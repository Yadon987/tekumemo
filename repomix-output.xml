This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.agent/
  walks/
    20260103_fit_import_bugs.md
    20260103_fit_import_fix_implemented.md
    IMPLEMENTATION_SUMMARY.md
  fix-review.md
.docs/
  DESIGN_SYSTEM_DARK.md
  DESIGN_SYSTEM_LIGHT.md
  PORTFOLIO_GUEST_MODE_SPEC.md
  RESPONSIVE_DESIGN.md
.gemini/
  handover_20251220_2019.md
  sudoers_development_config.txt
.github/
  workflows/
    ci.yml
  dependabot.yml
  ISSUE_14_UPDATED.md
app/
  assets/
    builds/
      .keep
    config/
      manifest.js
    images/
      .keep
      google_fit_logo.png
      icon.png
    stylesheets/
      application.css
      application.tailwind.css
  channels/
    application_cable/
      channel.rb
      connection.rb
  controllers/
    admin/
      announcements_controller.rb
      base_controller.rb
      dashboard_controller.rb
      posts_controller.rb
      users_controller.rb
      walks_controller.rb
    concerns/
      .keep
    posts/
      ogp_images_controller.rb
    rankings/
      ogp_images_controller.rb
    users/
      omniauth_callbacks_controller.rb
      passwords_controller.rb
      registrations_controller.rb
      sessions_controller.rb
    achievements_controller.rb
    application_controller.rb
    google_fit_controller.rb
    home_controller.rb
    login_stamps_controller.rb
    notifications_controller.rb
    posts_controller.rb
    rankings_controller.rb
    reactions_controller.rb
    static_pages_controller.rb
    stats_coming_soon_controller.rb
    stats_controller.rb
    users_controller.rb
    walks_controller.rb
    web_push_subscriptions_controller.rb
  helpers/
    achievements_helper.rb
    application_helper.rb
    home_helper.rb
    posts_helper.rb
    rankings_helper.rb
    reactions_helper.rb
    share_helper.rb
    static_pages_helper.rb
    stats_coming_soon_helper.rb
    users_helper.rb
  javascript/
    controllers/
      accordion_controller.js
      anomaly_controller.js
      application.js
      avatar_upload_controller.js
      carousel_controller.js
      character_counter_controller.js
      coach_mark_controller.js
      counter_controller.js
      dark_mode_toggle_controller.js
      dropdown_controller.js
      expandable_fab_controller.js
      flash_controller.js
      google_fit_controller.js
      hello_controller.js
      icon_select_controller.js
      index.js
      landing_modal_controller.js
      modal_controller.js
      ogp_preview_controller.js
      popover_controller.js
      push_notification_controller.js
      pwa_install_controller.js
      pwa_settings_controller.js
      radio_toggle_controller.js
      reaction_controller.js
      scroll_drag_controller.js
      scroll_hide_controller.js
      stats_chart_controller.js
    application.js
    dark_mode.js
  jobs/
    application_job.rb
    generate_post_ogp_image_job.rb
    generate_ranking_ogp_image_job.rb
  mailers/
    application_mailer.rb
  models/
    concerns/
      .keep
    achievement.rb
    announcement.rb
    application_record.rb
    notification.rb
    post.rb
    reaction.rb
    user_achievement.rb
    user.rb
    walk.rb
    web_push_subscription.rb
  services/
    geolocation_service.rb
    google_fit_service.rb
    inactive_reminder_service.rb
    reaction_summary_service.rb
    rpg_card_generator_service.rb
    stats_service.rb
    walk_reminder_service.rb
    weather_service.rb
    web_push_service.rb
  views/
    achievements/
      index.html.erb
    admin/
      announcements/
        _form.html.erb
        edit.html.erb
        index.html.erb
        new.html.erb
      dashboard/
        index.html.erb
      posts/
        index.html.erb
        show.html.erb
      users/
        index.html.erb
      walks/
        index.html.erb
        show.html.erb
    devise/
      mailer/
        email_changed.html.erb
        password_change.html.erb
        reset_password_instructions.html.erb
      passwords/
        edit.html.erb
        new.html.erb
      registrations/
        edit.html.erb
        new.html.erb
      sessions/
        new.html.erb
      shared/
        _error_messages.html.erb
        _links.html.erb
    home/
      index_9d26a2d.html.erb
      index_old.html.erb
      index.html.erb
      landing.html.erb
    kaminari/
      _first_page.html.erb
      _gap.html.erb
      _last_page.html.erb
      _next_page.html.erb
      _page.html.erb
      _paginator.html.erb
      _prev_page.html.erb
    layouts/
      _flash.html.erb
      admin.html.erb
      application.html.erb
      mailer.html.erb
      mailer.text.erb
    login_stamps/
      index.html.erb
    notifications/
      index.html.erb
    posts/
      _form.html.erb
      _post.html.erb
      _reactions.html.erb
      index.html.erb
      show.html.erb
    pwa/
      manifest.json.erb
      service-worker.js
    rankings/
      index.html.erb
    reactions/
      create.turbo_stream.erb
      destroy.turbo_stream.erb
    shared/
      _animated_background.html.erb
      _google_auth_guide.html.erb
      _google_fit_notice.html.erb
    static_pages/
      privacy.html.erb
    stats/
      index.html.erb
    stats_coming_soon/
      index.html.erb
    users/
      omniauth_callbacks/
        confirm_email_change.html.erb
      _avatar_section.html.erb
      _pwa_settings.html.erb
      update.turbo_stream.erb
    walks/
      _form.html.erb
      edit.html.erb
      index.html.erb
      new.html.erb
      show.html.erb
bin/
  Backup_full.sh
  brakeman
  complete_sync.sh
  dev
  docker-entrypoint
  importmap
  rails
  rake
  render-build.sh
  rubocop
  setup
  test_all.sh
config/
  environments/
    development.rb
    production.rb
    test.rb
  initializers/
    assets.rb
    content_security_policy.rb
    devise.rb
    filter_parameter_logging.rb
    geocoder.rb
    inflections.rb
    omniauth.rb
    permissions_policy.rb
    session_store.rb
  locales/
    devise.en.yml
    devise.ja.yml
    en.yml
    ja.yml
  application.rb
  boot.rb
  cable.yml
  cache.yml
  credentials.yml.enc
  database.yml
  environment.rb
  puma.rb
  routes.rb
  storage.yml
db/
  migrate/
    20251111002651_devise_create_users.rb
    20251118043542_create_walks.rb
    20251118051923_add_google_oauth_to_users.rb
    20251118080733_add_steps_and_calories_to_walks.rb
    20251125000014_add_avatar_url_to_users.rb
    20251125035721_add_name_to_users.rb
    20251127074734_add_target_distance_to_users.rb
    20251201090805_add_use_google_avatar_to_users.rb
    20251203000814_create_posts.rb
    20251203000817_create_reactions.rb
    20251204051500_create_solid_cache_entries.rb
    20251205012042_add_index_to_walks_user_id_and_walked_on.rb
    20251211083937_create_announcements.rb
    20251211084125_add_is_admin_to_users.rb
    20251211105939_create_notifications.rb
    20251211121714_remove_priority_from_announcements.rb
    20251212025118_add_notification_settings_to_users.rb
    20251212031212_create_web_push_subscriptions.rb
    20251213011842_add_reminder_fields_to_notifications.rb
    20251214160212_add_role_to_users.rb
    20251215082600_add_trackable_to_users.rb
    20251217225031_create_active_storage_tables.active_storage.rb
    20251219205704_add_time_of_day_to_walks.rb
    20251222200143_add_avatar_type_to_users.rb
    20251223060248_create_initial_announcements.rb
    20251223064230_create_achievements.rb
    20251223064232_create_user_achievements.rb
    20260103014700_add_unique_index_to_notifications.rb
  scripts/
    create_anomaly_test_data.rb
    delete_anomaly_test_data.rb
  cache_schema.rb
  schema.rb
  seeds.rb
lib/
  assets/
    .keep
  tasks/
    .keep
    admin.rake
    announcement_data.rake
    maintenance.rake
    reminder.rake
  supabase.js
log/
  .keep
public/
  fonts/
    MPLUS1p-Bold.ttf
    NotoSansJP-Bold.ttf
  404.html
  406-unsupported-browser.html
  422.html
  500.html
  512x512.png
  favicon.ico
  icon-192.png
  icon.png
  icon.svg
  robots.txt
  service-worker.js
spec/
  factories/
    achievements.rb
    announcements.rb
    notifications.rb
    posts.rb
    reactions.rb
    user_achievements.rb
    users.rb
    walks.rb
    web_push_subscriptions.rb
  fixtures/
    files/
      avatar.jpg
  helpers/
    application_helper_spec.rb
    posts_helper_spec.rb
    rankings_helper_spec.rb
    share_helper_spec.rb
    users_helper_spec.rb
  jobs/
    generate_post_ogp_image_job_spec.rb
    generate_ranking_ogp_image_job_spec.rb
  models/
    achievement_spec.rb
    announcement_spec.rb
    notification_spec.rb
    post_spec.rb
    reaction_spec.rb
    user_achievement_spec.rb
    user_guest_spec.rb
    user_spec.rb
    walk_spec.rb
    web_push_subscription_spec.rb
  requests/
    admin/
      dashboard_spec.rb
    posts/
      ogp_images_spec.rb
    rankings/
      ogp_images_spec.rb
    users/
      omniauth_callbacks_spec.rb
      registrations_spec.rb
    achievements_spec.rb
    google_fit_spec.rb
    home_controller_spec.rb
    login_stamps_controller_spec.rb
    notifications_controller_spec.rb
    posts_spec.rb
    rankings_spec.rb
    reactions_spec.rb
    static_pages_spec.rb
    stats_coming_soon_spec.rb
    stats_controller_spec.rb
    users_controller_spec.rb
    walks_pagination_spec.rb
    walks_spec.rb
    web_push_subscriptions_controller_spec.rb
  services/
    geolocation_service_spec.rb
    google_fit_service_spec.rb
    inactive_reminder_service_spec.rb
    reaction_summary_service_spec.rb
    stats_service_spec.rb
    walk_reminder_service_spec.rb
    weather_service_spec.rb
    web_push_service_spec.rb
  support/
    login_support.rb
    omniauth.rb
  system/
    achievements_spec.rb
    admin_users_spec.rb
    carousel_spec.rb
    guest_admin_dashboard_spec.rb
    guest_google_fit_spec.rb
    guest_login_system_spec.rb
    guest_logout_spec.rb
    guest_mode_enhancement_spec.rb
    home_spec.rb
    login_stamps_spec.rb
    ogp_preview_spec.rb
    rankings_spec.rb
    sns_spec.rb
    ui_components_spec.rb
    user_auth_spec.rb
    user_settings_spec.rb
    walks_spec.rb
  rails_helper.rb
  spec_helper.rb
storage/
  .keep
supabase/
  .gitignore
  config.toml
.cursorrules
.dockerignore
.env.example
.gitattributes
.gitignore
.node-version
.rspec
.rubocop.yml
.ruby-version
.yarnrc.yml
config.ru
docker-compose.yml
Dockerfile
Dockerfile.dev
Gemfile
LICENSE
package.json
parallel_output.txt
parallel_rspec_output.txt
PR_DESCRIPTION.md
Procfile.dev
Rakefile
README.md
render.yaml
restore_calories.sql
tailwind.config.js
user_31_walks.txt
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".github/dependabot.yml">
version: 2
updates:
- package-ecosystem: bundler
  directory: "/"
  schedule:
    interval: daily
  open-pull-requests-limit: 10
- package-ecosystem: github-actions
  directory: "/"
  schedule:
    interval: daily
  open-pull-requests-limit: 10
</file>

<file path=".github/ISSUE_14_UPDATED.md">
# Issue#14: 【拡散】OGP 設定と SNS シェア機能の実装

## 概要

アプリ内のコンテンツ（ユーザーの投稿）が外部 SNS（X 等）でシェアされた際に、
魅力的なプレビュー画像（OGP）が表示されるようにし、新規ユーザーの流入を促進する。

## 実装内容

- [x] OGP タグの基本設定（Rails の標準機能を使用、meta-tags gem は不使用）
- [ ] ~~静的 OGP 画像の設定（トップページ用）~~ ※動的生成のみで対応
- [x] 動的 OGP 画像の生成機能
  - [x] MiniMagick を使用した RPG 風ステータス画面デザインの実装
  - [x] 投稿詳細ページ (`/posts/:id`) で投稿内容を反映した画像を動的に生成
  - [x] ユーザーアバター（Google アバター or イニシャルアイコン）の表示
  - [x] ユーザー名、Lv、投稿本文、歩数、距離、EXP、ロケーション情報の表示
  - [x] 日本語フォント対応（MPLUS1p-Bold, NotoSansJP-Bold）
  - [x] デフォルトメッセージの実装（投稿本文が空の場合）
  - [x] 絵文字の除去処理
  - [x] 長いテキストの自動折り返し処理
- [x] シェアボタンの設置
  - [x] 投稿一覧画面に X へのシェアボタンを配置
  - [x] シェア用テキストの自動生成（投稿本文 + ハッシュタグ）
  - [ ] ~~LINE, Facebook へのシェアボタン~~ ※X のみ実装
- [x] OGP 画像生成 API エンドポイントの実装 (`/posts/:id/ogp_image`)
- [x] セキュリティ対策（Brakeman でのコマンドインジェクション警告の解消）
- [x] テスト環境の最適化（Google Fonts の読み込みスキップによる高速化）
- [x] システムスペックとリクエストスペックの追加

## 受け入れ条件

- [x] 投稿詳細ページを SNS でシェアした際、その投稿の内容が反映された RPG 風画像が表示されること
- [x] シェアボタンをクリックすると、適切なテキストが入った状態で X の投稿画面が開くこと
- [x] ユーザーの Google アバターがある場合は表示され、ない場合はイニシャルアイコンが表示されること
- [x] 全てのテストが成功すること（268 examples, 0 failures）
- [x] セキュリティスキャン（Brakeman）で警告が出ないこと
- [ ] Twitter Card Validator での表示確認（本番環境デプロイ後）

## 実装の変更点

### 当初の計画からの変更

- **meta-tags gem**: 不使用（Rails の標準機能で十分対応可能なため）
- **Grover/Puppeteer**: 廃止（Render.com でのデプロイ時のビルドエラーと複雑性のため）
- **MiniMagick 採用**: ImageMagick を使用したシンプルで軽量な画像生成に変更
- **デザイン**: RPG ステータス画面風の独自デザインを実装

## 実装時間

実績: 約 12 時間（見積もり通り）

## 技術スタック

- Rails 7
- MiniMagick (画像生成)
- ImageMagick (画像処理エンジン)
- Google Fonts（本番環境のみ、テスト環境ではスキップ）

## デプロイメモ

- Render.com のビルドスクリプト更新済み (`bin/render-build.sh`)
- ImageMagick とフォントファイル (`/public/fonts/`) のデプロイが必要
</file>

<file path="app/assets/builds/.keep">

</file>

<file path="app/assets/config/manifest.js">
//= link_tree ../images
//= link_tree ../builds
</file>

<file path="app/assets/images/.keep">

</file>

<file path="app/channels/application_cable/channel.rb">
module ApplicationCable
  class Channel < ActionCable::Channel::Base
  end
end
</file>

<file path="app/channels/application_cable/connection.rb">
module ApplicationCable
  class Connection < ActionCable::Connection::Base
  end
end
</file>

<file path="app/controllers/admin/posts_controller.rb">
class Admin::PostsController < Admin::BaseController
  def index
    @posts = Post.with_associations

    # 検索（本文・ユーザー名）
    if params[:q].present?
      search_term = "%#{params[:q]}%"
      @posts = @posts.joins(:user).where("posts.body ILIKE ? OR users.name ILIKE ?", search_term, search_term)
    end

    # フィルタ（天気）
    if params[:weather].present?
      @posts = @posts.where(weather: params[:weather])
    end

    # フィルタ（気分）
    if params[:feeling].present?
      @posts = @posts.where(feeling: params[:feeling])
    end

    @posts = @posts.recent.page(params[:page]).per(20)
  end

  def show
    @post = Post.find(params[:id])
  end

  def destroy
    @post = Post.find(params[:id])
    post_user_name = @post.user.name
    @post.destroy
    redirect_to admin_posts_path, notice: "「#{post_user_name}」さんの投稿を削除しました"
  end
end
</file>

<file path="app/controllers/admin/walks_controller.rb">
class Admin::WalksController < Admin::BaseController
  def index
    @walks = Walk.includes(:user)

    # 検索（ユーザー名）
    if params[:q].present?
      search_term = "%#{params[:q]}%"
      @walks = @walks.joins(:user).where("users.name ILIKE ?", search_term)
    end

    # フィルタ（距離範囲）
    if params[:min_distance].present?
      @walks = @walks.where("distance >= ?", params[:min_distance].to_i)
    end

    if params[:max_distance].present?
      @walks = @walks.where("distance <= ?", params[:max_distance].to_i)
    end

    # フィルタ（日付範囲）
    if params[:start_date].present?
      @walks = @walks.where("walked_on >= ?", params[:start_date])
    end

    if params[:end_date].present?
      @walks = @walks.where("walked_on <= ?", params[:end_date])
    end

    @walks = @walks.order(walked_on: :desc, created_at: :desc).page(params[:page]).per(20)
  end

  def show
    @walk = Walk.find(params[:id])
  end

  def destroy
    @walk = Walk.find(params[:id])
    walk_user_name = @walk.user.name
    walk_date = @walk.walked_on.strftime("%Y/%m/%d")
    @walk.destroy
    redirect_to admin_walks_path, notice: "「#{walk_user_name}」さんの散歩記録（#{walk_date}）を削除しました"
  end
end
</file>

<file path="app/controllers/concerns/.keep">

</file>

<file path="app/controllers/login_stamps_controller.rb">
class LoginStampsController < ApplicationController
  # ログインしていないユーザーはアクセスできないようにする
  before_action :authenticate_user!

  # ログインスタンプカレンダーページ（GET /login_stamps）
  def index
    # カレンダーの表示月を設定
    # params[:start_date]がない場合は今月を表示
    if params[:start_date]
      # URLパラメータから日付を取得
      @start_date = begin
        Date.parse(params[:start_date])
      rescue Date::Error, ArgumentError
        Date.current.beginning_of_month
      end
    else
      # 今月の1日を設定
      @start_date = Date.current.beginning_of_month
    end

    # 表示する月の範囲を設定
    # カレンダー表示のため、前月末から翌月初めまでの範囲を取得
    month_start = @start_date.beginning_of_month
    month_end = @start_date.end_of_month

    # カレンダー表示用に前後の日付も含めた範囲を設定
    calendar_start = month_start.beginning_of_week(:sunday)
    calendar_end = month_end.end_of_week(:sunday)

    # ログインユーザーの散歩記録を取得
    # カレンダー表示範囲内の記録のみ取得
    @walks = current_user.walks
                         .where(walked_on: calendar_start..calendar_end)
                         .order(:walked_on)

    # 日付ごとにグループ化（カレンダー表示用）
    # { Date => [Walk, Walk, ...] } の形式
    @walks_by_date = @walks.group_by { |walk| walk.walked_on }

    # 今月の散歩日数を計算
    @monthly_walk_count = current_user.walks
                                      .where(walked_on: month_start..month_end)
                                      .select(:walked_on)
                                      .distinct
                                      .count

    # 連続日数を計算
    @consecutive_days = current_user.consecutive_walk_days
  end
end
</file>

<file path="app/controllers/static_pages_controller.rb">
class StaticPagesController < ApplicationController
  skip_before_action :authenticate_user!, only: [ :privacy ]

  def privacy
  end
end
</file>

<file path="app/controllers/stats_coming_soon_controller.rb">
class StatsComingSoonController < ApplicationController
  def index
  end
end
</file>

<file path="app/controllers/web_push_subscriptions_controller.rb">
class WebPushSubscriptionsController < ApplicationController
  before_action :authenticate_user!

  def create
    subscription = current_user.web_push_subscriptions.find_or_initialize_by(
      endpoint: subscription_params[:endpoint]
    )

    subscription.assign_attributes(
      p256dh: subscription_params.dig(:keys, :p256dh),
      auth_key: subscription_params.dig(:keys, :auth),
      user_agent: request.user_agent
    )

    if subscription.save
      head :ok
    else
      Rails.logger.error "Failed to save subscription: #{subscription.errors.full_messages.join(', ')}"
      head :unprocessable_entity
    end
  end

  private

  def subscription_params
    params.permit(:endpoint, keys: [ :p256dh, :auth ])
  end
end
</file>

<file path="app/helpers/home_helper.rb">
module HomeHelper
end
</file>

<file path="app/helpers/reactions_helper.rb">
module ReactionsHelper
end
</file>

<file path="app/helpers/static_pages_helper.rb">
module StaticPagesHelper
end
</file>

<file path="app/helpers/stats_coming_soon_helper.rb">
module StatsComingSoonHelper
end
</file>

<file path="app/javascript/controllers/anomaly_controller.js">
import { Controller } from "@hotwired/stimulus";

export default class extends Controller {
  static targets = ["content"];

  toggle() {
    this.contentTarget.classList.toggle("hidden");
  }
}
</file>

<file path="app/javascript/controllers/application.js">
import { Application } from "@hotwired/stimulus"

const application = Application.start()

// Configure Stimulus development experience
application.debug = false
window.Stimulus   = application

export { application }
</file>

<file path="app/javascript/controllers/character_counter_controller.js">
import { Controller } from "@hotwired/stimulus"

// 文字数カウンターコントローラー
export default class extends Controller {
  static targets = ["input", "counter"]
  static values = { max: Number }

  connect() {
    console.log("Character counter connected!")
    this.update()
  }

  update() {
    const length = this.inputTarget.value.length
    const remaining = this.maxValue - length

    this.counterTarget.textContent = `${length} / ${this.maxValue}`

    if (remaining < 0) {
      // 超過時: 赤字にする
      this.counterTarget.classList.add("text-red-500", "dark:text-red-400", "font-bold")
      this.counterTarget.classList.remove("text-gray-400", "dark:text-purple-300/70")
    } else {
      // 通常時: グレー/紫に戻す
      this.counterTarget.classList.remove("text-red-500", "dark:text-red-400", "font-bold")
      this.counterTarget.classList.add("text-gray-400", "dark:text-purple-300/70")
    }
  }
}
</file>

<file path="app/javascript/controllers/counter_controller.js">
import { Controller } from "@hotwired/stimulus"

// 数値をカウントアップさせるアニメーションコントローラー
export default class extends Controller {
  static values = {
    target: Number, // 目標値（最終的な数値）
    duration: { type: Number, default: 1500 }, // アニメーション時間（ミリ秒）
    delimiter: { type: Boolean, default: true } // 3桁区切りをするかどうか
  }

  connect() {
    this.animate()
  }

  animate() {
    const start = 0
    const end = this.targetValue
    const duration = this.durationValue
    const startTime = performance.now()

    const update = (currentTime) => {
      const elapsed = currentTime - startTime
      const progress = Math.min(elapsed / duration, 1)

      // イージング関数（easeOutExpo）で自然な減速を実現
      const easeOut = (x) => x === 1 ? 1 : 1 - Math.pow(2, -10 * x)

      const current = start + (end - start) * easeOut(progress)

      // 小数点以下の桁数を判定（元の数値が小数の場合）
      const decimals = end.toString().includes('.') ? end.toString().split('.')[1].length : 0

      let formattedNumber = current.toFixed(decimals)

      if (this.delimiterValue) {
        // 整数部分と小数部分を分けて3桁区切り
        const parts = formattedNumber.split('.')
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",")
        formattedNumber = parts.join('.')
      }

      this.element.textContent = formattedNumber

      if (progress < 1) {
        requestAnimationFrame(update)
      } else {
        // 最終的な値を正確にセット
        let finalNumber = end.toFixed(decimals)
        if (this.delimiterValue) {
            const parts = finalNumber.split('.')
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",")
            finalNumber = parts.join('.')
        }
        this.element.textContent = finalNumber
      }
    }

    requestAnimationFrame(update)
  }
}
</file>

<file path="app/javascript/controllers/dark_mode_toggle_controller.js">
import { Controller } from "@hotwired/stimulus"

// =====================================
// ダークモード切り替えトグルスイッチ
// =====================================
// iOS風のトグルスイッチでダークモードとライトモードを切り替えます
// アニメーション付きで見た目も楽しいUIになっています

export default class extends Controller {
  // Stimulusが管理する要素（targets）を定義
  static targets = ["toggle", "slider", "icon"]

  // コントローラーが読み込まれた時に実行される
  connect() {
    // ページ読み込み時に、現在のテーマ設定を反映
    this.updateUI()
  }

  // トグルスイッチがクリックされた時の処理
  toggle() {
    // 現在のテーマ状態を取得
    const currentTheme = localStorage.getItem('theme') || 'light'

    // テーマを切り替える
    if (currentTheme === 'dark') {
      // ダークモード → ライトモード
      this.setLightMode()
    } else {
      // ライトモード → ダークモード
      this.setDarkMode()
    }
  }

  // ライトモードに設定
  setLightMode() {
    // htmlタグからdarkクラスを削除
    document.documentElement.classList.remove('dark')
    // localStorageに保存
    localStorage.setItem('theme', 'light')
    // UIを更新
    this.updateUI()
  }

  // ダークモードに設定
  setDarkMode() {
    // htmlタグにdarkクラスを追加
    document.documentElement.classList.add('dark')
    // localStorageに保存
    localStorage.setItem('theme', 'dark')
    // UIを更新
    this.updateUI()
  }

  // UIの表示を現在のテーマに合わせて更新
  updateUI() {
    // 現在のテーマ状態を取得
    const currentTheme = localStorage.getItem('theme') || 'light'
    const isDark = currentTheme === 'dark'

    // トグルボタンの背景色を変更
    if (isDark) {
      // ダークモード時：青いグラデーション背景
      this.toggleTarget.classList.remove('bg-gray-300')
      this.toggleTarget.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-sky-400')
    } else {
      // ライトモード時：グレー背景
      this.toggleTarget.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-sky-400')
      this.toggleTarget.classList.add('bg-gray-300')
    }

    // スライダー（丸いつまみ）の位置を変更
    if (isDark) {
      // ダークモード時：右側に移動（レスポンシブ対応：モバイル18px、PC22px）
      this.sliderTarget.classList.remove('translate-x-0')
      this.sliderTarget.classList.add('translate-x-[18px]', 'sm:translate-x-[22px]')
    } else {
      // ライトモード時：左側に移動
      this.sliderTarget.classList.remove('translate-x-[18px]', 'sm:translate-x-[22px]')
      this.sliderTarget.classList.add('translate-x-0')
    }

    // アイコンの表示/非表示を切り替え
    this.iconTargets.forEach((icon) => {
      const iconType = icon.dataset.icon

      if (isDark && iconType === 'sun') {
        // ダークモード時は太陽アイコンを表示
        icon.classList.remove('opacity-0', 'scale-0')
        icon.classList.add('opacity-100', 'scale-100')
      } else if (!isDark && iconType === 'moon') {
        // ライトモード時は月アイコンを表示
        icon.classList.remove('opacity-0', 'scale-0')
        icon.classList.add('opacity-100', 'scale-100')
      } else {
        // それ以外は非表示
        icon.classList.remove('opacity-100', 'scale-100')
        icon.classList.add('opacity-0', 'scale-0')
      }
    })
  }
}
</file>

<file path="app/javascript/controllers/dropdown_controller.js">
import { Controller } from "@hotwired/stimulus"

// ドロップダウンメニューの開閉を制御するコントローラー
export default class extends Controller {
    static targets = ["menu", "button"]

    connect() {
        // メニュー外クリックを検知するためのイベントリスナーを登録
        this.clickOutside = this.clickOutside.bind(this)
        document.addEventListener("click", this.clickOutside)
    }

    disconnect() {
        // コントローラー破棄時にイベントリスナーを削除
        document.removeEventListener("click", this.clickOutside)
    }

    // メニューの表示/非表示を切り替える
    toggle() {
        this.menuTarget.classList.toggle("hidden")

        // アニメーション用のクラスを切り替え（フェードイン・アウト用）
        if (this.menuTarget.classList.contains("hidden")) {
            this.menuTarget.classList.remove("opacity-100", "scale-100")
            this.menuTarget.classList.add("opacity-0", "scale-95")
        } else {
            // 表示時は少し遅延させてアニメーションクラスを適用（display: noneからの復帰用）
            requestAnimationFrame(() => {
                this.menuTarget.classList.remove("opacity-0", "scale-95")
                this.menuTarget.classList.add("opacity-100", "scale-100")
            })
        }
    }

    // メニューを閉じる
    close() {
        this.menuTarget.classList.add("hidden")
        this.menuTarget.classList.remove("opacity-100", "scale-100")
        this.menuTarget.classList.add("opacity-0", "scale-95")
    }

    // メニュー外をクリックした時に閉じる
    clickOutside(event) {
        if (!this.element.contains(event.target) && !this.menuTarget.classList.contains("hidden")) {
            this.close()
        }
    }
}
</file>

<file path="app/javascript/controllers/expandable_fab_controller.js">
import { Controller } from "@hotwired/stimulus"

// Expandable FAB（展開可能なFloating Action Button）の制御
export default class extends Controller {
  // Stimulusが管理する要素（targets）を定義
  static targets = ["overlay", "mainButton", "actionButton"]

  // 初期化時に実行
  connect() {
    // 開閉状態を管理する変数
    this.isOpen = false

    // オーバーレイクリック時にメニューを閉じる
    this.closeHandler = this.close.bind(this)
  }

  // FABの開閉を切り替える
  toggle() {
    if (this.isOpen) {
      this.close()
    } else {
      this.open()
    }
  }

  // FABを開く
  open() {
    this.isOpen = true

    // メインボタンを45度回転（✕マークのように見せる）
    this.mainButtonTarget.style.transform = "rotate(45deg)"

    // オーバーレイを表示
    this.overlayTarget.classList.remove("hidden")
    this.overlayTarget.classList.add("opacity-50")

    // アクションボタンを順番に表示（下から上へ）
    this.actionButtonTargets.forEach((button, index) => {
      setTimeout(() => {
        // hiddenクラスを削除して表示
        button.classList.remove("hidden")
        // 透明度を0から1に変更
        button.classList.remove("opacity-0")
        button.classList.add("opacity-100")
        // 下から上へ移動（transformを使用）
        button.style.transform = "translateY(0)"
      }, index * 50) // 50msずつ遅延させてアニメーション
    })
  }

  // FABを閉じる
  close() {
    this.isOpen = false

    // メインボタンの回転を元に戻す
    this.mainButtonTarget.style.transform = "rotate(0deg)"

    // オーバーレイを非表示
    this.overlayTarget.classList.remove("opacity-50")
    this.overlayTarget.classList.add("opacity-0")
    setTimeout(() => {
      this.overlayTarget.classList.add("hidden")
    }, 200)

    // アクションボタンを順番に非表示（上から下へ）
    this.actionButtonTargets.forEach((button, index) => {
      setTimeout(() => {
        // 透明度を1から0に変更
        button.classList.remove("opacity-100")
        button.classList.add("opacity-0")
        // 下方向へ移動
        button.style.transform = "translateY(20px)"

        // アニメーション完了後にhiddenクラスを追加
        setTimeout(() => {
          button.classList.add("hidden")
        }, 200)
      }, index * 30) // 30msずつ遅延させてアニメーション
    })
  }

  // コントローラーが切断されたときに実行
  disconnect() {
    // クリーンアップ処理（特に必要なし）
  }
}
</file>

<file path="app/javascript/controllers/hello_controller.js">
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
  connect() {
    this.element.textContent = "Hello World!"
  }
}
</file>

<file path="app/javascript/controllers/popover_controller.js">
import { Controller } from "@hotwired/stimulus"

// ポップオーバー（吹き出し）制御用コントローラー
export default class extends Controller {
  static targets = ["content"]

  connect() {
    // 外側クリックで閉じるイベントを登録
    this.clickOutsideHandler = this.clickOutside.bind(this)
  }

  toggle(event) {
    event.stopPropagation() // 親要素への伝播を防ぐ

    if (this.contentTarget.classList.contains("hidden")) {
      this.open()
    } else {
      this.close()
    }
  }

  open() {
    this.contentTarget.classList.remove("hidden")
    // 少し遅延させてイベントリスナーを登録（即座に閉じてしまうのを防ぐ）
    setTimeout(() => {
      document.addEventListener("click", this.clickOutsideHandler)
    }, 0)
  }

  close() {
    this.contentTarget.classList.add("hidden")
    document.removeEventListener("click", this.clickOutsideHandler)
  }

  clickOutside(event) {
    if (!this.element.contains(event.target)) {
      this.close()
    }
  }

  disconnect() {
    document.removeEventListener("click", this.clickOutsideHandler)
  }
}
</file>

<file path="app/javascript/controllers/push_notification_controller.js">
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
  static values = {
    vapidPublicKey: String
  }

  connect() {
    // ブラウザがService WorkerとPush APIをサポートしているか確認
    if (!("serviceWorker" in navigator) || !("PushManager" in window)) {
      this.element.style.display = "none"
    }
  }

  // 通知の購読登録を行う
  async subscribe() {
    try {
      // 通知権限を要求
      const permission = await Notification.requestPermission()
      if (permission !== "granted") {
        alert("通知を許可してください")
        return
      }

      // Service Workerを登録して、完全に有効になるまで待つ
      const registration = await navigator.serviceWorker.register("/service-worker.js")
      await navigator.serviceWorker.ready

      // 既存の購読を確認し、あれば削除
      let subscription = await registration.pushManager.getSubscription()
      if (subscription) {
        await subscription.unsubscribe()
      }

      // 新しく購読を登録
      subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: this.urlBase64ToUint8Array(this.vapidPublicKeyValue)
      })

      // 購読情報をサーバーに送信
      await this.sendSubscriptionToServer(subscription)

      alert("通知設定が完了しました！")
    } catch (error) {
      // エラーハンドリング（必要に応じてユーザーに通知）
      alert("通知設定に失敗しました。ブラウザの設定を確認してください。")
    }
  }

  // サーバーに購読情報を送信
  async sendSubscriptionToServer(subscription) {
    const response = await fetch("/web_push_subscriptions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify(subscription)
    })

    if (!response.ok) {
      throw new Error("Failed to send subscription to server")
    }
  }

  // VAPIDキーの変換用ユーティリティ
  urlBase64ToUint8Array(base64String) {
    const padding = "=".repeat((4 - base64String.length % 4) % 4)
    const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/")
    const rawData = window.atob(base64)
    const outputArray = new Uint8Array(rawData.length)

    for (let i = 0; i < rawData.length; ++i) {
      outputArray[i] = rawData.charCodeAt(i)
    }
    return outputArray
  }
}
</file>

<file path="app/javascript/controllers/radio_toggle_controller.js">
import { Controller } from "@hotwired/stimulus"

// ラジオボタンの選択解除を可能にするコントローラー
export default class extends Controller {
  static targets = ["input"]

  connect() {
    // 初期状態を保存
    this.lastChecked = null
    this.inputTargets.forEach(input => {
      if (input.checked) {
        this.lastChecked = input
      }
    })
  }

  toggle(event) {
    const input = event.currentTarget

    if (input === this.lastChecked) {
      // 既に選択されているものを再度クリックした場合、選択解除
      input.checked = false
      this.lastChecked = null

      // changeイベントを発火させて、他のリスナー（もしあれば）に通知
      input.dispatchEvent(new Event("change", { bubbles: true }))
    } else {
      // 新しく選択された場合
      this.lastChecked = input
    }
  }
}
</file>

<file path="app/javascript/controllers/reaction_controller.js">
import { Controller } from "@hotwired/stimulus"

// リアクションボタン制御用コントローラー
export default class extends Controller {
  static values = {
    url: String,
    kind: String,
    count: Number,
    reacted: Boolean
  }
  static targets = ["button", "count", "emoji"]

  toggle(event) {
    event.preventDefault()

    // デバッグログ
    console.log('[Reaction] Toggle started:', {
      url: this.urlValue,
      kind: this.kindValue,
      currentReacted: this.reactedValue,
      currentCount: this.countValue
    })

    // 1. Optimistic UI: サーバー応答を待たずにUIを即座に更新
    const previousReacted = this.reactedValue
    const previousCount = this.countValue

    this.reactedValue = !this.reactedValue
    if (this.reactedValue) {
      this.countValue++
    } else {
      this.countValue--
    }
    this.updateUI()

    // 2. サーバーへリクエスト
    fetch(this.urlValue, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content,
        "Accept": "application/json",
        "X-Requested-With": "XMLHttpRequest"
      },
      body: JSON.stringify({ reaction: { kind: this.kindValue } })
    })
    .then(response => {
      console.log('[Reaction] Response status:', response.status)
      if (!response.ok) {
        throw new Error(`Server returned ${response.status}`)
      }
      return response.json()
    })
    .then(data => {
      console.log('[Reaction] Server response:', data)
      // 3. サーバーからの正確な値で同期
      this.reactedValue = data.reacted
      this.countValue = data.count
      this.updateUI()
    })
    .catch(error => {
      console.error('[Reaction] Error:', error)
      // エラー時は元に戻す
      this.reactedValue = previousReacted
      this.countValue = previousCount
      this.updateUI()
      alert(`リアクションの更新に失敗しました: ${error.message}`)
    })
  }

  updateUI() {
    const btn = this.buttonTarget

    if (this.reactedValue) {
      // Active state - HTMLテンプレートと完全一致
      btn.classList.remove("bg-white", "dark:bg-white/5", "text-gray-600", "dark:text-gray-300", "border-gray-200", "dark:border-white/10")
      btn.classList.add("bg-blue-100", "dark:bg-blue-900/40", "text-blue-600", "dark:text-blue-300", "border-blue-300", "dark:border-blue-500/50")
    } else {
      // Inactive state - HTMLテンプレートと完全一致
      btn.classList.remove("bg-blue-100", "dark:bg-blue-900/40", "text-blue-600", "dark:text-blue-300", "border-blue-300", "dark:border-blue-500/50")
      btn.classList.add("bg-white", "dark:bg-white/5", "text-gray-600", "dark:text-gray-300", "border-gray-200", "dark:border-white/10")
    }

    // カウント表示の更新
    this.countTarget.textContent = this.countValue

    // ボタン全体の表示/非表示制御
    if (this.countValue > 0 || this.reactedValue) {
      btn.classList.remove("hidden")
      this.countTarget.classList.remove("hidden")
    } else {
      btn.classList.add("hidden")
    }

    // アニメーション効果
    this.emojiTarget.classList.remove("scale-125")
    void this.emojiTarget.offsetWidth // Trigger reflow
    this.emojiTarget.classList.add("scale-125")
    setTimeout(() => {
      this.emojiTarget.classList.remove("scale-125")
    }, 200)

    // ピッカー内のボタンの状態も同期
    const pickerBtnId = this.buttonTarget.id.replace("reaction-btn-", "picker-btn-")
    const pickerBtn = document.getElementById(pickerBtnId)
    if (pickerBtn) {
      if (this.reactedValue) {
        pickerBtn.classList.add("bg-blue-50", "dark:bg-blue-900/20")
      } else {
        pickerBtn.classList.remove("bg-blue-50", "dark:bg-blue-900/20")
      }
    }
  }
}
</file>

<file path="app/javascript/controllers/scroll_hide_controller.js">
import { Controller } from "@hotwired/stimulus"

// スクロールに応じて要素（FABやボトムナビ）を隠す/表示するコントローラー
export default class extends Controller {
    static targets = ["element"]

    connect() {
        // iOS Chromeの場合、スクロールによる隠蔽機能が画面のガタつき（ビューポートの変化による再レイアウトのループ）を引き起こすため、
        // この機能を完全に無効化し、常に表示固定とする。
        const isIOSChrome = /CriOS/i.test(navigator.userAgent) && /iPhone|iPad|iPod/i.test(navigator.userAgent);
        if (isIOSChrome) return;

        this.lastScrollTop = 0
        this.ticking = false
        this.onScroll = this.onScroll.bind(this)
        window.addEventListener("scroll", this.onScroll, { passive: true })
    }

    disconnect() {
        window.removeEventListener("scroll", this.onScroll)
    }

    onScroll() {
        if (!this.ticking) {
            window.requestAnimationFrame(() => {
                this.update()
                this.ticking = false
            })
            this.ticking = true
        }
    }

    update() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop
        const threshold = 10 // 感度（少しのスクロールで反応するように）

        // バウンススクロール対策（iOSなどで上に引っ張った時など）
        if (scrollTop < 0) return

        // 下にスクロール & 一定以上スクロールした時
        if (scrollTop > this.lastScrollTop && scrollTop > threshold) {
            // 隠す
            this.elementTargets.forEach(el => {
                el.classList.add("translate-y-[150%]", "opacity-0")
                el.classList.remove("translate-y-0", "opacity-100")
            })
        } else {
            // 上にスクロール
            // 表示する
            this.elementTargets.forEach(el => {
                el.classList.remove("translate-y-[150%]", "opacity-0")
                el.classList.add("translate-y-0", "opacity-100")
            })
        }

        this.lastScrollTop = scrollTop
    }
}
</file>

<file path="app/javascript/application.js">
// Configure your import map in config/importmap.rb. Read more: https://github.com/rails/importmap-rails
// Entry point for the build script in your package.json
import "@hotwired/turbo-rails"
import "./controllers"

// ダークモード機能はStimulusコントローラー（dark_mode_toggle_controller.js）で実装
// Google Fit連携はStimulusコントローラー（google_fit_controller.js）で実装
</file>

<file path="app/javascript/dark_mode.js">
// =====================================
// ダークモード機能
// =====================================
// このファイルでは、ダークモード（暗いテーマ）とライトモード（明るいテーマ）を
// 切り替える機能を実装しています

// -------------------------------------
// 関数1: ダークモードの状態を読み込む
// -------------------------------------
// ページを表示する前に、以前の設定を読み込んでダークモードを適用します
// これにより、ページが表示されるときにチラつくのを防ぎます
function initializeDarkMode() {
  // localStorageから前回の設定を取得（なければ'light'を使用）
  const theme = localStorage.getItem('theme') || 'light';

  // 取得した設定がdark（ダークモード）の場合
  if (theme === 'dark') {
    // htmlタグにdarkクラスを追加（これでダークモード用のスタイルが適用される）
    document.documentElement.classList.add('dark');
  } else {
    // それ以外の場合はdarkクラスを削除（ライトモードにする）
    document.documentElement.classList.remove('dark');
  }
}

// -------------------------------------
// 関数2: ボタンクリック時の処理（名前付き関数）
// -------------------------------------
// この関数を名前付きにすることで、後で削除や再登録ができます
function toggleDarkMode() {
  // htmlタグを取得（ここにdarkクラスを追加/削除する）
  const html = document.documentElement;

  // 現在ダークモードかどうかを確認
  const isDark = html.classList.contains('dark');

  // 現在の状態に応じて切り替える
  if (isDark) {
    // 今がダークモードなら→ライトモードに切り替え
    html.classList.remove('dark'); // darkクラスを削除
    localStorage.setItem('theme', 'light'); // 設定を保存
  } else {
    // 今がライトモードなら→ダークモードに切り替え
    html.classList.add('dark'); // darkクラスを追加
    localStorage.setItem('theme', 'dark'); // 設定を保存
  }
}

// -------------------------------------
// 関数3: ダークモード切り替えボタンの設定
// -------------------------------------
// ボタンをクリックしたときの動作を設定します
function setupDarkModeToggle() {
  // id="darkModeToggle"のボタンを取得
  const darkModeToggle = document.getElementById('darkModeToggle');

  // ボタンが見つかった場合のみ処理を実行
  if (!darkModeToggle) {
    return; // ボタンがなければここで終了
  }

  // 既存のイベントリスナーを削除（重複登録を防ぐため）
  // ※Turboでページ遷移するたびにこの関数が呼ばれるので、
  //   古いイベントリスナーを削除してから新しいのを登録します
  darkModeToggle.removeEventListener('click', toggleDarkMode);

  // 新しくイベントリスナーを登録
  darkModeToggle.addEventListener('click', toggleDarkMode);
}

// -------------------------------------
// 実行部分：イベントの設定
// -------------------------------------

// スクリプトが読み込まれたら即座にダークモードを初期化
// （これがないと、ページ表示時にチラつく可能性がある）
initializeDarkMode();

// Turbo（ページ遷移を高速化する仕組み）のページロード時に実行
document.addEventListener('turbo:load', function() {
  initializeDarkMode(); // ダークモードの状態を再適用
  setupDarkModeToggle(); // ボタンのクリックイベントを設定
});

// 通常のページロード時にも実行（Turboが無効な場合のため）
document.addEventListener('DOMContentLoaded', function() {
  setupDarkModeToggle(); // ボタンのクリックイベントを設定
});

// Turboでページ遷移する直前にもダークモードを再適用
// （遷移先でも同じテーマが維持されるようにする）
document.addEventListener('turbo:before-render', function() {
  initializeDarkMode(); // ダークモードの状態を再適用
});
</file>

<file path="app/jobs/application_job.rb">
class ApplicationJob < ActiveJob::Base
  # Automatically retry jobs that encountered a deadlock
  # retry_on ActiveRecord::Deadlocked

  # Most jobs are safe to ignore if the underlying records are no longer available
  # discard_on ActiveJob::DeserializationError
end
</file>

<file path="app/mailers/application_mailer.rb">
class ApplicationMailer < ActionMailer::Base
  default from: "from@example.com"
  layout "mailer"
end
</file>

<file path="app/models/concerns/.keep">

</file>

<file path="app/models/application_record.rb">
class ApplicationRecord < ActiveRecord::Base
  primary_abstract_class
end
</file>

<file path="app/models/notification.rb">
class Notification < ApplicationRecord
  belongs_to :user
  belongs_to :announcement, optional: true

  # Rails 7.2+ では enum 使用前に型を明示的に宣言する必要がある
  attribute :notification_type, :integer, default: 0

  # 通知種類のenum
  enum :notification_type, {
    announcement: 0,           # 運営からのお知らせ
    inactive_reminder: 1,      # 非アクティブリマインド
    reaction_summary: 2        # リアクションまとめ
  }, prefix: true

  # 未読通知のみを取得するスコープ
  scope :unread, -> { where(read_at: nil) }
  # 既読通知のみを取得するスコープ
  scope :read, -> { where.not(read_at: nil) }
  # 新しい順に並べ替え
  scope :recent, -> { order(created_at: :desc) }
  # お知らせの公開日順に並べ替え
  scope :ordered_by_announcement, -> { joins(:announcement).order("announcements.published_at DESC, notifications.created_at DESC") }
  # リマインダー通知のみ
  scope :reminders, -> { where(notification_type: [ :inactive_reminder, :reaction_summary ]) }
  # お知らせのみ
  scope :announcements, -> { where(notification_type: :announcement) }

  # 既読にする
  def mark_as_read!
    update!(read_at: Time.current) if read_at.nil?
  end

  # 未読かどうか
  def unread?
    read_at.nil?
  end

  # 通知のタイトルを取得（お知らせの場合はannouncementのtitle、リマインダーの場合は種類に応じたタイトル）
  def title
    if notification_type_announcement?
      announcement&.title
    elsif notification_type_inactive_reminder?
      "お久しぶりです！"
    elsif notification_type_reaction_summary?
      "リアクションまとめ"
    end
  end

  # 通知の本文を取得
  def body
    if notification_type_announcement?
      announcement&.body
    else
      message
    end
  end

  # 通知のリンク先を取得
  def link_url
    if notification_type_announcement?
      nil  # お知らせは詳細モーダルで表示
    else
      url
    end
  end
end
</file>

<file path="app/models/post.rb">
class Post < ApplicationRecord
  # アソシエーション（他のモデルとの関連付け）
  belongs_to :user  # 投稿は必ず1人のユーザー
  belongs_to :walk, optional: true  # 散歩記録の紐付けは任意
  has_many :reactions, dependent: :destroy

  # Active Storage: OGP画像の添付
  has_one_attached :ogp_image


  # バリデーション
  validates :body, length: { maximum: 200 }, allow_blank: true
  # enumを使用しているため、数値範囲のinclusionバリデーションは不要（削除）

  # カスタムバリデーション: body、weather、feeling、walkのいずれか1つは必須
  validate :must_have_content

  # enum（整数値に名前をつける機能）
  enum :weather, {
    sunny: 0,      # ☀️ 晴れ
    cloudy: 1,     # ☁️ 曇り
    rainy: 2,      # 🌧️ 雨
    snowy: 3,      # ⛄ 雪
    stormy: 4      # ⚡ 嵐
  }, prefix: true

  enum :feeling, {
    great: 0,      # 😊 最高
    good: 1,       # 🙂 良い
    normal: 2,     # 😐 普通
    tired: 3,      # 😮‍💨 疲れた
    exhausted: 4   # 😫 ヘトヘト
  }, prefix: true

  # スコープ（よく使うクエリに名前をつける）
  scope :recent, -> { order("posts.created_at DESC, posts.id DESC") }  # 新しい順に並べる（テーブル名明示）
  scope :with_walk, -> { where.not(walk_id: nil) }  # 散歩記録が紐付いている投稿のみ取得
  scope :with_associations, -> { preload(:user, :walk, :reactions) }  # N+1対策（preloadで別クエリ化）

  # 特定ユーザーがつけた全リアクションを取得（複数対応）
  def user_reactions(user)
    return [] unless user  # ログインしていない場合は空配列
    reactions.where(user: user)
  end

  # 特定ユーザーが特定のリアクションをつけているか判定
  def reacted_by?(user, kind)
    return false unless user
    reactions.exists?(user: user, kind: kind)
  end

  # 特定ユーザーがこの投稿に何らかのリアクションをつけているか判定
  def reacted_by_user?(user)
    return false unless user
    reactions.exists?(user: user)
  end

  # 天気の絵文字を返す
  def weather_emoji
    return nil unless weather
    case weather.to_sym
    when :sunny then "☀️"
    when :cloudy then "☁️"
    when :rainy then "🌧️"
    when :snowy then "⛄"
    when :stormy then "⚡"
    end
  end

  # 気分の絵文字を返す
  def feeling_emoji
    return nil unless feeling
    case feeling.to_sym
    when :great then "😆"
    when :good then "😄"
    when :normal then "🙂"
    when :tired then "😮‍💨"
    when :exhausted then "😫"
    end
  end

  # 天気の日本語ラベルを返す
  def weather_label
    return nil unless weather
    case weather.to_sym
    when :sunny then "晴れ"
    when :cloudy then "曇り"
    when :rainy then "雨"
    when :snowy then "雪"
    when :stormy then "嵐"
    else weather.to_s.humanize
    end
  end

  # 気分の日本語ラベルを返す
  def feeling_label
    return nil unless feeling
    case feeling.to_sym
    when :great then "最高！"
    when :good then "良い"
    when :normal then "普通"
    when :tired then "疲れた"
    when :exhausted then "ヘトヘト"
    else feeling.to_s.humanize
    end
  end

  private

  # カスタムバリデーションメソッド:完全に空の投稿を防ぐ
  def must_have_content
    if body.blank? && weather.nil? && feeling.nil? && walk_id.nil?
      errors.add(:base, "本文、天気、気分、散歩記録のいずれか1つは入力してください")
    end
  end
end
</file>

<file path="app/models/reaction.rb">
class Reaction < ApplicationRecord
  # アソシエーション（他のモデルとの関連付け）
  belongs_to :user
  belongs_to :post, touch: true

  # バリデーション（データの検証ルール）
  validates :kind, presence: true  # リアクションの種類（kind）は必須
  validates :user_id, uniqueness: {
    scope: [ :post_id, :kind ],
    message: "は同じ投稿に同じリアクションを複数回つけられません"
  }

  # enum（整数値に名前をつける機能）
  enum :kind, {
    thumbs_up: 0,      # 👍 いいね
    heart: 1,          # ❤️ 素敵
    bulb: 2,           # 💡 参考になる
    cherry_blossom: 3, # 🌸 癒やされる
    fire: 4,           # 🔥 燃えてきた！
    party: 5,          # 🎉 おめでとう
    eyes: 8,           # 👀 見たよ
    sparkles: 10,      # ✨ きれい
    muscle: 11,        # 💪 頑張った
    laugh: 12,         # 🤣 爆笑
    thanks: 13,        # 🙏 ありがとう
    cry: 14            # 😭 涙
  }, prefix: true

  # インスタンスメソッド（各リアクションが持つ機能）
  def emoji
    case kind.to_sym
    when :thumbs_up then "👍"
    when :heart then "❤️"
    when :bulb then "💡"
    when :cherry_blossom then "🌸"
    when :fire then "🔥"
    when :party then "🎉"
    when :eyes then "👀"
    when :sparkles then "✨"
    when :muscle then "💪"
    when :laugh then "🤣"
    when :thanks then "🙏"
    when :cry then "😭"
    end
  end

  # リアクションのラベルを返す（日本語）
  def label
    case kind.to_sym
    when :thumbs_up then "いいね"
    when :heart then "素敵"
    when :bulb then "参考になる"
    when :cherry_blossom then "癒やされる"
    when :fire then "燃えてきた！"
    when :party then "おめでとう"
    when :eyes then "見たよ"
    when :sparkles then "きれい"
    when :muscle then "頑張った"
    when :laugh then "爆笑"
    when :thanks then "ありがとう"
    when :cry then "涙"
    end
  end

  # クラスメソッドで全リアクション種類を配列で返す（ビューで使用）
  # 例: [{ kind: :thumbs_up, emoji: "👍", label: "いいね" }, ...]
  def self.all_kinds
    kinds.keys.map do |kind_key|
      reaction = new(kind: kind_key)
      {
        kind: kind_key,
        emoji: reaction.emoji,
        label: reaction.label
      }
    end
  end
end
</file>

<file path="app/models/web_push_subscription.rb">
class WebPushSubscription < ApplicationRecord
  belongs_to :user

  # バリデーション
  validates :endpoint, presence: true, uniqueness: true, format: { with: URI::DEFAULT_PARSER.make_regexp(%w[http https]), message: "は有効なURLである必要があります" }
  validates :p256dh, presence: true
  validates :auth_key, presence: true
end
</file>

<file path="app/services/geolocation_service.rb">
# IP位置情報を取得するサービスクラス
# geocoder gem を使用してより正確な位置情報を取得
class GeolocationService
  # リクエストからクライアントIPアドレスを抽出
  def self.extract_ip(request)
    request.headers["X-Forwarded-For"]&.split(",")&.first&.strip || request.remote_ip
  end

  # IPアドレスから位置情報を取得
  def self.get_location(ip_address)
    # ローカルホストやプライベートIPの場合はデフォルト（東京）を返す
    if local_ip?(ip_address)
      Rails.logger.info("ローカルIPアドレスを検出: #{ip_address}、デフォルト位置を使用")
      return default_location
    end

    begin
      # geocoder gem を使用してIP位置情報を取得
      # 複数のプロバイダーをフォールバックで試行
      results = Geocoder.search(ip_address)

      if results.present? && results.first
        result = results.first

        # デバッグ用ログ
        Rails.logger.info("========================================")
        Rails.logger.info("Geocoder で位置情報を取得:")
        Rails.logger.info("  IP: #{ip_address}")
        Rails.logger.info("  City: #{result.city}")
        Rails.logger.info("  Region: #{result.state}")
        Rails.logger.info("  Country: #{result.country}")
        Rails.logger.info("  Latitude: #{result.latitude}")
        Rails.logger.info("  Longitude: #{result.longitude}")
        Rails.logger.info("========================================")

        {
          latitude: result.latitude || default_location[:latitude],
          longitude: result.longitude || default_location[:longitude],
          city: result.city || default_location[:city],
          region: result.state || default_location[:region],
          country: result.country || default_location[:country]
        }
      else
        Rails.logger.warn("位置情報が取得できませんでした (IP: #{ip_address})")
        default_location
      end
    rescue => e
      Rails.logger.error("位置情報の取得に失敗: #{e.message} (IP: #{ip_address})")
      Rails.logger.error(e.backtrace.join("\n"))
      default_location
    end
  end

  private

  # ローカルIPまたはプライベートIPかどうかを判定
  def self.local_ip?(ip)
    return true if ip.nil? || ip.blank?
    return true if ip == "127.0.0.1" || ip == "::1" || ip == "localhost"

    # プライベートIPアドレスの範囲
    private_ranges = [
      /^10\./,
      /^172\.(1[6-9]|2[0-9]|3[0-1])\./,
      /^192\.168\./
    ]

    private_ranges.any? { |range| ip.match?(range) }
  end

  # デフォルトの位置情報（東京）
  def self.default_location
    {
      latitude: 35.6762,
      longitude: 139.6503,
      city: "東京",
      region: "東京都",
      country: "日本"
    }
  end
end
</file>

<file path="app/services/inactive_reminder_service.rb">
class InactiveReminderService
  def self.send_reminders
    # 非アクティブリマインドが有効なユーザーを取得
    users = User.where(inactive_days_reminder_enabled: true)

    users.find_each do |user|
      # 最終散歩日を取得（なければ登録日）
      last_walk_date = user.walks.maximum(:walked_on) || user.created_at.to_date

      # 経過日数を計算
      days_since_last_walk = (Date.current - last_walk_date).to_i

      # 設定された日数と一致する場合のみ通知（毎日送らないようにするため）
      if days_since_last_walk == user.inactive_days_threshold
        message_body = "#{days_since_last_walk}日間、散歩の記録がありません。今日は少し歩いてみませんか？"

        # Web Push通知を送信
        WebPushService.send_notification(
          user,
          title: "お久しぶりです！",
          body: message_body,
          url: "/walks/new"
        )

        # 通知ボックスにも保存（リマインダーは既読状態で作成）
        user.notifications.create!(
          notification_type: :inactive_reminder,
          message: message_body,
          url: "/walks/new",
          read_at: Time.current
        )

        Rails.logger.info "Sent inactive reminder to user #{user.id} (#{days_since_last_walk} days inactive)"
      end
    end
  end
end
</file>

<file path="app/services/reaction_summary_service.rb">
class ReactionSummaryService
  def self.send_summaries
    # 今日のリアクションを集計（0時〜現在まで）
    today = Date.current
    start_time = today.beginning_of_day
    end_time = Time.current

    # 今日作成されたリアクションを取得
    reactions = Reaction.where(created_at: start_time..end_time)
                        .includes(:post, :user)

    # リアクションがない場合は処理を終了
    return if reactions.empty?

    # 投稿者（リアクションを受け取った人）ごとにグループ化
    reactions_by_recipient = reactions.group_by { |reaction| reaction.post.user }

    reactions_by_recipient.each do |recipient, user_reactions|
      # 通知設定が無効な場合はスキップ
      next unless recipient.reaction_summary_enabled

      # リアクション数を集計
      total_count = user_reactions.size

      # リアクションの種類別にカウント
      reactions_by_kind = user_reactions.group_by(&:kind).transform_values(&:count)

      # 上位3種類のリアクションを取得
      top_reactions = reactions_by_kind.sort_by { |_, count| -count }.take(3)

      # 通知メッセージを作成
      summary_text = top_reactions.map do |kind, count|
        reaction = Reaction.new(kind: kind)
        emoji = reaction.emoji || "?"  # emojiが取得できない場合は"?"
        "#{emoji}#{count}件"
      end.join(", ")

      # 通知を送信
      message_body = "今日これまでに#{total_count}件のリアクションがありました！#{summary_text}"

      WebPushService.send_notification(
        recipient,
        title: "リアクションまとめ",
        body: message_body,
        url: "/posts"
      )

      # 通知ボックスにも保存（リマインダーは既読状態で作成）
      recipient.notifications.create!(
        notification_type: :reaction_summary,
        message: message_body,
        url: "/posts",
        read_at: Time.current
      )

      Rails.logger.info "Sent reaction summary to user #{recipient.id}: #{total_count} reactions"
    end
  end
end
</file>

<file path="app/services/walk_reminder_service.rb">
class WalkReminderService
  def self.send_reminders
    # 散歩リマインドが有効なユーザーを全て取得
    users = User.where(walk_reminder_enabled: true)

    users.find_each do |user|
      # 今日の散歩記録がある場合はスキップ
      next if user.walks.where(walked_on: Date.current).exists?

      # ユーザーの設定時刻を取得（時と分のみ）
      reminder_hour = user.walk_reminder_time.hour
      reminder_min = user.walk_reminder_time.min


      # 現在時刻を取得（時のみ）
      current_time = Time.current
      current_hour = current_time.hour

      # 時刻が一致する場合に通知（1時間ごとの実行を想定し、時が一致すれば通知）
      if current_hour == reminder_hour
        WebPushService.send_notification(
          user,
          title: "散歩の時間です！",
          body: "今日の目標まであと少しです。軽く歩いてきませんか？",
          url: "/walks/new"
        )
        Rails.logger.info "Sent walk reminder to user #{user.id}"
      end
    end
  end
end
</file>

<file path="app/services/weather_service.rb">
require "net/http"
require "json"

# 天気情報を取得するサービスクラス
class WeatherService
  # OpenWeatherMapのAPIエンドポイント
  API_URL = "https://api.openweathermap.org/data/2.5/forecast"

  # 東京の緯度経度（デフォルト）
  DEFAULT_LAT = 35.6762
  DEFAULT_LON = 139.6503

  # 天気情報を取得するメソッド
  # lat: 緯度、lon: 経度（指定されない場合はデフォルト値を使用）
  def self.get_forecast(lat: DEFAULT_LAT, lon: DEFAULT_LON)
    # 環境変数からAPIキーを取得
    api_key = ENV["OPENWEATHER_API_KEY"]

    # APIキーが設定されていない場合はダミーデータを返す
    if api_key.blank?
      return dummy_data
    end

    begin
      # APIリクエストのURLを組み立てる
      url = "#{API_URL}?lat=#{lat}&lon=#{lon}&appid=#{api_key}&units=metric&lang=ja"
      uri = URI(url)

      # HTTPリクエストを送信
      response = Net::HTTP.get_response(uri)

      # レスポンスが成功した場合
      if response.is_a?(Net::HTTPSuccess)
        # JSONをパース
        data = JSON.parse(response.body)

        # 今日と明日の天気情報を抽出
        format_forecast(data)
      else
        # エラーが発生した場合はダミーデータを返す
        dummy_data
      end
    rescue => e
      # 例外が発生した場合もダミーデータを返す
      Rails.logger.error("天気情報の取得に失敗しました: #{e.message}")
      dummy_data
    end
  end

  private

  # APIレスポンスから必要な情報を抽出して整形するメソッド
  def self.format_forecast(data)
    forecasts = data["list"]

    # 今日の日付
    today = Date.current
    # 明日の日付
    tomorrow = today + 1

    # 今日の天気情報を取得（最初の予報データ）
    today_forecast = forecasts.first

    # 明日の天気情報を取得（日付が変わる最初のデータを探す）
    tomorrow_forecast = forecasts.find do |forecast|
      forecast_date = Time.zone.at(forecast["dt"]).to_date
      forecast_date == tomorrow
    end

    # 整形したデータを返す
    {
      today: {
        temp: today_forecast["main"]["temp"].round,
        description: today_forecast["weather"].first["description"],
        icon: weather_icon(today_forecast["weather"].first["main"])
      },
      tomorrow: tomorrow_forecast ? {
        temp: tomorrow_forecast["main"]["temp"].round,
        description: tomorrow_forecast["weather"].first["description"],
        icon: weather_icon(tomorrow_forecast["weather"].first["main"])
      } : nil
    }
  end

  # 天気の状態に応じたアイコン名を返すメソッド
  def self.weather_icon(weather_main)
    case weather_main
    when "Clear"
      "sunny"
    when "Clouds"
      "cloud"
    when "Rain", "Drizzle"
      "rainy"
    when "Thunderstorm"
      "thunderstorm"
    when "Snow"
      "ac_unit"
    when "Mist", "Fog"
      "mist"
    else
      "wb_cloudy"
    end
  end

  # ダミーデータを返すメソッド（APIキーが無い場合や、エラー時に使用）
  def self.dummy_data
    {
      today: {
        temp: 22,
        description: "\u6674\u308C",
        icon: "sunny"
      },
      tomorrow: {
        temp: 20,
        description: "\u66C7\u308A",
        icon: "cloud"
      }
    }
  end
end
</file>

<file path="app/services/web_push_service.rb">
class WebPushService
  def self.send_notification(user, title:, body:, url: "/", icon: "/icon-192.png")
    subscriptions = user.web_push_subscriptions

    if subscriptions.empty?
      Rails.logger.info "No push subscriptions found for user #{user.id}"
      return
    end

    payload = {
      title: title,
      body: body,
      icon: icon,
      url: url
    }.to_json

    subscriptions.find_each do |subscription|
      begin
        WebPush.payload_send(
          message: payload,
          endpoint: subscription.endpoint,
          p256dh: subscription.p256dh,
          auth: subscription.auth_key,
          vapid: {
            subject: "cvg.fhc.66@gmail.com", # 本番環境では適切なメールアドレスに変更
            public_key: ENV["VAPID_PUBLIC_KEY"],
            private_key: ENV["VAPID_PRIVATE_KEY"]
          }
        )
      rescue WebPush::InvalidSubscription => e
        # 購読が無効になっている場合は削除
        Rails.logger.info "Removing invalid subscription for user #{user.id}: #{e.message}"
        subscription.destroy
      rescue StandardError => e
        Rails.logger.error "Failed to send push notification to user #{user.id}: #{e.message}"
      end
    end
  end
end
</file>

<file path="app/views/admin/announcements/_form.html.erb">
<div class="min-h-screen bg-gradient-to-b from-sky-50 to-slate-50 dark:bg-gradient-to-b dark:from-slate-900 dark:via-slate-900 dark:to-indigo-950 py-8">
  <div class="max-w-3xl mx-auto px-4">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
      <%= announcement.persisted? ? 'お知らせ編集' : 'お知らせ作成' %>
    </h1>

    <%= form_with model: [:admin, announcement], class: "bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 space-y-6" do |f| %>
      <% if announcement.errors.any? %>
        <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
          <h3 class="text-red-800 dark:text-red-300 font-bold mb-2">エラーがあります</h3>
          <ul class="listdisc list-inside text-red-700 dark:text-red-400 text-sm">
            <% announcement.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- タイトル -->
      <div>
        <%= f.label :title, 'タイトル', class: 'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2' %>
        <%= f.text_field :title, class: 'w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500', placeholder: 'メンテナンスのお知らせ' %>
      </div>

      <!-- 本文 -->
      <div>
        <%= f.label :content, '本文', class: 'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2' %>
        <%= f.text_area :content, rows: 8, class: 'w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500', placeholder: 'お知らせの内容を入力してください...' %>
      </div>

      <!-- 種類 -->
      <div>
        <%= f.label :announcement_type, '種類', class: 'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2' %>
        <%= f.select :announcement_type, Announcement::ANNOUNCEMENT_TYPES.invert, {}, class: 'w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500' %>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- 公開日時 -->
        <div>
          <%= f.label :published_at, '公開日時', class: 'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2' %>
          <%= f.datetime_local_field :published_at, value: (announcement.published_at || Time.current).strftime('%Y-%m-%dT%H:%M'), class: 'w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500', style: 'color-scheme: light dark;' %>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">未設定の場合は即座に公開されます</p>
        </div>

        <!-- 有効期限 -->
        <div>
          <%= f.label :expires_at, '有効期限', class: 'block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2' %>
          <%= f.datetime_local_field :expires_at, value: announcement.expires_at&.strftime('%Y-%m-%dT%H:%M'), class: 'w-full px-4 py-2 border border-gray-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500', style: 'color-scheme: light dark;' %>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">未設定の場合は無期限です</p>
        </div>
      </div>


      <!-- アクションボタン -->
      <div class="flex gap-4 pt-4">
        <%= f.submit announcement.persisted? ? '更新' : '作成', class: 'flex-1 px-6 py-3 border border-blue-600 bg-white dark:bg-blue-900/20 text-blue-600 dark:text-blue-300 font-bold rounded-lg transition-colors cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/40 shadow-sm' %>
        <%= link_to 'キャンセル', admin_announcements_path, class: 'px-6 py-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-300 font-bold rounded-lg transition-colors text-center hover:bg-gray-50 dark:hover:bg-slate-600 shadow-sm' %>
      </div>
    <% end %>
  </div>
</div>
</file>

<file path="app/views/admin/announcements/edit.html.erb">
<%= render 'form', announcement: @announcement %>
</file>

<file path="app/views/admin/announcements/index.html.erb">
<div class="bg-white dark:bg-slate-800 shadow rounded-lg overflow-hidden">
  <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
    <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
      <span class="material-symbols-outlined mr-2">campaign</span>
      お知らせ管理
    </h2>
    <div class="flex items-center gap-4">
      <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded dark:bg-blue-200 dark:text-blue-800">
        全 <%= @announcements.total_count %> 件
      </span>
      <%= link_to new_admin_announcement_path, class: "inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors shadow-sm" do %>
        <span class="material-symbols-outlined text-lg">add</span>
        <span>新規作成</span>
      <% end %>
    </div>
  </div>

  <!-- 検索・フィルタフォーム -->
  <div class="px-6 py-4 bg-gray-50 dark:bg-slate-700/50 border-b border-gray-200 dark:border-gray-700">
    <%= form_with url: admin_announcements_path, method: :get, class: "flex flex-wrap gap-4 items-center", local: true do |f| %>
      <!-- キーワード検索 -->
      <div class="flex-1 min-w-[200px]">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="material-symbols-outlined text-gray-400">search</span>
          </div>
          <%= f.text_field :q, value: params[:q], placeholder: "タイトルまたは本文で検索...", class: "pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
        </div>
      </div>

      <!-- 種類フィルタ -->
      <div class="w-32">
        <%= f.select :type, Announcement::ANNOUNCEMENT_TYPES.map { |k, v| [v, k] }, { include_blank: '全ての種類', selected: params[:type] }, { class: "block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" } %>
      </div>

      <!-- ステータスフィルタ -->
      <div class="w-32">
        <%= f.select :status, [['公開中', 'published'], ['下書き', 'draft']], { include_blank: '全ての状態', selected: params[:status] }, { class: "block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" } %>
      </div>

      <!-- 検索ボタン -->
      <%= f.button type: :submit, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
        検索
      <% end %>

      <!-- クリアボタン -->
      <% if params[:q].present? || params[:type].present? || params[:status].present? %>
        <%= link_to admin_announcements_path, class: "text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" do %>
          クリア
        <% end %>
      <% end %>
    <% end %>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
      <thead class="bg-gray-50 dark:bg-slate-700">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ステータス</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">種類</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">タイトル</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">内容</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">公開日時</th>
          <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">操作</th>
        </tr>
      </thead>
      <tbody class="bg-white dark:bg-slate-800 divide-y divide-gray-200 dark:divide-gray-700">
        <% @announcements.each do |announcement| %>
          <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors">
            <!-- ステータス -->
            <td class="px-6 py-4 whitespace-nowrap">
              <% if announcement.active? %>
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300">
                  公開中
                </span>
              <% elsif announcement.is_published %>
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300">
                  期限切れ
                </span>
              <% else %>
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400">
                  下書き
                </span>
              <% end %>
            </td>

            <!-- 種類 -->
            <td class="px-6 py-4 whitespace-nowrap">
              <% case announcement.announcement_type %>
              <% when 'urgent' %>
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300">
                  🚨 緊急
                </span>
              <% when 'warning' %>
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-300">
                  ⚠️ 重要
                </span>
              <% else %>
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300">
                  ℹ️ お知らせ
                </span>
              <% end %>
            </td>

            <!-- タイトル -->
            <td class="px-6 py-4">
              <div class="text-sm font-medium text-gray-900 dark:text-white">
                <%= announcement.title %>
              </div>
            </td>

            <!-- 内容 -->
            <td class="px-6 py-4">
              <div class="text-sm text-gray-500 dark:text-gray-400 max-w-xs truncate">
                <%= announcement.content.truncate(50) %>
              </div>
            </td>

            <!-- 公開日時 -->
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
              <% if announcement.published_at %>
                <%= l announcement.published_at, format: :short %>
              <% else %>
                <span class="text-gray-400">-</span>
              <% end %>
              <% if announcement.expires_at %>
                <div class="text-xs text-gray-400">
                  期限: <%= l announcement.expires_at, format: :short %>
                </div>
              <% end %>
            </td>

            <!-- 操作 -->
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
              <%= link_to edit_admin_announcement_path(announcement), class: "text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 inline-flex items-center" do %>
                <span class="material-symbols-outlined text-sm mr-1">edit</span>
                編集
              <% end %>

              <% if announcement.is_published %>
                <%= button_to unpublish_admin_announcement_path(announcement), method: :patch, class: "text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 inline-flex items-center" do %>
                  <span class="material-symbols-outlined text-sm mr-1">visibility_off</span>
                  非公開
                <% end %>
              <% else %>
                <%= button_to publish_admin_announcement_path(announcement), method: :patch, class: "text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300 inline-flex items-center" do %>
                  <span class="material-symbols-outlined text-sm mr-1">visibility</span>
                  公開
                <% end %>
              <% end %>

              <%= button_to admin_announcement_path(announcement), method: :delete, data: { turbo_confirm: '本当に削除しますか？' }, class: "text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 inline-flex items-center" do %>
                <span class="material-symbols-outlined text-sm mr-1">delete</span>
                削除
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <% if @announcements.empty? %>
      <div class="text-center py-12">
        <p class="text-gray-500 dark:text-gray-400">お知らせがありません</p>
      </div>
    <% end %>
  </div>

  <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
    <%= paginate @announcements %>
  </div>
</div>
</file>

<file path="app/views/admin/announcements/new.html.erb">
<%= render 'form', announcement: @announcement %>
</file>

<file path="app/views/admin/posts/index.html.erb">
<div class="bg-white dark:bg-slate-800 shadow rounded-lg overflow-hidden">
  <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
    <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
      <span class="material-symbols-outlined mr-2">edit_square</span>
      投稿管理
    </h2>
    <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded dark:bg-blue-200 dark:text-blue-800">
      全 <%= @posts.total_count %> 件
    </span>
  </div>

  <!-- 検索・フィルタフォーム -->
  <div class="px-6 py-4 bg-gray-50 dark:bg-slate-700/50 border-b border-gray-200 dark:border-gray-700">
    <%= form_with url: admin_posts_path, method: :get, class: "flex flex-wrap gap-4 items-center", local: true do |f| %>
      <!-- キーワード検索 -->
      <div class="flex-1 min-w-[200px]">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="material-symbols-outlined text-gray-400">search</span>
          </div>
          <%= f.text_field :q, value: params[:q], placeholder: "本文またはユーザー名で検索...", class: "pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
        </div>
      </div>

      <!-- 天気フィルタ -->
      <div class="w-32">
        <% weather_options = Post.weathers.keys.map { |k| [Post.new(weather: k).weather_label, k] } %>
        <%= f.select :weather, weather_options, { include_blank: '全ての天気', selected: params[:weather] }, { class: "block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" } %>
      </div>

      <!-- 気分フィルタ -->
      <div class="w-32">
        <% feeling_options = Post.feelings.keys.map { |k| [Post.new(feeling: k).feeling_label, k] } %>
        <%= f.select :feeling, feeling_options, { include_blank: '全ての気分', selected: params[:feeling] }, { class: "block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" } %>
      </div>

      <!-- 検索ボタン -->
      <%= f.button type: :submit, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
        検索
      <% end %>

      <!-- クリアボタン -->
      <% if params[:q].present? || params[:weather].present? || params[:feeling].present? %>
        <%= link_to admin_posts_path, class: "text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" do %>
          クリア
        <% end %>
      <% end %>
    <% end %>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
      <thead class="bg-gray-50 dark:bg-slate-700">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ID</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">投稿者</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">内容</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">投稿日時</th>
          <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">操作</th>
        </tr>
      </thead>
      <tbody class="bg-white dark:bg-slate-800 divide-y divide-gray-200 dark:divide-gray-700">
        <% @posts.each do |post| %>
          <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
              <%= post.id %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <%= user_avatar(post.user, classes: "h-10 w-10 rounded-full") %>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900 dark:text-white">
                    <%= post.user.name %>
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400">
              <div class="max-w-xs truncate">
                <% if post.body.present? %>
                  <%= post.body %>
                <% else %>
                  <span class="text-gray-400 dark:text-gray-500">
                    <%= post.weather_emoji if post.weather %>
                    <%= post.feeling_emoji if post.feeling %>
                    <% if post.walk %>
                      <%= "🚶 #{post.walk.distance}m" %>
                    <% end %>
                  </span>
                <% end %>
              </div>
              <% if post.reactions.any? %>
                <div class="mt-1 text-xs text-gray-400">
                  <%= "❤️ #{post.reactions.count}" %>
                </div>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
              <%= time_ago_in_words_game_style(post.created_at) %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
              <%= link_to admin_post_path(post), class: "text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 inline-flex items-center" do %>
                <span class="material-symbols-outlined text-sm mr-1">visibility</span>
                詳細
              <% end %>
              <%= button_to admin_post_path(post), method: :delete, data: { turbo_confirm: "本当に削除しますか？\nこの操作は取り消せません。" }, class: "text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 inline-flex items-center" do %>
                <span class="material-symbols-outlined text-sm mr-1">delete</span>
                削除
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
    <%= paginate @posts %>
  </div>
</div>
</file>

<file path="app/views/admin/posts/show.html.erb">
<div class="max-w-4xl mx-auto">
  <div class="bg-white dark:bg-slate-800 shadow rounded-lg overflow-hidden">
    <!-- ヘッダー -->
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
      <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
        <span class="material-symbols-outlined mr-2">article</span>
        投稿詳細
      </h2>
      <%= link_to admin_posts_path, class: "text-blue-600 hover:text-blue-700 dark:text-blue-400 flex items-center" do %>
        <span class="material-symbols-outlined mr-1">arrow_back</span>
        一覧に戻る
      <% end %>
    </div>

    <!-- 投稿内容 -->
    <div class="p-6">
      <!-- 投稿者情報 -->
      <div class="flex items-center mb-4 pb-4 border-b border-gray-200 dark:border-gray-700">
        <%= user_avatar(@post.user, classes: "h-12 w-12 rounded-full") %>
        <div class="ml-4">
          <div class="text-lg font-medium text-gray-900 dark:text-white">
            <%= @post.user.name %>
          </div>
          <div class="text-sm text-gray-500 dark:text-gray-400">
            <%= l @post.created_at, format: :long %>
          </div>
        </div>
      </div>

      <!-- 本文 -->
      <% if @post.body.present? %>
        <div class="mb-4">
          <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">本文</h3>
          <p class="text-gray-900 dark:text-white whitespace-pre-wrap"><%= @post.body %></p>
        </div>
      <% end %>

      <!-- 天気・気分 -->
      <div class="grid grid-cols-2 gap-4 mb-4">
        <% if @post.weather %>
          <div>
            <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">天気</h3>
            <div class="flex items-center text-2xl">
              <%= @post.weather_emoji %>
              <span class="ml-2 text-base text-gray-600 dark:text-gray-400"><%= @post.weather_label %></span>
            </div>
          </div>
        <% end %>

        <% if @post.feeling %>
          <div>
            <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">気分</h3>
            <div class="flex items-center text-2xl">
              <%= @post.feeling_emoji %>
              <span class="ml-2 text-base text-gray-600 dark:text-gray-400"><%= @post.feeling_label %></span>
            </div>
          </div>
        <% end %>
      </div>

      <!-- 散歩記録 -->
      <% if @post.walk %>
        <div class="mb-4">
          <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">紐付け散歩記録</h3>
          <div class="bg-gray-50 dark:bg-slate-700 rounded-lg p-4">
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="text-gray-500 dark:text-gray-400">距離:</span>
                <span class="ml-2 text-gray-900 dark:text-white font-medium"><%= @post.walk.distance %>m</span>
              </div>
              <div>
                <span class="text-gray-500 dark:text-gray-400">歩数:</span>
                <span class="ml-2 text-gray-900 dark:text-white font-medium"><%= @post.walk.steps || "-" %>歩</span>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <!-- リアクション -->
      <% if @post.reactions.any? %>
        <div class="mb-4">
          <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">リアクション (<%= @post.reactions.count %>)</h3>
          <div class="flex flex-wrap gap-2">
            <% @post.reactions.group_by(&:kind).each do |kind, reactions| %>
              <span class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-sm">
                <%= Reaction.human_enum_name(:kind, kind) %> × <%= reactions.count %>
              </span>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- 削除ボタン -->
      <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
        <%= button_to admin_post_path(@post), method: :delete, data: { turbo_confirm: "本当に削除しますか？\nこの操作は取り消せません。" }, class: "w-full sm:w-auto px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors flex items-center justify-center" do %>
          <span class="material-symbols-outlined mr-2">delete</span>
          この投稿を削除
        <% end %>
      </div>
    </div>
  </div>
</div>
</file>

<file path="app/views/admin/walks/show.html.erb">
<div class="max-w-4xl mx-auto">
  <div class="bg-white dark:bg-slate-800 shadow rounded-lg overflow-hidden">
    <!-- ヘッダー -->
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
      <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
        <span class="material-symbols-outlined mr-2">article</span>
        散歩記録詳細
      </h2>
      <%= link_to admin_walks_path, class: "text-blue-600 hover:text-blue-700 dark:text-blue-400 flex items-center" do %>
        <span class="material-symbols-outlined mr-1">arrow_back</span>
        一覧に戻る
      <% end %>
    </div>

    <!-- 散歩記録内容 -->
    <div class="p-6">
      <!-- ユーザー情報 -->
      <div class="flex items-center mb-6 pb-6 border-b border-gray-200 dark:border-gray-700">
        <%= user_avatar(@walk.user, classes: "h-16 w-16 rounded-full") %>
        <div class="ml-4">
          <div class="text-lg font-medium text-gray-900 dark:text-white">
            <%= @walk.user.name %>
          </div>
          <div class="text-sm text-gray-500 dark:text-gray-400">
            記録日: <%= l @walk.walked_on, format: :long %>
          </div>
        </div>
      </div>

      <!-- 基本情報 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- 距離 -->
        <div class="bg-gray-50 dark:bg-slate-700 rounded-lg p-4">
          <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">距離</h3>
          <% if @walk.distance > 50000 %>
            <p class="text-3xl font-bold text-red-600 dark:text-red-400">
              <%= number_with_delimiter(@walk.distance) %>m
            </p>
            <p class="text-xs text-red-500 dark:text-red-400 mt-1">⚠️ 異常値（50km以上）</p>
          <% else %>
            <p class="text-3xl font-bold text-gray-900 dark:text-white">
              <%= number_with_delimiter(@walk.distance) %>m
            </p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
              <%= number_with_delimiter((@walk.distance / 1000.0).round(2)) %>km
            </p>
          <% end %>
        </div>

        <!-- 歩数 -->
        <div class="bg-gray-50 dark:bg-slate-700 rounded-lg p-4">
          <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">歩数</h3>
          <% if @walk.steps && @walk.steps > 100000 %>
            <p class="text-3xl font-bold text-red-600 dark:text-red-400">
              <%= number_with_delimiter(@walk.steps) %>歩
            </p>
            <p class="text-xs text-red-500 dark:text-red-400 mt-1">⚠️ 異常値（10万歩以上）</p>
          <% elsif @walk.steps %>
            <p class="text-3xl font-bold text-gray-900 dark:text-white">
              <%= number_with_delimiter(@walk.steps) %>歩
            </p>
          <% else %>
            <p class="text-lg text-gray-400 dark:text-gray-500">記録なし</p>
          <% end %>
        </div>

        <!-- 時間 -->
        <% if @walk.duration %>
          <div class="bg-gray-50 dark:bg-slate-700 rounded-lg p-4">
            <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">所要時間</h3>
            <p class="text-2xl font-bold text-gray-900 dark:text-white">
              <%= (@walk.duration / 60).to_i %>分
            </p>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
              <%= number_with_delimiter(@walk.duration) %>秒
            </p>
          </div>
        <% end %>

        <!-- カロリー -->
        <% if @walk.calories_burned %>
          <div class="bg-gray-50 dark:bg-slate-700 rounded-lg p-4">
            <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">消費カロリー</h3>
            <p class="text-2xl font-bold text-gray-900 dark:text-white">
              <%= number_with_delimiter(@walk.calories_burned) %>kcal
            </p>
          </div>
        <% end %>
      </div>

      <!-- 場所 -->
      <% if @walk.location.present? %>
        <div class="mb-6">
          <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">場所</h3>
          <p class="text-gray-900 dark:text-white"><%= @walk.location %></p>
        </div>
      <% end %>

      <!-- メモ -->
      <% if @walk.notes.present? %>
        <div class="mb-6">
          <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">メモ</h3>
          <p class="text-gray-900 dark:text-white whitespace-pre-wrap"><%= @walk.notes %></p>
        </div>
      <% end %>

      <!-- メタ情報 -->
      <div class="mb-6 p-4 bg-gray-50 dark:bg-slate-700 rounded-lg">
        <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">システム情報</h3>
        <div class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
          <p>記録ID: <%= @walk.id %></p>
          <p>作成日時: <%= l @walk.created_at, format: :long %></p>
          <p>更新日時: <%= l @walk.updated_at, format: :long %></p>
        </div>
      </div>

      <!-- 削除ボタン -->
      <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
        <%= button_to admin_walk_path(@walk), method: :delete, data: { turbo_confirm: "本当に削除しますか？\nこの操作は取り消せません。" }, class: "w-full sm:w-auto px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors flex items-center justify-center" do %>
          <span class="material-symbols-outlined mr-2">delete</span>
          この記録を削除
        <% end %>
      </div>
    </div>
  </div>
</div>
</file>

<file path="app/views/devise/mailer/email_changed.html.erb">
<p>Hello <%= @email %>!</p>

<% if @resource.try(:unconfirmed_email?) %>
  <p>We're contacting you to notify you that your email is being changed to <%= @resource.unconfirmed_email %>.</p>
<% else %>
  <p>We're contacting you to notify you that your email has been changed to <%= @resource.email %>.</p>
<% end %>
</file>

<file path="app/views/devise/mailer/password_change.html.erb">
<p>Hello <%= @resource.email %>!</p>

<p>We're contacting you to notify you that your password has been changed.</p>
</file>

<file path="app/views/devise/mailer/reset_password_instructions.html.erb">
<p><%= @resource.email %> 様</p>

<p>パスワード再設定の申請を受け付けました。<br>
以下のリンクをクリックして、新しいパスワードを設定してください。</p>

<p><%= link_to 'パスワードを再設定する', edit_password_url(@resource, reset_password_token: @token) %></p>

<p>もしこのメールに心当たりがない場合は、無視してください。<br>
リンクをクリックしない限り、パスワードは変更されません。</p>
</file>

<file path="app/views/devise/passwords/edit.html.erb">
<% content_for :title, "てくメモ - パスワードの変更" %>

<div class="flex flex-1 flex-col items-center justify-center p-4 pb-24">
  <div class="w-full max-w-md bg-gradient-to-b from-white to-slate-50 dark:bg-gradient-to-br dark:from-slate-900/80 dark:to-indigo-950/80 backdrop-blur-xl border border-gray-100 dark:border-indigo-500/30 shadow-xl dark:shadow-[0_0_20px_rgba(99,102,241,0.2)] rounded-3xl p-6 sm:p-8 transition-all duration-300">

    <!-- Header -->
    <div class="mb-8 flex flex-col items-center text-center">
      <div class="w-16 h-16 bg-cyan-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4 shadow-inner">
        <span class="material-symbols-outlined text-3xl text-cyan-600 dark:text-cyan-400">key</span>
      </div>
      <h1 class="text-2xl font-bold text-gray-800 dark:text-slate-50">新しいパスワードの設定</h1>
      <p class="mt-2 text-sm text-gray-600 dark:text-slate-400">
        セキュリティのため、強力なパスワードを設定してください。
      </p>
    </div>

    <!-- Password Change Form -->
    <%= form_for(resource, as: resource_name, url: password_path(resource_name), html: { method: :put, class: "space-y-6" }) do |f| %>
      <%= render "devise/shared/error_messages", resource: resource %>
      <%= f.hidden_field :reset_password_token %>

      <!-- New Password Field -->
      <div class="space-y-2">
        <%= f.label :password, "新しいパスワード", class: "block text-base font-medium text-gray-700 dark:text-slate-300" %>
        <% if @minimum_password_length %>
          <span class="text-xs text-gray-500 dark:text-slate-400">(<%= @minimum_password_length %>文字以上)</span>
        <% end %>
        <div class="relative">
          <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500">lock</span>
          <%= f.password_field :password,
              autofocus: true,
              autocomplete: "new-password",
              placeholder: "新しいパスワード",
              id: "new-password-field",
              class: "block w-full h-14 pl-12 pr-12 text-base text-gray-900 bg-white dark:bg-slate-900/50 border border-gray-300 dark:border-white/10 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent dark:text-slate-50 dark:placeholder-slate-500 transition-colors duration-200" %>
          <button type="button"
                  onclick="togglePasswordVisibility('new-password-field', 'new-password-icon')"
                  class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500 hover:text-gray-600 dark:hover:text-slate-300 transition-colors">
            <span class="material-symbols-outlined" id="new-password-icon">visibility</span>
          </button>
        </div>
      </div>

      <!-- Password Confirmation Field -->
      <div class="space-y-2">
        <%= f.label :password_confirmation, "新しいパスワード（確認）", class: "block text-base font-medium text-gray-700 dark:text-slate-300" %>
        <div class="relative">
          <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500">lock_clock</span>
          <%= f.password_field :password_confirmation,
              autocomplete: "new-password",
              placeholder: "もう一度入力してください",
              id: "confirm-password-field",
              class: "block w-full h-14 pl-12 pr-12 text-base text-gray-900 bg-white dark:bg-slate-900/50 border border-gray-300 dark:border-white/10 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent dark:text-slate-50 dark:placeholder-slate-500 transition-colors duration-200" %>
          <button type="button"
                  onclick="togglePasswordVisibility('confirm-password-field', 'confirm-password-icon')"
                  class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500 hover:text-gray-600 dark:hover:text-slate-300 transition-colors">
            <span class="material-symbols-outlined" id="confirm-password-icon">visibility</span>
          </button>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="pt-4">
        <%= f.button class: "w-full h-14 group relative flex items-center justify-center bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white text-base font-bold rounded-full shadow-lg shadow-cyan-500/30 transition-all duration-200 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2 dark:ring-offset-slate-900" do %>
          <span class="material-symbols-outlined mr-2 group-hover:rotate-12 transition-transform duration-300">save</span>
          パスワードを変更する
        <% end %>
      </div>
    <% end %>

    <!-- Links -->
    <div class="mt-8 text-center">
      <%= link_to "ログイン画面に戻る", new_session_path(resource_name), class: "inline-flex items-center text-sm font-bold text-cyan-600 dark:text-cyan-400 hover:underline" %>
    </div>

  </div>
</div>

<script>
function togglePasswordVisibility(fieldId, iconId) {
  const field = document.getElementById(fieldId);
  const icon = document.getElementById(iconId);

  if (!field || !icon) return;

  if (field.type === 'password') {
    field.type = 'text';
    icon.textContent = 'visibility_off';
  } else {
    field.type = 'password';
    icon.textContent = 'visibility';
  }
}
</script>
</file>

<file path="app/views/devise/passwords/new.html.erb">
<% content_for :title, "てくメモ - パスワード再設定" %>

<div class="flex flex-1 flex-col items-center justify-center p-4 pb-24">
  <div class="relative w-full max-w-md bg-gradient-to-b from-white to-slate-50 dark:bg-gradient-to-br dark:from-slate-900/80 dark:to-indigo-950/80 backdrop-blur-xl border border-gray-100 dark:border-indigo-500/30 shadow-xl dark:shadow-[0_0_20px_rgba(99,102,241,0.2)] rounded-3xl p-6 sm:p-8 transition-all duration-300 overflow-hidden">

    <!-- Coming Soon Overlay (機能制限用マスク) -->
    <!-- 将来機能を有効化する場合は、この div ブロック全体を削除または非表示にしてください -->
    <div class="absolute inset-0 z-50 bg-white/30 dark:bg-slate-900/40 backdrop-blur-sm flex flex-col items-center justify-center text-center p-6">
      <div class="bg-white dark:bg-slate-800 p-4 rounded-full shadow-2xl mb-6 transform -rotate-6 border border-gray-100 dark:border-slate-700 animate-pulse">
        <span class="material-symbols-outlined text-5xl text-cyan-500">rocket_launch</span>
      </div>
      <h2 class="text-4xl font-black text-gray-800 dark:text-white tracking-widest uppercase drop-shadow-sm mb-2">
        Coming<br>Soon
      </h2>
      <p class="text-sm font-bold text-gray-600 dark:text-slate-300 mb-8">
        現在開発中です。<br>アップデートをお待ちください。
      </p>

      <%= link_to new_session_path(resource_name), class: "px-8 py-3 bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold rounded-full shadow-lg hover:scale-105 transition-transform duration-200 flex items-center" do %>
        <span class="material-symbols-outlined mr-2 text-sm">arrow_back</span>
        戻る
      <% end %>
    </div>

    <!-- Header -->
    <div class="mb-8 flex flex-col items-center text-center">
      <div class="w-16 h-16 bg-cyan-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-4 shadow-inner">
        <span class="material-symbols-outlined text-3xl text-cyan-600 dark:text-cyan-400">lock_reset</span>
      </div>
      <h1 class="text-2xl font-bold text-gray-800 dark:text-slate-50">パスワードの再設定</h1>
      <p class="mt-2 text-sm text-gray-600 dark:text-slate-400 leading-relaxed">
        ご登録のメールアドレスを入力してください。<br>
        再設定用のリンクをお送りします。
      </p>
    </div>

    <!-- Password Reset Form -->
    <%= form_for(resource, as: resource_name, url: password_path(resource_name), html: { method: :post, class: "space-y-6" }) do |f| %>
      <%= render "devise/shared/error_messages", resource: resource %>

      <!-- Email Field -->
      <div class="space-y-2">
        <%= f.label :email, "メールアドレス", class: "block text-base font-medium text-gray-700 dark:text-slate-300" %>
        <div class="relative">
          <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500">mail</span>
          <%= f.email_field :email,
              autofocus: true,
              autocomplete: "email",
              placeholder: "example@email.com",
              class: "block w-full h-14 pl-12 pr-4 text-base text-gray-900 bg-white dark:bg-slate-900/50 border border-gray-300 dark:border-white/10 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent dark:text-slate-50 dark:placeholder-slate-500 transition-colors duration-200" %>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="pt-2">
        <%= f.button class: "w-full h-14 group relative flex items-center justify-center bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white text-base font-bold rounded-full shadow-lg shadow-cyan-500/30 transition-all duration-200 transform hover:scale-[1.02] focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2 dark:ring-offset-slate-900" do %>
          <span class="material-symbols-outlined mr-2 group-hover:-translate-y-0.5 transition-transform duration-300">send</span>
          再設定メールを送信する
        <% end %>
      </div>
    <% end %>

    <!-- Divider -->
    <div class="my-8 flex items-center">
      <div class="flex-1 border-t border-gray-300 dark:border-white/10"></div>
      <span class="px-4 text-sm text-gray-500 dark:text-slate-400">または</span>
      <div class="flex-1 border-t border-gray-300 dark:border-white/10"></div>
    </div>

    <!-- Links -->
    <div class="space-y-4 text-center">
      <!-- Login Link -->
      <div>
        <p class="text-sm text-gray-600 dark:text-slate-400">パスワードを思い出しましたか?</p>
        <%= link_to "ログイン画面に戻る", new_session_path(resource_name), class: "inline-flex items-center mt-1 font-bold text-cyan-600 dark:text-cyan-400 hover:underline" %>
      </div>

      <!-- Sign Up Link -->
      <% if devise_mapping.registerable? %>
        <div class="pt-2">
          <p class="text-sm text-gray-600 dark:text-slate-400">アカウントをお持ちでないですか?</p>
          <%= link_to "新規登録", new_registration_path(resource_name), class: "inline-flex items-center mt-1 font-bold text-cyan-600 dark:text-cyan-400 hover:underline" %>
        </div>
      <% end %>
    </div>

  </div>
</div>
</file>

<file path="app/views/devise/shared/_error_messages.html.erb">
<% if resource.errors.any? %>
  <div id="error_explanation" data-turbo-cache="false" class="mb-6 rounded-lg border border-red-300 bg-red-50 p-4 dark:border-red-700 dark:bg-red-900/20">
    <div class="flex items-center mb-2">
      <span class="material-symbols-outlined text-red-600 dark:text-red-400 mr-2">error</span>
      <h2 class="text-base font-semibold text-red-800 dark:text-red-300">
        <%= I18n.t("errors.messages.not_saved",
                   count: resource.errors.count,
                   resource: resource.class.model_name.human.downcase)
         %>
      </h2>
    </div>
    <ul class="list-disc list-inside space-y-1 text-sm text-red-700 dark:text-red-300">
      <% resource.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
    </ul>
  </div>
<% end %>
</file>

<file path="app/views/devise/shared/_links.html.erb">
<%- if controller_name != 'sessions' %>
  <%= link_to "Log in", new_session_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.registerable? && controller_name != 'registrations' %>
  <%= link_to "Sign up", new_registration_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.recoverable? && controller_name != 'passwords' && controller_name != 'registrations' %>
  <%= link_to "Forgot your password?", new_password_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.confirmable? && controller_name != 'confirmations' %>
  <%= link_to "Didn't receive confirmation instructions?", new_confirmation_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.lockable? && resource_class.unlock_strategy_enabled?(:email) && controller_name != 'unlocks' %>
  <%= link_to "Didn't receive unlock instructions?", new_unlock_path(resource_name) %><br />
<% end %>

<%- if devise_mapping.omniauthable? %>
  <%- resource_class.omniauth_providers.each do |provider| %>
    <%= button_to "Sign in with #{OmniAuth::Utils.camelize(provider)}", omniauth_authorize_path(resource_name, provider), data: { turbo: false } %><br />
  <% end %>
<% end %>
</file>

<file path="app/views/home/index_9d26a2d.html.erb">
<% content_for :title, "てくメモ - ホーム" %>

<div class="flex-1 p-4 pb-24 w-full max-w-2xl mx-auto space-y-4">

  <!-- 今日の散歩ダッシュボード -->
  <!-- 今日の散歩ダッシュボード -->
  <div class="relative block bg-gradient-to-br from-cyan-400 to-indigo-500 dark:from-cyan-600 dark:to-indigo-800 text-white p-6 rounded-3xl shadow-lg transition-all duration-300 hover:shadow-lg hover:scale-[1.01] drop-shadow-2xl group">
    <!-- カード全体をリンク化（Stretched Link） -->
    <%= link_to "", walks_path, class: "absolute inset-0 z-0 rounded-3xl" %>

    <p class="text-xl font-bold font-bold opacity-90 text-shadow">今日の散歩</p>

    <!-- 距離と目標距離 -->
    <div class="flex justify-between items-baseline mt-2">
      <p class="text-4xl font-bold text-shadow">
        <span data-controller="counter"
              data-counter-target-value="<%= (@today_walk&.distance.to_f * 1000).to_i %>">0
        </span>
        <span class="text-base font-medium ml-1 text-shadow">m</span>
      </p>
      <p class="text-lg font-bold opacity-90 text-shadow relative z-10">
        <%= link_to edit_user_path(current_user), class: "text-white hover:text-white transition-all inline-flex items-center gap-0.5 group" do %>
          <span class="group-hover:underline decoration-white/50 underline-offset-4">
            / <%= number_with_delimiter(current_user.target_distance) %>m
          </span>
          <span class="material-symbols-outlined text-[16px] opacity-70 group-hover:opacity-100 transition-opacity">settings</span>
        <% end %>
      </p>
    </div>

    <!-- 距離のプログレスバー -->
    <div class="w-full bg-white/30 rounded-full h-2.5 my-4">
      <div class="bg-gradient-to-r from-lime-300 to-green-400 h-2.5 rounded-full shadow-md" style="width: <%= ((@today_walk&.distance.to_f * 1000) / current_user.target_distance.to_f * 100).clamp(0, 100) %>%"></div>
    </div>

    <!-- 消費カロリー -->
    <div class="flex justify-between text-lg">
      <!-- 歩数 -->
      <div class="flex items-center space-x-2">
        <span class="material-symbols-outlined text-4xl animate-pulse-fast text-shadow w-9 h-9 overflow-hidden">directions_walk</span>
        <div>
          <p class="font-bold text-lg text-shadow"><%= number_with_delimiter(@today_walk&.steps || 0) %> 歩</p>
        </div>
      </div>
      <!-- 消費カロリー -->
      <div class="flex items-center space-x-2">
        <span class="material-symbols-outlined text-4xl animate-pulse-fast text-shadow">local_fire_department</span>
        <div>
          <p class="font-bold text-lg text-shadow"><%= number_with_delimiter(@today_walk&.calories_burned || 0) %> kcal</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 天気予報とランキングのグリッド/カルーセル -->
  <div data-controller="carousel" class="relative group mb-6">
    <!-- カルーセルコンテナ（スマホ: 横スクロール, PC: グリッド） -->
    <!-- py-4: スマホで上下に余白確保、横幅は他のカードと揃える, sm:p-0: PCではoverflow-visibleなので余白不要 -->
    <div data-carousel-target="container" class="flex sm:grid sm:grid-cols-2 gap-4 overflow-x-auto snap-x snap-mandatory scrollbar-hide [&::-webkit-scrollbar]:hidden sm:overflow-visible py-4 sm:p-0" style="scrollbar-width: none; -ms-overflow-style: none;">

      <!-- 天気予報カード -->
      <div data-carousel-target="slide" class="min-w-full sm:min-w-0 snap-center px-1 sm:px-0">
        <div class="relative rounded-3xl shadow-lg transform transition-all duration-300 hover:shadow-lg hover:scale-[1.01] drop-shadow-xl h-full overflow-hidden bg-gradient-to-br from-sky-400 to-blue-600 dark:from-sky-600 dark:to-blue-800">
          <!-- カードヘッダー -->
          <div class="px-3 py-1.5 bg-white/10 dark:bg-black/20 backdrop-blur-sm border-b border-white/20">
            <div class="flex items-center justify-center">
              <div class="flex items-center space-x-0.5 text-white/80 text-sm">
                <span class="material-symbols-outlined font-bold text-base text-white w-5 h-5 overflow-hidden">location_on</span>
                <span class="font-bold text-base text-white"><%= @location_name || "現在地不明" %></span>
              </div>
            </div>
          </div>

          <!-- 天気情報グリッド -->
          <div class="grid grid-cols-2 divide-x divide-white/20">
            <!-- 今日の天気 -->
            <div class="p-3 text-white">
              <div class="text-center">
                <p class="text-sm font-medium opacity-90 mb-1.5 text-shadow">いま</p>
                <% if @weather && @weather[:today] %>
                  <!-- 天気アイコン -->
                  <div class="flex justify-center mb-2">
                    <span class="material-symbols-outlined text-4xl drop-shadow-2xl animate-bounce-slow text-shadow">
                      <%= @weather[:today][:icon] %>
                    </span>
                  </div>
                  <!-- 気温 -->
                  <div class="text-xl font-bold mb-1 text-shadow">
                    <%= @weather[:today][:temp] %><span class="text-sm text-shadow">°C</span>
                  </div>
                <% else %>
                  <div class="flex justify-center mb-2">
                    <span class="material-symbols-outlined text-5xl opacity-50 text-shadow">cloud_off</span>
                  </div>
                  <p class="text-sm opacity-70 text-shadow">取得中...</p>
                <% end %>
              </div>
            </div>

            <!-- 明日の天気 -->
            <div class="p-3 text-white bg-white/5">
              <div class="text-center">
                <p class="text-sm font-medium opacity-90 mb-1.5 text-shadow">あした</p>
                <% if @weather && @weather[:tomorrow] %>
                  <!-- 天気アイコン -->
                  <div class="flex justify-center mb-2">
                    <span class="material-symbols-outlined text-4xl drop-shadow-2xl animate-bounce-slow text-shadow">
                      <%= @weather[:tomorrow][:icon] %>
                    </span>
                  </div>
                  <!-- 気温 -->
                  <div class="text-xl font-bold mb-1 text-shadow">
                    <%= @weather[:tomorrow][:temp] %><span class="text-sm text-shadow">°C</span>
                  </div>
                <% else %>
                  <div class="flex justify-center mb-2">
                    <span class="material-symbols-outlined text-5xl opacity-50 text-shadow">cloud_off</span>
                  </div>
                  <p class="text-sm opacity-70 text-shadow">取得中...</p>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ランキングカード -->
      <div data-carousel-target="slide" class="min-w-full sm:min-w-0 snap-center px-1 sm:px-0">
        <div class="relative rounded-3xl shadow-lg transform transition-all duration-300 hover:shadow-xl hover:scale-[1.01] drop-shadow-lg h-full overflow-hidden bg-gradient-to-br from-sky-400 to-blue-700 dark:from-sky-600 dark:to-blue-900">
          <div class="p-3 h-full flex items-center justify-between relative">

            <div class="flex flex-col justify-center z-10">
              <div class="flex items-center space-x-1 mb-1 opacity-80">
                <span class="material-symbols-outlined text-3xl sm:text-4xl text-white w-10 h-10 overflow-hidden">trophy</span>
                <span class="text-sm sm:text-base font-bold text-white uppercase tracking-widest">Rank</span>
              </div>
              <div class="text-white">
                <span class="text-4xl sm:text-5xl font-bold font-mono tracking-tighter text-shadow">03</span>
                <span class="text-sm font-bold opacity-70">/ 24</span>
              </div>
              <!-- リボン風バッジ -->
              <div class="mt-2 relative inline-block">
                 <div class="absolute inset-0 bg-gradient-to-r from-yellow-300 to-orange-500 rounded-sm transform -skew-x-12 shadow-lg border border-white/20"></div>
                 <div class="relative px-2 py-0.5 flex items-center space-x-1">
                    <span class="material-symbols-outlined text-[14px] sm:text-[16px] text-yellow-900 w-5 h-4 overflow-hidden">workspace_premium</span>
                    <span class="text-[10px] sm:text-xs font-black text-yellow-900 uppercase tracking-wider">Top 15%</span>
                 </div>
              </div>
            </div>

            <div class="relative w-20 h-20 sm:w-24 sm:h-24 flex items-center justify-center">
              <svg class="w-full h-full transform -rotate-90">
                <defs>
                  <linearGradient id="gold-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#fef9c3" />
                    <stop offset="50%" stop-color="#fde047" />
                    <stop offset="100%" stop-color="#eab308" />
                  </linearGradient>
                </defs>
                <circle cx="50%" cy="50%" r="45%" stroke="currentColor" stroke-width="8" fill="transparent" class="text-white/20" />
                <circle cx="50%" cy="50%" r="45%" stroke="url(#gold-gradient)" stroke-width="8" fill="transparent" stroke-dasharray="226" stroke-dashoffset="34" stroke-linecap="round" class="drop-shadow-[0_0_8px_rgba(234,179,8,0.6)]" />
              </svg>
              <!-- 背面：光る影用（単色・不透明） -->
              <span class="absolute material-symbols-outlined text-6xl sm:text-7xl text-yellow-500 animate-sparkle">emoji_events</span>
              <!-- 前面：質感用（グラデーション・透明テキスト） -->
              <span class="absolute material-symbols-outlined text-6xl sm:text-7xl bg-gradient-to-b from-yellow-100 via-yellow-300 to-yellow-600 bg-clip-text text-transparent animate-sparkle-scale">emoji_events</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- インジケーター（スマホのみ表示） -->
    <div class="absolute bottom-6 left-0 right-0 flex justify-center space-x-2 sm:hidden z-10 pointer-events-none">
      <button type="button" data-action="carousel#scrollToSlide" data-index="0" data-carousel-target="indicator" class="w-2 h-2 rounded-full bg-white transition-all duration-300 shadow-sm pointer-events-auto"></button>
      <button type="button" data-action="carousel#scrollToSlide" data-index="1" data-carousel-target="indicator" class="w-2 h-2 rounded-full bg-white/40 transition-all duration-300 hover:bg-white/60 shadow-sm pointer-events-auto"></button>
    </div>
  </div>

  <!-- 下段グリッド：最新の投稿とメモ帳 -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <!-- 最新の投稿カード -->
    <!-- 最新の投稿カード -->
    <div class="bg-gradient-to-br from-blue-50/90 to-white/90 dark:from-slate-800/90 dark:to-slate-900/90 backdrop-blur-xl border border-blue-200 dark:border-blue-800/30 p-4 rounded-3xl shadow-lg transition-all duration-300 hover:shadow-xl hover:scale-[1.01] group">
      <h3 class="font-bold text-blue-900 dark:text-blue-100 mb-3 flex items-center">
        <span class="material-symbols-outlined mr-2 text-blue-600 dark:text-blue-400 group-hover:text-blue-700 dark:group-hover:text-blue-300 transition-colors">article</span>
        最新の投稿
      </h3>
      <div class="bg-white/60 dark:bg-slate-900/50 p-3 rounded-xl border border-blue-100 dark:border-blue-800/50 shadow-inner">
        <p class="text-sm text-blue-900 dark:text-blue-200 line-clamp-3 font-medium leading-relaxed">
          まだ投稿はありません。<br>
          <span class="text-xs text-blue-600 dark:text-blue-400 mt-1 block">散歩の記録をシェアしてみましょう！</span>
        </p>
      </div>
    </div>

    <!-- メモ帳カード -->
    <!-- メモ帳カード -->
    <%= link_to "https://keep.google.com/", target: "_blank", rel: "noopener noreferrer", class: "block bg-gradient-to-br from-cyan-50/90 to-white/90 dark:from-slate-800/90 dark:to-slate-900/90 backdrop-blur-xl border border-cyan-200 dark:border-cyan-800/30 p-5 rounded-3xl shadow-lg relative overflow-hidden transition-all duration-300 hover:shadow-xl hover:scale-[1.01] group" do %>
      <div class="flex justify-between items-end relative z-10">
        <div>
          <h3 class="font-bold text-lg mb-2 text-cyan-900 dark:text-cyan-100 text-shadow-sm">メモ帳</h3>
          <span class="material-symbols-outlined text-4xl text-cyan-700/50 dark:text-cyan-300/50 -ml-1 transform -rotate-12">note_stack</span>
        </div>
        <div>
          <button type="button" class="bg-white dark:bg-gray-700/80 text-green-600 dark:text-cyan-200 font-bold py-2 px-4 rounded-full shadow-lg flex items-center space-x-1 group-hover:bg-white dark:group-hover:bg-gray-700 transition-colors">
            <span class="material-symbols-outlined text-lg w-5 h-5 overflow-hidden">add</span>
            <span class="text-sm font-bold">メモ帳を開く</span>
          </button>
          <p class="text-sm font-bold text-right mt-1 text-cyan-800/80 dark:text-cyan-200/80">Google Keep に保存</p>
        </div>
      </div>

      <!-- 装飾用サークル -->
      <div class="absolute -top-4 -right-4 w-24 h-24 bg-white/20 rounded-full blur-2xl pointer-events-none"></div>
    <% end %>
  </div>

  <!-- 運営からのお知らせカード -->
  <div class="space-y-4">
    <!-- 運営からのお知らせカード -->
    <div class="relative bg-gradient-to-br from-purple-100 to-indigo-200 dark:from-purple-700 dark:to-indigo-900 p-5 rounded-3xl shadow-lg transition-all duration-300 hover:shadow-xl hover:scale-[1.01] drop-shadow-lg group overflow-hidden">
      <!-- 背景装飾（巨大アイコン） -->
      <span class="material-symbols-outlined absolute -right-4 -bottom-4 text-9xl text-white/10 transform rotate-12 group-hover:rotate-0 transition-transform duration-500 pointer-events-none">campaign</span>

      <!-- ヘッダー -->
      <div class="relative z-10 flex justify-between items-start mb-4">
        <div class="flex items-center space-x-2">
          <div class="bg-white/20 p-2 rounded-full backdrop-blur-sm shadow-sm">
            <span class="material-symbols-outlined text-purple-900 text-xl">notifications_active</span>
          </div>
          <h3 class="font-bold text-purple-900 text-lg text-shadow-sm">運営からのお知らせ</h3>
        </div>
      </div>

      <!-- コンテンツ -->
      <div class="relative z-10 bg-white/10 backdrop-blur-md rounded-xl p-3 border border-white/20 shadow-inner">
        <div class="flex items-start space-x-3">
          <div class="flex-shrink-0 mt-0.5 flex flex-col items-center space-y-1">
            <span class="text-xs font-bold bg-white/20 text-purple-900 px-2 py-0.5 rounded-md shadow-sm">11/23</span>
            <span class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm animate-pulse">NEW</span>
          </div>
          <p class="text-sm text-purple-900 font-medium leading-relaxed text-shadow-sm">
            MVPリリースに近いところまで完成しました！<br>
            <span class="text-xs text-purple-900/80 mt-1 block">引き続き機能改善を行っていきます。</span>
          </p>
        </div>
      </div>
    </div>


  </div>
</div>
</file>

<file path="app/views/home/index_old.html.erb">
<% content_for :title, "てくメモ - ホーム" %>

<div class="flex-1 p-4 pb-24 w-full max-w-2xl mx-auto space-y-4">

  <!-- 今日の散歩ダッシュボード -->
  <!-- 今日の散歩ダッシュボード -->
  <div class="relative block bg-gradient-to-br from-cyan-400 to-indigo-500 dark:from-cyan-600 dark:to-indigo-800 text-white p-6 rounded-3xl shadow-lg transition-all duration-300 hover:shadow-lg hover:scale-[1.01] drop-shadow-2xl group">
    <!-- カード全体をリンク化（Stretched Link） -->
    <%= link_to "", walks_path, class: "absolute inset-0 z-0 rounded-3xl" %>

    <p class="text-xl font-bold font-bold opacity-90 text-shadow">今日の散歩</p>

    <!-- 距離と目標距離 -->
    <div class="flex justify-between items-baseline mt-2">
      <p class="text-4xl font-bold text-shadow">
        <span data-controller="counter"
              data-counter-target-value="<%= (@today_walk&.distance.to_f * 1000).to_i %>">0
        </span>
        <span class="text-base font-medium ml-1 text-shadow">m</span>
      </p>
      <p class="text-lg font-bold opacity-90 text-shadow relative z-10">
        <%= link_to edit_user_path(current_user), class: "text-white hover:text-white transition-all inline-flex items-center gap-0.5 group" do %>
          <span class="group-hover:underline decoration-white/50 underline-offset-4">
            / <%= number_with_delimiter(current_user.target_distance) %>m
          </span>
          <span class="material-symbols-outlined text-[16px] opacity-70 group-hover:opacity-100 transition-opacity">settings</span>
        <% end %>
      </p>
    </div>

    <!-- 距離のプログレスバー -->
    <div class="w-full bg-white/30 rounded-full h-2.5 my-4">
      <div class="bg-gradient-to-r from-lime-300 to-green-400 h-2.5 rounded-full shadow-md" style="width: <%= ((@today_walk&.distance.to_f * 1000) / current_user.target_distance.to_f * 100).clamp(0, 100) %>%"></div>
    </div>

    <!-- 消費カロリー -->
    <div class="flex justify-between text-lg">
      <!-- 歩数 -->
      <div class="flex items-center space-x-2">
        <span class="material-symbols-outlined text-4xl animate-pulse-fast text-shadow w-9 h-9 overflow-hidden">directions_walk</span>
        <div>
          <p class="font-bold text-lg text-shadow"><%= number_with_delimiter(@today_walk&.steps || 0) %> 歩</p>
        </div>
      </div>
      <!-- 消費カロリー -->
      <div class="flex items-center space-x-2">
        <span class="material-symbols-outlined text-4xl animate-pulse-fast text-shadow">local_fire_department</span>
        <div>
          <p class="font-bold text-lg text-shadow"><%= number_with_delimiter(@today_walk&.calories_burned || 0) %> kcal</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 天気予報とランキングのグリッド/カルーセル -->
  <div data-controller="carousel" class="relative group mb-6">
    <!-- カルーセルコンテナ（スマホ: 横スクロール, PC: グリッド） -->
    <!-- py-4: スマホで上下に余白確保、横幅は他のカードと揃える, sm:p-0: PCではoverflow-visibleなので余白不要 -->
    <div data-carousel-target="container" class="flex sm:grid sm:grid-cols-2 gap-4 overflow-x-auto snap-x snap-mandatory scrollbar-hide [&::-webkit-scrollbar]:hidden sm:overflow-visible py-4 sm:p-0" style="scrollbar-width: none; -ms-overflow-style: none;">

      <!-- 天気予報カード -->
      <div data-carousel-target="slide" class="min-w-full sm:min-w-0 snap-center px-1 sm:px-0">
        <div class="relative rounded-3xl shadow-lg transform transition-all duration-300 hover:shadow-lg hover:scale-[1.01] drop-shadow-xl h-full overflow-hidden bg-gradient-to-br from-sky-400 to-blue-600 dark:from-sky-600 dark:to-blue-800">
          <!-- カードヘッダー -->
          <div class="px-3 py-1.5 bg-white/10 dark:bg-black/20 backdrop-blur-sm border-b border-white/20">
            <div class="flex items-center justify-center">
              <div class="flex items-center space-x-0.5 text-white/80 text-sm">
                <span class="material-symbols-outlined font-bold text-base text-white w-5 h-5 overflow-hidden">location_on</span>
                <span class="font-bold text-base text-white"><%= @location_name || "現在地不明" %></span>
              </div>
            </div>
          </div>

          <!-- 天気情報グリッド -->
          <div class="grid grid-cols-2 divide-x divide-white/20">
            <!-- 今日の天気 -->
            <div class="p-3 text-white">
              <div class="text-center">
                <p class="text-sm font-medium opacity-90 mb-1.5 text-shadow">いま</p>
                <% if @weather && @weather[:today] %>
                  <!-- 天気アイコン -->
                  <div class="flex justify-center mb-2">
                    <span class="material-symbols-outlined text-4xl drop-shadow-2xl animate-bounce-slow text-shadow">
                      <%= @weather[:today][:icon] %>
                    </span>
                  </div>
                  <!-- 気温 -->
                  <div class="text-xl font-bold mb-1 text-shadow">
                    <%= @weather[:today][:temp] %><span class="text-sm text-shadow">°C</span>
                  </div>
                <% else %>
                  <div class="flex justify-center mb-2">
                    <span class="material-symbols-outlined text-5xl opacity-50 text-shadow">cloud_off</span>
                  </div>
                  <p class="text-sm opacity-70 text-shadow">取得中...</p>
                <% end %>
              </div>
            </div>

            <!-- 明日の天気 -->
            <div class="p-3 text-white bg-white/5">
              <div class="text-center">
                <p class="text-sm font-medium opacity-90 mb-1.5 text-shadow">あした</p>
                <% if @weather && @weather[:tomorrow] %>
                  <!-- 天気アイコン -->
                  <div class="flex justify-center mb-2">
                    <span class="material-symbols-outlined text-4xl drop-shadow-2xl animate-bounce-slow text-shadow">
                      <%= @weather[:tomorrow][:icon] %>
                    </span>
                  </div>
                  <!-- 気温 -->
                  <div class="text-xl font-bold mb-1 text-shadow">
                    <%= @weather[:tomorrow][:temp] %><span class="text-sm text-shadow">°C</span>
                  </div>
                <% else %>
                  <div class="flex justify-center mb-2">
                    <span class="material-symbols-outlined text-5xl opacity-50 text-shadow">cloud_off</span>
                  </div>
                  <p class="text-sm opacity-70 text-shadow">取得中...</p>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ランキングカード -->
      <div data-carousel-target="slide" class="min-w-full sm:min-w-0 snap-center px-1 sm:px-0">
        <div class="relative rounded-3xl shadow-lg transform transition-all duration-300 hover:shadow-xl hover:scale-[1.01] drop-shadow-lg h-full overflow-hidden bg-gradient-to-br from-sky-400 to-blue-700 dark:from-sky-600 dark:to-blue-900">
          <div class="p-3 h-full flex items-center justify-between relative">

            <div class="flex flex-col justify-center z-10">
              <div class="flex items-center space-x-1 mb-1 opacity-80">
                <span class="material-symbols-outlined text-3xl sm:text-4xl text-white w-10 h-10 overflow-hidden">trophy</span>
                <span class="text-sm sm:text-base font-bold text-white uppercase tracking-widest">Rank</span>
              </div>
              <div class="text-white">
                <span class="text-4xl sm:text-5xl font-bold font-mono tracking-tighter text-shadow">03</span>
                <span class="text-sm font-bold opacity-70">/ 24</span>
              </div>
              <!-- リボン風バッジ -->
              <div class="mt-2 relative inline-block">
                 <div class="absolute inset-0 bg-gradient-to-r from-yellow-300 to-orange-500 rounded-sm transform -skew-x-12 shadow-lg border border-white/20"></div>
                 <div class="relative px-2 py-0.5 flex items-center space-x-1">
                    <span class="material-symbols-outlined text-[14px] sm:text-[16px] text-yellow-900 w-5 h-4 overflow-hidden">workspace_premium</span>
                    <span class="text-[10px] sm:text-xs font-black text-yellow-900 uppercase tracking-wider">Top 15%</span>
                 </div>
              </div>
            </div>

            <div class="relative w-20 h-20 sm:w-24 sm:h-24 flex items-center justify-center">
              <svg class="w-full h-full transform -rotate-90">
                <defs>
                  <linearGradient id="gold-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#fef9c3" />
                    <stop offset="50%" stop-color="#fde047" />
                    <stop offset="100%" stop-color="#eab308" />
                  </linearGradient>
                </defs>
                <circle cx="50%" cy="50%" r="45%" stroke="currentColor" stroke-width="8" fill="transparent" class="text-white/20" />
                <circle cx="50%" cy="50%" r="45%" stroke="url(#gold-gradient)" stroke-width="8" fill="transparent" stroke-dasharray="226" stroke-dashoffset="34" stroke-linecap="round" class="drop-shadow-[0_0_8px_rgba(234,179,8,0.6)]" />
              </svg>
              <!-- 背面：光る影用（単色・不透明） -->
              <span class="absolute material-symbols-outlined text-6xl sm:text-7xl text-yellow-500 animate-sparkle">emoji_events</span>
              <!-- 前面：質感用（グラデーション・透明テキスト） -->
              <span class="absolute material-symbols-outlined text-6xl sm:text-7xl bg-gradient-to-b from-yellow-100 via-yellow-300 to-yellow-600 bg-clip-text text-transparent animate-sparkle-scale">emoji_events</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- インジケーター（スマホのみ表示） -->
    <div class="absolute bottom-6 left-0 right-0 flex justify-center space-x-2 sm:hidden z-10 pointer-events-none">
      <button type="button" data-action="carousel#scrollToSlide" data-index="0" data-carousel-target="indicator" class="w-2 h-2 rounded-full bg-white transition-all duration-300 shadow-sm pointer-events-auto"></button>
      <button type="button" data-action="carousel#scrollToSlide" data-index="1" data-carousel-target="indicator" class="w-2 h-2 rounded-full bg-white/40 transition-all duration-300 hover:bg-white/60 shadow-sm pointer-events-auto"></button>
    </div>
  </div>

  <!-- 下段グリッド：最新の投稿とメモ帳 -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <!-- 最新の投稿カード -->
    <!-- 最新の投稿カード -->
    <div class="bg-gradient-to-br from-blue-50/90 to-white/90 dark:from-slate-800/90 dark:to-slate-900/90 backdrop-blur-xl border border-blue-200 dark:border-blue-800/30 p-4 rounded-3xl shadow-lg transition-all duration-300 hover:shadow-xl hover:scale-[1.01] group">
      <h3 class="font-bold text-blue-900 dark:text-blue-100 mb-3 flex items-center">
        <span class="material-symbols-outlined mr-2 text-blue-600 dark:text-blue-400 group-hover:text-blue-700 dark:group-hover:text-blue-300 transition-colors">article</span>
        最新の投稿
      </h3>
      <div class="bg-white/60 dark:bg-slate-900/50 p-3 rounded-xl border border-blue-100 dark:border-blue-800/50 shadow-inner">
        <p class="text-sm text-blue-900 dark:text-blue-200 line-clamp-3 font-medium leading-relaxed">
          まだ投稿はありません。<br>
          <span class="text-xs text-blue-600 dark:text-blue-400 mt-1 block">散歩の記録をシェアしてみましょう！</span>
        </p>
      </div>
    </div>

    <!-- メモ帳カード -->
    <!-- メモ帳カード -->
    <%= link_to "https://keep.google.com/", target: "_blank", rel: "noopener noreferrer", class: "block bg-gradient-to-br from-cyan-50/90 to-white/90 dark:from-slate-800/90 dark:to-slate-900/90 backdrop-blur-xl border border-cyan-200 dark:border-cyan-800/30 p-5 rounded-3xl shadow-lg relative overflow-hidden transition-all duration-300 hover:shadow-xl hover:scale-[1.01] group" do %>
      <div class="flex justify-between items-end relative z-10">
        <div>
          <h3 class="font-bold text-lg mb-2 text-cyan-900 dark:text-cyan-100 text-shadow-sm">メモ帳</h3>
          <span class="material-symbols-outlined text-4xl text-cyan-700/50 dark:text-cyan-300/50 -ml-1 transform -rotate-12">note_stack</span>
        </div>
        <div>
          <button type="button" class="bg-white dark:bg-gray-700/80 text-green-600 dark:text-cyan-200 font-bold py-2 px-4 rounded-full shadow-lg flex items-center space-x-1 group-hover:bg-white dark:group-hover:bg-gray-700 transition-colors">
            <span class="material-symbols-outlined text-lg w-5 h-5 overflow-hidden">add</span>
            <span class="text-sm font-bold">メモ帳を開く</span>
          </button>
          <p class="text-sm font-bold text-right mt-1 text-cyan-800/80 dark:text-cyan-200/80">Google Keep に保存</p>
        </div>
      </div>

      <!-- 装飾用サークル -->
      <div class="absolute -top-4 -right-4 w-24 h-24 bg-white/20 rounded-full blur-2xl pointer-events-none"></div>
    <% end %>
  </div>

  <!-- 運営からのお知らせカード -->
  <div class="space-y-4">
    <!-- 運営からのお知らせカード -->
    <div class="relative bg-gradient-to-br from-purple-100 to-indigo-200 dark:from-purple-700 dark:to-indigo-900 p-5 rounded-3xl shadow-lg transition-all duration-300 hover:shadow-xl hover:scale-[1.01] drop-shadow-lg group overflow-hidden">
      <!-- 背景装飾（巨大アイコン） -->
      <span class="material-symbols-outlined absolute -right-4 -bottom-4 text-9xl text-white/10 transform rotate-12 group-hover:rotate-0 transition-transform duration-500 pointer-events-none">campaign</span>

      <!-- ヘッダー -->
      <div class="relative z-10 flex justify-between items-start mb-4">
        <div class="flex items-center space-x-2">
          <div class="bg-white/20 p-2 rounded-full backdrop-blur-sm shadow-sm">
            <span class="material-symbols-outlined text-purple-900 text-xl">notifications_active</span>
          </div>
          <h3 class="font-bold text-purple-900 text-lg text-shadow-sm">運営からのお知らせ</h3>
        </div>
      </div>

      <!-- コンテンツ -->
      <div class="relative z-10 bg-white/10 backdrop-blur-md rounded-xl p-3 border border-white/20 shadow-inner">
        <div class="flex items-start space-x-3">
          <div class="flex-shrink-0 mt-0.5 flex flex-col items-center space-y-1">
            <span class="text-xs font-bold bg-white/20 text-purple-900 px-2 py-0.5 rounded-md shadow-sm">11/23</span>
            <span class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm animate-pulse">NEW</span>
          </div>
          <p class="text-sm text-purple-900 font-medium leading-relaxed text-shadow-sm">
            MVPリリースに近いところまで完成しました！<br>
            <span class="text-xs text-purple-900/80 mt-1 block">引き続き機能改善を行っていきます。</span>
          </p>
        </div>
      </div>
    </div>


  </div>
</div>
</file>

<file path="app/views/kaminari/_first_page.html.erb">
<%= link_to url, remote: remote, class: "hidden sm:flex items-center justify-center w-10 h-10 rounded-full bg-white dark:bg-slate-800 text-gray-400 dark:text-gray-500 shadow-sm border border-gray-100 dark:border-slate-700 hover:bg-sky-50 dark:hover:bg-slate-700 hover:text-sky-600 dark:hover:text-sky-400 hover:shadow-md transition-all duration-300 group mr-2", aria: { label: t('views.pagination.first') } do %>
  <span class="material-symbols-outlined text-xl group-hover:scale-110 transition-transform">first_page</span>
<% end %>
</file>

<file path="app/views/kaminari/_gap.html.erb">
<span class="flex items-center justify-center w-10 h-10 text-gray-300 dark:text-gray-600 select-none">
  <span class="material-symbols-outlined text-lg">more_horiz</span>
</span>
</file>

<file path="app/views/kaminari/_last_page.html.erb">
<%= link_to url, remote: remote, class: "hidden sm:flex items-center justify-center w-10 h-10 rounded-full bg-white dark:bg-slate-800 text-gray-400 dark:text-gray-500 shadow-sm border border-gray-100 dark:border-slate-700 hover:bg-sky-50 dark:hover:bg-slate-700 hover:text-sky-600 dark:hover:text-sky-400 hover:shadow-md transition-all duration-300 group ml-2", aria: { label: t('views.pagination.last') } do %>
  <span class="material-symbols-outlined text-xl group-hover:scale-110 transition-transform">last_page</span>
<% end %>
</file>

<file path="app/views/kaminari/_next_page.html.erb">
<%= link_to url, remote: remote, rel: 'next', class: "flex items-center justify-center w-10 h-10 rounded-full bg-white dark:bg-slate-800 text-gray-500 dark:text-gray-400 shadow-sm border border-gray-100 dark:border-slate-700 hover:bg-sky-50 dark:hover:bg-slate-700 hover:text-sky-600 dark:hover:text-sky-400 hover:shadow-md hover:translate-x-1 transition-all duration-300 group", aria: { label: t('views.pagination.next') } do %>
  <span class="material-symbols-outlined text-xl group-hover:scale-110 transition-transform">chevron_right</span>
<% end %>
</file>

<file path="app/views/kaminari/_page.html.erb">
<% if page.current? %>
  <span class="flex items-center justify-center w-10 h-10 rounded-full bg-gradient-to-r from-sky-400 to-blue-500 text-white font-bold shadow-lg shadow-sky-200 dark:shadow-[0_0_10px_rgba(14,165,233,0.5)] transform scale-110 transition-all duration-300 cursor-default">
    <%= page %>
  </span>
<% else %>
  <%= link_to page, url, remote: remote, rel: page.rel, class: "flex items-center justify-center w-10 h-10 rounded-full bg-white dark:bg-slate-800 text-gray-600 dark:text-gray-300 font-medium shadow-sm border border-gray-100 dark:border-slate-700 hover:bg-sky-50 dark:hover:bg-slate-700 hover:text-sky-600 dark:hover:text-sky-400 hover:shadow-md hover:scale-110 hover:border-sky-200 dark:hover:border-sky-500/30 transition-all duration-300" %>
<% end %>
</file>

<file path="app/views/kaminari/_paginator.html.erb">
<%= paginator.render do -%>
  <nav class="flex flex-wrap justify-center items-center gap-2" role="navigation" aria-label="pager">
    <%= first_page_tag unless current_page.first? %>
    <%= prev_page_tag unless current_page.first? %>
    <% each_page do |page| -%>
      <% if page.left_outer? || page.right_outer? || page.inside_window? -%>
        <%= page_tag page %>
      <% elsif !page.was_truncated? -%>
        <%= gap_tag %>
      <% end -%>
    <% end -%>
    <%= next_page_tag unless current_page.last? %>
    <%= last_page_tag unless current_page.last? %>
  </nav>
<% end -%>
</file>

<file path="app/views/kaminari/_prev_page.html.erb">
<%= link_to url, remote: remote, rel: 'prev', class: "flex items-center justify-center w-10 h-10 rounded-full bg-white dark:bg-slate-800 text-gray-500 dark:text-gray-400 shadow-sm border border-gray-100 dark:border-slate-700 hover:bg-sky-50 dark:hover:bg-slate-700 hover:text-sky-600 dark:hover:text-sky-400 hover:shadow-md hover:-translate-x-1 transition-all duration-300 group", aria: { label: t('views.pagination.previous') } do %>
  <span class="material-symbols-outlined text-xl group-hover:scale-110 transition-transform">chevron_left</span>
<% end %>
</file>

<file path="app/views/layouts/_flash.html.erb">
<% if notice.present? %>
  <div class="mx-auto max-w-2xl px-4 py-2">
    <div class="bg-blue-100 dark:bg-blue-900/30 border border-blue-400 dark:border-blue-600 text-blue-700 dark:text-blue-300 px-4 py-3 rounded-xl relative animate-fade-in-down" role="alert">
      <span class="block sm:inline"><%= notice %></span>
    </div>
  </div>
<% end %>

<% if alert.present? %>
  <div class="mx-auto max-w-2xl px-4 py-2">
    <div class="bg-red-100 dark:bg-red-900/30 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-300 px-4 py-3 rounded-xl relative animate-fade-in-down" role="alert">
      <span class="block sm:inline"><%= alert %></span>
    </div>
  </div>
<% end %>
</file>

<file path="app/views/layouts/admin.html.erb">
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>管理画面 - てくメモ</title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=block" rel="stylesheet">

  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>

  <script>
    (function() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>
</head>

<body class="min-h-screen bg-gray-50 dark:bg-slate-900 font-display transition-colors duration-200">
  <div class="flex flex-col min-h-screen">
    <!-- 管理画面ヘッダー -->
    <header class="bg-slate-800 text-white shadow-md z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <%= link_to admin_announcements_path, class: "flex items-center space-x-2" do %>
              <span class="material-symbols-outlined text-orange-400 text-3xl">admin_panel_settings</span>
              <span class="font-bold text-xl tracking-tight">てくメモ 管理画面</span>
            <% end %>

            <!-- PC用ナビゲーション -->
            <nav class="hidden md:ml-10 md:flex space-x-8">
              <%= link_to admin_root_path, class: "text-gray-300 hover:bg-slate-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium flex items-center #{current_page?(admin_root_path) ? 'bg-slate-900 text-white' : ''}" do %>
                <span class="material-symbols-outlined mr-1 text-lg">dashboard</span>
                ダッシュボード
              <% end %>

              <%= link_to admin_announcements_path, class: "text-gray-300 hover:bg-slate-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium flex items-center #{current_page?(admin_announcements_path) ? 'bg-slate-900 text-white' : ''}" do %>
                <span class="material-symbols-outlined mr-1 text-lg">campaign</span>
                お知らせ管理
              <% end %>

              <%= link_to admin_users_path, class: "text-gray-300 hover:bg-slate-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium flex items-center #{current_page?(admin_users_path) ? 'bg-slate-900 text-white' : ''}" do %>
                <span class="material-symbols-outlined mr-1 text-lg">group</span>
                ユーザー管理
              <% end %>

              <%= link_to admin_posts_path, class: "text-gray-300 hover:bg-slate-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium flex items-center #{current_page?(admin_posts_path) ? 'bg-slate-900 text-white' : ''}" do %>
                <span class="material-symbols-outlined mr-1 text-lg">edit_square</span>
                投稿管理
              <% end %>

              <%= link_to admin_walks_path, class: "text-gray-300 hover:bg-slate-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium flex items-center #{current_page?(admin_walks_path) ? 'bg-slate-900 text-white' : ''}" do %>
                <span class="material-symbols-outlined mr-1 text-lg">footprint</span>
                散歩記録管理
              <% end %>
            </nav>
          </div>

          <div class="flex items-center space-x-4">
            <%= link_to root_path, class: "text-gray-300 hover:text-white text-sm flex items-center" do %>
              <span class="material-symbols-outlined mr-1 text-lg">logout</span>
              アプリに戻る
            <% end %>
          </div>
        </div>
      </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="flex-1 w-full max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <!-- Flashメッセージ -->
      <div id="flash_messages" class="mb-6">
        <% if notice.present? %>
          <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
            <span class="block sm:inline"><%= notice %></span>
          </div>
        <% end %>
        <% if alert.present? %>
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
            <span class="block sm:inline"><%= alert %></span>
          </div>
        <% end %>
      </div>

      <%= yield %>
    </main>
  </div>
</body>
</html>
</file>

<file path="app/views/layouts/mailer.html.erb">
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style>
      /* Email styles need to be inline */
    </style>
  </head>

  <body>
    <%= yield %>
  </body>
</html>
</file>

<file path="app/views/layouts/mailer.text.erb">
<%= yield %>
</file>

<file path="app/views/pwa/manifest.json.erb">
{
  "name": "てくメモ",
  "short_name": "てくメモ",
  "description": "あなたの散歩を記録・共有するSNSアプリ。歩数、距離、カロリーを記録して、仲間と楽しく習慣化しよう！",
  "icons": [
    {
      "src": "/icon.png",
      "type": "image/png",
      "sizes": "192x192"
    },
    {
      "src": "/512x512.png",
      "type": "image/png",
      "sizes": "512x512"
    },
    {
      "src": "/512x512.png",
      "type": "image/png",
      "sizes": "512x512",
      "purpose": "maskable"
    }
  ],
  "start_url": "/",
  "display": "standalone",
  "scope": "/",
  "theme_color": "#3b82f6",
  "background_color": "#ffffff",
  "orientation": "portrait-primary",
  "categories": ["health", "social", "lifestyle"]
}
</file>

<file path="app/views/pwa/service-worker.js">
// てくメモ PWA Service Worker
// バージョン管理：アプリを更新する際はバージョンを上げる
const CACHE_VERSION = 'tekumemo-v3'; // キャッシュ対象ページ追加（/stats, /login_stamps）
const CACHE_NAME = `${CACHE_VERSION}`;

// キャッシュ対象のファイル（アプリの起動に最低限必要なもの）
const PRECACHE_URLS = [
  '/',
  '/walks',
  '/posts',
  '/rankings',
  '/stats',
  '/login_stamps',
  '/icon.png',
  '/512x512.png',
  '/favicon.ico'
];

// ========================================
// 1. インストール時の処理
// ========================================
self.addEventListener('install', (event) => {
  console.log('[Service Worker] Install');

  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => {
        console.log('[Service Worker] Pre-caching offline page');
        // 1つずつキャッシュして、どれが失敗するか特定
        return Promise.all(
          PRECACHE_URLS.map(url => {
            return cache.add(url).then(() => {
              console.log('[Service Worker] Cached:', url);
            }).catch(err => {
              console.error('[Service Worker] Failed to cache:', url, err);
            });
          })
        );
      })
      .then(() => {
        console.log('[Service Worker] All files cached successfully');
        return self.skipWaiting();
      })
      .catch(err => {
        console.error('[Service Worker] Installation failed:', err);
      })
  );
});

// ========================================
// 2. アクティベート時の処理（古いキャッシュを削除）
// ========================================
self.addEventListener('activate', (event) => {
  console.log('[Service Worker] Activate');

  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames.map((cacheName) => {
          // 古いバージョンのキャッシュを削除
          if (cacheName !== CACHE_NAME) {
            console.log('[Service Worker] Deleting old cache:', cacheName);
            return caches.delete(cacheName);
          }
        })
      );
    }).then(() => self.clients.claim()) // 即座に制御を取得
  );
});

// ========================================
// 3. フェッチ時の処理（キャッシュ戦略）
// ========================================
self.addEventListener('fetch', (event) => {
  const { request } = event;
  const url = new URL(request.url);

  // 同一オリジン以外（CDNなど）は通常のfetch
  if (url.origin !== location.origin) {
    return;
  }

  // POSTリクエスト（フォーム送信など）はキャッシュしない
  if (request.method !== 'GET') {
    return;
  }

  event.respondWith(
    caches.match(request)
      .then((cachedResponse) => {
        // キャッシュ戦略: Stale-While-Revalidate
        // 1. キャッシュがあれば即座に返す
        // 2. 同時にネットワークから最新版を取得してキャッシュ更新

        const fetchPromise = fetch(request)
          .then((networkResponse) => {
            // 成功したレスポンスのみキャッシュ
            if (networkResponse && networkResponse.status === 200) {
              const responseToCache = networkResponse.clone();
              caches.open(CACHE_NAME).then((cache) => {
                cache.put(request, responseToCache);
              });
            }
            return networkResponse;
          })
          .catch((error) => {
            console.log('[Service Worker] Fetch failed:', error);
            // ネットワークエラー時はキャッシュがあればそれを返す
            return cachedResponse;
          });

        // キャッシュがあれば即返し、なければネットワークを待つ
        return cachedResponse || fetchPromise;
      })
  );
});

// ========================================
// 4. プッシュ通知の受信（将来の実装用）
// ========================================
self.addEventListener('push', async (event) => {
  const data = event.data ? event.data.json() : {};
  const title = data.title || 'てくメモ';
  const options = {
    body: data.body || '新しい通知があります',
    icon: '/icon.png',
    badge: '/icon.png',
    data: {
      url: data.url || '/'
    }
  };

  event.waitUntil(
    self.registration.showNotification(title, options)
  );
});

// ========================================
// 5. 通知クリック時の処理（将来の実装用）
// ========================================
self.addEventListener('notificationclick', (event) => {
  event.notification.close();

  const urlToOpen = event.notification.data.url || '/';

  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true })
      .then((clientList) => {
        // 既に開いているウィンドウがあれば、そこにフォーカス
        for (let i = 0; i < clientList.length; i++) {
          const client = clientList[i];
          if (client.url === urlToOpen && 'focus' in client) {
            return client.focus();
          }
        }
        // なければ新しいウィンドウを開く
        if (clients.openWindow) {
          return clients.openWindow(urlToOpen);
        }
      })
  );
});
</file>

<file path="app/views/reactions/create.turbo_stream.erb">
<!-- リアクション追加/削除時に、該当投稿のリアクションボタン部分のみを更新 -->

<%= turbo_stream.replace "post_#{@post.id}_reactions" do %>
  <%= render "posts/reactions", post: @post %>
<% end %>
</file>

<file path="app/views/reactions/destroy.turbo_stream.erb">
<!-- リアクション削除時に、該当投稿のリアクションボタン部分のみを更新 -->

<%= turbo_stream.replace "post_#{@post.id}_reactions" do %>
  <%= render "posts/reactions", post: @post %>
<% end %>
</file>

<file path="app/views/shared/_google_auth_guide.html.erb">
<!-- Googleログイン警告対策ガイド（アコーディオン） -->
<details class="group mt-6">
  <summary class="list-none flex items-center justify-center cursor-pointer text-xs sm:text-sm font-bold text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-300 transition-all select-none px-4 py-3 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-200 dark:border-red-800 shadow-sm hover:shadow-md dark:shadow-[0_0_15px_rgba(239,68,68,0.2)]">
    <span class="material-symbols-outlined text-xl mr-2 flex-shrink-0 animate-pulse text-red-500 dark:text-red-400">warning</span>
    <span class="leading-relaxed text-left flex-1">「このアプリはGoogleで確認されていません」と表示される場合</span>
    <span class="material-symbols-outlined text-base ml-2 transform group-open:rotate-180 transition-transform flex-shrink-0 opacity-70">expand_more</span>
  </summary>

  <div class="mt-4 bg-gray-50 dark:bg-slate-800 rounded-2xl p-4 border border-gray-200 dark:border-gray-700 text-left animate-fade-in-down shadow-sm">
    <p class="text-xs text-gray-600 dark:text-gray-300 mb-4 leading-relaxed font-medium">
      現在、Googleの審査中のため、認証時に警告画面が表示されることがあります。<br>
      以下の手順で進めてください（安全性に問題はありません）。
    </p>

    <!-- Step 1 -->
    <div class="mb-6">
      <div class="text-[10px] font-bold text-gray-500 dark:text-gray-400 mb-1.5 flex items-center">
        <span class="bg-gray-200 dark:bg-gray-700 px-1.5 py-0.5 rounded mr-1.5 text-gray-700 dark:text-gray-300">STEP 1</span>
        左下の「詳細」をクリック
      </div>
      <div class="bg-[#202124] rounded-xl p-4 relative overflow-hidden border border-gray-700 shadow-inner">
        <div class="text-white text-sm font-bold mb-3 leading-tight">このアプリはGoogleで確認されていません</div>
        <div class="text-gray-400 text-[10px] mb-8 leading-relaxed">現在テスト中のアプリへのアクセスが許可されました。招待元のデベロッパーを信頼できる場合のみ、続行してください。</div>

        <div class="flex justify-between items-end">
          <!-- 詳細リンク -->
          <div class="relative z-10">
            <span class="text-[#8ab4f8] text-xs font-medium cursor-pointer border-b border-[#8ab4f8]">詳細</span>
            <!-- 赤枠 -->
            <div class="absolute -top-3 -left-4 -right-4 -bottom-3 border-2 border-red-500/90 rounded-full animate-pulse shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
            <!-- 指アイコン -->
            <span class="material-symbols-outlined absolute top-3 left-2 text-white drop-shadow-lg text-3xl transform rotate-[-15deg] animate-bounce">touch_app</span>
          </div>

          <!-- 安全なページに戻るボタン -->
          <div class="bg-[#8ab4f8] text-[#202124] text-[10px] font-bold px-3 py-2 rounded-md opacity-40">安全なページに戻る</div>
        </div>
      </div>
    </div>

    <!-- Step 2 -->
    <div>
      <div class="text-[10px] font-bold text-gray-500 dark:text-gray-400 mb-1.5 flex items-center">
        <span class="bg-gray-200 dark:bg-gray-700 px-1.5 py-0.5 rounded mr-1.5 text-gray-700 dark:text-gray-300">STEP 2</span>
        「安全ではないページに移動」をクリック
      </div>
      <div class="bg-[#202124] rounded-xl p-4 relative overflow-hidden border border-gray-700 shadow-inner">
        <div class="text-gray-400 text-[10px] mb-2">...続行してください。</div>
        <div class="text-[#8ab4f8] text-xs mb-4 opacity-80">詳細を非表示</div>

        <div class="mt-2 pl-1">
          <div class="relative z-10 inline-block">
            <span class="text-[#8ab4f8] text-xs font-medium cursor-pointer underline decoration-[#8ab4f8]/50 underline-offset-2 leading-relaxed">tekumemo.com（安全ではないページ）に移動</span>
            <!-- 赤枠 -->
            <div class="absolute -top-2 -left-2 -right-2 -bottom-2 border-2 border-red-500/90 rounded-lg animate-pulse shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
            <!-- 指アイコン -->
            <span class="material-symbols-outlined absolute top-4 right-0 text-white drop-shadow-lg text-3xl transform rotate-[-15deg] animate-bounce">touch_app</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</details>
</file>

<file path="app/views/shared/_google_fit_notice.html.erb">
<div class="relative overflow-hidden rounded-xl bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/10 dark:to-orange-900/10 border border-amber-200 dark:border-amber-700/30 p-4 shadow-sm my-4">
  <!-- 左側のアクセントライン -->
  <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-amber-400 to-orange-400"></div>

  <div class="flex items-start space-x-3">
    <!-- アイコン -->
    <div class="flex-shrink-0 mt-0.5">
      <div class="w-6 h-6 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
        <span class="material-symbols-outlined text-amber-600 dark:text-amber-400 text-base">engineering</span>
      </div>
    </div>

    <!-- テキスト -->
    <div class="flex-1">
      <h4 class="text-sm font-bold text-amber-900 dark:text-amber-100 mb-1 flex items-center">
        Google Fit連携は現在プレビュー版です
        <span class="ml-2 px-1.5 py-0.5 text-[10px] bg-amber-200 dark:bg-amber-800 text-amber-800 dark:text-amber-200 rounded-md font-mono">BETA</span>
      </h4>
      <p class="text-xs text-amber-800/80 dark:text-amber-200/70 leading-relaxed">
        連携ボタンを押した際に<span class="font-bold text-amber-900 dark:text-amber-100">「アクセスがブロックされました」</span>と表示される場合は、管理者の承認待ちです。<br>
        承認まで<span class="font-bold underline decoration-amber-400/50 decoration-2 underline-offset-2">半日ほど</span>お待ちいただき、再度お試しください。
      </p>
    </div>
  </div>
</div>
</file>

<file path="app/views/static_pages/privacy.html.erb">
<% content_for :title, "プライバシーポリシー＆利用規約 - てくメモ" %>

<div class="max-w-4xl mx-auto px-4 py-8 sm:px-6 lg:px-8 pb-32">
  <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-lg p-6 sm:p-10 border border-gray-100 dark:border-gray-800">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white mb-8 pb-4 border-b border-gray-200 dark:border-gray-700">
      プライバシーポリシー＆利用規約
    </h1>

    <div class="space-y-10 text-gray-700 dark:text-gray-300 leading-relaxed">

      <!-- プライバシーポリシー -->
      <section>
        <h2 class="text-xl font-bold text-gray-900 dark:text-cyan-400 mb-4 flex items-center">
          <span class="material-symbols-outlined mr-2">privacy_tip</span>
          プライバシーポリシー
        </h2>

        <div class="space-y-6">
          <div>
            <h3 class="font-bold text-gray-900 dark:text-gray-200 mb-2">1. 収集する情報</h3>
            <p>本アプリ「てくメモ」は、以下の情報を収集・利用します。</p>
            <ul class="list-disc list-inside mt-2 space-y-1 ml-2 text-sm sm:text-base">
              <li>Googleアカウント情報（メールアドレス、プロフィール画像、ユーザーID）</li>
              <li>Google Fitから取得される歩数、移動距離、消費カロリーなどの活動データ</li>
              <li>ユーザーが本アプリ内で入力した散歩記録（場所、メモなど）</li>
            </ul>
          </div>

          <div>
            <h3 class="font-bold text-gray-900 dark:text-gray-200 mb-2">2. 情報の利用目的</h3>
            <p>収集した情報は、以下の目的でのみ利用されます。</p>
            <ul class="list-disc list-inside mt-2 space-y-1 ml-2 text-sm sm:text-base">
              <li>ユーザー認証およびアカウント管理のため</li>
              <li>日々の活動記録（歩数、距離など）を可視化し、ユーザーに提供するため</li>
              <li>アプリの機能改善および不具合対応のため</li>
            </ul>
          </div>

          <div>
            <h3 class="font-bold text-gray-900 dark:text-gray-200 mb-2">3. Google Fitデータの取り扱い（Limited Use Policy）</h3>
            <p>本アプリは、Google Fit APIを使用してユーザーの活動データを取得します。取得したデータは、本アプリ内での表示および分析（歩数や消費カロリーの可視化）にのみ使用されます。</p>
            <ul class="list-disc list-inside mt-2 space-y-1 ml-2 text-sm sm:text-base">
              <li>取得したデータは、ユーザーの同意なく第三者に提供・販売されることはありません。</li>
              <li>取得したデータは、広告目的で使用されることはありません。</li>
              <li>Google APIから受け取った情報の使用および他のアプリへの転送は、<a href="https://developers.google.com/terms/api-services-user-data-policy" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">Google API Services User Data Policy</a>（Limited Use要件を含む）に準拠します。</li>
            </ul>
            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
              ※ Google Fitとの連携は、設定画面からいつでも解除することができます。
            </p>
          </div>
        </div>
      </section>

      <hr class="border-gray-200 dark:border-gray-800">

      <!-- 利用規約 -->
      <section>
        <h2 class="text-xl font-bold text-gray-900 dark:text-cyan-400 mb-4 flex items-center">
          <span class="material-symbols-outlined mr-2">gavel</span>
          利用規約
        </h2>

        <div class="space-y-6">
          <div>
            <h3 class="font-bold text-gray-900 dark:text-gray-200 mb-2">1. 免責事項</h3>
            <p>本アプリが提供する健康関連情報（消費カロリー計算など）は目安であり、医学的な助言を代替するものではありません。本アプリの利用により生じた損害について、開発者は一切の責任を負いません。</p>
          </div>

          <div>
            <h3 class="font-bold text-gray-900 dark:text-gray-200 mb-2">2. 禁止事項</h3>
            <p>ユーザーは、本アプリの利用にあたり、以下の行為を行ってはなりません。</p>
            <ul class="list-disc list-inside mt-2 space-y-1 ml-2 text-sm sm:text-base">
              <li>法令または公序良俗に違反する行為</li>
              <li>本アプリの運営を妨害する行為</li>
              <li>他のユーザーまたは第三者に不利益を与える行為</li>
            </ul>
          </div>

          <div>
            <h3 class="font-bold text-gray-900 dark:text-gray-200 mb-2">3. 規約の変更</h3>
            <p>開発者は、必要と判断した場合、ユーザーに通知することなく本規約を変更することができるものとします。</p>
          </div>
        </div>
      </section>

      <hr class="border-gray-200 dark:border-gray-800 my-12">

      <!-- English Version -->
      <section lang="en">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white mb-8 pb-4 border-b border-gray-200 dark:border-gray-700">
          Privacy Policy & Terms of Service
        </h1>

        <!-- Privacy Policy (English) -->
        <div class="mb-12">
          <h2 class="text-xl font-bold text-gray-900 dark:text-cyan-400 mb-4 flex items-center">
            <span class="material-symbols-outlined mr-2">privacy_tip</span>
            Privacy Policy
          </h2>

          <div class="space-y-6">
            <div>
              <h3 class="font-bold text-gray-900 dark:text-gray-200 mb-2">1. Information We Collect</h3>
              <p>This app "TekuMemo" collects and uses the following information:</p>
              <ul class="list-disc list-inside mt-2 space-y-1 ml-2 text-sm sm:text-base">
                <li>Google account information (email address, profile image, user ID)</li>
                <li>Activity data retrieved from Google Fit (steps, distance, calories burned, etc.)</li>
                <li>Walking records entered by the user within this app (location, notes, etc.)</li>
              </ul>
            </div>

            <div>
              <h3 class="font-bold text-gray-900 dark:text-gray-200 mb-2">2. How We Use Information</h3>
              <p>The collected information is used only for the following purposes:</p>
              <ul class="list-disc list-inside mt-2 space-y-1 ml-2 text-sm sm:text-base">
                <li>To authenticate users and manage accounts</li>
                <li>To visualize daily activity records (steps, distance, etc.) and provide them to the user</li>
                <li>To improve app functionality and address issues</li>
              </ul>
            </div>

            <div>
              <h3 class="font-bold text-gray-900 dark:text-gray-200 mb-2">3. Handling of Google Fit Data (Limited Use Policy)</h3>
              <p>This app uses the Google Fit API to retrieve user activity data. The retrieved data is used solely for display and analysis (visualization of steps and calories) within this app.</p>
              <ul class="list-disc list-inside mt-2 space-y-1 ml-2 text-sm sm:text-base">
                <li>The retrieved data will not be provided or sold to third parties without user consent.</li>
                <li>The retrieved data will not be used for advertising purposes.</li>
                <li>The use of information received from Google APIs and transfer to any other app will adhere to the <a href="https://developers.google.com/terms/api-services-user-data-policy" target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">Google API Services User Data Policy</a>, including the Limited Use requirements.</li>
              </ul>
              <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                * Link to Google Fit can be disconnected at any time from the settings screen.
              </p>
            </div>
          </div>
        </div>

        <!-- Terms of Service (English) -->
        <div>
          <h2 class="text-xl font-bold text-gray-900 dark:text-cyan-400 mb-4 flex items-center">
            <span class="material-symbols-outlined mr-2">gavel</span>
            Terms of Service
          </h2>

          <div class="space-y-6">
            <div>
              <h3 class="font-bold text-gray-900 dark:text-gray-200 mb-2">1. Disclaimer</h3>
              <p>Health-related information provided by this app (such as calorie calculations) is for reference only and does not substitute for medical advice. The developer assumes no responsibility for any damages caused by the use of this app.</p>
            </div>

            <div>
              <h3 class="font-bold text-gray-900 dark:text-gray-200 mb-2">2. Prohibited Acts</h3>
              <p>Users must not engage in the following acts when using this app:</p>
              <ul class="list-disc list-inside mt-2 space-y-1 ml-2 text-sm sm:text-base">
                <li>Acts that violate laws or public order and morals</li>
                <li>Acts that interfere with the operation of this app</li>
                <li>Acts that cause disadvantage to other users or third parties</li>
              </ul>
            </div>

            <div>
              <h3 class="font-bold text-gray-900 dark:text-gray-200 mb-2">3. Changes to Terms</h3>
              <p>The developer may change these terms without notice to the user if deemed necessary.</p>
            </div>
          </div>
        </div>
      </section>

      <div class="pt-8 text-center">
        <%= link_to root_path, class: "inline-flex items-center px-6 py-3 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full transition-colors duration-200 font-medium" do %>
          <span class="material-symbols-outlined mr-2">arrow_back</span>
          ホームに戻る
        <% end %>
      </div>

    </div>
  </div>
</div>
</file>

<file path="app/views/stats_coming_soon/index.html.erb">
<%# app/views/stats_coming_soon/index.html.erb %>
<div class="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">

  <!-- 背景装飾（ダークモード用ネオン） -->
  <div class="hidden dark:block absolute inset-0 overflow-hidden pointer-events-none -z-10">
    <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-purple-500/20 rounded-full mix-blend-screen filter blur-3xl animate-pulse"></div>
    <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-blue-500/20 rounded-full mix-blend-screen filter blur-3xl animate-pulse" style="animation-delay: 1s;"></div>
  </div>

  <!-- メインカード -->
  <div class="relative w-full max-w-md bg-[#fdfbf7] dark:bg-slate-900/80 dark:backdrop-blur-xl rounded-[2.5rem] p-8 sm:p-12 text-center shadow-[20px_20px_60px_#d1d9e6,-20px_-20px_60px_#ffffff] dark:shadow-[0_0_40px_rgba(139,92,246,0.3)] border border-white/50 dark:border-purple-500/30 transition-all duration-500 hover:scale-[1.02]">

    <!-- アイコンエリア -->
    <div class="mb-8 relative inline-block">
      <!-- Light Mode Icon -->
      <div class="dark:hidden text-8xl animate-bounce">
        🚧
      </div>
      <!-- Dark Mode Icon -->
      <div class="hidden dark:block text-8xl relative">
        <span class="absolute inset-0 blur-lg opacity-50">📊</span>
        <span class="relative z-10">📊</span>
      </div>

      <!-- 装飾パーツ -->
      <div class="absolute -top-4 -right-4 text-4xl animate-spin-slow">⚙️</div>
      <div class="absolute -bottom-2 -left-4 text-3xl animate-pulse">✨</div>
    </div>

    <!-- タイトル -->
    <h1 class="text-3xl sm:text-4xl font-black text-slate-700 dark:text-transparent dark:bg-clip-text dark:bg-gradient-to-r dark:from-purple-400 dark:to-blue-400 mb-4 tracking-tight">
      COMING SOON
    </h1>

    <!-- サブタイトル -->
    <h2 class="text-lg font-bold text-slate-500 dark:text-purple-200 mb-6">
      データ分析機能は準備中です
    </h2>

    <!-- 説明文 -->
    <p class="text-slate-400 dark:text-slate-400 text-sm mb-10 leading-relaxed">
      あなたの毎日の歩みを、美しいグラフや統計データで振り返れる機能を開発しています。<br>
      公開までもうしばらくお待ちください！
    </p>

    <!-- アクションボタン -->
    <%= link_to root_path, class: "group relative inline-flex items-center justify-center px-8 py-4 font-bold text-white transition-all duration-200 bg-gradient-to-r from-blue-400 to-blue-600 dark:from-purple-600 dark:to-blue-600 rounded-full shadow-lg hover:shadow-xl hover:-translate-y-1 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-purple-500" do %>
      <span class="absolute inset-0 w-full h-full -mt-1 rounded-full opacity-30 bg-gradient-to-b from-transparent via-transparent to-black"></span>
      <span class="relative flex items-center gap-2">
        <span class="material-symbols-outlined">home</span>
        ホームに戻る
      </span>
    <% end %>

  </div>

  <!-- フッター的な装飾 -->
  <div class="mt-12 text-slate-300 dark:text-slate-600 text-xs font-mono">
    SYSTEM STATUS: <span class="text-green-500 animate-pulse">●</span> BUILDING...
  </div>
</div>
</file>

<file path="app/views/users/omniauth_callbacks/confirm_email_change.html.erb">
<% content_for :title, "メールアドレスの確認 - てくメモ" %>

<div class="flex-1 p-4 pb-24 sm:pb-10 w-full max-w-2xl mx-auto">
  <div class="mb-8 text-center">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-slate-50 flex items-center justify-center space-x-2">
      <span class="material-symbols-outlined text-3xl text-yellow-500">warning</span>
      <span>メールアドレスの確認</span>
    </h1>
  </div>

  <div class="bg-white/80 dark:bg-slate-950/50 backdrop-blur-xl rounded-3xl shadow-xl p-6 sm:p-8 border border-white/20 dark:border-white/10">
    <div class="text-center mb-8">
      <p class="text-gray-600 dark:text-slate-300 mb-4">
        Googleアカウントのメールアドレスが、現在のアカウントと異なります。<br>
        連携を行うには、メールアドレスをGoogleアカウントのものに変更する必要があります。
      </p>

      <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 rounded-xl p-4 mb-6 text-left">
        <p class="text-xs font-bold text-yellow-800 dark:text-yellow-400 mb-1 flex items-center">
          <span class="material-symbols-outlined text-sm mr-1">info</span>
          MVP期間中の特別仕様について
        </p>
        <p class="text-xs text-yellow-700 dark:text-yellow-300/80 leading-relaxed">
          現在、Google Fit連携機能はテスト運用の段階（MVPプレビュー版）です。<br>
          Google Cloudの仕様上、テストユーザーとして登録されたメールアドレスと一致させる必要があるため、
          <span class="font-bold underline">一時的にメールアドレスの変更をお願いしております。</span><br>
          正式リリース時には、異なるメールアドレスでも連携できるよう改善予定です。
        </p>
      </div>

      <div class="flex flex-col sm:flex-row items-center justify-center gap-4 sm:gap-8 mb-8">
        <!-- 現在のアドレス -->
        <div class="w-full sm:w-auto bg-gray-50 dark:bg-slate-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">現在のアドレス</p>
          <p class="font-mono text-sm font-bold text-gray-700 dark:text-slate-300 break-all">
            <%= current_user.email %>
          </p>
        </div>

        <span class="material-symbols-outlined text-gray-400 dark:text-gray-600 rotate-90 sm:rotate-0">arrow_forward</span>

        <!-- 新しいアドレス -->
        <div class="w-full sm:w-auto bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-200 dark:border-blue-800">
          <p class="text-xs text-blue-500 dark:text-blue-400 mb-1">変更後のアドレス</p>
          <p class="font-mono text-sm font-bold text-blue-700 dark:text-blue-300 break-all">
            <%= session.dig(:google_auth_data, "email") %>
          </p>
        </div>
      </div>
    </div>

    <div class="flex flex-col-reverse sm:flex-row justify-center gap-4">
      <%= link_to edit_user_registration_path, class: "px-6 py-3 rounded-xl border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-300 font-bold text-sm hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors text-center" do %>
        キャンセル
      <% end %>

      <%= button_to update_email_and_connect_users_path, method: :post, class: "w-full sm:w-auto bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-blue-500/30 transition-all transform hover:-translate-y-0.5 flex items-center justify-center" do %>
        <span class="material-symbols-outlined mr-2">sync_alt</span>
        更新して連携する
      <% end %>
    </div>
  </div>
</div>
</file>

<file path="app/views/users/update.turbo_stream.erb">
<%= turbo_stream.replace "user_avatar_section" do %>
  <%= render partial: "avatar_section", locals: { user: @user } %>
<% end %>

<%# フラッシュメッセージも更新（保存完了のフィードバック） %>
<%= turbo_stream.update "flash_messages" do %>
  <%= render "layouts/flash" %>
<% end %>
</file>

<file path="app/views/walks/edit.html.erb">
<% content_for :title, "散歩記録を編集 - てくメモ" %>

<div class="flex-1 w-full max-w-3xl mx-auto pb-24 px-4 sm:px-6">
  <!-- ページタイトル -->
  <div class="mb-8 mt-4 text-center sm:text-left">
    <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-600 dark:from-cyan-300 dark:to-purple-400 drop-shadow-sm dark:drop-shadow-[0_0_10px_rgba(34,211,238,0.5)] inline-flex items-center gap-2">
      <span class="material-symbols-outlined text-4xl text-cyan-500 dark:text-cyan-400">edit_note</span>
      散歩記録を編集
    </h1>
    <p class="text-sm text-gray-500 dark:text-slate-400 mt-2 font-medium">
      <%= @walk.walked_on.strftime('%Y年%m月%d日') %>の記録を修正します
    </p>
  </div>

  <!-- フォーム -->
  <div class="relative z-10">
    <%= render "form", walk: @walk %>
  </div>
</div>
</file>

<file path="app/views/walks/new.html.erb">
<% content_for :title, "新しい散歩記録 - てくメモ" %>

<div class="flex-1 w-full max-w-3xl mx-auto pb-24 px-4 sm:px-6">
  <!-- ページタイトル -->
  <div class="mb-8 mt-4 text-center sm:text-left">
    <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-600 dark:from-cyan-300 dark:to-purple-400 drop-shadow-sm dark:drop-shadow-[0_0_10px_rgba(34,211,238,0.5)] inline-flex items-center gap-2">
      <span class="material-symbols-outlined text-4xl text-cyan-500 dark:text-cyan-400">add_circle</span>
      新しい散歩記録
    </h1>
    <p class="text-sm text-gray-500 dark:text-slate-400 mt-2 font-medium">
      今日の冒険を記録に残しましょう
    </p>
  </div>

  <!-- フォーム -->
  <div class="relative z-10">
    <%= render "form", walk: @walk %>
  </div>
</div>
</file>

<file path="config/environments/development.rb">
require "active_support/core_ext/integer/time"

Rails.application.configure do
  # 開発環境での設定
  config.enable_reloading = true
  config.eager_load = false
  config.consider_all_requests_local = true
  config.server_timing = true

  # ngrokやlocaltunnelなど、外部からのアクセスを許可
  config.hosts.clear

  # アセット設定を最適化
  config.assets.debug = false
  config.assets.digest = true
  config.assets.compile = true
  # Tailwind CSSビルドファイルを明示的に指定
  config.assets.precompile += %w[application.css]

  # キャッシュ設定
  if Rails.root.join("tmp/caching-dev.txt").exist?
    config.action_controller.perform_caching = true
    config.action_controller.enable_fragment_cache_logging = true
    # キャッシュストアをSolid Cacheに変更
    config.cache_store = :solid_cache_store
    config.public_file_server.headers = { "Cache-Control" => "public, max-age=#{2.days.to_i}" }
  else
    config.action_controller.perform_caching = false
    config.cache_store = :null_store
  end

  # ストレージ設定
  config.active_storage.service = :local

  # メール設定
  config.action_mailer.raise_delivery_errors = false
  config.action_mailer.perform_caching = false
  config.action_mailer.default_url_options = { host: "localhost", port: 3000 }

  # ログ設定
  config.active_support.deprecation = :log
  config.active_support.disallowed_deprecation = :raise
  config.active_support.disallowed_deprecation_warnings = []

  # データベース設定
  config.active_record.migration_error = :page_load
  config.active_record.verbose_query_logs = true

  # ジョブログ設定
  config.active_job.verbose_enqueue_logs = true

  # アセットを静的に配信
  config.assets.quiet = true

  # ビューファイル名を注釈
  config.action_view.annotate_rendered_view_with_filenames = true

  # コールバックエラー設定
  # Rails 7.1のデフォルトではtrueだが、OmniAuthのpassthruアクションとの互換性のためfalseに設定
  config.action_controller.raise_on_missing_callback_actions = false
end
</file>

<file path="config/environments/test.rb">
require "active_support/core_ext/integer/time"

# The test environment is used exclusively to run your application's
# test suite. You never need to work with it otherwise. Remember that
# your test database is "scratch space" for the test suite and is wiped
# and recreated between test runs. Don't rely on the data there!

Rails.application.configure do
  # Settings specified here will take precedence over those in config/application.rb.

  # While tests run files are not watched, reloading is not necessary.
  config.enable_reloading = false

  # Enable asset compilation for tests (fixes CI asset errors)
  config.assets.compile = true

  # Sprocketsのキャッシュをメモリ上に保存（ファイル権限エラー回避）
  config.assets.configure do |env|
    env.cache = ActiveSupport::Cache.lookup_store(:memory_store)
  end

  # Eager loading loads your entire application. When running a single test locally,
  # this is usually not necessary, and can slow down your test suite. However, it's
  # recommended that you enable it in continuous integration systems to ensure eager
  # loading is working properly before deploying your code.
  config.eager_load = ENV["CI"].present?

  # Configure public file server for tests with Cache-Control for performance.
  config.public_file_server.headers = { "Cache-Control" => "public, max-age=#{1.hour.to_i}" }

  # Show full error reports and disable caching.
  config.consider_all_requests_local = true
  config.action_controller.perform_caching = false
  config.cache_store = :null_store

  # Render exception templates for rescuable exceptions and raise for other exceptions.
  config.action_dispatch.show_exceptions = :rescuable

  # Disable request forgery protection in test environment.
  config.action_controller.allow_forgery_protection = false

  # Store uploaded files on the local file system in a temporary directory.
  config.active_storage.service = :test

  # Disable caching for Action Mailer templates even if Action Controller
  # caching is enabled.
  config.action_mailer.perform_caching = false

  # Tell Action Mailer not to deliver emails to the real world.
  # The :test delivery method accumulates sent emails in the
  # ActionMailer::Base.deliveries array.
  config.action_mailer.delivery_method = :test

  # メール送信を即座に実行（非同期ジョブを待たない）
  config.action_mailer.perform_deliveries = false

  # Unlike controllers, the mailer instance doesn't have any context about the
  # incoming request so you'll need to provide the :host parameter yourself.
  config.action_mailer.default_url_options = { host: "www.example.com" }

  # ActiveJobをインライン実行（非同期待機なし）
  config.active_job.queue_adapter = :inline

  # Print deprecation notices to the stderr.
  config.active_support.deprecation = :stderr

  # Raise exceptions for disallowed deprecations.
  config.active_support.disallowed_deprecation = :raise

  # Tell Active Support which deprecation messages to disallow.
  config.active_support.disallowed_deprecation_warnings = []

  # Raises error for missing translations.
  # config.i18n.raise_on_missing_translations = true

  # Annotate rendered view with file names.
  # config.action_view.annotate_rendered_view_with_filenames = true

  # Raise error when a before_action's only/except options reference missing actions.
  config.action_controller.raise_on_missing_callback_actions = true
  # テスト実行時に「全ホスト許可」に設定する
  # テスト実行時にホスト制限を無効化（全許可）
  config.hosts = nil
end
</file>

<file path="config/initializers/assets.rb">
# Be sure to restart your server when you modify this file.

# Version of your assets, change this if you want to expire all your assets.
Rails.application.config.assets.version = "1.0"

# Add additional assets to the asset load path.
# Rails.application.config.assets.paths << Emoji.images_path

# Precompile additional assets.
# application.js, application.css, and all non-JS/CSS in the app/assets
# folder are already added.
# Rails.application.config.assets.precompile += %w[ admin.js admin.css ]
</file>

<file path="config/initializers/content_security_policy.rb">
# Be sure to restart your server when you modify this file.

# Define an application-wide content security policy.
# See the Securing Rails Applications Guide for more information:
# https://guides.rubyonrails.org/security.html#content-security-policy-header

# Rails.application.configure do
#   config.content_security_policy do |policy|
#     policy.default_src :self, :https
#     policy.font_src    :self, :https, :data
#     policy.img_src     :self, :https, :data
#     policy.object_src  :none
#     policy.script_src  :self, :https
#     policy.style_src   :self, :https
#     # Specify URI for violation reports
#     # policy.report_uri "/csp-violation-report-endpoint"
#   end
#
#   # Generate session nonces for permitted importmap, inline scripts, and inline styles.
#   config.content_security_policy_nonce_generator = ->(request) { request.session.id.to_s }
#   config.content_security_policy_nonce_directives = %w(script-src style-src)
#
#   # Report violations without enforcing the policy.
#   # config.content_security_policy_report_only = true
# end
</file>

<file path="config/initializers/devise.rb">
# frozen_string_literal: true

# Devise設定ファイル
Devise.setup do |config|
  # 秘密鍵の設定（本番環境では環境変数から読み込み推奨）
  # config.secret_key = ENV['DEVISE_SECRET_KEY']

  # ===== メーラー設定 =====
  config.mailer_sender = "noreply@tekumemo.com"
  # config.mailer = 'Devise::Mailer'
  # config.parent_mailer = 'ActionMailer::Base'

  # ===== ORM設定 =====
  require "devise/orm/active_record"

  # ===== 認証設定 =====
  # 認証キー（デフォルトは:email）
  # config.authentication_keys = [:email]

  # 大文字小文字を区別しないキー
  config.case_insensitive_keys = [ :email ]

  # 空白を削除するキー
  config.strip_whitespace_keys = [ :email ]

  # パラメータ認証の有効化
  # config.params_authenticatable = true

  # HTTP認証の設定
  # config.http_authenticatable = false
  # config.http_authenticatable_on_xhr = true
  # config.http_authentication_realm = 'Application'

  # パラノイアモード（セキュリティ向上）
  # config.paranoid = true

  # セッションストレージのスキップ設定
  config.skip_session_storage = [ :http_auth ]

  # CSRF トークンのクリーンアップ
  # config.clean_up_csrf_token_on_authentication = true

  # ルートの再読み込み設定
  # config.reload_routes = true

  # ===== database_authenticatable設定 =====
  # bcryptのコスト（テスト環境では1、本番では12推奨）
  config.stretches = Rails.env.test? ? 1 : 12

  # pepper設定（追加のセキュリティ）
  # config.pepper = ENV['DEVISE_PEPPER']

  # メール変更通知
  # config.send_email_changed_notification = false

  # パスワード変更通知
  # config.send_password_change_notification = false

  # ===== confirmable設定 =====
  # 未確認でのアクセス期間
  # config.allow_unconfirmed_access_for = 2.days

  # 確認期限
  # config.confirm_within = 3.days

  # メール変更時の再確認
  config.reconfirmable = true

  # 確認キー
  # config.confirmation_keys = [:email]

  # ===== rememberable設定 =====
  # ログイン記憶期間
  # config.remember_for = 2.weeks

  # サインアウト時に記憶トークンを無効化
  config.expire_all_remember_me_on_sign_out = true

  # 記憶期間の延長
  # config.extend_remember_period = false

  # Cookieオプション
  # config.rememberable_options = {}

  # ===== validatable設定 =====
  # パスワード長の範囲
  config.password_length = 6..128

  # メールアドレスの正規表現
  config.email_regexp = /\A[^@\s]+@[^@\s]+\z/

  # ===== timeoutable設定 =====
  # タイムアウト時間
  # config.timeout_in = 30.minutes

  # ===== lockable設定 =====
  # ロック戦略
  # config.lock_strategy = :failed_attempts

  # アンロックキー
  # config.unlock_keys = [:email]

  # アンロック戦略
  # config.unlock_strategy = :both

  # ロックまでの試行回数
  # config.maximum_attempts = 20

  # アンロックまでの時間
  # config.unlock_in = 1.hour

  # 最後の試行の警告
  # config.last_attempt_warning = true

  # ===== recoverable設定 =====
  # パスワードリセットキー
  # config.reset_password_keys = [:email]

  # パスワードリセット期限
  config.reset_password_within = 6.hours

  # パスワードリセット後の自動サインイン
  # config.sign_in_after_reset_password = true

  # ===== encryptable設定 =====
  # bcrypt以外のハッシュアルゴリズムを使用する場合
  # require 'devise-encryptable' gem
  # config.encryptor = :sha512

  # ===== スコープ設定 =====
  # スコープ付きビューの有効化
  # config.scoped_views = false

  # デフォルトスコープ
  # config.default_scope = :user

  # 全スコープからのサインアウト
  # config.sign_out_all_scopes = true

  # ===== ナビゲーション設定 =====
  # ナビゲーショナルフォーマット
  # config.navigational_formats = ['*/*', :html, :turbo_stream]

  # サインアウトのHTTPメソッド（Turbo対応のためDELETEを推奨）
  config.sign_out_via = :delete

  # ===== OmniAuth設定 =====
  # OAuthプロバイダーの追加
  # config.omniauth :github, ENV['GITHUB_APP_ID'], ENV['GITHUB_APP_SECRET'], scope: 'user,public_repo'

  # Google OAuth2設定（Google Fit API連携用）
  # Google Cloud Consoleで取得したクライアントIDとシークレットを使用
  # スコープ: ユーザー情報とGoogle Fit（アクティビティ、位置情報、身体データ）へのアクセス

  # ↓はAIが出してきたコードで、Credentialsが読み込めない場合でもエラーにならないように空ハッシュをデフォルトにするためらしい
  google_creds = begin
    Rails.application.credentials.google || {}
  rescue ActiveSupport::MessageEncryptor::InvalidMessage, ActiveSupport::MessageVerifier::InvalidSignature
    # デプロイ時など、マスターキーが不一致の場合にビルドが落ちないようにする
    # ただし、この状態ではGoogle認証は機能しないため、環境変数の修正が必要
    warn "WARNING: Failed to decrypt credentials. Google Auth will not work."
    {}
  end

  config.omniauth :google_oauth2,
                  google_creds[:client_id],
                  google_creds[:client_secret],
                  {
                    scope: [
                      # 基本認証情報
                      "userinfo.email",
                      "userinfo.profile",
                      # フィットネス関連
                      "https://www.googleapis.com/auth/fitness.activity.read",    # 活動データ
                      "https://www.googleapis.com/auth/fitness.location.read",    # 位置情報
                      "https://www.googleapis.com/auth/fitness.body.read"         # 身体データ
                    ].join(","), # 配列 + .join(','),で文字列に変換できる
                    # 左だと可読性がバツ "userinfo.email,userinfo.profile,https://www.googleapis.com/auth/fitness.activity.read"

                    access_type: "offline",
                    prompt: "consent"
                  }

  # ===== Warden設定 =====
  # Wardenの追加設定
  # config.warden do |manager|
  #   manager.intercept_401 = false
  #   manager.default_strategies(scope: :user).unshift :some_external_strategy
  # end

  # ===== Hotwire/Turbo設定 =====
  # エラーレスポンスとリダイレクトのステータスコード
  # Turbo対応のために必要な設定
  config.responder.error_status = :unprocessable_entity
  config.responder.redirect_status = :see_other

  # ===== registerable設定 =====
  # パスワード変更後の自動サインイン
  # config.sign_in_after_change_password = true
end
</file>

<file path="config/initializers/filter_parameter_logging.rb">
# Be sure to restart your server when you modify this file.

# Configure parameters to be partially matched (e.g. passw matches password) and filtered from the log file.
# Use this to limit dissemination of sensitive information.
# See the ActiveSupport::ParameterFilter documentation for supported notations and behaviors.
Rails.application.config.filter_parameters += [
  :passw, :email, :secret, :token, :_key, :crypt, :salt, :certificate, :otp, :ssn
]
</file>

<file path="config/initializers/geocoder.rb">
# Geocoder の設定
Geocoder.configure(
  # タイムアウト設定（秒）
  timeout: 5,

  # IP位置情報のルックアップサービスを設定
  # 優先順位順に複数のサービスを設定可能
  ip_lookup: :ipapi_com,

  # キャッシュ設定（Railsのキャッシュストアを使用）
  cache: Rails.cache,
  cache_prefix: "geocoder:",

  # 言語設定
  language: :ja,

  # 単位（距離計算用）
  units: :km,

  # ログレベル
  logger: Rails.logger,

  # 各サービスごとの設定
  ipapi_com: {
    # ip-api.com は無料で利用可能
    # レート制限: 45リクエスト/分
  },

  # フォールバック用に別のサービスも設定可能
  # 例: ipinfo_io, ipstack, maxmind など
  # ipinfo_io: {
  #   api_key: ENV["IPINFO_IO_API_KEY"]
  # }
)
</file>

<file path="config/initializers/inflections.rb">
# Be sure to restart your server when you modify this file.

# Add new inflection rules using the following format. Inflections
# are locale specific, and you may define rules for as many different
# locales as you wish. All of these examples are active by default:
# ActiveSupport::Inflector.inflections(:en) do |inflect|
#   inflect.plural /^(ox)$/i, "\\1en"
#   inflect.singular /^(ox)en/i, "\\1"
#   inflect.irregular "person", "people"
#   inflect.uncountable %w( fish sheep )
# end

# These inflection rules are supported but not enabled by default:
# ActiveSupport::Inflector.inflections(:en) do |inflect|
#   inflect.acronym "RESTful"
# end
</file>

<file path="config/initializers/omniauth.rb">
# OmniAuthの初期化設定
# Rails 7のデフォルトCSRF保護を使用（omniauth-rails_csrf_protection gemは不要）

# Rails 7のTurboとOmniAuthを連携させるための設定
# POSTとGETの両方を許可（Google OAuth2のコールバックフローに必要）
OmniAuth.config.allowed_request_methods = [ :post, :get ]

# テスト・開発環境でのSSL警告を無効化（本番環境では有効のまま）
OmniAuth.config.silence_get_warning = true unless Rails.env.production?

# 認証失敗時の詳細ログを出力（本番環境でのデバッグ用）
OmniAuth.config.on_failure = proc { |env|
  error_type = env["omniauth.error.type"]
  error = env["omniauth.error"]
  strategy = env["omniauth.strategy"]&.name

  Rails.logger.error "=== OmniAuth Authentication Failure ==="
  Rails.logger.error "Error Type: #{error_type}"
  Rails.logger.error "Error Message: #{error&.message}"
  Rails.logger.error "Strategy: #{strategy}"
  Rails.logger.error "Request Path: #{env['REQUEST_PATH']}"
  Rails.logger.error "Request Method: #{env['REQUEST_METHOD']}"
  Rails.logger.error "=========================================="

  # デフォルトのエラーハンドラーに処理を委譲
  # Users::OmniauthCallbacksController#failure にリダイレクト
  env["omniauth.error.type"] = error_type
  OmniAuth::FailureEndpoint.new(env).call
}
</file>

<file path="config/initializers/permissions_policy.rb">
# Be sure to restart your server when you modify this file.

# Define an application-wide HTTP permissions policy. For further
# information see: https://developers.google.com/web/updates/2018/06/feature-policy

# Rails.application.config.permissions_policy do |policy|
#   policy.camera      :none
#   policy.gyroscope   :none
#   policy.microphone  :none
#   policy.usb         :none
#   policy.fullscreen  :self
#   policy.payment     :self, "https://secure.example.com"
# end
</file>

<file path="config/initializers/session_store.rb">
# Be sure to restart your server when you modify this file.

Rails.application.config.session_store :cookie_store,
  key: "_tekumemo_session_v4",
  secure: Rails.env.production?,
  same_site: Rails.env.production? ? :none : :lax,  # 本番環境ではクロスサイトCookieを許可
  httponly: true  # XSS対策：JavaScriptからのアクセスを防ぐ
</file>

<file path="config/locales/devise.en.yml">
# Additional translations at https://github.com/heartcombo/devise/wiki/I18n

en:
  devise:
    confirmations:
      confirmed: "Your email address has been successfully confirmed."
      send_instructions: "You will receive an email with instructions for how to confirm your email address in a few minutes."
      send_paranoid_instructions: "If your email address exists in our database, you will receive an email with instructions for how to confirm your email address in a few minutes."
    failure:
      already_authenticated: "You are already signed in."
      inactive: "Your account is not activated yet."
      invalid: "Invalid %{authentication_keys} or password."
      locked: "Your account is locked."
      last_attempt: "You have one more attempt before your account is locked."
      not_found_in_database: "Invalid %{authentication_keys} or password."
      timeout: "Your session expired. Please sign in again to continue."
      unauthenticated: "You need to sign in or sign up before continuing."
      unconfirmed: "You have to confirm your email address before continuing."
    mailer:
      confirmation_instructions:
        subject: "Confirmation instructions"
      reset_password_instructions:
        subject: "Reset password instructions"
      unlock_instructions:
        subject: "Unlock instructions"
      email_changed:
        subject: "Email Changed"
      password_change:
        subject: "Password Changed"
    omniauth_callbacks:
      failure: "Could not authenticate you from %{kind} because \"%{reason}\"."
      success: "Successfully authenticated from %{kind} account."
    passwords:
      no_token: "You can't access this page without coming from a password reset email. If you do come from a password reset email, please make sure you used the full URL provided."
      send_instructions: "You will receive an email with instructions on how to reset your password in a few minutes."
      send_paranoid_instructions: "If your email address exists in our database, you will receive a password recovery link at your email address in a few minutes."
      updated: "Your password has been changed successfully. You are now signed in."
      updated_not_active: "Your password has been changed successfully."
    registrations:
      destroyed: "Bye! Your account has been successfully cancelled. We hope to see you again soon."
      signed_up: "Welcome! You have signed up successfully."
      signed_up_but_inactive: "You have signed up successfully. However, we could not sign you in because your account is not yet activated."
      signed_up_but_locked: "You have signed up successfully. However, we could not sign you in because your account is locked."
      signed_up_but_unconfirmed: "A message with a confirmation link has been sent to your email address. Please follow the link to activate your account."
      update_needs_confirmation: "You updated your account successfully, but we need to verify your new email address. Please check your email and follow the confirmation link to confirm your new email address."
      updated: "Your account has been updated successfully."
      updated_but_not_signed_in: "Your account has been updated successfully, but since your password was changed, you need to sign in again."
    sessions:
      signed_in: "Signed in successfully."
      signed_out: "Signed out successfully."
      already_signed_out: "Signed out successfully."
    unlocks:
      send_instructions: "You will receive an email with instructions for how to unlock your account in a few minutes."
      send_paranoid_instructions: "If your account exists, you will receive an email with instructions for how to unlock it in a few minutes."
      unlocked: "Your account has been unlocked successfully. Please sign in to continue."
  errors:
    messages:
      already_confirmed: "was already confirmed, please try signing in"
      confirmation_period_expired: "needs to be confirmed within %{period}, please request a new one"
      expired: "has expired, please request a new one"
      not_found: "not found"
      not_locked: "was not locked"
      not_saved:
        one: "1 error prohibited this %{resource} from being saved:"
        other: "%{count} errors prohibited this %{resource} from being saved:"
</file>

<file path="config/locales/devise.ja.yml">
ja:
  devise:
    confirmations:
      confirmed: "メールアドレスが確認されました。"
      send_instructions: "アカウントの確認方法を数分以内にメールで送信します。"
      send_paranoid_instructions: "メールアドレスが登録されている場合、アカウントの確認方法を数分以内にメールで送信します。"
    failure:
      already_authenticated: "すでにログインしています。"
      inactive: "アカウントが有効化されていません。"
      invalid: "メールアドレスまたはパスワードが違います。"
      locked: "アカウントが凍結されています。"
      last_attempt: "あなたのアカウントが凍結される前に、あと一回だけ試行できます。"
      not_found_in_database: "メールアドレスまたはパスワードが違います。"
      timeout: "セッションがタイムアウトしました。もう一度ログインしてください。"
      unauthenticated: "アカウント登録もしくはログインしてください。"
      unconfirmed: "メールアドレスの確認が必要です。"
    mailer:
      confirmation_instructions:
        subject: "アカウントの確認方法"
      reset_password_instructions:
        subject: "パスワードの再設定"
      unlock_instructions:
        subject: "アカウントの凍結解除"
      email_changed:
        subject: "メールアドレスの変更"
      password_change:
        subject: "パスワードの変更"
    omniauth_callbacks:
      failure: "%{kind} アカウントによる認証に失敗しました。理由：%{reason}"
      success: "%{kind} アカウントによる認証に成功しました。"
    passwords:
      no_token: "このページにはアクセスできません。パスワード再設定メールのリンクからアクセスしているか確認してください。"
      send_instructions: "パスワードの再設定方法を数分以内にメールで送信します。"
      send_paranoid_instructions: "メールアドレスが登録されている場合、パスワードの再設定方法を数分以内にメールで送信します。"
      updated: "パスワードが正しく変更されました。ログインしました。"
      updated_not_active: "パスワードが正しく変更されました。"
    registrations:
      destroyed: "アカウントを削除しました。またのご利用をお待ちしております。"
      signed_up: "アカウント登録が完了しました。"
      signed_up_but_inactive: "アカウント登録が完了しました。しかし、アカウントが有効化されていないためログインできません。"
      signed_up_but_locked: "アカウント登録が完了しました。しかし、アカウントが凍結されているためログインできません。"
      signed_up_but_unconfirmed: "確認メールを登録したメールアドレス宛に送信しました。リンクをクリックしてアカウントを有効化してください。"
      update_needs_confirmation: "アカウント情報を変更しました。変更されたメールアドレスの確認が必要です。"
      updated: "アカウント情報を変更しました。"
      updated_but_not_signed_in: "アカウント情報を変更しました。変更された内容を反映するため、再度ログインしてください。"
    sessions:
      signed_in: "ログインしました。"
      signed_out: "ログアウトしました。"
      already_signed_out: "すでにログアウトしています。"
    unlocks:
      send_instructions: "アカウントの凍結解除方法を数分以内にメールで送信します。"
      send_paranoid_instructions: "アカウントが存在する場合、アカウントの凍結解除方法を数分以内にメールで送信します。"
      unlocked: "アカウントを凍結解除しました。ログインしてください。"
  errors:
    messages:
      already_confirmed: "は既に登録済みです。ログインしてください。"
      confirmation_period_expired: "の期限が切れました。%{period} までに確認する必要があります。 新しくリクエストしてください。"
      expired: "の期限が切れました。新しくリクエストしてください。"
      not_found: "は見つかりませんでした。"
      not_locked: "は凍結されていません。"
      not_saved:
        one: "エラーが発生したため %{resource} は保存されませんでした:"
        other: "%{count} 件のエラーが発生したため %{resource} は保存されませんでした:"
</file>

<file path="config/locales/en.yml">
# Files in the config/locales directory are used for internationalization and
# are automatically loaded by Rails. If you want to use locales other than
# English, add the necessary files in this directory.
#
# To use the locales, use `I18n.t`:
#
#     I18n.t "hello"
#
# In views, this is aliased to just `t`:
#
#     <%= t("hello") %>
#
# To use a different locale, set it with `I18n.locale`:
#
#     I18n.locale = :es
#
# This would use the information in config/locales/es.yml.
#
# To learn more about the API, please read the Rails Internationalization guide
# at https://guides.rubyonrails.org/i18n.html.
#
# Be aware that YAML interprets the following case-insensitive strings as
# booleans: `true`, `false`, `on`, `off`, `yes`, `no`. Therefore, these strings
# must be quoted to be interpreted as strings. For example:
#
#     en:
#       "yes": yup
#       enabled: "ON"

en:
  hello: "Hello world"
</file>

<file path="config/application.rb">
require_relative "boot"

require "rails/all"

# Require the gems listed in Gemfile, including any gems
# you've limited to :test, :development, or :production.
Bundler.require(*Rails.groups)

module Myapp
  class Application < Rails::Application
    # Initialize configuration defaults for originally generated Rails version.
    config.load_defaults 7.2

    # Please, add to the `ignore` list any other `lib` subdirectories that do
    # not contain `.rb` files, or that should not be reloaded or eager loaded.
    # Common ones are `templates`, `generators`, or `middleware`, for example.
    config.autoload_lib(ignore: %w[assets tasks])

    # Configuration for the application, engines, and railties goes here.
    #
    # These settings can be overridden in specific environments using the files
    # in config/environments, which are processed later.
    #
    # config.time_zone = "Central Time (US & Canada)"
    config.time_zone = "Tokyo"
    config.i18n.default_locale = :ja
    # config.eager_load_paths << Rails.root.join("extras")
  end
end
</file>

<file path="config/boot.rb">
ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../Gemfile", __dir__)

require "bundler/setup" # Set up gems listed in the Gemfile.
require "bootsnap/setup" # Speed up boot time by caching expensive operations.
</file>

<file path="config/cable.yml">
development:
  adapter: async

test:
  adapter: test

production:
  adapter: redis
  url: <%= ENV.fetch("REDIS_URL") { "redis://localhost:6379/1" } %>
  channel_prefix: myapp_production
</file>

<file path="config/cache.yml">
default: &default
  store_options:
    # Cap age of oldest cache entry to fulfill retention policies
    # max_age: <%= 60.days.to_i %>
    max_size: <%= 256.megabytes %>
    namespace: <%= Rails.env %>

development:
  <<: *default

test:
  <<: *default

production:
  database: cache
  <<: *default
</file>

<file path="config/credentials.yml.enc">
Ih4Fi/PhMKn0tpRJYF8tKHKyYUwmg99PPaGLll8EGXbSBnELEhSoo+tPWYiyRBa55xCWX5ZGoNshn0jcaBCljb+3i4l9u9v2gqYVjjCM9ZDoIloZvMRr5as8igy8WVHQijOKDc3eNHNOepzR6BhkiTpnTzpMwjAcopX8EcIZ3HO/sAnkyB3b5Ew1B6eztaFtWDu/Gpem77ChEa3X+jvJoBvS8U4259sLegW1LJA=--k9/++Cpqsksibuh1--7tDXpjE6w+7C05AbnbUcuA==
</file>

<file path="config/database.yml">
default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>

development:
  <<: *default
  database: tekumemo_development
  username: postgres
  password: password
  host: <%= ENV['DATABASE_HOST'] || '127.0.0.1' %>
  port: 5432

test:
  <<: *default
  database: tekumemo_test<%= ENV['TEST_ENV_NUMBER'] %>
  username: postgres
  password: password
  host: <%= ENV['DATABASE_HOST'] || '127.0.0.1' %>
  port: 5432

production:
  primary: &primary_production
    <<: *default
    url: <%= ENV['DATABASE_URL'] %>

  cache:
    <<: *primary_production
    # Solid Cache用の設定（プライマリと同じDBを使用）
</file>

<file path="config/environment.rb">
# Load the Rails application.
require_relative "application"

# Initialize the Rails application.
Rails.application.initialize!
</file>

<file path="config/puma.rb">
threads_count = ENV.fetch("RAILS_MAX_THREADS", 3)
threads threads_count, threads_count

environment ENV.fetch("RAILS_ENV") { "development" }

# Bind to 0.0.0.0 to allow access from outside Docker container
bind "tcp://0.0.0.0:#{ENV.fetch('PORT', 3000)}"

plugin :tmp_restart

pidfile ENV["PIDFILE"] if ENV["PIDFILE"]
</file>

<file path="config/storage.yml">
test:
  service: Disk
  root: <%= Rails.root.join("tmp/storage") %>

local:
  service: Disk
  root: <%= Rails.root.join("storage") %>

cloudinary:
  service: Cloudinary
  cloud_name: <%= ENV['CLOUDINARY_CLOUD_NAME'] %>
  api_key: <%= ENV['CLOUDINARY_API_KEY'] %>
  api_secret: <%= ENV['CLOUDINARY_API_SECRET'] %>
# Use bin/rails credentials:edit to set the AWS secrets (as aws:access_key_id|secret_access_key)
# amazon:
#   service: S3
#   access_key_id: <%= Rails.application.credentials.dig(:aws, :access_key_id) %>
#   secret_access_key: <%= Rails.application.credentials.dig(:aws, :secret_access_key) %>
#   region: us-east-1
#   bucket: your_own_bucket-<%= Rails.env %>

# Remember not to checkin your GCS keyfile to a repository
# google:
#   service: GCS
#   project: your_project
#   credentials: <%= Rails.root.join("path/to/gcs.keyfile") %>
#   bucket: your_own_bucket-<%= Rails.env %>

# Use bin/rails credentials:edit to set the Azure Storage secret (as azure_storage:storage_access_key)
# microsoft:
#   service: AzureStorage
#   storage_account_name: your_account_name
#   storage_access_key: <%= Rails.application.credentials.dig(:azure_storage, :storage_access_key) %>
#   container: your_container_name-<%= Rails.env %>

# mirror:
#   service: Mirror
#   primary: local
#   mirrors: [ amazon, google, microsoft ]
</file>

<file path="db/migrate/20251111002651_devise_create_users.rb">
# frozen_string_literal: true

class DeviseCreateUsers < ActiveRecord::Migration[7.2]
  def change
    create_table :users do |t|
      ## Database authenticatable
      t.string :email,              null: false, default: ""
      t.string :encrypted_password, null: false, default: ""

      ## Recoverable
      t.string   :reset_password_token
      t.datetime :reset_password_sent_at

      ## Rememberable
      t.datetime :remember_created_at

      ## Trackable
      # t.integer  :sign_in_count, default: 0, null: false
      # t.datetime :current_sign_in_at
      # t.datetime :last_sign_in_at
      # t.string   :current_sign_in_ip
      # t.string   :last_sign_in_ip

      ## Confirmable
      # t.string   :confirmation_token
      # t.datetime :confirmed_at
      # t.datetime :confirmation_sent_at
      # t.string   :unconfirmed_email # Only if using reconfirmable

      ## Lockable
      # t.integer  :failed_attempts, default: 0, null: false # Only if lock strategy is :failed_attempts
      # t.string   :unlock_token # Only if unlock strategy is :email or :both
      # t.datetime :locked_at


      t.timestamps null: false
    end

    add_index :users, :email,                unique: true
    add_index :users, :reset_password_token, unique: true
    # add_index :users, :confirmation_token,   unique: true
    # add_index :users, :unlock_token,         unique: true
  end
end
</file>

<file path="db/migrate/20251118043542_create_walks.rb">
class CreateWalks < ActiveRecord::Migration[7.2]
  def change
    create_table :walks do |t|
      t.references :user, null: false, foreign_key: true
      t.date :walked_on
      t.integer :duration
      t.decimal :distance
      t.string :location
      t.text :notes

      t.timestamps
    end
  end
end
</file>

<file path="db/migrate/20251118051923_add_google_oauth_to_users.rb">
class AddGoogleOauthToUsers < ActiveRecord::Migration[7.2]
  def change
    add_column :users, :google_uid, :string
    add_column :users, :google_token, :text
    add_column :users, :google_refresh_token, :text
    add_column :users, :google_expires_at, :datetime
  end
end
</file>

<file path="db/migrate/20251118080733_add_steps_and_calories_to_walks.rb">
class AddStepsAndCaloriesToWalks < ActiveRecord::Migration[7.2]
  def change
    add_column :walks, :steps, :integer
    add_column :walks, :calories_burned, :integer
  end
end
</file>

<file path="db/migrate/20251125000014_add_avatar_url_to_users.rb">
class AddAvatarUrlToUsers < ActiveRecord::Migration[7.2]
  def change
    add_column :users, :avatar_url, :string
  end
end
</file>

<file path="db/migrate/20251125035721_add_name_to_users.rb">
class AddNameToUsers < ActiveRecord::Migration[7.2]
  def change
    add_column :users, :name, :string
  end
end
</file>

<file path="db/migrate/20251127074734_add_target_distance_to_users.rb">
class AddTargetDistanceToUsers < ActiveRecord::Migration[7.2]
  def change
    add_column :users, :target_distance, :integer, default: 3000, null: false
  end
end
</file>

<file path="db/migrate/20251201090805_add_use_google_avatar_to_users.rb">
class AddUseGoogleAvatarToUsers < ActiveRecord::Migration[7.2]
  def change
    add_column :users, :use_google_avatar, :boolean, default: true
  end
end
</file>

<file path="db/migrate/20251203000814_create_posts.rb">
class CreatePosts < ActiveRecord::Migration[7.2]
  def change
    create_table :posts do |t|
      t.references :user, null: false, foreign_key: true
      t.references :walk, null: true, foreign_key: true
      t.text :body  # null: falseを削除（天気・気分のみの投稿も可能に）
      t.integer :weather
      t.integer :feeling

      t.timestamps
    end

    # 全ユーザーのタイムライン表示を高速化
    add_index :posts, :created_at

    # 特定ユーザーの投稿履歴表示を高速化
    add_index :posts, [ :user_id, :created_at ]
  end
end
</file>

<file path="db/migrate/20251203000817_create_reactions.rb">
class CreateReactions < ActiveRecord::Migration[7.2]
  def change
    create_table :reactions do |t|
      t.references :user, null: false, foreign_key: true
      t.references :post, null: false, foreign_key: true
      t.integer :kind, null: false  # リアクションの種類

      t.timestamps
    end

    # 1ユーザーが1投稿に対して1種類のリアクションのみ（重複防止）
    add_index :reactions, [ :user_id, :post_id, :kind ], unique: true, name: 'index_reactions_on_user_post_kind'
    # 投稿ごとのリアクション集計の高速化
    add_index :reactions, [ :post_id, :kind ]
  end
end
</file>

<file path="db/migrate/20251204051500_create_solid_cache_entries.rb">
class CreateSolidCacheEntries < ActiveRecord::Migration[7.2]
  def change
    create_table :solid_cache_entries do |t|
      t.binary   :key,       null: false, limit: 1024
      t.binary   :value,     null: false, limit: 536_870_912
      t.datetime :created_at, null: false
      t.integer  :key_hash,  null: false, limit: 8
      t.integer  :byte_size, null: false, limit: 4

      t.index [ :key_hash, :byte_size ], name: "index_solid_cache_entries_on_key_hash_and_byte_size"
      t.index [ :key_hash ], name: "index_solid_cache_entries_on_key_hash", unique: true
      t.index [ :byte_size ], name: "index_solid_cache_entries_on_byte_size"
    end
  end
end
</file>

<file path="db/migrate/20251205012042_add_index_to_walks_user_id_and_walked_on.rb">
class AddIndexToWalksUserIdAndWalkedOn < ActiveRecord::Migration[7.2]
  def change
    add_index :walks, [ :user_id, :walked_on ]
    add_index :walks, :walked_on
  end
end
</file>

<file path="db/migrate/20251211083937_create_announcements.rb">
class CreateAnnouncements < ActiveRecord::Migration[7.2]
  def change
    create_table :announcements do |t|
      t.string :title, null: false
      t.text :content, null: false
      t.string :announcement_type, default: 'info'
      t.datetime :published_at
      t.datetime :expires_at
      t.boolean :is_published, default: false, null: false
      t.integer :priority, default: 0

      t.timestamps
    end

    add_index :announcements, :is_published
    add_index :announcements, :published_at
  end
end
</file>

<file path="db/migrate/20251211084125_add_is_admin_to_users.rb">
class AddIsAdminToUsers < ActiveRecord::Migration[7.2]
  def change
    add_column :users, :is_admin, :boolean, default: false, null: false
    add_index :users, :is_admin
  end
end
</file>

<file path="db/migrate/20251211105939_create_notifications.rb">
class CreateNotifications < ActiveRecord::Migration[7.2]
  def change
    create_table :notifications do |t|
      t.references :user, null: false, foreign_key: true
      t.references :announcement, null: false, foreign_key: true
      t.datetime :read_at

      t.timestamps
    end

    add_index :notifications, [ :user_id, :read_at ]
  end
end
</file>

<file path="db/migrate/20251211121714_remove_priority_from_announcements.rb">
class RemovePriorityFromAnnouncements < ActiveRecord::Migration[7.2]
  def change
    remove_column :announcements, :priority, :integer
  end
end
</file>

<file path="db/migrate/20251212025118_add_notification_settings_to_users.rb">
class AddNotificationSettingsToUsers < ActiveRecord::Migration[7.2]
  def change
    # 散歩時間リマインド機能
    add_column :users, :walk_reminder_enabled, :boolean, default: false, null: false, comment: "散歩時間リマインド通知の有効/無効"
    add_column :users, :walk_reminder_time, :time, default: "19:00", comment: "散歩リマインド通知の時刻"

    # 非アクティブリマインド機能
    add_column :users, :inactive_days_reminder_enabled, :boolean, default: true, null: false, comment: "非アクティブリマインド通知の有効/無効"
    add_column :users, :inactive_days_threshold, :integer, default: 3, null: false, comment: "非アクティブと判定する日数"

    # リアクションまとめ通知機能
    add_column :users, :reaction_summary_enabled, :boolean, default: true, null: false, comment: "リアクションまとめ通知の有効/無効"
  end
end
</file>

<file path="db/migrate/20251212031212_create_web_push_subscriptions.rb">
class CreateWebPushSubscriptions < ActiveRecord::Migration[7.2]
  def change
    create_table :web_push_subscriptions do |t|
      t.references :user, null: false, foreign_key: true
      t.string :endpoint, null: false, comment: "通知送信先URL"
      t.string :p256dh, null: false, comment: "暗号化キー (P-256 curve)"
      t.string :auth_key, null: false, comment: "認証シークレット"
      t.string :user_agent, comment: "登録したブラウザ/デバイス情報"

      t.timestamps
    end

    add_index :web_push_subscriptions, :endpoint, unique: true
  end
end
</file>

<file path="db/migrate/20251213011842_add_reminder_fields_to_notifications.rb">
class AddReminderFieldsToNotifications < ActiveRecord::Migration[7.2]
  def change
    # announcement_idをoptionalにする（リマインダー通知では不要なため）
    change_column_null :notifications, :announcement_id, true

    # リマインダー用のカラムを追加
    add_column :notifications, :notification_type, :integer, default: 0, null: false, comment: "通知種類: 0=お知らせ, 1=非アクティブリマインド, 2=リアクションまとめ"
    add_column :notifications, :message, :text, comment: "リマインダー通知のメッセージ"
    add_column :notifications, :url, :string, comment: "リマインダー通知のリンク先"

    # 検索効率化のためのインデックス
    add_index :notifications, :notification_type
  end
end
</file>

<file path="db/migrate/20251214160212_add_role_to_users.rb">
class AddRoleToUsers < ActiveRecord::Migration[7.2]
  def change
    add_column :users, :role, :integer, default: 0, null: false
  end
end
</file>

<file path="db/migrate/20251215082600_add_trackable_to_users.rb">
class AddTrackableToUsers < ActiveRecord::Migration[7.2]
  def change
    add_column :users, :sign_in_count, :integer, default: 0, null: false
    add_column :users, :current_sign_in_at, :datetime
    add_column :users, :last_sign_in_at, :datetime
    add_column :users, :current_sign_in_ip, :string
    add_column :users, :last_sign_in_ip, :string
  end
end
</file>

<file path="db/scripts/create_anomaly_test_data.rb">
#!/usr/bin/env ruby
# 異常検知テスト用ダミーデータ作成スクリプト
# 実行方法: rails runner db/scripts/create_anomaly_test_data.rb
# 削除方法: rails runner db/scripts/delete_anomaly_test_data.rb

puts "=== 異常検知テスト用ダミーデータ作成開始 ==="

# テスト用ユーザーを一時的に保存する配列
test_user_ids = []

# 1. スパム疑いユーザー（24時間で20件以上投稿）
puts "\n[1/5] スパム疑いユーザーを作成中..."
spam_user = User.create!(
  name: "【テスト】スパムユーザー",
  email: "test_spam_#{Time.current.to_i}@example.com",
  password: "password123",
  role: :general
)
test_user_ids << spam_user.id


# 24時間以内に25件の投稿を作成
25.times do |i|
  post = Post.create!(
    user: spam_user,
    body: "テスト投稿 #{i + 1} - これはスパム検知のテストです"
  )
  # タイムスタンプをバリデーションをスキップして更新
  post.update_column(:created_at, rand(1..23).hours.ago)
end
puts "  ✓ スパムユーザー作成完了（25件投稿）"

# 2. 新規ユーザースパム（登録1時間以内に5件以上投稿）
puts "\n[2/5] 新規ユーザースパムを作成中..."
new_spam_user = User.create!(
  name: "【テスト】新規スパム",
  email: "test_new_spam_#{Time.current.to_i}@example.com",
  password: "password123",
  role: :general
)
new_spam_user.update_column(:created_at, 30.minutes.ago)
test_user_ids << new_spam_user.id

# 登録から1時間以内に8件の投稿を作成
8.times do |i|
  post = Post.create!(
    user: new_spam_user,
    body: "新規ユーザー投稿 #{i + 1}"
  )
  post.update_column(:created_at, rand(1..29).minutes.ago)
end
puts "  ✓ 新規スパムユーザー作成完了（8件投稿）"

# 3. データ整合性エラー（異常な距離・歩数の散歩記録）
puts "\n[3/5] データ整合性エラーを作成中..."
invalid_data_user = User.create!(
  name: "【テスト】データ異常ユーザー",
  email: "test_invalid_data_#{Time.current.to_i}@example.com",
  password: "password123",
  role: :general
)
test_user_ids << invalid_data_user.id

# 異常な距離の散歩記録（50km以上）
Walk.create!(
  user: invalid_data_user,
  distance: 75000, # 75km
  steps: 100000,
  walked_on: Date.today,
  duration: 7200 # 2時間 = 7200秒
)

# 異常な歩数の散歩記録（10万歩以上）
Walk.create!(
  user: invalid_data_user,
  distance: 10000,
  steps: 150000, # 15万歩
  walked_on: Date.yesterday,
  duration: 3600 # 1時間 = 3600秒
)
puts "  ✓ データ異常ユーザー作成完了（異常な散歩記録2件）"

# 4. セキュリティ懸念（30日以上未ログインだが最近投稿あり）
puts "\n[4/5] セキュリティ懸念ユーザーを作成中..."
security_concern_user = User.create!(
  name: "【テスト】セキュリティ懸念",
  email: "test_security_#{Time.current.to_i}@example.com",
  password: "password123",
  role: :general
)
# タイムスタンプを手動で設定
security_concern_user.update_columns(
  created_at: 60.days.ago,
  current_sign_in_at: 35.days.ago,
  last_sign_in_at: 36.days.ago
)
test_user_ids << security_concern_user.id

# 最近（7日以内）の投稿を作成
3.times do |i|
  post = Post.create!(
    user: security_concern_user,
    body: "最近の投稿 #{i + 1} - アカウント乗っ取り？"
  )
  post.update_column(:created_at, rand(1..6).days.ago)
end
puts "  ✓ セキュリティ懸念ユーザー作成完了（35日間未ログイン、最近3件投稿）"

# 5. 非アクティブアカウント（登録30日以上、投稿・散歩0件）
puts "\n[5/5] 非アクティブアカウントを作成中..."
3.times do |i|
  inactive_user = User.create!(
    name: "【テスト】非アクティブ#{i + 1}",
    email: "test_inactive_#{i}_#{Time.current.to_i}@example.com",
    password: "password123",
    role: :general
  )
  inactive_user.update_column(:created_at, (35 + i * 5).days.ago)
  test_user_ids << inactive_user.id
end
puts "  ✓ 非アクティブアカウント3件作成完了"

# テストユーザーIDをファイルに保存（削除用）
File.write(
  Rails.root.join('tmp', 'anomaly_test_user_ids.txt'),
  test_user_ids.join("\n")
)

puts "\n=== 完了 ==="
puts "作成されたテストユーザー数: #{test_user_ids.count}"
puts "ユーザーID: #{test_user_ids.join(', ')}"
puts "\n管理者ダッシュボード（/admin）で異常検知を確認してください。"
puts "\n削除方法:"
puts "  rails runner db/scripts/delete_anomaly_test_data.rb"
</file>

<file path="db/scripts/delete_anomaly_test_data.rb">
#!/usr/bin/env ruby
# 異常検知テスト用ダミーデータ削除スクリプト
# 実行方法: rails runner db/scripts/delete_anomaly_test_data.rb

puts "=== 異常検知テスト用ダミーデータ削除開始 ==="

id_file_path = Rails.root.join('tmp', 'anomaly_test_user_ids.txt')

unless File.exist?(id_file_path)
  puts "エラー: ユーザーIDファイルが見つかりません"
  puts "パス: #{id_file_path}"
  exit 1
end

user_ids = File.read(id_file_path).split("\n").map(&:to_i)

if user_ids.empty?
  puts "削除するユーザーIDがありません"
  exit 0
end

puts "削除対象ユーザー数: #{user_ids.count}"
puts "ユーザーID: #{user_ids.join(', ')}"

deleted_count = 0
user_ids.each do |user_id|
  user = User.find_by(id: user_id)
  if user
    user.destroy
    deleted_count += 1
    puts "  ✓ #{user.name} を削除しました"
  else
    puts "  ⚠ ID #{user_id} のユーザーは既に削除されています"
  end
end

# IDファイルを削除
File.delete(id_file_path)

puts "\n=== 完了 ==="
puts "削除されたユーザー数: #{deleted_count}"
puts "関連する投稿・散歩記録も自動的に削除されました（dependent: :destroy）"
</file>

<file path="db/cache_schema.rb">
ActiveRecord::Schema[7.2].define(version: 1) do
  create_table "solid_cache_entries", force: :cascade do |t|
    t.binary "key", limit: 1024, null: false
    t.binary "value", limit: 536870912, null: false
    t.datetime "created_at", null: false
    t.integer "key_hash", limit: 8, null: false
    t.integer "byte_size", limit: 4, null: false
    t.index ["byte_size"], name: "index_solid_cache_entries_on_byte_size"
    t.index ["key_hash", "byte_size"], name: "index_solid_cache_entries_on_key_hash_and_byte_size"
    t.index ["key_hash"], name: "index_solid_cache_entries_on_key_hash", unique: true
  end
end
</file>

<file path="lib/assets/.keep">

</file>

<file path="lib/tasks/.keep">

</file>

<file path="lib/tasks/admin.rake">
namespace :admin do
  desc "現在の管理者ユーザーを表示"
  task list: :environment do
    admins = User.where(role: "admin")

    if admins.any?
      puts "=" * 60
      puts "現在の管理者ユーザー（#{admins.count}名）"
      puts "=" * 60
      admins.each do |user|
        puts "ID: #{user.id}"
        puts "名前: #{user.name}"
        puts "メール: #{user.email}"
        puts "登録日: #{user.created_at.strftime('%Y-%m-%d %H:%M')}"
        puts "-" * 60
      end
    else
      puts "管理者ユーザーが存在しません"
    end
  end

  desc "指定したメールアドレスのユーザーに管理者権限を付与"
  task :grant, [ :email ] => :environment do |t, args|
    email = args[:email] || ENV["ADMIN_EMAIL"]

    if email.blank?
      puts "エラー: メールアドレスが指定されていません"
      puts "使用方法: rake admin:grant[email@example.com]"
      puts "または: ADMIN_EMAIL=email@example.com rake admin:grant"
      exit 1
    end

    user = User.find_by(email: email)

    if user.nil?
      puts "エラー: メールアドレス '#{email}' のユーザーが見つかりません"
      exit 1
    end

    if user.admin?
      puts "ユーザー '#{user.name}' (#{user.email}) は既に管理者です"
    else
      user.update!(role: "admin")
      puts "✅ 成功: ユーザー '#{user.name}' (#{user.email}) に管理者権限を付与しました"
    end
  end

  desc "指定したメールアドレスのユーザーから管理者権限を削除"
  task :revoke, [ :email ] => :environment do |t, args|
    email = args[:email] || ENV["ADMIN_EMAIL"]

    if email.blank?
      puts "エラー: メールアドレスが指定されていません"
      puts "使用方法: rake admin:revoke[email@example.com]"
      puts "または: ADMIN_EMAIL=email@example.com rake admin:revoke"
      exit 1
    end

    user = User.find_by(email: email)

    if user.nil?
      puts "エラー: メールアドレス '#{email}' のユーザーが見つかりません"
      exit 1
    end

    if user.general?
      puts "ユーザー '#{user.name}' (#{user.email}) は既に一般ユーザーです"
    else
      user.update!(role: "general")
      puts "✅ 成功: ユーザー '#{user.name}' (#{user.email}) から管理者権限を削除しました"
    end
  end
end
</file>

<file path="lib/tasks/announcement_data.rake">
namespace :announcement do
  desc "初期のお知らせデータをインポートする"
  task import: :environment do
    puts "お知らせデータのインポートを開始します..."

    announcements = [
      {
        title: "データ分析機能リリースのお知らせ",
        content: "日々の散歩データをグラフで確認できる「データ分析機能」をリリースしました！\n\n■ 機能概要\n・週間/月間の歩行距離グラフ\n・消費カロリーの推移\n・時間帯別の活動傾向\n\nマイページの「データ分析」タブからご確認いただけます。毎日の健康管理にぜひお役立てください。",
        announcement_type: "info",
        is_published: true,
        published_at: Time.zone.parse("2024-12-10 10:00:00")
      },
      {
        title: "通知機能リリースのお知らせ 🔔",
        content: "運営からのお知らせが届くと、ベルアイコンに通知バッジが表示されるようになりました。\n重要なお知らせを見逃さずにチェックできます。",
        announcement_type: "info",
        is_published: true,
        published_at: Time.current
      },
      {
        title: "アプリとして使えるようになりました (PWA) 📱",
        content: "スマートフォンやPCのブラウザから「ホーム画面に追加」することで、アプリのように起動できるようになりました！\n\n・ホーム画面からワンタップで起動\n・ページの読み込みが高速化\n・全画面表示で広々使える\n\nぜひホーム画面に追加して、毎日の散歩記録をよりスムーズにお楽しみください！",
        announcement_type: "info",
        is_published: true,
        published_at: Time.current
      }
    ]

    count = 0
    announcements.each do |data|
      announcement = Announcement.find_or_initialize_by(title: data[:title])
      if announcement.new_record?
        announcement.update!(data)
        puts "作成: #{announcement.title}"
        count += 1
      else
        puts "スキップ（既存）: #{announcement.title}"
      end
    end

    puts "#{count}件のお知らせを作成しました。"

    # 全ユーザーへの通知作成
    puts "全ユーザーへの通知を作成中..."
    notification_count = 0
    Announcement.published.find_each do |announcement|
      User.find_each do |user|
        unless Notification.exists?(user: user, announcement: announcement)
          Notification.create!(user: user, announcement: announcement)
          notification_count += 1
        end
      end
    end
    puts "#{notification_count}件の通知を作成しました。"
    puts "完了しました！"
  end
end
</file>

<file path="lib/tasks/reminder.rake">
namespace :reminder do
  desc "散歩時間のリマインドを送信（1時間ごとに実行推奨）"
  task walk: :environment do
    Rails.logger.info "Starting walk reminder task..."
    WalkReminderService.send_reminders
    Rails.logger.info "Walk reminder task completed."
  end

  desc "非アクティブユーザーへのリマインドを送信（1日1回実行推奨）"
  task inactive: :environment do
    Rails.logger.info "Starting inactive reminder task..."
    InactiveReminderService.send_reminders
    Rails.logger.info "Inactive reminder task completed."
  end

  desc "リアクションのまとめ通知を送信（1日1回実行推奨、夕方〜夜がおすすめ）"
  task reaction_summary: :environment do
    Rails.logger.info "Starting reaction summary task..."
    ReactionSummaryService.send_summaries
    Rails.logger.info "Reaction summary task completed."
  end
end
</file>

<file path="lib/supabase.js">
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
</file>

<file path="log/.keep">

</file>

<file path="public/404.html">
<!DOCTYPE html>
<html>
<head>
  <title>The page you were looking for doesn't exist (404)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
  .rails-default-error-page {
    background-color: #EFEFEF;
    color: #2E2F30;
    text-align: center;
    font-family: arial, sans-serif;
    margin: 0;
  }

  .rails-default-error-page div.dialog {
    width: 95%;
    max-width: 33em;
    margin: 4em auto 0;
  }

  .rails-default-error-page div.dialog > div {
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #BBB;
    border-top: #B00100 solid 4px;
    border-top-left-radius: 9px;
    border-top-right-radius: 9px;
    background-color: white;
    padding: 7px 12% 0;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }

  .rails-default-error-page h1 {
    font-size: 100%;
    color: #730E15;
    line-height: 1.5em;
  }

  .rails-default-error-page div.dialog > p {
    margin: 0 0 1em;
    padding: 1em;
    background-color: #F7F7F7;
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #999;
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 4px;
    border-top-color: #DADADA;
    color: #666;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }
  </style>
</head>

<body class="rails-default-error-page">
  <!-- This file lives in public/404.html -->
  <div class="dialog">
    <div>
      <h1>The page you were looking for doesn't exist.</h1>
      <p>You may have mistyped the address or the page may have moved.</p>
    </div>
    <p>If you are the application owner check the logs for more information.</p>
  </div>
</body>
</html>
</file>

<file path="public/406-unsupported-browser.html">
<!DOCTYPE html>
<html>
<head>
  <title>Your browser is not supported (406)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
  .rails-default-error-page {
    background-color: #EFEFEF;
    color: #2E2F30;
    text-align: center;
    font-family: arial, sans-serif;
    margin: 0;
  }

  .rails-default-error-page div.dialog {
    width: 95%;
    max-width: 33em;
    margin: 4em auto 0;
  }

  .rails-default-error-page div.dialog > div {
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #BBB;
    border-top: #B00100 solid 4px;
    border-top-left-radius: 9px;
    border-top-right-radius: 9px;
    background-color: white;
    padding: 7px 12% 0;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }

  .rails-default-error-page h1 {
    font-size: 100%;
    color: #730E15;
    line-height: 1.5em;
  }

  .rails-default-error-page div.dialog > p {
    margin: 0 0 1em;
    padding: 1em;
    background-color: #F7F7F7;
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #999;
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 4px;
    border-top-color: #DADADA;
    color: #666;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }
  </style>
</head>

<body class="rails-default-error-page">
  <!-- This file lives in public/406-unsupported-browser.html -->
  <div class="dialog">
    <div>
      <h1>Your browser is not supported.</h1>
      <p>Please upgrade your browser to continue.</p>
    </div>
  </div>
</body>
</html>
</file>

<file path="public/422.html">
<!DOCTYPE html>
<html>
<head>
  <title>The change you wanted was rejected (422)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
  .rails-default-error-page {
    background-color: #EFEFEF;
    color: #2E2F30;
    text-align: center;
    font-family: arial, sans-serif;
    margin: 0;
  }

  .rails-default-error-page div.dialog {
    width: 95%;
    max-width: 33em;
    margin: 4em auto 0;
  }

  .rails-default-error-page div.dialog > div {
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #BBB;
    border-top: #B00100 solid 4px;
    border-top-left-radius: 9px;
    border-top-right-radius: 9px;
    background-color: white;
    padding: 7px 12% 0;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }

  .rails-default-error-page h1 {
    font-size: 100%;
    color: #730E15;
    line-height: 1.5em;
  }

  .rails-default-error-page div.dialog > p {
    margin: 0 0 1em;
    padding: 1em;
    background-color: #F7F7F7;
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #999;
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 4px;
    border-top-color: #DADADA;
    color: #666;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }
  </style>
</head>

<body class="rails-default-error-page">
  <!-- This file lives in public/422.html -->
  <div class="dialog">
    <div>
      <h1>The change you wanted was rejected.</h1>
      <p>Maybe you tried to change something you didn't have access to.</p>
    </div>
    <p>If you are the application owner check the logs for more information.</p>
  </div>
</body>
</html>
</file>

<file path="public/500.html">
<!DOCTYPE html>
<html>
<head>
  <title>We're sorry, but something went wrong (500)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
  .rails-default-error-page {
    background-color: #EFEFEF;
    color: #2E2F30;
    text-align: center;
    font-family: arial, sans-serif;
    margin: 0;
  }

  .rails-default-error-page div.dialog {
    width: 95%;
    max-width: 33em;
    margin: 4em auto 0;
  }

  .rails-default-error-page div.dialog > div {
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #BBB;
    border-top: #B00100 solid 4px;
    border-top-left-radius: 9px;
    border-top-right-radius: 9px;
    background-color: white;
    padding: 7px 12% 0;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }

  .rails-default-error-page h1 {
    font-size: 100%;
    color: #730E15;
    line-height: 1.5em;
  }

  .rails-default-error-page div.dialog > p {
    margin: 0 0 1em;
    padding: 1em;
    background-color: #F7F7F7;
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #999;
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 4px;
    border-top-color: #DADADA;
    color: #666;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }
  </style>
</head>

<body class="rails-default-error-page">
  <!-- This file lives in public/500.html -->
  <div class="dialog">
    <div>
      <h1>We're sorry, but something went wrong.</h1>
    </div>
    <p>If you are the application owner check the logs for more information.</p>
  </div>
</body>
</html>
</file>

<file path="public/icon.svg">
<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg">
  <rect width="100%" height="100%" fill="red"/>
</svg>
</file>

<file path="public/robots.txt">
# See https://www.robotstxt.org/robotstxt.html for documentation on how to use the robots.txt file
</file>

<file path="public/service-worker.js">
// プッシュ通知イベントのリスナー
self.addEventListener("push", function (event) {
  let title = "てくメモ";
  let options = {
    body: "新しい通知があります",
    icon: "/icon-192.png", // アプリアイコン（後で用意する必要あり）
    badge: "/icon-192.png", // Androidのステータスバー用アイコン
    data: {
      url: "/", // 通知クリック時の遷移先
    },
  };

  if (event.data) {
    const data = event.data.json();
    title = data.title || title;
    options.body = data.body || options.body;
    options.icon = data.icon || options.icon;
    options.data.url = data.url || options.data.url;

    // アクションボタンがある場合
    if (data.actions) {
      options.actions = data.actions;
    }
  }

  event.waitUntil(self.registration.showNotification(title, options));
});

// 通知クリックイベントのリスナー
self.addEventListener("notificationclick", function (event) {
  event.notification.close(); // 通知を閉じる

  // クリック時の遷移先URL
  const urlToOpen = event.notification.data.url;

  event.waitUntil(
    clients
      .matchAll({
        type: "window",
        includeUncontrolled: true,
      })
      .then(function (windowClients) {
        // すでに開いているタブがあればフォーカスする
        for (let i = 0; i < windowClients.length; i++) {
          const client = windowClients[i];
          if (client.url === urlToOpen && "focus" in client) {
            return client.focus();
          }
        }
        // 開いていなければ新しいウィンドウで開く
        if (clients.openWindow) {
          return clients.openWindow(urlToOpen);
        }
      })
  );
});
</file>

<file path="spec/factories/announcements.rb">
FactoryBot.define do
  factory :announcement do
    title { "テストお知らせ" }
    content { "これはテスト用のお知らせです。" }
    announcement_type { "info" }
    published_at { Time.current }
    expires_at { nil }
    is_published { true }
  end
end
</file>

<file path="spec/factories/posts.rb">
FactoryBot.define do
  factory :post do
    association :user
    body { "今日はいい天気で散歩日和でした！" }
    weather { :sunny }
    feeling { :great }
  end
end
</file>

<file path="spec/factories/reactions.rb">
FactoryBot.define do
  factory :reaction do
    association :user
    association :post
    kind { :thumbs_up }
  end
end
</file>

<file path="spec/factories/users.rb">
FactoryBot.define do
  factory :user do
    sequence(:email) { |n| "tester#{n}@example.com" }
    password { "password123" }
    password_confirmation { "password123" }
    name { "テストユーザー" }
    target_distance { 5000 } # 5km

    trait :general do
      role { :general }
    end

    trait :admin do
      role { :admin }
    end
  end
end
</file>

<file path="spec/factories/walks.rb">
FactoryBot.define do
  factory :walk do
    association :user
    walked_on { Date.current }
    duration { 30 } # 分
    distance { 2.5 } # km
    steps { 3000 }
    calories_burned { 150 }

    # 過去の日付のデータを作るためのトレイト
    trait :yesterday do
      walked_on { 1.day.ago.to_date }
    end
  end
end
</file>

<file path="spec/factories/web_push_subscriptions.rb">
FactoryBot.define do
  factory :web_push_subscription do
    association :user
    endpoint { "https://fcm.googleapis.com/fcm/send/#{SecureRandom.hex}" }
    p256dh { SecureRandom.base64(65) }
    auth_key { SecureRandom.base64(16) }
    user_agent { "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" }
  end
end
</file>

<file path="spec/helpers/posts_helper_spec.rb">
require 'rails_helper'

# Specs in this file have access to a helper object that includes
# the PostsHelper. For example:
#
# describe PostsHelper do
#   describe "string concat" do
#     it "concats two strings with spaces" do
#       expect(helper.concat_strings("this","that")).to eq("this that")
#     end
#   end
# end
RSpec.describe PostsHelper, type: :helper do
  describe "#post_color_theme" do
    let(:post) { build(:post, weather: weather, feeling: feeling) }

    context "天気のスコアが高い場合" do
      let(:weather) { "stormy" } # score: 9
      let(:feeling) { "good" }   # score: 2

      it "天気に基づいたテーマ（stormy）を返すこと" do
        theme = helper.post_color_theme(post)
        expect(theme[:bg]).to include("bg-[#faf5ff]") # stormyの背景色
      end
    end

    context "気分のスコアが高い場合" do
      let(:weather) { "cloudy" } # score: 1
      let(:feeling) { "great" }  # score: 7

      it "気分に基づいたテーマ（great）を返すこと" do
        theme = helper.post_color_theme(post)
        expect(theme[:bg]).to include("bg-[#fffbeb]") # greatの背景色
      end
    end

    context "スコアが同点の場合" do
      # sunny: 5, feelingに5のスコアはないので調整が難しいが、
      # ロジック上は天気が優先される
      # ここでは weather: sunny (5), feeling: normal (0) で天気優先を確認
      let(:weather) { "sunny" }
      let(:feeling) { "normal" }

      it "天気を優先すること" do
        theme = helper.post_color_theme(post)
        expect(theme[:bg]).to include("bg-[#fff7ed]") # sunnyの背景色
      end
    end

    context "未設定の場合" do
      let(:weather) { nil }
      let(:feeling) { nil }

      it "デフォルトのテーマを返すこと" do
        theme = helper.post_color_theme(post)
        expect(theme[:bg]).to include("bg-[#fafaf9]") # defaultの背景色
      end
    end
  end
end
</file>

<file path="spec/models/post_spec.rb">
require 'rails_helper'

RSpec.describe Post, type: :model do
  describe 'バリデーション' do
    let(:post) { build(:post) }

    context '正常系' do
      it 'すべての値が正しく設定されていれば有効であること' do
        expect(post).to be_valid
      end
    end

    context '異常系' do
      it '本文、天気、気分、散歩記録のすべてがない場合は無効であること' do
        post.body = nil
        post.weather = nil
        post.feeling = nil
        post.walk = nil
        expect(post).to be_invalid
        expect(post.errors[:base]).to include('本文、天気、気分、散歩記録のいずれか1つは入力してください')
      end

      it '本文(body)が200文字を超える場合は無効であること' do
        post.body = 'a' * 201
        expect(post).to be_invalid
        expect(post.errors[:body]).to include('は200文字以内で入力してください')
      end
    end
  end

  describe 'アソシエーション' do
    it 'Userに属していること' do
      association = described_class.reflect_on_association(:user)
      expect(association.macro).to eq :belongs_to
    end

    it 'Reactionを複数持っていること' do
      association = described_class.reflect_on_association(:reactions)
      expect(association.macro).to eq :has_many
    end

    it '削除されたらReactionも削除されること' do
      post = create(:post)
      create(:reaction, post: post)
      expect { post.destroy }.to change(Reaction, :count).by(-1)
    end
  end

  describe 'メソッド' do
    describe '#weather_emoji' do
      it '天気に対応した絵文字を返すこと' do
        post = build(:post, weather: :sunny)
        expect(post.weather_emoji).to eq "☀️"

        post.weather = :rainy
        expect(post.weather_emoji).to eq "🌧️"
      end

      it '天気が未設定の場合はnilを返すこと' do
        post = build(:post, weather: nil)
        expect(post.weather_emoji).to be_nil
      end
    end

    describe '#feeling_emoji' do
      it '気分に対応した絵文字を返すこと' do
        post = build(:post, feeling: :great)
        expect(post.feeling_emoji).to eq "😆"

        post.feeling = :tired
        expect(post.feeling_emoji).to eq "😮‍💨"
      end

      it '気分が未設定の場合はnilを返すこと' do
        post = build(:post, feeling: nil)
        expect(post.feeling_emoji).to be_nil
      end
    end
  end
end
</file>

<file path="spec/models/reaction_spec.rb">
require 'rails_helper'

RSpec.describe Reaction, type: :model do
  describe 'バリデーション' do
    let(:reaction) { build(:reaction) }

    context '正常系' do
      it 'すべての値が正しく設定されていれば有効であること' do
        expect(reaction).to be_valid
      end
    end

    context '異常系' do
      it 'ユーザー(user)がない場合は無効であること' do
        reaction.user = nil
        expect(reaction).to be_invalid
      end

      it '投稿(post)がない場合は無効であること' do
        reaction.post = nil
        expect(reaction).to be_invalid
      end

      it '種類(kind)がない場合は無効であること' do
        reaction.kind = nil
        expect(reaction).to be_invalid
      end

      it '同じユーザーが同じ投稿に同じ種類のリアクションを2回つけられないこと' do
        # ユーザーと投稿を作成
        user = create(:user)
        post = create(:post)
        kind = :thumbs_up

        # 1つ目のリアクションを作成
        create(:reaction, user: user, post: post, kind: kind)

        # 2つ目のリアクション（同じ条件）を作成しようとする
        duplicate_reaction = build(:reaction, user: user, post: post, kind: kind)

        expect(duplicate_reaction).to be_invalid
        expect(duplicate_reaction.errors[:user_id]).to include('は同じ投稿に同じリアクションを複数回つけられません')
      end

      it '同じユーザーでも違う種類のリアクションならつけられること' do
        user = create(:user)
        post = create(:post)

        # 1つ目のリアクション（ハート）
        create(:reaction, user: user, post: post, kind: :heart)

        # 2つ目のリアクション（いいね）
        second_reaction = build(:reaction, user: user, post: post, kind: :thumbs_up)

        expect(second_reaction).to be_valid
      end
    end
  end

  describe 'アソシエーション' do
    it 'Userに属していること' do
      association = described_class.reflect_on_association(:user)
      expect(association.macro).to eq :belongs_to
    end

    it 'Postに属していること' do
      association = described_class.reflect_on_association(:post)
      expect(association.macro).to eq :belongs_to
    end
  end
end
</file>

<file path="spec/models/walk_spec.rb">
require 'rails_helper'

RSpec.describe Walk, type: :model do
  # テストデータのセットアップ
  let(:user) { FactoryBot.build_stubbed(:user) }

  describe 'バリデーション' do
    context '正常系' do
      it 'すべての値が正しく入力されていれば有効であること' do
        walk = FactoryBot.build(:walk, user: user)
        expect(walk).to be_valid
      end

      it '歩数とカロリーは空でも有効であること' do
        walk = FactoryBot.build(:walk, user: user, steps: nil, calories_burned: nil)
        expect(walk).to be_valid
      end
    end

    context '必須項目の検証' do
      it '日付(walked_on)がない場合は無効であること' do
        walk = FactoryBot.build(:walk, user: user, walked_on: nil)
        expect(walk).to be_invalid
        expect(walk.errors[:walked_on]).to include("を入力してください")
      end

      it '時間(duration)がない場合は無効であること' do
        walk = FactoryBot.build(:walk, user: user, duration: nil)
        expect(walk).to be_invalid
        expect(walk.errors[:duration]).to include("を入力してください")
      end

      it '距離(distance)がない場合は無効であること' do
        walk = FactoryBot.build(:walk, user: user, distance: nil)
        expect(walk).to be_invalid
        expect(walk.errors[:distance]).to include("を入力してください")
      end
    end

    context '数値の検証' do
      it '時間(duration)は0より大きい整数であること' do
        walk = FactoryBot.build(:walk, user: user, duration: 0)
        expect(walk).to be_invalid

        walk.duration = 1.5 # 整数のみ
        expect(walk).to be_invalid
      end

      it '距離(distance)は0より大きい数値であること' do
        walk = FactoryBot.build(:walk, user: user, distance: 0)
        expect(walk).to be_invalid

        walk.distance = 0.1 # 小数はOK
        expect(walk).to be_valid
      end

      it '歩数(steps)は0以上の整数であること' do
        walk = FactoryBot.build(:walk, user: user, steps: -1)
        expect(walk).to be_invalid

        walk.steps = 0
        expect(walk).to be_valid
      end
    end

    context '一意性の検証' do
      let(:user) { FactoryBot.create(:user) }

      it '同じユーザーが同じ日に重複して記録できないこと' do
        # 1つ目の記録を作成
        FactoryBot.create(:walk, user: user, walked_on: Date.current)

        # 同じ日付で2つ目の記録を作成しようとする
        duplicate_walk = FactoryBot.build(:walk, user: user, walked_on: Date.current)
        expect(duplicate_walk).to be_invalid
        expect(duplicate_walk.errors[:walked_on]).to include("の記録は既に存在します。同じ日付の記録を編集、もしくは削除してください。")
      end

      it '異なるユーザーであれば同じ日付でも記録できること' do
        other_user = FactoryBot.create(:user)
        FactoryBot.create(:walk, user: user, walked_on: Date.current)

        other_user_walk = FactoryBot.build(:walk, user: other_user, walked_on: Date.current)
        expect(other_user_walk).to be_valid
      end
    end
  end

  describe 'スコープ' do
    let(:user) { FactoryBot.create(:user) }

    describe '.recent' do
      it '新しい日付順に並び替えられること' do
        walk1 = FactoryBot.create(:walk, user: user, walked_on: 3.days.ago)
        walk2 = FactoryBot.create(:walk, user: user, walked_on: 1.day.ago)
        walk3 = FactoryBot.create(:walk, user: user, walked_on: 2.days.ago)

        expect(Walk.where(id: [ walk1.id, walk2.id, walk3.id ]).recent).to eq([ walk2, walk3, walk1 ])
      end
    end
  end
end
</file>

<file path="spec/models/web_push_subscription_spec.rb">
require 'rails_helper'

RSpec.describe WebPushSubscription, type: :model do
  describe "バリデーション" do
    let(:subscription) { build(:web_push_subscription) }

    it "有効なファクトリを持つこと" do
      expect(subscription).to be_valid
    end

    it "endpointが必須であること" do
      subscription.endpoint = nil
      expect(subscription).not_to be_valid
      expect(subscription.errors[:endpoint]).to include("を入力してください")
    end

    it "p256dhが必須であること" do
      subscription.p256dh = nil
      expect(subscription).not_to be_valid
      expect(subscription.errors[:p256dh]).to include("を入力してください")
    end

    it "auth_keyが必須であること" do
      subscription.auth_key = nil
      expect(subscription).not_to be_valid
      expect(subscription.errors[:auth_key]).to include("を入力してください")
    end

    it "endpointが一意であること" do
      create(:web_push_subscription, endpoint: "https://example.com/duplicate")
      duplicate_subscription = build(:web_push_subscription, endpoint: "https://example.com/duplicate")
      expect(duplicate_subscription).not_to be_valid
      expect(duplicate_subscription.errors[:endpoint]).to include("はすでに存在します")
    end
  end
end
</file>

<file path="spec/requests/admin/dashboard_spec.rb">
require 'rails_helper'

RSpec.describe "Admin::Dashboard", type: :request do
  let(:admin_user) { create(:user, :admin) }
  let(:general_user) { create(:user, :general) }

  describe "GET /admin/dashboard" do
    context "管理者ユーザーの場合" do
      before { sign_in admin_user }

      it "ダッシュボードにアクセスできること" do
        get admin_root_path
        expect(response).to have_http_status(:success)
      end
    end

    context "一般ユーザーの場合" do
      before { sign_in general_user }

      it "ルートパスにリダイレクトされること" do
        get admin_root_path
        expect(response).to redirect_to(root_path)
        expect(flash[:alert]).to eq "管理者権限が必要です。"
      end
    end

    context "ログインしていない場合" do
      it "ログインページにリダイレクトされること" do
        get admin_root_path
        expect(response).to redirect_to(new_user_session_path)
      end
    end
  end
end
</file>

<file path="spec/requests/users/omniauth_callbacks_spec.rb">
require 'rails_helper'

RSpec.describe "Users::OmniauthCallbacks", type: :request do
  describe "POST /users/auth/google_oauth2/callback" do
    let(:user) { FactoryBot.create(:user) }

    before do
      OmniAuth.config.test_mode = true
      OmniAuth.config.mock_auth[:google_oauth2] = OmniAuth::AuthHash.new({
        provider: "google_oauth2",
        uid: "123456789",
        info: {
          email: user.email,
          image: "http://example.com/avatar.jpg"
        },
        credentials: {
          token: "mock_token",
          refresh_token: "mock_refresh_token",
          expires_at: Time.now.to_i + 3600
        }
      })
    end

    after do
      OmniAuth.config.mock_auth[:google_oauth2] = nil
    end

    context "既存ユーザーがGoogleログインした場合" do
      before do
        # ユーザーを事前に連携状態にしておく（必須ではないが、ログインフローを確認するため）
        user.update!(google_uid: "123456789")
      end

      it "ログインに成功し、remember_meトークンがCookieにセットされること" do
        # OmniAuthのコールバックURLにPOSTリクエスト（Deviseの仕様上、GET/POSTどちらでも受け付けるが、テストではGETでコールバックを模倣することが多い。
        # ただし、Rails 7 + Turboの環境ではPOSTが推奨されることもあるが、OmniAuthのcallback自体はGETで戻ってくることが多い。
        # ここではDeviseのルーティングに合わせてリクエストを送る。

        get user_google_oauth2_omniauth_callback_path

        expect(response).to redirect_to(root_path)
        expect(flash[:notice]).to include("Google アカウントによる認証に成功しました。")

        # remember_user_token クッキーがセットされていることを確認
        # クッキー名はデフォルトで "remember_user_token" だが、Wardenの設定による
        expect(cookies['remember_user_token']).to be_present
      end
    end

    context "未連携のGoogleアカウントでログインしようとした場合" do
      let(:new_email) { "new_google@example.com" }

      before do
        OmniAuth.config.mock_auth[:google_oauth2].info.email = new_email
      end

      it "ログインできず、ログイン画面にリダイレクトされること" do
        expect {
          get user_google_oauth2_omniauth_callback_path
        }.not_to change(User, :count)

        expect(response).to redirect_to(new_user_session_path)
        expect(flash[:alert]).to include("このGoogleアカウントは連携されていません")
      end
    end
  end
end
</file>

<file path="spec/requests/home_controller_spec.rb">
require 'rails_helper'

RSpec.describe "Home", type: :request do
  describe "GET /" do
    context "ログインしていない場合" do
      it "トップページ（LP）が表示されること" do
        get root_path
        expect(response).to have_http_status(:success)
        expect(response.body).to include("てくメモ")
      end
    end

    context "ログインしている場合" do
      let(:user) { create(:user) }

      before do
        sign_in user
      end

      it "ダッシュボードが表示されること" do
        get root_path
        expect(response).to have_http_status(:success)
        expect(response.body).to include("今日の散歩")
      end
    end
  end
end
</file>

<file path="spec/requests/login_stamps_controller_spec.rb">
require 'rails_helper'

RSpec.describe "LoginStamps", type: :request do
  let(:user) { create(:user) }

  before do
    sign_in user
  end

  describe "GET /login_stamps" do
    it "スタンプカードページが表示されること" do
      get login_stamps_path
      expect(response).to have_http_status(:success)
    end
  end
end
</file>

<file path="spec/requests/posts_spec.rb">
require 'rails_helper'

RSpec.describe "Posts", type: :request do
  let(:user) { FactoryBot.create(:user) }
  let(:other_user) { FactoryBot.create(:user) }
  let(:my_post) { FactoryBot.create(:post, user: user, body: "自分の投稿") }
  let(:other_post) { FactoryBot.create(:post, user: other_user, body: "他人の投稿") }

  describe "GET /posts" do
    context "ログインしている場合" do
      before do
        sign_in user
        my_post
        other_post
      end

      it "投稿一覧ページにアクセスできること" do
        get posts_path
        expect(response).to have_http_status(:success)
        expect(response.body).to include("みんな")
      end
    end

    context "ログインしていない場合" do
      it "ログインページにリダイレクトされること" do
        get posts_path
        expect(response).to redirect_to(new_user_session_path)
      end
    end
  end

  describe "POST /posts" do
    before { sign_in user }

    context "有効なパラメータの場合" do
      let(:post_params) { { post: { body: "新しい投稿", weather: "sunny", feeling: "great" } } }

      it "投稿が作成されること" do
        expect {
          post posts_path, params: post_params
        }.to change(Post, :count).by(1)
      end

      it "投稿一覧ページにリダイレクトされること" do
        post posts_path, params: post_params
        expect(response).to redirect_to(posts_path)
      end
    end

    context "無効なパラメータの場合" do
      let(:invalid_params) { { post: { body: "", weather: nil, feeling: nil } } }

      it "投稿が作成されないこと" do
        expect {
          post posts_path, params: invalid_params
        }.not_to change(Post, :count)
      end
    end
  end

  describe "DELETE /posts/:id" do
    before { sign_in user }

    context "自分の投稿の場合" do
      it "投稿を削除できること" do
        my_post # 事前に作成
        expect {
          delete post_path(my_post)
        }.to change(Post, :count).by(-1)
      end
    end

    context "他人の投稿の場合" do
      before { other_post } # 事前に作成

      it "投稿を削除できないこと" do
        expect {
          delete post_path(other_post)
        }.not_to change(Post, :count)
      end

      it "ルートページなどにリダイレクトされる、またはエラーになること" do
        delete post_path(other_post)
        # 権限がない場合はリダイレクトされるか403/404エラーになるはず
        expect(response).not_to have_http_status(:success)
      end
    end
  end
end
</file>

<file path="spec/requests/reactions_spec.rb">
require 'rails_helper'

RSpec.describe "Reactions", type: :request do
  let(:user) { FactoryBot.create(:user) }
  let(:other_user) { FactoryBot.create(:user) }
  let!(:post_item) { FactoryBot.create(:post, user: other_user) }

  before { sign_in user }

  describe "POST /posts/:post_id/reactions" do
    context "有効なパラメータの場合" do
      let(:reaction_params) { { reaction: { kind: "thumbs_up" } } }

      it "リアクションが作成されること" do
        expect {
          post post_reactions_path(post_item), params: reaction_params, headers: { "Accept" => "text/vnd.turbo-stream.html" }
        }.to change(Reaction, :count).by(1)
      end

      it "Turbo Stream形式でレスポンスが返ること" do
        post post_reactions_path(post_item), params: reaction_params, headers: { "Accept" => "text/vnd.turbo-stream.html" }
        expect(response.media_type).to eq Mime[:turbo_stream]
        expect(response).to have_http_status(:success)
      end

      it "JSON形式でリクエストすると、JSON形式でレスポンスが返ること" do
        post post_reactions_path(post_item),
             params: reaction_params,
             headers: { "Accept" => "application/json", "Content-Type" => "application/json" },
             as: :json

        expect(response).to have_http_status(:success)
        expect(response.media_type).to eq "application/json"

        json_response = JSON.parse(response.body)
        expect(json_response["reacted"]).to eq(true)
        expect(json_response["count"]).to eq(1)
      end
    end

    context "重複するリアクションの場合（トグル動作）" do
      before do
        FactoryBot.create(:reaction, user: user, post: post_item, kind: "thumbs_up")
      end

      it "リアクションが削除されること" do
        expect {
          post post_reactions_path(post_item), params: { reaction: { kind: "thumbs_up" } }, headers: { "Accept" => "text/vnd.turbo-stream.html" }
        }.to change(Reaction, :count).by(-1)
      end

      it "JSON形式でリクエストすると、削除後のステータスがJSON形式で返ること" do
        post post_reactions_path(post_item),
             params: { reaction: { kind: "thumbs_up" } },
             headers: { "Accept" => "application/json", "Content-Type" => "application/json" },
             as: :json

        expect(response).to have_http_status(:success)
        expect(response.media_type).to eq "application/json"

        json_response = JSON.parse(response.body)
        expect(json_response["reacted"]).to eq(false)
        expect(json_response["count"]).to eq(0)
      end
    end
  end

  describe "DELETE /posts/:post_id/reactions/:id" do
    let!(:reaction) { FactoryBot.create(:reaction, user: user, post: post_item, kind: "thumbs_up") }

    it "リアクションを削除できること" do
      # ID指定での削除
      expect {
        delete post_reaction_path(post_item, reaction), headers: { "Accept" => "text/vnd.turbo-stream.html" }
      }.to change(Reaction, :count).by(-1)
    end
  end
end
</file>

<file path="spec/requests/static_pages_spec.rb">
require 'rails_helper'

RSpec.describe "StaticPages", type: :request do
  describe "GET /privacy" do
    it "returns http success" do
      get "/privacy"
      expect(response).to have_http_status(:success)
    end
  end
end
</file>

<file path="spec/requests/stats_coming_soon_spec.rb">
require 'rails_helper'

RSpec.describe "StatsComingSoons", type: :request do
  let(:user) { FactoryBot.create(:user) }

  before do
    sign_in user
  end

  describe "GET /index" do
    it "returns http success" do
      get stats_path
      expect(response).to have_http_status(:success)
    end
  end
end
</file>

<file path="spec/requests/walks_pagination_spec.rb">
require 'rails_helper'

RSpec.describe "WalksPagination", type: :request do
  let(:user) { User.create!(email: "pagination_test@example.com", password: "password", name: "ページネーション太郎") }

  before do
    # 15件のデータを作成
    # 場所0: 今日, 場所1: 昨日 ... 場所14: 14日前
    15.times do |i|
      Walk.create!(
        user: user,
        walked_on: Date.current - i.days,
        location: "場所#{i}",
        distance: 1.0,
        duration: 10,
        steps: 1000,
        calories_burned: 50
      )
    end

    # ログイン処理
    sign_in user
  end

  it "ページネーションが表示され、ページ遷移ができること" do
    # 1ページ目にアクセス
    get walks_path, headers: { "Host" => "localhost" }
    expect(response).to have_http_status(:success)

    # 1ページ目の確認（日付が新しい順なので、場所0〜9が表示されるはず）
    expect(response.body).to include("場所0") # 今日の記録
    expect(response.body).to include("場所9") # 9日前の記録
    expect(response.body).not_to include("場所10") # 10日前の記録（2ページ目）

    # ページネーションのリンクが存在することを確認
    expect(response.body).to include('role="navigation"')
    expect(response.body).to include('aria-label="pager"')

    # 2ページ目へアクセス
    get walks_path(page: 2), headers: { "Host" => "localhost" }
    expect(response).to have_http_status(:success)

    # 2ページ目の確認
    expect(response.body).to include("場所10")
    expect(response.body).to include("場所14")
    expect(response.body).not_to include("場所0")
  end
end
</file>

<file path="spec/requests/walks_spec.rb">
require 'rails_helper'

RSpec.describe "Walks", type: :request do
  let(:user) { FactoryBot.create(:user) }
  let(:other_user) { FactoryBot.create(:user) }
  let(:my_walk) { FactoryBot.create(:walk, user: user, walked_on: Date.current) }
  let(:other_walk) { FactoryBot.create(:walk, user: other_user, walked_on: Date.current) }

  describe "GET /walks/new" do
    context "ログインしている場合" do
      before { sign_in user }

      it "新規作成ページにアクセスできること" do
        get new_walk_path
        expect(response).to have_http_status(:success)
      end
    end

    context "ログインしていない場合" do
      it "ログインページにリダイレクトされること" do
        get new_walk_path
        expect(response).to redirect_to(new_user_session_path)
      end
    end
  end

  describe "POST /walks" do
    before { sign_in user }

    context "有効なパラメータの場合" do
      let(:walk_params) { { walk: { walked_on: 1.week.from_now.to_date, distance: 5.0, duration: 60, steps: 5000, calories_burned: 300 } } }

      it "散歩記録が作成されること" do
        expect {
          post walks_path, params: walk_params
        }.to change(Walk, :count).by(1)
      end

      it "詳細ページ（または一覧）にリダイレクトされること" do
        post walks_path, params: walk_params
        expect(response).to redirect_to(walks_path)
      end
    end

    context "無効なパラメータの場合" do
      let(:invalid_params) { { walk: { walked_on: nil, distance: nil } } }

      it "散歩記録が作成されないこと" do
        expect {
          post walks_path, params: invalid_params
        }.not_to change(Walk, :count)
      end
    end
  end

  describe "GET /walks/:id/edit" do
    before { sign_in user }

    context "自分の記録の場合" do
      it "編集ページにアクセスできること" do
        get edit_walk_path(my_walk)
        expect(response).to have_http_status(:success)
      end
    end

    context "他人の記録の場合" do
      it "アクセスできないこと（リダイレクトまたはエラー）" do
        get edit_walk_path(other_walk)
        expect(response).not_to have_http_status(:success)
        # 実装によりリダイレクト先が異なるため、ステータスコードで判定
      end
    end
  end

  describe "PATCH /walks/:id" do
    before { sign_in user }

    context "自分の記録の場合" do
      let(:update_params) { { walk: { distance: 10.0 } } }

      it "更新できること" do
        patch walk_path(my_walk), params: update_params
        expect(my_walk.reload.distance).to eq 10.0
      end
    end

    context "他人の記録の場合" do
      let(:update_params) { { walk: { distance: 100.0 } } }

      it "更新できないこと" do
        patch walk_path(other_walk), params: update_params
        expect(other_walk.reload.distance).not_to eq 100.0
      end
    end
  end

  describe "DELETE /walks/:id" do
    before { sign_in user }

    context "自分の記録の場合" do
      it "削除できること" do
        my_walk # 事前に作成
        expect {
          delete walk_path(my_walk)
        }.to change(Walk, :count).by(-1)
      end
    end

    context "他人の記録の場合" do
      before { other_walk } # 事前に作成

      it "削除できないこと" do
        expect {
          delete walk_path(other_walk)
        }.not_to change(Walk, :count)
      end
    end
  end
end
</file>

<file path="spec/requests/web_push_subscriptions_controller_spec.rb">
require 'rails_helper'

RSpec.describe "WebPushSubscriptions", type: :request do
  let(:user) { create(:user) }

  before do
    sign_in user
  end

  describe "POST /web_push_subscriptions" do
    let(:valid_params) do
      {
        endpoint: "https://fcm.googleapis.com/fcm/send/test",
        keys: {
          p256dh: "test_p256dh",
          auth: "test_auth_key"
        }
      }
    end

    context "有効なパラメータの場合" do
      it "購読情報が保存されること" do
        expect {
          post web_push_subscriptions_path, params: valid_params
        }.to change(WebPushSubscription, :count).by(1)
        expect(response).to have_http_status(:ok)
      end
    end

    context "既存の購読情報がある場合" do
      before do
        create(:web_push_subscription, user: user, endpoint: valid_params[:endpoint])
      end

      it "重複して保存されず、成功ステータスを返すこと" do
        expect {
          post web_push_subscriptions_path, params: valid_params
        }.not_to change(WebPushSubscription, :count)
        expect(response).to have_http_status(:ok)
      end
    end

    context "無効なパラメータの場合" do
      it "保存されず、エラーステータスを返すこと" do
        expect {
          post web_push_subscriptions_path, params: { endpoint: "" }
        }.not_to change(WebPushSubscription, :count)
        expect(response).to have_http_status(:unprocessable_content)
      end
    end
  end
end
</file>

<file path="spec/services/geolocation_service_spec.rb">
require "rails_helper"

RSpec.describe GeolocationService, type: :service do
  describe ".extract_ip" do
    let(:request) { instance_double(ActionDispatch::Request) }

    it "X-Forwarded-Forヘッダーがある場合はその最初のIPを返すこと" do
      allow(request).to receive(:headers).and_return({ "X-Forwarded-For" => "203.0.113.1, 198.51.100.1" })
      expect(described_class.extract_ip(request)).to eq("203.0.113.1")
    end

    it "X-Forwarded-Forヘッダーがない場合はremote_ipを返すこと" do
      allow(request).to receive(:headers).and_return({})
      allow(request).to receive(:remote_ip).and_return("192.0.2.1")
      expect(described_class.extract_ip(request)).to eq("192.0.2.1")
    end
  end

  describe ".get_location" do
    let(:default_location) do
      {
        latitude: 35.6762,
        longitude: 139.6503,
        city: "東京",
        region: "東京都",
        country: "日本"
      }
    end

    context "ローカルIPまたはプライベートIPの場合" do
      it "localhostの場合はデフォルト位置情報を返すこと" do
        expect(described_class.get_location("127.0.0.1")).to eq(default_location)
      end

      it "プライベートIPの場合はデフォルト位置情報を返すこと" do
        expect(described_class.get_location("192.168.1.1")).to eq(default_location)
      end

      it "nilの場合はデフォルト位置情報を返すこと" do
        expect(described_class.get_location(nil)).to eq(default_location)
      end
    end

    context "パブリックIPの場合" do
      let(:ip_address) { "203.0.113.1" }
      let(:geocoder_result) do
        double("GeocoderResult",
          latitude: 34.6937,
          longitude: 135.5023,
          city: "大阪市",
          state: "大阪府",
          country: "日本"
        )
      end

      it "Geocoderで取得できた場合はその位置情報を返すこと" do
        allow(Geocoder).to receive(:search).with(ip_address).and_return([ geocoder_result ])

        result = described_class.get_location(ip_address)

        expect(result[:latitude]).to eq(34.6937)
        expect(result[:longitude]).to eq(135.5023)
        expect(result[:city]).to eq("大阪市")
        expect(result[:region]).to eq("大阪府")
        expect(result[:country]).to eq("日本")
      end

      it "Geocoderで取得できなかった場合はデフォルト位置情報を返すこと" do
        allow(Geocoder).to receive(:search).with(ip_address).and_return([])

        expect(described_class.get_location(ip_address)).to eq(default_location)
      end

      it "例外が発生した場合はデフォルト位置情報を返すこと" do
        allow(Geocoder).to receive(:search).and_raise(StandardError.new("Geocoder error"))

        expect(described_class.get_location(ip_address)).to eq(default_location)
      end
    end
  end
end
</file>

<file path="spec/services/inactive_reminder_service_spec.rb">
require "rails_helper"

RSpec.describe InactiveReminderService, type: :service do
  describe ".send_reminders" do
    let(:threshold) { 3 }
    let(:user) { create(:user, inactive_days_reminder_enabled: true, inactive_days_threshold: threshold) }

    before do
      allow(WebPushService).to receive(:send_notification)
      travel_to Time.zone.parse("2025-01-10 10:00:00")
    end

    context "最終散歩日から指定日数が経過した場合" do
      let!(:user) { create(:user, inactive_days_reminder_enabled: true, inactive_days_threshold: threshold) }

      before do
        create(:walk, user: user, walked_on: threshold.days.ago.to_date)
      end

      it "リマインダーを送信すること" do
        described_class.send_reminders

        expect(WebPushService).to have_received(:send_notification).with(
          user,
          title: "お久しぶりです！",
          body: include("#{threshold}日間、散歩の記録がありません"),
          url: "/walks/new"
        )
      end

      it "通知ボックスに通知を作成すること" do
        expect {
          described_class.send_reminders
        }.to change(Notification, :count).by(1)

        notification = Notification.last
        expect(notification.user).to eq(user)
        expect(notification.notification_type).to eq("inactive_reminder")
      end
    end

    context "散歩記録がなく、登録日から指定日数が経過した場合" do
      # created_atを指定して作成（travel_toの影響を受けるため、days.agoで計算）
      let!(:user) { create(:user, inactive_days_reminder_enabled: true, inactive_days_threshold: threshold, created_at: threshold.days.ago) }

      it "リマインダーを送信すること" do
        described_class.send_reminders

        expect(WebPushService).to have_received(:send_notification).with(
          user,
          title: "お久しぶりです！",
          body: include("#{threshold}日間、散歩の記録がありません"),
          url: "/walks/new"
        )
      end
    end

    context "指定日数が経過していない場合" do
      before do
        create(:walk, user: user, walked_on: (threshold - 1).days.ago.to_date)
      end

      it "リマインダーを送信しないこと" do
        described_class.send_reminders
        expect(WebPushService).not_to have_received(:send_notification)
      end
    end

    context "指定日数を過ぎている場合（当日に送った後は送らない）" do
      before do
        create(:walk, user: user, walked_on: (threshold + 1).days.ago.to_date)
      end

      it "リマインダーを送信しないこと" do
        described_class.send_reminders
        expect(WebPushService).not_to have_received(:send_notification)
      end
    end

    context "リマインダー設定が無効な場合" do
      before do
        user.update!(inactive_days_reminder_enabled: false)
        create(:walk, user: user, walked_on: threshold.days.ago.to_date)
      end

      it "リマインダーを送信しないこと" do
        described_class.send_reminders
        expect(WebPushService).not_to have_received(:send_notification)
      end
    end
  end
end
</file>

<file path="spec/services/reaction_summary_service_spec.rb">
require "rails_helper"

RSpec.describe ReactionSummaryService, type: :service do
  describe ".send_summaries" do
    let(:user) { create(:user, reaction_summary_enabled: true) }
    let(:post) { create(:post, user: user) }
    let(:other_user) { create(:user) }

    before do
      # WebPushServiceのモック化
      allow(WebPushService).to receive(:send_notification)
    end

    context "リアクションがある場合" do
      before do
        # 今日のリアクションを作成
        create(:reaction, post: post, user: other_user, kind: "thumbs_up", created_at: Time.current)
        create(:reaction, post: post, user: other_user, kind: "heart", created_at: Time.current)
        create(:reaction, post: post, user: other_user, kind: "sparkles", created_at: Time.current)
      end

      it "通知設定が有効なユーザーに通知を送信すること" do
        described_class.send_summaries

        expect(WebPushService).to have_received(:send_notification).with(
          user,
          title: "リアクションまとめ",
          body: include("3件のリアクションがありました"),
          url: "/posts"
        )
      end

      it "通知ボックスに通知を作成すること" do
        expect {
          described_class.send_summaries
        }.to change(Notification, :count).by(1)

        notification = Notification.last
        expect(notification.user).to eq(user)
        expect(notification.notification_type).to eq("reaction_summary")
        expect(notification.read_at).not_to be_nil
      end
    end

    context "通知設定が無効な場合" do
      before do
        user.update!(reaction_summary_enabled: false)
        create(:reaction, post: post, user: other_user, kind: "thumbs_up", created_at: Time.current)
      end

      it "通知を送信しないこと" do
        described_class.send_summaries
        expect(WebPushService).not_to have_received(:send_notification)
      end
    end

    context "リアクションがない場合" do
      it "通知を送信しないこと" do
        described_class.send_summaries
        expect(WebPushService).not_to have_received(:send_notification)
      end
    end

    context "過去のリアクションのみの場合" do
      before do
        create(:reaction, post: post, user: other_user, kind: "thumbs_up", created_at: 1.day.ago)
      end

      it "通知を送信しないこと" do
        described_class.send_summaries
        expect(WebPushService).not_to have_received(:send_notification)
      end
    end
  end
end
</file>

<file path="spec/services/walk_reminder_service_spec.rb">
require "rails_helper"

RSpec.describe WalkReminderService, type: :service do
  describe ".send_reminders" do
    let(:reminder_time) { Time.zone.parse("2025-01-01 10:00:00") }

    before do
      allow(WebPushService).to receive(:send_notification)
      travel_to reminder_time
    end

    context "設定時刻になり、まだ散歩していない場合" do
      let!(:user) { create(:user, walk_reminder_enabled: true, walk_reminder_time: reminder_time) }

      it "リマインダーを送信すること" do
        described_class.send_reminders

        expect(WebPushService).to have_received(:send_notification).with(
          user,
          title: "散歩の時間です！",
          body: anything,
          url: "/walks/new"
        )
      end
    end

    context "設定時刻だが、既に散歩済みの場合" do
      let!(:user) { create(:user, walk_reminder_enabled: true, walk_reminder_time: reminder_time) }

      before do
        create(:walk, user: user, walked_on: Date.current)
      end

      it "リマインダーを送信しないこと" do
        described_class.send_reminders
        expect(WebPushService).not_to have_received(:send_notification)
      end
    end

    context "設定時刻ではない場合" do
      let!(:user) { create(:user, walk_reminder_enabled: true, walk_reminder_time: reminder_time) }

      it "リマインダーを送信しないこと" do
        # 1時間ずらす
        travel_to(reminder_time + 1.hour) do
          described_class.send_reminders
        end

        expect(WebPushService).not_to have_received(:send_notification)
      end
    end

    context "リマインダー設定が無効な場合" do
      let!(:user) { create(:user, walk_reminder_enabled: false, walk_reminder_time: reminder_time) }

      it "リマインダーを送信しないこと" do
        described_class.send_reminders
        expect(WebPushService).not_to have_received(:send_notification)
      end
    end
  end
end
</file>

<file path="spec/services/weather_service_spec.rb">
require "rails_helper"

RSpec.describe WeatherService, type: :service do
  describe ".get_forecast" do
    context "APIキーが設定されていない場合" do
      before do
        allow(ENV).to receive(:[]).with("OPENWEATHER_API_KEY").and_return(nil)
      end

      it "ダミーデータを返すこと" do
        # ダミーデータを返すことを検証
        result = described_class.get_forecast

        expect(result).to have_key(:today)
        expect(result).to have_key(:tomorrow)
        expect(result[:today][:temp]).to eq(22)
        expect(result[:today][:description]).to eq("晴れ")
        expect(result[:today][:icon]).to eq("sunny")
      end
    end

    context "APIキーが設定されている場合" do
      let(:api_key) { "test_api_key" }
      let(:mock_response_body) do
        {
          list: [
            {
              dt: Time.current.to_i,
              main: { temp: 25.5 },
              weather: [ { main: "Clear", description: "快晴" } ]
            },
            {
              dt: (Time.current + 1.day).to_i,
              main: { temp: 20.3 },
              weather: [ { main: "Clouds", description: "曇り" } ]
            }
          ]
        }.to_json
      end

      before do
        allow(ENV).to receive(:[]).with("OPENWEATHER_API_KEY").and_return(api_key)
      end

      it "APIから天気情報を取得して整形すること" do
        # Net::HTTPのモックを作成
        stub_request(:get, /api.openweathermap.org/)
          .to_return(status: 200, body: mock_response_body, headers: { "Content-Type" => "application/json" })

        result = described_class.get_forecast(lat: 35.6762, lon: 139.6503)

        # 取得した情報が正しく整形されているか検証
        expect(result).to have_key(:today)
        expect(result).to have_key(:tomorrow)
        expect(result[:today][:temp]).to eq(26) # 25.5を四捨五入
        expect(result[:today][:icon]).to eq("sunny")
      end

      it "API呼び出しに失敗した場合はダミーデータを返すこと" do
        # APIリクエストが失敗した場合をシミュレート
        stub_request(:get, /api.openweathermap.org/)
          .to_return(status: 500, body: "", headers: {})

        result = described_class.get_forecast

        # ダミーデータが返ることを検証
        expect(result[:today][:temp]).to eq(22)
        expect(result[:today][:description]).to eq("晴れ")
      end

      it "例外が発生した場合はダミーデータを返すこと" do
        # Net::HTTPで例外が発生する場合をシミュレート
        allow(Net::HTTP).to receive(:get_response).and_raise(StandardError.new("Network error"))

        result = described_class.get_forecast

        # ダミーデータが返ることを検証
        expect(result[:today][:temp]).to eq(22)
        expect(result[:today][:description]).to eq("晴れ")
      end
    end
  end

  describe ".weather_icon" do
    it "Clearの場合はsunnyアイコンを返すこと" do
      expect(described_class.weather_icon("Clear")).to eq("sunny")
    end

    it "Cloudsの場合はcloudアイコンを返すこと" do
      expect(described_class.weather_icon("Clouds")).to eq("cloud")
    end

    it "Rainの場合はrainyアイコンを返すこと" do
      expect(described_class.weather_icon("Rain")).to eq("rainy")
    end

    it "Drizzleの場合はrainyアイコンを返すこと" do
      expect(described_class.weather_icon("Drizzle")).to eq("rainy")
    end

    it "Thunderstormの場合はthunderstormアイコンを返すこと" do
      expect(described_class.weather_icon("Thunderstorm")).to eq("thunderstorm")
    end

    it "Snowの場合はac_unitアイコンを返すこと" do
      expect(described_class.weather_icon("Snow")).to eq("ac_unit")
    end

    it "Mistの場合はmistアイコンを返すこと" do
      expect(described_class.weather_icon("Mist")).to eq("mist")
    end

    it "未知の天気の場合はwb_cloudyアイコンを返すこと" do
      expect(described_class.weather_icon("Unknown")).to eq("wb_cloudy")
    end
  end

  describe ".dummy_data" do
    it "正しい構造のダミーデータを返すこと" do
      # ダミーデータの構造を検証
      data = described_class.dummy_data

      expect(data).to be_a(Hash)
      expect(data).to have_key(:today)
      expect(data).to have_key(:tomorrow)
      expect(data[:today]).to have_key(:temp)
      expect(data[:today]).to have_key(:description)
      expect(data[:today]).to have_key(:icon)
    end
  end
end
</file>

<file path="spec/services/web_push_service_spec.rb">
require "rails_helper"

RSpec.describe WebPushService, type: :service do
  describe ".send_notification" do
    let(:user) { create(:user) }
    let!(:subscription) { create(:web_push_subscription, user: user) }
    let(:title) { "Test Title" }
    let(:body) { "Test Body" }

    before do
      allow(WebPush).to receive(:payload_send)
      allow(ENV).to receive(:[]).and_call_original
      allow(ENV).to receive(:[]).with("VAPID_PUBLIC_KEY").and_return("public_key")
      allow(ENV).to receive(:[]).with("VAPID_PRIVATE_KEY").and_return("private_key")
    end

    context "正常系" do
      it "WebPush.payload_sendを呼び出すこと" do
        described_class.send_notification(user, title: title, body: body)

        expect(WebPush).to have_received(:payload_send).with(
          hash_including(
            message: include(title, body),
            endpoint: subscription.endpoint,
            p256dh: subscription.p256dh,
            auth: subscription.auth_key
          )
        )
      end
    end

    context "購読情報がない場合" do
      let(:user_without_sub) { create(:user) }

      it "何も送信しないこと" do
        described_class.send_notification(user_without_sub, title: title, body: body)
        expect(WebPush).not_to have_received(:payload_send)
      end
    end

    context "購読が無効な場合（WebPush::InvalidSubscription例外）" do
      before do
        # WebPush::InvalidSubscriptionはinitializeでresponse.bodyを参照するため、モックが必要
        response = double("Response", body: "Invalid subscription")
        allow(WebPush).to receive(:payload_send).and_raise(WebPush::InvalidSubscription.new(response, "host"))
      end

      it "購読情報を削除すること" do
        expect(WebPushSubscription.count).to eq(1)
        described_class.send_notification(user, title: title, body: body)
        expect(WebPushSubscription.count).to eq(0)
      end
    end

    context "その他のエラーが発生した場合" do
      before do
        allow(WebPush).to receive(:payload_send).and_raise(StandardError.new("Unknown error"))
      end

      it "エラーログを出力し、処理を継続すること（例外を再スローしない）" do
        expect(Rails.logger).to receive(:error).with(/Failed to send push notification/)
        expect {
          described_class.send_notification(user, title: title, body: body)
        }.not_to raise_error
      end
    end
  end
end
</file>

<file path="spec/support/login_support.rb">
module LoginSupport
  def sign_in_as(user)
    visit new_user_session_path
    fill_in "メールアドレス", with: user.email
    fill_in "login-password-field", with: "password123"
    within "#new_user" do
      click_button "ログインする"
    end
    expect(page).to have_content "ログインしました"
  end
end

RSpec.configure do |config|
  config.include LoginSupport
end
</file>

<file path="spec/system/carousel_spec.rb">
require 'rails_helper'

RSpec.describe "Home Carousel", type: :system, js: true do
  let(:user) { User.create(email: "test@example.com", password: "password", name: "Test User", target_distance: 1000) }

  context "on desktop view" do
  before do
    login_as(user, scope: :user)
    visit root_path
    # PCサイズにリサイズ
    page.current_window.resize_to(1280, 800)
  end

    it "hides carousel indicators" do
      visit root_path
      expect(page).to have_no_selector('.carousel-indicators')
    end
  end
end
</file>

<file path="spec/system/rankings_spec.rb">
require 'rails_helper'

RSpec.describe "Rankings", type: :system, js: true do
  let(:user) { FactoryBot.create(:user, name: "自分", email: "me@example.com") }
  let!(:other_user) { FactoryBot.create(:user, name: "ライバル", email: "rival@example.com") }

  describe "同率順位の表示" do
    let!(:rival2) { FactoryBot.create(:user, email: "rival2@example.com", name: "ライバル2") }

    before do
      # ユーザーとライバル1、ライバル2が全員同じ距離（10km）を歩いたとする
      # User.rankingの仕様上、同距離の場合はID順などで順位が決まるが、
      # ここでは全員が表示され、距離が正しいことを確認する
      create(:walk, user: user, walked_on: Date.current, distance: 10.0, duration: 60)
      create(:walk, user: other_user, walked_on: Date.current, distance: 10.0, duration: 60)
      create(:walk, user: rival2, walked_on: Date.current, distance: 10.0, duration: 60)

      # キャッシュクリア
      Rails.cache.clear

      login_as(user, scope: :user)
      visit rankings_path
    end

    it "全員が表示され、距離が正しいこと" do
      # 全員10kmなので、表示されていることを確認
      expect(page).to have_content "10.0km", count: 3
      expect(page).to have_content "自分"
      expect(page).to have_content "ライバル"
      expect(page).to have_content "ライバル2"
    end
  end
end
</file>

<file path="spec/spec_helper.rb">
# This file was generated by the `rails generate rspec:install` command. Conventionally, all
# specs live under a `spec` directory, which RSpec adds to the `$LOAD_PATH`.
# The generated `.rspec` file contains `--require spec_helper` which will cause
# this file to always be loaded, without a need to explicitly require it in any
# files.
#
# Given that it is always loaded, you are encouraged to keep this file as
# light-weight as possible. Requiring heavyweight dependencies from this file
# will add to the boot time of your test suite on EVERY test run, even for an
# individual file that may not need all of that loaded. Instead, consider making
# a separate helper file that requires the additional dependencies and performs
# the additional setup, and require it from the spec files that actually need
# it.
#
# See https://rubydoc.info/gems/rspec-core/RSpec/Core/Configuration
RSpec.configure do |config|
  # rspec-expectations config goes here. You can use an alternate
  # assertion/expectation library such as wrong or the stdlib/minitest
  # assertions if you prefer.
  config.expect_with :rspec do |expectations|
    # This option will default to `true` in RSpec 4. It makes the `description`
    # and `failure_message` of custom matchers include text for helper methods
    # defined using `chain`, e.g.:
    #     be_bigger_than(2).and_smaller_than(4).description
    #     # => "be bigger than 2 and smaller than 4"
    # ...rather than:
    #     # => "be bigger than 2"
    expectations.include_chain_clauses_in_custom_matcher_descriptions = true
  end

  # rspec-mocks config goes here. You can use an alternate test double
  # library (such as bogus or mocha) by changing the `mock_with` option here.
  config.mock_with :rspec do |mocks|
    # Prevents you from mocking or stubbing a method that does not exist on
    # a real object. This is generally recommended, and will default to
    # `true` in RSpec 4.
    mocks.verify_partial_doubles = true
  end

  # This option will default to `:apply_to_host_groups` in RSpec 4 (and will
  # have no way to turn it off -- the option exists only for backwards
  # compatibility in RSpec 3). It causes shared context metadata to be
  # inherited by the metadata hash of host groups and examples, rather than
  # triggering implicit auto-inclusion in groups with matching metadata.
  config.shared_context_metadata_behavior = :apply_to_host_groups

# The settings below are suggested to provide a good initial experience
# with RSpec, but feel free to customize to your heart's content.
=begin
  # This allows you to limit a spec run to individual examples or groups
  # you care about by tagging them with `:focus` metadata. When nothing
  # is tagged with `:focus`, all examples get run. RSpec also provides
  # aliases for `it`, `describe`, and `context` that include `:focus`
  # metadata: `fit`, `fdescribe` and `fcontext`, respectively.
  config.filter_run_when_matching :focus

  # Allows RSpec to persist some state between runs in order to support
  # the `--only-failures` and `--next-failure` CLI options. We recommend
  # you configure your source control system to ignore this file.
  config.example_status_persistence_file_path = "spec/examples.txt"

  # Limits the available syntax to the non-monkey patched syntax that is
  # recommended. For more details, see:
  # https://rspec.info/features/3-12/rspec-core/configuration/zero-monkey-patching-mode/
  config.disable_monkey_patching!

  # Many RSpec users commonly either run the entire suite or an individual
  # file, and it's useful to allow more verbose output when running an
  # individual spec file.
  if config.files_to_run.one?
    # Use the documentation formatter for detailed output,
    # unless a formatter has already been configured
    # (e.g. via a command-line flag).
    config.default_formatter = "doc"
  end

  # Print the 10 slowest examples and example groups at the
  # end of the spec run, to help surface which specs are running
  # particularly slow.
  config.profile_examples = 10

  # Run specs in random order to surface order dependencies. If you find an
  # order dependency and want to debug it, you can fix the order by providing
  # the seed, which is printed after each run.
  #     --seed 1234
  config.order = :random

  # Seed global randomization in this process using the `--seed` CLI option.
  # Setting this allows you to use `--seed` to deterministically reproduce
  # test failures related to randomization by passing the same `--seed` value
  # as the one that triggered the failure.
  Kernel.srand config.seed
=end
end
</file>

<file path="storage/.keep">

</file>

<file path="supabase/.gitignore">
# Supabase
.branches
.temp

# dotenvx
.env.keys
.env.local
.env.*.local
</file>

<file path="supabase/config.toml">
# For detailed configuration reference documentation, visit:
# https://supabase.com/docs/guides/local-development/cli/config
# A string used to distinguish different Supabase projects on the same host. Defaults to the
# working directory name when running `supabase init`.
project_id = "tekumemo"

[api]
enabled = true
# Port to use for the API URL.
port = 54321
# Schemas to expose in your API. Tables, views and stored procedures in this schema will get API
# endpoints. `public` and `graphql_public` schemas are included by default.
schemas = ["public", "graphql_public"]
# Extra schemas to add to the search_path of every request.
extra_search_path = ["public", "extensions"]
# The maximum number of rows returns from a view, table, or stored procedure. Limits payload size
# for accidental or malicious requests.
max_rows = 1000

[api.tls]
# Enable HTTPS endpoints locally using a self-signed certificate.
enabled = false
# Paths to self-signed certificate pair.
# cert_path = "../certs/my-cert.pem"
# key_path = "../certs/my-key.pem"

[db]
# Port to use for the local database URL.
port = 54322
# Port used by db diff command to initialize the shadow database.
shadow_port = 54320
# The database major version to use. This has to be the same as your remote database's. Run `SHOW
# server_version;` on the remote database to check.
major_version = 17

[db.pooler]
enabled = false
# Port to use for the local connection pooler.
port = 54329
# Specifies when a server connection can be reused by other clients.
# Configure one of the supported pooler modes: `transaction`, `session`.
pool_mode = "transaction"
# How many server connections to allow per user/database pair.
default_pool_size = 20
# Maximum number of client connections allowed.
max_client_conn = 100

# [db.vault]
# secret_key = "env(SECRET_VALUE)"

[db.migrations]
# If disabled, migrations will be skipped during a db push or reset.
enabled = true
# Specifies an ordered list of schema files that describe your database.
# Supports glob patterns relative to supabase directory: "./schemas/*.sql"
schema_paths = []

[db.seed]
# If enabled, seeds the database after migrations during a db reset.
enabled = true
# Specifies an ordered list of seed files to load during db reset.
# Supports glob patterns relative to supabase directory: "./seeds/*.sql"
sql_paths = ["./seed.sql"]

[db.network_restrictions]
# Enable management of network restrictions.
enabled = false
# List of IPv4 CIDR blocks allowed to connect to the database.
# Defaults to allow all IPv4 connections. Set empty array to block all IPs.
allowed_cidrs = ["0.0.0.0/0"]
# List of IPv6 CIDR blocks allowed to connect to the database.
# Defaults to allow all IPv6 connections. Set empty array to block all IPs.
allowed_cidrs_v6 = ["::/0"]

[realtime]
enabled = true
# Bind realtime via either IPv4 or IPv6. (default: IPv4)
# ip_version = "IPv6"
# The maximum length in bytes of HTTP request headers. (default: 4096)
# max_header_length = 4096

[studio]
enabled = true
# Port to use for Supabase Studio.
port = 54323
# External URL of the API server that frontend connects to.
api_url = "http://127.0.0.1"
# OpenAI API Key to use for Supabase AI in the Supabase Studio.
openai_api_key = "env(OPENAI_API_KEY)"

# Email testing server. Emails sent with the local dev setup are not actually sent - rather, they
# are monitored, and you can view the emails that would have been sent from the web interface.
[inbucket]
enabled = true
# Port to use for the email testing server web interface.
port = 54324
# Uncomment to expose additional ports for testing user applications that send emails.
# smtp_port = 54325
# pop3_port = 54326
# admin_email = "admin@email.com"
# sender_name = "Admin"

[storage]
enabled = true
# The maximum file size allowed (e.g. "5MB", "500KB").
file_size_limit = "50MiB"

# Image transformation API is available to Supabase Pro plan.
# [storage.image_transformation]
# enabled = true

# Uncomment to configure local storage buckets
# [storage.buckets.images]
# public = false
# file_size_limit = "50MiB"
# allowed_mime_types = ["image/png", "image/jpeg"]
# objects_path = "./images"

[auth]
enabled = true
# The base URL of your website. Used as an allow-list for redirects and for constructing URLs used
# in emails.
site_url = "http://127.0.0.1:3000"
# A list of *exact* URLs that auth providers are permitted to redirect to post authentication.
additional_redirect_urls = ["https://127.0.0.1:3000"]
# How long tokens are valid for, in seconds. Defaults to 3600 (1 hour), maximum 604,800 (1 week).
jwt_expiry = 3600
# Path to JWT signing key. DO NOT commit your signing keys file to git.
# signing_keys_path = "./signing_keys.json"
# If disabled, the refresh token will never expire.
enable_refresh_token_rotation = true
# Allows refresh tokens to be reused after expiry, up to the specified interval in seconds.
# Requires enable_refresh_token_rotation = true.
refresh_token_reuse_interval = 10
# Allow/disallow new user signups to your project.
enable_signup = true
# Allow/disallow anonymous sign-ins to your project.
enable_anonymous_sign_ins = false
# Allow/disallow testing manual linking of accounts
enable_manual_linking = false
# Passwords shorter than this value will be rejected as weak. Minimum 6, recommended 8 or more.
minimum_password_length = 6
# Passwords that do not meet the following requirements will be rejected as weak. Supported values
# are: `letters_digits`, `lower_upper_letters_digits`, `lower_upper_letters_digits_symbols`
password_requirements = ""

[auth.rate_limit]
# Number of emails that can be sent per hour. Requires auth.email.smtp to be enabled.
email_sent = 2
# Number of SMS messages that can be sent per hour. Requires auth.sms to be enabled.
sms_sent = 30
# Number of anonymous sign-ins that can be made per hour per IP address. Requires enable_anonymous_sign_ins = true.
anonymous_users = 30
# Number of sessions that can be refreshed in a 5 minute interval per IP address.
token_refresh = 150
# Number of sign up and sign-in requests that can be made in a 5 minute interval per IP address (excludes anonymous users).
sign_in_sign_ups = 30
# Number of OTP / Magic link verifications that can be made in a 5 minute interval per IP address.
token_verifications = 30
# Number of Web3 logins that can be made in a 5 minute interval per IP address.
web3 = 30

# Configure one of the supported captcha providers: `hcaptcha`, `turnstile`.
# [auth.captcha]
# enabled = true
# provider = "hcaptcha"
# secret = ""

[auth.email]
# Allow/disallow new user signups via email to your project.
enable_signup = true
# If enabled, a user will be required to confirm any email change on both the old, and new email
# addresses. If disabled, only the new email is required to confirm.
double_confirm_changes = true
# If enabled, users need to confirm their email address before signing in.
enable_confirmations = false
# If enabled, users will need to reauthenticate or have logged in recently to change their password.
secure_password_change = false
# Controls the minimum amount of time that must pass before sending another signup confirmation or password reset email.
max_frequency = "1s"
# Number of characters used in the email OTP.
otp_length = 6
# Number of seconds before the email OTP expires (defaults to 1 hour).
otp_expiry = 3600

# Use a production-ready SMTP server
# [auth.email.smtp]
# enabled = true
# host = "smtp.sendgrid.net"
# port = 587
# user = "apikey"
# pass = "env(SENDGRID_API_KEY)"
# admin_email = "admin@email.com"
# sender_name = "Admin"

# Uncomment to customize email template
# [auth.email.template.invite]
# subject = "You have been invited"
# content_path = "./supabase/templates/invite.html"

[auth.sms]
# Allow/disallow new user signups via SMS to your project.
enable_signup = false
# If enabled, users need to confirm their phone number before signing in.
enable_confirmations = false
# Template for sending OTP to users
template = "Your code is {{ .Code }}"
# Controls the minimum amount of time that must pass before sending another sms otp.
max_frequency = "5s"

# Use pre-defined map of phone number to OTP for testing.
# [auth.sms.test_otp]
# 4152127777 = "123456"

# Configure logged in session timeouts.
# [auth.sessions]
# Force log out after the specified duration.
# timebox = "24h"
# Force log out if the user has been inactive longer than the specified duration.
# inactivity_timeout = "8h"

# This hook runs before a new user is created and allows developers to reject the request based on the incoming user object.
# [auth.hook.before_user_created]
# enabled = true
# uri = "pg-functions://postgres/auth/before-user-created-hook"

# This hook runs before a token is issued and allows you to add additional claims based on the authentication method used.
# [auth.hook.custom_access_token]
# enabled = true
# uri = "pg-functions://<database>/<schema>/<hook_name>"

# Configure one of the supported SMS providers: `twilio`, `twilio_verify`, `messagebird`, `textlocal`, `vonage`.
[auth.sms.twilio]
enabled = false
account_sid = ""
message_service_sid = ""
# DO NOT commit your Twilio auth token to git. Use environment variable substitution instead:
auth_token = "env(SUPABASE_AUTH_SMS_TWILIO_AUTH_TOKEN)"

# Multi-factor-authentication is available to Supabase Pro plan.
[auth.mfa]
# Control how many MFA factors can be enrolled at once per user.
max_enrolled_factors = 10

# Control MFA via App Authenticator (TOTP)
[auth.mfa.totp]
enroll_enabled = false
verify_enabled = false

# Configure MFA via Phone Messaging
[auth.mfa.phone]
enroll_enabled = false
verify_enabled = false
otp_length = 6
template = "Your code is {{ .Code }}"
max_frequency = "5s"

# Configure MFA via WebAuthn
# [auth.mfa.web_authn]
# enroll_enabled = true
# verify_enabled = true

# Use an external OAuth provider. The full list of providers are: `apple`, `azure`, `bitbucket`,
# `discord`, `facebook`, `github`, `gitlab`, `google`, `keycloak`, `linkedin_oidc`, `notion`, `twitch`,
# `twitter`, `slack`, `spotify`, `workos`, `zoom`.
[auth.external.apple]
enabled = false
client_id = ""
# DO NOT commit your OAuth provider secret to git. Use environment variable substitution instead:
secret = "env(SUPABASE_AUTH_EXTERNAL_APPLE_SECRET)"
# Overrides the default auth redirectUrl.
redirect_uri = ""
# Overrides the default auth provider URL. Used to support self-hosted gitlab, single-tenant Azure,
# or any other third-party OIDC providers.
url = ""
# If enabled, the nonce check will be skipped. Required for local sign in with Google auth.
skip_nonce_check = false
# If enabled, it will allow the user to successfully authenticate when the provider does not return an email address.
email_optional = false

# Allow Solana wallet holders to sign in to your project via the Sign in with Solana (SIWS, EIP-4361) standard.
# You can configure "web3" rate limit in the [auth.rate_limit] section and set up [auth.captcha] if self-hosting.
[auth.web3.solana]
enabled = false

# Use Firebase Auth as a third-party provider alongside Supabase Auth.
[auth.third_party.firebase]
enabled = false
# project_id = "my-firebase-project"

# Use Auth0 as a third-party provider alongside Supabase Auth.
[auth.third_party.auth0]
enabled = false
# tenant = "my-auth0-tenant"
# tenant_region = "us"

# Use AWS Cognito (Amplify) as a third-party provider alongside Supabase Auth.
[auth.third_party.aws_cognito]
enabled = false
# user_pool_id = "my-user-pool-id"
# user_pool_region = "us-east-1"

# Use Clerk as a third-party provider alongside Supabase Auth.
[auth.third_party.clerk]
enabled = false
# Obtain from https://clerk.com/setup/supabase
# domain = "example.clerk.accounts.dev"

# OAuth server configuration
[auth.oauth_server]
# Enable OAuth server functionality
enabled = false
# Path for OAuth consent flow UI
authorization_url_path = "/oauth/consent"
# Allow dynamic client registration
allow_dynamic_registration = false

[edge_runtime]
enabled = true
# Supported request policies: `oneshot`, `per_worker`.
# `per_worker` (default) — enables hot reload during local development.
# `oneshot` — fallback mode if hot reload causes issues (e.g. in large repos or with symlinks).
policy = "per_worker"
# Port to attach the Chrome inspector for debugging edge functions.
inspector_port = 8083
# The Deno major version to use.
deno_version = 2

# [edge_runtime.secrets]
# secret_key = "env(SECRET_VALUE)"

[analytics]
enabled = true
port = 54327
# Configure one of the supported backends: `postgres`, `bigquery`.
backend = "postgres"

# Experimental features may be deprecated any time
[experimental]
# Configures Postgres storage engine to use OrioleDB (S3)
orioledb_version = ""
# Configures S3 bucket URL, eg. <bucket_name>.s3-<region>.amazonaws.com
s3_host = "env(S3_HOST)"
# Configures S3 bucket region, eg. us-east-1
s3_region = "env(S3_REGION)"
# Configures AWS_ACCESS_KEY_ID for S3 bucket
s3_access_key = "env(S3_ACCESS_KEY)"
# Configures AWS_SECRET_ACCESS_KEY for S3 bucket
s3_secret_key = "env(S3_SECRET_KEY)"
</file>

<file path=".dockerignore">
# See https://docs.docker.com/engine/reference/builder/#dockerignore-file for more about ignoring files.

# Ignore git directory.
/.git/
/.gitignore

# Ignore bundler config.
/.bundle

# Ignore all environment files (except templates).
/.env*
!/.env*.erb

# Ignore all default key files.
/config/master.key
/config/credentials/*.key

# Ignore all logfiles and tempfiles.
/log/*
/tmp/*
!/log/.keep
!/tmp/.keep

# Ignore pidfiles, but keep the directory.
/tmp/pids/*
!/tmp/pids/.keep

# Ignore storage (uploaded files in development and any SQLite databases).
/storage/*
!/storage/.keep
/tmp/storage/*
!/tmp/storage/.keep

# Ignore assets.
/node_modules/
/app/assets/builds/*
!/app/assets/builds/.keep
/public/assets

# Ignore CI service files.
/.github

# Ignore development files
/.devcontainer

# Ignore Docker-related files
/.dockerignore
/Dockerfile*
</file>

<file path=".env.example">
# OpenWeatherMap APIキー
# https://openweathermap.org/api から無料のAPIキーを取得できます
# APIキーが設定されていない場合は、ダミーデータが表示されます
OPENWEATHER_API_KEY=your_api_key_here

# Cloudinary設定（OGP画像の保存先）
# https://cloudinary.com/ で無料アカウントを作成して取得できます
# ダッシュボードの「API Keys」から以下の値をコピーしてください
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
</file>

<file path=".gitattributes">
# See https://git-scm.com/docs/gitattributes for more about git attribute files.

# Mark the database schema as having been generated.
db/schema.rb linguist-generated

# Mark any vendored files as having been vendored.
vendor/* linguist-vendored
config/credentials/*.yml.enc diff=rails_credentials
config/credentials.yml.enc diff=rails_credentials
</file>

<file path=".node-version">
20.18.0
</file>

<file path=".rspec">
--require spec_helper

--profile 10
</file>

<file path=".ruby-version">
ruby-3.2.2
</file>

<file path=".yarnrc.yml">
supportedArchitectures:
  os: ["linux", "darwin"]
  cpu: ["x64", "arm64"]
</file>

<file path="config.ru">
# This file is used by Rack-based servers to start the application.

require_relative "config/environment"

run Rails.application
Rails.application.load_server
</file>

<file path="LICENSE">
MIT License

Copyright (c) 2021 Supabase, Inc. and contributors

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="package.json">
{
  "name": "tekumemo",
  "private": "true",
  "dependencies": {
    "@hotwired/stimulus": "^3.2.1",
    "@hotwired/turbo-rails": "^7.3.0",
    "chart.js": "^4.5.1",
    "esbuild": "^0.17.19"
  },
  "devDependencies": {
    "@tailwindcss/forms": "^0.5.9",
    "@tailwindcss/typography": "^0.5.15",
    "tailwindcss": "^3.4.18"
  },
  "scripts": {
    "build": "esbuild app/javascript/*.* --bundle --format=esm --outdir=app/assets/builds --public-path=/assets",
    "build:css": "tailwindcss -i ./app/assets/stylesheets/application.css -o ./app/assets/builds/application.css --minify"
  }
}
</file>

<file path="parallel_output.txt">
4 processes for 28 specs, ~ 7 specs per process
....................................................................................../home/nukon999/workspace/tekumemo/vendor/bundle/ruby/3.2.0/gems/rspec-rails-8.0.2/lib/rspec/rails/matchers/have_http_status.rb:219: warning: Status code :unprocessable_entity is deprecated and will be removed in a future version of Rack. Please use :unprocessable_content instead.
........................................................../home/nukon999/workspace/tekumemo/vendor/bundle/ruby/3.2.0/gems/devise-4.9.4/lib/devise/failure_app.rb:80: warning: Status code :unprocessable_entity is deprecated and will be removed in a future version of Rack. Please use :unprocessable_content instead.
.../home/nukon999/workspace/tekumemo/vendor/bundle/ruby/3.2.0/gems/devise-4.9.4/lib/devise/failure_app.rb:80: warning: Status code :unprocessable_entity is deprecated and will be removed in a future version of Rack. Please use :unprocessable_content instead.
.......................

Top 10 slowest examples (5.24 seconds, 100.7% of total time):
  Home Carousel on desktop view hides carousel indicators
    1.22 seconds ./spec/system/carousel_spec.rb:14
  ユーザー認証・認可 ログイン 正しいメールアドレスとパスワードでログインできること
    0.78928 seconds ./spec/system/user_auth_spec.rb:7
  ユーザー認証・認可 ログイン 誤ったパスワードではログインできないこと
    0.6803 seconds ./spec/system/user_auth_spec.rb:19
  ユーザー認証・認可 ログイン 存在しないメールアドレスではログインできないこと
    0.66566 seconds ./spec/system/user_auth_spec.rb:31
  ユーザー認証・認可 パスワードリセット パスワードリセット画面が表示されること
    0.55546 seconds ./spec/system/user_auth_spec.rb:104
  ユーザー認証・認可 アクセス制御 ログインしていない場合 トップページにアクセスするとログイン画面にリダイレクトされること
    0.50969 seconds ./spec/system/user_auth_spec.rb:77
  ユーザー認証・認可 アクセス制御 ログインしている場合 新規登録画面にアクセスするとトップページにリダイレクトされること
    0.33125 seconds ./spec/system/user_auth_spec.rb:95
  ユーザー認証・認可 アクセス制御 ログインしている場合 ログイン画面にアクセスするとトップページにリダイレクトされること
    0.32252 seconds ./spec/system/user_auth_spec.rb:89
  Post バリデーション 異常系 本文(body)が200文字を超える場合は無効であること
    0.12611 seconds ./spec/models/post_spec.rb:23
  StatsService 時系列データ 日別距離データを正しく取得できる
    0.0424 seconds ./spec/services/stats_service_spec.rb:61

Top 7 slowest example groups:
  Home Carousel
    1.22 seconds average (1.22 seconds / 1 example) ./spec/system/carousel_spec.rb:3
  ユーザー認証・認可
    0.36611 seconds average (3.3 seconds / 9 examples) ./spec/system/user_auth_spec.rb:3
  StatsService
    0.02183 seconds average (0.28374 seconds / 13 examples) ./spec/services/stats_service_spec.rb:3
  Users::OmniauthCallbacks
    0.01918 seconds average (0.03837 seconds / 2 examples) ./spec/requests/users/omniauth_callbacks_spec.rb:3
  Post
    0.01788 seconds average (0.17881 seconds / 10 examples) ./spec/models/post_spec.rb:3
  Notification
    0.01566 seconds average (0.1409 seconds / 9 examples) ./spec/models/notification_spec.rb:3
  PostsHelper
    0.01191 seconds average (0.04764 seconds / 4 examples) ./spec/helpers/posts_helper_spec.rb:13

Finished in 5.21 seconds (files took 0.92461 seconds to load)
48 examples, 0 failures

...

Top 10 slowest examples (6.76 seconds, 94.4% of total time):
  Walks 散歩記録の削除 記録を削除できること
    1.48 seconds ./spec/system/walks_spec.rb:74
  Admin::Users 管理者権限の制御 一般ユーザーとしてログインしている場合 管理画面にアクセスできず、トップページにリダイレクトされる
    0.89161 seconds ./spec/system/admin_users_spec.rb:13
  Walks 散歩記録の編集 記録を編集できること
    0.78197 seconds ./spec/system/walks_spec.rb:46
  Walks 散歩記録の新規作成 散歩記録が保存され、一覧画面に表示されること
    0.76593 seconds ./spec/system/walks_spec.rb:12
  Walks ページネーション ページネーションが表示され、次ページに遷移できること
    0.75292 seconds ./spec/system/walks_spec.rb:111
  Walks DELETE /walks/:id 他人の記録の場合 削除できないこと
    0.49279 seconds ./spec/requests/walks_spec.rb:109
  Posts DELETE /posts/:id 他人の投稿の場合 投稿を削除できないこと
    0.48807 seconds ./spec/requests/posts_spec.rb:69
  Posts DELETE /posts/:id 他人の投稿の場合 ルートページなどにリダイレクトされる、またはエラーになること
    0.38071 seconds ./spec/requests/posts_spec.rb:75
  Walks GET /walks/:id/edit 他人の記録の場合 アクセスできないこと（リダイレクトまたはエラー）
    0.36692 seconds ./spec/requests/walks_spec.rb:67
  Walks PATCH /walks/:id 他人の記録の場合 更新できないこと
    0.3561 seconds ./spec/requests/walks_spec.rb:90

Top 8 slowest example groups:
  Walks
    0.94525 seconds average (3.78 seconds / 4 examples) ./spec/system/walks_spec.rb:3
  Admin::Users
    0.28003 seconds average (0.8401 seconds / 3 examples) ./spec/system/admin_users_spec.rb:3
  Posts
    0.14908 seconds average (1.19 seconds / 8 examples) ./spec/requests/posts_spec.rb:3
  Walks
    0.13217 seconds average (1.45 seconds / 11 examples) ./spec/requests/walks_spec.rb:3
  User
    0.03144 seconds average (0.40878 seconds / 13 examples) ./spec/models/user_spec.rb:3
  StatsComingSoons
    0.02419 seconds average (0.02419 seconds / 1 example) ./spec/requests/stats_coming_soon_spec.rb:3
  StaticPages
    0.01339 seconds average (0.01339 seconds / 1 example) ./spec/requests/static_pages_spec.rb:3
  Rankings
    0 seconds average (0 seconds / 1 example) ./spec/system/rankings_spec.rb:3

Finished in 7.16 seconds (files took 0.91372 seconds to load)
42 examples, 0 failures

.....

Top 10 slowest examples (8.08 seconds, 79.5% of total time):
  SNS機能 新規投稿 正常系 モーダルから投稿を作成できること
    1.78 seconds ./spec/system/sns_spec.rb:13
  Home ホーム画面の表示 位置情報と天気が表示されること
    0.81038 seconds ./spec/system/home_spec.rb:47
  SNS機能 投稿の削除 他人の投稿には削除ボタンが表示されないこと
    0.74336 seconds ./spec/system/sns_spec.rb:102
  SNS機能 リアクション機能 投稿に「いいね」できること
    0.74335 seconds ./spec/system/sns_spec.rb:59
  LoginStamps 月移動の動作 前月ボタンを押すと前月のカレンダーが表示されること
    0.74226 seconds ./spec/system/login_stamps_spec.rb:98
  SNS機能 新規投稿 異常系 入力不備がある場合、エラーメッセージが表示されること
    0.71253 seconds ./spec/system/sns_spec.rb:40
  LoginStamps スタンプの表示 散歩記録がある場合 その日にスタンプが表示されること
    0.69686 seconds ./spec/system/login_stamps_spec.rb:40
  LoginStamps 月移動の動作 次月ボタンを押すと次月のカレンダーが表示されること
    0.6922 seconds ./spec/system/login_stamps_spec.rb:107
  LoginStamps カレンダー画面の表示 現在の年月が表示されていること
    0.66148 seconds ./spec/system/login_stamps_spec.rb:20
  SNS機能 投稿の削除 自分の投稿は削除できること
    0.49254 seconds ./spec/system/sns_spec.rb:88

Top 7 slowest example groups:
  SNS機能
    0.89506 seconds average (4.48 seconds / 5 examples) ./spec/system/sns_spec.rb:3
  Home
    0.57041 seconds average (1.71 seconds / 3 examples) ./spec/system/home_spec.rb:3
  LoginStamps
    0.36945 seconds average (3.33 seconds / 9 examples) ./spec/system/login_stamps_spec.rb:3
  WalksPagination
    0.24084 seconds average (0.24084 seconds / 1 example) ./spec/requests/walks_pagination_spec.rb:3
  Reaction
    0.03625 seconds average (0.28997 seconds / 8 examples) ./spec/models/reaction_spec.rb:3
  GoogleFit
    0.01244 seconds average (0.08708 seconds / 7 examples) ./spec/requests/google_fit_spec.rb:3
  WebPushSubscription
    0.0058 seconds average (0.02898 seconds / 5 examples) ./spec/models/web_push_subscription_spec.rb:3

Finished in 10.16 seconds (files took 0.94017 seconds to load)
38 examples, 0 failures

F.....

Failures:

  1) ユーザー設定 設定画面の操作 Google連携を行い、その後解除できること
     Failure/Error: click_link "連携に進む"

     Ferrum::TimeoutError:
       Timed out waiting for response. It's possible that this happened because something took a very long time (for example a page load was slow). If so, setting the :timeout option to a higher value might help.

     [Screenshot Image]: /home/nukon999/workspace/tekumemo/tmp/capybara/failures_r_spec_example_groups_nested_nested_2_google-_714.png


     # ./spec/system/user_settings_spec.rb:161:in `block (3 levels) in <main>'

Top 10 slowest examples (12.8 seconds, 88.0% of total time):
  ユーザー設定 設定画面の操作 Google連携を行い、その後解除できること
    6.04 seconds ./spec/system/user_settings_spec.rb:147
  ユーザー設定 設定画面の操作 Google連携解除時にパスワードを間違えると解除できないこと
    1.02 seconds ./spec/system/user_settings_spec.rb:192
  ユーザー設定 新規登録とログイン 未連携のGoogleアカウントではログインできないこと
    0.94995 seconds ./spec/system/user_settings_spec.rb:57
  ユーザー設定 新規登録とログイン メールアドレスで新規登録し、ログインできること
    0.90483 seconds ./spec/system/user_settings_spec.rb:15
  ユーザー設定 設定画面の操作 確認用パスワードが一致しないと更新できないこと
    0.74473 seconds ./spec/system/user_settings_spec.rb:138
  ユーザー設定 設定画面の操作 現在のパスワードが間違っていると更新できないこと
    0.73472 seconds ./spec/system/user_settings_spec.rb:129
  ユーザー設定 新規登録とログイン 入力内容に不備がある場合 パスワード（確認用）が一致しないと登録できないこと
    0.6258 seconds ./spec/system/user_settings_spec.rb:43
  ユーザー設定 設定画面の操作 プロフィール更新（異常系） 目標距離に不正な値（0以下）を入力すると更新できないこと
    0.60339 seconds ./spec/system/user_settings_spec.rb:88
  ユーザー設定 設定画面の操作 プロフィール更新（異常系） 名前を空にすると更新できないこと
    0.59399 seconds ./spec/system/user_settings_spec.rb:82
  ユーザー設定 新規登録とログイン 入力内容に不備がある場合 必須項目が未入力だと登録できず、エラーメッセージが表示されること
    0.57521 seconds ./spec/system/user_settings_spec.rb:29

Top 6 slowest example groups:
  ユーザー設定
    0.97717 seconds average (13.68 seconds / 14 examples) ./spec/system/user_settings_spec.rb:3
  Rankings
    0.07144 seconds average (0.28578 seconds / 4 examples) ./spec/requests/rankings_spec.rb:3
  Announcement
    0.03354 seconds average (0.13416 seconds / 4 examples) ./spec/models/announcement_spec.rb:3
  Reactions
    0.02835 seconds average (0.1701 seconds / 6 examples) ./spec/requests/reactions_spec.rb:3
  Walk
    0.01948 seconds average (0.21426 seconds / 11 examples) ./spec/models/walk_spec.rb:3
  RankingsHelper
    0.00269 seconds average (0.04579 seconds / 17 examples) ./spec/helpers/rankings_helper_spec.rb:3

Finished in 14.53 seconds (files took 0.9142 seconds to load)
56 examples, 1 failure

Failed examples:

rspec ./spec/system/user_settings_spec.rb:147 # ユーザー設定 設定画面の操作 Google連携を行い、その後解除できること

Tests Failed

184 examples, 1 failure

Took 17 seconds
</file>

<file path="Procfile.dev">
web: bundle exec rails server -b 0.0.0.0 -p 3000
js: yarn build --watch
css: yarn build:css --watch
</file>

<file path="Rakefile">
# Add your own tasks in files placed in lib/tasks ending in .rake,
# for example lib/tasks/capistrano.rake, and they will automatically be available to Rake.

require_relative "config/application"

Rails.application.load_tasks
</file>

<file path="render.yaml">
services:
  - type: web
    name: tekumemo-web
    env: ruby
    buildCommand: "./bin/render-build.sh"
    startCommand: "bundle exec puma -C config/puma.rb"
    plan: free
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: tekumemo-db
          property: connectionString
      - key: RAILS_MASTER_KEY
        sync: false
      - key: WEB_CONCURRENCY
        value: 1

databases:
  - name: tekumemo-db
    databaseName: tekumemo_production
    user: tekumemo_user
    plan: free
</file>

<file path=".agent/walks/20260103_fit_import_bugs.md">
# Fit一括取込機能のバグ調査報告書

**調査日:** 2026年1月3日  
**調査者:** Antigravity  

---

## 概要

2つの問題が報告されています：

1. **問題1**: ゲストログイン以外の管理ユーザーでも「Fit一括取込」を押すとランダムなデたらめ数値に変更される
2. **問題2**: 連携APIで自動入力された数値とFitアプリの実際の数値が全然違う

---

## 問題1: 管理ユーザーでもランダム数値になるバグ

### 原因分析

**ファイル:** `app/services/google_fit_service.rb` (L26)

```ruby
def fetch_activities(start_date, end_date)
  return { data: fetch_dummy_activities(start_date, end_date) } if @user.admin? || @user.guest?
  # ...
end
```

**問題点:**
- `admin?` または `guest?` のユーザーは、**常にダミーデータ（ランダム生成）** が返される設計になっている
- これはデモ用途として意図されたものだが、実際の管理者がGoogle Fitと連携している場合でも、実データではなくダミーデータが使用されてしまう

**ダミーデータ生成ロジック (L136-163):**
```ruby
def fetch_dummy_activities(start_date, end_date)
  result = {}
  (start_date..end_date).each do |date|
    base_steps = date.saturday? || date.sunday? ? 8000 : 5000
    steps = base_steps + rand(-1000..3000)  # ← ランダム！
    # ...
  end
  result
end
```

### 影響範囲

| ユーザータイプ | 影響 |
|--------------|------|
| 管理者 (admin) | ❌ **実データが取得されない** - 常にダミーデータで上書きされる |
| ゲスト (guest) | ⚠️ 意図通り（デモ用ダミーデータ） |
| 一般ユーザー (general) | ✅ 問題なし - 実APIから取得 |

### これが起こる理由

1. 管理者がGoogle Fitと連携済み (`google_token_valid? = true`)
2. 「Fit一括取込」ボタンを押す
3. `WalksController#import_google_fit` が呼ばれる
4. `GoogleFitService#fetch_activities` が実行
5. **`@user.admin?` が `true` なので、L26でダミーデータが返される**
6. `Walk#merge_google_fit_data` でダミーデータがマージ
7. 既存データよりダミー値が大きい場合、**誤ったランダム値で上書きされる**

---

## 問題2: 連携APIとFitアプリの数値不一致

### 原因分析

**考えられる原因は複数あります：**

#### 原因A: アクティビティタイプのフィルタリング

**ファイル:** `app/services/google_fit_service.rb` (L5-9, L68)

```ruby
ACTIVITY_TYPE_BIKING = 1
ACTIVITY_TYPE_WALKING = 7
ACTIVITY_TYPE_RUNNING = 8
TARGET_ACTIVITY_TYPES = [ACTIVITY_TYPE_BIKING, ACTIVITY_TYPE_WALKING, ACTIVITY_TYPE_RUNNING].freeze

# L68
next unless TARGET_ACTIVITY_TYPES.include?(activity_type)
```

**問題点:**
- Google Fitアプリは**全てのアクティビティ**（階段昇降、エリプティカル、水泳等）を合算して表示
- このサービスは**徒歩(7)、ランニング(8)、サイクリング(1)のみ**を集計
- → Fitアプリより少ない数値になる可能性大

#### 原因B: サイクリングの換算処理

**ファイル:** `app/services/google_fit_service.rb` (L189-206)

```ruby
def apply_activity_conversion(activity_type, steps, distance, duration_min)
  if activity_type == ACTIVITY_TYPE_BIKING
    distance = distance / 4.0  # 距離は1/4に換算
    duration_min = (duration_min / 2.0).round  # 時間は1/2に換算
    steps = ((distance / 1000.0) * 1300).round  # 歩数を距離から逆算
  end
  [steps, distance, duration_min]
end
```

**問題点:**
- サイクリングデータを「早歩き相当」に換算している
- 距離が1/4、時間が1/2になる
- → サイクリングが多いユーザーは大幅に数値が減る

#### 原因C: バケット処理の問題

**ファイル:** `app/services/google_fit_service.rb` (L49-51)

```ruby
bucket_by_activity_segment: Google::Apis::FitnessV1::BucketByActivity.new(
  min_duration_millis: 0
)
```

**問題点:**
- アクティビティセグメントごとにバケット化している
- Google Fitアプリの「1日合計」とは集計方法が異なる可能性
- 特に複数のアクティビティが混在する日は差が大きくなりやすい

#### 原因D: データセットインデックスの固定

**ファイル:** `app/services/google_fit_service.rb` (L171-184)

```ruby
bucket.dataset.each_with_index do |dataset, index|
  dataset.point.each do |point|
    point.value.each do |value|
      case index
      when 0 # 歩数
        steps += value.int_val if value.int_val
      when 1 # 距離
        distance += value.fp_val if value.fp_val
      when 2 # カロリー
        calories += value.fp_val.to_i if value.fp_val
      end
    end
  end
end
```

**問題点:**
- データセットの順序が `aggregate_by` の順序と一致する前提
- Google Fit APIのレスポンス順序が保証されていない可能性
- データ型の不一致（intとfloatの判定）で取りこぼしの可能性

---

## 修正案

### 問題1の修正案（優先度: 高 🔴）

**方針:** 管理者が実際にGoogle連携している場合は実データを使用

#### 修正案A: フラグによる切り替え（推奨）

```ruby
# app/services/google_fit_service.rb

def initialize(user)
  @user = user
  @use_dummy_data = user.guest? || (user.admin? && !user.has_real_google_connection?)
  
  return if @use_dummy_data

  @client = Google::Apis::FitnessV1::FitnessService.new
  auth = Signet::OAuth2::Client.new(access_token: user.google_token)
  @client.authorization = auth
end

def fetch_activities(start_date, end_date)
  return { data: fetch_dummy_activities(start_date, end_date) } if @use_dummy_data
  # 以下、実API呼び出し...
end
```

**Userモデルに追加:**
```ruby
# app/models/user.rb

def has_real_google_connection?
  google_token.present? && google_refresh_token.present? && google_expires_at.present?
end
```

#### 修正案B: ゲストのみダミーデータ（シンプル）

```ruby
# app/services/google_fit_service.rb L26

# 変更前
return { data: fetch_dummy_activities(start_date, end_date) } if @user.admin? || @user.guest?

# 変更後
return { data: fetch_dummy_activities(start_date, end_date) } if @user.guest?
```

⚠️ **注意:** この場合、管理者もGoogle連携が必須になる

#### 修正案C: 環境変数による制御

```ruby
# app/services/google_fit_service.rb L26

return { data: fetch_dummy_activities(start_date, end_date) } if @user.guest?
return { data: fetch_dummy_activities(start_date, end_date) } if @user.admin? && ENV['ADMIN_USE_DUMMY_FIT_DATA'] == 'true'
```

### 問題2の修正案（優先度: 中 🟡）

#### 修正案A: アクティビティタイプの拡張

```ruby
# app/services/google_fit_service.rb

# 追加のアクティビティタイプ
ACTIVITY_TYPE_STILL = 3
ACTIVITY_TYPE_TILTING = 5
ACTIVITY_TYPE_IN_VEHICLE = 0
ACTIVITY_TYPE_UNKNOWN = 4

# より広範囲を対象に（ただし計算方法の調整が必要）
EXTENDED_ACTIVITY_TYPES = [
  ACTIVITY_TYPE_BIKING,
  ACTIVITY_TYPE_WALKING,
  ACTIVITY_TYPE_RUNNING,
  # 必要に応じて追加
].freeze
```

#### 修正案B: バケット戦略の変更（日次集計）

```ruby
# アクティビティセグメントではなく、日ごとにバケット化
bucket_by_time: Google::Apis::FitnessV1::BucketByTime.new(
  duration_millis: 86400000  # 24時間
)
```

これによりGoogle Fitアプリと同じ「1日合計」に近づく可能性

#### 修正案C: データ型名での判定（堅牢性向上）

```ruby
def extract_data_from_bucket(bucket)
  steps = 0
  distance = 0.0
  calories = 0

  bucket.dataset.each do |dataset|
    # インデックスではなく、データタイプ名で判定
    data_type_name = dataset.data_source_id&.split(':')&.last
    
    dataset.point.each do |point|
      point.value.each do |value|
        case data_type_name
        when /step_count/
          steps += value.int_val.to_i
        when /distance/
          distance += value.fp_val.to_f
        when /calories/
          calories += value.fp_val.to_i
        end
      end
    end
  end

  [steps, distance, calories]
end
```

#### 修正案D: ログ強化とデバッグ情報

```ruby
# app/services/google_fit_service.rb

def fetch_activities(start_date, end_date)
  # ...
  
  Rails.logger.info "GoogleFit API Request: #{start_date} to #{end_date}"
  
  response.bucket.each do |bucket|
    activity_type = bucket.activity
    Rails.logger.debug "Bucket: activity=#{activity_type}, start=#{bucket.start_time_millis}"
    
    # スキップするアクティビティもログ
    unless TARGET_ACTIVITY_TYPES.include?(activity_type)
      Rails.logger.debug "Skipping activity type: #{activity_type}"
      next
    end
    # ...
  end
  
  Rails.logger.info "GoogleFit Result: #{result.transform_values { |v| v.except(:start_time) }}"
  # ...
end
```

---

## 一般ユーザーへの影響評価

### 問題1について

| 観点 | 影響 |
|-----|------|
| 一般ユーザーのデータ | ✅ **影響なし** - `admin?` も `guest?` も `false` なのでダミーデータは使われない |
| データ整合性 | ✅ 問題なし |

### 問題2について

| 観点 | 影響 |
|-----|------|
| 一般ユーザーのデータ | ⚠️ **影響あり** - 全ユーザーに同じ集計ロジックが適用される |
| 数値の乖離 | ⚠️ サイクリング利用者、複数アクティビティ利用者で乖離が大きい |
| ユーザー体験 | ⚠️ 「Fitアプリと違う」という混乱を招く可能性 |

---

## 推奨対応順序

1. **即座に対応（問題1）**: 修正案Bまたは修正案Aを適用
   - 管理者のデータが破損するリスクを排除
   
2. **調査継続（問題2）**: ログ強化を実装し、実際のズレのパターンを確認
   - まずは修正案Dでデータ収集
   
3. **改善（問題2）**: データ分析後に適切な対策を選定
   - ユーザーへの説明文言の追加も検討

---

## テスト対象

修正後に以下のテストを実行すべき：

```bash
bin/rails test test/services/google_fit_service_test.rb
bundle exec rspec spec/services/google_fit_service_spec.rb
bundle exec rspec spec/system/guest_google_fit_spec.rb
bundle exec rspec spec/requests/google_fit_spec.rb
```
</file>

<file path=".agent/walks/20260103_fit_import_fix_implemented.md">
# Fit一括取込バグ修正完了報告書

**修正日:** 2026年1月3日  
**修正内容:** Google Fit APIデータ取得ロジックの再設計

---

## 修正した問題

### 問題1: 管理ユーザーでもランダム数値に変更される ✅ 修正完了

**原因:**
- `@user.admin?` の判定により、管理者は常にダミーデータを使用していた

**修正内容:**
```ruby
# 修正前
return if user.admin? || user.guest?
return { data: fetch_dummy_activities(...) } if @user.admin? || @user.guest?

# 修正後
return if user.guest?
return { data: fetch_dummy_activities(...) } if @user.guest?
```

---

### 問題2: 連携APIとFitアプリの数値不一致 ✅ 修正完了

**原因:**
- アクティビティセグメントバケット方式で取得すると、短い歩行が検出されない
- 例: 8725歩のうち1377歩（約16%）しか取得できていない

**修正内容:**
ハイブリッド方式を採用：

| データ | 取得方法 | 理由 |
|-------|---------|------|
| **歩数** | 日次バケット (`bucket_by_time`) | 全歩数を漏れなく取得 |
| **距離** | アクティビティセグメント (`bucket_by_activity_segment`) | 電車・車の移動を除外 |
| **カロリー** | アクティビティセグメント | 電車・車の移動を除外 |
| **時間** | 歩数÷100 + サイクリング時間÷2 | 厚労省データに基づく推定 |

---

## 修正後のロジック

### 1. 歩数取得（新規実装）

```ruby
def fetch_daily_steps(start_time_millis, end_time_millis)
  request = Google::Apis::FitnessV1::AggregateRequest.new(
    aggregate_by: [
      Google::Apis::FitnessV1::AggregateBy.new(
        data_type_name: "com.google.step_count.delta"
      )
    ],
    bucket_by_time: Google::Apis::FitnessV1::BucketByTime.new(
      duration_millis: 86400000  # 24時間
    )
  )
  # 日付ごとに全歩数を集計
end
```

### 2. 距離・カロリー取得（既存ロジックを流用）

```ruby
def fetch_activity_segment_data(start_time_millis, end_time_millis)
  # アクティビティセグメントでwalking/running/bikingのみ取得
  # サイクリングは距離1/4、時間1/2に換算
end
```

### 3. データ統合

```ruby
all_dates = (steps_by_date.keys + activity_data_by_date.keys).uniq

all_dates.each do |date|
  steps = steps_by_date[date] || 0
  activity = activity_data_by_date[date] || { distance_m: 0.0, calories: 0, ... }
  
  # 時間計算
  walk_duration = (steps / 100.0).round           # 歩行時間
  total_duration = walk_duration + cycling_time   # サイクリング時間を加算
end
```

---

## 科学的根拠

### 歩行時間の推定

| ソース | データ |
|-------|--------|
| 厚生労働省 | 1,000歩 ≒ 10分 → **100歩/分** |
| 成人男性歩幅 | 63〜78cm (平均70cm) |
| 歩行速度 | 4.0〜5.0 km/h |

**計算:** 70cm × 100歩/分 = 70m/分 = 4.2km/h ✅

### サイクリング換算

| 活動 | METs | 速度 |
|-----|------|------|
| 普通歩行 | 3.0 | 4.0 km/h |
| 通勤自転車 | 5.8 | 15.0 km/h |

**速度比:** 15km/h ÷ 4km/h ≈ 3.75倍 → **距離1/4換算** ✅  
**METs比:** 5.8 ÷ 3.0 ≈ 1.9倍 → **時間1/2換算（控えめ）** ✅

---

## 期待される効果

### Before（修正前）
```
Google Fit: 8725歩
てくメモ:   1377歩  ← 84%のデータ損失！
```

### After（修正後）
```
Google Fit: 8725歩
てくメモ:   8725歩  ← 100%取得！
```

---

## テスト対象

修正が正しく動作するか確認が必要：

```bash
# サービスのテスト
bundle exec rspec spec/services/google_fit_service_spec.rb

# システムテスト
bundle exec rspec spec/system/guest_google_fit_spec.rb

# リクエストテスト
bundle exec rspec spec/requests/google_fit_spec.rb
```

---

## 影響範囲

| ユーザータイプ | 影響 |
|--------------|------|
| 管理者 | ✅ 実データが正しく取得されるようになる |
| ゲスト | 変更なし（引き続きダミーデータ） |
| 一般ユーザー | ✅ 歩数が大幅に増加（正確な値になる） |

---

## 注意事項

1. **歩数と距離の不整合**
   - 歩数は全活動、距離はアクティビティセグメントのみ
   - 「家の中の歩行は歩数のみカウントされる」という正しい状態

2. **既存データへの影響**
   - 過去データは変更されない
   - 次回「Fit一括取込」実行時から新ロジックが適用される

3. **API呼び出し回数**
   - 2回のリクエストが必要（歩数+アクティビティセグメント）
   - Google Fit APIの制限内で問題なし
</file>

<file path=".agent/walks/IMPLEMENTATION_SUMMARY.md">
# Google Fit一括取込バグ修正 - 実装完了

## 修正ファイル

- `app/services/google_fit_service.rb`

## 主要な変更点

### 1. 問題1の修正: 管理者のダミーデータ使用を廃止

**変更箇所:**
- L13: `return if user.guest?` （`admin?` 判定を削除）
- L26: `if @user.guest?` （`admin?` 判定を削除）

### 2. 問題2の修正: ハイブリッドデータ取得方式の導入

**新規メソッド:**
- `fetch_daily_steps()` - 日次バケットで全歩数を取得
- `fetch_activity_segment_data()` - アクティビティセグメントで距離・カロリー取得
- `extract_distance_and_calories_from_bucket()` - 距離とカロリーのみを抽出

**削除メソッド:**
- `extract_data_from_bucket()` - 歩数・距離・カロリーを一度に取得（不要）
- `apply_activity_conversion()` - 換算処理は新メソッド内に統合

### 3. 時間計算ロジックの変更

```ruby
# 歩行時間（歩数÷100歩/分）
walk_duration = (steps / 100.0).round

# サイクリング時間（1/2換算後）を加算
total_duration = walk_duration + activity[:cycling_duration_min]
```

## テスト実行

Dockerコンテナが起動していないため、手動で以下を実行してください：

```bash
# Dockerコンテナを起動
docker compose up -d

# テスト実行
docker compose exec app bundle exec rspec spec/services/google_fit_service_spec.rb
docker compose exec app bundle exec rspec spec/system/guest_google_fit_spec.rb
docker compose exec app bundle exec rspec spec/requests/google_fit_spec.rb

# または全テスト
bin/test_all.sh
```

## 期待される動作

1. **管理ユーザー**: 実際のGoogle Fitデータが取得される
2. **一般ユーザー**: 歩数が正確に（8725歩など）取得される
3. **ゲストユーザー**: 引き続きダミーデータを使用

## 次のステップ

- [ ] Dockerコンテナを起動
- [ ] テストを実行して動作確認
- [ ] 実際のGoogle Fitデータで検証
- [ ] コミット & プッシュ
</file>

<file path=".docs/RESPONSIVE_DESIGN.md">
# Responsive Design System

## 📱 基本方針

このプロジェクトは**モバイルファースト**のレスポンシブデザインを採用しています。
ターゲットユーザーの大半がスマートフォンユーザーであることを前提に、シンプルで一貫性のある 2 段階設計を実現します。

---

## 🎯 ブレークポイント戦略

### **シンプル 2 段階設計**

複雑なブレークポイントを避け、**「モバイル」と「それ以外」**の 2 パターンに絞ることで、メンテナンス性と一貫性を確保します。

| デバイスカテゴリ      | 画面幅      | Tailwind 記法      | 用途                              |
| :-------------------- | :---------- | :----------------- | :-------------------------------- |
| **📱 スマートフォン** | 0px ~ 639px | プレフィックスなし | **デフォルト**（iPhone, Android） |
| **💻 タブレット/PC**  | 640px 以上  | `sm:`              | タブレット・デスクトップ          |

### **使用するブレークポイント**

- ✅ **`sm:` (640px~)**: 全面的に使用
- ❌ **`md:` (768px~)**: 使用禁止
- ❌ **`lg:` (1024px~)**: 使用禁止
- ❌ **`xl:` (1280px~)**: 使用禁止
- ❌ **`2xl:` (1536px~)**: 使用禁止

**理由:**

- シンプルな設計で保守性向上
- 一貫したユーザー体験
- コード量の削減
- デザインの統一性

---

## 📐 スケーリング比率

スマホから PC/タブレットへの拡大時は、**1.3 ～ 1.6 倍**の範囲で統一することで、自然で違和感のない拡大を実現します。

### **推奨スケール比率**

| 要素                    | スマホ               | PC/タブレット            | 比率         |
| :---------------------- | :------------------- | :----------------------- | :----------- |
| **小さいアイコン**      | `w-7 h-7` (28px)     | `sm:w-10 sm:w-10` (40px) | 1.43 倍      |
| **中アイコン**          | `w-8 h-8` (32px)     | `sm:w-9 sm:h-9` (36px)   | 1.13 倍      |
| **大アイコン**          | `w-12 h-12` (48px)   | `sm:w-14 sm:h-14` (56px) | 1.17 倍      |
| **padding (小)**        | `py-2 px-3` (8×12px) | `sm:py-4 sm:px-4` (16px) | 2 倍/1.33 倍 |
| **ナビゲーション高さ**  | `h-10` (40px)        | `sm:h-16` (64px)         | 1.6 倍       |
| **フォント (見出し)**   | `text-xl` (20px)     | `sm:text-3xl` (30px)     | 1.5 倍       |
| **フォント (本文)**     | `text-base` (16px)   | `sm:text-lg` (18px)      | 1.13 倍      |
| **フォント (アイコン)** | `text-lg` (18px)     | `sm:text-2xl` (24px)     | 1.33 倍      |

---

## 🧩 コンポーネント別ガイドライン

### **1. ヘッダー（Header）**

```erb
<!-- ✅ 正しい例：2段階レスポンシブ -->
<header class="fixed top-0 left-0 right-0 z-50 bg-white/60 dark:bg-slate-950/60 backdrop-blur-xl">
  <div class="grid grid-cols-3 items-center py-2 px-3 sm:py-4 sm:px-4 w-full max-w-2xl mx-auto">
    <!-- スマホ: py-2 px-3 (8×12px) -->
    <!-- PC: py-4 px-4 (16px) -->
  </div>
</header>
```

**調整項目:**

- `padding`: `py-2 px-3` → `sm:py-4 sm:px-4`
- `アイコンサイズ`: `h-7 w-7` → `sm:h-10 sm:w-10`
- `フォントサイズ`: `text-lg` → `sm:text-2xl`

---

### **2. ロゴ・ブランディング**

```erb
<!-- ✅ 正しい例：視認性重視で大きめに -->
<span class="text-xl sm:text-3xl font-bold bg-gradient-to-r from-sky-500 to-blue-600 bg-clip-text text-transparent">
  てくメモ
</span>
```

**調整項目:**

- `フォントサイズ`: `text-xl` (20px) → `sm:text-3xl` (30px)
- `比率`: 1.5 倍（視認性重視）

---

### **3. ボタン**

#### **アイコンのみボタン（FAB 等）**

```erb
<!-- ✅ 正しい例：タップ領域確保 -->
<button class="w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-gradient-to-r from-orange-400 to-pink-500">
  <span class="material-symbols-outlined text-2xl sm:text-3xl">add</span>
</button>
```

**最小サイズ:**

- スマホ: `w-12 h-12` (48px) - タップ領域の最小推奨サイズ
- PC: `sm:w-14 sm:h-14` (56px)

#### **テキスト付きボタン**

```erb
<!-- ✅ 正しい例：パディング調整 -->
<button class="px-4 py-2 sm:px-6 sm:py-3 rounded-full bg-blue-500 text-sm sm:text-base">
  新規作成
</button>
```

**調整項目:**

- `padding`: `px-4 py-2` → `sm:px-6 sm:py-3`
- `フォント`: `text-sm` → `sm:text-base`

---

### **4. カード**

```erb
<!-- ✅ 正しい例：padding と角丸を調整 -->
<div class="p-4 sm:p-6 rounded-[2.5rem] sm:rounded-[3rem] bg-white dark:bg-slate-900/40">
  <!-- 内容 -->
</div>
```

**調整項目:**

- `padding`: `p-4` (16px) → `sm:p-6` (24px)
- `角丸`: `rounded-[2.5rem]` (40px) → `sm:rounded-[3rem]` (48px)

---

### **5. ナビゲーション（ボトムナビ）**

```erb
<!-- ✅ 正しい例：高さとアイコンサイズを調整 -->
<nav class="fixed bottom-0 left-0 right-0 bg-white/60 dark:bg-slate-950/60 backdrop-blur-xl">
  <div class="flex justify-around items-center h-10 sm:h-16 max-w-2xl mx-auto">
    <a href="#" class="flex items-center justify-center w-full">
      <span class="material-symbols-outlined text-lg sm:text-2xl">home</span>
    </a>
  </div>
</nav>
```

**調整項目:**

- `ナビ高さ`: `h-10` (40px) → `sm:h-16` (64px)
- `アイコン`: `text-lg` (18px) → `sm:text-2xl` (24px)

**重要:** ナビの高さが変わる場合、FAB ボタンの位置も調整すること。

---

### **6. モーダル**

```erb
<!-- ✅ 正しい例：幅とパディングを調整 -->
<div class="w-full sm:max-w-md mx-4 sm:mx-auto p-6 sm:p-8 rounded-[2.5rem] sm:rounded-[3.75rem]">
  <!-- モーダル内容 -->
</div>
```

**調整項目:**

- `幅`: スマホは `w-full`、PC は `sm:max-w-md`（最大幅制限）
- `padding`: `p-6` → `sm:p-8`
- `角丸`: `rounded-[2.5rem]` → `sm:rounded-[3.75rem]`

---

### **7. テキスト表示の切り替え**

```erb
<!-- ✅ 正しい例：スマホでは改行、PCではインライン -->
<span class="block sm:inline">お知らせメッセージ</span>

<!-- ✅ 正しい例：スマホでは非表示、PCでは表示 -->
<span class="hidden sm:inline">追加情報</span>

<!-- ✅ 正しい例：スマホでは表示、PCでは非表示 -->
<span class="sm:hidden">省略版</span>
```

---

### **8. 間隔・マージン**

```erb
<!-- ✅ 正しい例：余白を段階的に拡大 -->
<div class="space-y-3 sm:space-y-4">
  <!-- カード一覧 -->
</div>

<div class="mb-4 sm:mb-6">
  <!-- セクション -->
</div>
```

**推奨比率:**

- 小: `space-y-2` → `sm:space-y-3`
- 中: `space-y-3` → `sm:space-y-4`
- 大: `space-y-4` → `sm:space-y-6`

---

## 🚫 アンチパターン（禁止事項）

### **❌ NG 例 1：3 段階以上のブレークポイント使用**

```erb
<!-- ❌ 悪い例：複雑すぎる -->
<div class="text-sm md:text-base lg:text-lg xl:text-xl">
  てくメモ
</div>

<!-- ✅ 良い例：シンプルな2段階 -->
<div class="text-sm sm:text-base">
  てくメモ
</div>
```

### **❌ NG 例 2：統一感のないスケーリング**

```erb
<!-- ❌ 悪い例：バラバラな比率 -->
<div class="w-6 sm:w-16">  <!-- 2.67倍 -->
  <span class="text-xs sm:text-3xl">  <!-- 2.5倍 -->
    アイコン
  </span>
</div>

<!-- ✅ 良い例：統一された比率（1.43倍） -->
<div class="w-7 sm:w-10">
  <span class="text-lg sm:text-2xl">
    アイコン
  </span>
</div>
```

### **❌ NG 例 3：デスクトップファースト**

```erb
<!-- ❌ 悪い例：PCがベース -->
<div class="w-full lg:w-1/2">
  <!-- 内容 -->
</div>

<!-- ✅ 良い例：モバイルがベース -->
<div class="w-full sm:w-1/2">
  <!-- 内容 -->
</div>
```

### **❌ NG 例 4：タップ領域の不足**

```erb
<!-- ❌ 悪い例：スマホでタップしにくい -->
<button class="w-6 h-6 sm:w-10 sm:h-10">
  <!-- 24px × 24px は小さすぎる -->
</button>

<!-- ✅ 良い例：最低48px確保 -->
<button class="w-12 h-12 sm:w-14 sm:h-14">
  <!-- スマホでもタップしやすい -->
</button>
```

**推奨最小サイズ:**

- ボタン・タップ可能要素: `w-12 h-12` (48px) 以上

---

## 📏 レイアウトガイドライン

### **1. コンテンツ最大幅**

すべてのページで統一された最大幅を使用すること。

```erb
<!-- ✅ 推奨：max-w-2xl (672px) -->
<div class="max-w-2xl mx-auto px-4 sm:px-6">
  <!-- メインコンテンツ -->
</div>
```

**理由:**

- タブレット・PC で横幅が広がりすぎるのを防ぐ
- 可読性の維持
- モバイルアプリライクな見た目

### **2. ヘッダー・ナビゲーションの高さに応じた調整**

固定ヘッダー・ナビゲーションの高さが変わる場合、メインコンテンツの `padding-top` / `padding-bottom` も調整すること。

```erb
<!-- ヘッダー -->
<header class="... py-2 sm:py-4">...</header>

<!-- メインコンテンツ（ヘッダー分の余白） -->
<main class="pt-12 sm:pt-20">
  <!-- ヘッダーが py-2 → py-4 に変わるので、padding も調整 -->
</main>

<!-- FABボタン（ボトムナビ分の余白） -->
<div class="... bottom-[65px] sm:bottom-24">
  <!-- ボトムナビが h-10 → h-16 に変わるので、位置も調整 -->
</div>
```

---

## 🎨 デザインシステムとの統合

### **ライトモード・ダークモードとの組み合わせ**

レスポンシブクラスとダークモードクラスは**組み合わせて使用**すること。

```erb
<!-- ✅ 正しい例：レスポンシブ × ダークモード -->
<div class="
  bg-white dark:bg-slate-900/40
  p-4 sm:p-6
  rounded-[2.5rem] sm:rounded-[3rem]
  shadow-clay-card dark:shadow-neon-blue
">
  <!-- スマホ・ライト: bg-white, p-4, rounded-[2.5rem], shadow-clay-card -->
  <!-- スマホ・ダーク: bg-slate-900/40, p-4, rounded-[2.5rem], shadow-neon-blue -->
  <!-- PC・ライト: bg-white, p-6, rounded-[3rem], shadow-clay-card -->
  <!-- PC・ダーク: bg-slate-900/40, p-6, rounded-[3rem], shadow-neon-blue -->
</div>
```

**クラスの順序（推奨）:**

1. レイアウト（`flex`, `grid`, `relative`）
2. サイズ（`w-`, `h-`, `p-`, `m-`）とレスポンシブ
3. 色（ライトモード → ダークモード）
4. その他（`rounded-`, `shadow-`）

---

## 🔧 実装チェックリスト

新しいコンポーネントを作成する際は、以下を確認すること：

### **スマホ対応**

- [ ] タップ領域は最低 `w-12 h-12` (48px) 以上
- [ ] テキストは `text-sm` (14px) 以上
- [ ] 横スクロールが発生しないか確認
- [ ] padding が狭すぎないか（最低 `p-3` 推奨）

### **レスポンシブ対応**

- [ ] `sm:` プレフィックスのみ使用（`md:`, `lg:` は使わない）
- [ ] スケール比率が 1.3 ～ 1.6 倍の範囲内
- [ ] ヘッダー・ナビの高さ変更に応じて、他の要素の位置も調整

### **デザインシステム統合**

- [ ] ライトモード（Crystal Claymorphism）のスタイルを適用
- [ ] ダークモード（Holographic Neon Noir）のスタイルを適用
- [ ] ダークモードクラスが `dark:` プレフィックスで正しく分離されている

### **アクセシビリティ**

- [ ] コントラスト比が十分（WCAG 2.1 Level A）
- [ ] フォーカス表示が明確（`focus:ring-2` など）
- [ ] `aria-label` が適切に設定されている

---

## 📱 対象デバイス一覧

### **スマートフォン（640px 未満）**

- iPhone SE (375px)
- iPhone 12/13/14 (390px)
- iPhone 14 Pro (393px)
- iPhone 14 Pro Max (430px)
- Samsung Galaxy S21 (360px)
- Google Pixel 7 (412px)

### **タブレット/PC（640px 以上）**

- iPad Mini（縦持ち: 768px、横持ち: 1024px）
- iPad Air（縦持ち: 820px、横持ち: 1180px）
- デスクトップ PC（1280px ～）

---

## 🎯 設計思想

この 2 段階レスポンシブ設計は、以下の原則に基づいています：

1. **シンプルさ**: 複雑なブレークポイントを避け、保守性を向上
2. **一貫性**: すべてのコンポーネントで統一されたスケーリング
3. **モバイルファースト**: ターゲットユーザーの大半がスマホユーザー
4. **アプリライク**: モバイルアプリのような UX を提供

---

## 🚀 プロンプト例

AI にコンポーネントを作成してもらう際は、以下のプロンプトを使用してください：

> 「このコンポーネントは、モバイルファースト・2 段階レスポンシブ設計で実装してください。
> 具体的には：
>
> 1. **ブレークポイント**: `sm:` (640px) のみ使用。`md:`, `lg:` は使用禁止。
> 2. **スケール比率**: スマホから PC へは 1.3 ～ 1.6 倍 の範囲で拡大。
> 3. **最小サイズ**: タップ可能要素は `w-12 h-12` (48px) 以上。
> 4. **デザインシステム**: ライトモード（Crystal Claymorphism）とダークモード（Holographic Neon Noir）の両方に対応。
> 5. **クラス順序**: レイアウト → サイズ（レスポンシブ含む） → 色（ライト・ダーク） → その他。
>
> `.docs/RESPONSIVE_DESIGN.md` の指針に厳密に従ってください。」

---

**Last Updated:** 2025-12-30
**Version:** 1.0
</file>

<file path=".gemini/handover_20251220_2019.md">
# 引継ぎ資料 (2025-12-20 20:19)

## 🚨 重要：基本ルール

**このプロジェクトでは `.cursorrules` ファイルに定義されたルールを厳格に遵守すること。**

- 思考プロセスは**必ず日本語**で行う
- 会話も**すべて日本語**で行う
- コード内のコメントも日本語で丁寧に記述
- 初学者にも理解できるように、理由と背景を説明する
- Rails 標準の書き方（The Rails Way）を優先

---

## 📍 現在の状況

### ブランチ

- **現在**: `15-comprehensive-improvements`
- **状態**: origin より 1 commit 先行（未プッシュのコミットあり）

### 作業状態

- **全変更をロールバック済み**
- 直近のコミット時点の状態に戻っている
- 未コミットの変更なし

---

## 🎯 今回のセッションの目的

**「コミュニティページ（/posts）のデザインを /stats ページと統一」**

具体的には、投稿カードに Crystal Claymorphism デザインを適用し、以下を実現する：

1. `crystal-card` クラスと色バリエーション（`crystal-blue`, `crystal-orange` など）の適用
2. カード内部に「Breathing Glow」（呼吸する光）を追加
3. 天気・気分に応じた動的な色付け
4. ライトモードとダークモードの両方で美しく表示

---

## ⚠️ 発生した問題と学び

### 1. **ActiveRecord のメソッド誤用**

- **問題**: `post.user.avatar` → 存在しないメソッド
- **正解**: `post.user.avatar_url` + `post.user.use_google_avatar` で条件分岐
- **原因**: 元のファイルを確認せずに、他のページ（例: ダッシュボード）の実装を参考にしてしまった

### 2. **存在しない要素を追加**

- **問題**: レベルバッジ（`post.user.level`）を誤って追加
- **原因**: 元のファイルには存在しない要素を、デザイン適用時に勝手に追加してしまった
- **対策**: **必ず元のファイルを `git show HEAD:ファイル名` で確認してから編集する**

### 3. **存在しないパーシャルを呼び出し**

- **問題**: `<%= render "reactions/button", post: post %>` → 存在しない
- **原因**: 元のファイルにはこの呼び出しが存在しないのに追加してしまった

### 4. **DOM 構造の破壊**

- **問題**: `<% end %>` タグの削除により構文エラー
- **原因**: レベルバッジを削除する際に、誤ってリンクの閉じタグも削除した
- **対策**: 編集範囲を最小限にし、慎重に行う

### 5. **ダークモードとの非互換性**

- **問題**:
  - Breathing Glow（右下のオレンジ色の呼吸する光）がダークモードでも表示され、違和感
  - `dark:hidden` で非表示にしたら、カードの色が完全に消えた
- **原因**: Crystal Claymorphism のライトモード専用スタイルをダークモードに適用
- **対策**: **最初からダークモードとの互換性を考慮し、段階的にテストする**

---

## 🔄 ロールバックした変更内容

以下のファイルを直近のコミットの状態に戻した：

1. `app/views/posts/_post.html.erb`
2. `app/views/posts/index.html.erb`
3. `app/views/posts/_form.html.erb`

---

## 📝 次のセッションでやるべきこと

### 目標

**コミュニティページのデザインを /stats と統一（再挑戦）**

### アプローチ

#### STEP 1: 元のファイルを完全に理解する

```bash
# 現在のファイル構造を確認
git show HEAD:app/views/posts/_post.html.erb
```

- どの要素が存在するか
- どのような条件分岐があるか
- どのようなパーシャルが呼ばれているか

#### STEP 2: /stats ページのデザインを分析

```bash
# /stats のデザイン実装を確認
cat app/views/stats/index.html.erb
cat app/assets/stylesheets/application.css | grep -A 50 "crystal-card"
```

- `crystal-card` とは何か
- 色バリエーションはどう定義されているか
- ライトモードとダークモードでどう切り替わるか

#### STEP 3: 段階的に適用

**3-1. カードコンテナのみ修正**

- `crystal-card` クラスを追加
- 色バリエーション（`crystal-blue` など）を動的に適用
- **ライトモードのみ**でテスト

**3-2. 内部要素を調整**

- 削除ボタン、アバター、本文エリアなどはそのまま
- **新しい要素は追加しない**

**3-3. ダークモードを確認**

- ダークモード専用のスタイルが正しく適用されているか
- Breathing Glow などのライトモード専用要素が邪魔していないか

**3-4. Breathing Glow を追加（オプション）**

- ライトモードのみで表示するように `dark:hidden` を追加
- ダークモードでカードが正しく表示されることを確認

#### STEP 4: コミット

```bash
git add .
git commit -m "design: コミュニティページ(/posts)のデザインを/statsと統一

- 投稿カードにcrystal-cardクラスを適用
- 天気・気分に基づいて色バリエーションを動的に適用
- ライトモードとダークモードの両方で正しく表示されることを確認"
git push origin 15-comprehensive-improvements
```

---

## 🔍 デバッグの際の重要なコマンド

### 元のファイルを確認

```bash
git show HEAD:app/views/posts/_post.html.erb
git diff HEAD app/views/posts/_post.html.erb
```

### 変更を破棄

```bash
git restore app/views/posts/_post.html.erb
```

### CSS を再ビルド

```bash
yarn build:css
```

---

## 📚 参考ファイル

### デザインシステム

- `.docs/DESIGN_SYSTEM_LIGHT.md` - Crystal Claymorphism の定義
- `app/assets/stylesheets/application.css` - `crystal-card` クラスの実装

### 参考実装

- `app/views/stats/index.html.erb` - /stats ページの実装例
- `app/views/posts/_post.html.erb` - 元の投稿カードの実装

### ヘルパーメソッド

- `app/helpers/posts_helper.rb` - `post_color_theme` メソッド（天気・気分に基づく配色）

---

## 💡 重要な教訓

1. **元のファイルを必ず確認する**

   - 編集前に `git show HEAD:ファイル名` で確認
   - 存在しない要素を追加しない

2. **段階的にテストする**

   - 一度にすべてを変更しない
   - ライトモード → ダークモード の順でテスト

3. **ダークモードとの互換性を最初から考慮**

   - ライトモード専用の要素は `dark:hidden` で非表示
   - ダークモード専用のスタイルは `dark:` プレフィックスで上書き

4. **最小限の変更に留める**

   - デザイン適用が目的なら、機能追加（レベルバッジなど）は行わない
   - 既存の要素を壊さない

5. **エラーが出たらすぐにロールバック**
   - 深みにハマる前に `git restore` で戻す
   - 新しいアプローチで再挑戦

---

## 🎨 Crystal Claymorphism のポイント

### ライトモード

- 柔らかい radial-gradient 背景
- ぷっくりとした box-shadow（外側 + 内側）
- 淡い境界線（`border-white/60`）
- 天気・気分に応じた色のバリエーション

### ダークモード

- `dark:bg-slate-900/40` で背景を上書き
- `dark:shadow-[...]` で影を再定義
- `dark:border-white/10` で境界線を暗く

### Breathing Glow

- カード右下の呼吸する光
- `animate-pulse-slow` でゆっくり点滅
- **ライトモードのみ** (`dark:hidden`)

---

## 次のセッション開始時の確認事項

1. ブランチが `15-comprehensive-improvements` であることを確認
2. 未コミットの変更がないことを確認（`git status`）
3. `.cursorrules` を読み、基本ルールを再確認
4. 今回の引継ぎ資料を読み、前回の失敗から学ぶ

---

**次のセッションでの成功を祈ります！🚀**
</file>

<file path=".gemini/sudoers_development_config.txt">
# ==========================================
# Rails開発環境用 sudo NOPASSWD設定
# 作成日: 2025-12-30
# 対象: 個人開発環境（WSL2 Ubuntu）
# Level 2: 開発ツール関連のみパスワードレス
# ==========================================

# --- Docker関連（最頻出）---
nukon999 ALL=(ALL) NOPASSWD: /usr/sbin/service docker start
nukon999 ALL=(ALL) NOPASSWD: /usr/sbin/service docker stop
nukon999 ALL=(ALL) NOPASSWD: /usr/sbin/service docker restart
nukon999 ALL=(ALL) NOPASSWD: /usr/sbin/service docker status
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/docker *
nukon999 ALL=(ALL) NOPASSWD: /usr/local/bin/docker-compose *

# --- ファイル権限関連（Rails開発で頻出）---
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/chown *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/chmod *

# --- パッケージ管理（gem, npm依存関係インストール時）---
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/apt update
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/apt upgrade
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/apt install *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/apt remove *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/apt autoremove
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/apt-get update
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/apt-get upgrade
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/apt-get install *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/apt-get remove *

# --- サービス管理（PostgreSQL, Redis等）---
nukon999 ALL=(ALL) NOPASSWD: /usr/sbin/service postgresql *
nukon999 ALL=(ALL) NOPASSWD: /usr/sbin/service redis-server *
nukon999 ALL=(ALL) NOPASSWD: /bin/systemctl start *
nukon999 ALL=(ALL) NOPASSWD: /bin/systemctl stop *
nukon999 ALL=(ALL) NOPASSWD: /bin/systemctl restart *
nukon999 ALL=(ALL) NOPASSWD: /bin/systemctl status *
nukon999 ALL=(ALL) NOPASSWD: /bin/systemctl enable *
nukon999 ALL=(ALL) NOPASSWD: /bin/systemctl disable *

# --- プロセス管理（ハングしたプロセス終了時）---
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/kill *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/killall *

# --- ネットワーク診断（開発時のデバッグ）---
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/netstat *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/ss *
nukon999 ALL=(ALL) NOPASSWD: /usr/sbin/lsof *

# --- ログ確認（本番ログ調査時）---
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/tail *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/less *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/cat /var/log/*

# --- 環境変数・設定ファイル編集（Rails環境設定）---
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/nano *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/vim *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/vi *

# --- Node.js / Yarn（フロントエンド開発）---
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/npm *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/yarn *

# --- Ruby / Bundler（gem依存関係）---
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/gem install *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/bundle *

# --- ファイルシステム（WSL2特有の権限問題対応）---
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/mount *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/umount *

# --- クリーンアップ（ディスク容量管理）---
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/du *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/df *
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/rm -rf /tmp/*
nukon999 ALL=(ALL) NOPASSWD: /usr/bin/rm -rf /var/tmp/*
</file>

<file path="app/controllers/admin/announcements_controller.rb">
class Admin::AnnouncementsController < Admin::BaseController
  before_action :set_announcement, only: %i[edit update destroy publish unpublish]

  # お知らせ一覧
  def index
    @announcements = Announcement.all

    # 検索（タイトル・本文）
    if params[:q].present?
      search_term = "%#{params[:q]}%"
      @announcements = @announcements.where("title ILIKE ? OR content ILIKE ?", search_term, search_term)
    end

    # フィルタ（種類）
    if params[:type].present?
      @announcements = @announcements.where(announcement_type: params[:type])
    end

    # フィルタ（公開状態）
    if params[:status].present?
      case params[:status]
      when "published"
        @announcements = @announcements.published
      when "draft"
        @announcements = @announcements.where(is_published: false)
      end
    end

    @announcements = @announcements.order(published_at: :desc, created_at: :desc).page(params[:page]).per(20)
  end

  # 新規作成フォーム
  def new
    @announcement = Announcement.new
  end

  # 作成処理
  def create
    @announcement = Announcement.new(announcement_params)

    if @announcement.save
      redirect_to admin_announcements_path, notice: "お知らせを作成しました"
    else
      render :new, status: :unprocessable_entity
    end
  end

  # 編集フォーム
  def edit
  end

  # 更新処理
  def update
    if @announcement.update(announcement_params)
      redirect_to admin_announcements_path, notice: "お知らせを更新しました"
    else
      render :edit, status: :unprocessable_entity
    end
  end

  # 削除処理
  def destroy
    @announcement.destroy
    redirect_to admin_announcements_path, notice: "お知らせを削除しました"
  end

  # 公開
  def publish
    # 公開日時が未設定の場合のみ現在時刻を設定
    published_at = @announcement.published_at || Time.current
    @announcement.update(is_published: true, published_at: published_at)
    redirect_to admin_announcements_path, notice: "お知らせを公開しました"
  end

  # 非公開
  def unpublish
    @announcement.update(is_published: false)
    redirect_to admin_announcements_path, notice: "お知らせを非公開にしました"
  end

  private



  def set_announcement
    @announcement = Announcement.find(params[:id])
  end

  def announcement_params
    params.require(:announcement).permit(:title, :content, :announcement_type, :published_at, :expires_at)
  end
end
</file>

<file path="app/controllers/users/omniauth_callbacks_controller.rb">
class Users::OmniauthCallbacksController < Devise::OmniauthCallbacksController
  # CSRF保護をスキップ（OmniAuthのコールバックのため）
  skip_before_action :verify_authenticity_token, only: [ :google_oauth2 ]

  # Google OAuth2のコールバック処理
  # Googleから認証が完了した後に呼ばれる
  def google_oauth2
    # OmniAuthから返された認証情報
    auth = request.env["omniauth.auth"]

    if user_signed_in?
      # ログイン中の場合：既存アカウントにGoogle情報を紐付け
      auth_email = auth.info.email

      # メールアドレスが一致しない場合 -> 確認画面へ
      if current_user.email != auth_email
        # 認証情報を一時的にセッションに保存（確認画面で使用）
        session[:google_auth_data] = {
          uid: auth.uid,
          token: auth.credentials.token,
          refresh_token: auth.credentials.refresh_token,
          expires_at: auth.credentials.expires_at,
          image: auth.info.image,
          email: auth_email
        }
        redirect_to confirm_email_change_users_path
        return
      end

      # メールアドレスが一致する場合 -> そのまま連携
      connect_google_account(auth)
    else
      # 未ログインの場合：Google連携済みのユーザーを探す
      @user = User.from_omniauth(auth)

      if @user
        # 連携済みユーザーが見つかった場合 -> ログイン
        @user.remember_me = true
        sign_in_and_redirect @user, event: :authentication
        set_flash_message(:notice, :success, kind: "Google") if is_navigational_format?
      else
        # 未連携の場合 -> ログイン画面に戻してエラー表示
        # セッションにデータは保存しない（新規登録には使わないため）
        redirect_to new_user_session_path, alert: "このGoogleアカウントは連携されていません。先にメールアドレスでログインし、設定画面から連携してください。"
      end
    end
  end

  # メールアドレス変更確認後の連携処理
  def update_email_and_connect
    auth_data = session[:google_auth_data]

    unless auth_data
      redirect_to edit_user_registration_path, alert: "セッションが切れました。もう一度連携操作を行ってください。"
      return
    end

    # メールアドレスを更新して連携
    if current_user.update(
      email: auth_data["email"],
      google_uid: auth_data["uid"],
      google_token: auth_data["token"],
      google_refresh_token: auth_data["refresh_token"],
      google_expires_at: Time.at(auth_data["expires_at"]),
      avatar_url: auth_data["image"]
    )
      # アバター画像をキャッシュ
      cache_avatar_image(current_user, auth_data["image"])

      session.delete(:google_auth_data) # セッション削除
      redirect_to edit_user_registration_path, notice: "メールアドレスを更新し、Googleアカウントと連携しました。"
    else
      redirect_to edit_user_registration_path, alert: "連携に失敗しました: #{current_user.errors.full_messages.join(', ')}"
    end
  end

  private

  # Googleアカウントとの連携処理（共通化）
  def connect_google_account(auth)
    if current_user.update(
      google_uid: auth.uid,
      google_token: auth.credentials.token,
      google_refresh_token: auth.credentials.refresh_token,
      google_expires_at: Time.at(auth.credentials.expires_at),
      avatar_url: auth.info.image
    )
      # アバター画像をキャッシュ（OGP生成高速化のため）
      cache_avatar_image(current_user, auth.info.image)

      set_flash_message(:notice, :success, kind: "Google") if is_navigational_format?
      redirect_to edit_user_registration_path, notice: "Googleアカウントと連携しました"
    else
      error_msg = "Googleアカウントの連携に失敗しました: #{current_user.errors.full_messages.join(', ')}"
      redirect_to edit_user_registration_path, alert: error_msg
    end
  end

  # アバター画像をActive Storageにキャッシュ
  def cache_avatar_image(user, avatar_url)
    return unless avatar_url.present?

    # 既存のキャッシュがあれば削除（更新のため）
    user.cached_avatar.purge if user.cached_avatar.attached?

    # Googleからダウンロードしてキャッシュ
    begin
      require "open-uri"
      downloaded_file = URI.open(avatar_url, read_timeout: 3, open_timeout: 3)
      user.cached_avatar.attach(
        io: downloaded_file,
        filename: "avatar_#{user.id}.jpg",
        content_type: "image/jpeg"
      )
      Rails.logger.info "Avatar cached for user #{user.id}"
    rescue => e
      Rails.logger.warn "Failed to cache avatar for user #{user.id}: #{e.message}"
      # キャッシュ失敗は致命的ではないので、エラーを無視
    end
  end

  # OAuth認証失敗時の処理
  def failure
    Rails.logger.error "=== Google Auth Failure Debug Info ==="
    Rails.logger.error "Session ID: #{session.id.inspect}"
    Rails.logger.error "CSRF Token in params: #{request.params['authenticity_token']}"
    Rails.logger.error "Cookie Header: #{request.headers['Cookie']}"
    Rails.logger.error "X-Forwarded-Proto: #{request.headers['X-Forwarded-Proto']}"
    Rails.logger.error "Origin: #{request.headers['Origin']}"
    Rails.logger.error "======================================"

    redirect_to root_path, alert: t("devise.omniauth_callbacks.failure", kind: "Google", reason: "アクセスが拒否されたか、エラーが発生しました")
  end
end
</file>

<file path="app/controllers/users/passwords_controller.rb">
# frozen_string_literal: true

class Users::PasswordsController < Devise::PasswordsController
  # パスワードリセット機能は現在未実装のため、アクセスをブロックする
  # 開発者ツールでComing Soonオーバーレイを削除してもアクセスできないようにする

  # GET /users/password/new
  def new
    redirect_to new_user_session_path,
                alert: "パスワードリセット機能は現在準備中です。Googleアカウントでログインするか、サポートにお問い合わせください。"
  end

  # POST /users/password
  def create
    redirect_to new_user_session_path,
                alert: "パスワードリセット機能は現在準備中です。"
  end

  # GET /users/password/edit?reset_password_token=abcdef
  def edit
    redirect_to new_user_session_path,
                alert: "パスワードリセット機能は現在準備中です。"
  end

  # PUT /users/password
  def update
    redirect_to new_user_session_path,
                alert: "パスワードリセット機能は現在準備中です。"
  end
end
</file>

<file path="app/controllers/achievements_controller.rb">
class AchievementsController < ApplicationController
  before_action :authenticate_user!

  def index
    @achievements = Achievement.all
    # ユーザーが獲得済みの実績IDのリストを取得（ビューでの判定を高速化するため）
    @earned_achievement_ids = current_user.user_achievements.pluck(:achievement_id)
  end
end
</file>

<file path="app/controllers/application_controller.rb">
class ApplicationController < ActionController::Base
  # モダンブラウザのみ許可（テスト環境では無効化）
  allow_browser versions: :modern unless Rails.env.test?

  # 全アクションの前に認証をチェック
  before_action :authenticate_user!

  # Deviseのパラメータ許可設定
  before_action :configure_permitted_parameters, if: :devise_controller?

  protected

  # Deviseで許可する追加パラメータ
  def configure_permitted_parameters
    # サインアップ時に追加フィールドを許可する場合
    devise_parameter_sanitizer.permit(:sign_up, keys: [ :name ])

    # アカウント更新時に追加フィールドを許可する場合
    devise_parameter_sanitizer.permit(:account_update, keys: [
      :name,
      :target_distance,
      :walk_reminder_enabled,
      :walk_reminder_time,
      :inactive_days_reminder_enabled,
      :inactive_days_threshold,
      :reaction_summary_enabled,
      :avatar_type,
      :uploaded_avatar
    ])
  end

  # ログイン後のリダイレクト先を指定
  # stored_location（ログイン前にアクセスしようとしたページ）があればそこへ、なければホームへ
  def after_sign_in_path_for(resource_or_scope)
    stored_location_for(resource_or_scope) || root_path
  end

  # ログアウト後のリダイレクト先を指定
  def after_sign_out_path_for(resource_or_scope)
    new_user_session_path
  end
end
</file>

<file path="app/controllers/notifications_controller.rb">
class NotificationsController < ApplicationController
  before_action :authenticate_user!
  before_action :set_notification, only: [ :mark_as_read ]



  # 通知一覧
  def index
    # タブの種類を取得（デフォルトは'announcements'）
    @tab = params[:tab] || "announcements"

    # タブに応じて通知をフィルタリング
    @notifications = case @tab
    when "reminders"
                       # リマインダーは作成日時の降順
                       current_user.notifications.reminders.recent
    else  # 'announcements'
                       # お知らせは公開日時の降順（ordered_by_announcementがorder句を持っているのでrecentは不要）
                       current_user.notifications.announcements.includes(:announcement).ordered_by_announcement
    end

    @notifications = @notifications.page(params[:page]).per(20)

    # 各タブの未読数を取得
    @announcement_unread_count = current_user.notifications.announcements.unread.count
    @reminder_unread_count = current_user.notifications.reminders.unread.count
  end

  # 個別既読
  def mark_as_read
    @notification.mark_as_read!
    redirect_to notifications_path, notice: "通知を既読にしました"
  end

  # 一括既読
  def mark_all_as_read
    current_user.notifications.unread.update_all(read_at: Time.current)
    redirect_to notifications_path, notice: "すべての通知を既読にしました"
  end

  private

  def set_notification
    @notification = current_user.notifications.find(params[:id])
  end
end
</file>

<file path="app/controllers/stats_controller.rb">
# frozen_string_literal: true

# 統計・分析ページのコントローラー
class StatsController < ApplicationController
  before_action :authenticate_user!

  def index
    # StatsServiceインスタンスを作成
    @stats_service = StatsService.new(current_user)

    # 基本統計データ
    @total_distance = @stats_service.total_distance
    @total_days = @stats_service.total_days
    @current_streak = @stats_service.current_streak
    @average_distance = @stats_service.average_distance_per_day
    @max_distance = @stats_service.max_distance
    @monthly_goal_rate = @stats_service.monthly_goal_achievement_rate
  end

  # グラフデータをJSON形式で返すAPI
  # Stimulusコントローラーから非同期で呼び出される
  def chart_data
    stats_service = StatsService.new(current_user)
    chart_type = params[:type]

    # パラメータのホワイトリスト検証
    allowed_types = %w[daily weekly monthly weekday pace calories time_of_day]
    unless allowed_types.include?(chart_type)
      render json: { error: "Invalid chart type. Allowed types: #{allowed_types.join(', ')}" }, status: :bad_request
      return
    end

    data = case chart_type
    when "daily"
      stats_service.daily_distances_last_30_days
    when "weekly"
      stats_service.weekly_distances_last_12_weeks
    when "monthly"
      stats_service.monthly_distances_last_12_months
    when "weekday"
      stats_service.average_distance_by_weekday
    when "pace"
      stats_service.pace_trend_last_30_days
    when "calories"
      stats_service.calories_trend_last_30_days
    when "time_of_day"
      stats_service.walks_count_by_time_of_day
    end

    render json: data
  rescue StandardError => e
    # 予期せぬエラーをログに記録し、500エラーを返す
    Rails.logger.error("StatsController#chart_data error: #{e.message}")
    Rails.logger.error(e.backtrace.join("\n"))
    render json: { error: "Internal server error" }, status: :internal_server_error
  end
end
</file>

<file path="app/helpers/achievements_helper.rb">
module AchievementsHelper
end
</file>

<file path="app/helpers/application_helper.rb">
module ApplicationHelper
  # 相対時刻表示（ソーシャルゲーム風）
  def time_ago_in_words_game_style(time)
    return "未ログイン" if time.nil?

    distance = Time.current - time
    minutes = (distance / 60).to_i
    hours = (distance / 3600).to_i
    days = (distance / 86400).to_i

    case
    when minutes < 1
      "1分未満"
    when minutes < 60
      "#{minutes}分前"
    when hours < 24
      "#{hours}時間前"
    when days < 30
      "#{days}日前"
    when days < 365
      "#{(days / 30).to_i}ヶ月前"
    else
      "#{(days / 365).to_i}年前"
    end
  end
end
</file>

<file path="app/helpers/posts_helper.rb">
module PostsHelper
  # 投稿の天気・気分スコアに基づいてカラーテーマを決定する
  # 強度スコアに基づく配色ロジック（高スコア＝Vivid, 低スコア＝Pastel）
  def post_color_theme(post)
    # 1. 各要素の強度スコアを定義（同点なし）
    weather_scores = {
      "stormy" => 9,    # 嵐：最強（Vivid Purple）
      "snowy" => 6,     # 雪：強い（Bright Sky）
      "sunny" => 5,     # 晴れ：中強（Bright Orange）
      "rainy" => 4,     # 雨：中弱（Soft Blue）
      "cloudy" => 1     # 曇り：弱い（Soft Gray）
    }

    feeling_scores = {
      "exhausted" => 8, # ヘトヘト：最強（Vivid Rose）
      "great" => 7,     # 最高：強い（Bright Yellow）
      "tired" => 3,     # 疲れた：中弱（Soft Slate）
      "good" => 2,      # 良い：弱い（Soft Lime）
      "normal" => 0     # 普通：最弱（Soft Stone）
    }

    # 2. 現在の投稿のスコアを取得
    w_score = weather_scores[post.weather] || 0
    f_score = feeling_scores[post.feeling] || 0

    # 3. スコア比較で勝者を決定
    winner = if w_score > f_score
               { type: "weather", key: post.weather, score: w_score }
    elsif f_score > w_score
               { type: "feeling", key: post.feeling, score: f_score }
    else
               # 万が一同点なら天気を優先
               { type: "weather", key: post.weather, score: w_score }
    end

    # 4. 勝者に基づいたカラーテーマ定義
    # Light: Claymorphism (Puni-Puni)
    # Dark: Neon Noir / Synthwave (Atmospheric Glow)
    case winner[:key]
    # === Lv.High (Ultraviolet & Hot Pink) ===
    when "stormy"
      {
        bg: "bg-[#faf5ff] dark:bg-[#1a0b2e]/90",
        border: "border-purple-100/50 dark:border-purple-500/50",
        text: "text-purple-800 dark:text-purple-200",
        inner_bg: "bg-purple-50/50 dark:bg-purple-900/30",
        shadow: "shadow-[20px_20px_60px_rgba(168,85,247,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(168,85,247,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(168,85,247,0.3)] dark:shadow-[0_0_30px_rgba(168,85,247,0.4),inset_0_0_20px_rgba(168,85,247,0.1)]",
        orb_bg: "from-purple-500/20 to-pink-500/20"
      }
    when "exhausted"
      {
        bg: "bg-[#fff1f2] dark:bg-[#2e0b16]/90",
        border: "border-rose-100/50 dark:border-rose-500/50",
        text: "text-rose-800 dark:text-rose-200",
        inner_bg: "bg-rose-50/50 dark:bg-rose-900/30",
        shadow: "shadow-[20px_20px_60px_rgba(244,63,94,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(244,63,94,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(244,63,94,0.3)] dark:shadow-[0_0_30px_rgba(244,63,94,0.4),inset_0_0_20px_rgba(244,63,94,0.1)]",
        orb_bg: "from-rose-500/20 to-orange-500/20"
      }

    # === Lv.Mid (Sunset Gradient Glow) ===
    when "great"
      {
        bg: "bg-[#fffbeb] dark:bg-[#2e200b]/90",
        border: "border-yellow-100/50 dark:border-yellow-500/50",
        text: "text-yellow-700 dark:text-yellow-200",
        inner_bg: "bg-yellow-50/50 dark:bg-yellow-900/30",
        shadow: "shadow-[20px_20px_60px_rgba(234,179,8,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(234,179,8,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(234,179,8,0.3)] dark:shadow-[0_0_30px_rgba(234,179,8,0.3),inset_0_0_20px_rgba(234,179,8,0.1)]",
        orb_bg: "from-yellow-400/20 to-orange-400/20"
      }
    when "snowy"
      {
        bg: "bg-[#f0f9ff] dark:bg-[#0b1e2e]/90",
        border: "border-sky-100/50 dark:border-cyan-400/50",
        text: "text-sky-700 dark:text-cyan-200",
        inner_bg: "bg-sky-50/50 dark:bg-cyan-900/30",
        shadow: "shadow-[20px_20px_60px_rgba(14,165,233,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(14,165,233,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(14,165,233,0.3)] dark:shadow-[0_0_30px_rgba(34,211,238,0.4),inset_0_0_20px_rgba(34,211,238,0.1)]",
        orb_bg: "from-sky-400/20 to-blue-400/20"
      }
    when "sunny"
      {
        bg: "bg-[#fff7ed] dark:bg-[#2e150b]/90",
        border: "border-orange-100/50 dark:border-orange-500/50",
        text: "text-orange-700 dark:text-orange-200",
        inner_bg: "bg-orange-50/50 dark:bg-orange-900/30",
        shadow: "shadow-[20px_20px_60px_rgba(249,115,22,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(249,115,22,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(249,115,22,0.3)] dark:shadow-[0_0_30px_rgba(249,115,22,0.4),inset_0_0_20px_rgba(249,115,22,0.1)]",
        orb_bg: "from-orange-400/20 to-red-400/20"
      }

    # === Lv.Low (Midnight Blue Glow) ===
    when "rainy"
      {
        bg: "bg-[#eff6ff] dark:bg-[#0b102e]/90",
        border: "border-blue-100/50 dark:border-blue-500/50",
        text: "text-blue-600 dark:text-blue-200",
        inner_bg: "bg-blue-50/50 dark:bg-blue-900/30",
        shadow: "shadow-[20px_20px_60px_rgba(59,130,246,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(59,130,246,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(59,130,246,0.3)] dark:shadow-[0_0_30px_rgba(59,130,246,0.3),inset_0_0_20px_rgba(59,130,246,0.1)]",
        orb_bg: "from-blue-400/20 to-cyan-400/20"
      }
    when "tired"
      {
        bg: "bg-[#f8fafc] dark:bg-[#0f172a]/90",
        border: "border-slate-100/50 dark:border-slate-500/50",
        text: "text-slate-600 dark:text-slate-300",
        inner_bg: "bg-slate-50/50 dark:bg-slate-800/50",
        shadow: "shadow-[20px_20px_60px_rgba(100,116,139,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(100,116,139,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(100,116,139,0.3)] dark:shadow-[0_0_20px_rgba(148,163,184,0.2),inset_0_0_10px_rgba(148,163,184,0.05)]",
        orb_bg: "from-slate-400/20 to-gray-400/20"
      }
    when "good"
      {
        bg: "bg-[#f7fee7] dark:bg-[#142e0b]/90",
        border: "border-lime-100/50 dark:border-lime-500/50",
        text: "text-lime-600 dark:text-lime-200",
        inner_bg: "bg-lime-50/50 dark:bg-lime-900/30",
        shadow: "shadow-[20px_20px_60px_rgba(132,204,22,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(132,204,22,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(132,204,22,0.3)] dark:shadow-[0_0_30px_rgba(132,204,22,0.3),inset_0_0_20px_rgba(132,204,22,0.1)]",
        orb_bg: "from-lime-400/20 to-green-400/20"
      }
    when "cloudy"
      {
        bg: "bg-[#f9fafb] dark:bg-[#111827]/90",
        border: "border-gray-100/50 dark:border-gray-600/50",
        text: "text-gray-500 dark:text-gray-300",
        inner_bg: "bg-gray-50/50 dark:bg-gray-800/50",
        shadow: "shadow-[20px_20px_60px_rgba(107,114,128,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(107,114,128,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(107,114,128,0.3)] dark:shadow-[0_0_20px_rgba(156,163,175,0.2),inset_0_0_10px_rgba(156,163,175,0.05)]",
        orb_bg: "from-gray-400/20 to-slate-400/20"
      }

    # === Default ===
    else
      {
        bg: "bg-[#fafaf9] dark:bg-[#1c1917]/90",
        border: "border-stone-100/50 dark:border-stone-600/50",
        text: "text-stone-500 dark:text-stone-300",
        inner_bg: "bg-stone-50/50 dark:bg-stone-900/50",
        shadow: "shadow-[20px_20px_60px_rgba(166,175,195,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(166,175,195,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(166,175,195,0.3)] dark:shadow-[0_0_20px_rgba(168,162,158,0.2),inset_0_0_10px_rgba(168,162,158,0.05)]",
        orb_bg: "from-stone-400/20 to-orange-100/20"
      }
    end
  end

  # OGP画像のURLを生成するヘルパー
  # routes.rbで resource :ogp_image を定義しているため、
  # post_ogp_image_url(@post) というヘルパーが自動生成されていますが、
  # もし将来的にロジックを挟みたい場合はここでラップすることも可能です。
  # 現状はルートヘルパーを直接使用して問題ありません。
end
</file>

<file path="app/helpers/rankings_helper.rb">
module RankingsHelper
  def rank_color_class(rank)
    case rank
    when 1
      "bg-gradient-to-br from-yellow-300 to-yellow-500 text-yellow-900"
    when 2
      "bg-gradient-to-br from-slate-300 to-slate-400 text-slate-700"
    when 3
      "bg-gradient-to-br from-orange-300 to-orange-400 text-orange-800"
    else
      "bg-slate-100 text-slate-600"
    end
  end

  def rank_icon(rank)
    case rank
    when 1
      content_tag(:span, "🥇", class: "text-2xl animate-pulse")
    when 2
      content_tag(:span, "🥈", class: "text-2xl")
    when 3
      content_tag(:span, "🥉", class: "text-2xl")
    else
      content_tag(:span, rank, class: "text-lg font-black")
    end
  end

  def period_label_ja(period)
    case period
    when "weekly"
      "今週"
    when "monthly"
      "今月"
    when "yearly"
      "今年"
    else
      "今週"
    end
  end

  # 英語の序数サフィックスを返す（st, nd, rd, th）
  def ordinal_suffix(number)
    n = number.to_i.abs
    return "th" if (11..13).include?(n % 100)

    case n % 10
    when 1 then "st"
    when 2 then "nd"
    when 3 then "rd"
    else "th"
    end
  end
end
</file>

<file path="app/helpers/users_helper.rb">
module UsersHelper
  # ユーザーのアバターを表示するヘルパー
  # 使い方: <%= user_avatar(current_user, classes: "w-20 h-20 text-2xl") %>
  def user_avatar(user, classes: "w-12 h-12 text-lg", default_color_classes: "bg-gradient-to-br from-blue-500 to-indigo-600 text-white")
    # 共通のスタイル（円形、中央寄せ、影など）
    base_classes = "rounded-full flex items-center justify-center font-bold shadow-md transition-transform hover:scale-105 #{classes}"

    avatar_source = user.display_avatar_url

    if avatar_source.is_a?(ActiveStorage::Attached::One) && avatar_source.attached?
      # アップロード画像（Active Storage）
      image_tag avatar_source, alt: user.name, class: "#{base_classes} object-cover"
    elsif avatar_source.is_a?(String)
      # Google画像（URL）
      image_tag avatar_source, alt: user.name, class: "#{base_classes} object-cover", referrerpolicy: "no-referrer"
    else
      # デフォルト：名前の頭文字3文字を取得して表示
      # 例: "Tech Memo" -> "TEC", "山田太郎" -> "山田太"
      initials = user.name.to_s.strip.slice(0, 3).upcase
      initials = "ゲスト" if initials.blank?

      # 3文字の場合、枠に収まるようにフォントサイズを小さくし、文字間を詰める
      # whitespace-nowrap: 改行禁止
      # leading-none: 行間を詰めて垂直中央寄せを安定させる
      adjust_class = initials.length >= 3 ? "text-[0.7em] tracking-tighter whitespace-nowrap leading-none" : "whitespace-nowrap leading-none"

      # 背景色はグラデーションにする（アプリの雰囲気に合わせる）
      content_tag :div, class: "#{base_classes} #{default_color_classes}" do
        content_tag :span, initials, class: adjust_class
      end
    end
  end
end
</file>

<file path="app/javascript/controllers/accordion_controller.js">
import { Controller } from "@hotwired/stimulus";

// シンプルなアコーディオン（開閉）コントローラー
export default class extends Controller {
  static targets = ["content", "icon"];
  static values = { isOpen: Boolean };

  connect() {
    // 初期状態の適用
    this.updateState();
  }

  toggle() {
    this.isOpenValue = !this.isOpenValue;
    this.updateState();
  }

  updateState() {
    if (this.isOpenValue) {
      this.contentTarget.classList.remove("hidden");
      this.iconTarget.style.transform = "rotate(180deg)";
    } else {
      this.contentTarget.classList.add("hidden");
      this.iconTarget.style.transform = "rotate(0deg)";
    }
  }
}
</file>

<file path="app/javascript/controllers/avatar_upload_controller.js">
import { Controller } from "@hotwired/stimulus";

// アバター画像のアップロードプレビューと選択状態の制御を行うコントローラー
export default class extends Controller {
  static targets = [
    "preview",
    "input",
    "radio",
    "optionCard",
    "dropZone",
    "errorMessage",
    "modal",
    "uploadIconContainer"
  ];

  connect() {
    this.updateUI();
  }

  // モーダルを開く
  openModal(e) {
    if (e) e.preventDefault()
    this.modalTarget.showModal()
  }

  // モーダルを閉じる
  closeModal(e) {
    if (e) e.preventDefault()
    this.modalTarget.close()
  }

  // 背景クリックで閉じる
  clickOutside(e) {
    if (e.target === this.modalTarget) {
      this.closeModal(e)
    }
  }

  // ドラッグオーバー時：スタイル変更でユーザーに通知
  dragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    this.dropZoneTarget.classList.add(
      "border-blue-500",
      "bg-blue-50",
      "dark:bg-blue-900/20",
      "scale-[1.02]"
    );
    this.dropZoneTarget.classList.remove(
      "border-gray-300",
      "dark:border-gray-600"
    );
  }

  // ドラッグリーブ時：スタイルを元に戻す
  dragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    this.resetDropZoneStyle();
  }

  // ドロップ時：ファイルを受け取って処理
  drop(e) {
    e.preventDefault();
    e.stopPropagation();
    this.resetDropZoneStyle();

    const files = e.dataTransfer.files;
    if (files.length > 0) {
      this.inputTarget.files = files;
      this.previewImage();
    }
  }

  resetDropZoneStyle() {
    this.dropZoneTarget.classList.remove(
      "border-blue-500",
      "bg-blue-50",
      "dark:bg-blue-900/20",
      "scale-[1.02]"
    );
    this.dropZoneTarget.classList.add(
      "border-gray-300",
      "dark:border-gray-600"
    );
  }

  // ファイルが選択された時の処理
  previewImage() {
    const file = this.inputTarget.files[0];
    if (!file) return;

    // バリデーション実行
    if (!this.validateFile(file)) return;

    // エラーをクリア
    this.hideError();

    // FileReaderで画像を読み込んでプレビュー表示
    const reader = new FileReader();
    reader.onload = (e) => {
      // アップロードアイコンの更新
      if (this.hasUploadIconContainerTarget) {
        this.uploadIconContainerTarget.innerHTML = `<img src="${e.target.result}" class="w-8 h-8 rounded-full object-cover shadow-sm">`;
      }
    };
    reader.readAsDataURL(file);

    // 自動的に「アップロード画像」を選択状態にする
    this.radioTargets.find((r) => r.value === "uploaded").checked = true;
    this.updateUI();
  }

  // クライアントサイドバリデーション
  validateFile(file) {
    const maxSize = 5 * 1024 * 1024; // 5MB
    const allowedTypes = ["image/jpeg", "image/png", "image/gif", "image/webp"];

    if (!allowedTypes.includes(file.type)) {
      this.showError(
        "対応していないファイル形式です。画像ファイル（JPG, PNG, GIF, WEBP）を選択してください。"
      );
      return false;
    }

    if (file.size > maxSize) {
      this.showError(
        "ファイルサイズが大きすぎます。5MB以下の画像を選択してください。"
      );
      return false;
    }

    return true;
  }

  showError(message) {
    if (this.hasErrorMessageTarget) {
      this.errorMessageTarget.textContent = message;
      this.errorMessageTarget.classList.remove("hidden");

      // エラー時は入力をリセット
      this.inputTarget.value = "";
    } else {
      alert(message);
    }
  }

  hideError() {
    if (this.hasErrorMessageTarget) {
      this.errorMessageTarget.classList.add("hidden");
    }
  }

  // ラジオボタンが変更された時の処理
  updateUI() {
    const selectedValue = this.radioTargets.find((r) => r.checked).value;

    // 選択されたカードを強調表示
    this.optionCardTargets.forEach((card) => {
      const radioValue = card.dataset.value;
      if (radioValue === selectedValue) {
        card.classList.add(
          "ring-2",
          "ring-blue-500",
          "bg-blue-50",
          "dark:bg-blue-900/20"
        );
        card.classList.remove("border-gray-200", "dark:border-gray-700");
      } else {
        card.classList.remove(
          "ring-2",
          "ring-blue-500",
          "bg-blue-50",
          "dark:bg-blue-900/20"
        );
        card.classList.add("border-gray-200", "dark:border-gray-700");
      }
    });
  }

  // 削除確認モーダルを表示
  showDeleteModal(e) {
    e.preventDefault();
    e.stopPropagation(); // ラベルへのイベント伝播を防ぐ
    const modal = document.getElementById("avatar_delete_modal");
    if (modal) {
      modal.classList.remove("hidden");
    }
  }

  // 削除確認モーダルを非表示
  hideDeleteModal() {
    const modal = document.getElementById("avatar_delete_modal");
    if (modal) {
      modal.classList.add("hidden");
    }
  }
}
</file>

<file path="app/javascript/controllers/carousel_controller.js">
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
    static targets = ["container", "indicator"]
    static values = {
        interval: { type: Number, default: 5000 },
        enable: { type: Boolean, default: true }
    }

    connect() {
        this.isDragging = false
        this.startX = 0
        this.scrollLeft = 0
        this.currentIndex = 0

        // スライドの枚数を取得（インジケーターの数から推測）
        this.slideCount = this.indicatorTargets.length

        // イベントリスナーの登録
        // タッチイベント
        this.containerTarget.addEventListener('touchstart', this.touchStart.bind(this), { passive: true })
        this.containerTarget.addEventListener('touchmove', this.touchMove.bind(this), { passive: true })
        this.containerTarget.addEventListener('touchend', this.touchEnd.bind(this))

        // マウスイベント
        this.containerTarget.addEventListener('mousedown', this.touchStart.bind(this))
        this.containerTarget.addEventListener('mouseup', this.touchEnd.bind(this))
        this.containerTarget.addEventListener('mouseleave', () => {
            if (this.isDragging) this.touchEnd()
        })
        this.containerTarget.addEventListener('mousemove', this.touchMove.bind(this))

        // コンテキストメニュー無効化（右クリックドラッグ防止）
        this.containerTarget.oncontextmenu = function (event) {
            event.preventDefault()
            event.stopPropagation()
            return false
        }

        this.startAutoPlay()
    }

    disconnect() {
        this.stopAutoPlay()
    }

    // --- イベントハンドラ ---

    touchStart(event) {
        this.stopAutoPlay()
        this.isDragging = true
        this.startX = this.getPositionX(event)
        this.scrollLeft = this.containerTarget.scrollLeft

        this.containerTarget.classList.add('cursor-grabbing')
        this.containerTarget.classList.remove('cursor-grab')
    }

    touchMove(event) {
        if (!this.isDragging) return

        // マウスの場合はデフォルト動作（テキスト選択など）を防ぐ
        if (event.type.includes('mouse')) {
            event.preventDefault()
        }

        const x = this.getPositionX(event)
        const walk = (x - this.startX) * 1.5 // 1.5倍速で追従
        this.containerTarget.scrollLeft = this.scrollLeft - walk
    }

    touchEnd() {
        if (!this.isDragging) return
        this.isDragging = false

        this.containerTarget.classList.remove('cursor-grabbing')
        this.containerTarget.classList.add('cursor-grab')

        // スナップ処理
        this.snapToNearestSlide()
        this.startAutoPlay()
    }

    // --- ヘルパーメソッド ---

    getPositionX(event) {
        return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX
    }

    snapToNearestSlide() {
        const slideWidth = this.containerTarget.offsetWidth // コンテナ幅をスライド幅とみなす（1枚表示の場合）
        const scrollLeft = this.containerTarget.scrollLeft

        // 現在のスクロール位置から最も近いスライドのインデックスを計算
        let newIndex = Math.round(scrollLeft / slideWidth)

        // 範囲制限
        if (newIndex < 0) newIndex = 0
        if (newIndex >= this.slideCount) newIndex = this.slideCount - 1

        this.currentIndex = newIndex
        this.scrollToSlide()
    }

    scrollToSlide() {
        const slideWidth = this.containerTarget.offsetWidth
        // ギャップ（gap-4 = 16px）を考慮するかどうかだが、snap-centerを使わない場合は
        // コンテナ幅 * インデックス で概ね合うはず（width: 100% の場合）
        // ただし、gapがある場合は少しずれる可能性がある。
        // 今回は min-w-full なので、コンテナ幅 = スライド幅。
        // gap-4 があるので、2枚目以降は gap 分ずれる。

        // 正確には、各スライドの offsetLeft を取得するのがベスト
        // しかし slideTargets が定義されていない（HTML側で data-carousel-target="slide" があるはずだが）
        // ここでは簡易的に offsetWidth を使うが、より正確にするなら slideTargets を使うべき。

        // slideTargets を取得してみる（connectで取得していないので、DOMから直接）
        const slides = Array.from(this.containerTarget.children)
        if (slides[this.currentIndex]) {
            const slide = slides[this.currentIndex]
            this.containerTarget.scrollTo({
                left: slide.offsetLeft,
                behavior: 'smooth'
            })
        }

        this.updateIndicators()
    }

    // --- 自動再生 ---

    startAutoPlay() {
        if (!this.enableValue) return
        this.stopAutoPlay()
        this.timer = setInterval(() => {
            this.next()
        }, this.intervalValue)
    }

    stopAutoPlay() {
        if (this.timer) {
            clearInterval(this.timer)
            this.timer = null
        }
    }

    next() {
        this.currentIndex = (this.currentIndex + 1) % this.slideCount
        this.scrollToSlide()
    }

    updateIndicators() {
        this.indicatorTargets.forEach((indicator, index) => {
            if (index === this.currentIndex) {
                indicator.classList.add("bg-white", "w-6")
                indicator.classList.remove("bg-white/40", "w-2")
            } else {
                indicator.classList.add("bg-white/40", "w-2")
                indicator.classList.remove("bg-white", "w-6")
            }
        })
    }
}
</file>

<file path="app/javascript/controllers/flash_controller.js">
import { Controller } from "@hotwired/stimulus";

// フラッシュメッセージを高度に制御するコントローラー
// - 自動消滅 (標準5秒)
// - ドロップダウンアニメーション (Dynamic Island風)
// - クリックで即時削除
export default class extends Controller {
  connect() {
    // 表示初期状態: 上に隠して少し小さくしておく
    // transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) <- 弾むような動き
    this.element.classList.add(
      "transition-all",
      "duration-500",
      "ease-out", // またはカスタムcubic-bezierで弾ませるのもあり
      "transform",
      "-translate-y-full",
      "scale-90",
      "opacity-0"
    );

    // ビューのレンダリング後にアニメーション開始（降りてくる）
    requestAnimationFrame(() => {
      this.element.classList.remove("-translate-y-full", "scale-90", "opacity-0");
    });

    // 5秒後に自動消滅開始
    this.timeout = setTimeout(() => {
      this.dismiss();
    }, 5000);
  }

  disconnect() {
    if (this.timeout) {
      clearTimeout(this.timeout);
    }
  }

  // メッセージを閉じるアクション
  dismiss() {
    if (this.element.dataset.dismissing) return;
    this.element.dataset.dismissing = "true";

    // 上へ退場
    this.element.classList.add("-translate-y-full", "scale-90", "opacity-0");

    // アニメーション完了後にDOMから削除
    setTimeout(() => {
      this.element.remove();
    }, 500);
  }
}
</file>

<file path="app/javascript/controllers/icon_select_controller.js">
import { Controller } from "@hotwired/stimulus"

// アイコンボタンによるラジオボタン選択コントローラー
export default class extends Controller {
  static targets = ["input", "button"]
  static classes = ["selected", "unselected"]

  connect() {
    this.updateState()
    // ラジオボタンの変更を監視
    this.inputTargets.forEach(input => {
      input.addEventListener('change', () => this.updateState())
    })
  }

  select(event) {
    // クリックされたボタンに対応するラジオボタンの値を取得
    const value = event.currentTarget.dataset.value

    // 対応するラジオボタンを選択
    const input = this.inputTargets.find(i => i.value === value)
    if (input) {
      input.checked = true
      this.updateState()
    }
  }

  updateState() {
    // 現在選択されている値を取得
    const checkedInput = this.inputTargets.find(i => i.checked)
    const checkedValue = checkedInput ? checkedInput.value : null

    // 各ボタンの見た目を更新
    this.buttonTargets.forEach(button => {
      if (button.dataset.value === checkedValue) {
        button.classList.add(...this.selectedClasses)
        button.classList.remove(...this.unselectedClasses)
      } else {
        button.classList.remove(...this.selectedClasses)
        button.classList.add(...this.unselectedClasses)
      }
    })
  }
}
</file>

<file path="app/javascript/controllers/landing_modal_controller.js">
import { Controller } from "@hotwired/stimulus";

export default class extends Controller {
  static targets = ["modal", "content", "count"]

  connect() {
    // モーダル初期化（非表示）
    this.close()
  }

  open(event) {
    event.preventDefault()

    // クリックされた要素から機能タイプを取得
    const featureType = event.currentTarget.dataset.featureType

    // すべてのコンテンツを非表示にし、該当するものだけ表示
    this.contentTargets.forEach(target => {
      if (target.dataset.featureType === featureType) {
        target.classList.remove("hidden")

        // アニメーションをリセットするために要素を再描画させるハック
        // クラスを一度削除して再付与することで、確実にアニメーションを再開させる
        const animationClasses = ['animate-dash', 'animate-grow-h-12', 'animate-grow-h-16', 'animate-grow-h-24', 'animate-shimmer', 'animate-pop-in', 'animate-float-up']

        // 対象となる要素をすべて取得
        const animatedElements = target.querySelectorAll(animationClasses.map(c => `.${c}`).join(', '))

        animatedElements.forEach(el => {
          // その要素が持っているアニメーションクラスを特定
          const activeClass = animationClasses.find(c => el.classList.contains(c))

          if (activeClass) {
            el.classList.remove(activeClass)
            void el.offsetWidth // trigger reflow
            el.classList.add(activeClass)
          }
        })

        // カウントアップ演出の実行
        const countElements = target.querySelectorAll('[data-landing-modal-target="count"]')
        countElements.forEach(el => {
          const endValue = parseInt(el.dataset.countTo, 10)
          this.animateValue(el, 0, endValue, 1500)
        })

      } else {
        target.classList.add("hidden")
      }
    })

    // モーダルを表示
    this.modalTarget.classList.remove("hidden")
    // アニメーション用クラスを追加（フェードイン）
    this.modalTarget.classList.add("animate-fade-in")

    // 背景スクロール固定
    document.body.style.overflow = "hidden"
  }

  close(event) {
    if (event) event.preventDefault()

    this.modalTarget.classList.add("hidden")
    this.modalTarget.classList.remove("animate-fade-in")

    // 背景スクロール解除
    document.body.style.overflow = "auto"
  }

  // 数値をカウントアップさせるヘルパーメソッド
  animateValue(obj, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);

      // イージング関数（easeOutExpoっぽい動き）
      const easeProgress = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);

      const current = Math.floor(easeProgress * (end - start) + start);
      obj.innerHTML = current.toLocaleString(); // カンマ区切り

      if (progress < 1) {
        window.requestAnimationFrame(step);
      }
    };
    window.requestAnimationFrame(step);
  }
}
</file>

<file path="app/javascript/controllers/pwa_install_controller.js">
import { Controller } from "@hotwired/stimulus";

// PWAインストールプロンプトを管理するコントローラー
export default class extends Controller {
  static targets = ["banner"];

  connect() {
    console.log("[PWA Install] Controller connected")

    // グローバルに保存されたイベントがあれば復元
    if (window.pwaInstallPrompt) {
      this.deferredPrompt = window.pwaInstallPrompt
    }

    // 既にインストール済みかチェック
    if (window.matchMedia('(display-mode: standalone)').matches) {
      console.log('[PWA Install] Already installed')
      return
    }

    console.log('[PWA Install] Waiting for beforeinstallprompt event...')

    // beforeinstallprompt イベントをキャプチャ
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('[PWA Install] beforeinstallprompt event fired!')

      // デフォルトのプロンプトを防ぐ
      e.preventDefault()

      // 後で使えるようにイベントを保存
      this.deferredPrompt = e
      window.pwaInstallPrompt = e // グローバルにも保存（設定画面などで使うため）

      // 以前に閉じていなければバナーを表示
      const dismissed = localStorage.getItem('pwa-install-dismissed')
      if (!dismissed) {
        this.showBanner()
      } else {
        console.log('[PWA Install] Banner suppressed because it was dismissed previously')
      }
    })

    // インストール完了時にバナーを非表示
    window.addEventListener('appinstalled', () => {
      this.hideBanner()
      window.pwaInstallPrompt = null
    })
  }

  // バナーを表示
  showBanner() {
    if (this.hasBannerTarget) {
      this.bannerTarget.classList.remove("hidden");
      // アニメーション用
      setTimeout(() => {
        this.bannerTarget.classList.add("translate-y-0", "opacity-100");
        this.bannerTarget.classList.remove("translate-y-4", "opacity-0");
      }, 100);
    }
  }

  // バナーを非表示
  hideBanner() {
    if (this.hasBannerTarget) {
      this.bannerTarget.classList.add("translate-y-4", "opacity-0");
      this.bannerTarget.classList.remove("translate-y-0", "opacity-100");
      setTimeout(() => {
        this.bannerTarget.classList.add("hidden");
      }, 300);
    }
  }

  // インストールボタンをクリック
  async install() {
    if (!this.deferredPrompt) {
      return;
    }

    // インストールプロンプトを表示
    this.deferredPrompt.prompt();

    // ユーザーの選択を待つ
    const { outcome } = await this.deferredPrompt.userChoice;

    console.log(`User response to the install prompt: ${outcome}`);

    // プロンプトを使い切ったのでクリア
    this.deferredPrompt = null;

    // バナーを非表示
    this.hideBanner();
  }

  // ×ボタンをクリック
  dismiss() {
    // ローカルストレージに記録（次回から表示しない）
    localStorage.setItem("pwa-install-dismissed", "true");

    // バナーを非表示
    this.hideBanner();
  }
}
</file>

<file path="app/javascript/controllers/pwa_settings_controller.js">
import { Controller } from "@hotwired/stimulus"

// 設定画面のPWAインストールボタンを管理するコントローラー
export default class extends Controller {
  static targets = ["installButton", "iosGuideModal"]

  connect() {
    console.log("[PWA Settings] Controller connected")

    // 既にインストール済み（スタンドアローンモード）の場合はボタンを非表示
    if (window.matchMedia('(display-mode: standalone)').matches) {
      console.log("[PWA Settings] Running in standalone mode. Removing install button.")
      if (this.hasInstallButtonTarget) {
        this.installButtonTarget.remove()
      }
      return
    }

    console.log("[PWA Settings] Not in standalone mode. Button should be visible.")

    // iOSかどうか判定
    this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream
    console.log(`[PWA Settings] isIOS: ${this.isIOS}`)
  }

  // インストールボタンクリック時の処理
  install() {
    if (this.isIOS) {
      // iOSの場合はガイドを表示
      this.showIOSGuide()
    } else {
      // Android/PCの場合はプロンプトを表示
      this.promptInstall()
    }
  }

  // Android/PC向けのインストールプロンプト表示
  async promptInstall() {
    const promptEvent = window.pwaInstallPrompt

    if (!promptEvent) {
      // イベントがない場合（Chromeで一度拒否した後など）
      alert('ブラウザのメニューから「アプリをインストール」を選択してください。')
      return
    }

    // プロンプトを表示
    promptEvent.prompt()

    // ユーザーの選択を待つ
    const { outcome } = await promptEvent.userChoice
    console.log(`User response to the install prompt: ${outcome}`)

    // プロンプトは一度しか使えないのでクリア
    window.pwaInstallPrompt = null

    // インストールされたらボタンを消す（appinstalledイベントでも良いが念のため）
    if (outcome === 'accepted') {
      this.installButtonTarget.remove()
    }
  }

  // iOS向けのガイドモーダル表示
  showIOSGuide() {
    if (this.hasIosGuideModalTarget) {
      this.iosGuideModalTarget.classList.remove('hidden')
      // アニメーション
      setTimeout(() => {
        this.iosGuideModalTarget.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0')
        this.iosGuideModalTarget.querySelector('.modal-content').classList.add('scale-100', 'opacity-100')
      }, 10)
    } else {
      alert('Safariの「共有」ボタンから「ホーム画面に追加」を選択してください。')
    }
  }

  // iOSガイドを閉じる
  closeIOSGuide() {
    if (this.hasIosGuideModalTarget) {
      this.iosGuideModalTarget.querySelector('.modal-content').classList.add('scale-95', 'opacity-0')
      this.iosGuideModalTarget.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100')
      setTimeout(() => {
        this.iosGuideModalTarget.classList.add('hidden')
      }, 200)
    }
  }
}
</file>

<file path="app/javascript/controllers/scroll_drag_controller.js">
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
  connect() {
    this.isDown = false
    this.startX = 0
    this.scrollLeft = 0

    // イベントリスナーのバインド（thisを固定）
    this.startHandler = this.start.bind(this)
    this.stopHandler = this.stop.bind(this)
    this.moveHandler = this.move.bind(this)

    // マウスイベント
    this.element.addEventListener('mousedown', this.startHandler)
    this.element.addEventListener('mouseleave', this.stopHandler)
    this.element.addEventListener('mouseup', this.stopHandler)
    this.element.addEventListener('mousemove', this.moveHandler)

    // タッチイベント
    this.element.addEventListener('touchstart', this.startHandler, { passive: true })
    this.element.addEventListener('touchend', this.stopHandler)
    this.element.addEventListener('touchmove', this.moveHandler, { passive: false })

    this.element.classList.add('cursor-grab')
    this.element.classList.remove('cursor-grabbing')
  }

  disconnect() {
    // イベントリスナーの削除
    this.element.removeEventListener('mousedown', this.startHandler)
    this.element.removeEventListener('mouseleave', this.stopHandler)
    this.element.removeEventListener('mouseup', this.stopHandler)
    this.element.removeEventListener('mousemove', this.moveHandler)

    this.element.removeEventListener('touchstart', this.startHandler)
    this.element.removeEventListener('touchend', this.stopHandler)
    this.element.removeEventListener('touchmove', this.moveHandler)
  }

  start(e) {
    this.isDown = true
    this.element.classList.add('cursor-grabbing')
    this.element.classList.remove('cursor-grab')
    this.element.classList.remove('snap-x', 'snap-mandatory')

    const pageX = e.pageX || (e.touches ? e.touches[0].pageX : 0)
    this.startX = pageX - this.element.offsetLeft
    this.scrollLeft = this.element.scrollLeft
  }

  stop() {
    if (!this.isDown) return
    this.isDown = false
    this.element.classList.remove('cursor-grabbing')
    this.element.classList.add('cursor-grab')

    setTimeout(() => {
      this.element.classList.add('snap-x', 'snap-mandatory')
    }, 100)
  }

  move(e) {
    if (!this.isDown) return

    // マウスの場合はデフォルト動作（テキスト選択など）を防ぐ
    if (!e.touches) {
      e.preventDefault()
    }

    const pageX = e.pageX || (e.touches ? e.touches[0].pageX : 0)
    const x = pageX - this.element.offsetLeft
    const walk = (x - this.startX) * 2 // スクロール速度
    this.element.scrollLeft = this.scrollLeft - walk
  }
}
</file>

<file path="app/javascript/controllers/stats_chart_controller.js">
import { Controller } from "@hotwired/stimulus"
import Chart from "chart.js/auto"

// 統計グラフを管理するStimulusコントローラー
// Chart.jsを使ってインタラクティブなグラフを描画します
export default class extends Controller {
  static targets = [
    "dailyCanvas",
    "weeklyCanvas",
    "monthlyCanvas",
    "weekdayCanvas",
    "paceCanvas",
    "caloriesCanvas",
    "timeOfDayCanvas"
  ]

  static values = {
    dailyUrl: String,
    weeklyUrl: String,
    monthlyUrl: String,
    weekdayUrl: String,
    paceUrl: String,
    caloriesUrl: String,
    timeOfDayUrl: String
  }

  // 各グラフのインスタンスを保持
  charts = {}

  connect() {
    console.log("StatsChart controller connected")
    this.initializeCharts()
  }

  disconnect() {
    // メモリリーク防止: グラフインスタンスを破棄
    Object.values(this.charts).forEach(chart => {
      if (chart) chart.destroy()
    })
    this.charts = {}
  }

  // 全グラフの初期化
  async initializeCharts() {
    // 日別距離グラフ
    if (this.hasDailyCanvasTarget) {
      await this.loadChart("daily", this.dailyCanvasTarget, this.dailyUrlValue, "line")
    }

    // 週別距離グラフ
    if (this.hasWeeklyCanvasTarget) {
      await this.loadChart("weekly", this.weeklyCanvasTarget, this.weeklyUrlValue, "line")
    }

    // 月別距離グラフ
    if (this.hasMonthlyCanvasTarget) {
      await this.loadChart("monthly", this.monthlyCanvasTarget, this.monthlyUrlValue, "line")
    }

    // 曜日別平均距離グラフ
    if (this.hasWeekdayCanvasTarget) {
      await this.loadChart("weekday", this.weekdayCanvasTarget, this.weekdayUrlValue, "bar")
    }

    // ペース推移グラフ
    if (this.hasPaceCanvasTarget) {
      await this.loadChart("pace", this.paceCanvasTarget, this.paceUrlValue, "line")
    }

    // カロリー推移グラフ
    if (this.hasCaloriesCanvasTarget) {
      await this.loadChart("calories", this.caloriesCanvasTarget, this.caloriesUrlValue, "line")
    }

    // 時間帯別円グラフ
    if (this.hasTimeOfDayCanvasTarget) {
      await this.loadChart("time_of_day", this.timeOfDayCanvasTarget, this.timeOfDayUrlValue, "doughnut")
    }
  }

  // グラフデータを読み込んで描画
  async loadChart(chartId, canvas, url, type) {
    try {
      const response = await fetch(url)

      // HTTPステータスコードをチェック
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`)
      }

      const data = await response.json()

      // サーバー側のエラーレスポンスをチェック
      if (data.error) {
        throw new Error(data.error)
      }

      // データの妥当性をチェック
      if (!this.validateChartData(chartId, data)) {
        throw new Error(`Invalid data structure for ${chartId} chart`)
      }

      // グラフの設定を構築
      const config = this.buildChartConfig(chartId, data, type)

      // データが全て0の場合はメッセージを表示して終了 (円グラフのみ)
      if (chartId === "time_of_day") {
        const total = data.data.reduce((a, b) => a + b, 0)
        if (total === 0) {
          this.showErrorOnCanvas(canvas, "データがありません")
          return
        }
      }

      // Chart.jsインスタンスを作成
      this.charts[chartId] = new Chart(canvas, config)
    } catch (error) {
      console.error(`Failed to load ${chartId} chart:`, error)
      // キャンバスにエラーメッセージを表示
      this.showErrorOnCanvas(canvas, `グラフの読み込みに失敗しました: ${chartId}`)
    }
  }

  // グラフデータの妥当性をチェック
  validateChartData(chartId, data) {
    if (!data || typeof data !== 'object') return false

    switch(chartId) {
      case "daily":
        return Array.isArray(data.dates) && Array.isArray(data.distances)
      case "weekly":
        return Array.isArray(data.weeks) && Array.isArray(data.distances)
      case "monthly":
        return Array.isArray(data.months) && Array.isArray(data.distances)
      case "weekday":
        return Array.isArray(data.day_names) && Array.isArray(data.average_distances)
      case "pace":
        return Array.isArray(data.dates) && Array.isArray(data.paces)
      case "calories":
        return Array.isArray(data.dates) && Array.isArray(data.calories)
      case "time_of_day":
        return Array.isArray(data.labels) && Array.isArray(data.data)
      default:
        return false
    }
  }

  // キャンバスにエラーメッセージを表示
  showErrorOnCanvas(canvas, message) {
    const ctx = canvas.getContext('2d')
    ctx.font = '14px sans-serif'
    ctx.fillStyle = '#ef4444' // red-500
    ctx.textAlign = 'center'
    ctx.fillText(message, canvas.width / 2, canvas.height / 2)
  }

  // グラフの設定を構築
  buildChartConfig(chartId, data, type) {
    const baseConfig = {
      type: type,
      data: this.buildChartData(chartId, data),
      options: this.buildChartOptions(chartId)
    }

    return baseConfig
  }

  // グラフのデータ部分を構築
  buildChartData(chartId, data) {
    switch(chartId) {
      case "daily":
        return {
          labels: data.dates,
          datasets: [{
            label: "距離 (km)",
            data: data.distances,
            borderColor: "rgb(59, 130, 246)", // blue-500
            backgroundColor: "rgba(59, 130, 246, 0.1)",
            tension: 0.3,
            fill: true
          }]
        }

      case "weekly":
        return {
          labels: data.weeks,
          datasets: [{
            label: "距離 (km)",
            data: data.distances,
            borderColor: "rgb(16, 185, 129)", // green-500
            backgroundColor: "rgba(16, 185, 129, 0.1)",
            tension: 0.3,
            fill: true
          }]
        }

      case "monthly":
        return {
          labels: data.months,
          datasets: [{
            label: "距離 (km)",
            data: data.distances,
            borderColor: "rgb(168, 85, 247)", // purple-500
            backgroundColor: "rgba(168, 85, 247, 0.1)",
            tension: 0.3,
            fill: true
          }]
        }

      case "weekday":
        return {
          labels: data.day_names,
          datasets: [{
            label: "平均距離 (km)",
            data: data.average_distances,
            backgroundColor: [
              "rgba(239, 68, 68, 0.7)",   // 日曜 red
              "rgba(251, 146, 60, 0.7)",  // 月曜 orange
              "rgba(234, 179, 8, 0.7)",   // 火曜 yellow
              "rgba(34, 197, 94, 0.7)",   // 水曜 green
              "rgba(59, 130, 246, 0.7)",  // 木曜 blue
              "rgba(168, 85, 247, 0.7)",  // 金曜 purple
              "rgba(236, 72, 153, 0.7)"   // 土曜 pink
            ]
          }]
        }

      case "pace":
        return {
          labels: data.dates,
          datasets: [{
            label: "ペース (分/km)",
            data: data.paces,
            borderColor: "rgb(245, 158, 11)", // amber-500
            backgroundColor: "rgba(245, 158, 11, 0.1)",
            tension: 0.3,
            fill: true
          }]
        }

      case "calories":
        return {
          labels: data.dates,
          datasets: [{
            label: "消費カロリー (kcal)",
            data: data.calories,
            borderColor: "rgb(239, 68, 68)", // red-500
            backgroundColor: "rgba(239, 68, 68, 0.1)",
            tension: 0.3,
            fill: true
          }]
        }

      case "time_of_day":
        return {
          labels: data.labels,
          datasets: [{
            data: data.data,
            backgroundColor: [
              "rgba(16, 185, 129, 0.7)",  // 早朝: emerald-500
              "rgba(245, 158, 11, 0.7)",  // 日中: amber-500
              "rgba(249, 115, 22, 0.7)",  // 夕方: orange-500 (夕焼けイメージ)
              "rgba(30, 58, 138, 0.7)"    // 夜間: blue-900 (深夜)
            ],
            borderColor: [
              "rgb(16, 185, 129)",
              "rgb(245, 158, 11)",
              "rgb(249, 115, 22)",
              "rgb(30, 58, 138)"
            ],
            borderWidth: 1,
            hoverOffset: 4
          }]
        }

      default:
        return {}
    }
  }

  // グラフのオプションを構築
  buildChartOptions(chartId) {
    const baseOptions = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: "top"
        },
        tooltip: {
          mode: "index",
          intersect: false
        }
      },
      interaction: {
        mode: "nearest",
        axis: "x",
        intersect: false
      }
    }

    // グラフタイプ別の追加設定
    if (chartId === "weekday") {
      // 棒グラフの場合
      baseOptions.scales = {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: "平均距離 (km)"
          }
        }
      }
    } else if (chartId === "time_of_day") {
      // 円グラフの場合
      // scales と interaction は不要なので削除
      delete baseOptions.interaction

      // ドーナツチャートのカットアウトサイズ
      baseOptions.cutout = '60%'

      // ツールチップのカスタマイズ (パーセンテージ表示など)
      baseOptions.plugins.tooltip = {
        callbacks: {
          label: function(context) {
            let label = context.label || '';
            if (label) {
              label += ': ';
            }
            const value = context.parsed;
            const dataset = context.dataset;
            const total = dataset.data.reduce((acc, data) => acc + data, 0);
            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + "%" : "0%";
            return `${label}${value}回 (${percentage})`;
          }
        }
      }
    } else {
      // 折れ線グラフの場合
      baseOptions.scales = {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: this.getYAxisLabel(chartId)
          }
        },
        x: {
          title: {
            display: false
          }
        }
      }
    }

    return baseOptions
  }

  // Y軸のラベルを取得
  getYAxisLabel(chartId) {
    const labels = {
      daily: "距離 (km)",
      weekly: "距離 (km)",
      monthly: "距離 (km)",
      pace: "ペース (分/km)",
      calories: "消費カロリー (kcal)"
    }
    return labels[chartId] || ""
  }
}
</file>

<file path="app/models/achievement.rb">
class Achievement < ApplicationRecord
  has_many :user_achievements, dependent: :destroy
  has_many :users, through: :user_achievements

  validates :name, presence: true
  validates :description, presence: true
  validates :condition_type, presence: true
  validates :condition_value, presence: true, numericality: { only_integer: true, greater_than: 0 }
  validates :icon_name, presence: true

  enum :condition_type, {
    total_steps: 0,      # 累計歩数
    total_distance: 1,   # 累計距離
    login_streak: 2,     # 連続ログイン
    post_count: 3        # 投稿数
  }
end
</file>

<file path="app/models/announcement.rb">
class Announcement < ApplicationRecord
  # 関連付け
  has_many :notifications, dependent: :destroy

  # バリデーション
  validates :title, presence: true, length: { maximum: 100 }
  validates :content, presence: true
  validates :announcement_type, inclusion: { in: %w[info warning urgent] }

  # コールバック: 公開時に全ユーザーに通知を作成
  after_commit :create_notifications_for_users, on: [ :create, :update ], if: :should_create_notifications?

  # お知らせの種類
  ANNOUNCEMENT_TYPES = {
    "info" => "お知らせ",
    "warning" => "重要",
    "urgent" => "緊急"
  }.freeze

  # スコープ: 公開中のお知らせ
  scope :published, -> { where(is_published: true).where("published_at <= ?", Time.current) }
  scope :active, -> {
    published.where("expires_at IS NULL OR expires_at > ?", Time.current)
  }
  scope :recent, -> { order(published_at: :desc, id: :desc) }

  # 公開中かどうか
  def active?
    is_published &&
      published_at.present? &&
      published_at <= Time.current &&
      (expires_at.nil? || expires_at > Time.current)
  end

  # お知らせ種類の日本語名
  def type_name
    ANNOUNCEMENT_TYPES[announcement_type] || "お知らせ"
  end

  private

  # 通知を作成すべきかどうか
  def should_create_notifications?
    # 公開状態に変更された場合のみ通知を作成
    saved_change_to_is_published? && is_published?
  end

  # 全ユーザーに通知を作成
  def create_notifications_for_users
    User.find_each do |user|
      notifications.find_or_create_by!(user: user)
    rescue ActiveRecord::RecordNotUnique
      # ユニークインデックス違反 = すでに通知が存在するためスキップ
      Rails.logger.debug "Notification already exists for user #{user.id} and announcement #{id}"
      next
    end
  end
end
</file>

<file path="app/models/user_achievement.rb">
class UserAchievement < ApplicationRecord
  belongs_to :user
  belongs_to :achievement

  validates :user_id, uniqueness: { scope: :achievement_id }
end
</file>

<file path="app/views/achievements/index.html.erb">
<div class="min-h-screen pb-20 bg-[#f0f4f8] dark:bg-[#0f172a] text-slate-800 dark:text-slate-100 transition-colors duration-300">
  <!-- Header -->
  <div class="sticky top-0 z-10 bg-[#f0f4f8]/80 dark:bg-[#0f172a]/80 backdrop-blur-md border-b border-white/20 dark:border-white/10">
    <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
      <%= link_to root_path, class: "p-2 rounded-full hover:bg-white/50 dark:hover:bg-white/10 transition-colors" do %>
        <span class="material-symbols-outlined text-2xl">arrow_back</span>
      <% end %>
      <h1 class="text-lg font-bold tracking-wider">ACHIEVEMENTS</h1>
      <div class="w-10"></div> <!-- Spacer -->
    </div>
  </div>

  <div class="max-w-4xl mx-auto px-4 py-6">
    <!-- Stats Summary -->
    <div class="mb-8 p-6 rounded-3xl bg-white/60 dark:bg-white/5 backdrop-blur-xl border border-white/40 dark:border-white/10 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-slate-500 dark:text-slate-400 font-medium">TOTAL EARNED</p>
          <p class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-400 dark:to-purple-400">
            <%= @earned_achievement_ids.count %> <span class="text-lg text-slate-500 dark:text-slate-400 font-normal">/ <%= @achievements.count %></span>
          </p>
        </div>
        <div class="h-12 w-12 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center shadow-lg shadow-orange-500/30">
          <span class="material-symbols-outlined text-white text-2xl">emoji_events</span>
        </div>
      </div>
      <!-- Progress Bar -->
      <div class="mt-4 h-2 w-full bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
        <div class="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-1000 ease-out" style="width: <%= @achievements.count > 0 ? (@earned_achievement_ids.count.to_f / @achievements.count * 100).round : 0 %>%"></div>
      </div>
    </div>

    <!-- Achievements Grid -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
      <% @achievements.each do |achievement| %>
        <% earned = @earned_achievement_ids.include?(achievement.id) %>

        <div class="relative group p-4 rounded-2xl border transition-all duration-300
          <%= earned ?
              'bg-white/80 dark:bg-slate-800/80 border-white/50 dark:border-white/10 shadow-lg hover:shadow-xl hover:-translate-y-1' :
              'bg-slate-100/50 dark:bg-slate-900/50 border-transparent opacity-70 grayscale' %>">

          <div class="flex flex-col items-center text-center">
            <!-- Icon -->
            <div class="mb-3 h-16 w-16 rounded-2xl flex items-center justify-center transition-transform duration-300 group-hover:scale-110
              <%= earned ?
                  'bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900/30 dark:to-purple-900/30 text-blue-600 dark:text-blue-400 shadow-inner' :
                  'bg-slate-200 dark:bg-slate-800 text-slate-400' %>">
              <span class="material-symbols-outlined text-4xl">
                <%= earned ? achievement.icon_name : 'lock' %>
              </span>
            </div>

            <!-- Name -->
            <h3 class="font-bold text-sm mb-1 <%= earned ? 'text-slate-800 dark:text-slate-100' : 'text-slate-500 dark:text-slate-500' %>">
              <%= achievement.name %>
            </h3>

            <!-- Description -->
            <p class="text-xs leading-relaxed <%= earned ? 'text-slate-500 dark:text-slate-400' : 'text-slate-400 dark:text-slate-600' %>">
              <%= achievement.description %>
            </p>

            <% unless earned %>
              <div class="mt-2 text-[10px] font-medium text-slate-400 bg-slate-200/50 dark:bg-slate-800 px-2 py-1 rounded-full">
                未獲得
              </div>
            <% end %>
          </div>

          <!-- Shine Effect for Earned -->
          <% if earned %>
            <div class="absolute inset-0 rounded-2xl bg-gradient-to-tr from-white/0 via-white/20 to-white/0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 pointer-events-none"></div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
</file>

<file path="app/views/admin/users/index.html.erb">
<div class="bg-white dark:bg-slate-800 shadow rounded-lg overflow-hidden">
  <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
    <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
      <span class="material-symbols-outlined mr-2">group</span>
      ユーザー管理
    </h2>
    <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded dark:bg-blue-200 dark:text-blue-800">
      全 <%= @users.total_count %> 名
    </span>
  </div>

  <!-- 検索・フィルタフォーム -->
  <div class="px-6 py-4 bg-gray-50 dark:bg-slate-700/50 border-b border-gray-200 dark:border-gray-700">
    <%= form_with url: admin_users_path, method: :get, class: "flex flex-wrap gap-4 items-center", local: true do |f| %>
      <!-- キーワード検索 -->
      <div class="flex-1 min-w-[200px]">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <span class="material-symbols-outlined text-gray-400">search</span>
          </div>
          <%= f.text_field :q, value: params[:q], placeholder: "名前またはメールアドレスで検索...", class: "pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
        </div>
      </div>

      <!-- 権限フィルタ -->
      <div class="w-40">
        <%= f.select :role, User.roles.keys.map { |k| [k == 'admin' ? '管理者' : '一般', k] }, { include_blank: '全ての権限', selected: params[:role] }, { class: "block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" } %>
      </div>

      <!-- 検索ボタン -->
      <%= f.button type: :submit, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
        検索
      <% end %>

      <!-- クリアボタン -->
      <% if params[:q].present? || params[:role].present? %>
        <%= link_to admin_users_path, class: "text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" do %>
          クリア
        <% end %>
      <% end %>
    <% end %>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
      <thead class="bg-gray-50 dark:bg-slate-700">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ID</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ユーザー</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">メールアドレス</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">権限</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
            <div class="flex items-center gap-2">
              <span>最終ログイン</span>
              <div class="flex gap-1">
                <%= link_to admin_users_path(q: params[:q], role: params[:role], sort: "last_login_desc"),
                    class: "hover:bg-gray-200 dark:hover:bg-gray-600 rounded p-0.5 transition-colors #{params[:sort] == 'last_login_desc' ? 'bg-blue-200 dark:bg-blue-700' : ''}",
                    title: "降順（新しい順）" do %>
                  <span class="material-symbols-outlined text-base">arrow_downward</span>
                <% end %>
                <%= link_to admin_users_path(q: params[:q], role: params[:role], sort: "last_login_asc"),
                    class: "hover:bg-gray-200 dark:hover:bg-gray-600 rounded p-0.5 transition-colors #{params[:sort] == 'last_login_asc' ? 'bg-blue-200 dark:bg-blue-700' : ''}",
                    title: "昇順（古い順）" do %>
                  <span class="material-symbols-outlined text-base">arrow_upward</span>
                <% end %>
              </div>
            </div>
          </th>
          <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">操作</th>
        </tr>
      </thead>
      <tbody class="bg-white dark:bg-slate-800 divide-y divide-gray-200 dark:divide-gray-700">
        <% @users.each do |user| %>
          <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
              <%= user.id %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <%= user_avatar(user, classes: "h-10 w-10 rounded-full") %>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900 dark:text-white">
                    <%= user.name %>
                  </div>
                  <% if user.google_uid.present? %>
                    <div class="text-xs text-gray-500 flex items-center mt-0.5">
                      <span class="material-symbols-outlined text-[14px] mr-0.5 text-blue-500">check_circle</span>
                      Google連携
                    </div>
                  <% end %>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
              <%= user.email %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% if user.admin? %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                  管理者
                </span>
              <% else %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                  一般
                </span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
              <%= time_ago_in_words_game_style(user.current_sign_in_at) %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <% unless user == current_user %>
                <%= button_to admin_user_path(user), method: :delete, data: { turbo_confirm: "本当に削除しますか？\nこの操作は取り消せません。" }, class: "text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 flex items-center justify-end ml-auto" do %>
                  <span class="material-symbols-outlined mr-1">delete</span>
                  削除
                <% end %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
    <%= paginate @users %>
  </div>
</div>
</file>

<file path="app/views/admin/walks/index.html.erb">
<div class="bg-white dark:bg-slate-800 shadow rounded-lg overflow-hidden">
  <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
    <h2 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
      <span class="material-symbols-outlined mr-2">footprint</span>
      散歩記録管理
    </h2>
    <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded dark:bg-blue-200 dark:text-blue-800">
      全 <%= @walks.total_count %> 件
    </span>
  </div>

  <!-- 検索・フィルタフォーム -->
  <div class="px-6 py-4 bg-gray-50 dark:bg-slate-700/50 border-b border-gray-200 dark:border-gray-700">
    <%= form_with url: admin_walks_path, method: :get, class: "space-y-4", local: true do |f| %>
      <div class="flex flex-wrap gap-4 items-end">
        <!-- キーワード検索 -->
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ユーザー名</label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <span class="material-symbols-outlined text-gray-400">search</span>
            </div>
            <%= f.text_field :q, value: params[:q], placeholder: "ユーザー名で検索...", class: "pl-10 block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
          </div>
        </div>

        <!-- 距離範囲 -->
        <div class="w-32">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">最小距離(km)</label>
          <%= f.number_field :min_distance, value: params[:min_distance], placeholder: "1", class: "block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
        </div>

        <div class="w-32">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">最大距離(km)</label>
          <%= f.number_field :max_distance, value: params[:max_distance], placeholder: "50", class: "block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
        </div>

        <!-- 日付範囲 -->
        <div class="w-40">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">開始日</label>
          <%= f.date_field :start_date, value: params[:start_date], class: "block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
        </div>

        <div class="w-40">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">終了日</label>
          <%= f.date_field :end_date, value: params[:end_date], class: "block w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-slate-800 text-gray-900 dark:text-white focus:ring-blue-500 focus:border-blue-500 sm:text-sm" %>
        </div>

        <!-- 検索ボタン -->
        <%= f.button type: :submit, class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
          検索
        <% end %>

        <!-- クリアボタン -->
        <% if params[:q].present? || params[:min_distance].present? || params[:max_distance].present? || params[:start_date].present? || params[:end_date].present? %>
          <%= link_to admin_walks_path, class: "text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" do %>
            クリア
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
      <thead class="bg-gray-50 dark:bg-slate-700">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ID</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ユーザー</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">日付</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">距離</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">歩数</th>
          <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">操作</th>
        </tr>
      </thead>
      <tbody class="bg-white dark:bg-slate-800 divide-y divide-gray-200 dark:divide-gray-700">
        <% @walks.each do |walk| %>
          <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
              <%= walk.id %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <%= user_avatar(walk.user, classes: "h-10 w-10 rounded-full") %>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900 dark:text-white">
                    <%= walk.user.name %>
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
              <%= l walk.walked_on, format: :long %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <% if walk.distance > 50 %>
                <span class="text-red-600 dark:text-red-400 font-bold">
                  <%= number_with_delimiter(walk.distance) %>km
                </span>
              <% else %>
                <span class="text-gray-900 dark:text-white">
                  <%= number_with_delimiter(walk.distance) %>km
                </span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <% if walk.steps && walk.steps > 100000 %>
                <span class="text-red-600 dark:text-red-400 font-bold">
                  <%= number_with_delimiter(walk.steps) %>歩
                </span>
              <% elsif walk.steps %>
                <span class="text-gray-900 dark:text-white">
                  <%= number_with_delimiter(walk.steps) %>歩
                </span>
              <% else %>
                <span class="text-gray-400 dark:text-gray-500">-</span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
              <%= link_to admin_walk_path(walk), class: "text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 inline-flex items-center" do %>
                <span class="material-symbols-outlined text-sm mr-1">visibility</span>
                詳細
              <% end %>
              <%= button_to admin_walk_path(walk), method: :delete, data: { turbo_confirm: "本当に削除しますか？\nこの操作は取り消せません。" }, class: "text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 inline-flex items-center" do %>
                <span class="material-symbols-outlined text-sm mr-1">delete</span>
                削除
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
    <%= paginate @walks %>
  </div>
</div>
</file>

<file path="app/views/login_stamps/index.html.erb">
<% content_for :title, "てくメモ - ログインスタンプ" %>

<div class="flex-1 p-4 pb-24 w-full max-w-2xl mx-auto space-y-6">
  <!-- ページヘッダー -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center space-x-2">
        <span class="material-symbols-outlined text-3xl text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-cyan-500 dark:text-cyan-400 drop-shadow-sm dark:drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]">calendar_month</span>
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-gray-800 to-gray-600 dark:from-cyan-300 dark:to-purple-400 drop-shadow-sm">てくてくスタンプ</span>
      </h1>
      <p class="text-sm text-gray-500 dark:text-slate-400 mt-1 ml-1">日々の積み重ねを可視化しましょう</p>
    </div>
  </div>

  <!-- 統計情報 -->
  <div class="grid grid-cols-2 gap-3 sm:gap-4">
    <!-- 今月の散歩日数 -->
    <!-- 今月の散歩日数 -->
    <div class="relative overflow-hidden rounded-[2.5rem] p-5 flex flex-col justify-between h-full transition-transform duration-300 hover:scale-[1.02] group
                bg-[#fdfbf7] dark:bg-slate-900/90
                shadow-[20px_20px_60px_rgba(6,182,212,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(6,182,212,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(6,182,212,0.3)]
                dark:shadow-[0_0_15px_rgba(6,182,212,0.2)] dark:border dark:border-cyan-500/30">

      <!-- Candy Texture (Light Mode) -->
      <div class="absolute inset-0 bg-gradient-to-br from-white/80 via-white/40 to-transparent pointer-events-none dark:hidden"></div>
      <div class="absolute -top-10 -right-10 w-32 h-32 bg-gradient-to-br from-cyan-400/20 to-blue-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

      <!-- Dark Mode Decoration -->
      <div class="absolute top-0 right-0 -mr-4 -mt-4 w-20 h-20 bg-cyan-500/10 rounded-full blur-xl pointer-events-none hidden dark:block"></div>

      <!-- Month Badge (Responsive Position) -->
      <div class="flex items-center space-x-1 sm:space-x-2 mb-1 sm:mb-2 relative z-10 mt-1">
        <span class="material-symbols-outlined text-cyan-500 dark:text-cyan-400 drop-shadow-sm text-2xl sm:text-2xl">event_available</span>
        <h3 class="font-bold text-slate-700 dark:text-cyan-100 text-sm sm:text-base whitespace-nowrap">てくてく日数</h3>
      </div>
      <div class="flex items-end justify-between relative z-10">
        <p class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-500 dark:text-cyan-300 dark:drop-shadow-[0_0_5px_rgba(34,211,238,0.5)]">
          <%= @monthly_walk_count %><span class="text-base ml-1 font-bold text-slate-400 dark:text-cyan-400">日</span>
        </p>
        <span class="text-[10px] sm:text-xs font-bold text-cyan-600 dark:text-cyan-300 bg-white/60 dark:bg-cyan-900/40 px-2 py-0.5 rounded-full backdrop-blur-sm border border-cyan-100 dark:border-cyan-500/30 shadow-sm mb-1">
          <%= @start_date.month %>月
        </span>
      </div>
    </div>

    <!-- 連続日数 -->
    <!-- 連続日数 -->
    <div class="relative overflow-hidden rounded-[2.5rem] p-5 flex flex-col justify-between h-full transition-transform duration-300 hover:scale-[1.02] group
                bg-[#fdfbf7] dark:bg-slate-900/90
                shadow-[20px_20px_60px_rgba(244,63,94,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(244,63,94,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(244,63,94,0.3)]
                dark:shadow-[0_0_15px_rgba(192,38,211,0.2)] dark:border dark:border-fuchsia-500/30">

      <!-- Candy Texture (Light Mode) -->
      <div class="absolute inset-0 bg-gradient-to-br from-white/80 via-white/40 to-transparent pointer-events-none dark:hidden"></div>
      <div class="absolute -top-10 -right-10 w-32 h-32 bg-gradient-to-br from-orange-400/20 to-pink-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

      <!-- Dark Mode Decoration -->
      <div class="absolute top-0 right-0 -mr-4 -mt-4 w-20 h-20 bg-fuchsia-500/10 rounded-full blur-xl pointer-events-none hidden dark:block"></div>

      <div class="flex items-center justify-between mb-2 relative z-10 p-1">
        <div class="flex items-center space-x-1 sm:space-x-2">
          <span class="material-symbols-outlined text-rose-500 dark:text-fuchsia-400 drop-shadow-sm text-2xl sm:text-2xl">local_fire_department</span>
          <h3 class="font-bold text-slate-700 dark:text-fuchsia-100 text-sm sm:text-base whitespace-nowrap">連続</h3>
        </div>
      </div>
      <p class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-pink-500 dark:text-fuchsia-300 dark:drop-shadow-[0_0_5px_rgba(232,121,249,0.5)] relative z-10">
        <%= @consecutive_days %><span class="text-base ml-1 font-bold text-slate-400 dark:text-fuchsia-400">日</span>
      </p>
    </div>
  </div>

  <!-- カレンダー -->
  <div class="relative bg-[#fdfbf7] dark:bg-slate-950/80 backdrop-blur-xl rounded-[3.75rem] p-8 transition-colors overflow-hidden border-2 border-white/60 dark:border-cyan-500/20
              shadow-[20px_20px_60px_rgba(168,85,247,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(168,85,247,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(168,85,247,0.3)]
              dark:shadow-[0_0_20px_rgba(6,182,212,0.15)]">

    <!-- Candy Texture & Orbs (Light Mode) -->
    <div class="absolute inset-0 bg-gradient-to-br from-white/80 via-white/40 to-transparent pointer-events-none dark:hidden"></div>
    <div class="absolute -top-20 -right-20 w-64 h-64 bg-gradient-to-br from-purple-400/20 to-pink-400/20 rounded-full blur-3xl pointer-events-none dark:hidden"></div>
    <div class="absolute -bottom-20 -left-20 w-64 h-64 bg-gradient-to-tr from-blue-400/20 to-cyan-400/20 rounded-full blur-3xl pointer-events-none dark:hidden"></div>

    <!-- 装飾用背景 (Dark Mode) -->
    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 dark:from-cyan-500 dark:via-blue-500 dark:to-purple-500 dark:shadow-[0_0_10px_rgba(34,211,238,0.5)] hidden dark:block"></div>

    <!-- 月ナビゲーション -->
    <div class="flex justify-center items-center space-x-6 mb-6 mt-2">
      <!-- 前月ボタン -->
      <%= link_to login_stamps_path(start_date: @start_date - 1.month),
          class: "flex items-center justify-center w-10 h-10 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-cyan-900/30 text-gray-600 dark:text-cyan-400 hover:text-blue-600 dark:hover:text-cyan-300 transition-all duration-200 shadow-[inset_2px_2px_5px_rgba(255,255,255,0.8),inset_-2px_-2px_5px_rgba(0,0,0,0.05)] hover:shadow-md dark:shadow-sm dark:border dark:border-cyan-500/20 relative z-10" do %>
        <span class="material-symbols-outlined">chevron_left</span>
      <% end %>

      <!-- 現在の月を表示 -->
      <h2 class="text-xl sm:text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 dark:from-cyan-300 dark:to-purple-400 tracking-tight dark:drop-shadow-[0_0_5px_rgba(34,211,238,0.3)] whitespace-nowrap">
        <%= @start_date.strftime("%Y年%m月") %>
      </h2>

      <!-- 次月ボタン -->
      <%= link_to login_stamps_path(start_date: @start_date + 1.month),
          class: "flex items-center justify-center w-10 h-10 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-white dark:hover:bg-cyan-900/30 text-gray-600 dark:text-cyan-400 hover:text-blue-600 dark:hover:text-cyan-300 transition-all duration-200 shadow-[inset_2px_2px_5px_rgba(255,255,255,0.8),inset_-2px_-2px_5px_rgba(0,0,0,0.05)] hover:shadow-md dark:shadow-sm dark:border dark:border-cyan-500/20 flex-shrink-0 relative z-10" do %>
        <span class="material-symbols-outlined">chevron_right</span>
      <% end %>
    </div>

    <!-- カレンダー本体 -->
    <div class="calendar-container relative z-10">
      <%= month_calendar(attribute: :walked_on, start_date: @start_date, events: @walks, week_start: :sunday) do |date, walks| %>
        <%
          has_stamp = @walks_by_date[date].present?
          is_today = date == Date.current
          is_other_month = date.month != @start_date.month

          classes = ["calendar-day"]
          classes << "has-stamp" if has_stamp
          classes << "today" if is_today
          classes << "other-month" if is_other_month
        %>
        <div class="<%= classes.join(' ') %> group relative">
          <!-- 日付（左上に配置） -->
          <div class="date-number absolute top-1 left-1 z-20">
            <%= date.day %>
          </div>

          <!-- スタンプアイコン（スタンプがある場合のみ、中央に大きく） -->
          <% if has_stamp %>
            <div class="stamp-icon absolute inset-0 flex items-center justify-center z-10 pointer-events-none">
              <span class="material-symbols-outlined text-4xl sm:text-5xl transform rotate-12 scale-110 select-none transition-all duration-300 animate-pulse">pets</span>
            </div>
          <% elsif is_today %>
            <!-- 今日でスタンプがない場合、「今日」と表示 -->
            <div class="absolute inset-0 flex items-center justify-center z-10 pointer-events-none">
              <span class="text-sm sm:text-xl font-bold text-blue-500/30 dark:text-cyan-400/60 select-none tracking-wider">今日</span>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- カレンダーの見方 -->
  <div class="bg-gray-50/80 dark:bg-slate-900/50 border border-gray-200 dark:border-cyan-500/20 rounded-2xl p-4 transition-colors backdrop-blur-sm">
    <div class="flex items-start space-x-3">
      <div class="bg-blue-100 dark:bg-cyan-900/30 p-2 rounded-full flex-shrink-0">
        <span class="material-symbols-outlined text-blue-500 dark:text-cyan-400 text-xl">info</span>
      </div>
      <div class="flex-1 pt-1 overflow-hidden">
        <h3 class="font-bold text-gray-900 dark:text-cyan-100 mb-3 text-sm whitespace-nowrap">カレンダーの見方</h3>
        <div class="grid grid-cols-2 gap-2 sm:gap-3">
          <div class="flex items-center space-x-1 sm:space-x-2">
            <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-orange-400 to-pink-500 dark:text-fuchsia-400 shadow-sm flex items-center justify-center flex-shrink-0">
              <span class="material-symbols-outlined text-white text-xs">pets</span>
            </div>
            <span class="text-[10px] sm:text-xs text-gray-600 dark:text-slate-400 whitespace-nowrap">散歩記録あり</span>
          </div>
          <div class="flex items-center space-x-1 sm:space-x-2">
            <div class="w-6 h-6 rounded-lg border-2 border-blue-400 dark:border-cyan-400 flex items-center justify-center flex-shrink-0">
              <span class="text-[10px] font-bold text-blue-500 dark:text-cyan-400">今日</span>
            </div>
            <span class="text-[10px] sm:text-xs text-gray-600 dark:text-slate-400 whitespace-nowrap">今日の日付</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- カレンダー用のスタイル -->
<style>
  /* カレンダー全体のコンテナ */
  .calendar-container {
    overflow-x: hidden; /* 横スクロール防止 */
    padding-bottom: 4px;
  }

  /* simple_calendarのデフォルトヘッダーを非表示 */
  .simple-calendar .calendar-heading {
    display: none;
  }

  /* simple_calendarのテーブルスタイル */
  .simple-calendar {
    width: 100%;
  }

  .simple-calendar table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 4px;
    table-layout: fixed;
  }

  /* テーブルヘッダー（曜日） */
  .simple-calendar thead th {
    padding: 0.75rem 0.25rem;
    text-align: center;
    font-weight: 700;
    font-size: 0.8rem;
    color: #6B7280;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .dark .simple-calendar thead th {
    color: #94a3b8;
  }

  /* 日曜・土曜の色 */
  .simple-calendar thead th:first-child { color: #EF4444; }
  .dark .simple-calendar thead th:first-child { color: #F87171; }
  .simple-calendar thead th:last-child { color: #3B82F6; }
  .dark .simple-calendar thead th:last-child { color: #60A5FA; }

  /* カレンダーのセル（td） */
  .simple-calendar td {
    padding: 0;
    border: none;
    height: 80px;
    vertical-align: top;
    background-color: transparent;
  }

  /* カレンダーの日付セルの中身（.calendar-day） */
  .calendar-day {
    width: 100%;
    height: 100%;
    display: block; /* flexからblockに変更（絶対配置を使うため） */
    border-radius: 1.5rem;
    background-color: rgba(255, 255, 255, 0.5);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    border: 2px solid transparent;
    box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05), inset -2px -2px 5px rgba(255,255,255,0.8);
    backdrop-filter: blur(4px);
  }

  .dark .calendar-day {
    background-color: rgba(15, 23, 42, 0.6);
    border-color: rgba(34, 211, 238, 0.1);
  }

  /* ホバーエフェクト */
  .calendar-day:not(.other-month):hover {
    background-color: rgba(255, 255, 255, 0.8);
    transform: translateY(-2px);
    box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.05), -5px -5px 10px rgba(255, 255, 255, 0.9);
    border-color: rgba(255, 255, 255, 0.5);
  }

  .dark .calendar-day:not(.other-month):hover {
    background-color: rgba(8, 145, 178, 0.2);
    border-color: rgba(34, 211, 238, 0.4);
    box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);
  }

  /* スタンプがある日（背景は控えめに、スタンプを目立たせる） */
  /* スタンプがある日（背景は控えめに、スタンプを目立たせる） */
  .calendar-day.has-stamp {
    background-color: #fff7ed; /* Orange-50 */
    border: 2px solid rgba(255, 255, 255, 0.6);
    box-shadow: 5px 5px 10px rgba(249,115,22,0.15), -5px -5px 10px rgba(255,255,255,0.9);
  }

  .dark .calendar-day.has-stamp {
    background-color: rgba(112, 26, 117, 0.2); /* Fuchsia-900/20 */
    border: 1px solid rgba(232, 121, 249, 0.3); /* Fuchsia-400/30 */
    box-shadow: 0 0 15px rgba(232, 121, 249, 0.15);
  }

  /* スタンプアイコンのスタイル */
  .stamp-icon .material-symbols-outlined {
    /* ライトモード: オレンジ〜ピンクのグラデーションテキスト */
    background: linear-gradient(135deg, #FB923C, #EC4899); /* Orange-400 to Pink-500 */
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(2px 4px 6px rgba(236, 72, 153, 0.4));
    opacity: 1;
  }

  .dark .stamp-icon .material-symbols-outlined {
    /* ダークモード: ネオン発光 */
    background: none;
    -webkit-background-clip: border-box;
    -webkit-text-fill-color: #e879f9; /* Fuchsia-400 */
    color: #e879f9;
    filter: drop-shadow(0 0 8px rgba(232, 121, 249, 0.8)) drop-shadow(0 0 15px rgba(192, 38, 211, 0.6));
    opacity: 1;
  }

  /* 今日の日付（枠線で強調） */
  .calendar-day.today {
    background-color: #EFF6FF;
    border: 2px solid #60A5FA;
  }

  .dark .calendar-day.today {
    background-color: rgba(15, 23, 42, 0.8);
    border-color: #22d3ee;
    box-shadow: 0 0 10px rgba(34, 211, 238, 0.2);
  }

  /* 他の月の日付 */
  .calendar-day.other-month {
    background-color: transparent;
    opacity: 0.4;
  }

  /* 日付の数字 */
  .date-number {
    font-size: 0.75rem;
    font-weight: 700;
    color: #9CA3AF; /* Gray-400 */
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 9999px;
    background-color: rgba(255, 255, 255, 0.8); /* 数字の背景を少し白くして視認性確保 */
    backdrop-filter: blur(2px);
  }

  .dark .date-number {
    color: #94a3b8; /* Slate-400 */
    background-color: rgba(15, 23, 42, 0.6);
  }

  /* 今日の日付数字 */
  .calendar-day.today .date-number {
    color: #2563EB;
    background-color: #DBEAFE;
  }

  .dark .calendar-day.today .date-number {
    color: #22d3ee;
    background-color: rgba(6, 182, 212, 0.2);
  }

  /* スタンプがある日の日付数字（少し色をつける） */
  .calendar-day.has-stamp .date-number {
    color: #EA580C; /* Orange-600 */
  }

  .dark .calendar-day.has-stamp .date-number {
    color: #f0abfc; /* Fuchsia-300 */
  }

  /* モバイル対応 */
  @media (max-width: 640px) {
    .simple-calendar table {
      border-spacing: 2px; /* 間隔を狭める */
    }
    .simple-calendar td {
      height: 56px; /* 高さを小さく */
    }
    .calendar-day {
      border-radius: 0.5rem; /* 角丸を少し小さく */
    }
    .date-number {
      font-size: 0.65rem;
      width: 1.1rem;
      height: 1.1rem;
      top: 2px;
      left: 2px;
    }
    .stamp-icon .material-symbols-outlined {
      font-size: 2rem; /* アイコンサイズ調整 */
    }
    /* 今日の文字サイズ調整はHTML側のクラスで行う */
  }
</style>
</file>

<file path="db/migrate/20251217225031_create_active_storage_tables.active_storage.rb">
# This migration comes from active_storage (originally 20170806125915)
class CreateActiveStorageTables < ActiveRecord::Migration[7.0]
  def change
    # Use Active Record's configured type for primary and foreign keys
    primary_key_type, foreign_key_type = primary_and_foreign_key_types

    create_table :active_storage_blobs, id: primary_key_type do |t|
      t.string   :key,          null: false
      t.string   :filename,     null: false
      t.string   :content_type
      t.text     :metadata
      t.string   :service_name, null: false
      t.bigint   :byte_size,    null: false
      t.string   :checksum

      if connection.supports_datetime_with_precision?
        t.datetime :created_at, precision: 6, null: false
      else
        t.datetime :created_at, null: false
      end

      t.index [ :key ], unique: true
    end

    create_table :active_storage_attachments, id: primary_key_type do |t|
      t.string     :name,     null: false
      t.references :record,   null: false, polymorphic: true, index: false, type: foreign_key_type
      t.references :blob,     null: false, type: foreign_key_type

      if connection.supports_datetime_with_precision?
        t.datetime :created_at, precision: 6, null: false
      else
        t.datetime :created_at, null: false
      end

      t.index [ :record_type, :record_id, :name, :blob_id ], name: :index_active_storage_attachments_uniqueness, unique: true
      t.foreign_key :active_storage_blobs, column: :blob_id
    end

    create_table :active_storage_variant_records, id: primary_key_type do |t|
      t.belongs_to :blob, null: false, index: false, type: foreign_key_type
      t.string :variation_digest, null: false

      t.index [ :blob_id, :variation_digest ], name: :index_active_storage_variant_records_uniqueness, unique: true
      t.foreign_key :active_storage_blobs, column: :blob_id
    end
  end

  private
    def primary_and_foreign_key_types
      config = Rails.configuration.generators
      setting = config.options[config.orm][:primary_key_type]
      primary_key_type = setting || :primary_key
      foreign_key_type = setting || :bigint
      [ primary_key_type, foreign_key_type ]
    end
end
</file>

<file path="db/migrate/20251222200143_add_avatar_type_to_users.rb">
class AddAvatarTypeToUsers < ActiveRecord::Migration[7.2]
  def up
    add_column :users, :avatar_type, :integer, default: 0, null: false

    # 既存データの移行
    # use_google_avatar: true -> avatar_type: 1 (google)
    # use_google_avatar: false -> avatar_type: 0 (default)
    User.reset_column_information
    User.find_each do |user|
      # use_google_avatarカラムが存在し、かつtrueの場合のみ更新
      # （falseの場合はデフォルトの0でOKなのでスキップ可能だが、念のため明示的に）
      new_type = user.use_google_avatar ? 1 : 0
      user.update_columns(avatar_type: new_type)
    end

    remove_column :users, :use_google_avatar
  end

  def down
    add_column :users, :use_google_avatar, :boolean, default: true

    User.reset_column_information
    User.find_each do |user|
      # avatar_type: 1 (google) -> use_google_avatar: true
      # その他 -> use_google_avatar: false
      is_google = (user.avatar_type == 1)
      user.update_columns(use_google_avatar: is_google)
    end

    remove_column :users, :avatar_type
  end
end
</file>

<file path="db/migrate/20251223060248_create_initial_announcements.rb">
class CreateInitialAnnouncements < ActiveRecord::Migration[7.2]
  def up
    announcements = [
      {
        title: "統計・グラフ機能の実装",
        content: "日々の歩数や消費カロリーをグラフで確認できるようになりました。過去のデータと比較して、モチベーション維持に役立ててください。",
        published_at: Time.zone.parse("2025-12-15 10:00:00"),
        announcement_type: "info"
      },
      {
        title: "OGP設定とSNSシェア機能の実装",
        content: "散歩の記録やランキング結果をSNSでシェアできるようになりました。RPG風のカード画像が自動生成されます。",
        published_at: Time.zone.parse("2025-12-17 10:00:00"),
        announcement_type: "info"
      },
      {
        title: "ライトモードとダークモードのデザイン刷新",
        content: "画面のデザインを大幅にリニューアルしました。ライトモードは「Crystal Claymorphism」、ダークモードは「Holographic Neon Noir」をテーマに、より美しく使いやすいUIになりました。",
        published_at: Time.zone.parse("2025-12-20 10:00:00"),
        announcement_type: "info"
      },
      {
        title: "Google Fit連携に一括取込機能を実装",
        content: "Google Fitからのデータ連携を強化し、過去のデータを一括で取り込めるようになりました。設定画面から連携を行うことで利用可能です。",
        published_at: Time.zone.parse("2025-12-22 10:00:00"),
        announcement_type: "info"
      },
      {
        title: "アイコンのアップロード機能の実装",
        content: "プロフィールアイコンを自由にアップロードできるようになりました。お気に入りの画像を設定して、ランキングや投稿で個性をアピールしましょう。",
        published_at: Time.zone.parse("2025-12-23 10:00:00"),
        announcement_type: "info"
      }
    ]

    announcements.each do |data|
      # 重複作成を防ぐため、同じタイトルのデータがない場合のみ作成
      unless Announcement.exists?(title: data[:title])
        Announcement.create!(
          title: data[:title],
          content: data[:content],
          published_at: data[:published_at],
          announcement_type: data[:announcement_type],
          expires_at: nil # 無期限
        )
      end
    end
  end

  def down
    # ロールバック時は今回追加したデータを削除
    titles = [
      "統計・グラフ機能の実装",
      "OGP設定とSNSシェア機能の実装",
      "ライトモードとダークモードのデザイン刷新",
      "Google Fit連携に一括取込機能を実装",
      "アイコンのアップロード機能の実装"
    ]
    Announcement.where(title: titles).destroy_all
  end
end
</file>

<file path="db/migrate/20251223064230_create_achievements.rb">
class CreateAchievements < ActiveRecord::Migration[7.2]
  def change
    create_table :achievements do |t|
      t.string :name, null: false
      t.text :description, null: false
      t.integer :condition_type, null: false, default: 0
      t.integer :condition_value, null: false, default: 0
      t.string :icon_name, null: false

      t.timestamps
    end
  end
end
</file>

<file path="db/migrate/20251223064232_create_user_achievements.rb">
class CreateUserAchievements < ActiveRecord::Migration[7.2]
  def change
    create_table :user_achievements do |t|
      t.references :user, null: false, foreign_key: true
      t.references :achievement, null: false, foreign_key: true


      t.index [:user_id, :achievement_id], unique: true
      t.timestamps
    end
  end
end
</file>

<file path="db/seeds.rb">
# db/seeds.rb

# 0. 実績マスターデータ作成
puts "Creating achievements..."
achievements_data = [
  { name: "初めの一歩", description: "初めて歩数を記録した", condition_type: :total_steps, condition_value: 1, icon_name: "footprint" },
  { name: "ウォーキングビギナー", description: "累計10,000歩を達成した", condition_type: :total_steps, condition_value: 10000, icon_name: "directions_walk" },
  { name: "ウォーキングマスター", description: "累計100,000歩を達成した", condition_type: :total_steps, condition_value: 100000, icon_name: "hiking" },
  { name: "マラソンランナー", description: "累計42kmを達成した", condition_type: :total_distance, condition_value: 42, icon_name: "sports_score" },
  { name: "地球一周", description: "累計40,000kmを達成した", condition_type: :total_distance, condition_value: 40000, icon_name: "public" },
  { name: "三日坊主卒業", description: "3日連続でログインした", condition_type: :login_streak, condition_value: 3, icon_name: "history" },
  { name: "習慣化の達人", description: "30日連続でログインした", condition_type: :login_streak, condition_value: 30, icon_name: "calendar_month" },
  { name: "初めての投稿", description: "初めて日記を投稿した", condition_type: :post_count, condition_value: 1, icon_name: "edit_note" },
  { name: "日記職人", description: "日記を10回投稿した", condition_type: :post_count, condition_value: 10, icon_name: "library_books" }
]

achievements_data.each do |data|
  Achievement.find_or_create_by!(name: data[:name]) do |a|
    a.description = data[:description]
    a.condition_type = data[:condition_type]
    a.condition_value = data[:condition_value]
    a.icon_name = data[:icon_name]
  end
end

# 1. キャラクター設定（20人）
CHARACTERS = [
  { name: "竈門炭治郎", email: "user1@example.com", quotes: [ "頑張れ炭治郎頑張れ！", "俺は長男だから我慢できたけど次男だったら我慢できなかった。", "心を燃やせ！" ] },
  { name: "うずまきナルト", email: "user2@example.com", quotes: [ "まっすぐ自分の言葉は曲げねぇ。それが俺の忍道だ！", "俺は火影になる男だ！", "だってばよ！" ] },
  { name: "モンキー・D・ルフィ", email: "user3@example.com", quotes: [ "海賊王に俺はなる！", "当たり前だ！！！！！", "腹減った〜！" ] },
  { name: "エドワード・エルリック", email: "user4@example.com", quotes: [ "立てよド三流。オレ達とおまえとの格の違いってやつを見せてやる！", "等価交換だ！", "降りてこいよド三流！" ] },
  { name: "孫悟空", email: "user5@example.com", quotes: [ "オッス！オラ悟空！", "クリリンのことかーっ！！！！！", "ワクワクすっぞ！" ] },
  { name: "アーニャ・フォージャー", email: "user6@example.com", quotes: [ "アーニャ、ピーナッツが好き。", "わくわく！", "ちち、はは、仲良し！" ] },
  { name: "フリーレン", email: "user7@example.com", quotes: [ "ヒンメルならそうした。", "人の心を知る旅に出ることにしたの。", "魔法を集めるのが趣味だからね。" ] },
  { name: "木之本桜", email: "user8@example.com", quotes: [ "絶対だいじょうぶだよ。", "汝のあるべき姿に戻れ！クロウカード！", "ほえ〜！" ] },
  { name: "月野うさぎ", email: "user9@example.com", quotes: [ "月にかわっておしおきよ！", "愛と正義のセーラー服美少女戦士、セーラームーン！", "まもちゃん！" ] },
  { name: "鹿目まどか", email: "user10@example.com", quotes: [ "クラスのみんなには内緒だよ！", "私、魔法少女になる。", "もう何も怖くない。" ] },
  { name: "五条悟", email: "user11@example.com", quotes: [ "大丈夫、僕最強だから。", "領域展開、無量空処。", "少し乱暴しようか。" ] },
  { name: "ロイド・フォージャー", email: "user12@example.com", quotes: [ "黄昏だ。", "スマートにこなすのが私の流儀だ。", "アーニャ、勉強の時間だ。" ] },
  { name: "ヨル・フォージャー", email: "user13@example.com", quotes: [ "息の根を止めて差し上げます。", "私、殺し屋ですので。", "ロイドさん、素敵です！" ] },
  { name: "工藤新一", email: "user14@example.com", quotes: [ "真実はいつもひとつ！", "バーロー。", "推理に勝ったも負けたも、上も下もねーよ。" ] },
  { name: "毛利蘭", email: "user15@example.com", quotes: [ "新一のバカ！", "もう、どこ行ってたのよ！", "空手なら負けないわよ。" ] },
  { name: "キリト", email: "user16@example.com", quotes: [ "スターバースト・ストリーム！", "俺はビーターだ。", "アスナは俺が守る。" ] },
  { name: "アスナ", email: "user17@example.com", quotes: [ "キリト君は私が守る。", "閃光のアスナよ。", "一緒に頑張ろうね。" ] },
  { name: "坂田銀時", email: "user18@example.com", quotes: [ "糖分が足りねぇ。", "万事屋銀ちゃんのお通りだ！", "ジャンプ読むの忙しいんだよ。" ] },
  { name: "神楽", email: "user19@example.com", quotes: [ "酢昆布よこすアル。", "定春、噛み付くアル！", "銀ちゃん、お腹空いたネ。" ] },
  { name: "志摩リン", email: "user20@example.com", quotes: [ "買っちった。", "焚き火、いいなぁ。", "ソロキャン最高。" ] }
]

# ランダムな日本の市
CITIES = [ "札幌市", "仙台市", "さいたま市", "千葉市", "横浜市", "川崎市", "相模原市", "新潟市", "静岡市", "浜松市", "名古屋市", "京都市", "大阪市", "堺市", "神戸市", "岡山市", "広島市", "北九州市", "福岡市", "熊本市" ]

puts "Start seeding..."

# 全ユーザーを先に確保（リアクション用）
users = []
CHARACTERS.each do |char_data|
  user = User.find_or_create_by!(email: char_data[:email]) do |u|
    u.name = char_data[:name]
    u.password = "password"
    u.password_confirmation = "password"
  end
  users << user
end

# 各ユーザーについてデータ作成
users.each_with_index do |user, index|
  char_data = CHARACTERS[index]
  puts "Processing user: #{user.name}"

  # ---------------------------------------------------------
  # A. 過去30日分 + 今日 (0..30)
  # ---------------------------------------------------------
  (0..30).each do |day|
    date = Date.today - day.days

    # 既にその日の記録があればスキップ（重複防止）
    next if user.walks.exists?(walked_on: date)

    # 今日(day=0)は100%、それ以外は60%の確率で歩く
    probability = day == 0 ? 1.0 : 0.6
    next unless rand < probability

    # 距離: 0.1km 〜 0.6km のランダム
    distance = rand(0.1..0.6).round(2)

    # 歩数・時間・カロリー概算
    steps = (distance * 1300 * rand(0.9..1.1)).to_i
    duration = (distance * 15 * rand(0.9..1.1)).to_i
    calories = (distance * 50 * rand(0.9..1.1)).to_i

    # 作成時刻ランダム（今日の場合は現在時刻より前に限定）
    if day == 0
      # 今日の場合：現在時刻の1時間前〜24時間前の範囲でランダム
      hours_ago = rand(1..24)
      walk_time = Time.current - hours_ago.hours - rand(0..59).minutes
    else
      # 過去の日付：6時〜22時のランダムな時刻
      walk_time = date.to_time + rand(6..22).hours + rand(0..59).minutes
    end

    walk = user.walks.create!(
      walked_on: date,
      distance: distance,
      steps: steps,
      duration: duration,
      calories_burned: calories,
      location: CITIES.sample,
      created_at: walk_time,
      updated_at: walk_time
    )

    # SNS投稿（30%）
    if rand < 0.3
      pattern = [ :body_only, :weather_only, :feeling_only, :weather_feeling, :all ].sample
      body = nil
      weather = nil
      feeling = nil

      case pattern
      when :body_only
        body = char_data[:quotes].sample
      when :weather_only
        weather = Post.weathers.keys.sample
      when :feeling_only
        feeling = Post.feelings.keys.sample
      when :weather_feeling
        weather = Post.weathers.keys.sample
        feeling = Post.feelings.keys.sample
      when :all
        body = char_data[:quotes].sample
        weather = Post.weathers.keys.sample
        feeling = Post.feelings.keys.sample
      end

      # 投稿時刻は散歩時刻の10分〜2時間後（ただし現在時刻は超えない）
      max_post_delay = day == 0 ? [ (Time.current - walk_time - 1.minute).to_i / 60, 120 ].min : 120
      post_delay = rand(10..[ max_post_delay, 10 ].max).minutes
      post_time = walk_time + post_delay
      post = user.posts.create!(
        body: body,
        weather: weather,
        feeling: feeling,
        walk: walk,
        created_at: post_time,
        updated_at: post_time
      )

      # リアクション（3〜8人）
      users.sample(rand(3..8)).each do |reactor|
        next if reactor == user
        next if post.reactions.exists?(user: reactor)

        reaction_time = post_time + rand(1..180).minutes
        post.reactions.create!(
          user: reactor,
          kind: Reaction.kinds.keys.sample,
          created_at: reaction_time,
          updated_at: reaction_time
        )
      end
    end
  end

  # ---------------------------------------------------------
  # B. 未来7日分 (1..7) - 900m以下
  # ---------------------------------------------------------
  (1..7).each do |day_offset|
    date = Date.today + day_offset.days

    # 既にその日の記録があればスキップ
    next if user.walks.exists?(walked_on: date)

    # 距離: 0.1km 〜 0.6km のランダム
    distance = rand(0.1..0.6).round(2)

    steps = (distance * 1300 * rand(0.9..1.1)).to_i
    duration = (distance * 15 * rand(0.9..1.1)).to_i
    calories = (distance * 50 * rand(0.9..1.1)).to_i
    walk_time = date.to_time + rand(6..22).hours + rand(0..59).minutes

    user.walks.create!(
      walked_on: date,
      distance: distance,
      steps: steps,
      duration: duration,
      calories_burned: calories,
      location: CITIES.sample,
      created_at: walk_time,
      updated_at: walk_time
    )
  end
end


# 実績付与のシミュレーション
puts "Assigning achievements..."
all_achievements = Achievement.all
users.each do |user|
  # 累計歩数
  total_steps = user.walks.sum(:steps)
  # 累計距離
  total_distance = user.walks.sum(:distance)
  # 投稿数
  post_count = user.posts.count

  all_achievements.each do |achievement|
    earned = case achievement.condition_type.to_sym
    when :total_steps
      total_steps >= achievement.condition_value
    when :total_distance
      total_distance >= achievement.condition_value
    when :post_count
      post_count >= achievement.condition_value
    when :login_streak
      # シードデータではログイン履歴を厳密に作っていないのでランダムで付与
      rand < 0.5
    else
      false
    end

    if earned
      UserAchievement.find_or_create_by!(user: user, achievement: achievement)
    end
  end
end

puts "Seeding completed!"
</file>

<file path="lib/tasks/maintenance.rake">
namespace :maintenance do
  desc "Walkモデルのtime_of_dayカラムをcreated_atに基づいて再計算・更新する"
  task update_walk_time_of_day: :environment do
    puts "Starting update_walk_time_of_day..."

    updated_count = 0
    Walk.find_each do |walk|
      # created_at または walked_on から時間を推定
      # walked_on は日付のみなので、created_at がない場合はデフォルト(早朝)にするか、スキップするか
      target_time = walk.created_at || Time.zone.parse("#{walk.walked_on} 00:00:00")

      hour = target_time.hour
      new_time_of_day = case hour
      when 4..8 then :early_morning
      when 9..15 then :day
      when 16..18 then :evening
      else :night
      end

      # 値が異なる場合のみ更新
      if walk.time_of_day != new_time_of_day.to_s
        walk.update_column(:time_of_day, Walk.time_of_days[new_time_of_day])
        updated_count += 1
      end
    end

    puts "Finished! Updated #{updated_count} walks."
  end
end
</file>

<file path="spec/factories/achievements.rb">
FactoryBot.define do
  factory :achievement do
    sequence(:name) { |n| "実績#{n}" }
    description { "これはテスト用の実績です" }
    condition_type { :total_steps }
    condition_value { 1000 }
    icon_name { "star" }
  end
end
</file>

<file path="spec/factories/notifications.rb">
FactoryBot.define do
  factory :notification do
    association :user
    announcement { nil } # デフォルトはnil
    read_at { nil }
  end
end
</file>

<file path="spec/factories/user_achievements.rb">
FactoryBot.define do
  factory :user_achievement do
    association :user
    association :achievement
  end
end
</file>

<file path="spec/helpers/application_helper_spec.rb">
require 'rails_helper'

RSpec.describe ApplicationHelper, type: :helper do
  describe "#user_avatar" do
    let(:user) { create(:user, name: "TestUser") }

    context "Google連携アバターを使用する場合" do
      before do
        user.update(avatar_type: :google, avatar_url: "http://example.com/avatar.jpg")
      end

      it "画像タグが返されること" do
        expect(helper.user_avatar(user)).to match(/<img.*src="http:\/\/example.com\/avatar.jpg".*>/)
      end
    end

    context "Google連携アバターを使用しない場合" do
      before do
        user.update(avatar_type: :default)
      end

      it "イニシャルが表示されること" do
        expect(helper.user_avatar(user)).to include("T")
      end

      it "名前がない場合はゲストが表示されること" do
        user.name = nil
        expect(helper.user_avatar(user)).to include("ゲスト")
      end
    end
  end

  describe "#time_ago_in_words_game_style" do
    it "nilの場合は'未ログイン'を返すこと" do
      expect(helper.time_ago_in_words_game_style(nil)).to eq "未ログイン"
    end

    it "1分未満の場合は'1分未満'を返すこと" do
      expect(helper.time_ago_in_words_game_style(Time.current - 30.seconds)).to eq "1分未満"
    end

    it "1時間未満の場合は'x分前'を返すこと" do
      expect(helper.time_ago_in_words_game_style(Time.current - 30.minutes)).to eq "30分前"
    end

    it "24時間未満の場合は'x時間前'を返すこと" do
      expect(helper.time_ago_in_words_game_style(Time.current - 5.hours)).to eq "5時間前"
    end

    it "30日未満の場合は'x日前'を返すこと" do
      expect(helper.time_ago_in_words_game_style(Time.current - 5.days)).to eq "5日前"
    end

    it "1年未満の場合は'xヶ月前'を返すこと" do
      expect(helper.time_ago_in_words_game_style(Time.current - 3.months)).to eq "3ヶ月前"
    end

    it "1年以上の場合は'x年前'を返すこと" do
      expect(helper.time_ago_in_words_game_style(Time.current - 2.years)).to eq "2年前"
    end
  end
end
</file>

<file path="spec/helpers/users_helper_spec.rb">
require 'rails_helper'

RSpec.describe UsersHelper, type: :helper do
  describe "#user_avatar" do
    let(:user) { create(:user, name: "Test User") }

    context "Googleアバターを使用する場合" do
      before do
        user.update(avatar_url: "http://example.com/avatar.jpg", avatar_type: :google)
      end

      it "画像タグが表示されること" do
        result = helper.user_avatar(user)
        expect(result).to have_selector("img[src='http://example.com/avatar.jpg']")
      end
    end

    context "Googleアバターを使用しない場合" do
      before do
        user.update(avatar_type: :default)
      end

      it "イニシャルが表示されること" do
        result = helper.user_avatar(user)
        expect(result).to have_content("TES") # Test User -> TES
        expect(result).to have_selector("div.bg-gradient-to-br")
      end

      it "名前が短い場合はそのまま表示されること" do
        user.update(name: "AB")
        result = helper.user_avatar(user)
        expect(result).to have_content("AB")
      end

      it "名前がない場合はゲストと表示されること" do
        user.name = nil
        result = helper.user_avatar(user)
        expect(result).to have_content("ゲスト")
      end
    end
  end
end
</file>

<file path="spec/jobs/generate_post_ogp_image_job_spec.rb">
require 'rails_helper'

RSpec.describe GeneratePostOgpImageJob, type: :job do
  let(:dummy_image_data) { "\xFF\xD8\xFF\xE0\x00\x10JFIF" } # JPEGマジックナンバー

  before do
    allow_any_instance_of(RpgCardGeneratorService).to receive(:generate).and_return(dummy_image_data)
  end

  describe "#perform" do
    let(:user) { create(:user) }
    let(:post) { create(:post, user: user) }

    it "OGP画像を生成して添付すること" do
      expect(post.ogp_image).not_to be_attached

      # ジョブ実行
      GeneratePostOgpImageJob.perform_now(post)

      post.reload
      expect(post.ogp_image).to be_attached
      expect(post.ogp_image.filename.to_s).to eq "post_#{post.id}_ogp.jpg"
    end

    it "既に画像がある場合は生成しないこと" do
      # ダミー画像を添付
      post.ogp_image.attach(io: StringIO.new("dummy"), filename: "dummy.jpg", content_type: "image/jpeg")

      expect(RpgCardGeneratorService).not_to receive(:new)

      GeneratePostOgpImageJob.perform_now(post)
    end
  end
end
</file>

<file path="spec/jobs/generate_ranking_ogp_image_job_spec.rb">
require 'rails_helper'

RSpec.describe GenerateRankingOgpImageJob, type: :job do
  let(:dummy_image_data) { "\xFF\xD8\xFF\xE0\x00\x10JFIF" } # JPEGマジックナンバー

  before do
    allow_any_instance_of(RpgCardGeneratorService).to receive(:generate).and_return(dummy_image_data)
  end

  describe "#perform" do
    let(:user) { create(:user) }

    it "ランキングOGP画像を生成して添付すること" do
      expect(user.ranking_ogp_image).not_to be_attached

      # ジョブ実行
      GenerateRankingOgpImageJob.perform_now(user)

      user.reload
      expect(user.ranking_ogp_image).to be_attached
      expect(user.ranking_ogp_image.filename.to_s).to match(/ranking_#{user.id}_\d{8}_\d{8}\.jpg/)
    end

    it "既に画像がある場合は生成しないこと" do
      # 今週のperiod_keyを計算
      start_date = Date.current.beginning_of_week
      end_date = Date.current.end_of_week
      period_key = "#{start_date.strftime('%Y%m%d')}_#{end_date.strftime('%Y%m%d')}"

      # ダミー画像を添付
      user.ranking_ogp_image.attach(io: StringIO.new("dummy"), filename: "ranking_#{user.id}_#{period_key}.jpg", content_type: "image/jpeg")

      expect(RpgCardGeneratorService).not_to receive(:new)

      GenerateRankingOgpImageJob.perform_now(user)
    end
  end
end
</file>

<file path="spec/models/achievement_spec.rb">
require 'rails_helper'

RSpec.describe Achievement, type: :model do
  describe 'バリデーション' do
    it '名前、説明、条件、アイコンがあれば有効であること' do
      achievement = FactoryBot.build(:achievement)
      expect(achievement).to be_valid
    end

    it '名前がなければ無効であること' do
      achievement = FactoryBot.build(:achievement, name: nil)
      achievement.valid?
      expect(achievement.errors[:name]).to include("を入力してください")
    end

    it '条件値が0以下なら無効であること' do
      achievement = FactoryBot.build(:achievement, condition_value: 0)
      achievement.valid?
      expect(achievement.errors[:condition_value]).to include("は0より大きい値にしてください")
    end
  end

  describe 'Enum' do
    it 'condition_typeが正しく定義されていること' do
      expect(Achievement.condition_types.keys).to include('total_steps', 'total_distance', 'login_streak', 'post_count')
    end
  end
end
</file>

<file path="spec/models/user_achievement_spec.rb">
require 'rails_helper'

RSpec.describe UserAchievement, type: :model do
  describe 'バリデーション' do
    let(:user) { FactoryBot.create(:user) }
    let(:achievement) { FactoryBot.create(:achievement) }

    it 'ユーザーと実績の組み合わせがユニークであること' do
      UserAchievement.create(user: user, achievement: achievement)
      duplicate = UserAchievement.new(user: user, achievement: achievement)
      duplicate.valid?
      expect(duplicate.errors[:user_id]).to include("はすでに存在します")
    end
  end
end
</file>

<file path="spec/requests/posts/ogp_images_spec.rb">
require 'rails_helper'

RSpec.describe "Posts::OgpImages", type: :request do
  let(:user) { create(:user) }
  let(:post_record) { create(:post, user: user) }

  # 画像生成サービスをスタブ化（高速化）
  let(:dummy_image_data) { "\xFF\xD8\xFF\xE0\x00\x10JFIF" } # JPEGマジックナンバー

  before do
    allow_any_instance_of(RpgCardGeneratorService).to receive(:generate).and_return(dummy_image_data)
  end

  describe "GET /posts/:post_id/ogp_image" do
    context "投稿が存在する場合" do
      it "リダイレクトまたは成功レスポンスが返されること" do
        get post_ogp_image_path(post_record, format: :jpg)
        # 初回は画像生成後にActive Storageへリダイレクト（302）、
        # 2回目以降は既存画像へのリダイレクト（302）
        expect([ 200, 302 ]).to include(response.status)
      end

      it "キャッシュヘッダーが設定されていること" do
        get post_ogp_image_path(post_record, format: :jpg)
        expect(response.headers['Cache-Control']).to include('max-age')
        expect(response.headers['Cache-Control']).to include('public')
      end

      it "画像が生成されてActive Storageに添付されること" do
        expect {
          get post_ogp_image_path(post_record, format: :jpg)
        }.to change { post_record.reload.ogp_image.attached? }.from(false).to(true)
      end
    end

    context "投稿が存在しない場合" do
      it "404エラーが返されること" do
        get post_ogp_image_path(post_id: 99999, format: :jpg)
        expect(response).to have_http_status(:not_found)
      end
    end
  end
end
</file>

<file path="spec/requests/users/registrations_spec.rb">
require 'rails_helper'

RSpec.describe "Users::Registrations", type: :request do
  let(:user) { create(:user) }
  let(:avatar_path) { Rails.root.join("spec/fixtures/files/avatar.jpg") }
  let(:avatar_file) { fixture_file_upload(avatar_path, 'image/jpeg') }

  before do
    sign_in user
  end

  describe "PUT /users" do
    context "アバター画像のアップロード" do
      it "画像をアップロードしてアバタータイプを'uploaded'に更新できること" do
        put user_registration_path, params: {
          user: {
            uploaded_avatar: avatar_file,
            avatar_type: 'uploaded',
            current_password: user.password
          }
        }

        user.reload
        expect(user.uploaded_avatar).to be_attached
        expect(user.avatar_type).to eq("uploaded")
        expect(response).to redirect_to(edit_user_registration_path)
      end
    end

    context "アバタータイプの切り替え" do
      before do
        # 事前に画像をアップロードしておく
        user.uploaded_avatar.attach(io: File.open(avatar_path), filename: "avatar.jpg", content_type: "image/jpeg")
        user.update!(avatar_type: :uploaded)
      end

      it "アバタータイプを'default'に切り替えられること" do
        put user_registration_path, params: {
          user: {
            avatar_type: 'default',
            current_password: user.password
          }
        }

        expect(user.reload.avatar_type).to eq("default")
        # 画像自体は消えていないことを確認
        expect(user.uploaded_avatar).to be_attached
      end

      it "アバタータイプを'uploaded'に戻せること" do
        user.update!(avatar_type: :default)

        put user_registration_path, params: {
          user: {
            avatar_type: 'uploaded',
            current_password: user.password
          }
        }

        expect(user.reload.avatar_type).to eq("uploaded")
      end
    end
  end

  describe "DELETE /users/uploaded_avatar" do
    before do
      user.uploaded_avatar.attach(io: File.open(avatar_path), filename: "avatar.jpg", content_type: "image/jpeg")
      user.update!(avatar_type: :uploaded)
    end

    it "アップロード画像を削除し、アバタータイプを'default'にリセットすること" do
      delete delete_user_uploaded_avatar_path

      user.reload
      expect(user.uploaded_avatar).not_to be_attached
      expect(user.avatar_type).to eq("default")
      expect(response).to redirect_to(edit_user_registration_path)
      expect(flash[:notice]).to eq("アップロード画像を削除しました")
    end
  end
end
</file>

<file path="spec/requests/achievements_spec.rb">
require 'rails_helper'

RSpec.describe "Achievements", type: :request do
  let(:user) { FactoryBot.create(:user) }

  describe "GET /index" do
    context "ログインしている場合" do
      before do
        sign_in user
      end

      it "正常にレスポンスが返ること" do
        get achievements_path
        expect(response).to have_http_status(:success)
      end
    end

    context "ログインしていない場合" do
      it "ログイン画面にリダイレクトされること" do
        get achievements_path
        expect(response).to have_http_status(:found)
        expect(response).to redirect_to(new_user_session_path)
      end
    end
  end
end
</file>

<file path="spec/requests/google_fit_spec.rb">
require 'rails_helper'

RSpec.describe "GoogleFit", type: :request do
  # テスト用ユーザーの作成
  let(:user) { FactoryBot.create(:user) }



  describe "GET /google_fit/status" do
    before { sign_in user }

    context "連携済みの場合" do
      before do
        user.update(google_token: "token", google_refresh_token: "refresh_token", google_expires_at: 1.hour.from_now)
      end

      it "connected: true とメールアドレスが返ること" do
        get google_fit_status_path

        expect(response).to have_http_status(:ok)
        json = JSON.parse(response.body)
        expect(json["connected"]).to be true
        expect(json["email"]).to eq(user.email)
      end
    end

    context "未連携の場合" do
      before do
        user.update(google_token: nil)
      end

      it "connected: false が返ること" do
        get google_fit_status_path

        expect(response).to have_http_status(:ok)
        json = JSON.parse(response.body)
        expect(json["connected"]).to be false
      end
    end
  end
end
</file>

<file path="spec/requests/notifications_controller_spec.rb">
require 'rails_helper'

RSpec.describe "Notifications", type: :request do
  let(:user) { create(:user) }
  let!(:notification) { create(:notification, user: user, read_at: nil, notification_type: :inactive_reminder, message: "テストメッセージ") }

  before do
    sign_in user
  end

  describe "GET /notifications" do
    it "通知一覧が表示されること" do
      # リマインダータブを表示
      get notifications_path(tab: "reminders")
      expect(response).to have_http_status(:success)
      expect(response.body).to include(notification.body)
    end
  end

  describe "PATCH /notifications/:id/mark_as_read" do
    around do |example|
      # テスト環境でCSRF保護を無効化（明示的に設定）し、テスト後に設定を戻す
      original_value = ActionController::Base.allow_forgery_protection
      ActionController::Base.allow_forgery_protection = false
      example.run
      ActionController::Base.allow_forgery_protection = original_value
    end

    it "未読通知が既読になること" do
      patch mark_as_read_notification_path(notification)
      expect(notification.reload.read_at).not_to be_nil
      expect(response).to redirect_to(notifications_path)
    end
  end
end
</file>

<file path="spec/support/omniauth.rb">
# OmniAuthのテストモード設定
OmniAuth.config.test_mode = true
OmniAuth.config.request_validation_phase = nil

# ログ出力を抑制（テスト実行時のノイズを減らす）
OmniAuth.config.logger = Logger.new("/dev/null")
</file>

<file path="spec/system/achievements_spec.rb">
require 'rails_helper'

RSpec.describe 'Achievements', type: :system do
  let(:user) { FactoryBot.create(:user) }
  let!(:achievement_earned) { FactoryBot.create(:achievement, name: '獲得済みバッジ', icon_name: 'star') }
  let!(:achievement_locked) { FactoryBot.create(:achievement, name: '未獲得バッジ', icon_name: 'lock_open') } # 元のアイコンはlock_openにしておく

  before do
    UserAchievement.create(user: user, achievement: achievement_earned)
  end

  context 'ログインしていない場合' do
    it 'ログイン画面にリダイレクトされる' do
      visit achievements_path
      expect(current_path).to eq new_user_session_path
    end
  end

  context 'ログインしている場合' do
    before do
      sign_in user
      visit achievements_path
    end

    it '実績一覧が表示される' do
      expect(page).to have_content 'ACHIEVEMENTS'
      expect(page).to have_content '獲得済みバッジ'
      expect(page).to have_content '未獲得バッジ'
    end

    it '獲得済みの実績は獲得済みとして表示される' do
      # 獲得済みの要素には特定のクラスやアイコンがあるはず
      # ここではアイコン名が表示されているかで簡易判定
      expect(page).to have_content 'star'
    end

    it '未獲得の実績はロック状態で表示される' do
      # 未獲得の場合はアイコンがlockになる
      # achievement_lockedのicon_nameはlock_openだが、未獲得なのでlockが表示されるはず
      expect(page).to have_content 'lock'
      expect(page).to have_content '未獲得'
    end

    it 'プログレスバーが正しく表示される' do
      # 全2個中1個獲得なので50%
      expect(page).to have_content '1 / 2'
    end
  end
end
</file>

<file path="spec/system/home_spec.rb">
require 'rails_helper'

RSpec.describe "Home", type: :system, js: true do
  # Chrome起動設定

  let(:user) { FactoryBot.create(:user, name: "ホーム太郎") }

  before do
    # ログイン処理
    # ログイン処理をWardenヘルパーで実行（UI操作をスキップして安定化）
    login_as(user, scope: :user)
  end

  describe "ホーム画面の表示" do
    before do
      # 外部サービスのモック化
      # 実際のリクエストを飛ばさないようにする

      # 位置情報のモック
      allow(GeolocationService).to receive(:get_location).and_return({
        latitude: 35.6895,
        longitude: 139.6917,
        city: "Shinjuku",
        region: "Tokyo"
      })

      # 天気情報のモック
      # ビューでは @weather[:today][:icon] のようにアクセスしているため構造を合わせる
      allow(WeatherService).to receive(:get_forecast).and_return({
        today: {
          temp: 20,
          condition: "晴れ",
          icon: "sunny", # material symbolsの名前
          description: "快晴です"
        },
        tomorrow: {
          temp: 18,
          condition: "曇り",
          icon: "cloud",
          description: "曇りです"
        }
      })

      visit root_path
    end

    it "位置情報と天気が表示されること" do
      # 非同期読み込み完了を待つ（特定の要素が表示されるまで待機）
      # 天気アイコンが表示されるまで待つことで、他の情報も読み込まれていることを保証する
      expect(page).to have_selector(".material-symbols-outlined", text: "sunny", wait: 10)

      # 位置情報（Shinjuku または Tokyo）が表示されているか
      expect(page).to have_content "Shinjuku"

      # 気温が表示されているか
      expect(page).to have_content "20"
    end

    context "今日の散歩記録がある場合" do
      before do
        FactoryBot.create(:walk,
          user: user,
          walked_on: Date.current,
          distance: 5.5,
          steps: 8000
        )
        visit root_path # リロードして反映
      end

      it "今日の記録が表示されること" do
        expect(page).to have_content "今日の散歩"

        # JavaScriptのカウンターで数値が表示されるため、data属性で値を確認する
        # 5.5km -> 5500m
        expect(page).to have_selector("[data-counter-target-value='5500']")

        # 歩数はそのまま表示される
        expect(page).to have_content "8,000"
      end
    end

    context "今日の散歩記録がない場合" do
      it "今日の散歩カードが表示され、距離が0mであること" do
        # 今日の散歩カード自体は常に表示される仕様
        expect(page).to have_content "今日の散歩"

        # 距離が0mであることを確認（data-counter-target-value="0"）
        # カウンターアニメーションのため、テキストは "0"
        within find(".bg-gradient-to-br.from-sky-400", text: "今日の散歩") do
          expect(page).to have_selector("[data-counter-target-value='0']")
          expect(page).to have_content "m"
        end
      end
    end
  end
end
</file>

<file path="spec/system/login_stamps_spec.rb">
require 'rails_helper'

RSpec.describe "LoginStamps", type: :system, js: true do
  # Chrome起動設定

  # テストデータの準備
  let(:user) { FactoryBot.create(:user, name: "スタンプ太郎") }

  before do
    # ログイン処理
    login_as(user, scope: :user)
    visit root_path
  end

  describe "カレンダー画面の表示" do
    before do
      visit login_stamps_path
    end

    it "現在の年月が表示されていること" do
      current_month = Date.current.strftime("%Y年%m月")
      expect(page).to have_content current_month
    end

    it "カレンダーの日付が表示されていること" do
      today_day = Date.current.day.to_s
      # 日付の数字が表示されているか確認（カレンダー内の日付セル）
      expect(page).to have_css(".date-number", text: today_day)
    end
  end

  describe "スタンプの表示" do
    context "散歩記録がある場合" do
      let!(:walk) { FactoryBot.create(:walk, user: user, walked_on: Date.current) }

      before do
        visit login_stamps_path
      end

      it "その日にスタンプが表示されること" do
        # スタンプアイコン（pets）が表示されているか
        expect(page).to have_content "pets"
        # has-stampクラスが付与されているか
        expect(page).to have_css(".calendar-day.has-stamp")
      end

      it "「てくてく日数」が1日と表示されること" do
        # 今月の散歩日数の表示確認
        # 「てくてく日数」というテキストを含む要素を特定
        # デザイン変更に伴い、背景色クラスではなくテキストで親要素を探す
        target_card = find(:xpath, "//div[contains(., 'てくてく日数')][contains(@class, 'rounded-[2.5rem]')]")

        within target_card do
          expect(page).to have_content "1"
        end
      end
    end

    context "散歩記録がない場合" do
      before do
        visit login_stamps_path
      end

      it "スタンプが表示されないこと" do
        expect(page).not_to have_css(".calendar-day.has-stamp")
      end

      it "今日の日付には「今日」と表示されること" do
        # 今日のセル内に「今日」という文字があるか
        today_cell = find(".calendar-day.today")
        expect(today_cell).to have_content "今日"
      end
    end
  end

  describe "連続日数の表示" do
    context "昨日と今日連続で散歩している場合" do
      before do
        FactoryBot.create(:walk, user: user, walked_on: Date.current)
        FactoryBot.create(:walk, user: user, walked_on: 1.day.ago.to_date)
        visit login_stamps_path
      end

      it "連続日数が「2日」と表示されること" do
        # 連続日数のカード内の数字を確認
        # デザイン変更に伴い、背景色クラスではなくテキストで親要素を探す
        target_card = find(:xpath, "//div[contains(., '連続')][contains(@class, 'rounded-[2.5rem]')]")

        within target_card do
          expect(page).to have_content "2"
        end
      end
    end
  end

  describe "月移動の動作" do
    before do
      visit login_stamps_path
    end

    it "前月ボタンを押すと前月のカレンダーが表示されること" do
      prev_month = 1.month.ago.strftime("%Y年%m月")

      # 前月ボタン（chevron_left）をクリック
      find("a", text: "chevron_left").click

      expect(page).to have_content prev_month
    end

    it "次月ボタンを押すと次月のカレンダーが表示されること" do
      next_month = 1.month.since.strftime("%Y年%m月")

      # 次月ボタン（chevron_right）をクリック
      find("a", text: "chevron_right").click

      # 画面遷移を待つ
      expect(page).to have_content next_month
    end
  end
end
</file>

<file path="spec/system/ogp_preview_spec.rb">
require 'rails_helper'

RSpec.describe "OGPプレビュー機能", type: :system do
  let(:user) { create(:user) }
  let!(:post) { create(:post, user: user, body: "テスト投稿") }

  before do
    login_as(user)
    visit post_path(post)
  end

  it "プレビューモーダルの開閉動作が正しく機能する", js: true do
    # 1. ページ読み込み完了確認
    expect(page).to have_content("冒険の記録")
    expect(page).to have_content("シェア画像を確認・更新")

    # 2. モーダルを開く
    click_button "シェア画像を確認・更新"

    # モーダルが表示される（非表示クラスが消える、あるいは透明度が変わるのを待つ）
    expect(page).to have_selector("#ogp-preview-modal", visible: true)
    expect(page).to have_content("シェア画像プレビュー")

    # 3. 閉じるボタン（×）で閉じる
    # ボタンは右上にあり、SVGを含んでいる
    close_button = find("button[data-action='click->ogp-preview#close']")
    close_button.click

    # モーダルが非表示になることを確認
    expect(page).to have_selector("#ogp-preview-modal", visible: false)

    # 4. 再び開く
    click_button "シェア画像を確認・更新"
    expect(page).to have_selector("#ogp-preview-modal", visible: true)

    # 5. モーダルの中身（白いカード部分）をクリックしても閉じない
    modal_container = find("[data-ogp-preview-target='container']")
    modal_container.click

    # まだ表示されているはず
    expect(page).to have_selector("#ogp-preview-modal", visible: true)

    # 6. 背景（オーバーレイ）をクリックして閉じる
    # fix: オーバーレイ要素をクリックする必要がある
    # オーバーレイは #ogp-preview-modal 自体が全画面を覆っている
    # ただし、Capybaraで真ん中をクリックすると中身をクリックしてしまう可能性があるため、
    # 座標指定か、コンテナの外側をクリックする工夫が必要だが、
    # 単純に #ogp-preview-modal 自体がオーバーレイとして機能しているので、
    # 「コンテナの外」をクリックするシミュレーションとして、
    # 画面の左上端(0,0)などをクリックさせるのが確実。

    page.execute_script("document.getElementById('ogp-preview-modal').click()")

    # モーダルが非表示になることを確認
    expect(page).to have_selector("#ogp-preview-modal", visible: false)
  end
end
</file>

<file path="spec/system/sns_spec.rb">
require 'rails_helper'

RSpec.describe 'SNS機能', type: :system, js: true do
  let(:user) { create(:user) }
  let!(:other_post) { create(:post, body: '他人の投稿です') }

  before do
    login_as(user, scope: :user)
  end

  describe '新規投稿' do
    context '正常系' do
      it 'モーダルから投稿を作成できること' do
        visit posts_path
        # モーダルを開く
        find('[data-action="click->modal#open"]').click
        # モーダルが開くのを待つ
        modal = find('dialog#new_post_modal[open]')

        within modal do
          # フォーム入力
          # 天気を選択（sunny）
          find('label', text: '晴れ', visible: true).click
          # 気分を選択（great）
          find('label', text: '最高', visible: true).click
          # 本文を入力
          fill_in 'post[body]', with: 'テスト投稿です！'

          # 送信
          click_button '投稿する'
        end

        # モーダルが閉じ、投稿が一覧に追加されていることを確認
        expect(page).to have_content 'テスト投稿です！'
        expect(page).to have_content '投稿しました'
      end
    end

    context '異常系' do
      it '入力不備がある場合、エラーメッセージが表示されること' do
        visit posts_path
        find('[data-action="click->modal#open"]').click

        # 何も入力せずに送信
        # HTML5バリデーションを無効化して送信（サーバーサイドのバリデーションをテストするため）
        execute_script("document.querySelector('form').noValidate = true")
        click_button '投稿する'

        # エラーメッセージの確認
        expect(page).to have_content '本文、天気、気分、散歩記録のいずれか1つは入力してください'

        # モーダルが開いたままであること
        expect(page).to have_selector 'dialog#new_post_modal[open]'
      end
    end
  end

  describe 'リアクション機能' do
    it '投稿に「いいね」できること' do
      visit posts_path
      # 投稿内のリアクションエリアを特定
      within "#post_#{other_post.id}" do
        # 「＋」ボタン（リアクション追加）をクリックしてポップオーバーを開く
        find('button[title="リアクションを追加"]').click

        # ポップオーバー内の「いいね」ボタンをクリック
        # ポップオーバーは絶対配置でbody直下などに出る可能性があるが、
        # 実装では .relative の中にあるので within の中で探せるはず
        # もし見つからない場合は page.find で探す

        # ポップオーバーが表示されるのを待つ
        expect(page).to have_selector('[data-popover-target="content"]', visible: true)

        # 「いいね」ボタン（thumbs_up）をクリック
        # id="picker-btn-{post.id}-thumbs_up" だが、post.idが不明なので部分一致などで探す
        # または絵文字で探す
        find('button', text: '👍').trigger('click')

        # カウントが1になることを確認
        expect(page).to have_content '1'
      end
    end
  end

  describe '投稿の削除' do
    let!(:my_post) { create(:post, user: user, body: '削除する投稿') }

    it '自分の投稿は削除できること' do
      visit posts_path
      # 削除ボタンをクリック
      accept_confirm do
        # 自分の投稿内の削除ボタンを探す
        # 投稿の特定が難しい場合、bodyテキストを含む要素の親を辿るなどの工夫が必要だが、
        # ここではシンプルに削除ボタンを探す（自分の投稿にしか出ないはずなので）
        find("a[title='投稿を削除']").click
      end

      expect(page).to have_content '投稿を削除しました'
      expect(page).not_to have_content '削除する投稿'
    end

    it '他人の投稿には削除ボタンが表示されないこと' do
      visit posts_path
      # 他人の投稿（other_post）が表示されていることを確認
      expect(page).to have_content '他人の投稿です'

      # 他人の投稿の要素内には削除ボタンがないことを確認
      # 自分の投稿（my_post）も表示されているので、削除ボタン自体はページに存在する可能性がある
      # そのため、他人の投稿のスコープ内で削除ボタンがないことを確認する

      # 他人の投稿要素を特定（bodyテキストで検索）
      other_post_element = find('p', text: '他人の投稿です').find(:xpath, '../../..') # 構造に合わせて親要素へ

      within other_post_element do
        expect(page).not_to have_selector "a[data-turbo-method='delete']"
      end
    end
  end
end
</file>

<file path=".rubocop.yml">
# Omakase Ruby styling for Rails
inherit_gem: { rubocop-rails-omakase: rubocop.yml }

# Overwrite or add rules to create your own house style
#
# # Use `[a, [b, c]]` not `[ a, [ b, c ] ]`
Layout/SpaceInsideArrayLiteralBrackets:
  Enabled: false

AllCops:
  Exclude:
    - "docs/**/*"
</file>

<file path="parallel_rspec_output.txt">
4 processes for 49 specs, ~ 12 specs per process
..........................................................................................................................F........................................................

Top 10 slowest examples (1.31 seconds, 67.0% of total time):
  Posts::OgpImages GET /posts/:post_id/ogp_image 投稿が存在しない場合 404エラーが返されること
    0.34277 seconds ./spec/requests/posts/ogp_images_spec.rb:37
  GenerateRankingOgpImageJob#perform ランキングOGP画像を生成して添付すること
    0.28611 seconds ./spec/jobs/generate_ranking_ogp_image_job_spec.rb:13
  Notifications GET /notifications 通知一覧が表示されること
    0.21615 seconds ./spec/requests/notifications_controller_spec.rb:12
  User.ranking 期間: yearly (今年) 今年の記録が集計され、距離順に並ぶこと
    0.12093 seconds ./spec/models/user_spec.rb:179
  User.from_omniauth ユーザーが既に存在する場合（Google UIDで一致） そのユーザーを返し、Google認証情報を更新すること
    0.0953 seconds ./spec/models/user_spec.rb:49
  GoogleFit GET /google_fit/daily_data ログインしている場合 Google連携済みの場合 無効な日付形式が送信された場合 400 Bad Requestが返ること
    0.08569 seconds ./spec/requests/google_fit_spec.rb:93
  ShareHelper#share_post_on_twitter_url 投稿シェア用のURLを生成すること
    0.04838 seconds ./spec/helpers/share_helper_spec.rb:24
  User.ranking 期間: monthly (今月) 今月の記録が集計され、距離順に並ぶこと
    0.04196 seconds ./spec/models/user_spec.rb:156
  User.ranking 期間: weekly (今週) 今週の記録が集計され、距離順に並ぶこと
    0.03456 seconds ./spec/models/user_spec.rb:138
  ShareHelper#twitter_share_url Twitterシェア用のURLを生成すること
    0.03422 seconds ./spec/helpers/share_helper_spec.rb:5

Top 10 slowest example groups:
  GenerateRankingOgpImageJob
    0.15576 seconds average (0.31152 seconds / 2 examples) ./spec/jobs/generate_ranking_ogp_image_job_spec.rb:3
  Notifications
    0.12017 seconds average (0.24033 seconds / 2 examples) ./spec/requests/notifications_controller_spec.rb:3
  Posts::OgpImages
    0.10885 seconds average (0.43542 seconds / 4 examples) ./spec/requests/posts/ogp_images_spec.rb:3
  ShareHelper
    0.03031 seconds average (0.09092 seconds / 3 examples) ./spec/helpers/share_helper_spec.rb:3
  User
    0.02749 seconds average (0.35741 seconds / 13 examples) ./spec/models/user_spec.rb:3
  GoogleFit
    0.02627 seconds average (0.18387 seconds / 7 examples) ./spec/requests/google_fit_spec.rb:3
  Users
    0.01628 seconds average (0.11397 seconds / 7 examples) ./spec/requests/users_controller_spec.rb:3
  WalkReminderService
    0.00872 seconds average (0.03487 seconds / 4 examples) ./spec/services/walk_reminder_service_spec.rb:3
  StaticPages
    0.00693 seconds average (0.00693 seconds / 1 example) ./spec/requests/static_pages_spec.rb:3
  Walk
    0.00682 seconds average (0.07506 seconds / 11 examples) ./spec/models/walk_spec.rb:3

Finished in 1.95 seconds (files took 0 seconds to load)
77 examples, 0 failures

....................................................................................../home/nukon999/workspace/tekumemo/vendor/bundle/ruby/3.2.0/gems/devise-4.9.4/lib/devise/failure_app.rb:80: warning: Status code :unprocessable_entity is deprecated and will be removed in a future version of Rack. Please use :unprocessable_content instead.
./home/nukon999/workspace/tekumemo/vendor/bundle/ruby/3.2.0/gems/devise-4.9.4/lib/devise/failure_app.rb:80: warning: Status code :unprocessable_entity is deprecated and will be removed in a future version of Rack. Please use :unprocessable_content instead.
..................

Failures:

  1) Stats GET /stats データが存在する場合 正常に表示されること
     Failure/Error: create(:walk, user: user, walked_on: Date.current, distance: 5000)

     ActiveRecord::RecordInvalid:
       バリデーションに失敗しました: 距離は50以下の値にしてください
     # ./spec/requests/stats_controller_spec.rb:18:in `block (4 levels) in <main>'

Top 10 slowest examples (9.78 seconds, 58.8% of total time):
  ユーザー認証・認可 ログアウト ログアウトできること
    1.76 seconds ./spec/system/user_auth_spec.rb:52
  LoginStamps 月移動の動作 次月ボタンを押すと次月のカレンダーが表示されること
    1.33 seconds ./spec/system/login_stamps_spec.rb:107
  ユーザー認証・認可 ログイン 誤ったパスワードではログインできないこと
    0.95556 seconds ./spec/system/user_auth_spec.rb:19
  Home ホーム画面の表示 位置情報と天気が表示されること
    0.90923 seconds ./spec/system/home_spec.rb:47
  LoginStamps カレンダー画面の表示 カレンダーの日付が表示されていること
    0.90641 seconds ./spec/system/login_stamps_spec.rb:25
  ユーザー認証・認可 ログイン 存在しないメールアドレスではログインできないこと
    0.89773 seconds ./spec/system/user_auth_spec.rb:31
  LoginStamps 月移動の動作 前月ボタンを押すと前月のカレンダーが表示されること
    0.88771 seconds ./spec/system/login_stamps_spec.rb:98
  ユーザー認証・認可 パスワードリセット パスワードリセット画面が表示されること
    0.77446 seconds ./spec/system/user_auth_spec.rb:106
  ユーザー認証・認可 ログイン 正しいメールアドレスとパスワードでログインできること
    0.73413 seconds ./spec/system/user_auth_spec.rb:7
  Home ホーム画面の表示 今日の散歩記録がある場合 今日の記録が表示されること
    0.63009 seconds ./spec/system/home_spec.rb:70

Top 10 slowest example groups:
  ユーザー認証・認可
    0.76832 seconds average (6.91 seconds / 9 examples) ./spec/system/user_auth_spec.rb:3
  LoginStamps
    0.65805 seconds average (5.92 seconds / 9 examples) ./spec/system/login_stamps_spec.rb:3
  Home
    0.61815 seconds average (1.85 seconds / 3 examples) ./spec/system/home_spec.rb:3
  Home
    0.23505 seconds average (0.47011 seconds / 2 examples) ./spec/requests/home_controller_spec.rb:3
  Users::OmniauthCallbacks
    0.18553 seconds average (0.37105 seconds / 2 examples) ./spec/requests/users/omniauth_callbacks_spec.rb:3
  Rankings::OgpImages
    0.06741 seconds average (0.26964 seconds / 4 examples) ./spec/requests/rankings/ogp_images_spec.rb:3
  StatsComingSoons
    0.04127 seconds average (0.04127 seconds / 1 example) ./spec/requests/stats_coming_soon_spec.rb:3
  Stats
    0.03941 seconds average (0.27584 seconds / 7 examples) ./spec/requests/stats_controller_spec.rb:3
  StatsService
    0.0194 seconds average (0.34928 seconds / 18 examples) ./spec/services/stats_service_spec.rb:3
  WebPushService
    0.01387 seconds average (0.05549 seconds / 4 examples) ./spec/services/web_push_service_spec.rb:3

Finished in 16.64 seconds (files took 0 seconds to load)
67 examples, 1 failure

Failed examples:

rspec ./spec/requests/stats_controller_spec.rb:22 # Stats GET /stats データが存在する場合 正常に表示されること

.

Top 10 slowest examples (9.86 seconds, 59.0% of total time):
  ユーザー設定 設定画面の操作 Google連携を行い、その後解除できること
    1.8 seconds ./spec/system/user_settings_spec.rb:147
  ユーザー設定 設定画面の操作 Google連携解除時にパスワードを間違えると解除できないこと
    1.39 seconds ./spec/system/user_settings_spec.rb:202
  Admin::Users 管理者権限の制御 一般ユーザーとしてログインしている場合 管理画面にアクセスできず、トップページにリダイレクトされる
    0.92656 seconds ./spec/system/admin_users_spec.rb:13
  ユーザー設定 設定画面の操作 プロフィール（名前・目標距離）を更新できること
    0.87473 seconds ./spec/system/user_settings_spec.rb:109
  ユーザー設定 設定画面の操作 現在のパスワードが間違っていると更新できないこと
    0.87166 seconds ./spec/system/user_settings_spec.rb:129
  Posts POST /posts 有効なパラメータの場合 投稿が作成されること
    0.86179 seconds ./spec/requests/posts_spec.rb:38
  ユーザー設定 設定画面の操作 プロフィール更新（異常系） 目標距離に不正な値（上限超え）を入力すると更新できないこと
    0.83854 seconds ./spec/system/user_settings_spec.rb:94
  ユーザー設定 設定画面の操作 アカウントを削除できること
    0.79891 seconds ./spec/system/user_settings_spec.rb:227
  ユーザー設定 設定画面の操作 プロフィール更新（異常系） 目標距離に不正な値（0以下）を入力すると更新できないこと
    0.76471 seconds ./spec/system/user_settings_spec.rb:88
  ユーザー設定 新規登録とログイン 入力内容に不備がある場合 必須項目が未入力だと登録できず、エラーメッセージが表示されること
    0.73893 seconds ./spec/system/user_settings_spec.rb:29

Top 10 slowest example groups:
  ユーザー設定
    0.82583 seconds average (11.56 seconds / 14 examples) ./spec/system/user_settings_spec.rb:3
  Admin::Users
    0.48011 seconds average (1.44 seconds / 3 examples) ./spec/system/admin_users_spec.rb:3
  Posts
    0.29632 seconds average (2.37 seconds / 8 examples) ./spec/requests/posts_spec.rb:3
  GeneratePostOgpImageJob
    0.17873 seconds average (0.35746 seconds / 2 examples) ./spec/jobs/generate_post_ogp_image_job_spec.rb:3
  Admin::Dashboard
    0.10188 seconds average (0.30564 seconds / 3 examples) ./spec/requests/admin/dashboard_spec.rb:3
  Reactions
    0.03316 seconds average (0.19897 seconds / 6 examples) ./spec/requests/reactions_spec.rb:3
  Announcement
    0.02432 seconds average (0.09728 seconds / 4 examples) ./spec/models/announcement_spec.rb:3
  WebPushSubscriptions
    0.02039 seconds average (0.06117 seconds / 3 examples) ./spec/requests/web_push_subscriptions_controller_spec.rb:3
  Reaction
    0.01893 seconds average (0.15142 seconds / 8 examples) ./spec/models/reaction_spec.rb:3
  Notification
    0.01512 seconds average (0.13605 seconds / 9 examples) ./spec/models/notification_spec.rb:3

Finished in 16.71 seconds (files took 0 seconds to load)
73 examples, 0 failures

..

Top 10 slowest examples (12.92 seconds, 69.4% of total time):
  SNS機能 新規投稿 正常系 モーダルから投稿を作成できること
    2.74 seconds ./spec/system/sns_spec.rb:13
  SNS機能 新規投稿 異常系 入力不備がある場合、エラーメッセージが表示されること
    1.52 seconds ./spec/system/sns_spec.rb:40
  Walks 散歩記録の削除 記録を削除できること
    1.49 seconds ./spec/system/walks_spec.rb:74
  Rankings GET /rankings ログインしている場合 期間パラメータ(monthly)を指定してもアクセスできること
    1.32 seconds ./spec/requests/rankings_spec.rb:18
  Walks ページネーション ページネーションが表示され、次ページに遷移できること
    1.04 seconds ./spec/system/walks_spec.rb:111
  Home Carousel on desktop view hides carousel indicators
    1 seconds ./spec/system/carousel_spec.rb:14
  Rankings 同率順位の表示 全員が表示され、距離が正しいこと
    0.98766 seconds ./spec/system/rankings_spec.rb:25
  Walks 散歩記録の新規作成 散歩記録が保存され、一覧画面に表示されること
    0.96735 seconds ./spec/system/walks_spec.rb:12
  Walks 散歩記録の編集 記録を編集できること
    0.93408 seconds ./spec/system/walks_spec.rb:46
  SNS機能 リアクション機能 投稿に「いいね」できること
    0.91576 seconds ./spec/system/sns_spec.rb:59

Top 10 slowest example groups:
  SNS機能
    1.26 seconds average (6.31 seconds / 5 examples) ./spec/system/sns_spec.rb:3
  Walks
    1.11 seconds average (4.42 seconds / 4 examples) ./spec/system/walks_spec.rb:3
  Home Carousel
    1.01 seconds average (1.01 seconds / 1 example) ./spec/system/carousel_spec.rb:3
  Rankings
    0.98818 seconds average (0.98818 seconds / 1 example) ./spec/system/rankings_spec.rb:3
  Rankings
    0.52604 seconds average (2.63 seconds / 5 examples) ./spec/requests/rankings_spec.rb:3
  LoginStamps
    0.45246 seconds average (0.45246 seconds / 1 example) ./spec/requests/login_stamps_controller_spec.rb:3
  Walks
    0.19872 seconds average (2.19 seconds / 11 examples) ./spec/requests/walks_spec.rb:3
  WalksPagination
    0.08686 seconds average (0.08686 seconds / 1 example) ./spec/requests/walks_pagination_spec.rb:3
  GoogleFitService
    0.06783 seconds average (0.20348 seconds / 3 examples) ./spec/services/google_fit_service_spec.rb:4
  ReactionSummaryService
    0.02345 seconds average (0.11727 seconds / 5 examples) ./spec/services/reaction_summary_service_spec.rb:3

Finished in 18.61 seconds (files took 0 seconds to load)
70 examples, 0 failures

Tests Failed

287 examples, 1 failure

Took 20 seconds
</file>

<file path="restore_calories.sql">
UPDATE walks SET calories_burned = 0 WHERE user_id = 31 AND walked_on = '2025-12-20';
UPDATE walks SET calories_burned = 8 WHERE user_id = 31 AND walked_on = '2025-12-18';
UPDATE walks SET calories_burned = 12 WHERE user_id = 31 AND walked_on = '2025-12-17';
UPDATE walks SET calories_burned = 0 WHERE user_id = 31 AND walked_on = '2025-12-15';
UPDATE walks SET calories_burned = 0 WHERE user_id = 31 AND walked_on = '2025-12-16';
UPDATE walks SET calories_burned = 181 WHERE user_id = 31 AND walked_on = '2025-12-12';
UPDATE walks SET calories_burned = 17 WHERE user_id = 31 AND walked_on = '2025-12-13';
UPDATE walks SET calories_burned = NULL WHERE user_id = 31 AND walked_on = '2025-12-05';
UPDATE walks SET calories_burned = 0 WHERE user_id = 31 AND walked_on = '2025-12-06';
UPDATE walks SET calories_burned = 0 WHERE user_id = 31 AND walked_on = '2025-12-07';
UPDATE walks SET calories_burned = 8 WHERE user_id = 31 AND walked_on = '2025-12-10';
UPDATE walks SET calories_burned = 56 WHERE user_id = 31 AND walked_on = '2025-12-11';
UPDATE walks SET calories_burned = 28 WHERE user_id = 31 AND walked_on = '2025-12-14';
</file>

<file path="user_31_walks.txt">
29	31	1	\N	2025-12-11 14:48:24.93377	2025-12-11 14:48:24.93377	0	\N	\N
89	31	2	\N	2025-12-11 14:48:45.625104	2025-12-11 14:48:45.625104	0	\N	\N
138	31	3	\N	2025-12-11 14:48:52.904338	2025-12-11 14:48:52.904338	0	\N	\N
197	31	5	\N	2025-12-11 14:51:54.977485	2025-12-11 14:51:54.977485	0	\N	\N
253	31	4	\N	2025-12-11 14:52:15.30496	2025-12-11 14:52:15.30496	0	\N	\N
309	31	6	\N	2025-12-14 02:15:13.89325	2025-12-14 02:15:13.89325	0	\N	\N
423	31	8	\N	2025-12-14 15:30:45.587524	2025-12-14 15:30:45.587524	0	\N	\N
126	31	\N	晴れてて気持ちいいな	0	0	2025-12-05 05:48:35.615233	2025-12-05 14:26:55.056546
658	31	126	8	2025-12-05 05:48:49.615004	2025-12-05 05:48:49.615004
659	31	124	0	2025-12-05 05:48:59.21672	2025-12-05 05:48:59.21672
660	31	124	1	2025-12-05 05:49:00.258519	2025-12-05 05:49:00.258519
661	31	124	2	2025-12-05 05:49:00.674784	2025-12-05 05:49:00.674784
662	31	124	3	2025-12-05 05:49:03.006061	2025-12-05 05:49:03.006061
674	31	127	12	2025-12-05 11:54:57.410787	2025-12-05 11:54:57.410787
675	31	127	13	2025-12-05 11:54:58.309103	2025-12-05 11:54:58.309103
802	31	149	0	2025-12-11 12:00:18.340771	2025-12-11 12:00:18.340771
803	31	149	1	2025-12-11 12:00:18.912961	2025-12-11 12:00:18.912961
804	31	149	5	2025-12-11 12:00:19.376098	2025-12-11 12:00:19.376098
805	31	149	10	2025-12-11 12:00:19.758095	2025-12-11 12:00:19.758095
808	31	150	0	2025-12-14 13:07:26.92261	2025-12-14 13:07:26.92261
809	31	152	0	2025-12-14 13:07:33.697558	2025-12-14 13:07:33.697558
577	31	2025-12-20	101	4.47			2025-12-20 21:46:28.059844	2025-12-20 21:46:28.059844	6373	0	1
578	31	2025-12-18	49	2.92			2025-12-20 21:46:45.50814	2025-12-20 21:46:45.50814	4207	8	1
579	31	2025-12-17	31	2.64			2025-12-20 21:49:02.673603	2025-12-20 21:49:02.673603	3915	12	2
580	31	2025-12-15	65	5.25			2025-12-20 21:49:49.488367	2025-12-20 21:49:49.488367	5717	0	2
581	31	2025-12-16	55	4.21			2025-12-20 21:50:08.130495	2025-12-20 21:50:08.130495	3659	0	3
582	31	2025-12-12	97	7.86			2025-12-20 21:50:32.538125	2025-12-20 21:50:32.538125	9562	181	1
583	31	2025-12-13	162	7.16			2025-12-20 21:55:46.620813	2025-12-20 21:55:46.620813	10244	17	2
541	31	2025-12-05	30	5.0		天気よき	2025-12-05 05:40:22.401335	2025-12-05 05:40:22.401335	\N	\N	1
547	31	2025-12-06	60	2.26		applewatch ✖️ ヘルスケアアプリ✖️Google fit✖️てくメモで何もせずにデータが簡単連携できた！\n使いやすい✨	2025-12-06 05:04:38.681314	2025-12-06 05:04:38.681314	3038	0	1
549	31	2025-12-07	12	0.72		午前中ずっといえ	2025-12-07 03:06:45.293413	2025-12-07 03:06:45.293413	1078	0	1
551	31	2025-12-10	44	2.79			2025-12-10 13:32:50.671819	2025-12-10 13:35:49.64494	4075	8	3
560	31	2025-12-11	148	8.55			2025-12-11 11:58:14.915913	2025-12-11 11:58:14.915913	11160	56	3
566	31	2025-12-14	102	5.02			2025-12-14 13:07:10.520673	2025-12-14 13:07:10.520673	7188	28	3
</file>

<file path=".agent/fix-review.md">
# 修正内容のレビュー結果

## ✅ 修正完了項目

### 1. ゲストユーザーのチェック復活 ✓
- `User#google_token_status` に `return :valid if role == "admin"` を追加
- これにより管理者は常にGoogle Fit連携が有効として扱われる

### 2. GoogleFitService のダミーデータ生成復活 ✓  
- `fetch_dummy_activities` メソッドを復元
- `initialize` で管理者の場合はAPIクライアント初期化をスキップ
- `fetch_activities` で管理者の場合は `{ data: fetch_dummy_activities(...) }` を返す

### 3. N+1問題対策の見直し ✓
- `User.ranking` から `with_attached_uploaded_avatar` を削除
- GROUP BY との競合を回避
- N+1は許容（ランキング表示は最大100件、実際は上位10-20件程度）
- 必要に応じて将来的にキャッシュで対応可能

## 🔍 残りの検証項目

### A. トランザクション処理の動作確認
```ruby
ActiveRecord::Base.transaction do
  # ...
  if failed_dates.any?
    raise ActiveRecord::Rollback
  end
end
```

**検証結果**: 正しい実装
- `ActiveRecord::Rollback` は例外をキャッチされずにトランザクションのみロールバック
- その後のフラッシュメッセージ表示も意図通り動作

### B. エラーハンドリングの網羅性
```ruby
result = service.fetch_activities(start_date, end_date)

if result[:error]
  # エラー処理
end

activities = result[:data]
```

**潜在的な問題**: `result[:data]` が nil の場合
- Google API が空のデータを返した場合、`result[:data]` は `{}` (空ハッシュ)
- `activities.each` は動作するが、念のため `activities ||= {}` を追加すべきか？

**判断**: 不要
- `fetch_activities` の実装では必ず `{ data: result }` を返す
- `result` は `Hash.new` で初期化されているため、最悪でも `{}` が入る

### C. 管理者判定ロジックの一貫性
- Userモデル: `role == "admin"`  
- GoogleFitService: `@user.admin?`

**潜在的な問題**: enum の比較方法が異なる
- `role == "admin"` は文字列比較
- `admin?` は Rails の enum が自動生成するメソッド

**修正が必要**: Userモデルも `admin?` メソッドを使うべき

## 🛠️ 最終修正事項

1. User#google_token_status の管理者チェックを `admin?` メソッドに統一
</file>

<file path=".docs/PORTFOLIO_GUEST_MODE_SPEC.md">
# ポートフォリオ閲覧モード（ゲスト機能）実装詳細資料

このドキュメントは、採用担当者やゲストユーザー向けに実装された「ポートフォリオ閲覧モード」の全容、設計思想、コード変更点を詳細にまとめたものです。

## 1. 概要と設計思想

### 目的

Google アカウントを持たない（または連携したくない）ユーザーに対し、アプリの魅力を最大限に伝えるための「体験版」モードを提供する。

### コアコンセプト

1.  **リッチなデータ体験**: 空っぽの状態で始めるのではなく、管理者のデータを複製して「3 ヶ月使い込んだ状態」を再現する。
2.  **安全性**: ゲストは閲覧のみとし、投稿や破壊的な操作を禁止する。また、本物のユーザーデータ（個人情報）は管理画面等で見せない。
3.  **Google Fit 不要**: 外部 API に依存せず、プログラム内で仮想の歩数データを生成してグラフ等を機能させる。

## 2. 実装詳細

### A. ユーザー管理と認証 (`User` Model & Session)

**変更ファイル:**

- `app/models/user.rb`
- `app/controllers/users/sessions_controller.rb`

#### ゲストユーザー作成ロジック (`User.create_portfolio_guest`)

1.  **クローン元の選定**:
    - 本番環境での運用を想定し、`User.find_by(id: 2)` を最優先でコピー元とする。
    - 存在しない場合は `User.admin.first`、それもなければ `create_fallback_guest` で最低限のダミーを作成。
2.  **データコピー**:
    - **期間**: 直近 3 ヶ月分に限定。
    - **対象**: `Walk` (散歩記録), `Post` (投稿), `UserAchievement` (実績)。
    - **手法**: `insert_all` を使用して SQL レベルで一括挿入し、パフォーマンスを確保。バリデーションをスキップすることで高速化している点に注意。
3.  **自動削除**:
    - `User.cleanup_old_guests` により、作成から 24 時間経過したゲスト（`role: :guest`）を削除。

#### 認証フロー

- ゲストログインボタン押下 → `Users::SessionsController#new_guest`
- ログイン後、セッションが維持される間は通常の Devise ユーザーとして振る舞う。
- ログアウト時 (`destroy`)、即座にそのゲストユーザーレコードを DB から削除する。

### B. Google Fit 連携シミュレーション (`GoogleFitService`)

**変更ファイル:**

- `app/services/google_fit_service.rb`
- `app/models/user.rb`

#### トークン検証のモック化:

- `User#google_token_valid?` を修正し、`guest?` なら常に `true` を返すように変更。これにより、設定画面等で「連携済み」と表示される。

#### データ取得のインターセプト:

- `GoogleFitService#fetch_activities` 内でゲスト判定を行う。
- ゲストの場合、API クライアントの初期化をスキップし、`fetch_dummy_activities` メソッドを呼び出す。

#### ダミーデータ生成ロジック:

- 期間中の各日について、`5000 + rand(-1000..3000)` 歩を生成。
- 距離、カロリー、活動時間も歩数から概算して生成。

### C. 管理画面の閲覧制限 (`Admin::DashboardController`)

**変更ファイル:**

- `app/controllers/admin/dashboard_controller.rb`
- `app/views/admin/dashboard/index.html.erb`

#### アクセス制御:

- `require_admin_or_guest` フィルタを追加。

#### データ隠蔽（Controller 層）:

- ゲストアクセス時、`@recent_users` や `@popular_posts` に本物の ActiveRecord オブジェクトを渡さず、`OpenStruct` で作成したダミーオブジェクトを渡す。
- これにより、万が一ビュー側で漏洩があっても、実データはメモリ上に存在しない。
- グローバル統計（総ユーザー数など）は、賑やかしとして実数（または固定値）を表示。

#### UI 制限（View 層）:

- 機密情報エリアに `relative overflow-hidden` と条件付きクラス `blur-sm` (ぼかし) を適用。
- その上に「🔒 Restricted」等のオーバーレイを表示し、操作できないことを視覚的に伝える。

### D. 投稿機能の制限 (`PostsController`)

**変更ファイル:**

- `app/controllers/posts_controller.rb`
- `app/views/posts/index.html.erb`

#### サーバーサイド:

- `create` アクションの冒頭で `if current_user.guest?` をチェックし、投稿リクエストがあれば強制リダイレクト＆アラート表示。

#### フロントエンド:

- タイムライン上部の「新規投稿フォーム」を非表示にし、代わりに「ポートフォリオ閲覧モード中は投稿できません」というバナーを表示。

### E. ランキングの可視性制御 (`User`, `RankingsController`)

**変更ファイル:**

- `app/models/user.rb`
- `app/controllers/rankings_controller.rb`

#### スコープ分離 (`User.ranking_for`):

- **ゲスト用**: 自分を含む全ユーザーを表示（自分が何位か確認したい需要に応える）。
- **一般ユーザー用**: `where.not(role: :guest)` でゲストを除外（ランキングがゲストだらけになるのを防ぐ）。

#### キャッシュ戦略:

- ランキング計算は重いためキャッシュしているが、見る人によって中身が異なるようになった。
- キャッシュキーに `viewer_role` (guest/general) を追加し、キャッシュ汚染を防ぐ。

## 3. 検証済みのテスト仕様

以下の System Spec により、機能の正しさを保証しています。修正時はこれらがパスすることを確認してください。

- **`spec/system/guest_login_system_spec.rb`**

  - ゲストログインができること。
  - ログアウト後にユーザーデータが消えること。

- **`spec/system/guest_admin_dashboard_spec.rb`**

  - ゲストが管理画面に入れること。
  - 重要なリストが「ぼかし」表示されていること。
  - ダミーテキスト（"ダミーユーザー"など）が表示されていること。
  - 他の管理ページへのアクセスが拒否されること。

- **`spec/system/guest_google_fit_spec.rb`**

  - Google Fit 連携状態が有効 (`true`) であること。
  - API 経由（サービスメソッド）で歩数データが取得できること。

- **`spec/system/guest_mode_enhancement_spec.rb`**
  - 投稿一覧は見れるが、投稿フォームがないこと。
  - 具体的なデータ作成（Walk 等）を伴うランキング表示において、一般ユーザーからはゲストが見えず、ゲストからは自分が見えること。

## 4. 今後の拡張・保守に関する注意点

1.  **コピー元のユーザー ID**:
    - 現在 `User.find_by(id: 2)` をハードコード気味に優先しています（`user.rb:115`）。環境に合わせて変更するか、環境変数化 (`ENV['DEMO_SOURCE_USER_ID']`) することを検討してください。
2.  **非同期ジョブ**:
    - `GenerateRankingOgpImageJob` など、バックグラウンドジョブがゲストユーザーに対しても走る設計になっています。リソース節約のため、ゲストの場合はジョブ発行をスキップする等のチューニングの余地があります。
3.  **DB パフォーマンス**:
    - ゲスト作成時の `insert_all` は高速ですが、関連テーブルが増えた場合（例: コメント機能など）、手動で追記する必要があります。`deep_cloneable` gem などの導入も検討の価値があります。
</file>

<file path="app/controllers/admin/base_controller.rb">
module Admin
  class BaseController < ApplicationController
    before_action :authenticate_user!
    before_action :require_admin
    layout "admin"

    private

    def require_admin
      unless current_user.admin?
        redirect_to root_path, alert: "管理者権限が必要です。"
      end
    end

    def require_admin_or_guest
      unless current_user.admin? || current_user.guest?
        redirect_to root_path, alert: "管理者権限が必要です。"
      end
    end
  end
end
</file>

<file path="app/controllers/admin/users_controller.rb">
module Admin
  class UsersController < BaseController
    # ソートオプションのホワイトリスト
    ALLOWED_SORT_OPTIONS = {
      "last_login_asc" => Arel.sql("current_sign_in_at ASC NULLS LAST"),
      "last_login_desc" => Arel.sql("current_sign_in_at DESC NULLS LAST"),
      "created_at_asc" => { created_at: :asc },
      "created_at_desc" => { created_at: :desc }
    }.freeze

    def index
      @users = User.all

      # 検索（名前・メールアドレス）
      if params[:q].present?
        search_term = "%#{params[:q]}%"
        @users = @users.where("name ILIKE ? OR email ILIKE ?", search_term, search_term)
      end

      # フィルタ（権限）
      if params[:role].present?
        @users = @users.where(role: params[:role])
      end

      # ソート
      @users = @users.order(sort_clause)
      @users = @users.page(params[:page]).per(20)
    end

    def destroy
      @user = User.find(params[:id])
      @user.destroy
      redirect_to admin_users_path, notice: "ユーザー「#{@user.name}」を削除しました。"
    end

    private

    def sort_clause
      ALLOWED_SORT_OPTIONS.fetch(params[:sort], { created_at: :desc })
    end
  end
end
</file>

<file path="app/controllers/home_controller.rb">
class HomeController < ApplicationController
  # 未ログインユーザーもトップページ（LP）は見れるようにする
  skip_before_action :authenticate_user!, only: [ :index ]

  def index
    # ログイン前ユーザーにはLP土台を表示
    unless user_signed_in?
      render :landing
      return
    end

    # 以下、ダッシュボード用のロジック（ログイン後のみ）
    # ユーザーのIPアドレスを取得
    # プロキシ環境（Cloudflare等）では X-Forwarded-For ヘッダーの最初の値が実際のクライアントIP
    user_ip = GeolocationService.extract_ip(request)

    # デバッグ用：取得したIPアドレスをログに出力（本番環境では出力しない）
    Rails.logger.debug("========================================")
    Rails.logger.debug("リクエストIP情報:")
    Rails.logger.debug("  使用するIP: #{user_ip}")
    Rails.logger.debug("  remote_ip: #{request.remote_ip}")
    Rails.logger.debug("  ip: #{request.ip}")
    Rails.logger.debug("  X-Forwarded-For: #{request.headers['X-Forwarded-For']}")
    Rails.logger.debug("  X-Real-IP: #{request.headers['X-Real-IP']}")
    Rails.logger.debug("========================================")

    # IP位置情報を取得
    @location = GeolocationService.get_location(user_ip)

    # 位置情報の名前を設定
    @location_name = @location[:city] || @location[:region] || "不明な場所"

    # 天気情報を取得（位置情報を使用）
    # 外部APIへのリクエストを減らすため、1時間キャッシュする
    # キーには緯度経度を含める（場所が変われば再取得）
    weather_cache_key = "weather_cache_#{@location[:latitude]}_#{@location[:longitude]}"
    @weather = Rails.cache.fetch(weather_cache_key, expires_in: 1.hour) do
      WeatherService.get_forecast(
        lat: @location[:latitude],
        lon: @location[:longitude]
      )
    end

    # 今日の散歩記録を取得
    @today_walk = current_user.walks.find_by(walked_on: Date.current)

    # 最新の投稿を取得
    @latest_post = Post.with_associations.recent.first

    # 最新のお知らせを取得（公開中かつ有効期限内、最新3件）
    @announcements = Announcement.active.recent.limit(3)

    # 統計・RPGデータの取得
    @stats_service = StatsService.new(current_user)

    # ===== 月間ランキング情報の取得 =====
    # キャッシュキー: ユーザーIDと日付（月）ベース
    # ユーザー体験向上のため、15分ごとに更新する（モチベーション維持）
    # Time.current.to_i / 15.minutes.to_i で15分ごとのタイムスタンプを生成
    cache_timestamp = Time.current.to_i / 15.minutes.to_i
    cache_key = "ranking/monthly/#{current_user.id}/#{Date.current.strftime('%Y-%m')}/#{cache_timestamp}"

    ranking_data = Rails.cache.fetch(cache_key, expires_in: 15.minutes) do
      start_date = Date.current.beginning_of_month
      end_date = Date.current

      # 1. 自分の今月の総距離
      my_total_distance = current_user.walks.where(walks: { walked_on: start_date..end_date }).sum(:distance)

      # 2. 全ユーザー数（歩いていないユーザーも含む）
      total_users = User.count

      # 3. 自分の順位（自分より多く歩いている人数 + 1）
      #    SQL最適化: to_a.size でメモリ展開せず、サブクエリを使ってDB側でカウントする
      #    小数点以下の誤差対策: ROUND関数で小数点第2位までで比較する
      higher_rankers_query = User.joins(:walks)
                                 .where(walks: { walked_on: start_date..end_date })
                                 .group(:id)
                                 .having("ROUND(SUM(walks.distance), 2) > ?", my_total_distance.round(2))
                                 .select(:id) # SELECT句を最小限に

      # User.from を使ってサブクエリの結果セットの行数をカウント
      higher_rankers_count = User.from(higher_rankers_query, :users).count

      my_rank = higher_rankers_count + 1

      # 4. 上位何%か
      percentile = if total_users > 0
                     ((my_rank.to_f / total_users) * 100).ceil
      else
                     0
      end

      {
        rank: my_rank,
        total_users: total_users,
        percentile: percentile
      }
    end

    @my_rank = ranking_data[:rank]
    @ranking_total_users = ranking_data[:total_users]
    @ranking_percentile = ranking_data[:percentile]
  end
end
</file>

<file path="app/controllers/reactions_controller.rb">
class ReactionsController < ApplicationController
  before_action :authenticate_user!
  before_action :set_post

  # POST /posts/:post_id/reactions
  # リアクションを追加（トグル動作）
  def create
    # ゲストユーザーはリアクション不可
    if current_user.guest?
      respond_to do |format|
        format.json { render json: { error: "ゲストユーザーはリアクションできません" }, status: :forbidden }
        format.turbo_stream { render turbo_stream: turbo_stream.replace("flash", partial: "shared/flash", locals: { flash: { alert: "ゲストユーザーはリアクションできません" } }) }
        format.html { redirect_back(fallback_location: posts_path, alert: "ゲストユーザーはリアクションできません") }
      end
      return
    end

    # 既に同じリアクションがあるか確認
    @reaction = @post.reactions.find_by(user: current_user, kind: reaction_params[:kind])

    if @reaction
      # 既にある場合は削除（トグル動作）
      @reaction.destroy
      @action = "removed"
    else
      # 新しいリアクションを作成
      @reaction = @post.reactions.build(reaction_params)
      @reaction.user = current_user

      unless @reaction.save
        # 保存失敗時
        respond_to do |format|
          format.json { render json: { error: "リアクションできませんでした" }, status: :unprocessable_entity }
          format.any { redirect_back(fallback_location: posts_path, alert: "リアクションできませんでした") }
        end
        return
      end
      @action = "added"
    end

    respond_to do |format|
      # JSON: Stimulusコントローラー用（優先）
      format.json do
        render json: {
          reacted: @action == "added",
          count: @post.reactions.where(kind: reaction_params[:kind]).count
        }
      end
      # Turbo Stream: リアクションボタンのみ更新（既存機能維持）
      format.turbo_stream
      # HTML: 通常のリダイレクト
      format.html { redirect_back(fallback_location: posts_path) }
    end
  end

  # DELETE /posts/:post_id/reactions/:id
  # リアクションを削除
  def destroy
    # ゲストユーザーは削除不可
    if current_user.guest?
      respond_to do |format|
        format.turbo_stream { render turbo_stream: turbo_stream.replace("flash", partial: "shared/flash", locals: { flash: { alert: "ゲストユーザーは操作できません" } }) }
        format.html { redirect_back(fallback_location: posts_path, alert: "ゲストユーザーは操作できません") }
      end
      return
    end

    @reaction = @post.reactions.find_by(id: params[:id], user: current_user)

    if @reaction&.destroy
      respond_to do |format|
        format.turbo_stream
        format.html { redirect_back(fallback_location: posts_path) }
      end
    else
      redirect_back(fallback_location: posts_path, alert: "リアクションが見つかりませんでした")
    end
  end

  private

  # 対象の投稿を取得
  def set_post
    @post = Post.find(params[:post_id])
  end

  # 許可するパラメータ
  def reaction_params
    params.require(:reaction).permit(:kind)
  end
end
</file>

<file path="app/javascript/controllers/coach_mark_controller.js">
import { Controller } from "@hotwired/stimulus";

// ボトムナビ向けコーチマークコントローラー
export default class extends Controller {
  // ステップ定義
  steps = [
    {
      targetId: "nav-home",
      title: "ホーム 🏠",
      message: "ここがあなたの出発点！\n今日の運動量や最新情報を確認できます。",
    },
    {
      targetId: "nav-walk",
      title: "散歩 👣",
      message: "今日の散歩を振り返ったり、\n過去の記録を確認できます。",
    },
    {
      targetId: "nav-post",
      title: "投稿 💬",
      message: "今日の気分や散歩の様子を\nシェアして仲間と繋がろう！",
    },
    {
      targetId: "nav-stats",
      title: "記録 📊",
      message: "グラフや統計で、あなたの成長を\n視覚的にチェックできます。",
    },
    {
      targetId: "nav-rank",
      title: "ランキング 🏆",
      message: "全国のユーザーと歩数を競おう！\n上位入賞で特別なバッジも…？",
    },
  ];

  connect() {
    // 既に見たかチェック（キーはcoachMarkV1とする）
    const hasSeen = localStorage.getItem("hasSeenCoachMarkV1");

    if (!hasSeen) {
      setTimeout(() => {
        this.start();
      }, 1000); // 1秒後に開始
    }
  }

  start() {
    this.currentStepIndex = 0;
    this.showOverlay();
    this.showStep(0);
  }

  showOverlay() {
    if (!this.overlay) {
      this.overlay = document.createElement("div");
      this.overlay.className =
        "fixed inset-0 bg-black/70 z-[9998] transition-opacity duration-300 opacity-0";
      document.body.appendChild(this.overlay);

      // フェードイン
      setTimeout(() => {
        this.overlay.classList.remove("opacity-0");
      }, 10);
    }
  }

  showStep(index) {
    const step = this.steps[index];
    if (!step) {
      this.complete();
      return;
    }

    const target = document.getElementById(step.targetId);
    if (!target) {
      // ターゲットが見つからない場合はスキップ
      this.showStep(index + 1);
      return;
    }

    // ハイライト処理
    this.highlightElement(target);

    // ツールチップ表示
    this.showTooltip(target, step);
  }

  highlightElement(element) {
    // 前のハイライトを解除
    if (this.currentHighlight) {
      this.currentHighlight.style.zIndex = "";
      this.currentHighlight.style.position = "";
      this.currentHighlight.classList.remove("relative");
    }

    // 今回の要素をハイライト
    element.style.position = "relative";
    element.style.zIndex = "9999"; // ツールチップ(10000)より下、オーバーレイ(9998)より上
    this.currentHighlight = element;

    // スポットライト効果（光る枠線）
    if (!this.spotlight) {
      this.spotlight = document.createElement("div");
      this.spotlight.className =
        "fixed pointer-events-none z-[9999] transition-all duration-300 rounded-full border-4 border-white/50 shadow-[0_0_30px_rgba(255,255,255,0.5)] animate-pulse";
      document.body.appendChild(this.spotlight);
    }

    const rect = element.getBoundingClientRect();
    // 少し大きめに枠を表示
    this.spotlight.style.top = `${rect.top - 5}px`;
    this.spotlight.style.left = `${rect.left - 5}px`;
    this.spotlight.style.width = `${rect.width + 10}px`;
    this.spotlight.style.height = `${rect.height + 10}px`;
  }

  showTooltip(target, step) {
    if (this.tooltip) {
      this.tooltip.remove();
    }

    this.tooltip = document.createElement("div");
    this.tooltip.className =
      "fixed z-[10000] w-64 max-w-[90vw] transition-all duration-300 opacity-0 transform translate-y-4";

    const isLast = this.currentStepIndex >= this.steps.length - 1;

    this.tooltip.innerHTML = `
      <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-4 border border-gray-100 dark:border-slate-700 relative">
        <!-- 吹き出しの三角（下向き） -->
        <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-4 h-4 bg-white dark:bg-slate-800 rotate-45 border-b border-r border-gray-100 dark:border-slate-700"></div>

        <h3 class="font-bold text-lg text-gray-800 dark:text-white mb-2">${
          step.title
        }</h3>
        <p class="text-sm text-gray-600 dark:text-slate-300 mb-4 whitespace-pre-wrap leading-relaxed">${
          step.message
        }</p>

        <div class="flex justify-between items-center">
          <div class="flex space-x-1">
            ${this.steps
              .map(
                (_, i) => `
              <div class="w-1.5 h-1.5 rounded-full ${
                i === this.currentStepIndex
                  ? "bg-blue-500"
                  : "bg-gray-200 dark:bg-slate-600"
              }"></div>
            `
              )
              .join("")}
          </div>

          <div class="flex gap-2">
            <button id="coach-skip-btn" class="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 px-2">スキップ</button>
            <button id="coach-next-btn" class="text-xs bg-blue-500 hover:bg-blue-600 text-white font-bold py-1.5 px-4 rounded-full transition-colors shadow-md">
              ${isLast ? "完了！" : "次へ"}
            </button>
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(this.tooltip);

    // イベントリスナー
    document
      .getElementById("coach-skip-btn")
      .addEventListener("click", () => this.complete());
    document.getElementById("coach-next-btn").addEventListener("click", () => {
      this.currentStepIndex++;
      this.showStep(this.currentStepIndex);
    });

    // 位置計算（ターゲットの上に表示）
    const rect = target.getBoundingClientRect();
    const tooltipRect = this.tooltip.getBoundingClientRect(); // まだDOMに追加した直後でサイズが取れないかも？

    // 一度表示してサイズを取得
    this.tooltip.style.visibility = "hidden";
    this.tooltip.style.display = "block";
    const finalRect = this.tooltip.getBoundingClientRect();
    this.tooltip.style.visibility = "visible";

    // 画面中央に寄せるためのオフセット
    const left = Math.max(
      10,
      Math.min(
        window.innerWidth - finalRect.width - 10,
        rect.left + rect.width / 2 - finalRect.width / 2
      )
    );
    const top = rect.top - finalRect.height - 20; // 20px上に

    this.tooltip.style.left = `${left}px`;
    this.tooltip.style.top = `${top}px`;

    // アニメーション
    requestAnimationFrame(() => {
      this.tooltip.classList.remove("opacity-0", "translate-y-4");
    });
  }

  complete() {
    // 片付け
    if (this.overlay) this.overlay.remove();
    if (this.tooltip) this.tooltip.remove();
    if (this.spotlight) this.spotlight.remove();

    if (this.currentHighlight) {
      this.currentHighlight.style.zIndex = "";
      this.currentHighlight.style.position = "";
    }

    // 記録
    localStorage.setItem("hasSeenCoachMarkV1", "true");
  }
}
</file>

<file path="app/javascript/controllers/google_fit_controller.js">
// Google Fit連携のStimulus化のためのコントローラ  by Gemini3
import { Controller } from "@hotwired/stimulus"

// Connects to data-controller="google-fit"
export default class extends Controller {
  // 操作したい要素（ターゲット）を定義
  static targets = ["button", "status", "date", "steps", "calories", "distance", "duration"]

  connect() {
    // 接続確認用（ブラウザのコンソールに表示されます）
    console.log("Google Fit Controller Connected! 🚀")
  }

  // ボタンがクリックされたら実行されるアクション
  async fetch(event) {
    event.preventDefault() // フォーム送信などを防ぐ

    // 日付が選択されているかチェック
    const date = this.dateTarget.value
    if (!date) {
      alert("日付を選択してください")
      return
    }

    // 1. ローディング開始：ボタンを押せなくして、スピナーを表示する
    this.buttonTarget.disabled = true
    const originalContent = this.buttonTarget.innerHTML

    // ローディングスピナーのHTML
    const spinnerHtml = `
      <div class="flex items-center justify-center w-full py-1">
        <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-blue-500 dark:text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="font-bold text-blue-600 dark:text-cyan-400">データ取得中...</span>
      </div>
    `
    this.buttonTarget.innerHTML = spinnerHtml
    this.statusTarget.textContent = "同期を開始しました..."
    this.statusTarget.classList.remove("text-red-500", "text-green-500", "text-orange-500")

    try {
      // 2. サーバーにデータを問い合わせる（30秒のタイムアウト設定）
      const response = await fetch(`/google_fit/daily_data?date=${date}`, {
        headers: {
          'Accept': 'application/json'
        },
        signal: AbortSignal.timeout(30000) // 30秒でタイムアウト
      })

      // レスポンスのJSONを先にパース（エラーレスポンスにも対応）
      const data = await response.json()

      // HTTPステータスコードに応じたエラーハンドリング
      if (!response.ok) {
        if (response.status === 401) {
          // 認証エラー：Googleとの連携が切れている
          this.statusTarget.textContent = "認証が切れました。再度Googleと連携してください。"
          this.statusTarget.classList.add("text-red-500")
          alert("Google認証の有効期限が切れました。\n設定画面で再度Google Fitと連携してください。")
          return
        } else if (response.status === 429) {
          // レート制限：リクエストが多すぎる
          this.statusTarget.textContent = "リクエスト制限中です。しばらく待ってから再試行してください。"
          this.statusTarget.classList.add("text-orange-500")
          alert("一時的にリクエスト制限がかかっています。\n数分待ってから再度お試しください。")
          return
        }
        // その他のHTTPエラー
        throw new Error(data.error || "データの取得に失敗しました")
      }

      // 3. 取得したデータを画面（入力欄）にセットする
      this.dateTarget.value = data.date || ""
      this.stepsTarget.value = data.steps || 0
      this.caloriesTarget.value = data.calories || 0
      this.distanceTarget.value = data.distance || 0
      this.durationTarget.value = data.duration || 0

      // 時間帯の自動選択
      if (data.start_time) {
        const startTime = new Date(data.start_time)
        const hour = startTime.getHours()
        let timeOfDay = "night"

        if (hour >= 4 && hour <= 8) {
          timeOfDay = "early_morning"
        } else if (hour >= 9 && hour <= 15) {
          timeOfDay = "day"
        } else if (hour >= 16 && hour <= 18) {
          timeOfDay = "evening"
        }

        // 対応するラジオボタンを選択
        const radio = this.element.querySelector(`input[name="walk[time_of_day]"][value="${timeOfDay}"]`)
        if (radio) {
          radio.checked = true
          // changeイベントを発火させてicon-selectコントローラーに通知
          radio.dispatchEvent(new Event("change", { bubbles: true }))
        }
      }

      // 4. 成功メッセージ
      this.statusTarget.textContent = "同期完了！✨"
      this.statusTarget.classList.add("text-green-500")

    } catch (error) {
      // 5. エラー時の処理（種類別に対応）
      console.error("Google Fit fetch error:", error)

      if (error.name === 'TimeoutError' || error.name === 'AbortError') {
        // タイムアウトエラー：通信に時間がかかりすぎた
        this.statusTarget.textContent = "タイムアウトしました。ネットワーク接続を確認してください。"
        this.statusTarget.classList.add("text-orange-500")
        alert("通信がタイムアウトしました。\n電波の良い場所で再度お試しください。")
      } else if (!navigator.onLine) {
        // オフライン：ネットワークに接続されていない
        this.statusTarget.textContent = "オフラインです。ネットワークに接続してください。"
        this.statusTarget.classList.add("text-red-500")
        alert("インターネットに接続されていません。\nWi-Fiやモバイルデータ通信を確認してください。")
      } else {
        // その他のエラー
        this.statusTarget.textContent = "エラーが発生しました。再試行してください。"
        this.statusTarget.classList.add("text-red-500")
        alert("Google Fitからのデータ取得に失敗しました。\nしばらく時間をおいて再度お試しください。")
      }

    } finally {
      // 6. 後始末：ボタンを元に戻す
      this.buttonTarget.disabled = false
      this.buttonTarget.innerHTML = originalContent
    }
  }
}
</file>

<file path="app/javascript/controllers/modal_controller.js">
import { Controller } from "@hotwired/stimulus"

// モーダル制御用コントローラー
export default class extends Controller {
  static values = {
    dialogId: String,
    autoOpenParam: String // URLパラメータのキー（例: 'open_modal'）を指定
  }

  connect() {
    // ページ読み込み時に自動オープン設定があるかチェック
    if (this.hasAutoOpenParamValue) {
      this.checkAutoOpen()
    }
  }

  checkAutoOpen() {
    const urlParams = new URLSearchParams(window.location.search)
    if (urlParams.get(this.autoOpenParamValue) === 'true') {
      // 少し遅延させて実行しないと、アニメーションや他の初期化と競合する場合がある
      setTimeout(() => {
        // 自分自身がdialog要素の場合は直接開く、そうでなければIDで探す
        if (this.element.tagName === 'DIALOG') {
          this.openDialogElement(this.element)
        } else {
          this.open()
        }
      }, 100)
      
      this.cleanUrl()
    }
  }

  cleanUrl() {
    // URLからパラメータを削除
    const url = new URL(window.location)
    url.searchParams.delete(this.autoOpenParamValue)
    window.history.replaceState({}, '', url)
  }

  open() {
    const dialog = document.getElementById(this.dialogIdValue)
    if (dialog) {
      this.openDialogElement(dialog)
    }
  }

  openDialogElement(dialog) {
    dialog.showModal()
    document.body.classList.add('overflow-hidden')

    // ダイアログ外クリックで閉じるイベントを登録
    dialog.addEventListener('click', (e) => {
      if (e.target === dialog) {
        this.closeDialog(dialog)
      }
    }, { once: true })
  }

  close() {
    // コントローラーがアタッチされている要素の親のdialogを探す
    const dialog = this.element.closest('dialog')
    if (dialog) {
      this.closeDialog(dialog)
    }
  }

  closeDialog(dialog) {
    dialog.close()
    document.body.classList.remove('overflow-hidden')
  }
}
</file>

<file path="app/javascript/controllers/ogp_preview_controller.js">
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
  static targets = ["modal", "image", "loading", "container"]
  static values = {
    retryCount: { type: Number, default: 0 },
    maxRetries: { type: Number, default: 5 }
  }

  connect() {
    // ESCキーで閉じる
    this.boundHandleKeydown = this.handleKeydown.bind(this)
    document.addEventListener("keydown", this.boundHandleKeydown)

    // ページ内の他のOGP画像更新イベントを購読
    this.boundHandleSync = this.handleSync.bind(this)
    document.addEventListener("ogp:refresh", this.boundHandleSync)

    // モーダルオープンイベントを購読
    this.boundHandleOpen = this.handleOpen.bind(this)
    document.addEventListener("ogp:open", this.boundHandleOpen)
  }

  disconnect() {
    document.removeEventListener("keydown", this.boundHandleKeydown)
    document.removeEventListener("ogp:refresh", this.boundHandleSync)
    document.removeEventListener("ogp:open", this.boundHandleOpen)
  }

  // モーダルを開くイベントハンドラ
  handleOpen() {
    this.open()
  }

  // モーダルを開く
  open(e) {
    if (e) e.preventDefault()
    if (!this.hasModalTarget) return

    this.modalTarget.classList.remove("hidden")

    // フェードイン
    requestAnimationFrame(() => {
      this.modalTarget.style.opacity = "1"
    })

    this.retryCountValue = 0
  }

  // 背景クリック時のみ閉じる（中身のクリックは無視）
  closeBackground(e) {
    if (e && this.containerTarget.contains(e.target)) return
    this.close(e)
  }

  // モーダルを閉じる（強制）
  close(e) {
    if (e) e.preventDefault()

    this.modalTarget.style.opacity = "0"
    setTimeout(() => {
      this.modalTarget.classList.add("hidden")
    }, 200)
  }

  // キーボードイベント処理
  handleKeydown(e) {
    if (e.key === "Escape" && !this.modalTarget.classList.contains("hidden")) {
      this.close()
    }
  }

  // 画像をリフレッシュ（同期イベント発火）
  refresh() {
    // 自分の画像を更新
    this.reloadImage()

    // 他のコンポーネントにも更新を通知
    const event = new CustomEvent("ogp:refresh")
    document.dispatchEvent(event)
  }

  // 外部からの更新イベントを受信
  handleSync() {
    // 自分が発火元でない場合のみ更新（無限ループ防止はreloadImage内のロジックで制御してもよいが、ここでは単純にリロード）
    // ただし、モーダルが開いていない場合は無駄なロードを避けるなどの最適化も可能
    // 今回は「同期」が目的なので、開いていなくても裏で更新しておくと次回開いたときに最新になる
    this.reloadImage()
  }

  // 画像再読み込みの実処理
  reloadImage() {
    // ローディング表示
    this.loadingTarget.style.display = "flex"
    this.imageTarget.classList.remove("opacity-100")
    this.imageTarget.classList.add("opacity-0")

    // 現在のsrcを取得し、refreshパラメータを付与
    const currentSrc = new URL(this.imageTarget.src)
    currentSrc.searchParams.set("refresh", "true")
    currentSrc.searchParams.set("v", new Date().getTime()) // キャッシュバスター

    // 画像を再読み込み
    this.imageTarget.src = currentSrc.toString()
  }

  // 画像読み込み成功
  handleLoad() {
    this.loadingTarget.style.display = "none"
    this.imageTarget.classList.remove("opacity-0")
    this.imageTarget.classList.add("opacity-100")
  }

  // 画像読み込み失敗（生成中の可能性）
  handleError() {
    if (this.retryCountValue < this.maxRetriesValue) {
      this.retryCountValue++

      // ローディングメッセージ更新
      const loadingText = this.loadingTarget.querySelector("p.font-bold")
      if (loadingText) {
        loadingText.textContent = `画像を生成中... (${this.retryCountValue}/${this.maxRetriesValue})`
      }

      // 2秒後にリトライ
      setTimeout(() => {
        const currentSrc = new URL(this.imageTarget.src)
        currentSrc.searchParams.set("v", new Date().getTime())
        this.imageTarget.src = currentSrc.toString()
      }, 2000)
    } else {
      // リトライ上限
      this.loadingTarget.innerHTML = `
        <div class="text-center">
          <span class="text-4xl">⚠️</span>
          <p class="mt-4 text-sm font-bold text-slate-600 dark:text-purple-300">画像の読み込みに失敗しました</p>
          <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">ページをリロードしてください</p>
        </div>
      `
    }
  }
}
</file>

<file path="app/views/devise/registrations/new.html.erb">
<% content_for :title, "てくメモ - 新規登録" %>

<div class="flex flex-1 flex-col items-center justify-center p-4 pb-24 relative overflow-hidden">
  <!-- 背景装飾（アニメーション付きオーブ） -->
  <div class="hidden dark:block absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-blue-400/20 dark:bg-blue-600/10 rounded-full blur-[100px] pointer-events-none animate-pulse-slow"></div>
  <div class="hidden dark:block absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-purple-400/20 dark:bg-purple-600/10 rounded-full blur-[100px] pointer-events-none animate-pulse-slow" style="animation-delay: 1s;"></div>
  <div class="w-full max-w-md bg-[radial-gradient(120%_120%_at_50%_50%,rgba(255,255,255,0.9)_0%,rgba(255,255,255,0.6)_100%)] dark:bg-none dark:bg-slate-950/60 backdrop-blur-xl border border-white/60 dark:border-white/10 shadow-[20px_20px_60px_rgba(59,130,246,0.15),-20px_-20px_60px_rgba(255,255,255,0.8),inset_0_0_0_1px_rgba(255,255,255,0.5)] dark:shadow-[0_0_50px_rgba(0,0,0,0.5),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.2),inset_0_-20px_30px_-10px_rgba(6,182,212,0.15)] rounded-[2.5rem] p-6 sm:p-8 transition-all duration-300 relative overflow-hidden group before:absolute before:inset-0 before:bg-gradient-to-b before:from-white/5 before:to-transparent before:opacity-0 dark:before:opacity-100 before:pointer-events-none before:animate-pulse">

    <!-- Header -->
    <div class="mb-8 flex flex-col items-center">
      <h1 class="text-3xl font-bold text-gray-800 dark:text-slate-50">ようこそ!</h1>
      <p class="mt-2 text-base text-gray-600 dark:text-slate-400">アカウントを作成して始めましょう</p>
    </div>

    <!-- Registration Form -->
    <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { class: "space-y-6" }) do |f| %>

      <!-- Error Messages -->
      <%= render "devise/shared/error_messages", resource: resource %>

      <!-- Name Field -->
      <div class="space-y-2">
        <%= f.label :name, "ユーザー名（表示名）", class: "block text-base font-medium text-gray-700 dark:text-slate-300" %>
        <div class="relative">
          <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500">badge</span>
          <%= f.text_field :name,
              autofocus: true,
              autocomplete: "name",
              placeholder: "表示名（例: てくメモ太郎）",
              class: "block w-full h-14 pl-12 pr-4 text-base text-gray-900 bg-white dark:bg-slate-950/50 border border-black/5 dark:border-white/10 rounded-2xl shadow-inner dark:shadow-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent dark:text-white dark:placeholder-slate-500 dark:focus:shadow-[0_0_15px_rgba(6,182,212,0.4)] transition-all duration-200" %>
        </div>
      </div>

      <!-- Email Field -->
      <div class="space-y-2">
        <%= f.label :email, "メールアドレス", class: "block text-base font-medium text-gray-700 dark:text-slate-300" %>
        <div class="relative">
          <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500">mail</span>
          <%= f.email_field :email,
              autocomplete: "email",
              placeholder: "メールアドレス",
              class: "block w-full h-14 pl-12 pr-4 text-base text-gray-900 bg-white dark:bg-slate-950/50 border border-black/5 dark:border-white/10 rounded-2xl shadow-inner dark:shadow-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent dark:text-white dark:placeholder-slate-500 dark:focus:shadow-[0_0_15px_rgba(6,182,212,0.4)] transition-all duration-200" %>
        </div>
      </div>

      <!-- Password Field -->
      <div class="space-y-2">
        <%= f.label :password, "パスワード", for: "register-password-field", class: "block text-base font-medium text-gray-700 dark:text-slate-300" %>
        <% if @minimum_password_length %>
          <p class="text-xs text-gray-500 dark:text-slate-400">(<%= @minimum_password_length %>文字以上)</p>
        <% end %>
        <div class="relative">
          <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500">lock</span>
          <%= f.password_field :password,
              autocomplete: "new-password",
              placeholder: "パスワード",
              id: "register-password-field",
              class: "block w-full h-14 pl-12 pr-12 text-base text-gray-900 bg-white dark:bg-slate-950/50 border border-black/5 dark:border-white/10 rounded-2xl shadow-inner dark:shadow-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent dark:text-white dark:placeholder-slate-500 dark:focus:shadow-[0_0_15px_rgba(6,182,212,0.4)] transition-all duration-200" %>
          <button type="button"
                  onclick="togglePasswordVisibility('register-password-field', 'register-password-icon')"
                  class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500 hover:text-gray-600 dark:hover:text-slate-300 transition-colors">
            <span class="material-symbols-outlined" id="register-password-icon">visibility</span>
          </button>
        </div>
      </div>

      <!-- Password Confirmation Field -->
      <div class="space-y-2">
        <%= f.label :password_confirmation, "パスワード(確認用)", for: "register-password-confirmation-field", class: "block text-base font-medium text-gray-700 dark:text-slate-300" %>
        <div class="relative">
          <span class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500">lock</span>
          <%= f.password_field :password_confirmation,
              autocomplete: "new-password",
              placeholder: "パスワード(確認用)",
              id: "register-password-confirmation-field",
              class: "block w-full h-14 pl-12 pr-12 text-base text-gray-900 bg-white dark:bg-slate-950/50 border border-black/5 dark:border-white/10 rounded-2xl shadow-inner dark:shadow-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent dark:text-white dark:placeholder-slate-500 dark:focus:shadow-[0_0_15px_rgba(6,182,212,0.4)] transition-all duration-200" %>
          <button type="button"
                  onclick="togglePasswordVisibility('register-password-confirmation-field', 'register-password-confirmation-icon')"
                  class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500 hover:text-gray-600 dark:hover:text-slate-300 transition-colors">
            <span class="material-symbols-outlined" id="register-password-confirmation-icon">visibility</span>
          </button>
        </div>
      </div>

      <!-- 注意書き -->
      <p class="text-xs text-red-500 dark:text-red-400 mt-2 mb-4">
        ※パスワード再設定メールはMVPでは未実装です。パスワードは忘れないよう管理してください。
      </p>

      <!-- Submit Button -->
      <div>
        <%= f.submit "登録する",
            class: "w-full h-14 bg-[radial-gradient(ellipse_110%_110%_at_30%_30%,#22d3ee_15%,#0ea5e9_90%)] dark:bg-gradient-to-r dark:from-cyan-500 dark:to-blue-600 hover:scale-[1.02] active:scale-95 text-white text-base font-bold rounded-full shadow-[8px_8px_16px_rgba(6,182,212,0.4),-8px_-8px_16px_rgba(255,255,255,1),inset_-2px_-2px_5px_rgba(8,145,178,0.4),inset_2px_2px_5px_rgba(165,243,252,0.5)] dark:shadow-[0_0_20px_rgba(6,182,212,0.5),inset_0_1px_0_rgba(255,255,255,0.4),inset_0_-2px_5px_rgba(0,0,0,0.3)] dark:hover:shadow-[0_0_30px_rgba(6,182,212,0.7),inset_0_1px_0_rgba(255,255,255,0.6)] transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-offset-2 dark:ring-offset-slate-900 relative overflow-hidden" %>
      </div>
    <% end %>

    <!-- Divider -->
    <div class="my-8 flex items-center">
      <div class="flex-1 border-t border-gray-300 dark:border-white/10"></div>
      <span class="px-4 text-sm text-gray-500 dark:text-slate-400">または</span>
      <div class="flex-1 border-t border-gray-300 dark:border-white/10"></div>
    </div>



    <!-- Login Link -->
    <div class="mt-8 text-center">
      <p class="text-base text-gray-600 dark:text-slate-400">すでにアカウントをお持ちですか?</p>
      <%= link_to "ログイン", new_session_path(resource_name), class: "inline-block mt-2 font-bold text-lg text-cyan-600 dark:text-cyan-400 hover:underline" %>
    </div>

  </div>
</div>

<style>
@keyframes pulse-slow {
  0%, 100% { opacity: 0.3; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.05); }
}
.animate-pulse-slow {
  animation: pulse-slow 4s ease-in-out infinite;
}
</style>

<script>
function togglePasswordVisibility(fieldId, iconId) {
  const field = document.getElementById(fieldId);
  const icon = document.getElementById(iconId);

  if (!field || !icon) return;

  if (field.type === 'password') {
    field.type = 'text';
    icon.textContent = 'visibility_off';
  } else {
    field.type = 'password';
    icon.textContent = 'visibility';
  }
}
</script>
</file>

<file path="app/views/notifications/index.html.erb">
<% content_for :title, '通知一覧 - てくメモ' %>

<div class="min-h-screen py-8 px-4 pb-24">
  <div class="max-w-2xl mx-auto">
    <%# ヘッダー %>
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">
        🔔 通知
      </h1>
    </div>

    <%# タブナビゲーション %>
    <div class="mb-6">
      <div class="bg-white/70 dark:bg-slate-900/40 backdrop-blur-md rounded-3xl border-2 border-white/60 dark:border-white/10 dark:border-t-white/40 shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_30px_rgba(99,102,241,0.15)] p-1 flex gap-1 relative overflow-hidden">
        <%= link_to notifications_path(tab: 'announcements'),
                    class: "flex-1 py-3 px-4 rounded-lg font-medium transition-all text-center #{@tab == 'announcements' ? 'bg-blue-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-white/10'}" do %>
          <div class="flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-xl">campaign</span>
            <span>お知らせ</span>
            <% if @announcement_unread_count > 0 %>
              <span class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full"><%= @announcement_unread_count %></span>
            <% end %>
          </div>
        <% end %>

        <%= link_to notifications_path(tab: 'reminders'),
                    class: "flex-1 py-3 px-4 rounded-lg font-medium transition-all text-center #{@tab == 'reminders' ? 'bg-purple-500 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-white/10'}" do %>
          <div class="flex items-center justify-center gap-2">
            <span class="material-symbols-outlined text-xl">notifications_active</span>
            <span>リマインダー</span>
          </div>
        <% end %>
      </div>
    </div>

    <%# お知らせタブ: 既読ボタンと未読数表示 %>
    <% if @tab == 'announcements' && @announcement_unread_count > 0 %>
      <div class="mb-4 flex items-center justify-between">
        <p class="text-gray-600 dark:text-gray-300">
          未読: <span class="font-bold text-blue-600 dark:text-cyan-400"><%= @announcement_unread_count %></span>件
        </p>
        <%= button_to '全て既読にする', mark_all_as_read_notifications_path,
                      method: :patch,
                      class: 'px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 dark:from-cyan-400 dark:to-blue-500 hover:-translate-y-0.5 active:scale-95 text-white rounded-full border-2 border-white/30 dark:border-white/20 shadow-[0_8px_20px_rgba(59,130,246,0.3),inset_0_1px_0_rgba(255,255,255,0.4)] hover:shadow-[0_10px_25px_rgba(59,130,246,0.5),inset_0_1px_0_rgba(255,255,255,0.5)] dark:shadow-[0_0_20px_rgba(34,211,238,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:hover:shadow-[0_0_40px_rgba(34,211,238,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] text-sm transition-all duration-300',
                      data: { turbo_confirm: '全ての通知を既読にしますか？' } %>
      </div>
    <% end %>

    <%# 通知リスト %>
    <div class="space-y-3">
      <% if @notifications.any? %>
        <% @notifications.each do |notification| %>
          <% if @tab == 'announcements' %>
            <%# お知らせカード %>
            <div class="relative bg-[#fdfbf7] dark:bg-slate-900/40 dark:backdrop-blur-xl rounded-3xl border-2 <%= notification.unread? ? 'border-blue-300 dark:border-cyan-500/50 dark:border-t-white/40' : 'border-white/60 dark:border-white/10 dark:border-t-white/40' %> p-4 shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8),0_4px_10px_rgba(0,0,0,0.08)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_30px_rgba(34,211,238,0.2)] overflow-hidden group"><div class="absolute inset-0 bg-gradient-to-br from-white/80 via-white/40 to-transparent dark:from-white/10 dark:via-white/5 dark:to-transparent pointer-events-none"></div><div class="relative z-10">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <%# バッジ %>
                  <div class="flex items-center gap-2 mb-2">
                    <% if notification.unread? %>
                      <span class="inline-block w-2 h-2 bg-blue-500 rounded-full"></span>
                    <% end %>

                    <% if notification.announcement.announcement_type == 'urgent' %>
                      <span class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">緊急</span>
                    <% elsif notification.announcement.announcement_type == 'warning' %>
                      <span class="text-xs font-bold px-2 py-0.5 rounded-full" style="background-color: #eab308; color: #000;">重要</span>
                    <% else %>
                      <span class="bg-blue-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">NEW</span>
                    <% end %>

                    <span class="text-sm text-gray-500 dark:text-gray-400">
                      <%= notification.announcement.published_at&.strftime('%Y/%m/%d') %>
                    </span>
                  </div>

                  <%# タイトル %>
                  <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-1">
                    <%= notification.title %>
                  </h3>

                  <%# 内容 %>
                  <p class="text-gray-600 dark:text-gray-300 text-sm">
                    <%= notification.announcement.content %>
                  </p>
                </div>

                <%# 既読ボタン/ステータス %>
                <div class="ml-4 flex-shrink-0">
                  <% if notification.unread? %>
                    <%= button_to mark_as_read_notification_path(notification),
                                  method: :patch,
                                  class: 'px-4 py-2 bg-gradient-to-r from-blue-500 to-cyan-500 dark:from-cyan-400 dark:to-blue-500 hover:-translate-y-0.5 active:scale-95 text-white rounded-full border-2 border-white/30 dark:border-white/20 shadow-[0_6px_15px_rgba(59,130,246,0.3),inset_0_1px_0_rgba(255,255,255,0.4)] hover:shadow-[0_8px_20px_rgba(59,130,246,0.5),inset_0_1px_0_rgba(255,255,255,0.5)] dark:shadow-[0_0_15px_rgba(34,211,238,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:hover:shadow-[0_0_30px_rgba(34,211,238,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] text-sm font-medium transition-all duration-300 flex items-center gap-1' do %>
                      <span class="material-symbols-outlined text-base">check_circle</span>
                      <span>既読にする</span>
                    <% end %>
                  <% else %>
                    <div class="px-4 py-2 text-gray-400 dark:text-gray-500 rounded-lg text-sm font-medium flex items-center gap-1">
                      <span class="material-symbols-outlined text-base">done_all</span>
                      <span>既読済み</span>
                    </div>
                  <% end %>
                </div>
              </div>
            </div></div>

          <% else %>
            <%# リマインダーカード（既読機能なし） %>
            <% if notification.link_url.present? %>
              <%= link_to notification.link_url, class: "block" do %>
                <div class="relative bg-[#fdfbf7] dark:bg-slate-900/40 dark:backdrop-blur-xl rounded-3xl border-2 border-purple-200/60 dark:border-purple-500/30 dark:border-t-white/40 p-4 shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8),0_4px_10px_rgba(168,85,247,0.08)] hover:shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8),0_8px_20px_rgba(168,85,247,0.15)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_30px_rgba(168,85,247,0.2)] dark:hover:shadow-[inset_0_1px_0_rgba(255,255,255,0.5),0_0_60px_rgba(168,85,247,0.4)] hover:border-purple-300 dark:hover:border-purple-500/50 hover:-translate-y-0.5 transition-all duration-300 overflow-hidden group"><div class="absolute inset-0 bg-gradient-to-br from-white/80 via-white/40 to-transparent dark:from-white/10 dark:via-white/5 dark:to-transparent pointer-events-none"></div><div class="absolute -top-10 -right-10 w-32 h-32 bg-gradient-to-br from-purple-400/15 to-pink-400/15 dark:from-purple-400/20 dark:to-fuchsia-400/20 rounded-full blur-2xl dark:blur-3xl pointer-events-none"></div><div class="relative z-10">
                  <div class="flex items-start gap-3">
                    <%# アイコン %>
                    <div class="flex-shrink-0">
                      <% if notification.notification_type_inactive_reminder? %>
                        <div class="w-10 h-10 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center">
                          <span class="material-symbols-outlined text-orange-600 dark:text-orange-400">directions_walk</span>
                        </div>
                      <% elsif notification.notification_type_reaction_summary? %>
                        <div class="w-10 h-10 bg-pink-100 dark:bg-pink-900/30 rounded-full flex items-center justify-center">
                          <span class="material-symbols-outlined text-pink-600 dark:text-pink-400">favorite</span>
                        </div>
                      <% end %>
                    </div>

                    <div class="flex-1">
                      <%# タイトル %>
                      <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-1">
                        <%= notification.title %>
                      </h3>

                      <%# メッセージ %>
                      <p class="text-gray-600 dark:text-gray-300 text-sm mb-2">
                        <%= notification.body %>
                      </p>

                      <%# 日時 %>
                      <span class="text-xs text-gray-500 dark:text-gray-400">
                        <%= notification.created_at.strftime('%Y/%m/%d %H:%M') %>
                      </span>
                    </div>

                    <%# リンクアイコン %>
                    <div class="flex-shrink-0">
                      <span class="material-symbols-outlined text-gray-400">arrow_forward</span>
                    </div>
                  </div>
                </div></div>
              <% end %>
            <% else %>
              <div class="relative bg-[#fdfbf7] dark:bg-slate-900/40 dark:backdrop-blur-xl rounded-3xl border-2 border-purple-200/60 dark:border-purple-500/30 dark:border-t-white/40 p-4 shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8),0_4px_10px_rgba(168,85,247,0.08)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_30px_rgba(168,85,247,0.2)] overflow-hidden group"><div class="absolute inset-0 bg-gradient-to-br from-white/80 via-white/40 to-transparent dark:from-white/10 dark:via-white/5 dark:to-transparent pointer-events-none"></div><div class="absolute -top-10 -right-10 w-32 h-32 bg-gradient-to-br from-purple-400/15 to-pink-400/15 dark:from-purple-400/20 dark:to-fuchsia-400/20 rounded-full blur-2xl dark:blur-3xl pointer-events-none"></div><div class="relative z-10">
                <div class="flex items-start gap-3">
                  <%# アイコン %>
                  <div class="flex-shrink-0">
                    <% if notification.notification_type_inactive_reminder? %>
                      <div class="w-10 h-10 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-orange-600 dark:text-orange-400">directions_walk</span>
                      </div>
                    <% elsif notification.notification_type_reaction_summary? %>
                      <div class="w-10 h-10 bg-pink-100 dark:bg-pink-900/30 rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-pink-600 dark:text-pink-400">favorite</span>
                      </div>
                    <% end %>
                  </div>

                  <div class="flex-1">
                    <%# タイトル %>
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-1">
                      <%= notification.title %>
                    </h3>

                    <%# メッセージ %>
                    <p class="text-gray-600 dark:text-gray-300 text-sm mb-2">
                      <%= notification.body %>
                    </p>

                    <%# 日時 %>
                    <span class="text-xs text-gray-500 dark:text-gray-400">
                      <%= notification.created_at.strftime('%Y/%m/%d %H:%M') %>
                    </span>
                  </div>
                </div>
              </div></div>
            <% end %>
          <% end %>
        <% end %>

      <% else %>
        <%# 通知がない場合 %>
        <div class="relative bg-white/70 dark:bg-slate-900/40 dark:backdrop-blur-xl backdrop-blur-md rounded-3xl border-2 border-white/60 dark:border-white/10 dark:border-t-white/40 p-12 text-center shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_30px_rgba(99,102,241,0.15)] overflow-hidden"><div class="absolute inset-0 bg-gradient-to-br from-white/80 via-white/40 to-transparent dark:from-white/10 dark:via-white/5 dark:to-transparent pointer-events-none"></div><div class="relative z-10">
          <p class="text-gray-500 dark:text-gray-400 text-lg">
            <% if @tab == 'announcements' %>
              📭 お知らせはありません
            <% else %>
              📭 リマインダーはありません
            <% end %>
          </p>
        </div></div>
      <% end %>
    </div>

    <%# ページネーション %>
    <% if @notifications.total_pages > 1 %>
      <div class="mt-6">
        <%= paginate @notifications, theme: 'twitter-bootstrap-4' %>
      </div>
    <% end %>
  </div>
</div>
</file>

<file path="app/views/posts/_form.html.erb">
<%# app/views/posts/_form.html.erb %>
<%# アイコン選択式のリッチな投稿フォーム %>
<%= form_with(model: post, local: true, class: "flex flex-col flex-1 min-h-0", id: "new_post_form") do |f| %>

  <div class="flex-1 overflow-y-auto pr-2 space-y-6 scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-gray-600 scrollbar-track-transparent">

  <%# エラーメッセージ表示エリア %>
  <% if post.errors.any? %>
    <div class="bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-300 p-4 rounded-xl text-sm border border-red-100 dark:border-red-800 animate-pulse">
      <div class="font-bold mb-1 flex items-center gap-2">
        <span class="material-symbols-outlined text-lg">error</span>
        入力内容を確認してください
      </div>
      <ul class="list-disc list-inside ml-1">
        <% post.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- 本文入力エリア -->
  <div data-controller="character-counter" data-character-counter-max-value="200">
    <div class="flex justify-between items-center mb-2 px-2">
      <%= f.label :body, "ひとことメモ", class: "block text-sm font-bold text-gray-700 dark:text-purple-200" %>
      <span data-character-counter-target="counter" class="text-xs text-gray-400 dark:text-purple-300/70 font-medium">0 / 200</span>
    </div>
    <div class="relative">
      <%= f.text_area :body, rows: 4,
          class: "w-full rounded-3xl border-2 border-transparent focus:border-blue-300/50 bg-white/50 dark:bg-[#2e1a47] text-gray-700 dark:text-purple-100 placeholder-gray-400 dark:placeholder-purple-400/50 focus:ring-0 focus:bg-white dark:focus:bg-[#1a0b2e] p-5 shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-none dark:border-solid dark:border-purple-400/50 dark:focus:shadow-[0_0_20px_rgba(168,85,247,0.5)] transition-all resize-none backdrop-blur-sm",
          placeholder: "今日の散歩はどうでしたか？",
          "data-character-counter-target": "input",
          "data-action": "input->character-counter#update" %>
      <div class="absolute bottom-4 right-5 text-gray-400 dark:text-purple-400/70 pointer-events-none">
        <span class="material-symbols-outlined">edit_note</span>
      </div>
    </div>
  </div>

  <!-- PC画面では天気と気分を横並びにする -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- 天気選択（アイコンラジオボタン） -->
    <div data-controller="radio-toggle">
      <label class="block text-sm font-bold text-gray-700 dark:text-purple-200 mb-3 px-2">天気</label>
      <div class="grid grid-cols-5 gap-2">
        <% Post.weathers.keys.each do |weather_key| %>
          <% temp_post = Post.new(weather: weather_key) %>
          <label class="cursor-pointer group relative">
            <%= f.radio_button :weather, weather_key, class: "peer sr-only", data: { radio_toggle_target: "input", action: "click->radio-toggle#toggle" } %>
            <div class="flex flex-col items-center justify-center aspect-square rounded-[2rem] bg-[#fdfbf7] dark:bg-[#2e1a47] shadow-[5px_5px_10px_rgba(0,0,0,0.05),-5px_-5px_10px_rgba(255,255,255,0.8)] dark:shadow-sm border-2 border-transparent hover:-translate-y-1 hover:shadow-[8px_8px_15px_rgba(0,0,0,0.08),-8px_-8px_15px_rgba(255,255,255,0.9)] transition-all duration-200 peer-checked:shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] peer-checked:bg-blue-50 dark:peer-checked:bg-cyan-900/40 peer-checked:border-blue-200/50 dark:peer-checked:border-cyan-400/50 peer-checked:translate-y-0 dark:peer-checked:shadow-[0_0_10px_rgba(34,211,238,0.3)]">
              <span class="text-2xl md:text-3xl mb-1 group-hover:scale-110 transition-transform filter drop-shadow-sm dark:drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]"><%= temp_post.weather_emoji %></span>
              <span class="text-[8px] md:text-[10px] font-bold text-gray-400 dark:text-gray-400 peer-checked:text-blue-600 dark:peer-checked:text-cyan-300"><%= temp_post.weather_label %></span>
            </div>
            <!-- 選択時のチェックマーク -->
            <div class="absolute -top-1 -right-1 w-4 h-4 md:w-5 md:h-5 bg-blue-500 dark:bg-cyan-500 rounded-full text-white flex items-center justify-center opacity-0 peer-checked:opacity-100 transition-opacity shadow-sm transform scale-0 peer-checked:scale-100 duration-200 dark:shadow-[0_0_8px_rgba(34,211,238,0.6)]">
              <span class="material-symbols-outlined text-[10px] md:text-xs font-bold">check</span>
            </div>
          </label>
        <% end %>
      </div>
    </div>

    <!-- 気分選択（アイコンラジオボタン） -->
    <div data-controller="radio-toggle">
      <label class="block text-sm font-bold text-gray-700 dark:text-purple-200 mb-3 px-2">気分</label>
      <div class="grid grid-cols-5 gap-2">
        <% Post.feelings.keys.each do |feeling_key| %>
          <% temp_post = Post.new(feeling: feeling_key) %>
          <label class="cursor-pointer group relative">
            <%= f.radio_button :feeling, feeling_key, class: "peer sr-only", data: { radio_toggle_target: "input", action: "click->radio-toggle#toggle" } %>
            <div class="flex flex-col items-center justify-center aspect-square rounded-[2rem] bg-[#fdfbf7] dark:bg-[#2e1a47] shadow-[5px_5px_10px_rgba(0,0,0,0.05),-5px_-5px_10px_rgba(255,255,255,0.8)] dark:shadow-sm border-2 border-transparent hover:-translate-y-1 hover:shadow-[8px_8px_15px_rgba(0,0,0,0.08),-8px_-8px_15px_rgba(255,255,255,0.9)] transition-all duration-200 peer-checked:shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] peer-checked:bg-green-50 dark:peer-checked:bg-fuchsia-900/40 peer-checked:border-green-200/50 dark:peer-checked:border-fuchsia-400/50 peer-checked:translate-y-0 dark:peer-checked:shadow-[0_0_10px_rgba(232,121,249,0.3)]">
              <span class="text-2xl md:text-3xl mb-1 group-hover:scale-110 transition-transform filter drop-shadow-sm dark:drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]"><%= temp_post.feeling_emoji %></span>
              <span class="text-[8px] md:text-[10px] font-bold text-gray-400 dark:text-gray-400 peer-checked:text-green-600 dark:peer-checked:text-fuchsia-300"><%= temp_post.feeling_label %></span>
            </div>
            <!-- 選択時のチェックマーク -->
            <div class="absolute -top-1 -right-1 w-4 h-4 md:w-5 md:h-5 bg-green-500 dark:bg-fuchsia-500 rounded-full text-white flex items-center justify-center opacity-0 peer-checked:opacity-100 transition-opacity shadow-sm transform scale-0 peer-checked:scale-100 duration-200 dark:shadow-[0_0_8px_rgba(232,121,249,0.6)]">
              <span class="material-symbols-outlined text-[10px] md:text-xs font-bold">check</span>
            </div>
          </label>
        <% end %>
      </div>
    </div>
  </div>

  </div>

  <div class="pt-6 mt-auto flex-shrink-0">
    <%= f.button type: :submit, class: "w-full rounded-full border-2 border-white/30 bg-gradient-to-r from-blue-500 to-cyan-400 dark:from-indigo-600 dark:to-violet-600 hover:from-blue-600 hover:to-cyan-500 dark:hover:from-indigo-500 dark:hover:to-violet-500 text-white font-bold text-lg py-4 px-6 shadow-[0_10px_25px_rgba(59,130,246,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:shadow-[0_0_25px_rgba(124,58,237,0.4),inset_0_1px_0_rgba(255,255,255,0.3),inset_0_-2px_5px_rgba(0,0,0,0.3)] hover:shadow-[0_15px_35px_rgba(59,130,246,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] dark:hover:shadow-[0_0_35px_rgba(124,58,237,0.6),inset_0_1px_0_rgba(255,255,255,0.4)] transform hover:-translate-y-1 active:translate-y-0 transition-all duration-200 flex items-center justify-center gap-3 group" do %>
      <span class="material-symbols-outlined text-2xl group-hover:rotate-12 transition-transform">send</span>
      投稿する
    <% end %>
  </div>
<% end %>
</file>

<file path="app/views/shared/_animated_background.html.erb">
<!-- Animated Background (Light Mode Only) -->
<div class="fixed inset-0 bg-gradient-to-br from-sky-200 via-sky-50 to-amber-50 animate-gradient-xy dark:hidden pointer-events-none overflow-hidden -z-50">
  <!-- Cloud 1: 大きめ、上部 -->
  <div class="cloud w-64 h-24 top-12 opacity-80 animate-cloud-1"></div>
  <!-- Cloud 2: さらに大きく、下部 -->
  <div class="cloud w-96 h-32 top-[60%] opacity-60 animate-cloud-2"></div>
  <!-- Cloud 3: 中くらい、中央付近 -->
  <div class="cloud w-48 h-20 top-[30%] opacity-70 animate-cloud-3" style="animation-duration: 80s;"></div>

  <!-- Cloud 4: 小さめ、最下部 -->
  <div class="cloud w-32 h-16 top-[85%] opacity-50 animate-cloud-1" style="animation-duration: 120s; animation-delay: -5s;"></div>
  <!-- Cloud 5: 中くらい、上部（Cloud 1とは別タイミング） -->
  <div class="cloud w-56 h-24 top-[15%] opacity-70 animate-cloud-2" style="animation-duration: 50s; animation-delay: -40s;"></div>
  <!-- Cloud 6: 左下に追加 -->
  <div class="cloud w-40 h-20 top-[90%] opacity-60 animate-cloud-3" style="animation-duration: 90s; animation-delay: -20s;"></div>
</div>
</file>

<file path="config/environments/production.rb">
require "active_support/core_ext/integer/time"

Rails.application.configure do
  # 本番環境の基本設定
  config.enable_reloading = false
  config.eager_load = true
  config.consider_all_requests_local = false
  config.action_controller.perform_caching = true

  # マスターキーの要求（オプション）
  # config.require_master_key = true

  # 静的ファイルの配信設定
  config.public_file_server.enabled = true

  # アセット設定
  config.assets.compile = false
  config.assets.digest = true

  # Tailwind gemのタスクを無効化（Tailwind CLIを使用）
  # config.assets.css_compressor を設定しない

  # ストレージ設定
  config.active_storage.service = :cloudinary


  # SSL設定
  config.force_ssl = true
  config.assume_ssl = true # Renderなどのロードバランサ配下でHTTPSとして認識させる
  # CSRF保護のOriginチェックを有効化（デフォルト）
  # config.action_controller.forgery_protection_origin_check = true

  # ログ設定
  config.logger = ActiveSupport::Logger.new(STDOUT)
    .tap  { |logger| logger.formatter = ::Logger::Formatter.new }
    .then { |logger| ActiveSupport::TaggedLogging.new(logger) }

  # config.log_tags = [ :request_id ]
  config.log_level = ENV.fetch("RAILS_LOG_LEVEL", "info")

  # キャッシュストアをSolid Cacheに変更
  config.cache_store = :solid_cache_store

  # Active Job設定
  # Renderの無料プランでは単一プロセスのため、inlineで同期実行する
  config.active_job.queue_adapter = :inline
  # config.active_job.queue_name_prefix = "myapp_production"

  # メーラー設定
  config.action_mailer.perform_caching = false
  # config.action_mailer.raise_delivery_errors = false

  # 国際化設定
  config.i18n.fallbacks = true

  # 非推奨警告を無効化
  config.active_support.report_deprecations = false

  # データベーススキーマのダンプを無効化
  config.active_record.dump_schema_after_migration = false

  # インスペクション設定
  config.active_record.attributes_for_inspect = [ :id ]

  # ホスト認証設定
  # config.hosts = [
  #   "example.com",
  #   /.*\.example\.com/
  # ]
  # config.host_authorization = { exclude: ->(request) { request.path == "/up" } }
end
</file>

<file path="db/migrate/20251219205704_add_time_of_day_to_walks.rb">
class AddTimeOfDayToWalks < ActiveRecord::Migration[7.2]
  def up
    add_column :walks, :time_of_day, :integer

    # 既存のデータに対して、created_atを元にtime_of_dayを設定する
    # 0: early_morning (04:00 - 08:59)
    # 1: day (09:00 - 15:59)
    # 2: evening (16:00 - 18:59)
    # 3: night (19:00 - 03:59)

    Walk.reset_column_information
    Walk.find_each do |walk|
      hour = walk.created_at.hour
      time_of_day = case hour
      when 4..8 then 0
      when 9..15 then 1
      when 16..18 then 2
      else 3
      end
      walk.update_columns(time_of_day: time_of_day)
    end
  end

  def down
    remove_column :walks, :time_of_day
  end
end
</file>

<file path="db/migrate/20260103014700_add_unique_index_to_notifications.rb">
class AddUniqueIndexToNotifications < ActiveRecord::Migration[7.2]
  def change
    # announcement_idがnullでないレコードに対してのみユニーク制約
    add_index :notifications,
              [ :announcement_id, :user_id ],
              unique: true,
              where: "announcement_id IS NOT NULL",
              name: "index_notifications_on_announcement_user_unique"
  end
end
</file>

<file path="spec/helpers/rankings_helper_spec.rb">
require 'rails_helper'

RSpec.describe RankingsHelper, type: :helper do
  describe "#ordinal_suffix" do
    it "1には'st'を返す" do
      expect(helper.ordinal_suffix(1)).to eq "st"
    end

    it "2には'nd'を返す" do
      expect(helper.ordinal_suffix(2)).to eq "nd"
    end

    it "3には'rd'を返す" do
      expect(helper.ordinal_suffix(3)).to eq "rd"
    end

    it "4には'th'を返す" do
      expect(helper.ordinal_suffix(4)).to eq "th"
    end

    it "11には'th'を返す（例外ケース）" do
      expect(helper.ordinal_suffix(11)).to eq "th"
    end

    it "12には'th'を返す（例外ケース）" do
      expect(helper.ordinal_suffix(12)).to eq "th"
      expect(helper.ordinal_suffix(13)).to eq "th"
      expect(helper.ordinal_suffix(111)).to eq "th"
    end

    it "21には'st'を返す" do
      expect(helper.ordinal_suffix(21)).to eq "st"
    end

    it "22には'nd'を返す" do
      expect(helper.ordinal_suffix(22)).to eq "nd"
    end

    it "23には'rd'を返す" do
      expect(helper.ordinal_suffix(23)).to eq "rd"
    end
  end

  describe "#rank_color_class" do
    it "1位の場合は金色のクラスを返すこと" do
      expect(helper.rank_color_class(1)).to include("from-yellow-300")
    end

    it "2位の場合は銀色のクラスを返すこと" do
      expect(helper.rank_color_class(2)).to include("from-slate-300")
    end

    it "3位の場合は銅色のクラスを返すこと" do
      expect(helper.rank_color_class(3)).to include("from-orange-300")
    end

    it "4位以下の場合はデフォルトのクラスを返すこと" do
      expect(helper.rank_color_class(4)).to include("bg-slate-100")
    end
  end

  describe "#period_label_ja" do
    it "weeklyの場合は'今週'を返すこと" do
      expect(helper.period_label_ja("weekly")).to eq "今週"
    end

    it "monthlyの場合は'今月'を返すこと" do
      expect(helper.period_label_ja("monthly")).to eq "今月"
    end

    it "yearlyの場合は'今年'を返すこと" do
      expect(helper.period_label_ja("yearly")).to eq "今年"
    end

    it "不正な値の場合はデフォルトで'今週'を返すこと" do
      expect(helper.period_label_ja("invalid")).to eq "今週"
    end
  end
end
</file>

<file path="spec/helpers/share_helper_spec.rb">
require 'rails_helper'

RSpec.describe ShareHelper, type: :helper do
  describe "#twitter_share_url" do
    it "Twitterシェア用のURLを生成すること" do
      url = helper.twitter_share_url(text: "Hello", url: "http://example.com", hashtags: [ "test", "rails" ])
      expect(url).to include("https://twitter.com/intent/tweet")
      expect(url).to include("text=Hello")
      expect(url).to include("url=http%3A%2F%2Fexample.com")
      expect(url).to include("hashtags=test%2Crails")
    end
  end

  describe "#share_post_on_twitter_url" do
    let(:user) { create(:user) }
    let(:post) { create(:post, user: user, body: "散歩したよ") }

    before do
      # 今日の散歩データを作成 (5km, 5000歩)
      # Walkモデルのdistanceはkm単位
      create(:walk, user: user, walked_on: Date.current, distance: 5.0, steps: 5000)
    end

    it "投稿シェア用のURLを生成すること" do
      url = helper.share_post_on_twitter_url(post)
      expect(url).to include("https://twitter.com/intent/tweet")
      # URLエンコードされているため、デコードしてチェックするか、部分一致で確認
      decoded_url = URI.decode_www_form_component(url)
      expect(decoded_url).to include("5.0km")
      expect(decoded_url).to include("5000 exp") # 歩数が経験値として表示されること
      expect(decoded_url).to include("散歩したよ")
    end
  end

  describe "#share_ranking_on_twitter_url" do
    let(:user) { create(:user) }

    it "ランキングシェア用のURLを生成すること" do
      # distanceはメートル単位で渡す
      url = helper.share_ranking_on_twitter_url(user: user, rank: 1, distance: 10000)
      expect(url).to include("https://twitter.com/intent/tweet")

      decoded_url = URI.decode_www_form_component(url)
      expect(decoded_url).to include("1位")
      expect(decoded_url).to include("10.0km")
      expect(decoded_url).to include("🏆") # ランキングを示す絵文字
      expect(decoded_url).to include("url=") # ランキングページのURLが含まれる
      expect(decoded_url).to include("user_id=#{user.id}") # ユーザーIDが含まれる
    end
  end
end
</file>

<file path="spec/models/announcement_spec.rb">
require 'rails_helper'

RSpec.describe Announcement, type: :model do
  describe 'コールバック' do
    before do
      Notification.delete_all
      Reaction.delete_all
      Post.delete_all
      Walk.delete_all
      Announcement.delete_all
      User.delete_all
    end

    let!(:user1) { FactoryBot.create(:user) }
    let!(:user2) { FactoryBot.create(:user) }

    context 'お知らせが公開された場合' do
      it '全ユーザーに通知が作成されること' do
        expect {
          FactoryBot.create(:announcement, is_published: true, published_at: Time.current)
        }.to change(Notification, :count).by(2)
      end
    end

    context 'お知らせが非公開で作成された場合' do
      it '通知は作成されないこと' do
        expect {
          FactoryBot.create(:announcement, is_published: false)
        }.not_to change(Notification, :count)
      end
    end

    context '非公開のお知らせが公開に更新された場合' do
      let(:announcement) { FactoryBot.create(:announcement, is_published: false) }

      it '全ユーザーに通知が作成されること' do
        expect {
          announcement.update!(is_published: true, published_at: Time.current)
        }.to change(Notification, :count).by(2)
      end
    end

    context '公開済みのお知らせが更新された場合' do
      let!(:announcement) { FactoryBot.create(:announcement, is_published: true, published_at: Time.current) }

      it '通知は再作成されないこと' do
        # 最初の作成で通知が作られているはず
        expect(Notification.count).to eq(2)

        expect {
          announcement.update!(title: '更新されたタイトル')
        }.not_to change(Notification, :count)
      end
    end
  end
end
</file>

<file path="spec/requests/rankings_spec.rb">
require 'rails_helper'

RSpec.describe "Rankings", type: :request do
  let(:user) { FactoryBot.create(:user) }

  describe "GET /rankings" do
    context "ログインしている場合" do
      before do
        sign_in user
      end

      it "ランキングページにアクセスできること" do
        get rankings_path
        expect(response).to have_http_status(:success)
        expect(response.body).to include("ランキング")
      end

      it "期間パラメータ(monthly)を指定してもアクセスできること" do
        get rankings_path(period: 'monthly')
        expect(response).to have_http_status(:success)
      end

      it "期間パラメータ(yearly)を指定してもアクセスできること" do
        get rankings_path(period: 'yearly')
        expect(response).to have_http_status(:success)
      end

      it "期間パラメータ(weekly)を指定してもアクセスできること" do
        get rankings_path(period: 'weekly')
        expect(response).to have_http_status(:success)
      end
    end

    context "ログインしていない場合" do
      it "ランキングページにアクセスできること" do
        get rankings_path
        expect(response).to have_http_status(:success)
      end
    end
  end
end
</file>

<file path="spec/requests/stats_controller_spec.rb">
require 'rails_helper'

RSpec.describe "Stats", type: :request do
  let(:user) { create(:user) }

  before do
    sign_in user
  end

  describe "GET /stats" do
    it "統計ページが表示されること" do
      get stats_path
      expect(response).to have_http_status(:success)
    end

    context "データが存在する場合" do
      before do
        create(:walk, user: user, walked_on: Date.current, distance: 5.0)
        create(:walk, user: user, walked_on: 1.day.ago, distance: 3.0)
      end

      it "正常に表示されること" do
        get stats_path
        expect(response).to have_http_status(:success)
        expect(response.body).to include("統計")
      end
    end
  end

  describe "GET /stats/chart_data" do
    it "JSON形式で日次データが返されること" do
      get stats_chart_data_path(type: "daily")
      expect(response).to have_http_status(:success)
      expect(response.content_type).to include("application/json")

      json = JSON.parse(response.body)
      expect(json).to be_a(Hash)
      expect(json).to include("dates", "distances")
    end

    it "JSON形式で週次データが返されること" do
      get stats_chart_data_path(type: "weekly")
      expect(response).to have_http_status(:success)
      expect(response.content_type).to include("application/json")
    end

    it "JSON形式で月次データが返されること" do
      get stats_chart_data_path(type: "monthly")
      expect(response).to have_http_status(:success)
      expect(response.content_type).to include("application/json")
    end

    it "JSON形式で時間帯別データが返されること" do
      get stats_chart_data_path(type: "time_of_day")
      expect(response).to have_http_status(:success)
      expect(response.content_type).to include("application/json")

      json = JSON.parse(response.body)
      expect(json).to be_a(Hash)
      expect(json).to include("labels", "data")
    end

    it "無効なタイプの場合は400エラーが返されること" do
      get stats_chart_data_path(type: "invalid")
      expect(response).to have_http_status(:bad_request)
    end
  end
end
</file>

<file path="spec/requests/users_controller_spec.rb">
require 'rails_helper'

RSpec.describe "Users", type: :request do
  let(:user) { create(:user) }
  let(:other_user) { create(:user) }

  before do
    sign_in user
  end

  describe "DELETE /users/disconnect_google" do
    before do
      user.update!(
        google_uid: "12345",
        google_token: "token",
        google_refresh_token: "refresh_token",
        google_expires_at: 1.hour.from_now,
        avatar_type: :google
      )
    end

    it "Google連携情報が削除されること" do
      delete disconnect_google_user_path(user), params: { user: { current_password: user.password } }
      user.reload
      expect(user.google_uid).to be_nil
      expect(user.google_token).to be_nil
      expect(user.google_refresh_token).to be_nil
      expect(user.google_expires_at).to be_nil
      expect(user.default?).to be true
      expect(response).to redirect_to(edit_user_registration_path)
      expect(flash[:notice]).to include("Google連携を解除しました")
    end
  end
end
</file>

<file path="spec/system/guest_logout_spec.rb">
require 'rails_helper'

RSpec.describe 'Guest User Logout', type: :system do
  let!(:guest_user) { User.create!(email: "guest_#{Time.current.to_i}@example.com", password: 'password', role: :guest, name: 'Guest User') }

  before do
    driven_by(:rack_test)
    sign_in guest_user
  end

  it 'allows guest user to logout from settings page' do
    visit edit_user_registration_path

    # ストロングパラメータやViewの変更により、設定画面が正しく表示されていることを確認
    expect(page).to have_content('ゲストモード中です')
    expect(page).to have_content('ログアウトして正式登録する')

    # ログアウトボタンをクリック
    click_button 'ログアウトして正式登録する'

    # ログアウト後の期待される挙動を確認（例: トップページへリダイレクト、フラッシュメッセージなど）
    expect(current_path).to eq(new_user_session_path)
    expect(page).to have_content('ログアウトしました。')
  end
end
</file>

<file path="spec/system/ui_components_spec.rb">
require 'rails_helper'

RSpec.describe "UI Components", type: :system, js: true do
  let(:user) { create(:user, name: "Test User", target_distance: 5000) }

  before do
    login_as(user, scope: :user)
  end

  describe "共通背景アニメーション" do
    it "ホーム画面に背景アニメーション要素が表示されること" do
      visit root_path
      # オーブ要素の確認 (クラス名で検索)
      # _animated_background.html.erb 内の要素
      expect(page).to have_selector('.animate-pulse-slow')
    end

    it "ログイン画面に背景アニメーション要素が表示されること" do
      logout(:user)
      visit new_user_session_path
      expect(page).to have_selector('.animate-pulse-slow')
    end
  end

  describe "物理演算カルーセル (ホーム画面)" do
    before do
      visit root_path
    end

    it "カルーセルコントローラーが適用されていること" do
      expect(page).to have_selector('[data-controller="carousel"]')
    end

    it "スライド要素が表示されていること" do
      # カルーセルの中身があることを確認
      expect(page).to have_selector('[data-carousel-target="slide"]')
    end
  end

  describe "ドラッグスクロール (統計ページ)" do
    before do
      # 統計データを作成 (称号を表示させるため)
      create(:walk, user: user, walked_on: Date.current, distance: 5.0)
      visit stats_path
    end

    it "ドラッグスクロールコントローラーが適用されていること" do
      # アコーディオンを開く必要があるかもしれないが、コントローラー自体はDOMに存在するはず
      # アコーディオンの中にあるため、まずはアコーディオンを開く
      find('button[data-action="click->accordion#toggle"]').click

      # アニメーション待ち
      expect(page).to have_selector('[data-controller="scroll-drag"]', visible: true)
    end

    it "称号リストが表示されていること" do
      find('button[data-action="click->accordion#toggle"]').click
      expect(page).to have_content("冒険の始まり") # 最初の散歩で獲得できる称号
    end
  end

  describe "Crystal Claymorphism デザイン適用確認" do
    it "ホーム画面のカードにデザインクラスが適用されていること" do
      visit root_path
      # rounded-[3.75rem] を持つ要素があるか確認 (Crystal Claymorphismの特徴)
      expect(page).to have_selector('.rounded-\\[3\\.75rem\\]')
    end

    it "統計ページのカードにデザインクラスが適用されていること" do
      visit stats_path
      expect(page).to have_selector('.crystal-card')
    end

    it "設定画面のカードにデザインクラスが適用されていること" do
      visit edit_user_registration_path
      # rounded-[2.5rem] の代わりに backdrop-blur-2xl (すりガラス効果) を確認
      expect(page).to have_css('.backdrop-blur-2xl')
    end
  end
end
</file>

<file path="spec/system/walks_spec.rb">
require 'rails_helper'

RSpec.describe "Walks", type: :system, js: true do
  describe "散歩記録の新規作成" do
    # シンプルにUser.create!を使用（FactoryBotの依存を排除して原因切り分け）
    let(:user) { User.create!(email: "test_walk@example.com", password: "password123", name: "テスト太郎", target_distance: 5000) }

    before do
      login_as(user, scope: :user)
    end

    it "散歩記録が保存され、一覧画面に表示されること" do
      visit new_walk_path
      expect(page).to have_content "新しい散歩記録"

      # 日付フィールドをクリック（カレンダー表示のトリガーを確認する意味合い）
      # find("#walk_walked_on").click
      # 日付を入力
      fill_in "walk_walked_on", with: Date.current.strftime('%Y-%m-%d')

      fill_in "walk_location", with: "テスト公園"
      fill_in "walk_distance", with: "5.5"
      fill_in "walk_duration", with: "60"
      fill_in "walk_steps", with: "8000"
      fill_in "walk_calories_burned", with: "300"
      fill_in "walk_notes", with: "テスト散歩の記録です"

      click_button "保存する"

      expect(page).to have_current_path(walks_path)
      expect(page).to have_content "散歩記録を作成しました"
      expect(page).to have_content "テスト公園"
      # 数値の検証は正規表現で柔軟に
      expect(page).to have_content(/5(\.5)?/)
    end
  end

  describe "散歩記録の編集" do
    let(:user) { User.create!(email: "edit_test@example.com", password: "password123", name: "編集太郎", target_distance: 5000) }
    let!(:walk) { Walk.create!(user: user, walked_on: Date.current, distance: 3.0, duration: 30, steps: 3000, calories_burned: 150, location: "編集前の場所") }

    before do
      login_as(user, scope: :user)
    end

    it "記録を編集できること" do
      visit edit_walk_path(walk)


      expect(page).to have_field("場所", with: "編集前の場所")

      fill_in "場所", with: "編集後の場所"
      fill_in "距離", with: "10.0"
      fill_in "時間", with: "45"

      click_button "保存する"



      expect(page).to have_current_path(walk_path(walk))
      expect(page).to have_content "編集後の場所"
      expect(page).to have_content(/10(\.0)?/)
    end
  end

  describe "散歩記録の削除" do
    let(:user) { User.create!(email: "delete_test@example.com", password: "password123", name: "削除太郎", target_distance: 5000) }
    let!(:walk) { Walk.create!(user: user, walked_on: Date.current, distance: 3.0, duration: 30, steps: 3000, calories_burned: 150, location: "削除する場所") }

    before do
      login_as(user, scope: :user)
    end

    it "記録を削除できること" do
      visit walk_path(walk)

      # 削除リンクをクリック（確認ダイアログあり）
      accept_confirm do
        click_link "削除"
      end



      expect(page).to have_current_path(walks_path)
      # 削除完了メッセージを待つ（文言が不明なため、Flashメッセージのコンテナが表示されることを待つ）
      # expect(page).to have_content "削除しました"
      expect(page).to have_no_content "削除する場所"
    end
  end

  describe "ページネーション" do
    let(:user) { User.create!(email: "pagination_test@example.com", password: "password123", name: "ページネーション太郎", target_distance: 5000) }

    before do
      # 50件のデータを作成
      50.times do |i|
        Walk.create!(
          user: user,
          walked_on: Date.current - i.days,
          distance: 1.0,
          duration: 30,
          steps: 1000,
          calories_burned: 50,
          location: "場所#{i}"
        )
      end

      login_as(user, scope: :user)
    end

    it "ページネーションが表示され、次ページに遷移できること" do
      visit walks_path

      # ページネーションのリンクがあるか確認
      expect(page).to have_link "2"

      # 上下2箇所にあるため、最初の一つをクリック
      click_link "2", match: :first

      # URLが変わるのを待つ（Capybaraの待機機能を利用）
      expect(page).to have_current_path(/page=2/)
      # 2ページ目は 10日前〜19日前のデータが表示されるはず（1ページ10件の場合）
      expect(page).to have_content "場所15"
    end
  end
end
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files for more about ignoring files.
#
# Temporary files generated by your text editor or operating system
# belong in git's global ignore instead:
# `$XDG_CONFIG_HOME/git/ignore` or `~/.config/git/ignore`

# Ignore bundler config.
/.bundle

# Ignore all environment files (except templates).
/.env*
!/.env*.erb
!/.env.example

# Ignore all logfiles and tempfiles.
/log/*
/tmp/*
!/log/.keep
!/tmp/.keep

# Ignore pidfiles, but keep the directory.
/tmp/pids/*
!/tmp/pids/
!/tmp/pids/.keep

# Ignore storage (uploaded files in development and any SQLite databases).
/storage/*
!/storage/.keep
/tmp/storage/*
!/tmp/storage/
!/tmp/storage/.keep

/public/assets

# Ignore master key for decrypting credentials and more.
/config/master.key

# Ignore npm lock file (using Yarn instead)
package-lock.json

/app/assets/builds/*
!/app/assets/builds/.keep

/node_modules
.vscode/
*.tar.gz
.DS_Store
node_modules/
vendor/bundle
*.sqlite3
/backups/

# テスト結果の一時ファイル
rspec_*.txt
</file>

<file path="Dockerfile.dev">
FROM ruby:3.2.2
ENV APP /rails
ENV LANG C.UTF-8
ENV TZ Asia/Tokyo

RUN curl -fsSL https://deb.nodesource.com/setup_lts.x | bash - \
 && apt update -qq \
 && apt install -y build-essential postgresql-client nodejs wget gnupg sudo \
 && wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - \
 && sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list' \
 && apt update -qq \
 && apt install -y google-chrome-stable \
 && npm install --global yarn

# ユーザー作成 (UID=1000)
RUN groupadd -g 1000 rails && \
    useradd -u 1000 -g rails -m rails && \
    echo "rails ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

WORKDIR $APP
RUN chown rails:rails $APP

USER rails

COPY --chown=rails:rails Gemfile Gemfile.lock ./
RUN bundle install

COPY --chown=rails:rails package.json yarn.lock ./
RUN yarn install
VOLUME ["/rails/node_modules"]

COPY --chown=rails:rails . .

CMD ["rails", "server", "-b", "0.0.0.0"]
</file>

<file path="PR_DESCRIPTION.md">
## 📝 概要

通知ページとユーザー設定ページに **Holographic Neon Noir / God Mode Glass** ダークモードデザインを適用し、投稿詳細ページのボタンに立体感を追加しました。ライトモードの **Crystal Claymorphism** デザインは完全に保護されています。

## ✨ 主な変更内容

### 🌙 ダークモードデザイン適用

#### 1. `/notifications` - 通知ページ

- ✅ タブナビゲーションに God Mode Glass 適用
- ✅ お知らせカード・リマインダーカードに半透明ガラス質感
- ✅ Double Rim Light（上部エッジ強調）実装
- ✅ ネオン発光シャドウ追加
- ✅ Breathing Glow（呼吸する光のオーブ）配置
- ✅ 「全て既読にする」ボタンに発光エフェクト
- ⚠️ グラスカバーのパルスアニメーションは削除（大きなカードには不適切と判断）

#### 2. `/users/edit` - ユーザー設定ページ

- ✅ メインカードに God Mode Glass 適用
- ✅ 右上と左下にシアン/ブルーのオーブ配置
- ✅ 通知設定カード（散歩時間・非アクティブ・リアクションまとめ）にダークモード適用
- ✅ Danger Zone（アカウント削除）にダークモード適用
- ✅ メールアドレスバッジのスタイル改善
- ✅ すべてのボタンにネオン発光追加

#### 3. `/posts/:id` - 投稿詳細ページ

- ✅ 「タイムラインを見る」「ホームに戻る」ボタンにぷっくり立体感追加
- ✅ インセットシャドウでキャンディのような質感実現
- ✅ `active:scale-95` で押下時のへこみエフェクト追加

### 🎨 Crystal Claymorphism デザイン適用

#### `/login_stamps` - 出席簿ページ

- ✅ カードとボタンにぷっくり立体感追加
- ✅ インセットシャドウとキャンディテクスチャ実装
- ✅ Warm White 背景（`bg-[#fdfbf7]`）適用

#### 投稿カードのデザイン改善

- ✅ リアクションボタンの立体感強化
- ✅ フォーム入力フィールドのデザイン統一

### 🧪 テスト修正

- ✅ `spec/support/omniauth.rb` 追加（OmniAuth テストモード設定）
- ✅ `StatsService` 仕様の日付ロジック修正
- ✅ システムテストのセレクタ更新
- ✅ UI コンポーネントテスト追加

### 📚 ドキュメント更新

- ✅ `.docs/DESIGN_SYSTEM_LIGHT.md` に Crystal Claymorphism ガイドライン追加
- ✅ コンポーネント実装例を詳細化

## 🎯 技術的なポイント

### God Mode Glass の実装

**半透明ガラス質感**

- `dark:bg-slate-900/40` + `dark:backdrop-blur-xl`
- 向こう側が透ける磨りガラス

**Double Rim Light**

- `dark:border-t-white/40` で上部エッジを強調
- `dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),...]` でガラスの厚み表現

**Breathing Glow（呼吸する光）**

- シアン/ブルーのオーブ: `dark:from-cyan-500/20 dark:to-blue-500/20`
- `blur-3xl` で柔らかい拡散

**ネオン発光**

- ボタン: `dark:shadow-[0_0_20px_rgba(34,211,238,0.4),...]`
- ホバー時: 発光を強化（`0_0_40px`）

### ぷっくり立体感の実装

**インセットシャドウの組み合わせ**

- 暗い影（右下）: `inset_-2px_-2px_5px_rgba(0,0,0,0.15)`
- 明るいハイライト（左上）: `inset_2px_2px_5px_rgba(255,255,255,0.3)`
- この 2 つで盛り上がった質感を実現

**アクティブエフェクト**

- `active:scale-95` で押下時にへこむ
- `hover:-translate-y-1` でホバー時に浮き上がる

## ⚠️ 制約の遵守

### 1. ライトモード完全保護

- ✅ プレフィックスなしクラスは一切変更なし
- ✅ `dark:` クラスのみを追加

### 2. 機能保全

- ✅ JavaScript/ERB ロジックは変更なし
- ✅ `id` / `data-` 属性は維持
- ✅ イベントハンドラは完全保護

### 3. DOM 構造維持

- ✅ 既存の HTML 構造は極力維持
- ✅ 装飾要素（オーブ、グラデーション）のみ追加

## 🧪 テスト実行結果

すべてのテストが通過していることを確認済み。

## 📸 スクリーンショット

<!-- ここにスクリーンショットをドロップしてください -->

### ライトモード

- `/notifications` ページ
- `/users/edit` ページ
- `/posts/:id` ページ

### ダークモード

- `/notifications` ページ (God Mode Glass)
- `/users/edit` ページ (God Mode Glass)
- `/posts/:id` ページ (ぷっくりボタン)
</file>

<file path=".docs/DESIGN_SYSTEM_DARK.md">
# Role

あなたは世界最高峰のフロントエンドエンジニア兼 UI デザイナーです。
**既存のライトモード（デフォルト）のデザインと機能**を完全に維持したまま、指定された「ダークモード用デザイン」を適用してください。

# ⚠️ Critical Constraints (絶対厳守の制約事項)

作業を行うにあたり、以下のルールを絶対に守ってください。

1. **【最重要】ライトモード（デフォルトスタイル）の完全保護:**

   - **プレフィックスが付いていない標準クラス（例: `bg-white`, `text-gray-900`, `shadow-lg`）は、原則として変更・削除しないでください。**
   - これらはライトモードの表示を決定しているため、変更するとライトモードが崩れます。

2. **作業範囲の限定:**

   - 今回行う変更は、**`dark:` プレフィックスが付いたクラスの追加・編集のみ**に限定してください。
   - 例: 背景色を変える場合は、既存の `bg-white` を書き換えるのではなく、`bg-white dark:bg-slate-900` のように **`dark:` クラスを追加** してください。

3. **ロジックと構造の保全:**
   - JavaScript / PHP / Ruby などのロジックコードは一切変更しないでください。
   - `id` 属性、`data-` 属性は絶対に変更・削除しないでください。
   - レイアウト構造（HTML のネスト）は、ダークモード対応のために必須である場合（例: 背景レイヤーの追加）を除き、極力維持してください。

---

# Design System: Holographic Neon Noir / God Mode Glass

## 🌌 Core Concept: "Living Interface"

ただのダークモードではない。**「生きているかのように呼吸し、発光するインターフェース」**を目指す。
LP（ランディングページ）のクオリティを絶対基準とし、全てのページでその没入感を再現する。

---

## 🎨 Foundations (基本設定)

### 1. Deep Void (深淵なる背景)

画面全体の背景は、単なる黒ではなく、**「宇宙のような深みのあるネイビーブラック」**を使用する。

- **Base:** `dark:bg-[#020617]` (Slate-950 よりさらに深い黒)
- **Gradient:** `dark:bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] dark:from-slate-900 dark:via-[#020617] dark:to-[#020617]`

### 2. Neon Accent (発光する魂)

各機能のテーマカラーは、単なる色ではなく**「光源」**として扱う。

- **Blue (Weather/Distance):** `cyan-400` to `blue-500`
- **Green (Health/Days):** `emerald-400` to `teal-500`
- **Purple (Stats/Memo):** `fuchsia-400` to `violet-600`
- **Gold (Rank/Achievement):** `amber-300` to `orange-500`
- **Pink (Record/Action):** `pink-400` to `rose-600`

### 3. Jewel Icons (宝石のようなアイコン)

アイコンは単色ではなく、グラデーションと強いドロップシャドウで「自ら発光する宝石」のように見せる。
**重要:** CSS の優先順位で色が上書きされないよう、`!text-transparent` と `!bg-clip-text` を使用すること。絵文字（🍎, 🏃）は禁止。

```html
<span
  class="material-symbols-outlined text-3xl
             text-blue-500 /* Light Mode */
             dark:!text-transparent dark:!bg-clip-text
             dark:bg-gradient-to-br dark:from-cyan-300 dark:to-blue-300
             dark:drop-shadow-[0_0_8px_rgba(34,211,238,0.8)]"
>
  distance
</span>
```

### 4. Text Gradients (テキストグラデーション)

**注意:** グラデーションは親要素の座標系で計算されるため、`inline-block` を使用しないとページ全体にかかってしまう。

```html
<!-- ✅ 正しい：テキスト内でグラデーション -->
<p
  class="inline-block text-4xl bg-clip-text text-transparent bg-gradient-to-r
           dark:from-cyan-300 dark:via-blue-300 dark:to-cyan-500"
>
  35.26
</p>
```

---

## ✨ Core Visual Effects (実装ルール)

### 1. God Mode Glass (神のガラス)

カードの背景は「塗りつぶし」ではなく、**「向こう側が透ける磨りガラス」**でなければならない。

- **Surface:** `dark:bg-slate-900/40` (透明度 40%が黄金比)
- **Blur:** `dark:backdrop-blur-xl` (強力なぼかしで奥行きを作る)
- **Border:** `dark:border-white/10` (極めて薄いエッジ)

### 2. Glass Cover (Wet Texture / 濡れた質感)

カードの上部 45% に「濡れたような光沢」を追加し、ゆっくりと明滅させる。

**推奨設定:**

- **Height:** `before:h-[45%]`
- **Opacity:** `before:from-white/20` (20%が最適。15%は薄すぎ、25%は強すぎる)
- **Animation:** `before:animate-pulse`

```html
<div class="relative overflow-hidden ...">
  <!-- Glass Cover Layer -->
  <div
    class="absolute inset-0 bg-gradient-to-br from-white/10 via-white/5 to-transparent pointer-events-none"
  ></div>

  <!-- Upper Gloss (Pseudo-element) -->
  <div
    class="before:absolute before:inset-x-0 before:top-0 before:h-[45%]
              before:bg-gradient-to-b before:from-white/20 before:to-transparent
              before:rounded-t-[2.5rem] before:pointer-events-none before:animate-pulse"
  ></div>
</div>
```

### 3. Double Rim Light (二重リムライト)

カードの境界線は、内側から発光しているように見せる。ホバー時にはテーマカラーで強く発光させる。

```html
class="border dark:border-white/10 dark:border-t-white/40
dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_30px_rgba(THEME_COLOR,0.15)]
hover:dark:border-cyan-500/50
hover:dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.5),0_0_60px_rgba(6,182,212,0.4)]"
```

### 4. Breathing Glow (呼吸する光)

**最重要。** 重要なカード（Hero Card など）の背景には、**「呼吸する光のオーブ」**を配置する。

```html
<div
  class="absolute -bottom-10 -right-10 w-64 h-64 bg-cyan-500/20 rounded-full blur-3xl animate-pulse-slow pointer-events-none"
></div>
```

### 5. Futuristic Capsule (カプセル形状)

カードの角丸は、**カードのサイズに応じて適切な値を選ぶ**。

| カードの種類                               | 推奨 border-radius | Tailwind クラス      |
| :----------------------------------------- | :----------------- | :------------------- |
| **小さいカード**（統計カードなど）         | `60px`             | `!rounded-[3.75rem]` |
| **大きいカード**（Hero/レベルバーなど）    | `80px`             | `!rounded-[5rem]`    |
| **ランディングページ**（大きな機能カード） | `40px`             | `rounded-[2.5rem]`   |

**注意点:**

- 擬似要素 (`before:`) の角丸も親要素と一致させること。
- 大きな角丸の場合、端に近い要素がはみ出さないよう、適度なマージン (`ml-2` 等) を設定すること。

---

## 🧩 Component Guidelines

### Cards (General Structure)

全てのカードコンポーネントは以下の構造を持つこと。

1.  **Outer Glow:** 背面で呼吸する光（重要なカードのみ）。
2.  **Glass Body:** 半透明の背景とぼかし。
3.  **Neon Icon:** Material Symbols は `text-shadow` または `drop-shadow` で発光させる。

**階層による明るさ調整:**

- **主要カード:** `dark:from-cyan-600 dark:via-indigo-700 dark:to-purple-800` (明るめ)
- **副次カード:** `dark:from-slate-900 dark:to-blue-950` (暗め)

### Post Card (投稿カード)

タイムラインの中心要素。

- **Shape:** `rounded-[3.75rem]` (60px)
- **Reaction Area:** `rounded-b-[3.75rem]` を適用し、カード本体と一体化させる。
- **Glass Cover:** 全体に適用。

### Modal (モーダル)

浮遊感を強調する。

- **Shape:** `rounded-[3.75rem]`
- **Border:** `border-4` で太めの枠線。
- **Shadow:** 強力なドロップシャドウ + インナーシャドウ。

### Progress Bar (シマーエフェクト)

プログレスバーに「光が走る」アニメーションを追加する場合のルール。

**実装ルール:**

1. シマーエフェクト用の `div` は、必ず**色付きバー（進捗バー）の内部**に配置する。
2. `absolute inset-0` でバー全体を覆う。
3. 背景色は単色ではなく、**透明〜白(30%)〜透明のグラデーション**を使用する。
4. `animate-shimmer` と `-skew-x-12` を適用する。

**正しいコード例:**

```erb
<!-- 背景バー -->
<div class="h-3 rounded-full bg-gray-200 dark:bg-slate-800 overflow-hidden">
  <!-- 色付きバー (進捗) -->
  <div class="h-full bg-gradient-to-r from-blue-400 to-purple-500 relative overflow-hidden" style="width: 50%">
    <!-- シマーエフェクト (色付きバーの内部に配置) -->
    <div class="absolute inset-0 animate-shimmer bg-gradient-to-r from-transparent via-white/30 to-transparent -skew-x-12"></div>
  </div>
</div>
```

**禁止事項:**

- ❌ シマーエフェクトを色付きバーの**外（背面や前面）**に配置しないこと。
- ❌ `bg-white/40` のような単色半透明を使用しないこと。

### Buttons & Interactions

- **Hover:** `hover:scale-[1.01]` は地味すぎる。`hover:scale-105` (5%拡大) を使用する。
- **Glow:** ホバー時はシャドウを拡大 (`0_30px` → `0_60px`) させる。

### Scrollbars

- **Track:** 透明または極薄い黒 (`bg-white/5`)
- **Thumb:** 半透明の白またはテーマカラー (`bg-white/20 hover:bg-white/40`)
- **Width:** 極細 (`w-1.5`)

---

## 🚫 Anti-Patterns (やってはいけないこと)

- **Solid Backgrounds:** 不透明な背景色（`bg-gray-800`など）は使用禁止。必ず透けさせる。
- **Flat Borders:** 単色のボーダー（`border-gray-700`）は禁止。光らせるか、透けさせる。
- **Raw White Text:** 純粋な白文字（`text-white`）は避け、少し青みやグレーを含ませるか、グラデーションにする。
- **Default Shadows:** デフォルトの影（`shadow-xl`）だけでは足りない。色付きの影（`shadow-cyan-500/20`）を重ねる。
</file>

<file path="app/assets/stylesheets/application.tailwind.css">
@layer utilities {
  @keyframes spin-slow {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .animate-spin-slow {
    animation: spin-slow 3s linear infinite;
  }

  @keyframes shimmer {
    0% {
      transform: translateX(-100%);
    }
    100% {
      transform: translateX(100%);
    }
  }

  @keyframes bounce-slow {
    0%,
    100% {
      transform: translateY(-5%);
      animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
    }
    50% {
      transform: translateY(0);
      animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
    }
  }

  .animate-bounce-slow {
    animation: bounce-slow 3s infinite;
  }

  @keyframes sheen {
    0% {
      transform: translate(-100%, -100%) rotate(0deg);
    }
    100% {
      transform: translate(100%, 100%) rotate(0deg);
    }
  }

  .animate-sheen {
    animation: sheen 1.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
  }
}
</file>

<file path="app/controllers/posts/ogp_images_controller.rb">
class Posts::OgpImagesController < ApplicationController
  skip_before_action :authenticate_user!, only: [ :show ]

  def show
    @post = Post.find(params[:post_id])
    Rails.logger.info "Generating OGP image for Post ID: #{@post.id}"

    # 強制リフレッシュ: ?refresh=true があれば既存の画像を削除
    if params[:refresh] == "true"
      expires_now
      if @post.ogp_image.attached?
        Rails.logger.info "Force refreshing OGP image for Post ID: #{@post.id}"
        @post.ogp_image.purge
        @post.reload
      end
    else
      # OGP画像は投稿作成後不変なので、1ヶ月キャッシュしてサーバー負荷を削減
      expires_in 1.month, public: true
    end

    begin
      # 既存の画像があればそれを返す（Active Storage経由でCloudinaryから配信）
      if @post.ogp_image.attached?
        redirect_to rails_blob_url(@post.ogp_image, disposition: "inline"), allow_other_host: true
        return
      end

      # 画像が未保存の場合、生成してActive Storageに保存
      user = @post.user
      walk = @post.walk || user.walks.find_by(walked_on: @post.created_at.to_date)

      # レベル計算
      level = StatsService.new(user).level

      # 統計情報
      stats = {
        level: level,
        date: walk&.walked_on&.strftime("%Y-%m-%d") || @post.created_at.strftime("%Y-%m-%d"),
        label1: "DISTANCE",
        value1: "#{walk&.distance || 0} km",
        label2: "EXP (STEPS)",
        value2: "#{walk&.steps || 0}",
        label3: "LOCATION",
        value3: walk&.location.presence || "TekuMemo"
      }

      image_data = RpgCardGeneratorService.new(
        user: user,
        title: "QUEST COMPLETE",
        message: @post.body,
        stats: stats,
        theme: :quest
      ).generate

      # Active Storageに保存（Cloudinaryへアップロード）
      @post.ogp_image.attach(
        io: StringIO.new(image_data),
        filename: "post_#{@post.id}_ogp.jpg",
        content_type: "image/jpeg"
      )

      # 保存した画像のURLにリダイレクト
      redirect_to rails_blob_url(@post.ogp_image, disposition: "inline"), allow_other_host: true
    rescue => e
      Rails.logger.error "Failed to generate OGP image for Post ID #{@post.id}: #{e.message}\n#{e.backtrace.join("\n")}"

      # デフォルトのOGP画像にフォールバック（空白画像を避ける）
      # アプリアイコンを代替として使用
      redirect_to ActionController::Base.helpers.image_url("icon.png"), allow_other_host: true
    end
  end
end
</file>

<file path="app/controllers/users_controller.rb">
class UsersController < ApplicationController
  # Google連携解除
  def disconnect_google
    # パスワード検証
    unless current_user.valid_password?(params[:user][:current_password])
      redirect_to edit_user_registration_path, alert: "パスワードが正しくありません"
      return
    end

    # Google関連の情報をクリア
    if current_user.update(
      google_uid: nil,
      google_token: nil,
      google_refresh_token: nil,
      google_expires_at: nil,
      avatar_type: :default # アバター種別をデフォルトに戻す
    )
      redirect_to edit_user_registration_path, notice: "Google連携を解除しました"
    else
      redirect_to edit_user_registration_path, alert: "連携解除に失敗しました。"
    end
  end
end
</file>

<file path="app/jobs/generate_post_ogp_image_job.rb">
class GeneratePostOgpImageJob < ApplicationJob
  queue_as :default

  # リトライ設定: 指数バックオフで最大3回リトライ
  retry_on StandardError, wait: :polynomially_longer, attempts: 3

  # 最終的に失敗した場合の処理
  discard_on ActiveJob::DeserializationError

  def perform(post)
    return if post.ogp_image.attached?

    Rails.logger.info "Starting background OGP generation for Post ID: #{post.id}"

    user = post.user
    walk = post.walk || user.walks.find_by(walked_on: post.created_at.to_date)

    # レベル計算
    level = StatsService.new(user).level

    # 統計情報
    stats = {
      level: level,
      date: walk&.walked_on&.strftime("%Y-%m-%d") || post.created_at.strftime("%Y-%m-%d"),
      label1: "DISTANCE",
      value1: "#{walk&.distance || 0} km",
      label2: "EXP (STEPS)",
      value2: "#{walk&.steps || 0}",
      label3: "LOCATION",
      value3: walk&.location.presence || "TekuMemo"
    }

    image_data = RpgCardGeneratorService.new(
      user: user,
      title: "QUEST COMPLETE",
      message: post.body,
      stats: stats,
      theme: :quest
    ).generate

    # Active Storageに保存
    post.ogp_image.attach(
      io: StringIO.new(image_data),
      filename: "post_#{post.id}_ogp.jpg",
      content_type: "image/jpeg"
    )

    Rails.logger.info "Background OGP generation completed for Post ID: #{post.id}"
  end
end
</file>

<file path="app/views/admin/dashboard/index.html.erb">
<div class="space-y-6">
  <!-- ページタイトル -->
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center">
      <span class="material-symbols-outlined mr-2 text-3xl">dashboard</span>
      管理者ダッシュボード
    </h1>
    <div class="text-sm text-gray-500 dark:text-gray-400">
      <%= l Time.current, format: :long %>
    </div>
  </div>

  <!-- 統計カード群 -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <!-- 総ユーザー数 -->
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500 dark:text-gray-400">総ユーザー数</p>
          <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2"><%= @total_users %></p>
          <p class="text-xs text-green-600 dark:text-green-400 mt-1">
            今月 +<%= @users_this_month %>
          </p>
        </div>
        <div class="bg-blue-100 dark:bg-blue-900/30 rounded-full p-3">
          <span class="material-symbols-outlined text-3xl text-blue-600 dark:text-blue-400">group</span>
        </div>
      </div>
    </div>

    <!-- 総投稿数 -->
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500 dark:text-gray-400">総投稿数</p>
          <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2"><%= @total_posts %></p>
          <p class="text-xs text-green-600 dark:text-green-400 mt-1">
            今日 +<%= @posts_today %>
          </p>
        </div>
        <div class="bg-purple-100 dark:bg-purple-900/30 rounded-full p-3">
          <span class="material-symbols-outlined text-3xl text-purple-600 dark:text-purple-400">edit_square</span>
        </div>
      </div>
    </div>

    <!-- 総散歩距離 -->
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500 dark:text-gray-400">総散歩距離</p>
          <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2">
            <%= number_with_delimiter(@total_distance.round(1)) %>
            <span class="text-lg">km</span>
          </p>
          <p class="text-xs text-green-600 dark:text-green-400 mt-1">
            今月 <%= number_with_delimiter(@distance_this_month.round(1)) %>km
          </p>
        </div>
        <div class="bg-green-100 dark:bg-green-900/30 rounded-full p-3">
          <span class="material-symbols-outlined text-3xl text-green-600 dark:text-green-400">footprint</span>
        </div>
      </div>
    </div>

    <!-- アクティブユーザー -->
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
      <div class="flex items-center justify-between mb-3">
        <div>
          <p class="text-sm text-gray-500 dark:text-gray-400">アクティブユーザー</p>
          <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2"><%= @active_users_this_month %></p>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
            今日: <%= @active_users_today %> / 今週: <%= @active_users_this_week %>
          </p>
        </div>
        <div class="bg-orange-100 dark:bg-orange-900/30 rounded-full p-3">
          <span class="material-symbols-outlined text-3xl text-orange-600 dark:text-orange-400">monitoring</span>
        </div>
      </div>

      <!-- 今日のアクティブユーザー名表示 -->
      <% if @active_users_today_list.any? %>
        <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-700">
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">今日のアクティブユーザー:</p>
          <div class="flex flex-wrap gap-1">
            <% @active_users_today_list.take(3).each do |user_name| %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300">
                <%= user_name %>
              </span>
            <% end %>
            <% if @active_users_today > 3 %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">
                他<%= @active_users_today - 3 %>名
              </span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 異常検知セクション -->
  <div class="bg-white dark:bg-slate-800 rounded-lg shadow overflow-hidden" data-controller="anomaly">
    <!-- トグルヘッダー -->
    <button
      type="button"
      data-action="click->anomaly#toggle"
      class="w-full px-6 py-4 flex items-center justify-between <%= @total_anomalies > 0 ? 'bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30' : 'bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-900/30' %> transition-colors"
    >
      <div class="flex items-center space-x-3">
        <% if @total_anomalies > 0 %>
          <!-- 異常あり：赤いパルスアニメーション -->
          <div class="relative">
            <span class="material-symbols-outlined text-2xl text-red-600 dark:text-red-400 relative z-10">warning</span>
            <span class="absolute inset-0 animate-ping">
              <span class="material-symbols-outlined text-2xl text-red-600 dark:text-red-400 opacity-75">warning</span>
            </span>
          </div>
          <div>
            <h2 class="text-lg font-bold text-red-800 dark:text-red-300">
              ⚠️ システム異常検出
            </h2>
            <p class="text-sm text-red-600 dark:text-red-400">
              <%= @total_anomalies %> 件の異常が検出されました
            </p>
          </div>
        <% else %>
          <!-- 正常：緑色のグロー -->
          <div class="relative">
            <span class="material-symbols-outlined text-2xl text-green-600 dark:text-green-400 drop-shadow-[0_0_8px_rgba(34,197,94,0.5)]">check_circle</span>
          </div>
          <div>
            <h2 class="text-lg font-bold text-green-800 dark:text-green-300">
              ✓ システム正常
            </h2>
            <p class="text-sm text-green-600 dark:text-green-400">
              異常は検出されていません
            </p>
          </div>
        <% end %>
      </div>

      <!-- 開閉アイコン -->
      <span class="material-symbols-outlined text-gray-400">expand_more</span>
    </button>

    <!-- 異常詳細（開閉式） -->
    <div data-anomaly-target="content" class="hidden">
      <% if @total_anomalies > 0 %>
        <div class="px-6 py-4 space-y-6">
          <!-- 1. スパム疑いユーザー -->
          <% if @anomalies[:spam_users].any? %>
            <div>
              <h3 class="text-md font-bold text-red-700 dark:text-red-300 flex items-center mb-3">
                <span class="material-symbols-outlined mr-2">report</span>
                🚨 スパム疑いユーザー（<%= @anomalies[:spam_users].count %>件）
              </h3>
              <div class="space-y-2">
                <% @anomalies[:spam_users].each do |user| %>
                  <div class="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/10 rounded-lg border border-red-200 dark:border-red-800">
                    <div class="flex items-center space-x-3">
                      <%= user_avatar(user, classes: "h-10 w-10 rounded-full") %>
                      <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white"><%= user.name %></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                          短期間に <%= user.try(:post_count) || '大量' %> 件投稿
                        </p>
                      </div>
                    </div>
                    <%= link_to "詳細", admin_users_path(q: user.email), class: "text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400" %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- 2. データ整合性エラー -->
          <% if @anomalies[:invalid_walks].any? %>
            <div>
              <h3 class="text-md font-bold text-orange-700 dark:text-orange-300 flex items-center mb-3">
                <span class="material-symbols-outlined mr-2">error</span>
                📊 データ整合性エラー（<%= @anomalies[:invalid_walks].count %>件）
              </h3>
              <div class="space-y-2">
                <% @anomalies[:invalid_walks].each do |walk| %>
                  <div class="flex items-center justify-between p-3 bg-orange-50 dark:bg-orange-900/10 rounded-lg border border-orange-200 dark:border-orange-800">
                    <div class="flex items-center space-x-3">
                      <%= user_avatar(walk.user, classes: "h-10 w-10 rounded-full") %>
                      <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white"><%= walk.user.name %></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                          距離: <%= number_with_delimiter(walk.distance) %>m / 歩数: <%= number_with_delimiter(walk.steps || 0) %>歩
                        </p>
                      </div>
                    </div>
                    <%= link_to "詳細", admin_walk_path(walk), class: "text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400" %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- 3. セキュリティ懸念 -->
          <% if @anomalies[:security_concern].any? %>
            <div>
              <h3 class="text-md font-bold text-yellow-700 dark:text-yellow-300 flex items-center mb-3">
                <span class="material-symbols-outlined mr-2">security</span>
                🔒 セキュリティ懸念（<%= @anomalies[:security_concern].count %>件）
              </h3>
              <div class="space-y-2">
                <% @anomalies[:security_concern].each do |user| %>
                  <div class="flex items-center justify-between p-3 bg-yellow-50 dark:bg-yellow-900/10 rounded-lg border border-yellow-200 dark:border-yellow-800">
                    <div class="flex items-center space-x-3">
                      <%= user_avatar(user, classes: "h-10 w-10 rounded-full") %>
                      <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white"><%= user.name %></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                          最終ログイン: <%= time_ago_in_words_game_style(user.current_sign_in_at) %> / 最近投稿あり
                        </p>
                      </div>
                    </div>
                    <%= link_to "詳細", admin_users_path(q: user.email), class: "text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400" %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- 4. 非アクティブアカウント -->
          <% if @anomalies[:inactive_accounts].any? %>
            <div>
              <h3 class="text-md font-bold text-gray-700 dark:text-gray-300 flex items-center mb-3">
                <span class="material-symbols-outlined mr-2">person_off</span>
                🗑️ 非アクティブアカウント（<%= @anomalies[:inactive_accounts].count %>件）
              </h3>
              <div class="space-y-2">
                <% @anomalies[:inactive_accounts].each do |user| %>
                  <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                    <div class="flex items-center space-x-3">
                      <%= user_avatar(user, classes: "h-10 w-10 rounded-full") %>
                      <div>
                        <p class="text-sm font-medium text-gray-900 dark:text-white"><%= user.name %></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                          登録: <%= time_ago_in_words_game_style(user.created_at) %> / 活動なし
                        </p>
                      </div>
                    </div>
                    <%= link_to "詳細", admin_users_path(q: user.email), class: "text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400" %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="px-6 py-8 text-center">
          <p class="text-green-600 dark:text-green-400">
            すべてのシステムが正常に動作しています
          </p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- 2カラムグリッド -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- 人気投稿 -->
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center">
          <span class="material-symbols-outlined mr-2">trending_up</span>
          人気の投稿 TOP5
        </h2>
      </div>
      <div class="p-6 relative">
        <% if current_user.guest? %>
          <div class="absolute inset-0 z-10 flex items-center justify-center bg-white/10 dark:bg-slate-900/10 rounded-b-lg">
            <div class="px-4 py-2 bg-slate-800/90 text-white text-sm font-bold rounded-lg shadow-lg flex items-center space-x-2 backdrop-blur-md">
              <span class="material-symbols-outlined text-base">lock</span>
              <span>ゲスト閲覧モード（保護中）</span>
            </div>
          </div>
        <% end %>

        <div class="<%= 'blur-[3px] pointer-events-none select-none opacity-80' if current_user.guest? %>">
          <% if @popular_posts.any? %>
            <div class="space-y-4">
              <% @popular_posts.each do |post| %>
                <div class="flex items-start space-x-3 p-3 bg-gray-50 dark:bg-slate-700 rounded-lg">
                  <%= user_avatar(post.user, classes: "h-10 w-10 rounded-full flex-shrink-0") %>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                      <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                        <%= post.user.name %>
                      </p>
                      <span class="text-xs text-gray-500 dark:text-gray-400">
                        <%= time_ago_in_words_game_style(post.created_at) %>
                      </span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mt-1 line-clamp-2">
                      <%= post.body.presence || "#{post.weather_emoji} #{post.feeling_emoji}" %>
                    </p>
                    <div class="flex items-center mt-2 text-xs text-gray-500 dark:text-gray-400">
                      <span class="material-symbols-outlined text-sm mr-1">favorite</span>
                      <%= post.reactions_count %> リアクション
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-center text-gray-500 dark:text-gray-400 py-8">投稿がありません</p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- 最近の投稿 -->
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center">
          <span class="material-symbols-outlined mr-2">schedule</span>
          最近の投稿
        </h2>
      </div>
      <div class="p-6 relative">
        <% if current_user.guest? %>
          <div class="absolute inset-0 z-10 flex items-center justify-center bg-white/10 dark:bg-slate-900/10 rounded-b-lg">
            <div class="px-4 py-2 bg-slate-800/90 text-white text-sm font-bold rounded-lg shadow-lg flex items-center space-x-2 backdrop-blur-md">
              <span class="material-symbols-outlined text-base">lock</span>
              <span>ゲスト閲覧モード（保護中）</span>
            </div>
          </div>
        <% end %>

        <div class="<%= 'blur-[3px] pointer-events-none select-none opacity-80' if current_user.guest? %>">
          <% if @recent_posts.any? %>
            <div class="space-y-4">
              <% @recent_posts.each do |post| %>
                <div class="flex items-start space-x-3 p-3 bg-gray-50 dark:bg-slate-700 rounded-lg">
                  <%= user_avatar(post.user, classes: "h-10 w-10 rounded-full flex-shrink-0") %>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                      <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                        <%= post.user.name %>
                      </p>
                      <span class="text-xs text-gray-500 dark:text-gray-400">
                        <%= time_ago_in_words_game_style(post.created_at) %>
                      </span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-300 mt-1 line-clamp-2">
                      <%= post.body.presence || "#{post.weather_emoji} #{post.feeling_emoji}" %>
                    </p>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-center text-gray-500 dark:text-gray-400 py-8">投稿がありません</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- 最近の登録ユーザー -->
  <div class="bg-white dark:bg-slate-800 rounded-lg shadow">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <h2 class="text-lg font-bold text-gray-900 dark:text-white flex items-center">
        <span class="material-symbols-outlined mr-2">person_add</span>
        最近の登録ユーザー
      </h2>
    </div>
    <div class="p-6 relative">
      <% if current_user.guest? %>
        <div class="absolute inset-0 z-10 flex items-center justify-center bg-white/10 dark:bg-slate-900/10 rounded-b-lg">
          <div class="px-4 py-2 bg-slate-800/90 text-white text-sm font-bold rounded-lg shadow-lg flex items-center space-x-2 backdrop-blur-md">
            <span class="material-symbols-outlined text-base">lock</span>
            <span>ゲスト閲覧モード（保護中）</span>
          </div>
        </div>
      <% end %>

      <div class="<%= 'blur-[3px] pointer-events-none select-none opacity-80' if current_user.guest? %>">
        <% if @recent_users.any? %>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <% @recent_users.each do |user| %>
              <div class="flex flex-col items-center p-4 bg-gray-50 dark:bg-slate-700 rounded-lg">
                <%= user_avatar(user, classes: "h-16 w-16 rounded-full mb-2") %>
                <p class="text-sm font-medium text-gray-900 dark:text-white text-center truncate w-full">
                  <%= user.name %>
                </p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                  <%= time_ago_in_words_game_style(user.created_at) %>
                </p>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-center text-gray-500 dark:text-gray-400 py-8">ユーザーがいません</p>
        <% end %>
      </div>
    </div>
  </div>
</div>
</file>

<file path="app/views/posts/_reactions.html.erb">
<!-- app/views/posts/_reactions.html.erb -->
<!-- 投稿に対するリアクションボタン群を表示 -->

<div id="post_<%= post.id %>_reactions" class="flex gap-3 mt-3 items-start">
  <!-- ========================================
       事前準備：N+1問題を回避するため、一度だけデータを整理
       ======================================== -->

  <!-- 自分がつけたリアクションの種類をSetで保持（高速な検索用） -->
  <% my_reaction_kinds = post.reactions
                             .select { |r| r.user_id == current_user.id }
                             .map(&:kind)
                             .to_set %>

  <!-- リアクションの種類ごとの件数をハッシュで保持 -->
  <% reaction_counts = post.reactions
                           .group_by(&:kind)
                           .transform_values(&:count) %>

  <!-- ========================================
       左側：追加ボタン（固定）
       ======================================== -->
  <div class="relative shrink-0" data-controller="popover">
    <!-- トリガーボタン -->
    <button type="button"
            data-action="click->popover#toggle"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-white/50 dark:bg-slate-700/50 text-gray-400 dark:text-gray-500 border border-white/60 dark:border-gray-600 hover:bg-white dark:hover:bg-slate-600 hover:text-gray-600 dark:hover:text-gray-300 transition-all shadow-[inset_2px_2px_5px_rgba(255,255,255,0.8),inset_-2px_-2px_5px_rgba(0,0,0,0.05)] dark:shadow-inner"
            title="リアクションを追加">
      <span class="material-symbols-outlined text-xl">add_reaction</span>
    </button>

    <!-- ピッカー（吹き出し） -->
    <div data-popover-target="content"
         class="hidden absolute bottom-full left-0 mb-2 p-4 bg-white/95 dark:bg-slate-800/95 backdrop-blur-md rounded-[2rem] shadow-[10px_10px_30px_rgba(0,0,0,0.1),-10px_-10px_30px_rgba(255,255,255,0.8)] dark:shadow-xl border border-white/60 dark:border-gray-700 w-64 z-30 animate-fade-in-up origin-bottom-left">
      <div class="grid grid-cols-4 gap-2">
        <% Reaction.all_kinds.each do |reaction_info| %>
          <% kind = reaction_info[:kind] %>
          <% is_reacted = my_reaction_kinds.include?(kind) %>
          <% count = reaction_counts[kind] || 0 %>

          <button type="button"
                  id="picker-btn-<%= post.id %>-<%= kind %>"
                  class="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors flex flex-col items-center justify-center group <%= is_reacted ? 'bg-blue-50 dark:bg-blue-900/20' : '' %>"
                  data-action="click->popover#close"
                  onclick="document.getElementById('reaction-btn-<%= post.id %>-<%= kind %>').click();">
            <span class="text-2xl group-hover:scale-125 transition-transform duration-200"><%= reaction_info[:emoji] %></span>
            <span class="text-[10px] text-gray-500 dark:text-gray-400 mt-1"><%= reaction_info[:label] %></span>
          </button>
        <% end %>
      </div>
    </div>
  </div>

  <!-- ========================================
       右側：スタンプ一覧（横スクロール）
       ======================================== -->
  <div data-controller="scroll-drag" class="flex overflow-x-auto gap-1.5 scrollbar-hide [&::-webkit-scrollbar]:hidden items-center py-1 pr-4 mask-image-linear-gradient">
    <% Reaction.all_kinds.each do |reaction_info| %>
      <% kind = reaction_info[:kind] %>
      <% count = reaction_counts[kind] || 0 %>
      <% is_reacted = my_reaction_kinds.include?(kind) %>

      <%# カウントが0かつ未リアクションの場合はhiddenクラスで隠す %>
      <% is_hidden = count == 0 && !is_reacted %>

      <% button_class = if is_reacted
                          "reaction-btn flex-shrink-0 flex items-center gap-1 px-3 h-8 rounded-full bg-blue-50 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300 border border-blue-200 dark:border-blue-500/50 hover:bg-blue-100 dark:hover:bg-blue-800/50 transition transform active:scale-95 shadow-[2px_2px_5px_rgba(0,0,0,0.1),-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-none"
                        else
                          "reaction-btn flex-shrink-0 flex items-center gap-1 px-3 h-8 rounded-full bg-white/50 dark:bg-white/5 text-gray-600 dark:text-gray-300 border border-white/60 dark:border-white/10 hover:bg-white dark:hover:bg-white/10 transition transform active:scale-95 shadow-[inset_2px_2px_5px_rgba(255,255,255,0.8),inset_-2px_-2px_5px_rgba(0,0,0,0.05)] dark:shadow-none"
                        end %>

      <%# hiddenクラスを追加 %>
      <% button_class += " hidden" if is_hidden %>

      <button type="button"
              id="reaction-btn-<%= post.id %>-<%= kind %>"
              class="<%= button_class %>"
              data-controller="reaction"
              data-action="click->reaction#toggle"
              data-reaction-target="button"
              data-reaction-url-value="<%= post_reactions_path(post) %>"
              data-reaction-kind-value="<%= kind %>"
              data-reaction-count-value="<%= count %>"
              data-reaction-reacted-value="<%= is_reacted %>">

        <span class="text-base transition-transform duration-200" data-reaction-target="emoji"><%= reaction_info[:emoji] %></span>
        <span class="text-xs font-bold" data-reaction-target="count"><%= count %></span>
      </button>
    <% end %>
  </div>
</div>
</file>

<file path="app/views/users/_avatar_section.html.erb">
<div id="user_avatar_section" class="flex flex-col items-center mb-8 mt-2" data-controller="avatar-upload">
  <!-- 現在のアバター表示 (メイン) -->
  <div class="relative mb-6 group">
    <div class="w-24 h-24 rounded-full overflow-hidden shadow-xl ring-4 ring-white dark:ring-slate-800 relative z-10">
      <%# プレビュー用のターゲットを設定 %>
      <% if user.uploaded? && user.uploaded_avatar.attached? %>
        <%= image_tag user.uploaded_avatar, class: "w-full h-full object-cover", data: { avatar_upload_target: "preview" } %>
      <% elsif user.google? && user.avatar_url.present? %>
        <%= image_tag user.avatar_url, class: "w-full h-full object-cover", data: { avatar_upload_target: "preview" } %>
      <% else %>
        <div class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-blue-500 to-indigo-600 text-white font-bold text-3xl">
          <%= user.name.to_s.strip.slice(0, 3).upcase %>
        </div>
        <img data-avatar-upload-target="preview" class="w-full h-full object-cover absolute inset-0 opacity-0" />
      <% end %>
    </div>

    <!-- 編集ボタン（カメラアイコン） - ゲストユーザーには非表示 -->
    <% unless user.guest? %>
      <button type="button"
              data-action="click->avatar-upload#openModal"
              class="absolute bottom-0 right-0 z-20 w-8 h-8 bg-white dark:bg-slate-700 text-gray-600 dark:text-gray-300 rounded-full shadow-lg border border-gray-200 dark:border-gray-600 flex items-center justify-center hover:bg-gray-50 dark:hover:bg-slate-600 transition-all hover:scale-110"
              title="アバターを変更">
        <span class="material-symbols-outlined text-sm">photo_camera</span>
      </button>
    <% end %>

    <!-- 装飾的な背景 -->
    <div class="absolute -inset-4 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full opacity-20 blur-xl group-hover:opacity-30 transition-opacity duration-500"></div>
  </div>

  <div class="text-center mb-6">
    <p class="text-gray-500 dark:text-slate-400 text-xs font-mono bg-gray-100 dark:bg-slate-800 px-2 py-1 rounded-md inline-block">
      <%= user.email %>
    </p>
  </div>

  <!-- アバター編集モーダル (dialog要素を使用) -->
  <dialog data-avatar-upload-target="modal"
          data-action="click->avatar-upload#clickOutside"
          class="rounded-2xl bg-white dark:bg-slate-900 text-left shadow-xl border border-gray-100 dark:border-slate-800 p-0 backdrop:bg-gray-500/75 backdrop:backdrop-blur-sm w-full max-w-lg open:animate-fade-in">

    <!-- モーダルヘッダー -->
    <div class="bg-gray-50 dark:bg-slate-800/50 px-4 py-3 sm:px-6 flex justify-between items-center border-b border-gray-100 dark:border-slate-800">
      <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white" id="modal-title">アバターを変更</h3>
      <button type="button" data-action="click->avatar-upload#closeModal" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300 transition-colors">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>

    <!-- モーダルボディ -->
    <div class="px-4 py-5 sm:p-6">
      <%= form_with(model: user, url: user_registration_path, method: :put, class: "w-full", data: { turbo: false }) do |f| %>
        <div class="grid grid-cols-3 gap-3 mb-6">

          <!-- 1. デフォルト -->
          <label class="cursor-pointer group relative" data-avatar-upload-target="optionCard" data-value="default">
            <%= f.radio_button :avatar_type, :default, class: "sr-only", data: { avatar_upload_target: "radio", action: "change->avatar-upload#updateUI" } %>
            <div class="h-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-all flex flex-col items-center justify-center gap-2">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-xs font-bold shadow-sm">
                <%= user.name.to_s.slice(0, 1).upcase %>
              </div>
              <span class="text-xs font-bold text-gray-600 dark:text-gray-300">デフォルト</span>
            </div>
          </label>

          <!-- 2. Google (連携済みの場合のみ有効) -->
          <% google_linked = user.google_uid.present? %>
          <label class="cursor-pointer group relative <%= 'opacity-50 cursor-not-allowed' unless google_linked %>" data-avatar-upload-target="optionCard" data-value="google">
            <%= f.radio_button :avatar_type, :google, class: "sr-only", disabled: !google_linked, data: { avatar_upload_target: "radio", action: "change->avatar-upload#updateUI" } %>
            <div class="h-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-all flex flex-col items-center justify-center gap-2">
              <% if google_linked && user.avatar_url.present? %>
                <%= image_tag user.avatar_url, class: "w-8 h-8 rounded-full object-cover shadow-sm" %>
              <% else %>
                <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400">
                  <span class="material-symbols-outlined text-lg">account_circle</span>
                </div>
              <% end %>
              <span class="text-xs font-bold text-gray-600 dark:text-gray-300">Google</span>
            </div>
            <% unless google_linked %>
              <div class="absolute inset-0 z-10" title="Google連携が必要です"></div>
            <% end %>
          </label>

          <!-- 3. アップロード -->
          <label class="cursor-pointer group relative" data-avatar-upload-target="optionCard" data-value="uploaded">
            <%= f.radio_button :avatar_type, :uploaded, class: "sr-only", data: { avatar_upload_target: "radio", action: "change->avatar-upload#updateUI" } %>
            <div class="h-full p-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-all flex flex-col items-center justify-center gap-2">
              <div data-avatar-upload-target="uploadIconContainer">
                <% if user.uploaded_avatar.attached? %>
                  <%= image_tag user.uploaded_avatar, class: "w-8 h-8 rounded-full object-cover shadow-sm" %>
                <% else %>
                  <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-400">
                    <span class="material-symbols-outlined text-lg">cloud_upload</span>
                  </div>
                <% end %>
              </div>
              <span class="text-xs font-bold text-gray-600 dark:text-gray-300">アップロード</span>
            </div>

            <!-- 削除ボタン（アップロード済みの場合のみ表示） -->
            <% if user.uploaded_avatar.attached? %>
              <button type="button"
                      data-action="click->avatar-upload#showDeleteModal"
                      class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center shadow-lg transition-all hover:scale-110 z-10"
                      title="アップロード画像を削除">
                <span class="material-symbols-outlined text-xs font-bold">close</span>
              </button>
            <% end %>
          </label>
        </div>

        <!-- エラーメッセージ表示エリア -->
        <div data-avatar-upload-target="errorMessage" class="hidden mb-4 p-3 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-xs font-bold rounded-lg border border-red-200 dark:border-red-800/30 flex items-center animate-pulse">
          <span class="material-symbols-outlined mr-1 text-base">error</span>
          <span></span>
        </div>

        <!-- ファイルアップロードエリア -->
        <div class="relative group mb-6">
          <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-2xl cursor-pointer bg-gray-50 dark:bg-slate-800/50 hover:bg-gray-100 dark:hover:bg-slate-800 transition-all duration-200"
                 data-avatar-upload-target="dropZone"
                 data-action="dragover->avatar-upload#dragOver dragenter->avatar-upload#dragOver dragleave->avatar-upload#dragLeave drop->avatar-upload#drop">
            <div class="flex flex-col items-center justify-center pt-5 pb-6 pointer-events-none">
              <span class="material-symbols-outlined text-3xl text-gray-400 mb-2 group-hover:text-blue-500 transition-colors">add_photo_alternate</span>
              <p class="mb-1 text-sm text-gray-500 dark:text-gray-400"><span class="font-bold">クリックまたは画像をドロップ</span></p>
              <p class="text-xs text-gray-400 dark:text-gray-500">PNG, JPG, GIF (最大 5MB)</p>
            </div>
            <%= f.file_field :uploaded_avatar, class: "hidden", accept: "image/*", data: { avatar_upload_target: "input", action: "change->avatar-upload#previewImage" } %>
          </label>
        </div>

        <!-- 保存ボタン -->
        <div>
          <%= f.button class: "w-full py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-xl shadow-md transition-colors flex items-center justify-center gap-2" do %>
            <span class="material-symbols-outlined">save</span>
            変更を保存する
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- アバター削除確認オーバーレイ -->
    <div id="avatar_delete_modal" class="hidden absolute inset-0 bg-white/90 dark:bg-slate-900/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm rounded-2xl">
      <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 max-w-sm w-full shadow-2xl border border-gray-100 dark:border-gray-700 transform scale-100 animate-fade-in-up">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center">
          <span class="material-symbols-outlined text-red-500 mr-2">warning</span>
          画像の削除
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
          アップロードした画像を削除しますか？<br>
          この操作は取り消せません。
        </p>

        <div class="flex justify-end space-x-3">
          <button type="button"
                  data-action="click->avatar-upload#hideDeleteModal"
                  class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 font-medium text-sm transition-colors">
            キャンセル
          </button>
          <%= button_to delete_user_uploaded_avatar_path,
              method: :delete,
              class: "bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors text-sm flex items-center" do %>
            <span class="material-symbols-outlined text-lg mr-1">delete</span>
            削除する
          <% end %>
        </div>
      </div>
    </div>
  </dialog>
</div>
</file>

<file path="app/views/walks/show.html.erb">
<% content_for :title, "散歩記録詳細 - てくメモ" %>

<div class="flex-1 p-4 pb-24 w-full max-w-2xl mx-auto space-y-6">

  <!-- ヘッダーエリア：日付と場所 -->
  <div class="text-center space-y-2">
    <div class="inline-block bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm px-4 py-1 rounded-full border border-gray-200 dark:border-cyan-500/30 shadow-sm">
      <span class="text-sm font-bold text-gray-500 dark:text-cyan-400">
        <%= %w[日 月 火 水 木 金 土][@walk.walked_on.wday] %>曜日
      </span>
    </div>
    <h1 class="text-4xl font-black text-gray-900 dark:text-cyan-50 tracking-tight dark:drop-shadow-[0_0_10px_rgba(34,211,238,0.5)]">
      <%= @walk.walked_on.strftime('%Y.%m.%d') %>
    </h1>
    <div class="flex items-center justify-center space-x-1 text-gray-600 dark:text-cyan-100">
      <span class="material-symbols-outlined text-red-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-cyan-300 dark:to-blue-300 dark:drop-shadow-[0_0_8px_rgba(34,211,238,0.8)]">location_on</span>
      <span class="font-bold text-lg"><%= @walk.location %></span>
    </div>
  </div>

  <!-- Bento Grid 統計情報 -->
  <div class="grid grid-cols-2 gap-4">
    <!-- 距離カード -->
    <div class="bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#dcfce7_90%)] dark:bg-none dark:bg-gradient-to-br dark:from-slate-900/90 dark:to-emerald-950/90 backdrop-blur-xl rounded-[3.75rem] p-5 text-gray-800 dark:text-white shadow-[15px_15px_40px_rgba(34,197,94,0.2),-15px_-15px_40px_#ffffff,inset_-5px_-5px_15px_rgba(34,197,94,0.1),inset_5px_5px_15px_rgba(255,255,255,0.7)] dark:shadow-[0_0_15px_rgba(16,185,129,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] relative overflow-hidden group hover:scale-105 transition-transform duration-300 border-2 border-white/60 dark:border-emerald-500/30 dark:border-t-white/40 before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
      <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-white/20 dark:bg-emerald-500/10 rounded-full blur-2xl"></div>
      <div class="relative z-10 pl-2">
        <div class="flex items-center space-x-1 mb-2 opacity-90">
          <span class="material-symbols-outlined dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-emerald-300 dark:to-green-300 dark:drop-shadow-[0_0_8px_rgba(16,185,129,0.8)]">straighten</span>
          <span class="text-[10px] sm:text-xs font-bold dark:text-emerald-200">距離</span>
        </div>
        <div class="flex items-baseline">
          <span class="inline-block text-xl sm:text-4xl font-black tracking-tighter text-shadow-sm bg-clip-text text-transparent bg-gradient-to-b from-green-400 to-emerald-600 dark:from-emerald-300 dark:via-green-300 dark:to-emerald-500 dark:drop-shadow-[0_0_5px_rgba(16,185,129,0.5)]"
                data-controller="counter"
                data-counter-target-value="<%= @walk.distance %>">
            0
          </span>
          <span class="text-xs sm:text-sm font-bold ml-1 opacity-90 dark:text-emerald-400">km</span>
        </div>
      </div>
    </div>

    <!-- 時間カード -->
    <div class="bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#e0f2fe_90%)] dark:bg-none dark:bg-gradient-to-br dark:from-slate-900/90 dark:to-indigo-950/90 backdrop-blur-xl rounded-[3.75rem] p-5 text-gray-800 dark:text-white shadow-[15px_15px_40px_rgba(14,165,233,0.2),-15px_-15px_40px_#ffffff,inset_-5px_-5px_15px_rgba(14,165,233,0.1),inset_5px_5px_15px_rgba(255,255,255,0.7)] dark:shadow-[0_0_15px_rgba(6,182,212,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] relative overflow-hidden group hover:scale-105 transition-transform duration-300 border-2 border-white/60 dark:border-cyan-500/30 dark:border-t-white/40 before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
      <div class="absolute bottom-0 left-0 -ml-4 -mb-4 w-24 h-24 bg-white/20 dark:bg-cyan-500/10 rounded-full blur-2xl"></div>
      <div class="relative z-10 pl-2">
        <div class="flex items-center space-x-1 mb-2 opacity-90">
          <span class="material-symbols-outlined dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-cyan-300 dark:to-blue-300 dark:drop-shadow-[0_0_8px_rgba(34,211,238,0.8)]">schedule</span>
          <span class="text-[10px] sm:text-xs font-bold dark:text-cyan-200">時間</span>
        </div>
        <div class="flex items-baseline">
          <span class="inline-block text-xl sm:text-4xl font-black tracking-tighter text-shadow-sm bg-clip-text text-transparent bg-gradient-to-b from-sky-400 to-blue-600 dark:from-cyan-300 dark:via-blue-300 dark:to-cyan-500 dark:drop-shadow-[0_0_5px_rgba(34,211,238,0.5)]"
                data-controller="counter"
                data-counter-target-value="<%= @walk.duration %>">
            0
          </span>
          <span class="text-xs sm:text-sm font-bold ml-1 opacity-90 dark:text-cyan-400">分</span>
        </div>
      </div>
    </div>

    <!-- 歩数カード -->
    <div class="bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#f3e8ff_90%)] dark:bg-none dark:bg-gradient-to-br dark:from-slate-900/90 dark:to-purple-950/90 backdrop-blur-xl rounded-[3.75rem] p-5 text-gray-800 dark:text-white shadow-[15px_15px_40px_rgba(168,85,247,0.2),-15px_-15px_40px_#ffffff,inset_-5px_-5px_15px_rgba(168,85,247,0.1),inset_5px_5px_15px_rgba(255,255,255,0.7)] dark:shadow-[0_0_15px_rgba(168,85,247,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] relative overflow-hidden group hover:scale-105 transition-transform duration-300 border-2 border-white/60 dark:border-purple-500/30 dark:border-t-white/40 before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
      <div class="absolute top-0 left-0 -ml-4 -mt-4 w-24 h-24 bg-white/20 dark:bg-purple-500/10 rounded-full blur-2xl"></div>
      <div class="relative z-10 pl-2">
        <div class="flex items-center space-x-1 mb-2 opacity-90">
          <span class="material-symbols-outlined dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-purple-300 dark:to-fuchsia-300 dark:drop-shadow-[0_0_8px_rgba(168,85,247,0.8)]">directions_walk</span>
          <span class="text-[10px] sm:text-xs font-bold dark:text-purple-200">歩数</span>
        </div>
        <div class="flex items-baseline">
          <span class="inline-block text-xl sm:text-4xl font-black tracking-tighter text-shadow-sm bg-clip-text text-transparent bg-gradient-to-b from-purple-400 to-indigo-600 dark:from-purple-300 dark:via-fuchsia-300 dark:to-purple-500 dark:drop-shadow-[0_0_5px_rgba(168,85,247,0.5)]"
                data-controller="counter"
                data-counter-target-value="<%= @walk.steps || 0 %>">
            0
          </span>
          <span class="text-xs sm:text-sm font-bold ml-1 opacity-90 dark:text-purple-400">歩</span>
        </div>
      </div>
    </div>

    <!-- カロリーカード -->
    <div class="bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#ffedd5_90%)] dark:bg-none dark:bg-gradient-to-br dark:from-slate-900/90 dark:to-rose-950/90 backdrop-blur-xl rounded-[3.75rem] p-5 text-gray-800 dark:text-white shadow-[15px_15px_40px_rgba(249,115,22,0.2),-15px_-15px_40px_#ffffff,inset_-5px_-5px_15px_rgba(249,115,22,0.1),inset_5px_5px_15px_rgba(255,255,255,0.7)] dark:shadow-[0_0_15px_rgba(244,63,94,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] relative overflow-hidden group hover:scale-105 transition-transform duration-300 border-2 border-white/60 dark:border-rose-500/30 dark:border-t-white/40 before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
      <div class="absolute bottom-0 right-0 -mr-4 -mb-4 w-24 h-24 bg-white/20 dark:bg-rose-500/10 rounded-full blur-2xl"></div>
      <div class="relative z-10 pl-2">
        <div class="flex items-center space-x-1 mb-2 opacity-90">
          <span class="material-symbols-outlined dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-orange-300 dark:to-red-300 dark:drop-shadow-[0_0_8px_rgba(251,146,60,0.8)]">local_fire_department</span>
          <span class="text-[10px] sm:text-xs font-bold dark:text-rose-200">消費カロリー</span>
        </div>
        <div class="flex items-baseline">
          <span class="inline-block text-xl sm:text-4xl font-black tracking-tighter text-shadow-sm bg-clip-text text-transparent bg-gradient-to-b from-orange-400 to-red-600 dark:from-orange-300 dark:via-red-300 dark:to-orange-500 dark:drop-shadow-[0_0_5px_rgba(244,63,94,0.5)]"
                data-controller="counter"
                data-counter-target-value="<%= @walk.calories_burned || 0 %>">
            0
          </span>
          <span class="text-xs sm:text-sm font-bold ml-1 opacity-90 dark:text-rose-400">kcal</span>
        </div>
      </div>
    </div>
  </div>

  <!-- メモセクション（ノート風） -->
  <% if @walk.notes.present? %>
    <div class="bg-yellow-50 dark:bg-slate-900/80 backdrop-blur-sm border-l-4 border-yellow-400 dark:border-yellow-400 p-5 rounded-r-xl shadow-sm dark:shadow-[0_0_10px_rgba(250,204,21,0.1)] relative overflow-hidden">
      <div class="flex items-center space-x-2 mb-3 text-yellow-600 dark:text-yellow-300">
        <span class="material-symbols-outlined">edit_note</span>
        <h3 class="font-bold text-sm uppercase tracking-wider">Memo</h3>
      </div>
      <p class="text-gray-700 dark:text-yellow-50 whitespace-pre-wrap leading-relaxed font-medium">
        <%= @walk.notes %>
      </p>
    </div>
  <% end %>

  <!-- アクションボタン -->
  <div class="grid grid-cols-3 gap-3 pt-4">
    <%= link_to walks_path,
        class: "col-span-1 bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#f3f4f6_90%)] dark:bg-none dark:bg-slate-800/80 backdrop-blur-sm text-gray-600 dark:text-slate-400 hover:shadow-[10px_10px_20px_rgba(156,163,175,0.2),-10px_-10px_20px_#ffffff] dark:hover:bg-slate-700 font-bold py-4 rounded-[3.75rem] flex flex-col items-center justify-center space-y-1 transition-all active:scale-95 shadow-[5px_5px_15px_rgba(156,163,175,0.1),-5px_-5px_15px_#ffffff,inset_-2px_-2px_5px_rgba(156,163,175,0.05),inset_2px_2px_5px_rgba(255,255,255,0.5)] border-2 border-white/60 dark:border-white/5 dark:border-t-white/20 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none" do %>
      <span class="material-symbols-outlined">arrow_back</span>
      <span class="text-xs">戻る</span>
    <% end %>

    <%= link_to edit_walk_path(@walk),
        class: "col-span-1 bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#e0f2fe_90%)] dark:bg-none dark:bg-cyan-950/50 backdrop-blur-sm text-blue-600 dark:text-cyan-400 hover:shadow-[10px_10px_20px_rgba(14,165,233,0.2),-10px_-10px_20px_#ffffff] dark:hover:bg-cyan-900/50 font-bold py-4 rounded-[3.75rem] flex flex-col items-center justify-center space-y-1 transition-all active:scale-95 shadow-[5px_5px_15px_rgba(14,165,233,0.1),-5px_-5px_15px_#ffffff,inset_-2px_-2px_5px_rgba(14,165,233,0.05),inset_2px_2px_5px_rgba(255,255,255,0.5)] border-2 border-white/60 dark:border-cyan-500/50 dark:border-t-white/20 dark:shadow-[0_0_10px_rgba(34,211,238,0.2)] relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none" do %>
      <span class="material-symbols-outlined">edit</span>
      <span class="text-xs">編集</span>
    <% end %>

    <%= link_to walk_path(@walk),
        method: :delete,
        data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
        class: "col-span-1 bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#ffe4e6_90%)] dark:bg-none dark:bg-rose-950/50 backdrop-blur-sm text-red-600 dark:text-rose-400 hover:shadow-[10px_10px_20px_rgba(244,63,94,0.2),-10px_-10px_20px_#ffffff] dark:hover:bg-rose-900/50 font-bold py-4 rounded-[3.75rem] flex flex-col items-center justify-center space-y-1 transition-all active:scale-95 shadow-[5px_5px_15px_rgba(244,63,94,0.1),-5px_-5px_15px_#ffffff,inset_-2px_-2px_5px_rgba(244,63,94,0.05),inset_2px_2px_5px_rgba(255,255,255,0.5)] border-2 border-white/60 dark:border-rose-500/50 dark:border-t-white/20 dark:shadow-[0_0_10px_rgba(244,63,94,0.2)] relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none" do %>
      <span class="material-symbols-outlined">delete</span>
      <span class="text-xs">削除</span>
    <% end %>
  </div>

</div>
</file>

<file path="config/locales/ja.yml">
---
ja:
  activerecord:
    attributes:
      walk:
        walked_on: "散歩日"
        steps: "歩数"
        distance: "距離"
        duration: "時間"
        calories: "カロリー"
        location: "場所"
        notes: "メモ"
      user:
        name: "ユーザー名"
        email: "メールアドレス"
        password: "パスワード"
        password_confirmation: "パスワード（確認）"
        current_password: "現在のパスワード"
        target_distance: "目標距離"
      post:
        body: "ひとことメモ"
        weather: "天気"
        feeling: "気分"
    errors:
      messages:
        record_invalid: "バリデーションに失敗しました: %{errors}"
        restrict_dependent_destroy:
          has_one: "%{record}が存在しているので削除できません"
          has_many: "%{record}が存在しているので削除できません"
  date:
    abbr_day_names:
      - 日
      - 月
      - 火
      - 水
      - 木
      - 金
      - 土
    abbr_month_names:
      -
      - 1月
      - 2月
      - 3月
      - 4月
      - 5月
      - 6月
      - 7月
      - 8月
      - 9月
      - 10月
      - 11月
      - 12月
    day_names:
      - 日曜日
      - 月曜日
      - 火曜日
      - 水曜日
      - 木曜日
      - 金曜日
      - 土曜日
    formats:
      default: "%Y/%m/%d"
      long: "%Y年%m月%d日(%a)"
      short: "%m/%d"
    month_names:
      -
      - 1月
      - 2月
      - 3月
      - 4月
      - 5月
      - 6月
      - 7月
      - 8月
      - 9月
      - 10月
      - 11月
      - 12月
    order:
      - :year
      - :month
      - :day
  datetime:
    distance_in_words:
      about_x_hours: 約%{count}時間
      about_x_months: 約%{count}ヶ月
      about_x_years: 約%{count}年
      almost_x_years: "%{count}年弱"
      half_a_minute: 30秒前後
      less_than_x_seconds: "%{count}秒未満"
      less_than_x_minutes: "%{count}分未満"
      over_x_years: "%{count}年以上"
      x_seconds: "%{count}秒"
      x_minutes: "%{count}分"
      x_days: "%{count}日"
      x_months: "%{count}ヶ月"
      x_years: "%{count}年"
    prompts:
      second: 秒
      minute: 分
      hour: 時
      day: 日
      month: 月
      year: 年
  errors:
    format: "%{attribute}%{message}"
    messages:
      accepted: を受諾してください
      blank: を入力してください
      confirmation: と%{attribute}の入力が一致しません
      empty: を入力してください
      equal_to: は%{count}にしてください
      even: は偶数にしてください
      exclusion: は予約されています
      greater_than: は%{count}より大きい値にしてください
      greater_than_or_equal_to: は%{count}以上の値にしてください
      in: は%{count}の範囲に含めてください
      inclusion: は一覧にありません
      invalid: は不正な値です
      less_than: は%{count}より小さい値にしてください
      less_than_or_equal_to: は%{count}以下の値にしてください
      model_invalid: "バリデーションに失敗しました: %{errors}"
      not_a_number: は数値で入力してください
      not_an_integer: は整数で入力してください
      odd: は奇数にしてください
      other_than: は%{count}以外の値にしてください
      password_too_long: が長すぎます
      present: は入力しないでください
      required: を入力してください
      taken: はすでに存在します
      too_long: は%{count}文字以内で入力してください
      too_short: は%{count}文字以上で入力してください
      wrong_length: は%{count}文字で入力してください
    template:
      body: 次の項目を確認してください
      header: "%{model}に%{count}個のエラーが発生しました"
  helpers:
    select:
      prompt: 選択してください
    submit:
      create: 登録する
      submit: 保存する
      update: 更新する
  number:
    nth:
      ordinals:
        default: "位"
    currency:
      format:
        delimiter: ","
        format: "%n%u"
        negative_format: "-%u%n"
        precision: 0
        separator: "."
        significant: false
        strip_insignificant_zeros: false
        unit: 円
    format:
      delimiter: ","
      precision: 3
      round_mode: default
      separator: "."
      significant: false
      strip_insignificant_zeros: false
    human:
      decimal_units:
        format: "%n %u"
        units:
          billion: 十億
          million: 百万
          quadrillion: 千兆
          thousand: 千
          trillion: 兆
          unit: ""
      format:
        delimiter: ""
        precision: 3
        significant: true
        strip_insignificant_zeros: true
      storage_units:
        format: "%n%u"
        units:
          byte: バイト
          eb: EB
          gb: GB
          kb: KB
          mb: MB
          pb: PB
          tb: TB
          zb: ZB
  support:
    array:
      last_word_connector: "、"
      two_words_connector: "、"
      words_connector: "、"
  time:
    am: 午前
    formats:
      default: "%Y年%m月%d日(%a) %H時%M分%S秒 %z"
      long: "%Y/%m/%d %H:%M"
      short: "%m/%d %H:%M"
    pm: 午後
  flash:
    walks:
      create:
        notice: "散歩記録を作成しました"
      update:
        notice: "散歩記録を更新しました"
      destroy:
        notice: "散歩記録を削除しました"
  rankings:
    index:
      title: "ランキング"
      subtitle: "競い合って、一緒に成長しよう！"
      update_frequency: "（1時間ごとに更新）"
      tabs:
        weekly: "週次"
        monthly: "月次"
        yearly: "年次"
      your_rank:
        title: "あなたの順位"
        rank_suffix: "位"
        top_10: "トップ10入り！"
        distance: "歩行距離"
        unit: "歩きました"
        distance_to_top: "1位まであと"
        distance_to_next: "次の順位まであと"
      podium: "表彰台"
      list_title: "ランキング"
      you: "あなた"
      empty:
        title: "記録はまだありません"
        subtitle: "一番乗りのチャンス！"
        action: "散歩を記録する"
        cheer: "もっと歩いてランクイン！"
        challenge: "TOP 100チャレンジ中"
  enums:
    walk:
      time_of_day:
        early_morning: "早朝"
        day: "日中"
        evening: "夕方"
        night: "夜間"
</file>

<file path="spec/models/notification_spec.rb">
require 'rails_helper'

RSpec.describe Notification, type: :model do
  let(:user) { FactoryBot.build_stubbed(:user) }
  let(:announcement) { FactoryBot.build_stubbed(:announcement, is_published: false) }
  let(:notification) { FactoryBot.build_stubbed(:notification, user: user, announcement: announcement) }

  describe 'アソシエーション' do
    it 'Userに属していること' do
      expect(notification.user).to be_a(User)
    end

    it 'Announcementに属していること' do
      expect(notification.announcement).to be_a(Announcement)
    end
  end

  describe 'スコープ' do
    let(:user) { FactoryBot.create(:user) }
    let(:announcement1) { FactoryBot.create(:announcement, is_published: false) }
    let(:announcement2) { FactoryBot.create(:announcement, is_published: false) }
    let!(:unread_notification) { FactoryBot.create(:notification, user: user, announcement: announcement1, read_at: nil) }
    let!(:read_notification) { FactoryBot.create(:notification, user: user, announcement: announcement2, read_at: 1.day.ago) }

    describe '.unread' do
      it '未読の通知のみを取得すること' do
        expect(Notification.unread).to include(unread_notification)
        expect(Notification.unread).not_to include(read_notification)
      end
    end

    describe '.read' do
      it '既読の通知のみを取得すること' do
        expect(Notification.read).to include(read_notification)
        expect(Notification.read).not_to include(unread_notification)
      end
    end

    describe '.ordered_by_announcement' do
      let!(:old_announcement) { FactoryBot.create(:announcement, published_at: 2.days.ago, is_published: false) }
      let!(:new_announcement) { FactoryBot.create(:announcement, published_at: 1.day.ago, is_published: false) }
      # old_announcementの通知を「新しく」作成する（作成順と公開順を逆転させる）
      let!(:notification_for_old) { FactoryBot.create(:notification, user: user, announcement: old_announcement, created_at: Time.current) }
      let!(:notification_for_new) { FactoryBot.create(:notification, user: user, announcement: new_announcement, created_at: 1.hour.ago) }

      it 'お知らせの公開日順（降順）に並ぶこと' do
        # created_at順だと notification_for_old が先に来るはずだが、
        # ordered_by_announcement なら notification_for_new が先に来るはず
        target_ids = [ notification_for_old.id, notification_for_new.id ]
        notifications = Notification.where(id: target_ids).ordered_by_announcement
        expect(notifications.first).to eq notification_for_new
        expect(notifications.last).to eq notification_for_old
      end
    end
  end

  describe 'メソッド' do
    describe '#mark_as_read!' do
      it '通知を既読にすること' do
        notification = FactoryBot.create(:notification, read_at: nil)
        notification.mark_as_read!
        expect(notification.reload.read_at).not_to be_nil
      end



      it '既に既読の場合は更新日時を変更しないこと' do
        read_time = 1.day.ago
        notification = FactoryBot.create(:notification, read_at: read_time)
        notification.mark_as_read!
        expect(notification.reload.read_at.to_i).to eq read_time.to_i
      end
    end

    describe '#unread?' do
      it '未読の場合はtrueを返すこと' do
        notification = FactoryBot.build(:notification, read_at: nil)
        expect(notification.unread?).to be true
      end

      it '既読の場合はfalseを返すこと' do
        notification = FactoryBot.build(:notification, read_at: Time.current)
        expect(notification.unread?).to be false
      end
    end
  end
end
</file>

<file path="spec/models/user_guest_spec.rb">
require 'rails_helper'

RSpec.describe User, type: :model do
  describe '.create_portfolio_guest' do
    # Cloudinaryの削除コールをモック（テスト環境での外部通信防止）
    before do
      allow(Cloudinary::Uploader).to receive(:destroy).and_return({ "result" => "ok" })

      # テストデータの強制お掃除（DB汚染対策）
      Reaction.delete_all
      Notification.delete_all
      WebPushSubscription.delete_all
      UserAchievement.delete_all
      Post.delete_all
      Walk.delete_all
      User.delete_all
    end

    context 'when admin user exists' do
      let!(:admin_user) { FactoryBot.create(:user, :admin, target_distance: 8000) }

      before do
        # 管理者用のデータ作成
        # 3ヶ月以内の散歩
        FactoryBot.create(:walk, user: admin_user, walked_on: 1.day.ago, distance: 5)
        FactoryBot.create(:walk, user: admin_user, walked_on: 2.months.ago, distance: 4)
        # 3ヶ月より前の散歩（コピーされないはず）
        FactoryBot.create(:walk, user: admin_user, walked_on: 4.months.ago, distance: 3)

        # 投稿
        FactoryBot.create(:post, user: admin_user, created_at: 1.day.ago)

        # 実績
        achievement = FactoryBot.create(:achievement)
        UserAchievement.create(user: admin_user, achievement: achievement)
      end

      it 'creates a guest user with copied data' do
        expect {
          User.create_portfolio_guest
        }.to change(User, :count).by(1)

        guest = User.last
        expect(guest.role).to eq 'guest'
        expect(guest.name).to eq 'ゲストユーザー'
        expect(guest.target_distance).to eq admin_user.target_distance # 管理者の設定を継承

        # 散歩記録のコピー確認
        expect(guest.walks.count).to eq 2
        distances = guest.walks.pluck(:distance)
        expect(distances).to include(5, 4)
        expect(distances).not_to include(3)

        # 投稿のコピー確認
        expect(guest.posts.count).to eq 1

        # 実績のコピー確認
        expect(guest.user_achievements.count).to eq 1
      end
    end

    context 'when no admin user exists' do
      # トランザクションでロールバックされるため、明示的な削除は不要
      # ただし、念のため管理者だけはいないことを保証するなどしてもよいが、
      # ここではシンプルに何も作らない状態でテストする

      it 'creates a fallback guest user' do
        guest = User.create_portfolio_guest
        expect(guest.role).to eq 'guest'
        expect(guest.persisted?).to be true
        expect(guest.walks.count).to eq 0
      end
    end

    context 'cleanup logic' do
      it 'removes guests created more than 24 hours ago' do
        old_guest = FactoryBot.create(:user, role: :guest, created_at: 25.hours.ago)
        new_guest = FactoryBot.create(:user, role: :guest, created_at: 1.hour.ago)

        User.create_portfolio_guest

        expect(User.exists?(old_guest.id)).to be false
        expect(User.exists?(new_guest.id)).to be true
      end
    end
  end
end
</file>

<file path="spec/requests/rankings/ogp_images_spec.rb">
require 'rails_helper'

RSpec.describe "Rankings::OgpImages", type: :request do
  let(:user) { create(:user) }

  # 画像生成サービスをスタブ化（高速化）
  let(:dummy_image_data) { "\xFF\xD8\xFF\xE0\x00\x10JFIF" } # JPEGマジックナンバー

  before do
    sign_in user
    allow_any_instance_of(RpgCardGeneratorService).to receive(:generate).and_return(dummy_image_data)
  end

  describe "GET /rankings/users/:id/ogp_image" do
    context "ユーザーが存在する場合" do
      it "画像データが直接返されること" do
        get ogp_image_rankings_user_path(user, format: :jpg)
        expect(response.status).to eq(200)
        expect(response.content_type).to eq("image/jpeg")
        expect(response.body).to eq(dummy_image_data)
      end

      it "キャッシュヘッダーが設定されていること" do
        get ogp_image_rankings_user_path(user, format: :jpg)
        expect(response.headers['Cache-Control']).to include('max-age')
      end

      it "画像が生成されてActive Storageに添付されること" do
        expect {
          get ogp_image_rankings_user_path(user, format: :jpg)
        }.to change { user.reload.ranking_ogp_image.attached? }.from(false).to(true)
      end
    end

    context "ユーザーが存在しない場合" do
      it "デフォルト画像へリダイレクトされること" do
        get ogp_image_rankings_user_path(id: 99999, format: :jpg)
        expect(response).to redirect_to(ActionController::Base.helpers.image_url("icon.png"))
      end
    end
  end
end
</file>

<file path="spec/system/guest_login_system_spec.rb">
require 'rails_helper'

RSpec.describe 'Guest Login', type: :system do
  # Cloudinaryの削除コールをモック
  before do
    allow(Cloudinary::Uploader).to receive(:destroy).and_return({ "result" => "ok" })

    # DBクリーンアップ
    Reaction.delete_all
    Notification.delete_all
    WebPushSubscription.delete_all
    UserAchievement.delete_all
    Post.delete_all
    Walk.delete_all
    User.delete_all
  end

  context 'when admin user exists (data source)', js: true do
    let!(:admin_user) { FactoryBot.create(:user, :admin, target_distance: 8000) }

    before do
       # 管理者データ作成（コピー元）
       FactoryBot.create(:walk, user: admin_user, walked_on: 1.day.ago, distance: 5)
    end

    it 'logs in as guest and deletes account on logout' do
      # 1. ログイン画面へアクセス
      visit new_user_session_path

      # 2. ゲストログイン実行
      expect {
        click_button 'ゲストログイン'
      }.to change(User, :count).by(1) # ゲストユーザーが1人増える

      # 3. ログイン成功を確認
      # ホーム画面（root_path）に遷移していることを確認
      expect(page).to have_current_path(root_path)
      # 認証が必要なコンテンツが表示されていることを確認
      expect(page).to have_content '今日の散歩'

      # 4. ゲストユーザーの特定
      guest = User.last
      expect(guest.role).to eq "guest"
      expect(guest.walks.count).to eq 1 # データがコピーされていること

      # 5. ログアウト実行
      expect {
        # ドロップダウンを開く
        find('button[data-action="click->dropdown#toggle"]').click
        click_link 'ログアウト'
      }.to change(User, :count).by(-1) # ゲストユーザーが削除される

      expect(page).to have_content 'ログアウトしました。'
    end
  end

  context 'when no admin user exists (fallback)', js: true do
    it 'creates a fallback guest and logs in' do
      visit new_user_session_path
      click_button 'ゲストログイン'

      expect(page).to have_content 'ゲストモードとしてログインしました。'
      expect(User.last.role).to eq "guest"
      expect(User.last.walks.count).to eq 0

      # Logout
      find('button[data-action="click->dropdown#toggle"]').click
      click_link 'ログアウト'
      expect(page).to have_content 'ログアウトしました。'
    end
  end
end
</file>

<file path="spec/rails_helper.rb">
# This file is copied to spec/ when you run 'rails generate rspec:install'
require 'spec_helper'
ENV['RAILS_ENV'] ||= 'test'
require_relative '../config/environment'
# Prevent database truncation if the environment is production
abort("The Rails environment is running in production mode!") if Rails.env.production?
# Uncomment the line below in case you have `--require rails_helper` in the `.rspec` file
# that will avoid rails generators crashing because migrations haven't been run yet
# return unless Rails.env.test?
require 'rspec/rails'
# Add additional requires below this line. Rails is not loaded until this point!

# Requires supporting ruby files with custom matchers and macros, etc, in
# spec/support/ and its subdirectories. Files matching `spec/**/*_spec.rb` are
# run as spec files by default. This means that files in spec/support that end
# in _spec.rb will both be required and run as specs, causing the specs to be
# run twice. It is recommended that you do not name files matching this glob to
# end with _spec.rb. You can configure this pattern with the --pattern
# option on the command line or in ~/.rspec, .rspec or `.rspec-local`.
#
# The following line is provided for convenience purposes. It has the downside
# of increasing the boot-up time by auto-requiring all files in the support
# directory. Alternatively, in the individual `*_spec.rb` files, manually
# require only the support files necessary.
#
Rails.root.glob('spec/support/**/*.rb').sort_by(&:to_s).each { |f| require f }

# Ensures that the test database schema matches the current schema file.
# If there are pending migrations it will invoke `db:test:prepare` to
# recreate the test database by loading the schema.
# If you are not using ActiveRecord, you can remove these lines.
begin
  ActiveRecord::Migration.maintain_test_schema!
rescue ActiveRecord::PendingMigrationError => e
  abort e.to_s.strip
end

require 'capybara/rails'
require 'capybara/cuprite'
require 'webmock/rspec'

# WebMockの設定: ローカルホストへの接続は許可する（システムテスト等のため）
WebMock.disable_net_connect!(allow_localhost: true)

# 並列実行時は負荷がかかるため、待機時間を長めに設定
Capybara.default_max_wait_time = 10

RSpec.configure do |config|
  # システムテストの設定
  config.before(:each, type: :system) do
    driven_by(:rack_test)
  end

  config.before(:each, type: :system, js: true) do
    driven_by(:cuprite, screen_size: [ 1400, 1400 ], options: {
      window_size: [ 1400, 1400 ],
      browser_options: {
        'no-sandbox' => nil,
        'disable-dev-shm-usage' => nil,
        'disable-gpu' => nil
      },
      process_timeout: 30, # タイムアウトを少し緩和
      timeout: 30,         # タイムアウトを少し緩和
      inspector: true,
      headless: true,
      # 高速化のために不要なリソースをブロック
      url_blacklist: [
        /fonts\.googleapis\.com/,
        /fonts\.gstatic\.com/,
        /analytics\.google\.com/,
        /www\.googletagmanager\.com/
      ]
    })
  end
end

RSpec.configure do |config|
  # Remove this line if you're not using ActiveRecord or ActiveRecord fixtures
  config.include Devise::Test::IntegrationHelpers, type: :system
  config.include Devise::Test::IntegrationHelpers, type: :request
  config.include Warden::Test::Helpers
  config.before(:suite) do
    Warden.test_mode!
  end
  config.after :each do
    Warden.test_reset!
  end

  # メール送信を高速化（メモリ内で完結）
  config.before(:each) do
    ActionMailer::Base.deliveries.clear
    stub_request(:any, /cloudinary\.com/).to_return(status: 200, body: "", headers: {})
  end

  config.include FactoryBot::Syntax::Methods
  config.include ActiveSupport::Testing::TimeHelpers
  config.fixture_paths = [
    Rails.root.join('spec/fixtures')
  ]

  # If you're not using ActiveRecord, or you'd prefer not to run each of your
  # examples within a transaction, remove the following line or assign false
  # instead of true.
  # DatabaseCleanerの設定
  # Rails標準のトランザクション管理を使用する
  config.use_transactional_fixtures = true

  # DatabaseCleanerの設定は削除（Rails標準機能で十分なため）

  # You can uncomment this line to turn off ActiveRecord support entirely.
  # config.use_active_record = false

  # RSpec Rails uses metadata to mix in different behaviours to your tests,
  # for example enabling you to call `get` and `post` in request specs. e.g.:
  #
  #     RSpec.describe UsersController, type: :request do
  #       # ...
  #     end
  #
  # The different available types are documented in the features, such as in
  # https://rspec.info/features/8-0/rspec-rails
  #
  # You can also this infer these behaviours automatically by location, e.g.
  # /spec/models would pull in the same behaviour as `type: :model` but this
  # behaviour is considered legacy and will be removed in a future version.
  #
  # To enable this behaviour uncomment the line below.
  # config.infer_spec_type_from_file_location!

  # Filter lines from Rails gems in backtraces.
  config.filter_rails_from_backtrace!
  # arbitrary gems may also be filtered via:
  # config.filter_gems_from_backtrace("gem name")
end
</file>

<file path="Gemfile">
source "https://rubygems.org"

# Rails本体
gem "rails", "~> 7.2.3"

# フロントエンド関連
gem "sprockets-rails"      # アセットパイプライン
gem "jsbundling-rails"     # JavaScriptバンドリング（esbuild等）
gem "turbo-rails"          # Hotwire Turbo（高速な画面遷移）
gem "stimulus-rails"       # Hotwire Stimulus（軽量なJSフレームワーク）
gem "jbuilder"             # JSON APIレスポンス構築用

# サーバー・パフォーマンス
gem "puma", ">= 5.0"       # アプリケーションサーバー
gem "bootsnap", require: false  # 起動速度の高速化

# データベース
gem "pg", "~> 1.6"         # PostgreSQL（本番環境）

# 認証・認可
gem "devise"                    # ユーザー認証の基盤
gem "omniauth-google-oauth2"    # Google OAuth2認証
# gem "omniauth-rails_csrf_protection", "~> 2.0.0"  # Rails 7 + Turbo環境では不要（CSRFトークンの二重チェックが問題を引き起こす）

# 外部API連携
gem "google-apis-fitness_v1"    # Google Fit APIとの連携

# UI/UX・機能拡張
gem "simple_calendar", "~> 3.0" # カレンダー表示
gem "kaminari"                  # ページネーション
gem "geocoder"                  # 位置情報・ジオコーディング
gem "mini_magick"               # 画像処理（OGP生成用）
gem "cloudinary"                # Cloudinary SDK
gem "activestorage-cloudinary-service"  # Active Storage用Cloudinaryアダプター


# キャッシュ
gem "solid_cache", "~> 1.0"     # Railsの高速キャッシュストア

# 通知機能
gem "web-push", "~> 3.1"        # Web Push通知

# システム・その他
gem "tzinfo-data", platforms: %i[ windows jruby ]  # WindowsやJRuby向けのタイムゾーンデータ
gem "dotenv-rails"              # 環境変数管理（.envファイル）
gem "foreman"                   # 複数プロセス管理（Procfile実行用）

# 開発環境・テスト環境共通
group :development, :test do
  gem "debug", platforms: %i[ mri windows ], require: "debug/prelude"  # デバッグツール
  gem "brakeman", require: false          # セキュリティ脆弱性検査
  gem "rubocop-rails-omakase", require: false  # コーディング規約チェック
  gem "rspec-rails", "~> 8.0"             # RSpec（テストフレームワーク）
  gem "factory_bot_rails", "~> 6.5"       # テストデータ生成（ファクトリー）
  gem "faker", "~> 3.5"                   # ダミーデータ生成
  gem "parallel_tests", "~> 5.5"          # 並列テスト実行
end

# 開発環境のみ
group :development do
  gem "web-console"  # ブラウザ上でのデバッグコンソール
end

# テスト環境のみ
group :test do
  gem "sqlite3", ">= 1.4"        # テスト専用のインメモリDB
  gem "capybara"                 # システムテスト（E2Eテスト）
  gem "cuprite"                  # Capybara用のヘッドレスChromeドライバー
  gem "swimming_fish", "~> 0.2.2"  # テスト用のダミーデータ生成ツール
  gem "webmock"                    # HTTPリクエストのスタブ化
end
</file>

<file path="app/assets/stylesheets/application.css">
/* Tailwind CSSのベースディレクティブ */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Material Symbols アイコンフォント設定 */
/* アイコンの見た目を統一するための設定 */
.material-symbols-outlined {
  font-variation-settings: "FILL" 0,
    /* アイコンを塗りつぶす（1 = 塗りつぶし、0 = 線のみ） */ "wght" 400,
    /* 太さ（100〜700の範囲） */ "GRAD" 0,
    /* グラデーション効果（-25〜200の範囲） */ "opsz" 24;
  /* 光学サイズ（20〜48の範囲） */
}

/* ===== カスタムコンポーネント ===== */
@layer components {
  /* ボタンのカーソルスタイル */
  button[type="submit"],
  input[type="submit"],
  button[type="button"] {
    @apply cursor-pointer;
  }

  button[type="submit"]:disabled,
  input[type="submit"]:disabled,
  button[type="button"]:disabled {
    @apply cursor-not-allowed opacity-50;
  }

  /* ===== Crystal Claymorphism Components ===== */

  /* Base Card Style */
  .crystal-card {
    @apply relative overflow-hidden !rounded-[3.75rem] p-6 transition-transform duration-200 hover:scale-105 border-2;

    /* CSS Variables for customization */
    --crystal-bg-end: #f3f4f6;
    --crystal-shadow-color: rgba(0, 0, 0, 0.05);
    --crystal-inset-shadow: rgba(0, 0, 0, 0.05);
    --crystal-border-color: rgba(255, 255, 255, 0.6);

    /* Light Mode Styles */
    background: radial-gradient(
      ellipse 120% 120% at 35% 35%,
      #ffffff 30%,
      var(--crystal-bg-end) 90%
    );
    box-shadow: 20px 20px 60px var(--crystal-shadow-color),
      -20px -20px 60px #ffffff, inset -5px -5px 15px var(--crystal-inset-shadow),
      inset 5px 5px 15px rgba(255, 255, 255, 0.7);
    border-color: var(--crystal-border-color);
  }

  /* Dark Mode Reset & Styles */
  :is(.dark .crystal-card) {
    background: none;
    box-shadow: none;
    border-color: transparent;
    @apply bg-gray-800 border-gray-700 shadow-xl;
  }

  /* Color Variants */
  .crystal-blue {
    --crystal-bg-end: #dbeafe; /* blue-100 */
    --crystal-shadow-color: rgba(59, 130, 246, 0.2);
    --crystal-inset-shadow: rgba(59, 130, 246, 0.1);
    --crystal-border-color: rgba(191, 219, 254, 0.6);
  }

  .crystal-purple {
    --crystal-bg-end: #f3e8ff; /* purple-100 */
    --crystal-shadow-color: rgba(168, 85, 247, 0.2);
    --crystal-inset-shadow: rgba(168, 85, 247, 0.1);
    --crystal-border-color: rgba(233, 213, 255, 0.6);
  }

  .crystal-emerald {
    --crystal-bg-end: #d1fae5; /* emerald-100 */
    --crystal-shadow-color: rgba(16, 185, 129, 0.2);
    --crystal-inset-shadow: rgba(16, 185, 129, 0.1);
    --crystal-border-color: rgba(167, 243, 208, 0.6);
  }

  .crystal-orange {
    --crystal-bg-end: #ffedd5; /* orange-100 */
    --crystal-shadow-color: rgba(249, 115, 22, 0.2);
    --crystal-inset-shadow: rgba(249, 115, 22, 0.1);
    --crystal-border-color: rgba(254, 215, 170, 0.6);
  }

  .crystal-pink {
    --crystal-bg-end: #fce7f3; /* pink-100 */
    --crystal-shadow-color: rgba(236, 72, 153, 0.2);
    --crystal-inset-shadow: rgba(236, 72, 153, 0.1);
    --crystal-border-color: rgba(251, 207, 232, 0.6);
  }

  .crystal-amber {
    --crystal-bg-end: #fef3c7; /* amber-100 */
    --crystal-shadow-color: rgba(245, 158, 11, 0.2);
    --crystal-inset-shadow: rgba(245, 158, 11, 0.1);
    --crystal-border-color: rgba(253, 230, 138, 0.6);
  }

  /* ===== Cloud Animation Background ===== */
  .cloud {
    background: linear-gradient(
      to bottom,
      #ffffff 40%,
      #dbeafe 100%
    ); /* 白から淡いブルー(#dbeafe)へのグラデーション */
    border-radius: 50%;
    position: absolute;
    filter: blur(12px);
    opacity: 0.95;
  }

  .cloud:after,
  .cloud:before {
    content: "";
    position: absolute;
    background: inherit;
    border-radius: 50%;
  }

  .cloud:after {
    width: 40%;
    height: 40%;
    top: -20%;
    left: 15%;
  }

  .cloud:before {
    width: 60%;
    height: 60%;
    top: -30%;
    right: 10%;
  }

  .animate-cloud-1 {
    animation: float-cloud 60s linear infinite;
  }

  .animate-cloud-2 {
    animation: float-cloud 90s linear infinite;
    animation-delay: -30s;
  }

  .animate-cloud-3 {
    animation: float-cloud 75s linear infinite;
    animation-delay: -10s;
  }
}

@keyframes float-cloud {
  0% {
    transform: translateX(100vw);
  }
  100% {
    transform: translateX(-100%);
  }
}

/* ===== カスタムユーティリティ ===== */
@layer utilities {
  /* グラデーションテキスト用 */
  .bg-clip-text {
    -webkit-background-clip: text;
    background-clip: text;
  }

  .text-fill-transparent {
    -webkit-text-fill-color: transparent;
  }

  /* テキストシャドウ（白文字の視認性向上用） */
  .text-shadow {
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.6);
  }

  /* カスタムスクロールバー（Webkit系） */
  .scrollbar-thin::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  .scrollbar-thin::-webkit-scrollbar-track {
    background: transparent;
  }

  .scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5); /* gray-400/50 */
    border-radius: 20px;
  }

  /* ダークモード用スクロールバー */
  .dark .scrollbar-thin::-webkit-scrollbar-thumb {
    background-color: rgba(87, 83, 78, 0.8); /* stone-600/80 */
  }

  .dark .scrollbar-thin::-webkit-scrollbar-track {
    background-color: rgba(41, 37, 36, 0.3); /* stone-900/30 */
  }
}
</file>

<file path="app/controllers/users/registrations_controller.rb">
# frozen_string_literal: true

class Users::RegistrationsController < Devise::RegistrationsController
  # ユーザー情報の更新前に、許可するパラメータを追加する
  before_action :configure_account_update_params, only: [ :update ]

  # GET /resource/edit
  # Deviseのデフォルトのeditアクションをそのまま使うので、オーバーライド不要
  # ただし、ビューは app/views/devise/registrations/edit.html.erb を使うことになる

  # PUT /resource
  # 更新処理
  def update
    # ゲストユーザーは更新不可
    if current_user.guest?
      redirect_to edit_user_registration_path, alert: "ゲストユーザーは設定を変更できません。"
      return
    end

    # Google連携済みなどでパスワードなしで更新したい場合のロジック
    # Devise標準の update_resource をオーバーライドしてもいいが、
    # ここでは super を呼ぶ前にパラメータを調整したり、
    # update_resource メソッド自体をオーバーライドするのが一般的。
    super
  end

  # Google連携解除アクション
  # これはDevise標準にはないので、独自に追加
  def disconnect_google
    # ゲストユーザーは操作不可
    if current_user.guest?
      redirect_to edit_user_registration_path, alert: "ゲストユーザーは設定を変更できません。"
      return
    end

    # Googleのみで登録したユーザー（パスワード未設定）のチェック
    # Googleログインのみで登録したユーザーは、自分のパスワードを知らない状態
    # そのため、先にパスワードを設定してもらう必要がある
    unless user_has_usable_password?(current_user)
      redirect_to edit_user_registration_path,
                  alert: "Google連携を解除する前に、セキュリティ設定で新しいパスワードを設定してください。パスワード設定後、再度連携解除を実行できます。"
      return
    end

    # パスワード入力チェック
    if params[:user].nil? || params[:user][:current_password].blank?
      redirect_to edit_user_registration_path, alert: "連携解除にはパスワードの入力が必要です。"
      return
    end

    # パスワード検証
    unless current_user.valid_password?(params[:user][:current_password])
      redirect_to edit_user_registration_path, alert: "パスワードが正しくありません。"
      return
    end

    if current_user.update(
      google_uid: nil,
      google_token: nil,
      google_refresh_token: nil,
      google_expires_at: nil,
      avatar_type: :default
    )
      redirect_to edit_user_registration_path, notice: "Google連携を解除しました。次回からはパスワードでログインしてください。"
    else
      redirect_to edit_user_registration_path, alert: "解除に失敗しました: #{current_user.errors.full_messages.join(', ')}"
    end
  end

  # アップロード画像の削除
  def delete_uploaded_avatar
    # ゲストユーザーは操作不可
    if current_user.guest?
      redirect_to edit_user_registration_path, alert: "ゲストユーザーは設定を変更できません。"
      return
    end

    if current_user.uploaded_avatar.attached?
      current_user.uploaded_avatar.purge
      current_user.update(avatar_type: :default)
      redirect_to edit_user_registration_path, notice: "アップロード画像を削除しました"
    else
      redirect_to edit_user_registration_path, alert: "削除する画像がありません"
    end
  end

  protected

  # アカウント更新時に許可するストロングパラメータの設定
  def configure_account_update_params
    devise_parameter_sanitizer.permit(:account_update, keys: [
      :name,
      :target_distance,
      :avatar_type,
      :uploaded_avatar,
      # 通知設定
      :walk_reminder_enabled,
      :walk_reminder_time,
      :inactive_days_reminder_enabled,
      :inactive_days_threshold,
      :reaction_summary_enabled
    ])
  end

  # 更新後のリダイレクト先
  def after_update_path_for(resource)
    edit_user_registration_path
  end

  # パスワードなしで更新する場合の対応
  def update_resource(resource, params)
    # 画像がアップロードされた場合、アバタータイプを自動的にuploadedにする
    if params[:uploaded_avatar].present?
      params[:avatar_type] = "uploaded"
    end

    # パスワード入力がある、またはメールアドレス変更時はパスワード必須
    if params[:password].present? || (params[:email].present? && params[:email] != resource.email)
      resource.update_with_password(params)
    else
      # それ以外（名前や目標距離のみの変更）はパスワードなしで更新
      params.delete(:current_password)
      resource.update_without_password(params)
    end
  end

  # ユーザーが「使える」パスワードを持っているかを判定
  # Googleのみで登録したユーザーはパスワードを知らない状態
  def user_has_usable_password?(user)
    # パスワードが暗号化されていない（空）なら論外
    return false if user.encrypted_password.blank?

    # Google未連携ならパスワード設定済みとみなす（Email登録）
    return true if user.google_uid.blank?

    # Google連携済みの場合
    # 「Googleログインのみで作成されたユーザー」は、作成と同時に連携情報が保存されるため
    # created_at と updated_at がほぼ同時になる。
    # 一方、通常登録ユーザーが後からGoogle連携した場合、
    # 連携のupdateで updated_at が更新されるので created_at と差が出る。

    # したがって、created_at より updated_at が新しければ、
    # 「後から連携した＝元々パスワードを持っていた」と判断する。
    # (マイグレーション不要での暫定対策としてはこれが最も確実)
    user.updated_at > user.created_at
  end
end
</file>

<file path="app/controllers/users/sessions_controller.rb">
class Users::SessionsController < Devise::SessionsController
  # ゲストログイン
  def new_guest
    resource = User.create_portfolio_guest
    sign_in(resource_name, resource)
    redirect_to root_path, notice: "ゲストモードとしてログインしました。"
  end

  # ログアウト時にゲストユーザーなら削除する
  def destroy
    if current_user && current_user.guest?
      host_guest = current_user
      # 高速化: 関連データを一括削除 (N+1削除の回避)
      # 削除対象が多い順に処理
      host_guest.walks.delete_all
      host_guest.posts.delete_all
      host_guest.user_achievements.delete_all
      host_guest.notifications.delete_all
      host_guest.reactions.delete_all

      # 削除対象のIDを保持（削除後に参照できなくなるため）
      guest_id = host_guest.id

      # Deviseのログアウト処理
      super do
        # ログアウト後に削除実行
        # 主なデータは既に削除済みなので、destroyは軽量に動作する
        User.find_by(id: guest_id)&.destroy
      end
    else
      super
    end
  end
end
</file>

<file path="app/controllers/google_fit_controller.rb">
class GoogleFitController < ApplicationController
  # ログインしていないユーザーはアクセスできないようにする
  before_action :authenticate_user!



  # Google Fitとの連携状態を確認する
  # GET /google_fit/status
  def status
    if current_user.google_token_valid?
      render json: {
        connected: true,
        email: current_user.email
      }
    else
      render json: {
        connected: false
      }
    end
  end

  # 指定した日のGoogle Fitデータを取得する
  # GET /google_fit/daily_data?date=YYYY-MM-DD
  def daily_data
    unless current_user.google_token_valid?
      render json: { error: "Google Fit not connected" }, status: :unauthorized
      return
    end

    date = params[:date].present? ? Date.parse(params[:date]) : Date.current
    service = GoogleFitService.new(current_user)

    # 指定日のデータを取得
    activities = service.fetch_activities(date, date)
    data = activities[date]

    if data
      render json: {
        date: date.to_s,
        steps: data[:steps],
        distance: data[:distance],
        calories: data[:calories],
        duration: data[:duration] || 0,
        start_time: data[:start_time]&.iso8601 || date.to_time.change(hour: 9).iso8601
      }
    else
      render json: {
        date: date.to_s,
        steps: 0,
        distance: 0.0,
        calories: 0,
        duration: 0
      }
    end
  rescue => e
    Rails.logger.error "Google Fit API Error: #{e.message}"
    render json: { error: e.message }, status: :internal_server_error
  end
end
</file>

<file path="app/controllers/posts_controller.rb">
class PostsController < ApplicationController
  before_action :authenticate_user!, except: [ :show ]

  # GET /posts
  # タイムライン（みんなの投稿）を表示
  def index
    # 全投稿を10件ずつ取得（N+1対策済み）
    @posts = Post.with_associations.recent.page(params[:page]).per(10)
    # 新規投稿フォーム用
    @post = Post.new
  end

  # GET /posts/:id
  # 投稿詳細（シェア用ページ）
  def show
    @post = Post.find(params[:id])
  end

  # GET /posts/mine
  # 投稿履歴（自分の投稿のみ）を表示
  def mine
    # 自分の投稿のみを10件ずつ取得
    @posts = current_user.posts.with_associations.recent.page(params[:page]).per(10)
    @post = Post.new
    # index と同じビューを使用
    render :index
  end

  # POST /posts
  # 新規投稿を作成
  def create
    # ゲストユーザーは投稿不可
    if current_user.guest?
      redirect_to posts_path, alert: "ゲストモードでは投稿機能は利用できません。"
      return
    end

    # ログインユーザーの投稿として作成
    @post = current_user.posts.build(post_params)

    # セキュリティ対策：他人の散歩記録を紐付けられないようにチェック
    if @post.walk_id.present?
      unless current_user.walks.exists?(id: @post.walk_id)
        redirect_to posts_path, alert: "不正な操作です。指定された散歩記録は存在しないか、権限がありません。"
        return
      end
    end

    if @post.save
      # OGP画像をバックグラウンドで生成（シェア時の高速化）
      GeneratePostOgpImageJob.perform_later(@post)

      # 成功：セッションに投稿IDを保存してモーダル表示フラグを立てる
      session[:show_post_success_modal] = @post.id
      # 投稿一覧ページに明示的にリダイレクト（モーダル表示のため）
      redirect_to posts_path, notice: "投稿しました！"
    else
      # 失敗：Turbo Streamでフォーム部分だけをエラーメッセージ付きで更新
      respond_to do |format|
        format.turbo_stream do
          render turbo_stream: turbo_stream.replace("new_post_form", partial: "posts/form", locals: { post: @post })
        end
        format.html do
          @posts = Post.with_associations.recent.page(params[:page]).per(10)
          # エラーメッセージを具体的に表示して、ユーザーが修正できるようにする
          flash.now[:alert] = "投稿に失敗しました: #{@post.errors.full_messages.join(', ')}"
          render :index, status: :unprocessable_entity
        end
      end
    end
  end

  # DELETE /posts/:id
  # 投稿を削除
  def destroy
    # 自分の投稿のみ削除可能（他人の投稿は RecordNotFound）
    post = current_user.posts.find(params[:id])
    post.destroy!
    redirect_back(fallback_location: posts_path, notice: "投稿を削除しました", status: :see_other)
  end

  private

  # 許可するパラメータを指定
  def post_params
    params.require(:post).permit(:body, :weather, :feeling, :walk_id)
  end
end
</file>

<file path="app/jobs/generate_ranking_ogp_image_job.rb">
class GenerateRankingOgpImageJob < ApplicationJob
  queue_as :default

  def perform(user, force: false)
    return unless user

    # 期間設定 (今週)
    start_date = Date.current.beginning_of_week
    end_date = Date.current.end_of_week
    period_key = "#{start_date.strftime('%Y%m%d')}_#{end_date.strftime('%Y%m%d')}"

    # 既に画像があり、期間キーが一致し、作成から24時間以内ならスキップ（強制フラグがない場合）
    if !force &&
       user.ranking_ogp_image.attached? &&
       user.ranking_ogp_image.filename.to_s.include?(period_key) &&
       user.ranking_ogp_image.blob.created_at > 24.hours.ago
      return
    end

    Rails.logger.info "Starting background Ranking OGP generation for User ID: #{user.id}"

    begin
      # 週間データ集計と順位計算をモデルに委譲
      stats = user.weekly_ranking_stats

      image_data = RpgCardGeneratorService.new(
        user: user,
        title: "RANKING CHAMPION",
        message: "今週のランキング結果！\n目指せトップランカー！",
        stats: stats,
        theme: :ranking
      ).generate

      # Active Storageに保存
      user.ranking_ogp_image.attach(
        io: StringIO.new(image_data),
        filename: "ranking_#{user.id}_#{period_key}.jpg",
        content_type: "image/jpeg"
      )

      Rails.logger.info "Background Ranking OGP generation completed for User ID: #{user.id}"
    rescue => e
      Rails.logger.error "Background Ranking OGP generation failed: #{e.message}"
    end
  end
end
</file>

<file path="app/views/devise/sessions/new.html.erb">
<% content_for :title, "てくメモ - ログイン" %>

<div class="flex flex-1 flex-col items-center justify-center p-4 relative overflow-hidden">
  <!-- 背景装飾（アニメーション付きオーブ） -->
  <div class="hidden dark:block absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-blue-400/20 dark:bg-blue-600/10 rounded-full blur-[100px] pointer-events-none animate-pulse-slow"></div>
  <div class="hidden dark:block absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-purple-400/20 dark:bg-purple-600/10 rounded-full blur-[100px] pointer-events-none animate-pulse-slow" style="animation-delay: 1s;"></div>

  <div class="w-full max-w-md relative z-10">
    <!-- メインカード -->
    <!-- メインカード -->
    <!-- メインカード -->
    <div class="bg-[radial-gradient(120%_120%_at_50%_50%,rgba(255,255,255,0.9)_0%,rgba(255,255,255,0.6)_100%)] dark:bg-none dark:bg-slate-950/60 backdrop-blur-2xl border border-white/60 dark:border-white/10 shadow-[20px_20px_60px_rgba(59,130,246,0.15),-20px_-20px_60px_rgba(255,255,255,0.8),inset_0_0_0_1px_rgba(255,255,255,0.5)] dark:shadow-[0_0_50px_rgba(0,0,0,0.5),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.2),inset_0_-20px_30px_-10px_rgba(59,130,246,0.15)] rounded-[2.5rem] p-8 sm:p-10 overflow-hidden relative group before:absolute before:inset-0 before:bg-gradient-to-b before:from-white/5 before:to-transparent before:opacity-0 dark:before:opacity-100 before:pointer-events-none before:animate-pulse">

      <!-- カード上部の光沢エフェクト -->
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-400/50 to-transparent opacity-50"></div>

      <!-- Header -->
      <div class="mb-10 text-center relative">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-cyan-400 text-white shadow-[0_10px_20px_rgba(59,130,246,0.3)] dark:shadow-blue-500/30 mb-4 transform rotate-[-5deg] group-hover:rotate-0 transition-transform duration-500">
          <span class="material-symbols-outlined text-3xl">hiking</span>
        </div>
        <h1 class="text-2xl font-black text-slate-800 dark:text-white tracking-tight">おかえりなさい</h1>
        <p class="mt-2 text-sm text-slate-500 dark:text-slate-400 font-medium">今日も歩いて、記録を残そう。</p>
      </div>

      <!-- Login Form -->
      <%= form_for(resource, as: resource_name, url: session_path(resource_name), html: { class: "space-y-5", data: { turbo: false } }) do |f| %>

        <!-- Email Field -->
        <div class="group/field">
          <%= f.label :email, "メールアドレス", class: "block text-xs font-bold text-slate-500 dark:text-slate-400 group-focus-within/field:text-blue-500 dark:group-focus-within/field:text-blue-400 mb-1.5 ml-1 uppercase tracking-wider transition-colors duration-200" %>
          <div class="relative transition-all duration-300 transform group-focus-within/field:scale-[1.01]">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <span class="material-symbols-outlined text-slate-400 group-focus-within/field:text-blue-500 transition-colors">mail</span>
            </div>
            <%= f.email_field :email,
                autofocus: true,
                autocomplete: "email",
                placeholder: "name@example.com",
                class: "block w-full h-12 pl-11 pr-4 bg-white dark:bg-slate-950/50 border border-black/5 dark:border-white/10 rounded-2xl shadow-inner dark:shadow-none text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 dark:focus:border-blue-400 dark:focus:shadow-[0_0_15px_rgba(59,130,246,0.4)] transition-all duration-200 text-sm font-medium" %>
          </div>
        </div>

        <!-- Password Field -->
        <div class="group/field">
          <div class="flex justify-between items-center mb-1.5 ml-1">
            <%= f.label :password, "パスワード", class: "block text-xs font-bold text-slate-500 dark:text-slate-400 group-focus-within/field:text-blue-500 dark:group-focus-within/field:text-blue-400 uppercase tracking-wider transition-colors duration-200" %>
            <% if devise_mapping.recoverable? %>
              <%= link_to "忘れた場合", new_password_path(resource_name), class: "text-xs font-bold text-blue-500 hover:text-blue-600 dark:text-blue-400 transition-colors" %>
            <% end %>
          </div>
          <div class="relative transition-all duration-300 transform group-focus-within/field:scale-[1.01]">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none z-10">
              <span class="material-symbols-outlined text-slate-400 group-focus-within/field:text-blue-500 transition-colors">lock</span>
            </div>
            <%= f.password_field :password,
                autocomplete: "current-password",
                placeholder: "パスワード",
                id: "login-password-field",
                class: "block w-full h-12 pl-11 pr-12 bg-white dark:bg-slate-950/50 border border-black/5 dark:border-white/10 rounded-2xl shadow-inner dark:shadow-none text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 dark:focus:border-blue-400 dark:focus:shadow-[0_0_15px_rgba(59,130,246,0.4)] transition-all duration-200 text-sm font-medium" %>

            <!-- パスワード表示切り替えボタン -->
            <button type="button"
                    onclick="togglePasswordVisibility('login-password-field', 'login-password-icon')"
                    class="absolute inset-y-0 right-0 pr-4 flex items-center text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors cursor-pointer focus:outline-none z-10">
              <span class="material-symbols-outlined text-xl" id="login-password-icon">visibility</span>
            </button>
          </div>
          <p class="mt-1 ml-1 text-[10px] text-slate-400 dark:text-slate-500">※6文字以上</p>
        </div>

        <!-- Remember Me & Submit -->
        <div class="pt-2">
          <% if devise_mapping.rememberable? %>
            <div class="flex items-center mb-6">
              <%= f.check_box :remember_me,
                  class: "w-4 h-4 text-blue-600 bg-slate-100 border-slate-300 rounded focus:ring-0 focus:ring-offset-0 focus:outline-none dark:bg-slate-800 dark:border-slate-600 dark:ring-offset-slate-900 cursor-pointer" %>
              <%= f.label :remember_me, "ログイン状態を保持", class: "ml-2 text-sm text-slate-600 dark:text-slate-300 cursor-pointer select-none" %>
            </div>
          <% end %>

          <%= f.button class: "w-full h-12 bg-[radial-gradient(ellipse_110%_110%_at_30%_30%,#60a5fa_15%,#3b82f6_90%)] dark:bg-gradient-to-r dark:from-blue-600 dark:to-cyan-500 hover:scale-105 active:scale-95 text-white font-bold rounded-full shadow-[8px_8px_16px_rgba(59,130,246,0.4),-8px_-8px_16px_rgba(255,255,255,1),inset_-2px_-2px_5px_rgba(30,64,175,0.4),inset_2px_2px_5px_rgba(147,197,253,0.5)] dark:shadow-[0_0_20px_rgba(59,130,246,0.5),inset_0_1px_0_rgba(255,255,255,0.4),inset_0_-2px_5px_rgba(0,0,0,0.3)] dark:hover:shadow-[0_0_30px_rgba(59,130,246,0.7),inset_0_1px_0_rgba(255,255,255,0.6)] transform transition-all duration-200 flex items-center justify-center gap-2 group/btn relative overflow-hidden" do %>
            <span>ログイン</span>
            <span class="material-symbols-outlined text-lg group-hover/btn:translate-x-1 transition-transform">arrow_forward</span>
          <% end %>
        </div>
      <% end %>

      <!-- Divider -->
      <div class="relative my-8">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-slate-200 dark:border-slate-700"></div>
        </div>
        <div class="relative flex justify-center text-xs uppercase">
          <span class="bg-white dark:bg-[#1a1f2e] px-4 text-slate-400 font-medium tracking-wider">or continue with</span>
        </div>
      </div>

      <!-- Google Login Button -->
      <%= link_to user_google_oauth2_omniauth_authorize_path,
          data: { turbo: false },
          class: "w-full h-12 flex items-center justify-center bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-white/10 rounded-full shadow-[6px_6px_12px_rgba(166,175,195,0.4),-6px_-6px_12px_rgba(255,255,255,0.8),inset_-2px_-2px_4px_rgba(166,175,195,0.2),inset_2px_2px_4px_rgba(255,255,255,1)] dark:shadow-[0_0_15px_rgba(255,255,255,0.05),inset_0_1px_0_rgba(255,255,255,0.1),inset_0_0_0_1px_rgba(255,255,255,0.05)] dark:hover:shadow-[0_0_20px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.2)] hover:scale-[1.02] active:scale-95 transition-all duration-200 group/google relative overflow-hidden" do %>
        <div class="absolute inset-0 bg-gradient-to-r from-slate-50 to-white opacity-0 group-hover/google:opacity-100 transition-opacity dark:hidden"></div>
        <svg class="w-5 h-5 mr-3 relative z-10 group-hover/google:scale-110 transition-transform duration-300" viewBox="0 0 48 48">
          <path d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" fill="#FFC107"></path>
          <path d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" fill="#FF3D00"></path>
          <path d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" fill="#4CAF50"></path>
          <path d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C41.38,36.43,44,30.63,44,24C44,22.659,43.862,21.35,43.611,20.083z" fill="#1976D2"></path>
        </svg>
        <span class="text-sm font-bold text-slate-700 dark:text-slate-200 relative z-10">Googleでログイン</span>
      <% end %>

      <!-- ゲストログインボタン -->
      <div class="mt-4">
        <%= button_to users_guest_sign_in_path,
            method: :post,
            data: { turbo: false },
            form: { class: "w-full" },
            class: "w-full h-12 flex items-center justify-center bg-white dark:bg-slate-800/50 border border-slate-200 dark:border-white/10 rounded-full shadow-[6px_6px_12px_rgba(166,175,195,0.4),-6px_-6px_12px_rgba(255,255,255,0.8),inset_-2px_-2px_4px_rgba(166,175,195,0.2),inset_2px_2px_4px_rgba(255,255,255,1)] dark:shadow-[0_0_15px_rgba(255,255,255,0.05),inset_0_1px_0_rgba(255,255,255,0.1),inset_0_0_0_1px_rgba(255,255,255,0.05)] dark:hover:shadow-[0_0_20px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.2)] hover:scale-[1.02] active:scale-95 transition-all duration-200 group/guest relative overflow-hidden" do %>
          <span class="material-symbols-outlined text-xl mr-2 text-slate-700 dark:text-slate-200">account_circle</span>
          <span class="text-sm font-bold text-slate-700 dark:text-slate-200">ゲストログイン</span>
        <% end %>
      </div>

      <!-- Googleログイン警告対策ガイド -->
      <div class="mt-6">
        <%= render "shared/google_auth_guide" %>
      </div>
    </div>

    <!-- 新規登録エリア（強調デザイン） -->
    <% if devise_mapping.registerable? %>
      <div class="mt-8 relative group">
        <div class="absolute -inset-1 bg-gradient-to-r from-green-400 via-emerald-400 to-green-500 rounded-2xl blur-md opacity-40 group-hover:opacity-70 transition duration-500 animate-pulse-slow"></div>
        <div class="relative bg-[radial-gradient(120%_120%_at_50%_50%,rgba(255,255,255,0.95)_0%,rgba(240,253,244,0.8)_100%)] dark:bg-none dark:bg-slate-950/80 rounded-[2rem] p-6 flex flex-col items-center text-center border border-white/60 dark:border-white/10 shadow-[10px_10px_30px_rgba(34,197,94,0.15),-10px_-10px_30px_rgba(255,255,255,0.8),inset_0_0_0_1px_rgba(255,255,255,0.6)] dark:shadow-[0_0_30px_rgba(34,197,94,0.1),inset_0_0_0_1px_rgba(255,255,255,0.1)] hover:scale-[1.02] transition-all duration-300">
          <div class="w-14 h-14 rounded-full bg-gradient-to-br from-green-100 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/20 flex items-center justify-center text-green-600 dark:text-green-400 mb-4 group-hover:scale-110 transition-transform duration-300 shadow-lg">
            <span class="material-symbols-outlined text-2xl">person_add</span>
          </div>
          <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-1">初めてのご利用ですか？</h3>
          <p class="text-xs text-slate-500 dark:text-slate-400 mb-5 leading-relaxed">アカウントを作成して、散歩の記録を始めましょう。</p>

          <%= link_to new_registration_path(resource_name), class: "w-full py-3 bg-[radial-gradient(ellipse_110%_110%_at_30%_30%,#334155_15%,#0f172a_90%)] dark:bg-gradient-to-r dark:from-emerald-600 dark:to-green-500 text-white dark:text-white text-sm font-bold rounded-full shadow-[6px_6px_12px_rgba(15,23,42,0.3),-6px_-6px_12px_rgba(255,255,255,0.5),inset_-2px_-2px_5px_rgba(0,0,0,0.5),inset_2px_2px_5px_rgba(255,255,255,0.2)] dark:shadow-[0_0_20px_rgba(16,185,129,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:hover:shadow-[0_0_30px_rgba(16,185,129,0.6)] hover:scale-105 active:scale-95 transition-all duration-200 flex items-center justify-center gap-2 relative overflow-hidden group/reg" do %>
            <span>新規登録する</span>
            <span class="material-symbols-outlined text-base">arrow_forward</span>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Footer Links -->
    <div class="mt-8 text-center">
      <%= link_to privacy_path, class: "inline-flex items-center gap-1.5 text-xs text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors underline decoration-slate-300 dark:decoration-slate-600 underline-offset-2 hover:decoration-slate-500 dark:hover:decoration-slate-400" do %>
        <span class="material-symbols-outlined text-xs">shield</span>
        <span>プライバシーポリシー</span>
      <% end %>
    </div>
  </div>
</div>

<style>
@keyframes pulse-slow {
  0%, 100% { opacity: 0.3; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.05); }
}
.animate-pulse-slow {
  animation: pulse-slow 4s ease-in-out infinite;
}
</style>

<script>
function togglePasswordVisibility(fieldId, iconId) {
  const field = document.getElementById(fieldId);
  const icon = document.getElementById(iconId);

  if (!field || !icon) return;

  if (field.type === 'password') {
    field.type = 'text';
    icon.textContent = 'visibility_off';
  } else {
    field.type = 'password';
    icon.textContent = 'visibility';
  }
}
</script>
</file>

<file path="app/views/home/landing.html.erb">
<% content_for :title, "てくメモ - 健康管理を楽しく続ける" %>

<!-- LP Wrapper: 全画面オーバーレイ -->
<div class="fixed inset-0 z-40 overflow-y-auto bg-clay-bg dark:bg-gradient-to-b dark:from-slate-900 dark:via-slate-900 dark:to-indigo-950 text-slate-800 dark:text-purple-100 font-display transition-colors duration-300">

  <!-- Main Content with width constraint -->
  <main class="min-h-screen flex flex-col items-center pt-28 pb-20 px-4 max-w-4xl mx-auto" data-controller="landing-modal">

    <!-- Hero Section -->
    <section class="text-center mb-12 animate-fade-in max-w-4xl mx-auto">
      <h1 class="text-5xl md:text-7xl font-black tracking-tight leading-snug text-slate-800 dark:text-transparent dark:bg-clip-text dark:bg-gradient-to-br dark:from-purple-400 dark:via-fuchsia-300 dark:to-cyan-300 drop-shadow-sm">
        続く健康、<br>
        楽しめる記録。
      </h1>

      <!-- Hero Buttons -->
      <div class="flex flex-col sm:flex-row gap-6 justify-center mt-12">
        <!-- Login Button - Light Mode -->
        <%= link_to new_user_session_path, class: "inline-flex dark:hidden px-12 py-4 rounded-full font-bold text-lg text-white hover:scale-105 active:scale-95 transition-all duration-300 items-center justify-center gap-2 min-w-[200px]", style: "background: radial-gradient(ellipse 110% 110% at 30% 30%, #60a5fa 15%, #3b82f6 90%); box-shadow: 12px 12px 28px rgba(59, 130, 246, 0.4), -10px -10px 22px rgba(255, 255, 255, 0.95), inset -3px -3px 8px rgba(30, 64, 175, 0.4), inset 3px 3px 8px rgba(147, 197, 253, 0.5);" do %>
          ログイン
        <% end %>
        <!-- Login Button - Dark Mode -->
        <%= link_to new_user_session_path, class: "hidden dark:!flex relative overflow-hidden px-12 py-4 rounded-full font-bold text-lg hover:scale-105 active:scale-95 transition-all duration-300 items-center justify-center gap-2 min-w-[200px] bg-gradient-to-b from-purple-500/30 to-purple-900/60 border border-purple-400/50 border-t-white/50 shadow-[0_0_30px_rgba(168,85,247,0.5),inset_0_0_0_1px_rgba(255,255,255,0.15),inset_0_1px_0_rgba(255,255,255,0.6)] text-purple-50 hover:bg-purple-800/60 hover:shadow-[0_0_50px_rgba(168,85,247,0.7),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.8)] backdrop-blur-xl before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/30 before:to-transparent before:rounded-t-full before:pointer-events-none before:animate-pulse" do %>
          <span class="relative z-10 drop-shadow-[0_0_10px_rgba(168,85,247,1)]">ログイン</span>
        <% end %>

        <!-- Register Button - Light Mode -->
        <%= link_to new_user_registration_path, class: "inline-flex dark:hidden px-12 py-4 rounded-full font-bold text-lg text-white hover:scale-105 active:scale-95 transition-all duration-300 items-center justify-center gap-2 min-w-[200px]", style: "background: radial-gradient(ellipse 110% 110% at 30% 30%, #fb923c 15%, #f97316 90%); box-shadow: 12px 12px 28px rgba(249, 115, 22, 0.4), -10px -10px 22px rgba(255, 255, 255, 0.95), inset -3px -3px 8px rgba(154, 52, 18, 0.4), inset 3px 3px 8px rgba(253, 186, 116, 0.5);" do %>
          新規登録
        <% end %>
        <!-- Register Button - Dark Mode -->
        <%= link_to new_user_registration_path, class: "hidden dark:!flex relative overflow-hidden px-12 py-4 rounded-full font-bold text-lg hover:scale-105 active:scale-95 transition-all duration-300 items-center justify-center gap-2 min-w-[200px] bg-gradient-to-b from-cyan-500/30 to-cyan-900/60 border border-cyan-400/50 border-t-white/50 shadow-[0_0_30px_rgba(34,211,238,0.5),inset_0_0_0_1px_rgba(255,255,255,0.15),inset_0_1px_0_rgba(255,255,255,0.6)] text-cyan-50 hover:bg-cyan-800/60 hover:shadow-[0_0_50px_rgba(34,211,238,0.7),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.8)] backdrop-blur-xl before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/30 before:to-transparent before:rounded-t-full before:pointer-events-none before:animate-pulse" do %>
          <span class="relative z-10 drop-shadow-[0_0_10px_rgba(34,211,238,1)]">新規登録</span>
        <% end %>
      </div>
    </section>

    <!-- Features Section -->
    <section id="features" class="w-full max-w-6xl mx-auto mb-8">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 md:gap-8 px-4">
        <!-- Feature 1: Walking - Light Mode -->
        <div data-action="click->landing-modal#open"
             data-feature-type="walking"
             class="flex dark:hidden rounded-[2.5rem] p-8 flex-col items-center text-center hover:scale-105 transition-transform duration-300 group h-full justify-center cursor-pointer" style="background: radial-gradient(ellipse 120% 120% at 35% 35%, #ffffff 10%, #d4e9f7 85%); box-shadow: 20px 20px 45px rgba(59, 130, 246, 0.3), -18px -18px 35px rgba(255, 255, 255, 0.95), inset -5px -5px 15px rgba(80, 130, 200, 0.3), inset 5px 5px 15px rgba(255, 255, 255, 0.7);">
          <span class="material-symbols-outlined text-[120px] text-blue-500 mb-8 group-hover:animate-bounce-slow drop-shadow-lg">directions_walk</span>
          <h3 class="text-xl font-bold mb-3 text-slate-800">ウォーキング</h3>
          <p class="text-sm text-slate-500 font-medium">歩くを楽しむ記録</p>
        </div>
        <!-- Feature 1: Walking - Dark Mode -->
        <div data-action="click->landing-modal#open"
             data-feature-type="walking"
             class="hidden dark:!flex relative overflow-hidden rounded-[2.5rem] p-8 flex-col items-center text-center hover:scale-105 transition-transform duration-300 group h-full justify-center bg-gradient-to-br from-slate-800/50 to-slate-950/80 backdrop-blur-xl border border-white/10 border-t-white/40 shadow-[0_0_30px_rgba(168,85,247,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3),inset_0_-20px_30px_-10px_rgba(168,85,247,0.3)] hover:bg-slate-800/60 hover:shadow-[0_0_60px_rgba(168,85,247,0.5),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5),inset_0_-20px_50px_-10px_rgba(168,85,247,0.6)] before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:rounded-t-[2.5rem] before:pointer-events-none before:animate-pulse cursor-pointer">
          <span class="relative z-10 material-symbols-outlined text-[120px] mb-8 group-hover:animate-bounce-slow drop-shadow-lg text-transparent bg-clip-text bg-gradient-to-br from-purple-400 to-blue-400 drop-shadow-[0_0_35px_rgba(168,85,247,0.8)]">directions_walk</span>
          <h3 class="relative z-10 text-xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-purple-200 to-blue-200 drop-shadow-[0_0_15px_rgba(168,85,247,0.6)]">ウォーキング</h3>
          <p class="relative z-10 text-sm text-blue-200/70 font-medium drop-shadow-[0_0_5px_rgba(168,85,247,0.3)]">歩くを楽しむ記録</p>
        </div>

        <!-- Feature 2: SNS Share - Light Mode -->
        <div data-action="click->landing-modal#open"
             data-feature-type="share"
             class="flex dark:hidden rounded-[2.5rem] p-8 flex-col items-center text-center hover:scale-105 transition-transform duration-300 group h-full justify-center cursor-pointer" style="background: radial-gradient(ellipse 120% 120% at 35% 35%, #ffffff 30%, #ffedd5 90%); box-shadow: 20px 20px 45px rgba(249, 115, 22, 0.3), -18px -18px 35px rgba(255, 255, 255, 0.95), inset -5px -5px 15px rgba(200, 100, 50, 0.3), inset 5px 5px 15px rgba(255, 255, 255, 0.7);">
          <span class="material-symbols-outlined text-[120px] text-orange-500 mb-8 group-hover:animate-bounce-slow drop-shadow-lg">ios_share</span>
          <h3 class="text-xl font-bold mb-3 text-slate-800">SNSシェア</h3>
          <p class="text-sm text-slate-500 font-medium">記録を美しくシェア</p>
        </div>
        <!-- Feature 2: SNS Share - Dark Mode -->
        <div data-action="click->landing-modal#open"
             data-feature-type="share"
             class="hidden dark:!flex relative overflow-hidden rounded-[2.5rem] p-8 flex-col items-center text-center hover:scale-105 transition-transform duration-300 group h-full justify-center bg-gradient-to-br from-slate-800/50 to-slate-950/80 backdrop-blur-xl border border-white/10 border-t-white/40 shadow-[0_0_30px_rgba(236,72,153,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3),inset_0_-20px_30px_-10px_rgba(236,72,153,0.3)] hover:bg-slate-800/60 hover:shadow-[0_0_60px_rgba(236,72,153,0.5),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5),inset_0_-20px_50px_-10px_rgba(236,72,153,0.6)] before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:rounded-t-[2.5rem] before:pointer-events-none before:animate-pulse cursor-pointer">
          <span class="relative z-10 material-symbols-outlined text-[120px] mb-8 group-hover:animate-bounce-slow drop-shadow-lg text-transparent bg-clip-text bg-gradient-to-br from-pink-400 to-orange-400 drop-shadow-[0_0_35px_rgba(236,72,153,0.8)]">ios_share</span>
          <h3 class="relative z-10 text-xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-pink-200 to-orange-200 drop-shadow-[0_0_15px_rgba(236,72,153,0.6)]">SNSシェア</h3>
          <p class="relative z-10 text-sm text-pink-200/70 font-medium drop-shadow-[0_0_5px_rgba(236,72,153,0.3)]">記録を美しくシェア</p>
        </div>

        <!-- Feature 3: Ranking - Light Mode -->
        <div data-action="click->landing-modal#open"
             data-feature-type="ranking"
             class="flex dark:hidden rounded-[2.5rem] p-8 flex-col items-center text-center hover:scale-105 transition-transform duration-300 group h-full justify-center cursor-pointer" style="background: radial-gradient(ellipse 120% 120% at 35% 35%, #ffffff 10%, #ead9f3 85%); box-shadow: 20px 20px 45px rgba(168, 85, 247, 0.3), -18px -18px 35px rgba(255, 255, 255, 0.95), inset -5px -5px 15px rgba(130, 80, 160, 0.3), inset 5px 5px 15px rgba(255, 255, 255, 0.7);">
          <span class="material-symbols-outlined text-[120px] text-indigo-600 mb-8 group-hover:animate-bounce-slow drop-shadow-lg">emoji_events</span>
          <h3 class="text-xl font-bold mb-3 text-slate-800">ランキング</h3>
          <p class="text-sm text-slate-500 font-medium">仲間と競い合う</p>
        </div>
        <!-- Feature 3: Ranking - Dark Mode -->
        <div data-action="click->landing-modal#open"
             data-feature-type="ranking"
             class="hidden dark:!flex relative overflow-hidden rounded-[2.5rem] p-8 flex-col items-center text-center hover:scale-105 transition-transform duration-300 group h-full justify-center bg-gradient-to-br from-slate-800/50 to-slate-950/80 backdrop-blur-xl border border-white/10 border-t-white/40 shadow-[0_0_30px_rgba(34,211,238,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3),inset_0_-20px_30px_-10px_rgba(34,211,238,0.3)] hover:bg-slate-800/60 hover:shadow-[0_0_60px_rgba(34,211,238,0.5),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5),inset_0_-20px_50px_-10px_rgba(34,211,238,0.6)] before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:rounded-t-[2.5rem] before:pointer-events-none before:animate-pulse cursor-pointer">
          <span class="relative z-10 material-symbols-outlined text-[120px] mb-8 group-hover:animate-bounce-slow drop-shadow-lg text-transparent bg-clip-text bg-gradient-to-br from-cyan-400 to-blue-400 drop-shadow-[0_0_35px_rgba(34,211,238,0.8)]">emoji_events</span>
          <h3 class="relative z-10 text-xl font-bold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-cyan-200 to-blue-200 drop-shadow-[0_0_15px_rgba(34,211,238,0.6)]">ランキング</h3>
          <p class="relative z-10 text-sm text-cyan-200/70 font-medium drop-shadow-[0_0_5px_rgba(34,211,238,0.3)]">仲間と競い合う</p>
        </div>
      </div>
    </section>

    <!-- Closing Section -->
    <section class="text-center py-16 animate-fade-in-up delay-300">
      <h2 class="text-3xl font-bold mb-6 text-slate-800 dark:text-transparent dark:bg-clip-text dark:bg-gradient-to-r dark:from-pink-300 dark:via-purple-300 dark:to-indigo-300 dark:drop-shadow-[0_0_10px_rgba(168,85,247,0.5)]">今すぐ健康管理を始めよう</h2>
      <p class="text-xl text-slate-600 dark:text-transparent dark:bg-clip-text dark:bg-gradient-to-r dark:from-purple-200 dark:to-blue-200 dark:drop-shadow-[0_0_5px_rgba(168,85,247,0.3)] mb-10">歩数記録で、毎日の健康を楽しく続けられます</p>

      <!-- Closing Button - Light Mode -->
      <%= link_to new_user_registration_path, class: "inline-block dark:hidden w-full max-w-md px-16 py-6 rounded-full font-bold text-2xl text-white hover:scale-105 active:scale-95 transition-all duration-300", style: "background: radial-gradient(ellipse 110% 110% at 30% 30%, #fb923c 15%, #f97316 90%); box-shadow: 14px 14px 32px rgba(249, 115, 22, 0.4), -12px -12px 26px rgba(255, 255, 255, 1), inset -4px -4px 10px rgba(154, 52, 18, 0.4), inset 4px 4px 10px rgba(253, 186, 116, 0.5);" do %>
        今すぐ始める
      <% end %>
      <!-- Closing Button - Dark Mode -->
      <%= link_to new_user_registration_path, class: "hidden dark:!inline-block relative overflow-hidden w-full max-w-md px-16 py-6 rounded-full font-bold text-2xl hover:scale-105 active:scale-95 transition-all duration-300 bg-gradient-to-r from-cyan-500/30 to-cyan-900/60 border border-cyan-400/50 border-t-white/50 shadow-[0_0_50px_rgba(34,211,238,0.5),inset_0_0_0_1px_rgba(255,255,255,0.15),inset_0_1px_0_rgba(255,255,255,0.6)] text-cyan-50 hover:bg-gradient-to-r hover:from-cyan-400/40 hover:to-cyan-800/60 hover:shadow-[0_0_80px_rgba(34,211,238,0.8),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.8)] backdrop-blur-xl before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/30 before:to-transparent before:rounded-t-full before:pointer-events-none before:animate-pulse" do %>
        <span class="relative z-10 drop-shadow-[0_0_10px_rgba(34,211,238,1)]">今すぐ始める</span>
      <% end %>
    </section>

    </section>

    <!-- Modal Template -->
    <div data-landing-modal-target="modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
      <!-- Backdrop -->
      <div data-action="click->landing-modal#close" class="absolute inset-0 bg-slate-900/60 dark:bg-black/80 backdrop-blur-sm transition-opacity"></div>

      <!-- Modal Content -->
      <div class="relative w-full max-w-lg transform transition-all scale-100">
        <!-- Light Mode Card Style -->
        <div class="dark:hidden bg-white rounded-[2.5rem] p-8 text-center relative overflow-hidden" style="box-shadow: 20px 20px 60px rgba(0,0,0,0.1), -20px -20px 60px rgba(255,255,255,0.9);">
          <button data-action="click->landing-modal#close" class="absolute top-4 right-4 p-2 rounded-full hover:bg-slate-100 transition-colors z-20">
            <span class="material-symbols-outlined text-slate-400">close</span>
          </button>

          <!-- Walking Content -->
          <div data-landing-modal-target="content" data-feature-type="walking" class="hidden">
            <div class="mb-6 flex justify-center items-center h-40">
              <div class="relative w-32 h-32">
                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                  <circle cx="50" cy="50" r="45" stroke="#e2e8f0" stroke-width="8" fill="transparent" />
                  <circle cx="50" cy="50" r="45" stroke="#3b82f6" stroke-width="8" fill="transparent" stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" class="animate-[dash_1.5s_ease-out_forwards]" />
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-700">
                  <span data-landing-modal-target="count" data-count-to="8500" class="text-2xl font-bold">0</span>
                  <span class="text-xs text-slate-500">steps</span>
                </div>
              </div>
            </div>
            <h3 class="text-2xl font-bold text-slate-800 mb-4">ウォーキング</h3>
            <p class="text-slate-600 leading-relaxed">毎日の歩数と消費カロリーを自動で記録。<br>目標達成に向けて楽しく歩きましょう。</p>
          </div>

          <!-- Share Content -->
          <div data-landing-modal-target="content" data-feature-type="share" class="hidden">
            <div class="mb-6 flex justify-center items-center h-40 relative">
              <div class="relative w-48 h-28 bg-gradient-to-br from-orange-100 to-orange-50 rounded-xl shadow-lg border-2 border-white flex items-center justify-center overflow-hidden group z-10">
                <div class="absolute inset-0 bg-white/30 animate-[shimmer_2s_infinite]"></div>
                <div class="flex items-center space-x-2 z-10">
                  <span class="material-symbols-outlined text-4xl text-orange-500">directions_walk</span>
                  <div class="text-left">
                    <div class="w-16 h-2 bg-orange-200 rounded mb-1"></div>
                    <div class="w-10 h-2 bg-orange-200 rounded"></div>
                  </div>
                </div>
                <div class="absolute bottom-2 right-2 bg-white/80 p-1 rounded-full shadow-sm">
                   <span class="material-symbols-outlined text-orange-400 text-sm">ios_share</span>
                </div>
              </div>
              <!-- Floating Hearts -->
              <span class="material-symbols-outlined absolute text-pink-500 animate-float-up text-3xl z-0" style="top: 10%; left: 50%; margin-left: -110px; animation-delay: 0.5s;">favorite</span>
              <span class="material-symbols-outlined absolute text-pink-400 animate-float-up text-3xl z-0" style="bottom: 15%; left: 50%; margin-left: 90px; animation-delay: 1.2s;">favorite</span>
              <span class="material-symbols-outlined absolute text-pink-500 animate-float-up text-4xl z-0" style="top: 0%; left: 50%; margin-left: 80px; animation-delay: 2.0s;">favorite</span>
            </div>
            <h3 class="text-2xl font-bold text-slate-800 mb-4">SNSシェア</h3>
            <p class="text-slate-600 leading-relaxed">あなたの頑張りを美しいカードでシェア。<br>あなただけのオリジナルカードで、共有がもっと楽しく。</p>
          </div>

          <!-- Ranking Content -->
          <div data-landing-modal-target="content" data-feature-type="ranking" class="hidden">
            <div class="mb-6 flex justify-center items-end h-40 space-x-4 pb-4">
              <div class="w-8 bg-indigo-200 rounded-t-lg h-0 animate-grow-h-16"></div>
              <div class="w-8 bg-indigo-500 rounded-t-lg h-0 animate-grow-h-24 relative">
                <span class="absolute -top-6 left-1/2 -translate-x-1/2 text-indigo-600 font-bold animate-pop-in" style="animation-delay: 1.6s;">1st</span>
              </div>
              <div class="w-8 bg-indigo-200 rounded-t-lg h-0 animate-grow-h-12"></div>
            </div>
            <h3 class="text-2xl font-bold text-slate-800 mb-4">ランキング</h3>
            <p class="text-slate-600 leading-relaxed">全ユーザーと歩数を競争。<br>上位を目指してモチベーションを維持しましょう。</p>
          </div>

          <div class="mt-8">
             <%= link_to new_user_registration_path, class: "inline-block px-8 py-3 rounded-full font-bold text-white hover:scale-105 active:scale-95 transition-all duration-300 shadow-lg hover:shadow-xl", style: "background: linear-gradient(135deg, #3b82f6, #8b5cf6);" do %>
               はじめる
             <% end %>
          </div>
        </div>

        <!-- Dark Mode Card Style -->
        <div class="hidden dark:block bg-slate-900/90 backdrop-blur-xl rounded-[2.5rem] p-8 text-center relative overflow-hidden border border-white/10 shadow-[0_0_50px_rgba(168,85,247,0.3)]">
          <!-- Glow effects -->
          <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-32 bg-purple-500/20 rounded-full blur-3xl pointer-events-none"></div>

          <button data-action="click->landing-modal#close" class="absolute top-4 right-4 p-2 rounded-full hover:bg-white/10 transition-colors z-20">
            <span class="material-symbols-outlined text-slate-400">close</span>
          </button>

          <!-- Walking Content (Dark) -->
          <div data-landing-modal-target="content" data-feature-type="walking" class="hidden">
            <div class="mb-6 flex justify-center items-center h-40">
              <div class="relative w-32 h-32">
                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                  <circle cx="50" cy="50" r="45" stroke="#334155" stroke-width="8" fill="transparent" />
                  <circle cx="50" cy="50" r="45" stroke="url(#gradient-walking)" stroke-width="8" fill="transparent" stroke-dasharray="283" stroke-dashoffset="283" stroke-linecap="round" class="animate-[dash_1.5s_ease-out_forwards]" />
                  <defs>
                    <linearGradient id="gradient-walking" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" stop-color="#c084fc" />
                      <stop offset="100%" stop-color="#60a5fa" />
                    </linearGradient>
                  </defs>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center text-white">
                  <span data-landing-modal-target="count" data-count-to="8500" class="text-2xl font-bold drop-shadow-[0_0_10px_rgba(168,85,247,0.8)]">0</span>
                  <span class="text-xs text-slate-400">steps</span>
                </div>
              </div>
            </div>
            <h3 class="relative z-10 text-2xl font-bold text-white mb-4 drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">ウォーキング</h3>
            <p class="relative z-10 text-slate-300 leading-relaxed">毎日の歩数と消費カロリーを自動で記録。<br>目標達成に向けて楽しく歩きましょう。</p>
          </div>

          <!-- Share Content (Dark) -->
          <div data-landing-modal-target="content" data-feature-type="share" class="hidden">
            <div class="mb-6 flex justify-center items-center h-40 relative">
              <div class="relative w-48 h-28 bg-slate-800/80 rounded-xl border border-white/20 flex items-center justify-center overflow-hidden shadow-[0_0_20px_rgba(236,72,153,0.3)] z-10">
                <div class="absolute inset-0 bg-gradient-to-br from-pink-500/20 to-orange-500/20"></div>
                <!-- 光の走るエフェクト -->
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -skew-x-12 animate-[shimmer_2s_infinite]"></div>

                <div class="flex items-center space-x-2 z-10">
                  <span class="material-symbols-outlined text-4xl text-transparent bg-clip-text bg-gradient-to-br from-pink-400 to-orange-400">directions_walk</span>
                  <div class="text-left">
                    <div class="w-16 h-2 bg-slate-600 rounded mb-1"></div>
                    <div class="w-10 h-2 bg-slate-600 rounded"></div>
                  </div>
                </div>
              </div>
              <!-- Floating Hearts (Dark) -->
              <span class="material-symbols-outlined absolute text-pink-500 animate-float-up text-3xl drop-shadow-[0_0_5px_rgba(236,72,153,0.8)] z-0" style="top: 10%; left: 50%; margin-left: -110px; animation-delay: 0.5s;">favorite</span>
              <span class="material-symbols-outlined absolute text-pink-400 animate-float-up text-3xl drop-shadow-[0_0_5px_rgba(236,72,153,0.8)] z-0" style="bottom: 15%; left: 50%; margin-left: 90px; animation-delay: 1.2s;">favorite</span>
              <span class="material-symbols-outlined absolute text-pink-500 animate-float-up text-4xl drop-shadow-[0_0_5px_rgba(236,72,153,0.8)] z-0" style="top: 0%; left: 50%; margin-left: 80px; animation-delay: 2.0s;">favorite</span>
            </div>
            <h3 class="relative z-10 text-2xl font-bold text-white mb-4 drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">SNSシェア</h3>
            <p class="relative z-10 text-slate-300 leading-relaxed">あなたの頑張りを美しいカードでシェア。<br>あなただけのオリジナルカードで、共有がもっと楽しく。</p>
          </div>

          <!-- Ranking Content (Dark) -->
          <div data-landing-modal-target="content" data-feature-type="ranking" class="hidden">
            <div class="mb-6 flex justify-center items-end h-40 space-x-4 pb-4">
              <div class="w-8 bg-slate-700 rounded-t-lg h-0 animate-grow-h-16"></div>
              <div class="w-8 bg-gradient-to-t from-cyan-600 to-blue-500 rounded-t-lg h-0 animate-grow-h-24 relative shadow-[0_0_20px_rgba(6,182,212,0.5)]">
                <span class="absolute -top-6 left-1/2 -translate-x-1/2 text-cyan-300 font-bold drop-shadow-[0_0_5px_rgba(6,182,212,0.8)] animate-pop-in" style="animation-delay: 1.6s;">1st</span>
              </div>
              <div class="w-8 bg-slate-700 rounded-t-lg h-0 animate-grow-h-12"></div>
            </div>
            <h3 class="relative z-10 text-2xl font-bold text-white mb-4 drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">ランキング</h3>
            <p class="relative z-10 text-slate-300 leading-relaxed">全ユーザーと歩数を競争。<br>上位を目指してモチベーションを維持しましょう。</p>
          </div>

          <div class="mt-8 relative z-10">
             <%= link_to new_user_registration_path, class: "inline-block px-8 py-3 rounded-full font-bold text-white hover:scale-105 active:scale-95 transition-all duration-300 bg-gradient-to-r from-cyan-500 to-blue-500 shadow-[0_0_20px_rgba(6,182,212,0.4)] hover:shadow-[0_0_30px_rgba(6,182,212,0.6)]" do %>
               はじめる
             <% end %>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="text-center py-8 text-slate-400 dark:text-slate-600 text-sm">
    &copy; <%= Time.current.year %> Tekumemo. All rights reserved.
  </footer>
</div>
</file>

<file path="app/views/users/_pwa_settings.html.erb">
<!-- アプリ設定セクション（PWAインストール） -->
<div class="mb-8 p-6 bg-white/60 dark:bg-slate-900/40 backdrop-blur-xl rounded-3xl border-l-4 border-t-4 border-l-white border-t-white border-r border-b border-r-purple-100 border-b-purple-100 dark:border-white/10 shadow-[8px_8px_20px_rgba(168,85,247,0.1),-8px_-8px_20px_rgba(255,255,255,0.8)] dark:shadow-[0_0_30px_rgba(168,85,247,0.15),inset_0_1px_0_rgba(255,255,255,0.1)] relative overflow-hidden group" data-controller="pwa-settings">

  <!-- Decorative Elements -->
  <div class="absolute top-0 right-0 w-32 h-32 bg-purple-400/10 dark:bg-purple-500/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
  <div class="absolute bottom-0 left-0 w-24 h-24 bg-blue-400/10 dark:bg-blue-500/10 rounded-full blur-2xl -ml-8 -mb-8 pointer-events-none"></div>

  <div class="relative z-10 flex flex-col sm:flex-row items-center justify-between gap-4">
    <div class="flex items-center space-x-4 w-full sm:w-auto">
      <div class="relative">
        <div class="absolute inset-0 bg-purple-400 blur-md opacity-20 dark:opacity-40 rounded-full"></div>
        <div class="relative bg-gradient-to-br from-white to-purple-50 dark:from-slate-800 dark:to-slate-700 p-3 rounded-2xl shadow-sm border border-white/50 dark:border-white/10">
          <span class="material-symbols-outlined text-2xl text-transparent bg-clip-text bg-gradient-to-br from-purple-500 to-pink-500 dark:from-purple-400 dark:to-pink-400">install_mobile</span>
        </div>
      </div>
      <div>
        <span class="inline-block px-2 py-0.5 mb-1 text-[10px] font-bold text-purple-600 dark:text-purple-300 bg-purple-100 dark:bg-purple-900/50 rounded-full border border-purple-200 dark:border-purple-700/50">推奨</span>
        <h3 class="text-base font-bold text-gray-800 dark:text-white">
          アプリをインストール
        </h3>
        <p class="text-xs text-gray-500 dark:text-slate-400 mt-0.5">ホーム画面に追加して、より快適に利用できます</p>
      </div>
    </div>

    <div class="w-full sm:w-auto flex justify-center sm:justify-end">
      <% if current_user.guest? %>
        <!-- ゲスト用（ロック表示） -->
        <div class="flex flex-col items-center sm:items-end">
          <button type="button" disabled class="w-full sm:w-auto bg-gray-100 dark:bg-slate-800 text-gray-400 dark:text-slate-500 font-bold py-2.5 px-6 rounded-full cursor-not-allowed text-sm flex items-center justify-center border border-gray-200 dark:border-white/10">
            <span class="material-symbols-outlined mr-1.5 text-lg">lock</span>
            正式アカウント限定機能
          </button>
          <span class="text-[10px] text-gray-400 dark:text-slate-500 mt-1">※データ保護のため</span>
        </div>
      <% else %>
        <!-- 通常用 -->
        <button type="button" data-pwa-settings-target="installButton" data-action="click->pwa-settings#install" class="w-full sm:w-auto bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-2.5 px-6 rounded-full shadow-[0_4px_15px_rgba(168,85,247,0.4)] hover:shadow-[0_6px_20px_rgba(168,85,247,0.6)] hover:-translate-y-0.5 active:scale-95 transition-all duration-300 text-sm flex items-center justify-center group/btn">
          <span class="material-symbols-outlined mr-1.5 text-lg group-hover/btn:animate-bounce">download</span>
          インストール
        </button>
      <% end %>
    </div>
  </div>

  <!-- iOS用インストールガイドモーダル -->
  <div data-pwa-settings-target="iosGuideModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center px-4">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md transition-opacity" data-action="click->pwa-settings#closeIOSGuide"></div>
    <div class="modal-content bg-white/90 dark:bg-slate-900/90 backdrop-blur-2xl rounded-[2rem] p-8 w-full max-w-sm relative z-10 shadow-[0_20px_50px_rgba(0,0,0,0.3)] border border-white/50 dark:border-white/10 transform transition-all duration-300 scale-95 opacity-0 ring-1 ring-white/20">
      <button type="button" data-action="click->pwa-settings#closeIOSGuide" class="absolute top-4 right-4 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
        <span class="material-symbols-outlined">close</span>
      </button>

      <div class="text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-purple-50 dark:bg-purple-900/30 mb-6 relative">
          <div class="absolute inset-0 bg-purple-400 blur-xl opacity-20 rounded-full"></div>
          <span class="material-symbols-outlined text-3xl text-purple-500 dark:text-purple-400 relative z-10">add_to_home_screen</span>
        </div>

        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">ホーム画面に追加</h3>
        <p class="text-sm text-gray-600 dark:text-slate-300 mb-8 leading-relaxed">
          Safariのメニューから<br>
          <span class="font-bold text-gray-800 dark:text-white">「ホーム画面に追加」</span>を選択してください。
        </p>

        <div class="flex flex-col gap-3 text-sm text-left">
          <div class="flex items-center gap-4 p-4 bg-gray-50/80 dark:bg-slate-800/50 rounded-2xl border border-gray-100 dark:border-white/5">
            <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-blue-100 dark:bg-blue-900/30 rounded-full text-blue-600 dark:text-blue-400 font-bold">1</div>
            <div class="flex-1">
              <p class="text-xs text-gray-500 dark:text-slate-400 mb-0.5">画面下部の</p>
              <div class="flex items-center font-bold text-gray-700 dark:text-slate-200">
                <span class="material-symbols-outlined text-blue-500 mr-1">ios_share</span>
                共有ボタン
                <span class="text-xs font-normal text-gray-500 ml-1">をタップ</span>
              </div>
            </div>
          </div>

          <div class="flex justify-center">
            <span class="material-symbols-outlined text-gray-300 dark:text-slate-600">arrow_downward</span>
          </div>

          <div class="flex items-center gap-4 p-4 bg-gray-50/80 dark:bg-slate-800/50 rounded-2xl border border-gray-100 dark:border-white/5">
            <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-gray-200 dark:bg-slate-700 rounded-full text-gray-600 dark:text-slate-300 font-bold">2</div>
            <div class="flex-1">
              <p class="text-xs text-gray-500 dark:text-slate-400 mb-0.5">メニュー内の</p>
              <div class="flex items-center font-bold text-gray-700 dark:text-slate-200">
                <span class="material-symbols-outlined text-gray-600 dark:text-gray-300 mr-1">add_box</span>
                ホーム画面に追加
                <span class="text-xs font-normal text-gray-500 ml-1">を選択</span>
              </div>
            </div>
          </div>
        </div>

        <button type="button" data-action="click->pwa-settings#closeIOSGuide" class="mt-8 w-full bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-bold py-3.5 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
          閉じる
        </button>
      </div>
    </div>
  </div>
</div>
</file>

<file path="spec/system/admin_users_spec.rb">
require 'rails_helper'

RSpec.describe "Admin::Users", type: :system do
  let!(:admin_user) { create(:user, :admin) }
  let!(:general_user) { create(:user, :general) }

  describe "管理者権限の制御" do
    context "一般ユーザーとしてログインしている場合" do
      before do
        sign_in general_user
      end

      it "管理画面にアクセスできず、トップページにリダイレクトされる" do
        visit admin_users_path
        expect(current_path).to eq root_path
        expect(page).to have_content "管理者権限が必要です"
      end
    end

    context "管理者としてログインしている場合" do
      before do
        sign_in admin_user
      end

      it "管理画面（ユーザー一覧）にアクセスできる" do
        visit admin_users_path
        expect(current_path).to eq admin_users_path
        expect(page).to have_content "ユーザー管理"
        expect(page).to have_content general_user.name
      end
    end
  end

  describe "ユーザー削除機能" do
    before do
      sign_in admin_user
      visit admin_users_path
    end


    # 注意: このテストは非常に重く、Docker環境では150秒以上かかることがあります
    # リソース不足の環境ではタイムアウトする可能性があるため、一時的にpending
    # TODO: CI環境またはリソースに余裕のある環境でのみ実行するように修正する
    it "一般ユーザーを削除できる", js: true do
      # ページにユーザーが表示されていることを確認（メールアドレスで特定）
      expect(page).to have_content general_user.email

      # ページの読み込みを確実に待つ（メールアドレスで特定）
      expect(page).to have_selector('tr', text: general_user.email, wait: 10)

      # 削除対象のユーザーの行を見つける（メールアドレスで特定して曖昧さを回避）
      user_row = find('tr', text: general_user.email)

      # 削除ボタンをクリックして確認ダイアログを承認
      within(user_row) do
        page.accept_confirm do
          click_button "削除"
        end
      end

      # 削除成功メッセージの表示を待つ
      expect(page).to have_content "ユーザー「#{general_user.name}」を削除しました", wait: 10
      expect(page).not_to have_content general_user.email
    end
  end
end
</file>

<file path="spec/system/guest_admin_dashboard_spec.rb">
require 'rails_helper'

RSpec.describe 'Guest Admin Dashboard', type: :system do
  before do
    allow(Cloudinary::Uploader).to receive(:destroy).and_return({ "result" => "ok" })
    Reaction.delete_all
    Notification.delete_all
    UserAchievement.delete_all
    Post.delete_all
    Walk.delete_all
    User.delete_all
  end

  context 'as a guest user', js: true do
    it 'can access dashboard but sees restricted view' do
      # Fallback guest login (simplest)
      visit new_user_session_path
      click_button 'ゲストログイン'

      expect(page).to have_content 'ゲストモードとしてログインしました。'

      visit root_path
      # FABを展開
      find('button[data-expandable-fab-target="mainButton"]').click
      # 管理者メニューボタンをクリック
      click_link '管理者メニュー'

      # Should be allowed (no redirect to root)
      expect(page).to have_current_path(admin_root_path)
      expect(page).to have_content '管理者ダッシュボード'

      # Check for Overlay
      expect(page).to have_content 'ゲスト閲覧モード（保護中）'

      # Check for Dummy Data
      expect(page).to have_content 'ダミーユーザー1'
      expect(page).to have_content 'これはダミーの投稿です'

      # Check Global Stats (Real but mocked/empty)
      # Since no real posts, total posts should be 0 (or whatever logic)
      # Actually controller logic sets @total_posts = 9876 for guest!
      expect(page).to have_content '9876'
    end

    it 'cannot access other admin pages' do
      visit new_user_session_path
      click_button 'ゲストログイン'

      visit admin_users_path

      # Should redirect to root with alert
      expect(page).to have_current_path(root_path)
      expect(page).to have_content '管理者権限が必要です。'
    end
  end
end
</file>

<file path="spec/system/guest_google_fit_spec.rb">
require 'rails_helper'

RSpec.describe 'Guest Google Fit Simulation', type: :system do
  before do
    allow(Cloudinary::Uploader).to receive(:destroy).and_return({ "result" => "ok" })
    Reaction.delete_all
    Notification.delete_all
    UserAchievement.delete_all
    Post.delete_all
    Walk.delete_all
    User.delete_all
  end

  context 'as a guest user', js: true do
    it 'simulates Google Fit connection and data' do
      # ゲストログイン
      visit new_user_session_path
      click_button 'ゲストログイン'
      expect(page).to have_content 'ゲストモードとしてログインしました。'

      # 設定画面などで連携状態が「連携済み」になっているか確認したいが
      # UI上の場所が不明確なので、まずはAPI/Controllerの挙動を直接検証する方が確実だが
      # System SpecなのでUIを通したい。

      # Google Fitデータ取得APIを叩いてみる (JSfetch等で呼ばれる想定だが直接アクセス)
      # または、Walks/Stats画面でグラフが表示されるか...

      # ひとまず、ルートパス（ダッシュボード）にはGoogle Fitデータは出ない？
      # Stats画面があればそこへ。

      # Userモデルの挙動確認 (System Spec内でモデルを直接触るのはグレーだが確認のため)
      guest = User.order(:created_at).last
      expect(guest.role).to eq 'guest'
      expect(guest.google_token_valid?).to be true

      # GoogleFitServiceの挙動確認
      service = GoogleFitService.new(guest)
      data = service.fetch_activities(Date.today, Date.today)
      expect(data).not_to be_empty
      expect(data[:data][Date.today][:steps]).to be > 0
    end

    it 'api endpoint returns dummy data' do
      # ゲストログイン
      visit new_user_session_path
      click_button 'ゲストログイン'

      # APIエンドポイントへのアクセス（System Specではpage.driver.getなどでリクエストを送れる場合もあるが）
      # ここでは visit で JSON が返るか確認（ブラウザで表示）
      visit google_fit_daily_data_path(date: Date.today)

      # JSONレスポンスの検証
      # "steps": ... が含まれているはず
      expect(page.body).to include('steps')
      expect(page.body).to include('distance')
    end
  end
end
</file>

<file path="spec/system/guest_mode_enhancement_spec.rb">
require 'rails_helper'

RSpec.describe 'Guest Mode Enhancements', type: :system do
  before do
    allow(Cloudinary::Uploader).to receive(:destroy).and_return({ "result" => "ok" })
    # Google Fit Serviceのダミー化
    allow_any_instance_of(GoogleFitService).to receive(:fetch_activities).and_return({})

    # 既存データのクリーンアップ（依存関係順に削除）
    Reaction.delete_all
    Notification.delete_all
    UserAchievement.delete_all
    Post.delete_all
    Walk.delete_all
    User.delete_all

    # 一般ユーザー作成（ランキング比較用）
    @general_user = User.create!(
      email: 'general@example.com',
      password: 'password',
      name: 'General User',
      role: :general,
      avatar_type: :default
    )
    # 距離データを紐付け（ランキング入りさせる）
    Walk.create!(user: @general_user, walked_on: Date.today, distance: 10.0, steps: 10000, duration: 60)

    # ゲストユーザー作成（ヘルパー経由だとDBロック怖いので直接作成）
    @guest_user = User.create!(
      email: "guest_test_#{Time.now.to_i}@example.com",
      password: 'password',
      name: 'Guest User',
      role: :guest,
      avatar_type: :default
    )
    Walk.create!(user: @guest_user, walked_on: Date.today, distance: 5.0, steps: 5000, duration: 30)
  end

  context 'Posts Timeline' do
    it 'allows guest to view timeline but hides post form' do
      sign_in @guest_user
      visit posts_path

      expect(page).to have_content('みんな')
      expect(page).to have_content('ゲストモード中は投稿できません')
      expect(page).not_to have_selector('div[data-modal-dialog-id-value="new_post_modal"]') # モーダルトリガーの正規ID
    end

    it 'prevents guest from reacting' do
      # 投稿を作成
      post = Post.create!(user: @general_user, body: 'Test Post')
      sign_in @guest_user
      visit posts_path

      # リアクションボタンは表示されていても、コントローラーでブロックされる
      # ここではボタンを押すとエラーメッセージ（Alert）が出るか、または何も起きないことを確認したいが、
      # JS依存の動作なので、System Specでは「エラーにならない（クラッシュしない）」ことを最低限確認
      # 理想的には「ゲストユーザーはリアクションできません」のフラッシュメッセージを確認

      # 簡略化して、ページ遷移が正常に行われることだけ確認
      expect(page).to have_content('Test Post')
    end
  end

  context 'Account Settings' do
    it 'hides restricted features for guest' do
      sign_in @guest_user
      visit edit_user_registration_path

      # Google Fit連携ボタンがないこと
      expect(page).not_to have_content('Google連携')
      expect(page).not_to have_button('連携する')

      # アバター編集ボタン（カメラアイコン）がないこと
      expect(page).not_to have_selector('button[title="アバターを変更"]')
    end
  end

  context 'Rankings Visibility' do
    it 'general user does NOT see guest in ranking' do
      sign_in @general_user
      visit rankings_path

      # 自分の名前はある
      expect(page).to have_content('General User')
      # ゲストの名前はない
      expect(page).not_to have_content('Guest User')
    end

    it 'guest user SEES themselves in ranking' do
      sign_in @guest_user
      visit rankings_path

      # 一般ユーザーも見える
      expect(page).to have_content('General User')
      # 自分（ゲスト）も見える
      expect(page).to have_content('Guest User')
    end
  end
end
</file>

<file path="spec/system/user_auth_spec.rb">
require "rails_helper"

RSpec.describe "ユーザー認証・認可", type: :system, js: true do
  describe "ログイン" do
    let!(:user) { FactoryBot.create(:user, password: "password123") }

    it "正しいメールアドレスとパスワードでログインできること" do
      visit new_user_session_path
      fill_in "メールアドレス", with: user.email
      fill_in "login-password-field", with: "password123"
      within "#new_user" do
        click_button "ログイン"
      end

      expect(page).to have_content 'ログインしました。'
      expect(current_path).to eq root_path
    end

    it "誤ったパスワードではログインできないこと" do
      visit new_user_session_path
      fill_in "メールアドレス", with: user.email
      fill_in "login-password-field", with: "wrongpassword"
      within "#new_user" do
        click_button "ログイン"
      end

      expect(page).to have_content 'メールアドレスまたはパスワードが違います。'
      expect(current_path).to eq new_user_session_path
    end

    it "存在しないメールアドレスではログインできないこと" do
      visit new_user_session_path
      fill_in "メールアドレス", with: "unknown@example.com"
      fill_in "login-password-field", with: "password123"
      within "#new_user" do
        click_button "ログイン"
      end

      expect(page).to have_content 'メールアドレスまたはパスワードが違います。'
      expect(current_path).to eq new_user_session_path
    end
  end

  describe "ログアウト" do
    let!(:user) { FactoryBot.create(:user, password: "password123") }

    before do
      login_as(user, scope: :user)
      visit root_path
    end

    it "ログアウトできること" do
      # アバター画像をクリックしてドロップダウンを開く
      # 画像がない場合（イニシャル表示）も考慮して、ボタン自体をクリックする
      find("button[data-dropdown-target='button']").click

      # ドロップダウンが表示されるのを待ってからログアウトをクリック
      # "ログアウト" のリンクが表示されるまで待機する
      expect(page).to have_content("ログアウト")
      click_link "ログアウト"

      expect(page).to have_content 'ログアウトしました。'
      expect(current_path).to eq new_user_session_path
    end
  end

  describe "アクセス制御" do
    let!(:user) { FactoryBot.create(:user, password: "password123") }

    context "ログインしていない場合" do
      it "設定画面にアクセスするとログイン画面にリダイレクトされること" do
        visit edit_user_registration_path
        expect(page).to have_content 'アカウント登録もしくはログインしてください。'
        expect(current_path).to eq new_user_session_path
      end

      it "トップページにアクセスするとLPが表示されること" do
        visit root_path
        expect(page).to have_content 'てくメモ'
        expect(page).to have_link 'ログイン'
        expect(page).to have_link '新規登録'
        expect(current_path).to eq root_path
      end
    end

    context "ログインしている場合" do
      before do
        sign_in user
      end

      it "ログイン画面にアクセスするとトップページにリダイレクトされること" do
        visit new_user_session_path
        expect(page).to have_content 'すでにログインしています。'
        expect(current_path).to eq root_path
      end

      it "新規登録画面にアクセスするとトップページにリダイレクトされること" do
        visit new_user_registration_path
        expect(page).to have_content 'すでにログインしています。'
        expect(current_path).to eq root_path
      end
    end
  end

  describe "パスワードリセット" do
    it "リセット機能が未実装のため、ログイン画面にリダイレクトされること" do
      visit new_user_session_path
      click_link "忘れた場合"

      # ログイン画面にリダイレクトされる
      expect(current_path).to eq new_user_session_path
      # アラートメッセージが表示される（文言はコントローラの実装に合わせる）
      expect(page).to have_content("準備中です")
    end
  end
end
</file>

<file path="README.md">
# README
# **てくメモ**

> ⚠️ **MVP(β版)について**
> 本アプリは現在開発中のベータ版です。バグや不具合が含まれる可能性があります。
> 既知の問題は→ [GitHub Issues](https://github.com/Yadon987/tekumemo/issues/142)
> 💡 本プロジェクトでは、カリキュラムの復習と自分に足りない物の洗い出しのため、AIエージェントを積極的に活用しています。

アプリ正式名称：てくてくメモリア

## サービス概要
散歩の記録、歩数の可視化、ランキング機能を核とし、働き盛り世代のモチベーション維持と習慣化をサポートします。

投稿やリアクション機能を通じて「頑張り」を共有し、フォロー機能で気の合う仲間とのつながりを作ることで、飽きによる挫折を防ぎ達成感を与えます。

天気予報やランキング機能で、毎日の散歩を「ちょっとしたイベント」に変え、日々の健康づくりを継続的に促す**コミュニティ型のお散歩習慣化アプリ**です。

## このサービスへの思い・作りたい理由
散歩を習慣化したい働き盛り世代の挫折を防ぐため。

日々の**「頑張り」を記録・可視化することで達成感とモチベーション**を維持したい。

単調な散歩を乗り越え、健康習慣を定着させるためのアプリを提供したい。

## ユーザー層について
**ターゲット：** 健康に気を使い始める30代から60代の働き盛り世代　外出中のスマホ利用を想定

## サービスの利用イメージ
- 外で使うことを想定
- 早朝や深夜に使う想定で配色(ダークモード機能など)に配慮が必要
- 歩きながら短時間で操作しやすいようにボタンの大きさの配慮が必要

## ユーザーの獲得について
Coming soon……

## サービスの差別化ポイント・推しポイント
### **1. 多様なリアクション機能**
- 単なる「いいね」ではなく「応援」「すごい」「頑張って」など感情豊かな反応
- 働き盛り世代の励まし合いに特化したリアクション設計

### **2. 実用性重視の設計**
- 天気予報連携で散歩計画をサポート
- Google Keep連携で散歩中のひらめきを逃さない
- 忙しい世代でも続けやすいシンプルな記録方式

### **3. 適度なコミュニティ感**
- フォロー機能で気の合う仲間を見つけられる
- 過度なSNS化を避け、健康習慣に集中した設計
- プライバシー設定で安心して利用可能

### **4. 継続を支える仕組み**
- ログインスタンプで習慣化をサポート
- 目標達成率の可視化でモチベーション維持
- ランキングで適度な競争要素を提供

## できること（機能一覧）
### **認証・基本機能**
* ログイン・ユーザー管理
* ユーザープロフィール設定
* ログインスタンプ機能

### **散歩記録機能**
* 散歩投稿の追加・編集・削除
* 歩数・距離・時間の記録
* Google Fit連携

### **コミュニティ機能**
* リアクション機能（いいね、応援、すごい等）
* フォロー・フォロワー機能（将来実装）

### **実用機能**
* 天気予報の閲覧
* 歩数・距離ランキング
* 目標設定と達成率表示

### **外部連携**
* Google Keepのリンク・アプリ起動

### **将来実装予定**
* 位置情報の取得・ルート表示
* 歩数と距離の自動計算
* 散歩リマインダー通知
* グラフ・統計表示
* Googleログイン

## 機能候補と優先順位

| 優先度 | 技術要素 | 目的 |
| :--- | :--- | :--- |
| **最優先（MVP）**| **CRUD操作・DB操作** | 投稿、ユーザー認証・ログインなどのデータ永続化に必須 |
| **最優先（MVP）**| **歩数記録・表示** | メイン機能 |
| **最優先（MVP）**| **継続スタンプ + カレンダー** | 習慣化の核機能。実装が比較的容易 |
| **最優先（MVP）**| **リアクション機能** | コミュニティの基盤。多様な反応で継続モチベーション向上 |
| **最優先（MVP）**| **非同期通信** | 投稿データの送受信、外部APIデータ取得時のUX向上 |
| **最優先（MVP）**| **外部API連携（Google Fit）** | ユーザーの面倒なデータ入力の手間を省く |
| **最優先（MVP）**| **外部API連携（天気予報）** | ユーザーが散歩計画を立てるための実用性 |
| **最優先（MVP）**| **Googleログイン** | ログインの手間を減らす |
| **高優先** | **フォロー機能** | 継続的なコミュニティ形成。モチベーション維持の核 |
| **中優先** | **ランキング機能** | ゲーミフィケーション要素 |
| **中優先** | **GoogleマップAPI連携** | 歩行距離表示など、高度なUXを実現 |
| **低優先** | **通知機能** | 継続利用を促すためのプッシュ通知 |
| **低優先** | **グラフ機能** | ユーザー体験を向上させるための可視化 |
| **低優先** | **継続スタンプ補填** | 雨などで連続ログインが止まらないように運動ガチャでスタンプを補填 |
| **低優先** | **フォロー機能** | 継続的なコミュニティ形成。本来は高優先度だがユーザーが少ないうちは低優先度|
| **ボツ案** | **アチーブメント機能** | 目標達成の可視化 一つ一つリッチなデザインを考え実装する時間がかかるためボツ |

## 使用する技術スタック
### **バックエンド**
* **言語・フレームワーク:** Ruby 3.2.2 + Ruby on Rails 7.2.x
* **データベース:** PostgreSQL(Supabase)
* **認証:** Devise
* **API連携:** net-http（Rails標準）or OpenWeatherMap API（天気予報）

### **フロントエンド**
* **スタイリング:** Tailwind CSS CLI
* **JavaScript:** Hotwire (Turbo / Stimulus)


### **インフラ・API**
* **デプロイ先:** Render
* **デザインツール:** Google Stitch・Figma
* **バージョン管理:** Git/GitHub
* **Auth:** Devise, OmniAuth (Google OAuth2)
* **External APIs:**
    *   Google Fit API (REST)
    *   OpenWeatherMap API
    *   Windy.com (Embed)

## 🐳 開発環境

### **前提条件**
* **Docker Engine** (WSL2上で動作)
* **docker-compose**

### **環境構築**
```bash
# コンテナの起動
docker compose up -d

# 初回のみ: データベース作成とマイグレーション
docker exec tekumemo-web bash -c "bundle exec rails db:create db:migrate"
```

### **テスト実行**
⚠️ **重要: このプロジェトではDocker環境でのテスト実行が必須です**

```bash
# 全テストを実行（推奨）
./bin/test_all.sh

# 個別にテストを実行する場合
docker exec tekumemo-web bash -c "RAILS_ENV=test bundle exec rspec spec/models/user_spec.rb"

# システムテストのみ実行
docker exec tekumemo-web bash -c "RAILS_ENV=test bundle exec rspec spec/system/"
```

**テストスクリプトが実行すること:**
1. Dockerコンテナの起動確認
2. テストデータベースの準備
3. RuboCopによるコードスタイルチェック
4. RSpecによる全テスト実行（306項目）

**初回のみ実行権限付与:**
```bash
chmod +x bin/test_all.sh
```


## 画面遷移図(暫定版)
### PC版
Figma：(https://www.figma.com/board/U1dqKDAMsI9lNTAEYcGTOV/FigJam-basics?node-id=0-1&p=f&t=ZDUfKhhX3F41N6dn-0)
[![Image from Gyazo](https://i.gyazo.com/46f161ccd35179b545c2b700eeb17617.png)](https://gyazo.com/46f161ccd35179b545c2b700eeb17617)

### スマホ版
Coming soon…


## ER図(暫定版)
dbdiagram.io：(https://dbdiagram.io/d/68f9ef31357668b7323f223e)
[![Image from Gyazo](https://i.gyazo.com/c20dc36a70bfa9218cfd56b62ab7c0dd.png)](https://gyazo.com/c20dc36a70bfa9218cfd56b62ab7c0dd)

### ER図設計メモ
- **ユーザー情報の分離**: 認証情報、プロフィール、設定を実務に近い形で分離し、パフォーマンスを最適化
- **散歩投稿の統合**: 投稿内容と実績データを統合し、N+1問題を回避
- **インデックス最適化**: 検索・ソート・集計処理を高速化
- **スケーラビリティ**: 将来のフォロー機能など、機能拡張に対応

## 今後の改善ポイント
Google Cloudの審査を早めに通す

## 📝 変更履歴
v1.3　ER図の作成と仕様変更
v1.4　アプリ正式名称を『てくてくメモリア』に変更
v1.5  MVPリリースのドキュメント整理

## ⚠️ 重要: 環境変数の管理

このプロジェクトでは、**開発環境と本番環境で異なる環境変数ファイルを使用**します：

### 環境変数ファイル

- **`.env`** - 開発環境用（ローカルDocker環境）
  - `DATABASE_URL`は**設定しないでください**
  - docker-compose.ymlとdatabase.ymlの設定を使用します
  
- **`.env.production`** - 本番環境用（Supabase使用）
  - 本番デプロイ時のみ使用
  - **開発環境では絶対に読み込まないでください**

### 絶対に守ること

1. `.env`に本番のDATABASE_URLを**絶対に設定しない**
2. 開発環境で本番データベースに接続することを**完全に防止**
3. 本番デプロイ時のみ`.env.production`を使用する

### なぜこの分離が重要か

過去に、開発環境で誤って本番データベースに接続し、**本番データが消失する事故**が発生しました。
この設定により、開発中に本番環境に影響を与えることを防止します。
</file>

<file path="app/models/walk.rb">
class Walk < ApplicationRecord
  # ユーザーとの関連付け（1人のユーザーは複数の散歩記録を持つ）
  belongs_to :user

  # バリデーション（入力チェック）

  # 散歩日は必須項目
  # ▼ 追加: 同じユーザーが同じ日に複数の記録を作成できないようにする
  validates :walked_on, presence: true
  validates :walked_on, uniqueness: { scope: :user_id, message: "の記録は既に存在します。同じ日付の記録を編集、もしくは削除してください。" }

  # 距離と時間を必須に ▼▼▼
  # 散歩時間は任意項目で、入力された場合は0以上の整数のみ許可
  validates :duration, presence: true, numericality: { greater_than: 0, only_integer: true }

  # 距離は任意項目で、入力された場合は0以上の数値のみ許可（上限50km）
  validates :distance, presence: true, numericality: { greater_than: 0, less_than_or_equal_to: 50 }

  # 歩数は任意項目で、入力された場合は0以上の整数のみ許可
  validates :steps, numericality: { greater_than_or_equal_to: 0, only_integer: true }, allow_nil: true

  # 消費カロリーは任意項目で、入力された場合は0以上の整数のみ許可
  validates :calories_burned, numericality: { greater_than_or_equal_to: 0, only_integer: true }, allow_nil: true

  # 場所とメモはバリデーションなし（完全に任意）

  # 時間帯 (0:早朝, 1:日中, 2:夕方, 3:夜間)
  enum :time_of_day, {
    early_morning: 0, # 04:00 - 08:59
    day: 1,           # 09:00 - 15:59
    evening: 2,       # 16:00 - 18:59
    night: 3          # 19:00 - 03:59
  }, prefix: true

  # ==========================================
  # スコープ（データの絞り込みや並び替え）
  # ==========================================

  # 新しい日付順に並び替えるスコープ
  # (default_scopeは予期せぬバグの原因になりやすいため、名前付きスコープを使用)
  scope :recent, -> { order(walked_on: :desc) }

  # コールバック
  before_save :set_time_of_day_from_created_at

  # Google Fitのデータをマージする
  # 既存の値より大きい場合のみ更新する
  def merge_google_fit_data(data)
    if new_record?
      self.distance = data[:distance]
      self.steps = data[:steps]
      self.calories_burned = data[:calories]
      self.duration = data[:duration] if data[:duration]
    else
      self.distance = data[:distance] if distance.to_f < data[:distance]
      self.steps = data[:steps] if steps.to_i < data[:steps]
      self.calories_burned = data[:calories] if calories_burned.to_i < data[:calories]
      self.duration = data[:duration] if data[:duration] && duration.to_i < data[:duration].to_i
    end

    # 時間帯の設定（未設定の場合のみ）
    if time_of_day.blank? && data[:start_time]
      set_time_of_day_from_hour(data[:start_time].hour)
    elsif time_of_day.blank?
      self.time_of_day = :day # デフォルト
    end
  end

  private

  def set_time_of_day_from_created_at
    return if time_of_day.present?

    # created_atが未設定の場合は現在時刻を使用
    target_time = created_at || Time.current
    hour = target_time.hour

    self.time_of_day = case hour
    when 4..8 then :early_morning
    when 9..15 then :day
    when 16..18 then :evening
    else :night
    end
  end



  private

  def set_time_of_day_from_hour(hour)
    self.time_of_day = case hour
    when 4..8 then :early_morning
    when 9..15 then :day
    when 16..18 then :evening
    else :night
    end
  end
end
</file>

<file path="spec/services/google_fit_service_spec.rb">
require 'rails_helper'
require 'google/apis/fitness_v1'

RSpec.describe GoogleFitService, type: :service do
  let(:user) { create(:user, google_token: "token", google_refresh_token: "refresh_token", google_expires_at: 1.hour.from_now) }
  let(:service) { described_class.new(user) }
  let(:fitness_service) { instance_double(Google::Apis::FitnessV1::FitnessService) }
  let(:auth_client) { instance_double(Signet::OAuth2::Client) }

  before do
    allow(Google::Apis::FitnessV1::FitnessService).to receive(:new).and_return(fitness_service)
    allow(fitness_service).to receive(:authorization=)
    allow(user).to receive(:google_token_valid?).and_return(true)

    # Signet::OAuth2::Client のモック
    allow(Signet::OAuth2::Client).to receive(:new).and_return(auth_client)
    allow(auth_client).to receive(:refresh!)
    allow(auth_client).to receive(:access_token).and_return("new_token")
    allow(auth_client).to receive(:expires_at).and_return(Time.now + 3600)
  end

  describe "#fetch_activities" do
    let(:start_date) { Date.current }
    let(:end_date) { Date.current }

    # === 共通の値オブジェクト ===
    let(:step_val_obj) { double(int_val: 1000) }
    let(:distance_val_obj) { double(fp_val: 1500.0) } # 1500m
    let(:calorie_val_obj) { double(fp_val: 500.0) }

    # === 1. 日次歩数リクエスト用のモック ===
    let(:daily_step_point) { double(value: [ step_val_obj ]) }
    let(:daily_step_dataset) { double(point: [ daily_step_point ]) }
    let(:daily_bucket) { double(
      start_time_millis: start_date.beginning_of_day.to_i * 1000,
      end_time_millis: start_date.end_of_day.to_i * 1000,
      dataset: [ daily_step_dataset ]
    )}
    let(:daily_steps_response) { double(bucket: [ daily_bucket ]) }

    # === 2. アクティビティセグメントリクエスト用のモック ===
    # データセットの順序: Distance, Calories
    let(:act_distance_point) { double(value: [ distance_val_obj ]) }
    let(:act_calorie_point) { double(value: [ calorie_val_obj ]) }

    let(:act_distance_dataset) { double(point: [ act_distance_point ]) }
    let(:act_calorie_dataset) { double(point: [ act_calorie_point ]) }

    let(:activity_bucket) { double(
      start_time_millis: start_date.beginning_of_day.to_i * 1000,
      end_time_millis: start_date.beginning_of_day.to_i * 1000 + 3600000, # 1時間
      activity: 7, # Walking
      dataset: [ act_distance_dataset, act_calorie_dataset ]
    )}
    let(:activity_segments_response) { double(bucket: [ activity_bucket ]) }

    before do
      # 1回目は日次歩数、2回目はアクティビティデータを返す
      allow(fitness_service).to receive(:aggregate_dataset).and_return(daily_steps_response, activity_segments_response)
    end

    it "正しくデータを取得して整形すること" do
      result = service.fetch_activities(start_date, end_date)
      data = result[:data][start_date]

      # 歩数: 日次データから (1000)
      # 距離: アクティビティデータから (1500m -> 1.5km)
      # カロリー: アクティビティデータから (500)
      # 時間: 歩数(1000) / 100 = 10分 + アクティビティ時間(サイクリングなら加算だが今回はWalkingなので加算なし)

      expect(data[:steps]).to eq 1000
      expect(data[:distance]).to eq 1.5
      expect(data[:calories]).to eq 500
      expect(data[:duration]).to eq 10 # 1000歩 ÷ 100歩/分
    end

    context "APIエラーが発生した場合" do
      before do
        allow(fitness_service).to receive(:aggregate_dataset).and_raise(Google::Apis::ClientError.new("API Error"))
      end

      it "エラーハッシュを返すこと" do
        result = service.fetch_activities(start_date, end_date)
        expect(result).to include(error: :api_error)
      end
    end
  end
end
</file>

<file path="spec/services/stats_service_spec.rb">
require 'rails_helper'

RSpec.describe StatsService do
  let(:user) { create(:user, target_distance: 3000) }
  let(:service) { StatsService.new(user) }

  describe '基本統計' do
    before do
      # テストデータを作成
      create(:walk, user: user, walked_on: Date.current, distance: 5.0, duration: 60, steps: 6000, calories_burned: 250)
      create(:walk, user: user, walked_on: 1.day.ago, distance: 3.0, duration: 30, steps: 4000, calories_burned: 150)
      create(:walk, user: user, walked_on: 2.days.ago, distance: 4.0, duration: 45, steps: 5000, calories_burned: 200)
    end

    it '累計距離を正しく計算できる' do
      expect(service.total_distance).to eq(12.0)
    end

    it '累計日数を正しく計算できる' do
      expect(service.total_days).to eq(3)
    end

    it '平均距離を正しく計算できる' do
      # 12.0 / 3 = 4.0
      expect(service.average_distance_per_day).to eq(4.0)
    end

    it '最長記録距離を正しく取得できる' do
      expect(service.max_distance).to eq(5.0)
    end
  end

  describe '今月の統計' do
    context 'データが既に存在する場合' do
      before do
        # 今月のデータ
        create(:walk, user: user, walked_on: Date.current, distance: 5.0, duration: 60, steps: 6000, calories_burned: 250)
        # 先月のデータ
        create(:walk, user: user, walked_on: Date.current.prev_month, distance: 3.0, duration: 30, steps: 4000, calories_burned: 150)
        create(:walk, user: user, walked_on: Date.current.prev_month - 1.day, distance: 4.0, duration: 45, steps: 5000, calories_burned: 200)
      end

      it '今月の距離を正しく計算できる' do
        # 今月のデータ（5.0km）のみが対象
        expect(service.current_month_distance).to eq(5.0)
      end
    end

    context '目標達成率の計算' do
      it '今月の目標達成率を正しく計算できる（習慣化達成率）' do
        # 毎月1日に固定
        travel_to Date.current.beginning_of_month do
          # このテストケース専用のデータを作成
          # 目標: 3000m (3.0km)
          # 実績: 5.0km -> 達成
          # 達成率: 1日中1日達成 -> 100.0%
          create(:walk, user: user, walked_on: Date.current, distance: 5.0, duration: 60, steps: 6000, calories_burned: 250)

          expect(service.monthly_goal_achievement_rate).to eq(100.0)
        end
      end
    end
  end

  describe '時系列データ' do
    before do
      # 過去30日間にランダムな記録を作成
      10.times do |i|
        create(:walk,
          user: user,
          walked_on: i.days.ago.to_date,
          distance: (i + 1).to_f,
          duration: 30
        )
      end
    end

    it '日別距離データを正しく取得できる' do
      result = service.daily_distances_last_30_days

      expect(result).to have_key(:dates)
      expect(result).to have_key(:distances)
      expect(result[:dates].length).to eq(31)  # 30日前〜今日まで
      expect(result[:distances].length).to eq(31)
    end

    it '週別距離データを正しく取得できる' do
      result = service.weekly_distances_last_12_weeks

      expect(result).to have_key(:weeks)
      expect(result).to have_key(:distances)
      expect(result[:weeks].length).to eq(12)
      expect(result[:distances].length).to eq(12)
    end

    it '月別距離データを正しく取得できる' do
      result = service.monthly_distances_last_12_months

      expect(result).to have_key(:months)
      expect(result).to have_key(:distances)
      expect(result[:months].length).to eq(12)
      expect(result[:distances].length).to eq(12)
    end
  end

  describe '曜日別分析' do
    before do
      # 各曜日に記録を作成
      # 月曜日に2000m、火曜日に3000m
      monday = Date.current.beginning_of_week  # 月曜日
      create(:walk, user: user, walked_on: monday, distance: 2.0)
      create(:walk, user: user, walked_on: monday + 1.day, distance: 3.0)  # 火曜日
    end

    it '曜日別平均距離を正しく計算できる' do
      result = service.average_distance_by_weekday

      expect(result).to have_key(:day_names)
      expect(result).to have_key(:average_distances)
      expect(result[:day_names]).to eq(%w[日 月 火 水 木 金 土])
      expect(result[:average_distances].length).to eq(7)
    end
  end

  describe '時間帯別分析' do
    before do
      # 早朝 (4-8時)
      create(:walk, user: user, created_at: Time.current.change(hour: 6), walked_on: 1.day.ago)
      # 日中 (9-15時)
      create(:walk, user: user, created_at: Time.current.change(hour: 12), walked_on: 2.days.ago)
      create(:walk, user: user, created_at: Time.current.change(hour: 14), walked_on: 3.days.ago)
      # 夕方 (16-18時)
      create(:walk, user: user, created_at: Time.current.change(hour: 17), walked_on: 4.days.ago)
      # 夜間 (19-3時) - なし
    end

    it '時間帯別の散歩回数を正しく集計できる' do
      result = service.walks_count_by_time_of_day

      expect(result).to have_key(:labels)
      expect(result).to have_key(:data)
      expect(result[:labels]).to eq([ "早朝 (4-9時)", "日中 (9-16時)", "夕方 (16-19時)", "夜間 (19-4時)" ])

      # 早朝: 1, 日中: 2, 夕方: 1, 夜間: 0
      expect(result[:data]).to eq([ 1, 2, 1, 0 ])
    end
  end

  describe 'パフォーマンス分析' do
    before do
      create(:walk, user: user, walked_on: Date.current, distance: 5.0, duration: 50)  # 5km、50分
      create(:walk, user: user, walked_on: 1.day.ago, distance: 3.0, duration: 30)     # 3km、30分
    end

    it '平均ペースを正しく計算できる' do
      # 合計: 8km、80分 → 10分/km
      pace = service.average_pace
      expect(pace).to eq(10.0)
    end

    it 'ペース推移データを取得できる' do
      result = service.pace_trend_last_30_days

      expect(result).to have_key(:dates)
      expect(result).to have_key(:paces)
      expect(result[:dates].length).to eq(31)
      expect(result[:paces].length).to eq(31)
    end

    it 'カロリー推移データを取得できる' do
      result = service.calories_trend_last_30_days

      expect(result).to have_key(:dates)
      expect(result).to have_key(:calories)
      expect(result[:dates].length).to eq(31)
      expect(result[:calories].length).to eq(31)
    end
  end

  describe 'RPG要素' do
    describe '#level' do
      it '累計距離に応じてレベルが上昇する' do
        # Lv1: 0-9km
        create(:walk, user: user, distance: 5, walked_on: Date.current)
        expect(service.level).to eq(1)

        # Lv2: 10-29km
        create(:walk, user: user, distance: 5, walked_on: 1.day.ago) # 合計10km
        expect(service.level).to eq(2)

        # Lv3: 30-59km
        create(:walk, user: user, distance: 20, walked_on: 2.days.ago) # 合計30km
        expect(service.level).to eq(3)
      end
    end

    describe '#rank_name' do
      it 'レベルに応じたランク名を返す' do
        # Lv1
        create(:walk, user: user, distance: 5, walked_on: Date.current)
        expect(service.rank_name).to eq("散歩見習い")

        # Lv3
        create(:walk, user: user, distance: 25, walked_on: 1.day.ago) # 合計30km
        expect(service.rank_name).to eq("街の探索者")
      end
    end

    describe '#achievements' do
      it '条件を満たした称号が獲得済み(obtained: true)になる' do
        # 雨天強行軍の条件: 雨の日の記録(Post)があり、同日の散歩記録(Walk)がある
        post = create(:post, user: user, weather: :rainy, created_at: Time.current)
        create(:walk, user: user, walked_on: post.created_at.to_date)

        # 嵐を呼ぶ者の条件: 嵐の日の記録(Post)があり、同日の散歩記録(Walk)がある
        storm_post = create(:post, user: user, weather: :stormy, created_at: 1.day.ago)
        create(:walk, user: user, walked_on: storm_post.created_at.to_date)

        # 暁の冒険者の条件: 早朝(4-8時)の記録(Walk)がある
        # created_atを5時に設定 -> before_saveでtime_of_day: :early_morningになるはず
        create(:walk, user: user, created_at: Time.current.change(hour: 5), walked_on: 2.days.ago)

        # 太陽の申し子の条件: 日中(9-15時)の記録(Walk)がある
        create(:walk, user: user, created_at: Time.current.change(hour: 12), walked_on: 3.days.ago)

        # 不屈の精神の条件: ヘトヘト(exhausted)の投稿がある
        create(:post, user: user, feeling: :exhausted)

        achievements = service.achievements

        expect(achievements.find { |a| a[:id] == :rain_walker }[:obtained]).to be true
        expect(achievements.find { |a| a[:id] == :storm_walker }[:obtained]).to be true
        expect(achievements.find { |a| a[:id] == :early_bird }[:obtained]).to be true
        expect(achievements.find { |a| a[:id] == :sun_child }[:obtained]).to be true
        expect(achievements.find { |a| a[:id] == :indomitable }[:obtained]).to be true
      end

      it '条件を満たしていない称号は未獲得(obtained: false)になる' do
        # まだ記録がない状態
        achievements = service.achievements

        expect(achievements.find { |a| a[:id] == :rain_walker }[:obtained]).to be false
      end
    end
  end

  describe 'エッジケース' do
    it '記録が0件の場合、エラーにならない' do
      empty_user = create(:user)
      empty_service = StatsService.new(empty_user)

      expect(empty_service.total_distance).to eq(0)
      expect(empty_service.total_days).to eq(0)
      expect(empty_service.average_distance_per_day).to eq(0)
      expect(empty_service.max_distance).to eq(0)
      expect(empty_service.average_pace).to eq(0)
    end
  end
end
</file>

<file path="Dockerfile">
# syntax = docker/dockerfile:1

# This Dockerfile is designed for production, not development. Use with Kamal or build'n'run by hand:
# docker build -t my-app .
# docker run -d -p 80:80 -p 443:443 --name my-app -e RAILS_MASTER_KEY=<value from config/master.key> my-app

# Make sure RUBY_VERSION matches the Ruby version in .ruby-version
ARG RUBY_VERSION=3.2.2
FROM docker.io/library/ruby:$RUBY_VERSION-slim AS base

# Rails app lives here
WORKDIR /rails

# Install base packages
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y curl libjemalloc2 libvips postgresql-client && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Set production environment
ENV RAILS_ENV="production" \
    BUNDLE_DEPLOYMENT="1" \
    BUNDLE_PATH="/usr/local/bundle" \
    BUNDLE_WITHOUT="development"

# Throw-away build stage to reduce size of final image
FROM base AS build

# Install packages needed to build gems and node modules
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y build-essential git libpq-dev libyaml-dev node-gyp pkg-config python-is-python3 && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Install JavaScript dependencies
ARG NODE_VERSION=18.20.4
ARG YARN_VERSION=latest
ENV PATH=/usr/local/node/bin:$PATH
RUN curl -sL https://github.com/nodenv/node-build/archive/master.tar.gz | tar xz -C /tmp/ && \
    /tmp/node-build-master/bin/node-build "${NODE_VERSION}" /usr/local/node && \
    npm install -g yarn@$YARN_VERSION && \
    rm -rf /tmp/node-build-master

# Install application gems
COPY Gemfile Gemfile.lock ./
RUN bundle install && \
    rm -rf ~/.bundle/ "${BUNDLE_PATH}"/ruby/*/cache "${BUNDLE_PATH}"/ruby/*/bundler/gems/*/.git && \
    bundle exec bootsnap precompile --gemfile

# Install node modules
COPY package.json yarn.lock ./
RUN yarn install --frozen-lockfile

# Copy application code
COPY . .

# Precompile bootsnap code for faster boot times
RUN bundle exec bootsnap precompile app/ lib/

# Precompiling assets for production without requiring secret RAILS_MASTER_KEY
RUN SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile


RUN rm -rf node_modules


# Final stage for app image
FROM base

# Copy built artifacts: gems, application
COPY --from=build "${BUNDLE_PATH}" "${BUNDLE_PATH}"
COPY --from=build /rails /rails

# Run and own only the runtime files as a non-root user for security
RUN groupadd --system --gid 1000 rails && \
    useradd rails --uid 1000 --gid 1000 --create-home --shell /bin/bash && \
    chown -R rails:rails db log storage tmp
USER 1000:1000

# Entrypoint prepares the database.
ENTRYPOINT ["/rails/bin/docker-entrypoint"]

# Start the server by default, this can be overwritten at runtime
EXPOSE 3000
CMD ["./bin/rails", "server"]
</file>

<file path="tailwind.config.js">
const defaultTheme = require("tailwindcss/defaultTheme");

module.exports = {
  content: [
    "./public/*.html",
    "./app/helpers/**/*.rb",
    "./app/javascript/**/*.js",
    "./app/views/**/*.{erb,haml,html,slim}",
    "./app/assets/stylesheets/**/*.css",
  ],
  // ダークモード設定: classベース
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        // プライマリカラー
        primary: "#1976D2",
        // 背景色
        "background-light": "#F7F8FC",
        "background-dark": "#121212",
        // Claymorphism Colors
        clay: {
          bg: "#fdf5e6", // Warm peachy beige (health app style)
          card: "#ffffff", // Pure White
          primary: "#60a5fa", // blue-400
          accent: "#fb923c", // orange-400
        },
      },
      fontFamily: {
        // 日本語フォント設定
        display: ["Noto Sans JP", ...defaultTheme.fontFamily.sans],
        sans: ["Noto Sans JP", ...defaultTheme.fontFamily.sans],
      },
      borderRadius: {
        DEFAULT: "1rem",
        clay: "2.5rem", // 40px
      },
      boxShadow: {
        // Claymorphism Shadows (TEST: Darker color + Higher opacity)
        // カード用: 仮説5+6検証 - 影の色を暗く、不透明度を大幅UP
        "clay-card":
          "0 20px 40px -5px rgba(59, 130, 246, 0.15), 0 10px 20px -5px rgba(59, 130, 246, 0.1)",
        // 右上ボタン用
        "clay-floating":
          "0 6px 16px rgba(50, 60, 70, 0.4), 0 3px 8px rgba(50, 60, 70, 0.2)",
        // アイコン用（凸）: 不要になったので削除可能
        "clay-icon":
          "8px 8px 20px rgba(192, 197, 208, 0.3), -6px -6px 12px rgba(255, 255, 255, 0.5)",
        // ボタン用: 色付きの影（Glow）
        "clay-btn-blue":
          "0 10px 25px -5px rgba(59, 130, 246, 0.6), 0 8px 10px -6px rgba(59, 130, 246, 0.2)",
        "clay-btn-orange":
          "0 10px 25px -5px rgba(249, 115, 22, 0.6), 0 8px 10px -6px rgba(249, 115, 22, 0.2)",
        // 凹み（アイコン背景など）- 必要なら残す
        "clay-inner":
          "inset 6px 6px 10px #cbd5e1, inset -6px -6px 10px #ffffff",
        // Dark Mode Glow
        "neon-blue":
          "0 0 15px rgba(59, 130, 246, 0.6), 0 0 30px rgba(59, 130, 246, 0.3)",
        "neon-purple":
          "0 0 15px rgba(168, 85, 247, 0.6), 0 0 30px rgba(168, 85, 247, 0.3)",
      },
      // グラデーション関連のユーティリティを有効化
      backgroundImage: {
        "gradient-radial": "radial-gradient(var(--tw-gradient-stops))",
        "clay-gradient": "linear-gradient(145deg, #ffffff, #e6e6e6)",
        // ボタン用グラデーション
        "btn-blue-grad": "linear-gradient(to bottom, #60a5fa, #3b82f6)",
        "btn-orange-grad": "linear-gradient(to bottom, #fb923c, #f97316)",
      },
      // カスタムアニメーション
      animation: {
        "bounce-slow": "bounce 3s ease-in-out infinite",
        "fade-in": "fadeIn 0.8s ease-out",
        "slide-up": "slideUp 0.6s ease-out",
        "pulse-fast": "pulseDeep 3s cubic-bezier(0.4, 0, 0.6, 1) infinite",
        "pulse-slow": "pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite", // God Mode: Breathing Glow
        shimmer: "shimmer 2s linear infinite", // God Mode: Shining Effect
        sparkle: "sparkle 4.5s ease-in-out infinite",
        "sparkle-scale": "sparkleScale 4.5s ease-in-out infinite",
        float: "float 6s ease-in-out infinite",
        "gradient-xy": "gradient-xy 15s ease infinite",
        // LPミニチュアUI用アニメーション
        dash: "dash 1.5s ease-out forwards",
        "grow-h-12": "growH12 1s ease-out forwards",
        "grow-h-16": "growH16 1s ease-out forwards",
        "grow-h-24": "growH24 1s ease-out forwards",
        "pop-in": "pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) both",
        "float-up": "float-up 2s ease-out infinite both",
      },
      keyframes: {
        shimmer: {
          "0%": { transform: "translateX(-100%)" },
          "100%": { transform: "translateX(100%)" },
        },
        sparkle: {
          "0%, 85%, 100%": {
            filter:
              "drop-shadow(0 2px 2px rgba(0,0,0,0.8)) drop-shadow(0 0 15px rgba(250,204,21,0.5))",
            transform: "scale(1)",
          },
          "92.5%": {
            filter:
              "drop-shadow(0 2px 2px rgba(0,0,0,0.8)) drop-shadow(0 0 60px rgba(250,204,21,0.8)) drop-shadow(0 0 25px rgba(255,255,255,0.6))",
            transform: "scale(1.15)",
          },
        },
        sparkleScale: {
          "0%, 85%, 100%": { transform: "scale(1)" },
          "92.5%": { transform: "scale(1.05)" },
        },
        pulseDeep: {
          "0%, 100%": { opacity: "1" },
          "50%": { opacity: "0.3" },
        },
        fadeIn: {
          "0%": { opacity: "0", transform: "translateY(10px)" },
          "100%": { opacity: "1", transform: "translateY(0)" },
        },
        slideUp: {
          "0%": { transform: "translateY(30px)", opacity: "0" },
          "100%": { transform: "translateY(0)", opacity: "1" },
        },
        float: {
          "0%, 100%": { transform: "translateY(0)" },
          "50%": { transform: "translateY(-10px)" },
        },
        "gradient-xy": {
          "0%, 100%": {
            "background-size": "400% 400%",
            "background-position": "0% 0%",
          },
          "50%": {
            "background-size": "400% 400%",
            "background-position": "100% 100%",
          },
        },
        // LPミニチュアUI用キーフレーム
        dash: {
          "0%": { "stroke-dashoffset": "283" },
          "100%": { "stroke-dashoffset": "70" }, // 75%くらいの位置
        },
        growH12: {
          "0%": { height: "0" },
          "100%": { height: "3rem" }, // h-12
        },
        growH16: {
          "0%": { height: "0" },
          "100%": { height: "4rem" }, // h-16
        },
        growH24: {
          "0%": { height: "0" },
          "100%": { height: "6rem" }, // h-24
        },
        "pop-in": {
          "0%": { opacity: "0", transform: "translate(-50%, 20px) scale(0.5)" },
          "100%": { opacity: "1", transform: "translate(-50%, 0) scale(1)" },
        },
        "float-up": {
          "0%": { opacity: "0", transform: "translateY(10px) scale(0.5)" },
          "20%": { opacity: "1", transform: "translateY(0) scale(1)" },
          "80%": { opacity: "1", transform: "translateY(-20px) scale(1)" },
          "100%": { opacity: "0", transform: "translateY(-30px) scale(0.5)" },
        },
      },
    },
  },
  // プラグイン設定
  plugins: [require("@tailwindcss/forms"), require("@tailwindcss/typography")],
  // 重要: JITモードでのsafelist設定（必要に応じて）
  safelist: [
    // グラデーション関連
    "bg-gradient-to-r",
    "bg-gradient-to-br",
    "from-sky-400",
    "from-sky-500",
    "from-sky-600",
    "from-sky-800",
    "via-blue-700",
    "via-blue-900",
    "to-blue-500",
    "to-blue-600",
    "to-indigo-800",
    "to-indigo-950",
    "bg-clip-text",
    "text-transparent",
    // お知らせバッジ用の背景色
    "bg-red-500",
    "bg-orange-500",
    "bg-yellow-500",
    "bg-yellow-600",
    "bg-blue-500",
    // Claymorphism
    "shadow-clay-card",
    "shadow-clay-floating",
    "shadow-clay-btn-blue",
    "shadow-clay-btn-orange",
    "shadow-clay-icon",
    "shadow-clay-inner",
  ],
};
</file>

<file path=".docs/DESIGN_SYSTEM_LIGHT.md">
# Role

あなたは世界最高峰のフロントエンドエンジニア兼 UI デザイナーです。
既存の機能要件および**既存のダークモード設定**を完全に維持したまま、指定されたデザインシステム（ライトモード用）を適用してください。

# ⚠️ Critical Constraints (絶対厳守の制約事項)

作業を行うにあたり、以下のルールを絶対に守ってください。機能や既存のダークモード表示を破壊することは許されません。

1. **ロジックの保全:**

   - JavaScript / TypeScript / Ruby(ERB) / PHP などのロジックコードは一切変更・削除しないでください。
   - `onClick`, `onSubmit`, `onChange` などのイベントハンドラ属性は絶対に触らないでください。

2. **DOM 構造と識別子の維持:**

   - `id` 属性、`data-` 属性は絶対に変更・削除しないでください（JS からの参照維持のため）。

3. **【最重要】ダークモード設定の完全保護:**

   - **`dark:` プレフィックスが付いているクラスは、いかなる理由があっても削除・変更しないでください。**
   - 今回適用するデザインは「ライトモード（Default）」用です。追加・変更するスタイルが、ダークモード時の表示を崩さないようにしてください。
   - 必要であれば、変更するプロパティに対して明示的に `dark:既存の色` などを再定義し、ライトモード用の変更がダークモードに漏れ出さないようにコードを調整してください。

4. **変更の範囲:**
   - 変更してよいのは「Tailwind CSS のクラス」と「装飾目的の HTML 構造」のみです。
   - テキストコンテンツは変更しないでください。

---

# Design System: Crystal Claymorphism (Light Mode)

## 🎨 Design Concept

**「触りたくなるような柔らかさと、キャンディのような透明感（ポップ × クリア × わくわく）」**

- **Keywords:** Claymorphism（クレイモーフィズム）, Crystal Clear（透明感）, Candy Color（キャンディカラー）, Soft & Pop.

---

## 🛠️ Foundations (基本設定)

### 1. Shape (形状)

鋭利な角を排除し、徹底的に「柔らかさ」を強調する。

- **基本:** `rounded-3xl` (24px) 以上。
- **カード:** `rounded-[2.5rem]` (40px)
- **特別/大型カード:** `rounded-[3.75rem]` (60px)
- **ボタン:** `rounded-full` (完全な円/カプセル)

### 2. Color Palette (カラーパレット)

- **Base (背景):** `bg-[#fdfbf7]` (Warm White) や `bg-slate-50`。
- **Shadow (影):** 各要素のテーマカラーに合わせる（青なら青い影）。黒い影は使わない。
- **Icon (アイコン):** 鮮やかな原色に近い色（`text-blue-500`, `text-orange-500`）を使用し、ポップさを維持する。

### 3. Typography (タイポグラフィ)

- **見出し (Title):**
  - 視認性を最優先し、`text-slate-800` などの濃い色を使用。
  - **重要:** ダークモードのネオン表現と共存させるため、必ず `class="text-slate-800 dark:text-transparent dark:bg-clip-text ..."` と記述する。
- **数字 (Numbers):**
  - データの数字はグラデーションテキスト (`bg-clip-text text-transparent`) を使用し、ポップさを演出する。

---

## ✨ Core Visual Effects (実装ルール)

**「触りたくなるような、ぷるぷるとしたキャンディーの質感」**を以下の要素の組み合わせで実現する。これらは**セットで適用**すること。

### 1. Crystal Shadow (3-Layer Shadow)

単なる影ではなく、**「浮遊感」「ハイライト」「ぷっくり感」**を同時に表現する 3 層構造のシャドウ。

- **Layer 1 (Drop Shadow):** 右下にテーマカラーの半透明影 (`20px 20px 60px rgba(Color, 0.2)`)
- **Layer 2 (Highlight Shadow):** 左上に強い白の影 (`-20px -20px 60px rgba(255, 255, 255, 0.8)`)
- **Layer 3 (Puffy Inset):** 内側にぷっくり感を出すインセット影 (`inset -5px -5px 15px rgba(Color, 0.05), inset 5px 5px 15px rgba(255, 255, 255, 0.9)`)

```css
shadow-[20px_20px_60px_rgba(59,130,246,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(59,130,246,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9)]
```

### 2. Crystal Rim (クリスタルリム)

カードのフチは、**「白いハイライト」**と**「色の反射」**を分けて表現する。

- **Border:** 白の半透明 (`border-2 border-white/60`) でハイライトを入れる。
- **Color Reflection:** 左上からの極細のインセットシャドウ (`inset 2px 2px 0px rgba(Color, 0.3)`) で、ガラスの中に色が閉じ込められているような表現をする。

### 3. Candy Texture (キャンディー質感)

透明感と光沢を出す。

1.  **White Gradient Overlay:** 背景に白から透明へのグラデーションを重ねる (`bg-gradient-to-br from-white/80 via-white/40 to-transparent`)。
    - **重要:** ダークモードでは必ず無効化する (`dark:bg-none`)。
2.  **Blurry Gradient Orbs:** カードの隅に、テーマカラーのぼかし円（オーブ）を配置する。
    - `<div class="absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br from-Color/20 to-Color/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>`

### 4. Glass Cover (光沢)

カードの上部に薄い光沢を追加し、ガラスのような質感を表現する（特に統計ページなどのプレミアムカードで推奨）。

- `before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent`

### 5. Card Depth & Rim Light (立体表現)

アクションの性質に応じて、カードの立体感を使い分ける。

1.  **Convex (凸 / 浮き出し):**

    - **用途:** ポジティブなアクション（追加、作成、インストールなど）。
    - **表現:** 通常のドロップシャドウを使用。
    - **Strong Rim Light:** 左と上のフチを太く (`border-l-4 border-t-4 border-white`) し、右と下を影色 (`border-r-purple-100` 等) にすることで、強い光の反射と立体感を強調する。
      - ※**White-on-White**（白背景に白カード）の場合の視認性向上テクニックとして推奨。背景色が濃い場合は通常の `border-2` で十分。

2.  **Concave (凹 / へこみ):**
    - **用途:** ネガティブなアクション（削除、警告）や、情報の埋め込み。
    - **表現:** `shadow-inner` や `inset` シャドウを使用し、背景に沈み込ませる。
    - **Rim:** フチは細く控えめにし、内側の影を強調する。

---

## 🧩 Component Guidelines

### Premium Crystal Card (Stats/Dashboard)

統計ページなどの「データを見せる」画面で使用する、発展形のスタイル。

- **Shape:** `rounded-[3.75rem]` (60px)
- **Shadow:** `shadow-clay-card` (opacity 0.1~0.3) を使用し、影を「濃く」するのではなく「薄く、広く」拡散させる。
- **Dark Mode Safety:** ライト/ダークで `rounded` の値を変えないこと。影は `shadow-clay-card` (ライト) と `dark:shadow-[...]` (ダーク) で完全に分離する。

### Rich Glass Button (Action Button)

「新しい散歩を記録する」ボタンなどで使用される、強調アクション用ボタン。

- **特徴:** 色付きのドロップシャドウで「発光」と「浮遊感」を表現。内側のハイライト (`inset`) と半透明ボーダーで「ガラスの厚み」を表現。
- **Interaction:** `hover:scale-105` + `hover:-translate-y-1`。

### Podium / Crystal Pillar (Ranking)

ランキングの表彰台や垂直プログレスバーに使用。

- **Concept:** 色付きの液体が入った厚いガラス容器。
- **Shape:** `rounded-t-[2.5rem]` to `rounded-t-[3.5rem]` (上部を強く丸める)。
- **Texture:** `border-4 border-white/60` (ガラスケース) + 強い `inset` シャドウ (液体の深み)。

---

## 🌊 Animation & Interaction

### 1. Sunny Sky Background (共通背景)

- **概要:** 「ひだまりの空」をテーマにした、雲がゆっくりと流れるアニメーション背景。
- **実装:** `app/views/shared/_animated_background.html.erb`
- **適用:** `layouts/application.html.erb`
- **制約:** ライトモード専用。ダークモードでは `dark:hidden`。

### 2. Physics Carousel & Drag Scroll

- **Physics Carousel:** `carousel_controller.js`。慣性スクロールとバウンス効果。
- **Drag Scroll:** `scroll_drag_controller.js`。PC でのマウスドラッグスクロール。

### 3. Micro-interactions

- **Hover:** `hover:scale-105` (少し膨らむ) + 影の色を少し濃くする。
- **Active:** `active:scale-95` (押される)。

---

## 📝 Implementation Guide (実装ガイド)

### プロンプト例

> 「UI デザインは『Crystal Claymorphism』テーマを採用してください。
> 具体的には、TailwindCSS を使用して以下の特徴を持たせてください：
>
> 1. **カラーシャドウ:** `box-shadow` の影色には黒を使わず、要素のテーマカラー（青、オレンジ等）の半透明色 (`rgba(..., 0.2)`) を使用して透明感を出す。
> 2. **ぷっくり感:** `radial-gradient` で中央を明るくし、`inset` シャドウで縁の丸みを強調する。
> 3. **輪郭:** ボーダーには `rgba(255, 255, 255, 0.6)` を使用し、背景との境界を適度にはっきりさせる。
> 4. **形状:** 角丸は `rounded-[2.5rem]` (40px) を基本とし、特別なカードには `rounded-[3.75rem]` (60px) を使用する。
> 5. **アイコン:** 鮮やかな色 (`text-blue-500` 等) を使用し、黒くしない。」

### ダークモード保護 (Dark Mode Safety)

Crystal Claymorphism は**ライトモード専用**のデザインである。

- ライトモード用の装飾（Orbs, Gradient Overlay, Light Shadows）は、ダークモードでは**完全に非表示・無効化**すること。
- `dark:hidden`, `dark:bg-none`, `dark:shadow-none` を徹底する。
</file>

<file path="app/controllers/admin/dashboard_controller.rb">
class Admin::DashboardController < Admin::BaseController
  skip_before_action :require_admin
  before_action :require_admin_or_guest

  def index
    # ユーザー統計
    @total_users = User.count
    @users_this_month = User.where(created_at: Time.current.beginning_of_month..Time.current).count
    @active_users_today = User.where("current_sign_in_at >= ?", Time.current.beginning_of_day).count

    if current_user.guest?
      # ゲスト用ダミーデータ
      # アクティブユーザーリストもダミーにする
      @active_users_today_list = ["ユーザーA", "ユーザーB", "ユーザーC"]

      # 統計情報の非表示やダミー化が必要ならここで行うが、
      # グローバル統計は見せても良い方針なのでそのまま

      @active_users_this_week = 1234 # User.where(...).count
      @active_users_this_month = 5678

      # 投稿統計
      @total_posts = 9876
      @posts_today = 123
      @posts_this_month = 456

      # 散歩統計
      @total_walks = 5432
      @total_distance = 12345.6
      @distance_this_month = 789.0

      # === リスト系のダミー化（ぼかし表示の下に置くためそれっぽいデータ） ===
      @popular_posts = create_dummy_posts(5)
      @recent_posts = create_dummy_posts(5)
      @recent_users = create_dummy_users(5)

      # === 異常検知（ダミー） ===
      generate_dummy_anomalies
    else
      # 管理者用（リアルデータ）
      @active_users_today_list = User.where("current_sign_in_at >= ?", Time.current.beginning_of_day)
                                      .order(current_sign_in_at: :desc)
                                      .limit(3)
                                      .pluck(:name)
      @active_users_this_week = User.where("current_sign_in_at >= ?", Time.current.beginning_of_week).count
      @active_users_this_month = User.where("current_sign_in_at >= ?", Time.current.beginning_of_month).count

      # 投稿統計
      @total_posts = Post.count
      @posts_today = Post.where(created_at: Time.current.beginning_of_day..Time.current).count
      @posts_this_month = Post.where(created_at: Time.current.beginning_of_month..Time.current).count

      # 散歩統計
      @total_walks = Walk.count
      @total_distance = Walk.sum(:distance) || 0
      @distance_this_month = Walk.where(walked_on: Time.current.beginning_of_month.to_date..Time.current.to_date).sum(:distance) || 0

      # 人気投稿
      @popular_posts = Post.left_joins(:reactions)
                           .select("posts.*, COUNT(reactions.id) as reactions_count")
                           .group("posts.id")
                           .order("reactions_count DESC")
                           .limit(5)
                           .includes(user: { uploaded_avatar_attachment: :blob })

      # 最近の投稿
      @recent_posts = Post.order(created_at: :desc).limit(5).includes(user: { uploaded_avatar_attachment: :blob })

      # 最近のユーザー
      @recent_users = User.order(created_at: :desc).limit(5)

      # 異常検知
      detect_anomalies
    end
  end

  private

  def create_dummy_posts(count)
    (1..count).map do |i|
      OpenStruct.new(
        id: i,
        body: "これはダミーの投稿です。内容は表示されません。",
        created_at: Time.current - i.hours,
        user: OpenStruct.new(
          name: "ダミーユーザー#{i}",
          email: "dummy#{i}@example.com",
          display_avatar_url: nil
        ),
        reactions_count: rand(1..100),
        weather_label: "晴れ",
        feeling_label: "最高"
      )
    end
  end

  def create_dummy_users(count)
    (1..count).map do |i|
      OpenStruct.new(
        id: i,
        name: "新規ユーザー#{i}",
        email: "user#{i}@example.com",
        created_at: Time.current - i.days,
        current_sign_in_at: Time.current - i.hours,
        display_avatar_url: nil
      )
    end
  end

  def generate_dummy_anomalies
    @anomalies = {}

    # 1. スパム疑い
    @anomalies[:spam_users] = [
      OpenStruct.new(id: 1, name: "SpamBot01", email: "bot1@example.com", post_count: 25, created_at: 1.day.ago, current_sign_in_at: Time.current, display_avatar_url: nil),
      OpenStruct.new(id: 2, name: "AggressiveUser", email: "agg@example.com", post_count: 22, created_at: 2.days.ago, current_sign_in_at: Time.current, display_avatar_url: nil)
    ]

    # 2. データ整合性エラー (Walkのダミー)
    @anomalies[:invalid_walks] = [
      OpenStruct.new(
        id: 101, distance: 55000, steps: 100000,
        user: OpenStruct.new(id: 3, name: "WalkerPRO", email: "walk@example.com", display_avatar_url: nil)
      )
    ]

    # 3. セキュリティ懸念
    @anomalies[:security_concern] = [
      OpenStruct.new(id: 4, name: "HackedAccount?", email: "old@example.com", post_count: 0, created_at: 1.year.ago, current_sign_in_at: 35.days.ago, display_avatar_url: nil)
    ]

    # 4. 非アクティブアカウント（ダミーでは空）
    @anomalies[:inactive_accounts] = []

    @total_anomalies = @anomalies.values.sum { |v| v.to_a.size }
  end

  def detect_anomalies
    @anomalies = {}
    # ... (元のロジック)

    # 1. スパム疑いユーザー
    spam_users = User.joins(:posts)
                     .where("posts.created_at >= ?", 24.hours.ago)
                     .group("users.id")
                     .having("COUNT(posts.id) >= 20")
                     .select("users.*, COUNT(posts.id) as post_count")

    new_user_spam = User.joins(:posts)
                        .where("users.created_at >= ?", 1.hour.ago)
                        .group("users.id")
                        .having("COUNT(posts.id) >= 5")
                        .select("users.*, COUNT(posts.id) as post_count")

    @anomalies[:spam_users] = (spam_users + new_user_spam).uniq

    # 2. データ整合性エラー
    @anomalies[:invalid_walks] = Walk.where("distance > 50000 OR steps > 100000")
                                     .includes(:user)
                                     .limit(10)

    # 3. セキュリティ懸念（最終ログイン30日以上前なのに最近7日以内に投稿）
    @anomalies[:security_concern] = User.joins(:posts)
                                        .where("users.current_sign_in_at < ?", 30.days.ago)
                                        .where("posts.created_at >= ?", 7.days.ago)
                                        .distinct
                                        .limit(10)

    # 異常の総数を計算
    @total_anomalies = @anomalies.values.sum { |v| v.to_a.size }
  end
end
</file>

<file path="app/helpers/share_helper.rb">
module ShareHelper
  # X（旧Twitter）でシェアするURLを生成
  # @param text [String] ツイート本文
  # @param url [String] シェアするURL（省略可）
  # @param hashtags [Array<String>] ハッシュタグ（省略可）
  # @return [String] Twitter Web Intent URL
  def twitter_share_url(text:, url: nil, hashtags: [])
    params = {
      text: text,
      url: url,
      hashtags: hashtags.join(",")
    }.compact

    "https://twitter.com/intent/tweet?#{params.to_query}"
  end

  # 投稿をXでシェアするURLを生成
  def share_post_on_twitter_url(post)
    user = post.user

    # 投稿に関連する散歩記録を取得
    walk = post.walk || user.walks.find_by(walked_on: post.created_at.to_date)

    # 距離を取得 (km単位)
    distance_km = walk&.distance || 0.0
    steps = walk&.steps || 0

    # 今月のランキング順位
    rankings = User.ranking(period: "monthly", limit: 1000).to_a
    user_in_ranking = rankings.find { |u| u.id == user.id }

    rank_str = "-"
    if user_in_ranking
      my_dist = user_in_ranking.total_distance.to_f
      higher_rankers = rankings.count { |u| u.total_distance.to_f > my_dist }
      rank_str = "#{higher_rankers + 1}th"
    end

    # メッセージ（投稿本文があれば優先、なければランダム）
    # 改行をスペースに置換して1行にする（Xでの表示崩れ防止と文字数節約のため）
    message = post.body.present? ? "「#{post.body.gsub(/\R/, ' ').truncate(30)}」" : get_flavor_text(distance_km)

    # 投稿詳細ページのURLを含める（OGP画像表示のため）
    post_url = post_url(post, host: request.host, protocol: request.protocol)

    text = generate_rpg_text(distance: distance_km, rank: rank_str, message: message, steps: steps)
    # URLとハッシュタグの間に改行を入れるため、ハッシュタグをテキストに含める
    text += "\n#てくメモ #RUNTEQ #散歩"
    twitter_share_url(text: text, url: post_url)
  end

  # ランキングをXでシェアするURLを生成
  def share_ranking_on_twitter_url(user:, rank:, distance:, period: "monthly")
    distance_km = (distance / 1000.0).round(2)
    rank_str = rank ? "#{rank}位" : "-"

    # ランキングシェア時はランダムフレーバーテキスト
    message = get_ranking_flavor_text(rank)

    # ランキングページのURLを含める（OGP画像表示のため）
    # 環境に応じて動的にURLを生成
    ranking_url = rankings_url(host: request.host, protocol: request.protocol, user_id: user.id)

    text = generate_rpg_text(distance: distance_km, rank: rank_str, message: message, type: :ranking)
    twitter_share_url(text: text, url: ranking_url)
  end

  private

  def get_flavor_text(distance_km)
    flavor_texts = [
      "「いい気分転換になった！」",
      "「明日はどこまで行こうかな？」",
      "「継続は力なり！ナイス！」",
      "「歩いた後のご飯は美味しいぞ！」"
    ]
    # 5km以上歩いた時のレアメッセージ
    flavor_texts << "「伝説級のウォーキングだ...！」" if distance_km > 5.0
    flavor_texts.sample
  end

  def get_ranking_flavor_text(rank)
    case rank
    when 1
      "「栄光の第1位！素晴らしい！」"
    when 2..3
      "「トップ3入り！すごい！」"
    when 4..10
      "「トップ10入り！頑張った！」"
    else
      "「今週もお疲れ様でした！」"
    end
  end

  def generate_rpg_text(distance:, rank:, message:, type: :quest, steps: 0)
    exp = steps > 0 ? steps : (distance * 100).to_i

    if type == :ranking
      <<~TEXT
        🏆 𝐑𝐀𝐍𝐊𝐈𝐍𝐆 𝐂𝐇𝐀𝐌𝐏𝐈𝐎𝐍 🏆

        👟 𝐃𝐢𝐬𝐭𝐚𝐧𝐜𝐞 : #{distance}km
        👑 𝐑𝐚𝐧𝐤𝐢𝐧𝐠  : #{rank}

        💬 #{message}
        ━━━━━━━━━━━━
        ━━━━━━━━━━━━
      TEXT
    else
      <<~TEXT
        ✨ 𝐐𝐔𝐄𝐒𝐓 𝐂𝐎𝐌𝐏𝐋𝐄𝐓𝐄 ✨

        👟 𝐃𝐢𝐬𝐭𝐚𝐧𝐜𝐞 : #{distance}km
        👑 𝐑𝐚𝐧𝐤𝐢𝐧𝐠  : #{rank}

        ⚔️ 獲得経験値... #{exp} exp
        💬 #{message}
        ━━━━━━━━━━━━
        👇
      TEXT
    end
  end
end
</file>

<file path="app/views/walks/_form.html.erb">
<%# app/views/walks/_form.html.erb %>
<%# Google Fit JSの「Stimulus化」  by Gemini3 %>

<div data-controller="google-fit" class="w-full">

  <!-- Google Fit連携エリア（ボタンのみシンプルに配置） -->
  <div class="mb-8">
    <% if current_user.google_token_valid? %>
      <div class="relative group">
        <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-cyan-500 rounded-xl blur opacity-30 group-hover:opacity-75 transition duration-200"></div>
        <button type="button"
                data-google-fit-target="button"
                data-action="click->google-fit#fetch"
                class="relative w-full bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#e0f2fe_90%)] dark:bg-none dark:bg-slate-900/80 backdrop-blur-xl text-gray-800 dark:text-white font-bold py-4 px-6 rounded-[3.75rem] shadow-[10px_10px_20px_rgba(14,165,233,0.2),-10px_-10px_20px_#ffffff,inset_-5px_-5px_10px_rgba(14,165,233,0.1),inset_5px_5px_10px_rgba(255,255,255,0.7)] hover:shadow-[15px_15px_30px_rgba(14,165,233,0.3),-15px_-15px_30px_#ffffff] dark:shadow-[0_0_20px_rgba(34,211,238,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] transition-all flex items-center justify-between group-hover:scale-[1.02] dark:group-hover:bg-slate-800/80 border-2 border-white/60 dark:border-cyan-500/30 dark:border-t-white/40 overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
          <div class="flex items-center space-x-3 relative z-10">
            <div class="bg-blue-100 dark:bg-cyan-900/50 p-2 rounded-full text-blue-600 dark:text-cyan-400 dark:shadow-[0_0_10px_rgba(34,211,238,0.5)]">
              <span class="material-symbols-outlined">fitness_center</span>
            </div>
            <div class="text-left">
              <span class="block text-sm text-gray-500 dark:text-slate-400 font-normal">Google Fit連携中</span>
              <span class="block text-base">データを自動入力する</span>
            </div>
          </div>
          <span class="material-symbols-outlined text-gray-400 group-hover:text-blue-500 dark:group-hover:text-cyan-400 transition-colors relative z-10">download</span>
        </button>
      </div>
      <span data-google-fit-target="status" class="block mt-2 text-center text-sm font-bold text-blue-600 dark:text-cyan-400 empty:hidden"></span>

    <% else %>
      <%= link_to user_google_oauth2_omniauth_authorize_path,
          data: { turbo: false },
          class: "w-full bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#f3f4f6_90%)] dark:bg-none dark:bg-slate-800/80 backdrop-blur-xl hover:shadow-[10px_10px_20px_rgba(156,163,175,0.2),-10px_-10px_20px_#ffffff] dark:hover:bg-slate-700/80 text-gray-700 dark:text-slate-200 font-bold py-4 px-6 rounded-[3.75rem] shadow-[5px_5px_15px_rgba(156,163,175,0.1),-5px_-5px_15px_#ffffff,inset_-2px_-2px_5px_rgba(156,163,175,0.05),inset_2px_2px_5px_rgba(255,255,255,0.5)] dark:shadow-[0_0_20px_rgba(255,255,255,0.1),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] transition-all flex items-center justify-center space-x-3 border-2 border-white/60 dark:border-slate-700 dark:border-t-white/30 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none" do %>
        <svg class="w-6 h-6 relative z-10" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        <span class="relative z-10">Google Fitと連携して自動入力</span>
      <% end %>
    <% end %>

  </div>

  <!-- Google Fit連携の注意書き（プレビュー版） -->
  <%= render "shared/google_fit_notice" %>

  <!-- Google認証警告ガイド -->
  <%= render "shared/google_auth_guide" %>

  <!-- エラーメッセージ -->
  <% if walk.errors.any? %>
    <div class="mt-6 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg shadow-sm mb-8 animate-pulse">
      <h3 class="font-bold flex items-center">
        <span class="material-symbols-outlined mr-2">error</span>
        入力内容に <%= pluralize(walk.errors.count, "件") %> のエラーがあります
      </h3>
      <ul class="list-disc list-inside mt-2 ml-2 space-y-1 text-sm">
        <% walk.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- 入力フォーム -->
  <%= form_with(model: walk, class: "space-y-8") do |form| %>

    <!-- 日付 -->
    <div class="relative">
      <%= form.label :walked_on, "散歩日", class: "block text-sm font-bold text-gray-500 dark:text-slate-400 mb-1 ml-1" %>
      <div class="relative group">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <span class="material-symbols-outlined text-gray-400 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-purple-300 dark:to-pink-300 dark:drop-shadow-[0_0_8px_rgba(192,132,252,0.8)] group-focus-within:text-cyan-500 dark:group-focus-within:text-cyan-400 transition-colors">calendar_today</span>
        </div>
        <%= form.date_field :walked_on,
            id: "walk_walked_on",
            data: { google_fit_target: "date" },
            onclick: "this.showPicker()",
            class: "block w-full pl-12 pr-4 py-4 bg-white/50 dark:bg-slate-900/50 border-2 border-white/60 dark:border-slate-700 rounded-[3.75rem] focus:ring-0 focus:border-cyan-500 dark:focus:border-purple-500 dark:focus:shadow-[0_0_15px_rgba(168,85,247,0.3)] text-gray-900 dark:text-white placeholder-gray-400 transition-all shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-none text-lg font-medium cursor-pointer" %>
      </div>
    </div>

    <!-- 時間帯選択 (Icon Select) -->
    <div class="relative" data-controller="icon-select"
         data-icon-select-selected-class="bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#ffedd5_90%)] dark:bg-none border-white/60 text-orange-600 dark:bg-purple-900/60 dark:border-purple-400 dark:text-purple-300 shadow-[5px_5px_15px_rgba(249,115,22,0.2),-5px_-5px_15px_#ffffff,inset_-2px_-2px_5px_rgba(249,115,22,0.1),inset_2px_2px_5px_rgba(255,255,255,0.7)] transform scale-[1.02] dark:shadow-[0_0_15px_rgba(168,85,247,0.4)] relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none"
         data-icon-select-unselected-class="bg-white/50 dark:bg-slate-900/50 border-white/40 dark:border-slate-700 text-gray-400 dark:text-slate-500 hover:bg-white/80 dark:hover:bg-slate-800 hover:border-white/60 dark:hover:border-slate-600 shadow-sm">

      <%= form.label :time_of_day, "時間帯", class: "block text-sm font-bold text-gray-500 dark:text-slate-400 mb-2 ml-1" %>

      <div class="grid grid-cols-4 gap-2 sm:gap-4">
        <% Walk.time_of_days.keys.each do |key| %>
          <%
            icon_name = case key
                        when "early_morning" then "wb_twilight"
                        when "day" then "sunny"
                        when "evening" then "wb_twilight"
                        when "night" then "dark_mode"
                        end
            # 翻訳キーは後で追加するが、とりあえずデフォルト値を設定
            label_text = t("enums.walk.time_of_day.#{key}", default: key.humanize)
          %>

          <!-- 隠しラジオボタン -->
          <%= form.radio_button :time_of_day, key, class: "hidden", data: { icon_select_target: "input" } %>

          <!-- アイコンボタン -->
          <button type="button"
                  data-icon-select-target="button"
                  data-action="click->icon-select#select"
                  data-value="<%= key %>"
                  class="flex flex-col items-center justify-center p-3 rounded-[2.5rem] border-2 transition-all duration-200 group h-20 sm:h-24 overflow-hidden normal-case">
            <span class="material-symbols-outlined text-2xl sm:text-3xl mb-1 transition-colors"><%= icon_name %></span>
            <span class="text-[10px] sm:text-xs font-bold"><%= label_text %></span>
          </button>
        <% end %>
      </div>
    </div>

    <!-- 場所 -->
    <div class="relative">
      <%= form.label :location, "場所", class: "block text-sm font-bold text-gray-500 dark:text-slate-400 mb-1 ml-1" %>
      <div class="relative group">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <span class="material-symbols-outlined text-gray-400 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-purple-300 dark:to-pink-300 dark:drop-shadow-[0_0_8px_rgba(192,132,252,0.8)] group-focus-within:text-cyan-500 dark:group-focus-within:text-cyan-400 transition-colors">location_on</span>
        </div>
        <%= form.text_field :location,
            placeholder: "例: 代々木公園",
            class: "block w-full pl-12 pr-4 py-4 bg-white/50 dark:bg-slate-900/50 border-2 border-white/60 dark:border-slate-700 rounded-[3.75rem] focus:ring-0 focus:border-cyan-500 dark:focus:border-purple-500 dark:focus:shadow-[0_0_15px_rgba(168,85,247,0.3)] text-gray-900 dark:text-white placeholder-gray-400 transition-all shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-none text-lg" %>
      </div>
    </div>

    <!-- 数値入力グリッド（スマホ2列 / PC2列） -->
    <div class="grid grid-cols-2 gap-4 sm:gap-6">
      <!-- 距離 -->
      <div>
        <%= form.label :distance, class: "flex items-center text-sm font-bold text-gray-500 dark:text-slate-400 mb-1 ml-1" do %>
          <span>距離</span>
          <span class="ml-2 bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400 text-[10px] px-2 py-0.5 rounded-full font-bold">必須</span>
        <% end %>
        <div class="relative group">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <span class="material-symbols-outlined text-gray-400 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-emerald-300 dark:to-green-300 dark:drop-shadow-[0_0_8px_rgba(16,185,129,0.8)] group-focus-within:text-cyan-500 dark:group-focus-within:text-cyan-400 transition-colors">route</span>
          </div>
          <%= form.number_field :distance,
              id: "walk_distance",
              step: 0.01,
              data: { google_fit_target: "distance" },
              placeholder: "0.0",
              class: "block w-full pl-12 pr-12 bg-white/50 dark:bg-slate-900/50 border-2 border-white/60 dark:border-slate-700 rounded-[3.75rem] focus:ring-0 focus:border-cyan-500 dark:focus:border-emerald-500 dark:focus:shadow-[0_0_15px_rgba(16,185,129,0.3)] text-gray-900 dark:text-white placeholder-gray-400 transition-all shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-none text-lg sm:text-xl font-bold text-right" %>
          <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
            <span class="text-gray-400 text-sm font-bold">km</span>
          </div>
        </div>
      </div>

      <!-- 時間 -->
      <div>
        <%= form.label :duration, class: "flex items-center text-sm font-bold text-gray-500 dark:text-slate-400 mb-1 ml-1" do %>
          <span>時間</span>
          <span class="ml-2 bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400 text-[10px] px-2 py-0.5 rounded-full font-bold">必須</span>
        <% end %>
        <div class="relative group">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <span class="material-symbols-outlined text-gray-400 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-cyan-300 dark:to-blue-300 dark:drop-shadow-[0_0_8px_rgba(34,211,238,0.8)] group-focus-within:text-cyan-500 dark:group-focus-within:text-cyan-400 transition-colors">schedule</span>
          </div>
          <%= form.number_field :duration,
              id: "walk_duration",
              data: { google_fit_target: "duration" },
              placeholder: "0",
              class: "block w-full pl-12 pr-12 bg-white/50 dark:bg-slate-900/50 border-2 border-white/60 dark:border-slate-700 rounded-[3.75rem] focus:ring-0 focus:border-cyan-500 dark:focus:border-cyan-500 dark:focus:shadow-[0_0_15px_rgba(6,182,212,0.3)] text-gray-900 dark:text-white placeholder-gray-400 transition-all shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-none text-lg sm:text-xl font-bold text-right" %>
          <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
            <span class="text-gray-400 text-sm font-bold">分</span>
          </div>
        </div>
      </div>

      <!-- 歩数 -->
      <div>
        <%= form.label :steps, "歩数", class: "block text-sm font-bold text-gray-500 dark:text-slate-400 mb-1 ml-1" %>
        <div class="relative group">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <span class="material-symbols-outlined text-gray-400 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-purple-300 dark:to-fuchsia-300 dark:drop-shadow-[0_0_8px_rgba(168,85,247,0.8)] group-focus-within:text-cyan-500 dark:group-focus-within:text-cyan-400 transition-colors">directions_walk</span>
          </div>
          <%= form.number_field :steps,
              id: "walk_steps",
              data: { google_fit_target: "steps" },
              placeholder: "0",
              class: "block w-full pl-12 pr-12 bg-white/50 dark:bg-slate-900/50 border-2 border-white/60 dark:border-slate-700 rounded-[3.75rem] focus:ring-0 focus:border-cyan-500 dark:focus:border-purple-500 dark:focus:shadow-[0_0_15px_rgba(168,85,247,0.3)] text-gray-900 dark:text-white placeholder-gray-400 transition-all shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-none text-lg sm:text-xl font-bold text-right" %>
          <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
            <span class="text-gray-400 text-sm font-bold">歩</span>
          </div>
        </div>
      </div>

      <!-- カロリー -->
      <div>
        <%= form.label :calories_burned, "カロリー", class: "block text-sm font-bold text-gray-500 dark:text-slate-400 mb-1 ml-1" %>
        <div class="relative group">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <span class="material-symbols-outlined text-gray-400 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-orange-300 dark:to-red-300 dark:drop-shadow-[0_0_8px_rgba(251,146,60,0.8)] group-focus-within:text-cyan-500 dark:group-focus-within:text-cyan-400 transition-colors">local_fire_department</span>
          </div>
          <%= form.number_field :calories_burned,
              id: "walk_calories_burned",
              data: { google_fit_target: "calories" },
              placeholder: "0",
              class: "block w-full pl-12 pr-16 bg-white/50 dark:bg-slate-900/50 border-2 border-white/60 dark:border-slate-700 rounded-[3.75rem] focus:ring-0 focus:border-cyan-500 dark:focus:border-rose-500 dark:focus:shadow-[0_0_15px_rgba(244,63,94,0.3)] text-gray-900 dark:text-white placeholder-gray-400 transition-all shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-none text-lg sm:text-xl font-bold text-right" %>
          <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
            <span class="text-gray-400 text-sm font-bold">kcal</span>
          </div>
        </div>
      </div>
    </div>

    <!-- メモ -->
    <div>
      <%= form.label :notes, "メモ", class: "block text-sm font-bold text-gray-500 dark:text-slate-400 mb-1 ml-1" %>
      <%= form.text_area :notes,
          rows: 4,
          placeholder: "今日の散歩の感想...",
          class: "block w-full px-4 py-4 bg-white/50 dark:bg-slate-900/50 border-2 border-white/60 dark:border-slate-700 rounded-3xl focus:ring-0 focus:border-cyan-500 dark:focus:border-purple-500 dark:focus:shadow-[0_0_15px_rgba(168,85,247,0.3)] text-gray-900 dark:text-white placeholder-gray-400 transition-all shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-none resize-none text-base" %>
    </div>

    <!-- アクションボタン -->
    <div class="flex flex-col sm:flex-row gap-4 pt-6">
      <%= form.submit "保存する", class: "flex-1 bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#e0f2fe_90%)] dark:bg-none dark:bg-gradient-to-r dark:from-fuchsia-600 dark:to-purple-600 dark:hover:from-fuchsia-500 dark:hover:to-purple-500 text-blue-600 dark:text-white font-bold py-4 px-6 rounded-[3.75rem] shadow-[10px_10px_20px_rgba(14,165,233,0.2),-10px_-10px_20px_#ffffff,inset_-5px_-5px_10px_rgba(14,165,233,0.1),inset_5px_5px_10px_rgba(255,255,255,0.7)] hover:shadow-[15px_15px_30px_rgba(14,165,233,0.3),-15px_-15px_30px_#ffffff] dark:shadow-[0_0_20px_rgba(192,38,211,0.5),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] transition-all transform hover:-translate-y-1 cursor-pointer text-lg border-2 border-white/60 dark:border-fuchsia-500/30 dark:border-t-white/40 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse" %>

      <%= link_to "キャンセル", walks_path,
          class: "flex-1 text-center bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#f3f4f6_90%)] dark:bg-none dark:hover:bg-slate-800/80 text-gray-600 dark:text-slate-400 font-bold py-4 px-6 rounded-[3.75rem] shadow-[5px_5px_15px_rgba(156,163,175,0.1),-5px_-5px_15px_#ffffff,inset_-2px_-2px_5px_rgba(156,163,175,0.05),inset_2px_2px_5px_rgba(255,255,255,0.5)] hover:shadow-[10px_10px_20px_rgba(156,163,175,0.2),-10px_-10px_20px_#ffffff] transition-all border-2 border-white/60 dark:border-white/5 dark:border-t-white/20 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none" %>
    </div>

  <% end %>
</div>
</file>

<file path="app/views/walks/index.html.erb">
<% content_for :title, "散歩記録一覧 - てくメモ" %>

<div class="flex-1 p-4 pb-24 w-full max-w-2xl mx-auto">
  <!-- ページタイトル（レスポンシブ） -->
  <div class="mb-6 md:mb-8 flex items-center justify-between">
    <div class="flex-1">
      <!-- PC用: 大きなタイトルとサブタイトル -->
      <div class="hidden md:block">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white flex items-center space-x-3">
          <span class="material-symbols-outlined text-4xl text-orange-400 dark:text-purple-400 drop-shadow-sm dark:drop-shadow-[0_0_10px_rgba(168,85,247,0.8)] animate-bounce-slow">footprint</span>
          <span class="text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-pink-500 dark:from-purple-400 dark:to-pink-400 drop-shadow-sm">散歩記録</span>
        </h1>
        <p class="text-sm text-gray-500 dark:text-purple-200/70 mt-1 ml-1 font-medium">あなたの足跡、ひとつひとつ。</p>
      </div>

      <!-- スマホ用: シンプルなタイトル -->
      <div class="md:hidden">
        <h1 class="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-pink-500 dark:from-purple-400 dark:to-pink-400 tracking-tight drop-shadow-sm">
          散歩記録
        </h1>
      </div>
    </div>

    <!-- スマホ用: 小さな記録ボタン（右上）-->
    <div class="md:hidden flex items-center gap-2">
      <%= link_to import_google_fit_walks_path, data: { turbo_method: :post, turbo_confirm: "直近30日分のデータをGoogle Fitから取り込みますか？" }, class: "flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-r from-green-500 to-green-600 dark:from-green-600 dark:to-green-700 text-white shadow-sm hover:shadow-md transition-all active:scale-95" do %>
        <%= image_tag "google_fit_logo.png", class: "w-5 h-5 object-contain rounded-full bg-white p-0.5 shadow-sm", alt: "Google Fit" %>
      <% end %>

      <%= link_to new_walk_path, class: "flex items-center gap-1 px-3 py-1.5 rounded-full bg-gradient-to-r from-orange-400 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white text-xs font-bold shadow-sm hover:shadow-md transition-all active:scale-95" do %>
        <span class="material-symbols-outlined text-sm">add</span>
        <span>記録</span>
      <% end %>
    </div>
  </div>

  <!-- 新規作成ボタン（PCのみ） -->
  <div class="mb-10 hidden md:block">
    <div class="flex items-center gap-4">
      <%= link_to new_walk_path,
          class: "group relative w-full sm:w-auto inline-flex items-center justify-center space-x-2 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-700 dark:via-fuchsia-800 dark:to-pink-800 hover:from-purple-400 hover:to-pink-400 dark:hover:from-purple-600 dark:hover:via-fuchsia-700 dark:hover:to-pink-700 text-white font-bold py-4 px-8 rounded-full border-2 border-white/30 dark:border-purple-400/30 shadow-[0_10px_25px_rgba(168,85,247,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:shadow-[0_0_25px_rgba(168,85,247,0.5),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] hover:shadow-[0_15px_35px_rgba(168,85,247,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] dark:hover:shadow-[0_0_40px_rgba(168,85,247,0.7),inset_0_0_0_1px_rgba(255,255,255,0.3)] transition-all duration-300 transform hover:-translate-y-1 active:scale-95 overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/30 before:to-transparent before:rounded-t-full before:pointer-events-none" do %>
        <span class="material-symbols-outlined text-2xl group-hover:rotate-90 transition-transform duration-300 relative z-10 drop-shadow-md">add</span>
        <span class="text-lg relative z-10 drop-shadow-sm">新しい散歩を記録する</span>
      <% end %>

      <%= link_to import_google_fit_walks_path,
          data: { turbo_method: :post, turbo_confirm: "直近30日分のデータをGoogle Fitから取り込みますか？\n\n・既存より数値が大きい項目のみ更新されます\n・サイクリングは早歩き相当の歩数に換算されます" },
          class: "group relative w-full sm:w-auto inline-flex items-center justify-center space-x-2 bg-gradient-to-r from-green-500 to-green-600 dark:from-green-700 dark:via-green-800 dark:to-green-900 hover:from-green-400 hover:to-green-500 dark:hover:from-green-600 dark:hover:via-green-700 dark:hover:to-green-800 text-white font-bold py-4 px-6 rounded-full border-2 border-white/30 dark:border-green-400/30 shadow-[0_10px_25px_rgba(34,197,94,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:shadow-[0_0_25px_rgba(34,197,94,0.5),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] hover:shadow-[0_15px_35px_rgba(34,197,94,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] dark:hover:shadow-[0_0_40px_rgba(34,197,94,0.7),inset_0_0_0_1px_rgba(255,255,255,0.3)] transition-all duration-300 transform hover:-translate-y-1 active:scale-95 overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/30 before:to-transparent before:rounded-t-full before:pointer-events-none" do %>
        <%= image_tag "google_fit_logo.png", class: "w-8 h-8 object-contain rounded-full bg-white p-1 shadow-sm relative z-10", alt: "Google Fit" %>
        <span class="text-lg relative z-10 drop-shadow-sm">Fit一括取込</span>
      <% end %>
    </div>
  </div>

  <!-- ページネーション（上部） -->
  <div class="mb-4 flex justify-center">
    <%= paginate @walks %>
  </div>

  <!-- 散歩記録一覧 -->
  <div class="grid grid-cols-1 gap-8">
    <% if @walks.any? %>
      <% @walks.each do |walk| %>
        <!-- 各散歩記録カード (Claymorphism / Neon Noir) -->
        <%= link_to walk_path(walk), class: "block group relative transform transition-all duration-300 hover:-translate-y-2 hover:scale-105" do %>
          <div class="relative overflow-hidden bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#ffedd5_90%)] dark:bg-none dark:bg-[#1a0b2e]/80 backdrop-blur-xl border-2 border-white/60 dark:border-purple-500/30 dark:border-t-white/40 rounded-[3.75rem] shadow-[20px_20px_60px_rgba(249,115,22,0.2),-20px_-20px_60px_#ffffff,inset_-5px_-5px_15px_rgba(249,115,22,0.1),inset_5px_5px_15px_rgba(255,255,255,0.7)] dark:shadow-[0_0_20px_rgba(168,85,247,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] p-6 transition-all duration-300 hover:shadow-[25px_25px_70px_rgba(249,115,22,0.3),-25px_-25px_70px_#ffffff,inset_-5px_-5px_15px_rgba(249,115,22,0.1),inset_5px_5px_15px_rgba(255,255,255,0.7)] hover:dark:shadow-[0_0_40px_rgba(168,85,247,0.4),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">

            <!-- 装飾用背景（パステルカラーのオーブ / ネオンの光） -->
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-orange-100/50 dark:bg-purple-600/20 rounded-full blur-3xl pointer-events-none group-hover:bg-orange-200/50 dark:group-hover:bg-purple-500/30 transition-colors duration-300"></div>
            <div class="absolute bottom-[-10%] left-[-10%] w-32 h-32 bg-blue-100/50 dark:bg-pink-600/10 rounded-full blur-3xl pointer-events-none group-hover:bg-blue-200/50 dark:group-hover:bg-pink-500/20 transition-colors duration-300"></div>

            <!-- 背景アクセントアイコン（足跡） -->
            <div class="absolute -top-6 -right-6 pointer-events-none opacity-[0.04] dark:opacity-[0.03] transform transition-transform duration-500 group-hover:rotate-12 group-hover:scale-110">
              <span class="material-symbols-outlined text-[9rem] text-slate-600 dark:text-white">footprint</span>
            </div>

            <!-- ヘッダー部分（日付・曜日） -->
            <div class="flex items-center justify-between mb-4 relative z-10">
              <div class="flex items-center space-x-4">
                <div class="bg-orange-50 dark:bg-[#2e1a47] p-3 rounded-2xl text-orange-500 dark:text-purple-300 shadow-inner border border-orange-100 dark:border-purple-500/30 dark:shadow-[0_0_10px_rgba(168,85,247,0.2)]">
                  <span class="material-symbols-outlined text-2xl dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-purple-300 dark:to-pink-300 dark:drop-shadow-[0_0_8px_rgba(192,132,252,0.8)]">calendar_month</span>
                </div>
                <div>
                  <p class="text-xl font-bold text-gray-700 dark:text-purple-100">
                    <%= walk.walked_on.strftime('%Y/%m/%d') %>
                  </p>
                  <p class="text-sm text-orange-400 dark:text-purple-400 font-bold">
                    <%= %w[日 月 火 水 木 金 土][walk.walked_on.wday] %>曜日
                  </p>
                </div>
              </div>

              <!-- 詳細へ矢印 (円形ボタン風) -->
              <div class="w-10 h-10 rounded-full bg-white dark:bg-white/10 flex items-center justify-center shadow-[4px_4px_8px_rgba(166,175,195,0.2),-4px_-4px_8px_rgba(255,255,255,0.9)] dark:shadow-none group-hover:scale-110 transition-transform duration-300">
                <span class="material-symbols-outlined text-gray-400 dark:text-purple-300 group-hover:text-orange-500 dark:group-hover:text-pink-400 transition-colors">arrow_forward_ios</span>
              </div>
            </div>

            <!-- 場所 -->
            <div class="flex items-center space-x-2 mb-4 relative z-10 pl-1">
              <span class="material-symbols-outlined text-gray-400 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-purple-300 dark:to-pink-300 dark:drop-shadow-[0_0_8px_rgba(192,132,252,0.8)]">location_on</span>
              <span class="font-bold text-gray-600 dark:text-purple-200 line-clamp-1"><%= walk.location %></span>
            </div>

            <!-- スタッツグリッド (統合・横並び・レスポンシブ最適化) -->
            <div class="relative z-10 bg-slate-50 dark:bg-[#0b0514]/40 rounded-3xl shadow-inner border border-black/5 dark:border-purple-500/20 dark:shadow-none p-3 sm:p-4 flex items-center justify-between">
              <!-- 距離 -->
              <div class="flex flex-col items-center flex-1">
                <div class="flex items-center space-x-0.5 sm:space-x-1 mb-1">
                  <span class="material-symbols-outlined text-base sm:text-lg text-blue-400 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-cyan-300 dark:to-blue-300 dark:drop-shadow-[0_0_8px_rgba(34,211,238,0.8)]">straighten</span>
                  <span class="text-[10px] sm:text-xs text-gray-400 dark:text-purple-300/70 font-bold">距離</span>
                </div>
                <div class="flex items-baseline">
                  <span class="font-bold text-gray-700 dark:text-cyan-200 text-base sm:text-lg mr-0.5 sm:mr-1">
                    <%= walk.distance || 0 %>
                  </span>
                  <span class="text-[10px] sm:text-xs text-gray-400 dark:text-purple-400/60">km</span>
                </div>
              </div>

              <!-- 区切り線 -->
              <div class="w-px h-6 sm:h-8 bg-gray-200 dark:bg-white/10"></div>

              <!-- 時間 -->
              <div class="flex flex-col items-center flex-1">
                <div class="flex items-center space-x-0.5 sm:space-x-1 mb-1">
                  <span class="material-symbols-outlined text-base sm:text-lg text-green-400 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-green-300 dark:to-emerald-300 dark:drop-shadow-[0_0_8px_rgba(74,222,128,0.8)]">timer</span>
                  <span class="text-[10px] sm:text-xs text-gray-400 dark:text-purple-300/70 font-bold">時間</span>
                </div>
                <div class="flex items-baseline">
                  <span class="font-bold text-gray-700 dark:text-green-200 text-base sm:text-lg mr-0.5 sm:mr-1">
                    <%= walk.duration || 0 %>
                  </span>
                  <span class="text-[10px] sm:text-xs text-gray-400 dark:text-purple-400/60">分</span>
                </div>
              </div>

              <!-- 区切り線 -->
              <div class="w-px h-6 sm:h-8 bg-gray-200 dark:bg-white/10"></div>

              <!-- 歩数 -->
              <div class="flex flex-col items-center flex-1">
                <div class="flex items-center space-x-0.5 sm:space-x-1 mb-1">
                  <span class="material-symbols-outlined text-base sm:text-lg text-purple-400 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-fuchsia-300 dark:to-pink-300 dark:drop-shadow-[0_0_8px_rgba(232,121,249,0.8)]">footprint</span>
                  <span class="text-[10px] sm:text-xs text-gray-400 dark:text-purple-300/70 font-bold">歩数</span>
                </div>
                <div class="flex items-baseline">
                  <span class="font-bold text-gray-700 dark:text-fuchsia-200 text-base sm:text-lg mr-0.5 sm:mr-1">
                    <%= number_with_delimiter(walk.steps || 0) %>
                  </span>
                  <span class="text-[10px] sm:text-xs text-gray-400 dark:text-purple-400/60">歩</span>
                </div>
              </div>
            </div>

            <!-- メモ（あれば） -->
            <% if walk.notes.present? %>
              <div class="mt-4 pt-4 border-t border-gray-100 dark:border-white/10 relative z-10">
                <div class="flex items-start space-x-2 text-gray-500 dark:text-purple-200/80">
                  <span class="material-symbols-outlined text-sm mt-0.5 text-gray-400 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-purple-300 dark:to-pink-300 dark:drop-shadow-[0_0_8px_rgba(192,132,252,0.8)]">edit_note</span>
                  <p class="text-sm line-clamp-1"><%= walk.notes %></p>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>

    <!-- ページネーション -->
    <div class="mt-8 flex justify-center">
      <%= paginate @walks %>
    </div>

    <% else %>
      <!-- 記録がない場合のメッセージ (Claymorphism / Neon Noir) -->
      <div class="col-span-1 bg-[radial-gradient(ellipse_120%_120%_at_35%_35%,#ffffff_30%,#ffedd5_90%)] dark:bg-none dark:bg-[#1a0b2e]/80 backdrop-blur-xl p-12 rounded-[3.75rem] shadow-[20px_20px_60px_rgba(249,115,22,0.2),-20px_-20px_60px_#ffffff,inset_-5px_-5px_15px_rgba(249,115,22,0.1),inset_5px_5px_15px_rgba(255,255,255,0.7)] dark:shadow-[0_0_20px_rgba(168,85,247,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] border-2 border-white/60 dark:border-purple-500/30 dark:border-t-white/40 text-center relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
        <div class="bg-orange-50 dark:bg-[#2e1a47] w-28 h-28 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner animate-pulse-slow dark:shadow-[0_0_20px_rgba(168,85,247,0.3)] relative z-10">
          <span class="material-symbols-outlined text-6xl text-orange-400 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-purple-300 dark:to-pink-300 dark:drop-shadow-[0_0_10px_rgba(168,85,247,0.8)]">hiking</span>
        </div>
        <h3 class="text-2xl font-bold text-gray-700 dark:text-purple-100 mb-3">さあ、冒険に出かけよう！</h3>
        <p class="text-gray-500 dark:text-purple-200/70 mb-10 text-base leading-relaxed">
          まだ散歩の記録がありません。<br>
          最初の足跡を刻んで、思い出を作りませんか？
        </p>
        <%= link_to new_walk_path,
            class: "inline-flex items-center space-x-2 bg-gradient-to-r from-orange-400 to-pink-500 dark:from-purple-600 dark:to-pink-600 hover:from-orange-500 hover:to-pink-600 dark:hover:from-purple-500 dark:hover:to-pink-500 text-white font-bold py-4 px-8 rounded-full shadow-[6px_6px_12px_rgba(166,175,195,0.4),-6px_-6px_12px_rgba(255,255,255,0.9)] dark:shadow-[0_0_20px_rgba(168,85,247,0.5)] transition-all duration-300 transform hover:-translate-y-1 active:scale-95 active:shadow-inner" do %>
          <span class="material-symbols-outlined">arrow_forward</span>
          <span>最初の記録を作成する</span>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
</file>

<file path="bin/brakeman">
#!/usr/bin/env ruby
require "rubygems"
require "bundler/setup"

ARGV.unshift("--ensure-latest")

load Gem.bin_path("brakeman", "brakeman")
</file>

<file path="bin/complete_sync.sh">
#!/bin/bash

# complete_sync.sh
# Claude Codeで追加したGemやパッケージをローカル環境（Docker）に同期するスクリプト

set -e  # エラーが発生したら終了

echo "========================================="
echo "🔄 Gemとパッケージの同期を開始します"
echo "========================================="

# プロジェクトルートに移動
cd "$(dirname "$0")"

# 色付き出力用の関数
success() {
    echo "✅ $1"
}

info() {
    echo "ℹ️  $1"
}

error() {
    echo "❌ $1"
}

# Rubyのバージョンを確認
info "Rubyバージョン: $(ruby -v)"

# 1. Bundlerのバージョンを確認
if [ -f "Gemfile.lock" ]; then
    BUNDLED_WITH=$(grep -A 1 "BUNDLED WITH" Gemfile.lock | tail -n 1 | tr -d ' ')
    if [ -n "$BUNDLED_WITH" ]; then
        info "必要なBundlerバージョン: $BUNDLED_WITH"
        CURRENT_BUNDLER=$(bundle -v | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
        if [ "$CURRENT_BUNDLER" != "$BUNDLED_WITH" ]; then
            info "Bundler $BUNDLED_WITH をインストール中..."
            gem install bundler -v "$BUNDLED_WITH"
        fi
    fi
fi

# 2. bundle install を実行
info "bundle install を実行中..."
if bundle install; then
    success "bundle install が完了しました"
else
    error "bundle install が失敗しました"
    exit 1
fi

# 3. yarn install を実行（package.jsonが存在する場合）
if [ -f "package.json" ]; then
    info "yarn install を実行中..."
    if yarn install; then
        success "yarn install が完了しました"
    else
        error "yarn install が失敗しました"
        exit 1
    fi
else
    info "package.json が見つかりません。スキップします。"
fi

# 4. データベースのマイグレーション状態を確認
info "データベースのマイグレーション状態を確認中..."
if bin/rails db:migrate:status 2>/dev/null | grep -q "down"; then
    info "未実行のマイグレーションがあります。実行中..."
    if bin/rails db:migrate; then
        success "データベースマイグレーションが完了しました"
    else
        error "データベースマイグレーションが失敗しました"
        # マイグレーションの失敗は致命的ではないので続行
    fi
else
    success "データベースは最新の状態です"
fi

# 5. アセットのプリコンパイル（本番環境用、開発環境ではスキップ可能）
if [ "$RAILS_ENV" = "production" ] || [ "$PRECOMPILE_ASSETS" = "true" ]; then
    info "アセットをプリコンパイル中..."
    if bin/rails assets:precompile; then
        success "アセットのプリコンパイルが完了しました"
    else
        error "アセットのプリコンパイルが失敗しました"
        exit 1
    fi
else
    info "アセットのプリコンパイルはスキップします（開発環境）"
fi

# 6. JavaScriptのビルド（開発環境用）
if [ -f "package.json" ]; then
    info "JavaScriptをビルド中..."
    if yarn build 2>/dev/null || npm run build 2>/dev/null; then
        success "JavaScriptのビルドが完了しました"
    else
        info "JavaScriptのビルドスクリプトが見つかりません。スキップします。"
    fi
fi

# 7. Railsサーバーが起動しているか確認
if lsof -i:3000 >/dev/null 2>&1; then
    info "Railsサーバーが起動中です。再起動を推奨します。"
    echo ""
    echo "以下のコマンドでサーバーを再起動してください："
    echo "  docker-compose restart web"
    echo "  または"
    echo "  bin/rails restart"
fi

echo ""
echo "========================================="
success "同期が完了しました！"
echo "========================================="
echo ""
echo "次のステップ："
echo "  1. Railsサーバーを再起動してください"
echo "  2. ブラウザで http://localhost:3000 にアクセスして動作確認してください"
echo ""
</file>

<file path="bin/dev">
#!/usr/bin/env sh

if ! gem list foreman -i --silent; then
  echo "Installing foreman..."
  gem install foreman
fi

# Default to port 3000 if not specified
export PORT="${PORT:-3000}"

# Let the debug gem allow remote connections,
# but avoid loading until `debugger` is called
export RUBY_DEBUG_OPEN="true"
export RUBY_DEBUG_LAZY="true"

exec bundle exec foreman start -f Procfile.dev "$@"
</file>

<file path="bin/docker-entrypoint">
#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ] && [ -f /usr/lib/*/libjemalloc.so.2 ]; then
  export LD_PRELOAD="$(echo /usr/lib/*/libjemalloc.so.2)"
fi

# If running the rails server then create or migrate existing database
if [ "${1}" == "./bin/rails" ] && [ "${2}" == "server" ]; then
  ./bin/rails db:prepare
fi

exec "${@}"
</file>

<file path="bin/importmap">
#!/usr/bin/env ruby

require_relative "../config/application"
require "importmap/commands"
</file>

<file path="bin/rails">
#!/usr/bin/env ruby
APP_PATH = File.expand_path("../config/application", __dir__)
require_relative "../config/boot"
require "rails/commands"
</file>

<file path="bin/rake">
#!/usr/bin/env ruby
require_relative "../config/boot"
require "rake"
Rake.application.run
</file>

<file path="bin/render-build.sh">
#!/usr/bin/env bash
# bin/render-build.sh

set -o errexit

echo "🚀 アプリのビルド開始！"

# 古いgemのクリーンアップ（キャッシュクリア）
echo "🧹 古い依存関係をクリーンアップ中..."
bundle clean --force || true

# Bundlerのインストール
echo "📦 Ruby Gemsをインストール中..."
bundle install

# ImageMagickの確認
echo "📸 ImageMagickのバージョン確認..."
convert --version || echo "⚠️ ImageMagickが見つかりません！"

# Node.jsの依存関係（package.jsonがある場合のみ）
if [ -f "package.json" ]; then
  echo "📦 Node.jsの依存関係をインストール中..."
  npm install
fi

# アセットのプリコンパイル
echo "🎨 アセットをコンパイル中..."
npm run build:css
npm run build
bundle exec rails assets:precompile

# データベースマイグレーション
echo "🗄️ データベースを更新中..."
bundle exec rails db:migrate

echo "✅ ビルド完了！アプリの準備ができました！"
</file>

<file path="bin/rubocop">
#!/usr/bin/env ruby
require "rubygems"
require "bundler/setup"

# explicit rubocop config increases performance slightly while avoiding config confusion.
ARGV.unshift("--config", File.expand_path("../.rubocop.yml", __dir__))

load Gem.bin_path("rubocop", "rubocop")
</file>

<file path="bin/setup">
#!/usr/bin/env ruby
require "fileutils"

APP_ROOT = File.expand_path("..", __dir__)
APP_NAME = "myapp"

def system!(*args)
  system(*args, exception: true)
end

FileUtils.chdir APP_ROOT do
  # This script is a way to set up or update your development environment automatically.
  # This script is idempotent, so that you can run it at any time and get an expectable outcome.
  # Add necessary setup steps to this file.

  puts "== Installing dependencies =="
  system! "gem install bundler --conservative"
  system("bundle check") || system!("bundle install")

  # Install JavaScript dependencies
  system("yarn install --check-files")

  # puts "\n== Copying sample files =="
  # unless File.exist?("config/database.yml")
  #   FileUtils.cp "config/database.yml.sample", "config/database.yml"
  # end

  puts "\n== Preparing database =="
  system! "bin/rails db:prepare"

  puts "\n== Removing old logs and tempfiles =="
  system! "bin/rails log:clear tmp:clear"

  puts "\n== Restarting application server =="
  system! "bin/rails restart"

  # puts "\n== Configuring puma-dev =="
  # system "ln -nfs #{APP_ROOT} ~/.puma-dev/#{APP_NAME}"
  # system "curl -Is https://#{APP_NAME}.test/up | head -n 1"
end
</file>

<file path="spec/models/user_spec.rb">
require "rails_helper"

RSpec.describe User, type: :model do
  describe "バリデーション" do
    it "有効な属性であれば有効であること" do
      user = FactoryBot.build(:user)
      expect(user).to be_valid
    end

    it "ユーザー名がない場合は無効であること" do
      user = FactoryBot.build(:user, name: nil)
      user.valid?
      expect(user.errors[:name]).to include("を入力してください")
    end

    it "目標距離がない場合は無効であること" do
      user = FactoryBot.build(:user, target_distance: nil)
      user.valid?
      expect(user.errors[:target_distance]).to include("を入力してください")
    end

    it "目標距離が100,000より大きい場合は無効であること" do
      user = FactoryBot.build(:user, target_distance: 100_001)
      user.valid?
      expect(user.errors[:target_distance]).to include("は100000以下の値にしてください")
    end
  end

  describe ".from_omniauth" do
    # OmniAuthのモックデータを作成
    # 実際のGoogle認証の代わりに、このハッシュデータを使用します
    let(:auth_hash) do
      OmniAuth::AuthHash.new({
        provider: "google_oauth2",
        uid: "123456789",
        info: {
          email: "test@example.com",
          image: "https://example.com/avatar.jpg"
        },
        credentials: {
          token: "mock_token",
          refresh_token: "mock_refresh_token",
          expires_at: Time.now.to_i + 3600
        }
      })
    end

    context "ユーザーが既に存在する場合（Google UIDで一致）" do
      it "そのユーザーを返し、Google認証情報を更新すること" do
        # 事前にユーザーを作成
        user = FactoryBot.create(:user,
          name: "既存ユーザー",
          email: "other@example.com",
          google_uid: "123456789"
        )

        # メソッド実行
        result_user = User.from_omniauth(auth_hash)

        # 検証
        expect(result_user).to eq(user) # 同じユーザーオブジェクトが返されるか
        expect(result_user.google_token).to eq("mock_token") # トークンが更新されているか
        expect(result_user.avatar_url).to eq("https://example.com/avatar.jpg") # アバター画像が更新されているか
      end
    end

    context "ユーザーが存在しない場合" do
      it "新しいユーザーを作成せず、nilを返すこと" do
        # ユーザー数が増えないことを検証
        expect {
          result = User.from_omniauth(auth_hash)
          expect(result).to be_nil
        }.not_to change(User, :count)
      end
    end
  end

  describe "#consecutive_walk_days" do
    let(:user) { FactoryBot.create(:user) }

    context "記録がない場合" do
      it "0を返すこと" do
        expect(user.consecutive_walk_days).to eq 0
      end
    end

    context "今日記録がある場合" do
      before { FactoryBot.create(:walk, user: user, walked_on: Date.current) }

      it "1を返すこと" do
        expect(user.consecutive_walk_days).to eq 1
      end
    end

    context "今日と昨日記録がある場合" do
      before do
        FactoryBot.create(:walk, user: user, walked_on: Date.current)
        FactoryBot.create(:walk, user: user, walked_on: 1.day.ago.to_date)
      end

      it "2を返すこと" do
        expect(user.consecutive_walk_days).to eq 2
      end
    end

    context "連続が途切れている場合" do
      before do
        FactoryBot.create(:walk, user: user, walked_on: Date.current)
        # 昨日はなし
        FactoryBot.create(:walk, user: user, walked_on: 2.days.ago.to_date)
      end

      it "1を返すこと" do
        expect(user.consecutive_walk_days).to eq 1
      end
    end
  end

  describe ".ranking" do
    let!(:user_a) { FactoryBot.create(:user, name: "User A") }
    let!(:user_b) { FactoryBot.create(:user, name: "User B") }
    let!(:user_c) { FactoryBot.create(:user, name: "User C") }

    around do |example|
      # 2026-01-15 (木) に固定してテスト実行（月の半ばなど安全な日を選ぶ）
      travel_to(Time.zone.parse("2026-01-15 12:00:00")) do
        example.run
      end
    end

    context "期間: weekly (今週)" do
      it "今週の記録が集計され、距離順に並ぶこと" do
        # 1/15(木)の週: 1/12(月) - 1/18(日)

        # User A: 今日(15日) 5km + 昨日(14日) 3km = 8km
        FactoryBot.create(:walk, user: user_a, walked_on: Date.current, distance: 5.0)
        FactoryBot.create(:walk, user: user_a, walked_on: 1.day.ago, distance: 3.0)

        # User B: 今日(15日) 10km
        FactoryBot.create(:walk, user: user_b, walked_on: Date.current, distance: 10.0)

        # User C: 昨日(14日) 20km
        FactoryBot.create(:walk, user: user_c, walked_on: 1.day.ago, distance: 20.0)

        # 範囲外のデータ（先月）
        FactoryBot.create(:walk, user: user_a, walked_on: 1.month.ago, distance: 10.0)

        ranking = User.ranking(period: "weekly")

        expect(ranking.length).to eq 3
        expect(ranking[0].id).to eq user_c.id # 20km
        expect(ranking[0].total_distance).to eq 20.0
        expect(ranking[1].id).to eq user_b.id # 10km
        expect(ranking[1].total_distance).to eq 10.0
        expect(ranking[2].id).to eq user_a.id # 8km
        expect(ranking[2].total_distance).to eq 8.0
      end
    end

    context "期間: monthly (今月)" do
      it "今月の記録が集計され、距離順に並ぶこと" do
        # 範囲: 1/1 - 1/15
        current_month = Date.current.beginning_of_month # 1/1
        last_month = 1.month.ago.beginning_of_month

        # User A: 1/2に5km (範囲内)
        FactoryBot.create(:walk, user: user_a, walked_on: current_month + 1.day, distance: 5.0)
        # 範囲外（先月）
        FactoryBot.create(:walk, user: user_a, walked_on: last_month + 1.day, distance: 10.0)

        # User B: 1/3に10km (範囲内)
        FactoryBot.create(:walk, user: user_b, walked_on: current_month + 2.days, distance: 10.0)

        ranking = User.ranking(period: "monthly")

        # user_cは今月の記録がないためランキングに含まれない
        expect(ranking.map(&:id)).to contain_exactly(user_b.id, user_a.id)
        expect(ranking.find { |u| u.id == user_b.id }.total_distance).to eq 10.0
        expect(ranking.find { |u| u.id == user_a.id }.total_distance).to eq 5.0
      end
    end

    context "期間: yearly (今年)" do
      it "今年の記録が集計され、距離順に並ぶこと" do
        # 範囲: 1/1 - 1/15
        current_year = Date.current.beginning_of_year
        last_year = 1.year.ago.beginning_of_year

        # User A: 1/2に5km (範囲内)
        FactoryBot.create(:walk, user: user_a, walked_on: current_year + 1.day, distance: 5.0)
        # 範囲外（去年）
        FactoryBot.create(:walk, user: user_a, walked_on: last_year + 1.day, distance: 10.0)

        # User B: 1/3に10km (範囲内)
        FactoryBot.create(:walk, user: user_b, walked_on: current_year + 2.days, distance: 10.0)

        ranking = User.ranking(period: "yearly")

        expect(ranking.map(&:id)).to contain_exactly(user_b.id, user_a.id)
        expect(ranking.find { |u| u.id == user_b.id }.total_distance).to eq 10.0
        expect(ranking.find { |u| u.id == user_a.id }.total_distance).to eq 5.0
      end
    end
  end

  describe "#display_avatar_url" do
    let(:user) { FactoryBot.create(:user) }

    context "avatar_type: default" do
      before { user.update(avatar_type: :default) }
      it "nilを返すこと" do
        expect(user.display_avatar_url).to be_nil
      end
    end

    context "avatar_type: google" do
      before do
        user.update(avatar_type: :google, avatar_url: "https://example.com/google.jpg")
      end
      it "googleのURLを返すこと" do
        expect(user.display_avatar_url).to eq "https://example.com/google.jpg"
      end
    end

    context "avatar_type: uploaded" do
      before do
        user.update(avatar_type: :uploaded)
        user.uploaded_avatar.attach(io: File.open(Rails.root.join("spec/fixtures/files/avatar.jpg")), filename: "avatar.jpg", content_type: "image/jpeg")
      end
      it "アップロードされた画像を返すこと" do
        expect(user.display_avatar_url).to be_attached
      end
    end
  end
end
</file>

<file path="app/controllers/walks_controller.rb">
class WalksController < ApplicationController
  # ログインしていないユーザーはアクセスできないようにする
  before_action :authenticate_user!

  # show、edit、update、destroyアクションの前に、対象の散歩記録を取得する
  before_action :set_walk, only: [ :show, :edit, :update, :destroy ]

  # 散歩記録一覧ページ（GET /walks）
  def index
    # ログインしているユーザーの散歩記録だけを取得する
    # Walkモデルのdefault_scopeにより、日付順（新しい順）で自動ソートされる
    @walks = current_user.walks.recent.page(params[:page]).per(10)
  end

  # 散歩記録詳細ページ（GET /walks/:id）
  def show
    # before_actionで@walkが設定されているので、ここでは何もしない
  end

  # 新規散歩記録作成ページ（GET /walks/new）
  def new
    # 新しい散歩記録のインスタンスを作成
    # デフォルト値として今日の日付を設定
    @walk = Walk.new(walked_on: Date.current)

    # 現在時刻に基づいて時間帯の初期値をセット
    hour = Time.current.hour
    @walk.time_of_day = case hour
    when 4..8 then :early_morning
    when 9..15 then :day
    when 16..18 then :evening
    else :night
    end
  end

  # 散歩記録編集ページ（GET /walks/:id/edit）
  def edit
    # before_actionで@walkが設定されているので、ここでは何もしない
  end

  # 散歩記録の作成処理（POST /walks）
  def create
    # ログインしているユーザーに紐づけて散歩記録を作成
    @walk = current_user.walks.build(walk_params)

    # データベースに保存を試みる
    if @walk.save
      # 保存に成功した場合、一覧ページにリダイレクトして成功メッセージを表示
      redirect_to walks_path, notice: t("flash.walks.create.notice")
    else
      # 保存に失敗した場合（バリデーションエラー）、新規作成ページを再表示
      render :new, status: :unprocessable_entity
    end
  end

  # 散歩記録の更新処理（PATCH/PUT /walks/:id）
  def update
    # 散歩記録を更新
    if @walk.update(walk_params)
      # 更新に成功した場合、詳細ページにリダイレクトして成功メッセージを表示
      redirect_to @walk, notice: t("flash.walks.update.notice")
    else
      # 更新に失敗した場合（バリデーションエラー）、編集ページを再表示
      render :edit, status: :unprocessable_entity
    end
  end

  # 散歩記録の削除処理（DELETE /walks/:id）
  def destroy
    # 散歩記録を削除
    @walk.destroy
    # 一覧ページにリダイレクトして削除完了メッセージを表示
    redirect_to walks_path, notice: t("flash.walks.destroy.notice")
  end

  # Google Fitからデータをインポート（POST /walks/import_google_fit）
  def import_google_fit
    token_status = current_user.google_token_status

    case token_status
    when :not_connected
      redirect_to walks_path, alert: "Google Fitと連携してください。"
      return
    when :expired_need_reauth
      redirect_to walks_path, alert: "Google認証の有効期限が切れました。再度連携してください。"
      return
    when :temporary_error
      redirect_to walks_path, alert: "Googleとの通信に一時的な問題が発生しました。しばらく経ってから再試行してください。"
      return
    end

    service = GoogleFitService.new(current_user)
    # 直近30日分（今日を含む）
    end_date = Date.current
    start_date = end_date - 29.days

    result = service.fetch_activities(start_date, end_date)

    if result[:error]
      flash[:alert] = case result[:error]
      when :auth_expired
                        "Google認証の期限が切れました。再度連携してください。"
      when :api_error
                        "Google Fit APIエラー: #{result[:message]}"
      else
                        "データの取得に失敗しました。"
      end
      redirect_to walks_path
      return
    end

    activities = result[:data]
    created_count = 0
    updated_count = 0
    failed_dates = []

    # トランザクションで囲むことでデータの一貫性を保証
    ActiveRecord::Base.transaction do
      activities.each do |date, data|
        # 距離が0以下の場合はスキップ（DBを汚さない）
        next if data[:distance] <= 0

        walk = current_user.walks.find_or_initialize_by(walked_on: date)

        # モデルのメソッドを使ってデータをマージ
        walk.merge_google_fit_data(data)

        # 何らかの変更があった場合のみ保存処理を続行
        if walk.changed?
          if walk.save
            if walk.previously_new_record?
              created_count += 1
            else
              updated_count += 1
            end
          else
            failed_dates << date
            Rails.logger.error "Failed to save walk for #{date}: #{walk.errors.full_messages.join(', ')}"
          end
        end
      end

      # 失敗があった場合はロールバック
      if failed_dates.any?
        raise ActiveRecord::Rollback
      end
    end

    if failed_dates.any?
      flash[:alert] = "データの保存中にエラーが発生しました（日付: #{failed_dates.join(', ')}）。処理は中断されました。"
    elsif created_count > 0 || updated_count > 0
      flash[:notice] = "#{created_count}件の記録を作成、#{updated_count}件の記録を更新しました。"

      # データ更新があったので、ランキングOGP画像を強制再生成
      GenerateRankingOgpImageJob.perform_later(current_user, force: true)
    else
      flash[:info] = "新しいデータはありませんでした（または既存データの方が最新でした）。"
    end

    redirect_to walks_path
  end

  private

  # 対象の散歩記録を取得するメソッド
  # ログインユーザーの散歩記録の中から、指定されたIDの記録を取得する
  # これにより、他のユーザーの散歩記録にアクセスできないようにする
  def set_walk
    @walk = current_user.walks.find(params[:id])
  end

  # フォームから送信されたパラメータを許可するメソッド
  # セキュリティのため、必要なパラメータだけを許可する
  def walk_params
    params.require(:walk).permit(:walked_on, :duration, :distance, :steps, :calories_burned, :location, :notes, :time_of_day)
  end
end
</file>

<file path="app/views/posts/show.html.erb">
<%# OGP設定 %>
<% content_for :head do %>
  <meta property="og:title" content="ADVENTURE LOG - TekuMemo" />
  <meta property="og:description" content="<%= @post.body.present? ? @post.body.truncate(100) : '散歩の記録をチェックしよう！' %>" />
  <%# OGP画像のURLにキャッシュバスターと拡張子を追加 %>
  <meta property="og:image" content="<%= post_ogp_image_url(@post, format: :jpg, v: @post.updated_at.to_i) %>" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="<%= post_url(@post) %>" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ADVENTURE LOG - TekuMemo" />
  <meta name="twitter:description" content="<%= @post.body.present? ? @post.body.truncate(100) : '散歩の記録をチェックしよう！' %>" />
  <meta name="twitter:image" content="<%= post_ogp_image_url(@post, format: :jpg, v: @post.updated_at.to_i) %>" />
<% end %>

<div class="container mx-auto px-4 py-8 min-h-screen flex items-center justify-center">
  <div class="relative max-w-2xl w-full bg-[#fdfbf7] dark:bg-[#1a0b2e] rounded-[2.5rem] shadow-[20px_20px_60px_rgba(168,85,247,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(168,85,247,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(168,85,247,0.3)] dark:shadow-[0_0_20px_rgba(168,85,247,0.4)] overflow-hidden border-2 border-white/60 dark:border-purple-500/30 p-8">
    <!-- Candy Texture & Orbs (Light Mode Only) -->
    <div class="absolute inset-0 bg-gradient-to-br from-white/80 via-white/40 to-transparent pointer-events-none dark:hidden"></div>
    <div class="absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br from-purple-400/20 to-pink-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>
    <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-gradient-to-br from-blue-400/20 to-cyan-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

    <div class="relative z-10">
      <!-- 戻るボタン -->
      <div class="mb-4">
      <% back_path = user_signed_in? ? posts_path : root_path %>
      <% back_text = user_signed_in? ? "タイムラインに戻る" : "トップページに戻る" %>
      <%= link_to back_path, class: "inline-flex items-center gap-2 text-slate-600 dark:text-purple-300 hover:text-purple-600 dark:hover:text-purple-200 transition font-bold" do %>
        <span class="material-symbols-outlined">arrow_back</span>
        <span class="text-sm"><%= back_text %></span>
      <% end %>
    </div>

    <h1 class="text-3xl font-bold mb-6 text-center text-slate-800 dark:text-purple-100">冒険の記録</h1>

    <div class="mb-8 relative group" data-controller="ogp-preview">
      <div class="absolute -inset-1 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>

      <!-- Loading State -->
      <div data-ogp-preview-target="loading" class="absolute inset-0 z-20 flex items-center justify-center bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm rounded-[2rem] hidden">
         <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-300 dark:border-slate-600 border-t-purple-600 dark:border-t-fuchsia-500"></div>
      </div>

      <img id="main-ogp-image"
           data-ogp-preview-target="image"
           data-action="load->ogp-preview#handleLoad error->ogp-preview#handleError"
           src="<%= post_ogp_image_url(@post, format: :jpg) %>"
           alt="Adventure Log"
           class="relative w-full rounded-[2rem] shadow-[0_10px_30px_rgba(0,0,0,0.1)] dark:shadow-none transform transition duration-500 hover:scale-[1.02] border-4 border-white/50 dark:border-transparent">
    </div>

    <!-- シェア画像プレビューリンク（小） -->
    <div class="mt-[-20px] mb-8 text-center relative z-10">
      <button onclick="document.dispatchEvent(new CustomEvent('ogp:open'))" class="text-xs text-slate-500 dark:text-slate-400 hover:text-purple-600 dark:hover:text-fuchsia-300 underline transition">
        📷 シェア画像を確認・更新
      </button>
    </div>

    <% if @post.body.present? %>
      <p class="text-lg text-slate-600 dark:text-slate-300 mb-8 text-center font-medium leading-relaxed break-words">
        "<%= @post.body %>"
      </p>
    <% end %>

    <div class="text-center space-y-4 max-w-md mx-auto">
      <% if @post.user_id == current_user&.id %>
        <%= link_to share_post_on_twitter_url(@post),
            target: "_blank",
            rel: "noopener noreferrer",
            class: "w-full rounded-full border-2 border-white/30 bg-black text-white font-bold py-3 px-8 shadow-[0_10px_25px_rgba(0,0,0,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] hover:shadow-[0_15px_35px_rgba(0,0,0,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] hover:-translate-y-1 transition-all duration-300 mb-4 flex items-center justify-center gap-2" do %>
          <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
          でシェアする
        <% end %>
        <br>
      <% end %>

      <% if user_signed_in? %>
        <%= link_to posts_path, class: "w-full rounded-full border-2 border-white/30 dark:border-cyan-500/50 bg-gradient-to-r from-cyan-500 to-blue-500 dark:from-[#0f172a] dark:to-[#1e3a8a] text-white dark:text-cyan-100 font-bold py-4 px-10 shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.15),inset_2px_2px_5px_rgba(255,255,255,0.3),0_10px_25px_rgba(6,182,212,0.4)] dark:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.3),inset_2px_2px_5px_rgba(255,255,255,0.2),0_0_20px_rgba(6,182,212,0.4)] hover:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.15),inset_2px_2px_5px_rgba(255,255,255,0.3),0_15px_35px_rgba(6,182,212,0.6)] dark:hover:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.3),inset_2px_2px_5px_rgba(255,255,255,0.2),0_0_40px_rgba(6,182,212,0.6)] hover:-translate-y-1 active:scale-95 transition-all duration-300 flex items-center justify-center gap-2" do %>
          <i class="fas fa-list"></i> <span>タイムラインを見る</span>
        <% end %>

        <%= link_to root_path, class: "w-full rounded-full border-2 border-white/30 dark:border-rose-500/50 bg-gradient-to-r from-rose-500 to-red-500 dark:from-[#2e0f15] dark:to-[#450a0a] text-white dark:text-rose-100 font-bold py-4 px-10 shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.15),inset_2px_2px_5px_rgba(255,255,255,0.3),0_10px_25px_rgba(244,63,94,0.4)] dark:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.3),inset_2px_2px_5px_rgba(255,255,255,0.2),0_0_20px_rgba(244,63,94,0.4)] hover:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.15),inset_2px_2px_5px_rgba(255,255,255,0.3),0_15px_35px_rgba(244,63,94,0.6)] dark:hover:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.3),inset_2px_2px_5px_rgba(255,255,255,0.2),0_0_40px_rgba(244,63,94,0.6)] hover:-translate-y-1 active:scale-95 transition-all duration-300 flex items-center justify-center gap-2" do %>
          <i class="fas fa-home"></i> <span>ホームに戻る</span>
        <% end %>
      <% else %>
        <%= link_to new_user_session_path, class: "w-full rounded-full border-2 border-white/30 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-[#0f172a] dark:to-[#1e3a8a] text-white dark:text-cyan-100 font-bold py-4 px-10 shadow-[0_10px_25px_rgba(168,85,247,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:shadow-[0_0_15px_rgba(6,182,212,0.3)] dark:border-cyan-500/50 hover:shadow-[0_15px_35px_rgba(168,85,247,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] dark:hover:shadow-[0_0_25px_rgba(6,182,212,0.6)] hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2" do %>
          <i class="fas fa-sign-in-alt"></i> <span>ログインして始める</span>
        <% end %>

        <%= link_to root_path, class: "w-full rounded-full border-2 border-white/30 bg-gradient-to-r from-yellow-400 to-orange-500 dark:from-[#2e0f15] dark:to-[#450a0a] text-white dark:text-rose-100 font-bold py-4 px-10 shadow-[0_10px_25px_rgba(245,158,11,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:shadow-[0_0_15px_rgba(244,63,94,0.3)] dark:border-rose-500/50 hover:shadow-[0_15px_35px_rgba(245,158,11,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] dark:hover:shadow-[0_0_25px_rgba(244,63,94,0.6)] hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2" do %>
          <i class="fas fa-play"></i> <span>冒険を始める</span>
        <% end %>
      <% end %>

      <p class="text-sm text-slate-400 dark:text-slate-500 mt-4">
        TekuMemo - 楽しく歩く、冒険する。
      </p>
    </div>
    </div>
    </div> <!-- End of relative z-10 wrapper -->
  </div>
</div>

<!-- OGPプレビューモーダル -->
<div id="ogp-preview-modal"
     data-controller="ogp-preview"
     data-ogp-preview-target="modal"
     class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-200 opacity-0"
     data-action="click->ogp-preview#closeBackground">

  <div data-ogp-preview-target="container"
       class="relative bg-white dark:bg-slate-900/90 rounded-[3.75rem] p-8 max-w-2xl w-full shadow-2xl transform transition-all border-4 border-white dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_50px_rgba(168,85,247,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1)] overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[20%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none">

    <!-- 閉じるボタン -->
    <button data-action="click->ogp-preview#close" class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 hover:text-slate-700 dark:bg-white/10 dark:hover:bg-white/20 dark:text-gray-300 dark:hover:text-white transition-all duration-200 z-50 shadow-md hover:shadow-lg hover:scale-110 active:scale-95">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>

    <!-- タイトル -->
    <h3 class="text-lg font-bold text-slate-700 dark:text-white mb-2 flex items-center gap-2 relative z-10 pr-12">
      <span>🖼️</span> シェア画像プレビュー
    </h3>
    <p class="text-xs text-slate-500 dark:text-slate-400 mb-4 leading-relaxed relative z-10 pr-12">
      X(Twitter)などでシェアされた時に表示される画像です。<br>
      <span class="text-orange-500 dark:text-amber-400">※画像が古い場合は「画像を最新にする」を押してください。</span>
    </p>

    <!-- プレビュー画像 -->
    <div class="relative aspect-[1.91/1] w-full rounded-xl overflow-hidden shadow-lg bg-slate-200 dark:bg-slate-800 z-10">
      <!-- ローディング表示 -->
      <div data-ogp-preview-target="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-100 dark:bg-slate-800">
        <div class="animate-spin rounded-full h-16 w-16 border-4 border-slate-300 dark:border-slate-600 border-t-purple-600 dark:border-t-fuchsia-500"></div>
        <p class="mt-4 text-sm font-bold text-slate-600 dark:text-slate-300">画像を読み込み中...</p>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">生成に数秒かかる場合があります</p>
      </div>

      <!-- OGP画像 -->
      <%= image_tag post_ogp_image_path(@post, format: :jpg, v: Time.current.to_i),
          data: {
            ogp_preview_target: "image",
            action: "error->ogp-preview#handleError load->ogp-preview#handleLoad"
          },
          class: "w-full h-full object-cover opacity-0 transition-opacity duration-500",
          alt: "Post OGP Preview" %>
    </div>

    <!-- アクションボタン -->
    <div class="mt-4 flex justify-end relative z-10">
      <button data-action="click->ogp-preview#refresh" class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg transition-colors text-sm font-bold border border-transparent dark:border-white/10">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        画像を最新にする
      </button>
    </div>
  </div>
</div>
</file>

<file path="bin/Backup_full.sh">
#!/bin/bash
set -e

# ==========================================
# プロジェクト完全バックアップスクリプト
# ------------------------------------------
# 目的: DBダンプ、環境変数、機密キー、アップロードファイルを
#       一括でバックアップし、プロジェクト外の安全な場所に保存する。
# ==========================================

# プロジェクトルートディレクトリに移動
cd "$(dirname "$0")/.."
PROJECT_ROOT=$(pwd)
PROJECT_NAME=$(basename "$PROJECT_ROOT")
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

# 保存先ディレクトリ (WSL上のホームディレクトリ直下推奨)
BACKUP_DIR=~/Backup_all
mkdir -p "$BACKUP_DIR"

# 一時作業ディレクトリ作成
TEMP_DIR="/tmp/full_backup_${PROJECT_NAME}_${TIMESTAMP}"
mkdir -p "$TEMP_DIR"

echo "🚀 バックアップを開始します..."
echo "   プロジェクト: $PROJECT_NAME"
echo "   保存先: $BACKUP_DIR"

# ==========================================
# 1. データベースバックアップ (PostgreSQL)
# ==========================================
echo "📦 [1/4] データベースのバックアップを取得中..."

# 環境変数の読み込み (.env.backupがあれば優先、なければ.env)
if [ -f .env.backup ]; then
  source .env.backup
elif [ -f .env ]; then
  source .env
fi

if [ -n "$DATABASE_URL" ]; then
  # pg_dump実行
  # --no-owner --no-acl: リストア時の権限エラー防止
  docker run --rm postgres:17-alpine pg_dump "$DATABASE_URL" --no-owner --no-acl > "$TEMP_DIR/database_dump.sql"
  echo "   ✅ DBダンプ完了: database_dump.sql"
else
  echo "   ⚠️ DATABASE_URLが見つかりません。DBバックアップをスキップします。"
fi

# ==========================================
# 2. 機密ファイル・設定ファイルの収集
# ==========================================
echo "🔑 [2/4] 機密ファイルを収集中..."

# .env ファイル群 (除外: .env.example, *.erb)
find . -maxdepth 1 -name ".env*" ! -name "*.erb" ! -name ".env.example" | while read file; do
  cp "$file" "$TEMP_DIR/"
  echo "   ✅ $file"
done

# master.key
if [ -f "config/master.key" ]; then
  mkdir -p "$TEMP_DIR/config"
  cp config/master.key "$TEMP_DIR/config/"
  echo "   ✅ config/master.key"
fi

# credentials.yml.enc (念のため)
if [ -f "config/credentials.yml.enc" ]; then
  mkdir -p "$TEMP_DIR/config"
  cp config/credentials.yml.enc "$TEMP_DIR/config/"
  echo "   ✅ config/credentials.yml.enc"
fi

# VSCode設定
if [ -d ".vscode" ]; then
  cp -r .vscode "$TEMP_DIR/"
  echo "   ✅ .vscode/"
fi

# ==========================================
# 3. アップロードファイル (ActiveStorage)
# ==========================================
echo "📂 [3/4] ストレージファイルを収集中..."

if [ -d "storage" ]; then
  mkdir -p "$TEMP_DIR/storage"
  # エラー抑制のため || : を追加
  cp -r storage/* "$TEMP_DIR/storage/" 2>/dev/null || :
  echo "   ✅ storage/"
else
  echo "   ⚠️ storageディレクトリが見つかりません（スキップ）"
fi

# ==========================================
# 4. ZIP圧縮と保存
# ==========================================
echo "asd [4/4] ZIPアーカイブを作成中..."

ZIP_FILENAME="${PROJECT_NAME}_full_backup_${TIMESTAMP}.zip"
ZIP_FILEPATH="$BACKUP_DIR/$ZIP_FILENAME"

# 一時ディレクトリに移動してZIP化
cd "$TEMP_DIR"
zip -r "$ZIP_FILEPATH" . > /dev/null

# 元の場所に戻る
cd "$PROJECT_ROOT"

# 一時ディレクトリ削除
rm -rf "$TEMP_DIR"

echo "🎉 バックアップ完了！"
echo "---------------------------------------------------"
echo "📁 ファイル: $ZIP_FILEPATH"
echo "📦 サイズ: $(du -h "$ZIP_FILEPATH" | cut -f1)"
echo "---------------------------------------------------"
</file>

<file path="db/schema.rb">
# This file is auto-generated from the current state of the database. Instead
# of editing this file, please use the migrations feature of Active Record to
# incrementally modify your database, and then regenerate this schema definition.
#
# This file is the source Rails uses to define your schema when running `bin/rails
# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to
# be faster and is potentially less error prone than running all of your
# migrations from scratch. Old migrations may fail to apply correctly if those
# migrations use external dependencies or application code.
#
# It's strongly recommended that you check this file into your version control system.

ActiveRecord::Schema[7.2].define(version: 2026_01_03_014700) do
  create_schema "auth"
  create_schema "extensions"
  create_schema "graphql"
  create_schema "graphql_public"
  create_schema "pgbouncer"
  create_schema "realtime"
  create_schema "storage"
  create_schema "vault"

  # These are extensions that must be enabled in order to support this database
  enable_extension "pg_stat_statements"
  enable_extension "pgcrypto"
  enable_extension "plpgsql"
  enable_extension "uuid-ossp"

  create_table "achievements", force: :cascade do |t|
    t.string "name", null: false
    t.text "description", null: false
    t.integer "condition_type", default: 0, null: false
    t.integer "condition_value", default: 0, null: false
    t.string "icon_name", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
  end

  create_table "active_storage_attachments", force: :cascade do |t|
    t.string "name", null: false
    t.string "record_type", null: false
    t.bigint "record_id", null: false
    t.bigint "blob_id", null: false
    t.datetime "created_at", null: false
    t.index ["blob_id"], name: "index_active_storage_attachments_on_blob_id"
    t.index ["record_type", "record_id", "name", "blob_id"], name: "index_active_storage_attachments_uniqueness", unique: true
  end

  create_table "active_storage_blobs", force: :cascade do |t|
    t.string "key", null: false
    t.string "filename", null: false
    t.string "content_type"
    t.text "metadata"
    t.string "service_name", null: false
    t.bigint "byte_size", null: false
    t.string "checksum"
    t.datetime "created_at", null: false
    t.index ["key"], name: "index_active_storage_blobs_on_key", unique: true
  end

  create_table "active_storage_variant_records", force: :cascade do |t|
    t.bigint "blob_id", null: false
    t.string "variation_digest", null: false
    t.index ["blob_id", "variation_digest"], name: "index_active_storage_variant_records_uniqueness", unique: true
  end

  create_table "announcements", force: :cascade do |t|
    t.string "title", null: false
    t.text "content", null: false
    t.string "announcement_type", default: "info"
    t.datetime "published_at"
    t.datetime "expires_at"
    t.boolean "is_published", default: false, null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["is_published"], name: "index_announcements_on_is_published"
    t.index ["published_at"], name: "index_announcements_on_published_at"
  end

  create_table "notifications", force: :cascade do |t|
    t.bigint "user_id", null: false
    t.bigint "announcement_id"
    t.datetime "read_at"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.integer "notification_type", default: 0, null: false, comment: "通知種類: 0=お知らせ, 1=非アクティブリマインド, 2=リアクションまとめ"
    t.text "message", comment: "リマインダー通知のメッセージ"
    t.string "url", comment: "リマインダー通知のリンク先"
    t.index ["announcement_id", "user_id"], name: "index_notifications_on_announcement_user_unique", unique: true, where: "(announcement_id IS NOT NULL)"
    t.index ["announcement_id"], name: "index_notifications_on_announcement_id"
    t.index ["notification_type"], name: "index_notifications_on_notification_type"
    t.index ["user_id"], name: "index_notifications_on_user_id"
  end

  create_table "posts", force: :cascade do |t|
    t.bigint "user_id", null: false
    t.bigint "walk_id"
    t.text "body"
    t.integer "weather"
    t.integer "feeling"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["created_at"], name: "index_posts_on_created_at"
    t.index ["user_id", "created_at"], name: "index_posts_on_user_id_and_created_at"
    t.index ["user_id"], name: "index_posts_on_user_id"
    t.index ["walk_id"], name: "index_posts_on_walk_id"
  end

  create_table "reactions", force: :cascade do |t|
    t.bigint "user_id", null: false
    t.bigint "post_id", null: false
    t.integer "kind", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["post_id", "kind"], name: "index_reactions_on_post_id_and_kind"
    t.index ["post_id"], name: "index_reactions_on_post_id"
    t.index ["user_id", "post_id", "kind"], name: "index_reactions_on_user_post_kind", unique: true
    t.index ["user_id"], name: "index_reactions_on_user_id"
  end

  create_table "solid_cache_entries", force: :cascade do |t|
    t.binary "key", null: false
    t.binary "value", null: false
    t.datetime "created_at", null: false
    t.bigint "key_hash", null: false
    t.integer "byte_size", null: false
    t.index ["byte_size"], name: "index_solid_cache_entries_on_byte_size"
    t.index ["key_hash", "byte_size"], name: "index_solid_cache_entries_on_key_hash_and_byte_size"
    t.index ["key_hash"], name: "index_solid_cache_entries_on_key_hash", unique: true
  end

  create_table "user_achievements", force: :cascade do |t|
    t.bigint "user_id", null: false
    t.bigint "achievement_id", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["achievement_id"], name: "index_user_achievements_on_achievement_id"
    t.index ["user_id", "achievement_id"], name: "index_user_achievements_on_user_id_and_achievement_id", unique: true
    t.index ["user_id"], name: "index_user_achievements_on_user_id"
  end

  create_table "users", force: :cascade do |t|
    t.string "email", default: "", null: false
    t.string "encrypted_password", default: "", null: false
    t.string "reset_password_token"
    t.datetime "reset_password_sent_at"
    t.datetime "remember_created_at"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.string "google_uid"
    t.text "google_token"
    t.text "google_refresh_token"
    t.datetime "google_expires_at"
    t.string "avatar_url"
    t.string "name"
    t.integer "target_distance", default: 3000, null: false
    t.boolean "is_admin", default: false, null: false
    t.boolean "walk_reminder_enabled", default: false, null: false, comment: "散歩時間リマインド通知の有効/無効"
    t.time "walk_reminder_time", default: "2000-01-01 19:00:00", comment: "散歩リマインド通知の時刻"
    t.boolean "inactive_days_reminder_enabled", default: true, null: false, comment: "非アクティブリマインド通知の有効/無効"
    t.integer "inactive_days_threshold", default: 3, null: false, comment: "非アクティブと判定する日数"
    t.boolean "reaction_summary_enabled", default: true, null: false, comment: "リアクションまとめ通知の有効/無効"
    t.integer "role", default: 0, null: false
    t.integer "sign_in_count", default: 0, null: false
    t.datetime "current_sign_in_at"
    t.datetime "last_sign_in_at"
    t.string "current_sign_in_ip"
    t.string "last_sign_in_ip"
    t.integer "avatar_type", default: 0, null: false
    t.index ["email"], name: "index_users_on_email", unique: true
    t.index ["is_admin"], name: "index_users_on_is_admin"
    t.index ["reset_password_token"], name: "index_users_on_reset_password_token", unique: true
  end

  create_table "walks", force: :cascade do |t|
    t.bigint "user_id", null: false
    t.date "walked_on"
    t.integer "duration"
    t.decimal "distance"
    t.string "location"
    t.text "notes"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.integer "steps"
    t.integer "calories_burned"
    t.integer "time_of_day"
    t.index ["user_id", "walked_on"], name: "index_walks_on_user_id_and_walked_on"
    t.index ["user_id"], name: "index_walks_on_user_id"
    t.index ["walked_on"], name: "index_walks_on_walked_on"
  end

  create_table "web_push_subscriptions", force: :cascade do |t|
    t.bigint "user_id", null: false
    t.string "endpoint", null: false, comment: "通知送信先URL"
    t.string "p256dh", null: false, comment: "暗号化キー (P-256 curve)"
    t.string "auth_key", null: false, comment: "認証シークレット"
    t.string "user_agent", comment: "登録したブラウザ/デバイス情報"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["endpoint"], name: "index_web_push_subscriptions_on_endpoint", unique: true
    t.index ["user_id"], name: "index_web_push_subscriptions_on_user_id"
  end

  add_foreign_key "active_storage_attachments", "active_storage_blobs", column: "blob_id"
  add_foreign_key "active_storage_variant_records", "active_storage_blobs", column: "blob_id"
  add_foreign_key "notifications", "announcements"
  add_foreign_key "notifications", "users"
  add_foreign_key "posts", "users"
  add_foreign_key "posts", "walks"
  add_foreign_key "reactions", "posts"
  add_foreign_key "reactions", "users"
  add_foreign_key "user_achievements", "achievements"
  add_foreign_key "user_achievements", "users"
  add_foreign_key "walks", "users"
  add_foreign_key "web_push_subscriptions", "users"
end
</file>

<file path="docker-compose.yml">
name: tekumemo_app

services:
  # PostgreSQLデータベース
  db:
    container_name: tekumemo-db
    image: postgres:15
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=myapp_development
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Railsアプリケーション
  web:
    container_name: tekumemo-web
    build:
      context: .
      dockerfile: Dockerfile.dev
    shm_size: "2gb"
    # ./bin/devでwatcherが起動するため、事前ビルドは不要
    command: bash -c "mkdir -p tmp/pids tmp/cache log && chmod -R 777 tmp log && rm -f tmp/pids/server.pid && ./bin/dev"
    tty: true
    stdin_open: true
    restart: always
    volumes:
      - .:/rails
      - bundle_data:/usr/local/bundle
      - /rails/tmp
      - /rails/log
      - /rails/app/assets/builds
      - /rails/public/assets
    ports:
      - "3000:3000"
    depends_on:
      db:
        condition: service_healthy
    environment:
      - RAILS_ENV=development
      - DATABASE_HOST=db
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=password

volumes:
  postgres_data:
  bundle_data:
</file>

<file path="app/controllers/rankings/ogp_images_controller.rb">
module Rankings
  class OgpImagesController < ApplicationController
    skip_before_action :authenticate_user!, only: [ :show ]

    def show
      @user = User.find(params[:id])

      # 期間設定 (今週)
      start_date = Date.current.beginning_of_week
      end_date = Date.current.end_of_week
      period_key = "#{start_date.strftime("%Y%m%d")}_#{end_date.strftime("%Y%m%d")}"

      # 強制リフレッシュ: ?refresh=true があれば既存の画像を削除
      if params[:refresh] == "true"
        expires_now # キャッシュを無効化
        if @user.ranking_ogp_image.attached?
          Rails.logger.info "[Ranking OGP] Force refreshing image for user #{@user.id}"
          @user.ranking_ogp_image.purge
          @user.reload # アタッチメント情報を更新
        end
      else
        # キャッシュ設定: 手動更新機能があるため、1週間に設定してサーバー負荷を軽減
        expires_in 1.week, public: true
      end

      # 既存の画像があり、ファイル名が今週のもので、かつ作成から1週間以内であれば返す
      if @user.ranking_ogp_image.attached? &&
         @user.ranking_ogp_image.filename.to_s.include?(period_key) &&
         @user.ranking_ogp_image.blob.created_at > 1.week.ago
         send_data @user.ranking_ogp_image.download, type: "image/jpeg", disposition: "inline"
        return
      end

      # 画像がない、または古い場合
      # コントローラー内で同期的に生成（投稿OGPと同じパターン）

      # 週間データ集計と順位計算をモデルに委譲
      stats = @user.weekly_ranking_stats

      image_data = RpgCardGeneratorService.new(
        user: @user,
        title: "RANKING CHAMPION",
        message: "今週のランキング結果です！\n目指せトップランカー！",
        stats: stats,
        theme: :ranking
      ).generate

      Rails.logger.info "[Ranking OGP] Image generated, size: #{image_data.bytesize} bytes"
      Rails.logger.info "[Ranking OGP] Before attach - attached?: #{@user.ranking_ogp_image.attached?}"

      # Active Storageに保存
      @user.ranking_ogp_image.attach(
        io: StringIO.new(image_data),
        filename: "ranking_#{@user.id}_#{period_key}.jpg",
        content_type: "image/jpeg"
      )

      Rails.logger.info "[Ranking OGP] After attach - attached?: #{@user.ranking_ogp_image.attached?}"

      # 明示的にリロードして、DBの状態を確認
      @user.reload
      Rails.logger.info "[Ranking OGP] After reload - attached?: #{@user.ranking_ogp_image.attached?}"

      if @user.ranking_ogp_image.attached?
        Rails.logger.info "[Ranking OGP] Success! Serving image directly."
        send_data @user.ranking_ogp_image.download, type: "image/jpeg", disposition: "inline"
      else
        Rails.logger.error "[Ranking OGP] CRITICAL: attach() completed but image not attached after reload!"
        redirect_to ActionController::Base.helpers.image_url("icon.png"), allow_other_host: true
      end

    rescue => e
      Rails.logger.error "Failed to handle ranking OGP image request: #{e.message}"
      # エラー時もデフォルト画像へ
      redirect_to ActionController::Base.helpers.image_url("icon.png"), allow_other_host: true
    end
  end
end
</file>

<file path="app/controllers/rankings_controller.rb">
class RankingsController < ApplicationController
  # OGPメタタグ取得のため、ログインなしでもアクセス可能にする
  skip_before_action :authenticate_user!, only: [ :index ]

  def index
    # パラメータ取得
    @period = params[:period] || "weekly"

    # キャッシュキー生成（日付ごとに更新）
    cache_key = case @period
    when "weekly"
                  "rankings_weekly_#{Date.current.beginning_of_week}"
    when "monthly"
                  "rankings_monthly_#{Date.current.strftime('%Y-%m')}"
    when "all_time"
                  "rankings_all_time_#{Date.current}"
    else
                  "rankings_weekly_#{Date.current.beginning_of_week}"
    end

    # ランキング取得（1時間キャッシュ）
    fetch_rankings_for_period(@period)

    # 自分の順位と距離を特定
    if user_signed_in?
      find_my_rank
      calculate_my_distance

      # OGP画像の事前生成をキック（非同期）
      GenerateRankingOgpImageJob.perform_later(current_user)

      # 1位との差分を計算（自分が1位でない場合）
      if @my_rank && @my_rank > 1 && @rankings.present?
        top_distance = @rankings.first.total_distance
        @distance_to_top = top_distance - @my_distance
      else
        @distance_to_top = 0
      end
    end
  end

  private

  def fetch_rankings_for_period(period)
    # キャッシュキーの生成
    # 1. 期間 (period)
    # 2. 時間 (Time.current.hour): 1時間ごとに強制更新
    # 3. ユーザー更新 (User.maximum(:updated_at)): プロフィール変更（アバター等）を即時反映させるため
    # 4. 閲覧ユーザーの属性 (guest or general): ゲストと一般でランキング内容を変えるため
    latest_update = User.maximum(:updated_at).to_i
    viewer_role = current_user&.guest? ? "guest" : "general"
    cache_key = "rankings_#{period}_#{Time.current.strftime('%Y%m%d%H')}_#{latest_update}_#{viewer_role}"

    cached_data = Rails.cache.fetch(cache_key, expires_in: 30.minutes, race_condition_ttl: 10.seconds) do
      Rails.logger.info "Regenerating rankings cache for period: #{period}"
      {
        updated_at: Time.current,
        rankings: User.ranking_for(current_user, period: period).with_attached_uploaded_avatar.to_a
      }
    end

    @rankings = cached_data[:rankings]
    @last_data_updated_at = cached_data[:updated_at]
    # 次回キャッシュ更新時刻 = データ取得時刻の30分後
    @next_cache_update_at = @last_data_updated_at + 30.minutes
  end

  def find_my_rank
    # @rankingsの中から自分のIDを探す（キャッシュされた配列から探すので高速）
    user_in_ranking = @rankings.find { |user| user.id == current_user.id }

    if user_in_ranking
      # ランキング内にいれば、順位を計算（同順位対応）
      # 自分より距離が多い人の数 + 1
      my_dist = user_in_ranking.total_distance.to_f.round(2)
      higher_rankers = @rankings.count { |u| u.total_distance.to_f.round(2) > my_dist }
      @my_rank = higher_rankers + 1
    else
      # ランキング外の場合、DBから直接順位を計算するのは重いので、
      # ここでは「ランキング外」として扱う（nilのまま）
      # 必要であれば別途COUNTクエリを発行するが、今回はMVPなので省略
      @my_rank = nil
    end
  end

  def calculate_my_distance
    # ランキング内にいれば、その集計値を使う
    user_in_ranking = @rankings.find { |user| user.id == current_user.id }

    if user_in_ranking
      @my_distance = user_in_ranking.total_distance
    else
      # ランキング外の場合、個別に集計する
      range = case @period
      when "weekly" then Date.current.beginning_of_week..Date.current.end_of_week
      when "monthly" then Date.current.beginning_of_month..Date.current
      when "yearly" then Date.current.beginning_of_year..Date.current
      else Date.current.beginning_of_week..Date.current.end_of_week
      end

      @my_distance = current_user.walks.where(walked_on: range).sum(:distance) # walked_onカラムを使用
    end
  end
end
</file>

<file path="app/javascript/controllers/index.js">
// This file is auto-generated by ./bin/rails stimulus:manifest:update
// Run that command whenever you add a new controller or create them with
// ./bin/rails generate stimulus controllerName

import { application } from "./application"

import AccordionController from "./accordion_controller"
application.register("accordion", AccordionController)

import AnomalyController from "./anomaly_controller"
application.register("anomaly", AnomalyController)

import AvatarUploadController from "./avatar_upload_controller"
application.register("avatar-upload", AvatarUploadController)

import CarouselController from "./carousel_controller"
application.register("carousel", CarouselController)

import CharacterCounterController from "./character_counter_controller"
application.register("character-counter", CharacterCounterController)

import CounterController from "./counter_controller"
application.register("counter", CounterController)

import DarkModeToggleController from "./dark_mode_toggle_controller"
application.register("dark-mode-toggle", DarkModeToggleController)

import DropdownController from "./dropdown_controller"
application.register("dropdown", DropdownController)

import ExpandableFabController from "./expandable_fab_controller"
application.register("expandable-fab", ExpandableFabController)

import FlashController from "./flash_controller"
application.register("flash", FlashController)

import GoogleFitController from "./google_fit_controller"
application.register("google-fit", GoogleFitController)

import HelloController from "./hello_controller"
application.register("hello", HelloController)

import IconSelectController from "./icon_select_controller"
application.register("icon-select", IconSelectController)

import LandingModalController from "./landing_modal_controller"
application.register("landing-modal", LandingModalController)

import ModalController from "./modal_controller"
application.register("modal", ModalController)

import OgpPreviewController from "./ogp_preview_controller"
application.register("ogp-preview", OgpPreviewController)

import PopoverController from "./popover_controller"
application.register("popover", PopoverController)

import PushNotificationController from "./push_notification_controller"
application.register("push-notification", PushNotificationController)

import PwaInstallController from "./pwa_install_controller"
application.register("pwa-install", PwaInstallController)

import PwaSettingsController from "./pwa_settings_controller"
application.register("pwa-settings", PwaSettingsController)

import RadioToggleController from "./radio_toggle_controller"
application.register("radio-toggle", RadioToggleController)

import ReactionController from "./reaction_controller"
application.register("reaction", ReactionController)

import ScrollDragController from "./scroll_drag_controller"
application.register("scroll-drag", ScrollDragController)

import ScrollHideController from "./scroll_hide_controller"
application.register("scroll-hide", ScrollHideController)

import StatsChartController from "./stats_chart_controller"
application.register("stats-chart", StatsChartController)

import CoachMarkController from "./coach_mark_controller"
application.register("coach-mark", CoachMarkController)
</file>

<file path="app/services/stats_service.rb">
# frozen_string_literal: true

# 統計データを集計するサービスクラス
# ユーザーの散歩記録から様々な統計情報を算出します
class StatsService
  attr_reader :user

  def initialize(user)
    @user = user
  end

  # ===== 基本統計カード用データ =====

  # 累計距離 (全期間)
  def total_distance
    user.walks.sum(:distance).to_f.round(2)
  end

  # 累計散歩日数
  def total_days
    user.walks.count
  end

  # 現在の連続記録日数 (Userモデルのメソッドを利用)
  def current_streak
    user.consecutive_walk_days
  end

  # 平均距離/日
  def average_distance_per_day
    return 0 if total_days.zero?
    (total_distance / total_days).round(2)
  end

  # 最長記録距離
  def max_distance
    user.walks.maximum(:distance)&.to_f&.round(2) || 0
  end

  # 今月の目標達成率 (%)
  # 目標距離を達成した日数の割合（習慣化達成率）
  def monthly_goal_achievement_rate
    # 目標距離 (km)
    target_km = user.target_distance / 1000.0

    # 今月の記録のうち、目標を達成した日数をカウント
    achieved_days = user.walks
                        .where(walked_on: Date.current.beginning_of_month..Date.current)
                        .where("distance >= ?", target_km)
                        .count

    # 今日までの経過日数
    days_elapsed = Date.current.day

    return 0 if days_elapsed.zero?
    ((achieved_days.to_f / days_elapsed) * 100).round(1)
  end

  # 今月の歩いた距離（km単位）
  def current_month_distance
    user.walks
        .where(walked_on: Date.current.beginning_of_month..Date.current)
        .sum(:distance)
        .to_f
        .round(2)
  end

  # ===== 時系列グラフ用データ =====

  # 過去30日間の日別距離データ（今日を含めて31日分）
  # 返り値: { dates: [...], distances: [...] }
  def daily_distances_last_30_days
    start_date = 30.days.ago.to_date
    end_date = Date.current

    # 日付の配列を生成 (30日前〜今日 = 31日分)
    dates = (start_date..end_date).to_a

    # 散歩記録を一括取得してハッシュ化 (N+1対策)
    walks_by_date = user.walks
                        .where(walked_on: start_date..end_date)
                        .group(:walked_on)
                        .sum(:distance)

    # 各日付に対して距離を設定 (記録がない日は0)
    distances = dates.map { |date| walks_by_date[date]&.to_f&.round(2) || 0 }

    {
      dates: dates.map { |d| d.strftime("%m/%d") },  # "12/01" 形式
      distances: distances
    }
  end

  # 過去12週間の週別合計距離
  # 返り値: { weeks: [...], distances: [...] }
  def weekly_distances_last_12_weeks
    # 今週を含めて過去12週間分取得したい
    end_date = Date.current
    start_date = 11.weeks.ago.to_date.beginning_of_week # 11週間前 + 今週 = 12週間分

    # 週ごとにグループ化して合計
    # PostgreSQLのDATE_TRUNCはTime型を返すため、Date型に変換してハッシュ化
    raw_data = user.walks
               .where(walked_on: start_date..end_date)
               .group("DATE_TRUNC('week', walked_on)")
               .sum(:distance)

    data = raw_data.transform_keys { |k| k.to_date }

    # 週の配列を生成
    weeks = []
    current_week = start_date
    # 今週の月曜日までループ
    while current_week <= Date.current.beginning_of_week
      weeks << current_week
      current_week += 1.week
    end

    # 各週の距離を設定
    week_labels = weeks.map { |w| w.strftime("%m/%d") }
    distances = weeks.map do |week_start|
      data[week_start] || 0
    end

    {
      weeks: week_labels,
      distances: distances.map { |d| d.to_f.round(2) }
    }
  end

  # 過去12ヶ月の月別合計距離
  # 返り値: { months: [...], distances: [...] }
  def monthly_distances_last_12_months
    # 今月を含めて過去12ヶ月分
    end_date = Date.current.end_of_month
    start_date = 11.months.ago.to_date.beginning_of_month # to_dateを追加してDate型にする

    # 月ごとにグループ化して合計
    raw_data = user.walks
               .where(walked_on: start_date..end_date)
               .group("DATE_TRUNC('month', walked_on)")
               .sum(:distance)

    data = raw_data.transform_keys { |k| k.to_date }

    # 月の配列を生成
    months = []
    current_month = start_date
    # 今月の初日までループ
    while current_month <= Date.current.beginning_of_month
      months << current_month
      current_month += 1.month
    end

    # 各月の距離を設定
    month_labels = months.map { |m| m.strftime("%Y/%m") }
    distances = months.map do |month_start|
      data[month_start] || 0
    end

    {
      months: month_labels,
      distances: distances.map { |d| d.to_f.round(2) }
    }
  end

  # ===== 曜日別分析用データ =====

  # 曜日ごとの平均距離
  # 返り値: { day_names: [...], average_distances: [...] }
  def average_distance_by_weekday
    # PostgreSQLのEXTRACT(DOW FROM date)を使用 (0=日曜, 6=土曜)
    # 戻り値はFloatなのでIntegerに変換
    raw_data = user.walks
               .group("EXTRACT(DOW FROM walked_on)")
               .average(:distance)

    data = raw_data.transform_keys { |k| k.to_i }

    # 曜日ラベル (日曜始まり)
    day_names = %w[日 月 火 水 木 金 土]

    # 各曜日の平均距離を設定 (記録がない曜日は0)
    average_distances = (0..6).map do |dow|
      data[dow] || 0
    end

    {
      day_names: day_names,
      average_distances: average_distances.map { |d| d.to_f.round(2) }
    }
  end

  # 時間帯別散歩回数 (円グラフ用)
  # 返り値: { labels: [...], data: [...] }
  def walks_count_by_time_of_day
    # 時間帯ごとにグループ化してカウント
    # キーはDBに保存されている値(Integer)になる
    raw_data = user.walks.group(:time_of_day).count

    # 表示順序とラベルの定義 (Walkモデルのenum定義に準拠)
    # 0:early_morning, 1:day, 2:evening, 3:night
    time_slots = [
      { id: 0, key: "early_morning", label: "早朝 (4-9時)" },
      { id: 1, key: "day", label: "日中 (9-16時)" },
      { id: 2, key: "evening", label: "夕方 (16-19時)" },
      { id: 3, key: "night", label: "夜間 (19-4時)" }
    ]

    labels = []
    data = []

    time_slots.each do |slot|
      labels << slot[:label]
      # raw_dataは環境によって Integerキー または Stringキー(enum名) で返る可能性があるため両対応
      count = raw_data[slot[:id]] || raw_data[slot[:key]] || 0
      data << count
    end

    {
      labels: labels,
      data: data
    }
  end

  # ===== パフォーマンス分析用データ =====

  # 平均ペース (分/km)
  def average_pace
    # duration(分) / distance(km) = 分/km
    total_time = user.walks.sum(:duration).to_f  # 分
    total_dist_km = user.walks.sum(:distance).to_f # km

    return 0 if total_dist_km.zero?

    (total_time / total_dist_km).round(2)
  end

  # 過去30日間の平均ペースの推移
  # 返り値: { dates: [...], paces: [...] }
  def pace_trend_last_30_days
    start_date = 30.days.ago.to_date
    end_date = Date.current

    dates = (start_date..end_date).to_a

    # 各日のペースを計算
    walks_by_date = user.walks
                        .where(walked_on: start_date..end_date)
                        .select(:walked_on, :distance, :duration)
                        .group_by(&:walked_on)

    paces = dates.map do |date|
      if walks_by_date[date]
        walk = walks_by_date[date].first  # 1日1記録の想定
        distance_km = walk.distance.to_f  # km
        distance_km.zero? ? 0 : (walk.duration / distance_km).round(2)
      else
        0
      end
    end

    {
      dates: dates.map { |d| d.strftime("%m/%d") },
      paces: paces
    }
  end

  # 過去30日間のカロリー消費推移
  # 返り値: { dates: [...], calories: [...] }
  def calories_trend_last_30_days
    start_date = 30.days.ago.to_date
    end_date = Date.current

    dates = (start_date..end_date).to_a

    walks_by_date = user.walks
                        .where(walked_on: start_date..end_date)
                        .group(:walked_on)
                        .sum(:calories_burned)

    calories = dates.map { |date| walks_by_date[date] || 0 }

    {
      dates: dates.map { |d| d.strftime("%m/%d") },
      calories: calories
    }
  end

  # ===== RPG / ゲーミフィケーション要素 =====

  # レベル計算
  # 累計距離に基づいてレベルを算出 (例: 10kmごとにレベルアップなど、累進的に設定)
  def level
    total_dist = total_distance
    # レベル閾値の定義 (累計km)
    # Lv1: 0, Lv2: 10, Lv3: 30, Lv4: 60, Lv5: 100, Lv6: 150...
    # 簡易計算式: レベル = 1 + √(累計距離) のようなカーブも良いが、
    # ここでは明確なマイルストーンを設定
    case total_dist
    when 0...10 then 1
    when 10...30 then 2
    when 30...60 then 3
    when 60...100 then 4
    when 100...150 then 5
    when 150...220 then 6
    when 220...300 then 7
    when 300...400 then 8
    when 400...550 then 9
    else 10 + ((total_dist - 550) / 200).to_i # Lv10以降は200kmごとにレベルアップ
    end
  end

  # ランク名 (称号)
  def rank_name
    case level
    when 1 then "散歩見習い"
    when 2 then "駆け出しウォーカー"
    when 3 then "街の探索者"
    when 4 then "路地裏の住人"
    when 5 then "健脚の冒険家"
    when 6 then "ストリートランナー"
    when 7 then "都市の遊撃手"
    when 8 then "風の旅人"
    when 9 then "レジェンドウォーカー"
    else "散歩の神"
    end
  end

  # 次のレベルまでの残り距離 (Next XP)
  def distance_to_next_level
    total_dist = total_distance
    next_threshold = case level
    when 1 then 10
    when 2 then 30
    when 3 then 60
    when 4 then 100
    when 5 then 150
    when 6 then 220
    when 7 then 300
    when 8 then 400
    when 9 then 550
    else 550 + ((level - 9) * 200)
    end
    (next_threshold - total_dist).round(2)
  end

  # 現在のレベルの進行度 (%)
  def level_progress_percentage
    total_dist = total_distance
    current_level_start = case level
    when 1 then 0
    when 2 then 10
    when 3 then 30
    when 4 then 60
    when 5 then 100
    when 6 then 150
    when 7 then 220
    when 8 then 300
    when 9 then 400
    else 550 + ((level - 10) * 200)
    end

    next_level_start = case level
    when 1 then 10
    when 2 then 30
    when 3 then 60
    when 4 then 100
    when 5 then 150
    when 6 then 220
    when 7 then 300
    when 8 then 400
    when 9 then 550
    else 550 + ((level - 9) * 200)
    end

    range = next_level_start - current_level_start
    current_pos = total_dist - current_level_start

    return 0 if range.zero?
    ((current_pos / range) * 100).clamp(0, 100).round(1)
  end

  # 獲得済み称号 (Achievements) リスト
  # 返り値: [{ id: :rain_walker, name: "雨天決行", description: "...", icon: "...", obtained: true/false }, ...]
  def achievements
    walks = user.walks
    posts = user.posts

    list = [
      # --- 基本 ---
      {
        id: :first_step,
        name: "冒険の始まり",
        description: "初めて散歩を記録した",
        icon: "footprint",
        condition: -> { walks.exists? }
      },
      {
        id: :three_day_streak,
        name: "三日坊主卒業",
        description: "3日連続で歩いた",
        icon: "looks_3",
        condition: -> { user.max_consecutive_walk_days >= 3 }
      },
      {
        id: :seven_day_streak,
        name: "一週間の奇跡",
        description: "7日連続で歩いた",
        icon: "looks_one",
        condition: -> { user.max_consecutive_walk_days >= 7 }
      },
      {
        id: :thirty_day_streak,
        name: "継続の達人",
        description: "30日連続で歩いた",
        icon: "calendar_month",
        condition: -> { user.max_consecutive_walk_days >= 30 }
      },

      # --- 天候・環境 ---
      {
        id: :rain_walker,
        name: "雨天強行軍",
        description: "雨の日に散歩に出かけた",
        icon: "rainy",
        condition: -> {
          posts.where(weather: :rainy).any? do |post|
            walks.where(walked_on: post.created_at.to_date).exists?
          end
        }
      },
      {
        id: :storm_walker,
        name: "嵐を呼ぶ者 (Storm Bringer)",
        description: "嵐の中でも歩みを止めなかった",
        icon: "thunderstorm",
        condition: -> {
          posts.where(weather: :stormy).any? do |post|
            walks.where(walked_on: post.created_at.to_date).exists?
          end
        }
      },

      # --- 時間帯 ---
      {
        id: :early_bird,
        name: "暁の冒険者",
        description: "早朝(4:00〜8:59)に歩いた",
        icon: "wb_twilight",
        condition: -> {
          walks.where(time_of_day: :early_morning).exists?
        }
      },
      {
        id: :sun_child,
        name: "太陽の申し子",
        description: "日中(9:00〜15:59)に歩いた",
        icon: "sunny",
        condition: -> {
          walks.where(time_of_day: :day).exists?
        }
      },
      {
        id: :twilight_traveler,
        name: "黄昏の旅人",
        description: "夕方(16:00〜18:59)に歩いた",
        icon: "wb_horizon",
        condition: -> {
          walks.where(time_of_day: :evening).exists?
        }
      },
      {
        id: :night_owl,
        name: "月下の徘徊者 (Moon Walker)",
        description: "夜間(19:00〜3:59)に歩いた",
        icon: "dark_mode",
        condition: -> {
          walks.where(time_of_day: :night).exists?
        }
      },

      # --- 距離・強度 ---
      {
        id: :long_distance,
        name: "限界突破 (Limit Break)",
        description: "1回の散歩で10km以上歩いた",
        icon: "hiking",
        condition: -> { walks.where("distance >= ?", 10).exists? }
      },
      {
        id: :marathon,
        name: "マラソン完走",
        description: "累計距離が42.195kmを超えた",
        icon: "sports_score",
        condition: -> { total_distance >= 42.195 }
      },
      {
        id: :weekend_warrior,
        name: "週末の英雄 (Weekend Hero)",
        description: "土日で合計20km以上歩いた",
        icon: "event_available",
        condition: -> {
          # 土曜日(6)または日曜日(0)の記録を抽出し、合計距離を計算
          # PostgreSQLのDOW (Day Of Week): 日曜=0, 月曜=1, ..., 土曜=6
          walks.where("EXTRACT(DOW FROM walked_on) IN (0, 6)").sum(:distance) >= 20
        }
      },

      # --- ソーシャル・メンタル ---
      {
        id: :bard,
        name: "吟遊詩人",
        description: "散歩の記録(投稿)を50回以上行った",
        icon: "history_edu",
        condition: -> { posts.count >= 50 }
      },
      {
        id: :popular,
        name: "街の人気者",
        description: "投稿へのリアクションを合計100回もらった",
        icon: "favorite",
        condition: -> {
          # ReactionモデルがPostに紐付いていると仮定
          Reaction.where(post_id: posts.select(:id)).count >= 100
        }
      },
      {
        id: :indomitable,
        name: "不屈の精神",
        description: "「ヘトヘト」な気分でも歩いた",
        icon: "fitness_center",
        condition: -> { posts.where(feeling: :exhausted).exists? }
      }
    ]

    list.map do |item|
      item.merge(obtained: item[:condition].call)
    end
  end

  private

  # 今月の日数
  def days_in_current_month
    Date.current.end_of_month.day
  end
end
</file>

<file path="app/views/posts/_post.html.erb">
<%# app/views/posts/_post.html.erb %>
<%# Claymorphism Style: Colorful, Pop, Tactile, Deep %>

<%# 強度スコアに基づく配色ロジック（高スコア＝Vivid, 低スコア＝Pastel） %>
<%# 強度スコアに基づく配色ロジック（高スコア＝Vivid, 低スコア＝Pastel） %>
<% color_theme = post_color_theme(post) %>

<div id="<%= dom_id post %>"
     class="group relative mb-8 p-6 rounded-[3.75rem] transition-all duration-300 hover:-translate-y-2
            <%= color_theme[:bg] %> <%= color_theme[:shadow] %> bg-gradient-to-br from-white/80 via-white/40 to-transparent dark:bg-none border-2 border-white/60 dark:border-purple-500/30 dark:border-t-white/40 backdrop-blur-md hover:shadow-xl">

  <!-- 背景・装飾用コンテナ（ここでoverflow-hiddenして中身を切り抜く） -->
  <div class="absolute inset-0 rounded-[3.75rem] pointer-events-none overflow-hidden">
    <!-- Light Mode: Top Gradient Pulse -->
    <div class="absolute inset-x-0 top-0 h-[45%] bg-gradient-to-b from-white/15 to-transparent rounded-t-[3.75rem] animate-pulse dark:hidden"></div>

    <!-- Candy Gradient Orbs (Light Mode Only) -->
    <div class="absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br <%= color_theme[:orb_bg] %> rounded-full blur-2xl dark:hidden"></div>
    <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-gradient-to-tr <%= color_theme[:orb_bg] %> rounded-full blur-2xl dark:hidden"></div>

    <!-- Dark Mode Decor (Synthwave Sun / Grid) -->
    <div class="hidden dark:block absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/5 to-transparent"></div>
    <div class="hidden dark:block absolute bottom-0 left-0 w-full h-1/4 bg-[linear-gradient(to_top,rgba(255,255,255,0.05)_1px,transparent_1px)] bg-[size:100%_10px]"></div>
  </div>

  <%# 自分の投稿の場合、詳細ページへのリンクを全体に配置 %>
  <% if post.user_id == current_user&.id %>
    <%= link_to post_path(post), class: "absolute inset-0 z-0 rounded-[3.75rem] focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-purple-500/50", aria: { label: "詳細を見る" } do %>
      <span class="sr-only">詳細を見る</span>
    <% end %>
  <% end %>

  <!-- コンテンツラッパー -->
  <div class="relative z-10 pointer-events-none">
    <!-- リンクを無効化しないように、インタラクティブな要素だけ pointer-events-auto にする -->
    <!-- ヘッダー：ユーザー情報 -->
    <div class="flex justify-between items-start mb-4">
      <div class="flex items-center gap-4">
        <!-- アバター -->
        <div class="transform group-hover:rotate-6 transition-transform duration-300 relative z-10">
          <%= user_avatar(post.user, classes: "w-14 h-14 text-xl border-2 border-white/60 dark:border-white/10 shadow-[5px_5px_10px_rgba(0,0,0,0.1),-5px_-5px_10px_rgba(255,255,255,0.8)] dark:shadow-[0_0_15px_rgba(255,255,255,0.2)]") %>
        </div>

        <div>
          <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg tracking-wide dark:drop-shadow-[0_0_5px_rgba(255,255,255,0.5)] truncate max-w-[8rem] sm:max-w-xs">
            <%= post.user.name %>
          </h3>
          <div class="flex items-center gap-2 mt-1">
            <span class="text-xs font-bold px-3 py-1 rounded-full bg-white/60 dark:bg-white/10 text-gray-500 dark:text-gray-300 backdrop-blur-sm shadow-sm dark:shadow-none dark:border dark:border-white/10">
              <%= time_ago_in_words(post.created_at) %>前
            </span>
          </div>
        </div>
      </div>

      <!-- 削除ボタン -->
      <% if post.user_id == current_user&.id %>
        <div class="absolute top-0 right-0">
          <%= link_to post_path(post),
              data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
              class: "pointer-events-auto flex items-center justify-center w-12 h-12 rounded-full text-gray-400 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400 transition-all duration-300 transform hover:-translate-y-1 active:translate-y-0 active:scale-95 group/btn border border-white/60 dark:border-white/10 dark:hover:border-red-500/50 dark:hover:shadow-[0_0_15px_rgba(248,113,113,0.6)] relative z-20 bg-gradient-to-br from-white to-slate-100 dark:from-white/5 dark:to-transparent shadow-[5px_5px_10px_rgba(166,175,195,0.4),-5px_-5px_10px_rgba(255,255,255,0.9),inset_2px_2px_5px_rgba(255,255,255,1),inset_-2px_-2px_5px_rgba(166,175,195,0.2)] dark:shadow-none",
              title: "投稿を削除" do %>
            <span class="material-symbols-outlined text-xl font-bold drop-shadow-sm group-hover/btn:text-red-500 transition-colors">delete</span>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- 投稿本文エリア -->
    <div class="mb-0 px-1">
      <% if post.body.present? %>
        <!-- パターンA: 本文がある場合 -->
        <div class="flex flex-wrap gap-2 mb-3">
          <% if post.weather %>
            <span class="inline-flex items-center justify-center h-10 gap-2 px-4 rounded-full bg-white/70 dark:bg-white/5 text-sky-600 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-cyan-300 dark:to-blue-300 text-sm font-bold shadow-[inset_2px_2px_5px_rgba(255,255,255,0.8),inset_-2px_-2px_5px_rgba(0,0,0,0.05)] dark:shadow-[0_0_10px_rgba(34,211,238,0.2)] border border-white/50 dark:border-white/10 hover:scale-105 transition-transform cursor-default relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-full before:pointer-events-none">
              <span class="text-xl leading-none"><%= post.weather_emoji %></span>
              <span><%= post.weather_label %></span>
            </span>
          <% end %>
          <% if post.feeling %>
            <span class="inline-flex items-center justify-center h-10 gap-2 px-4 rounded-full bg-white/70 dark:bg-white/5 <%= color_theme[:text] %> text-sm font-bold shadow-[inset_2px_2px_5px_rgba(255,255,255,0.8),inset_-2px_-2px_5px_rgba(0,0,0,0.05)] dark:shadow-[0_0_10px_rgba(255,255,255,0.1)] border border-white/50 dark:border-white/10 hover:scale-105 transition-transform cursor-default relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-full before:pointer-events-none">
              <span class="text-xl leading-none"><%= post.feeling_emoji %></span>
              <span><%= post.feeling_label %></span>
            </span>
          <% end %>
        </div>

        <!-- 本文 -->
        <div class="prose dark:prose-invert max-w-none break-words text-gray-700 dark:text-gray-200 leading-relaxed font-medium text-base p-5 rounded-3xl <%= color_theme[:inner_bg] %> shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-none border border-black/5 dark:border-white/5 relative z-10">
          <%= simple_format(post.body) %>
        </div>

      <% else %>
        <!-- パターンB: 本文がない場合 -->
        <div class="flex justify-center items-center gap-8 py-2">
          <% if post.weather %>
            <div class="flex flex-col items-center animate-bounce-slow group/icon cursor-default">
              <span class="text-7xl drop-shadow-md dark:drop-shadow-[0_0_20px_rgba(255,255,255,0.4)] mb-2 transform transition-transform group-hover/icon:scale-110"><%= post.weather_emoji %></span>
              <span class="text-sm font-bold text-gray-500 dark:text-cyan-300 bg-white/50 dark:bg-white/5 px-3 py-1 rounded-full backdrop-blur-sm dark:border dark:border-white/10"><%= post.weather_label %></span>
            </div>
          <% end %>

          <% if post.feeling %>
            <div class="flex flex-col items-center animate-pulse-slow group/icon cursor-default">
              <span class="text-7xl drop-shadow-md dark:drop-shadow-[0_0_20px_rgba(255,255,255,0.4)] mb-2 transform transition-transform group-hover/icon:scale-110"><%= post.feeling_emoji %></span>
              <span class="text-sm font-bold <%= color_theme[:text] %> bg-white/50 dark:bg-white/5 px-3 py-1 rounded-full backdrop-blur-sm dark:border dark:border-white/10"><%= post.feeling_label %></span>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- リアクションエリア -->
    <div class="mt-0 pt-2 pb-1 bg-white/30 dark:bg-black/20 backdrop-blur-sm -mx-6 px-6 rounded-b-[3.75rem] pointer-events-auto relative z-20">
      <%= render "posts/reactions", post: post %>
    </div>
  </div>
</div>
</file>

<file path="app/views/stats/index.html.erb">
<style>
  @keyframes sheen-skew {
    0% { transform: translate(-100%, -100%) skewX(-12deg); }
    100% { transform: translate(100%, 100%) skewX(-12deg); }
  }
  .animate-sheen-skew {
    animation: sheen-skew 1.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
  }
</style>

<div class="py-8 px-4 sm:px-6 lg:px-8">
  <div class="max-w-7xl mx-auto relative z-10">
    <!-- ヘッダー -->
    <div class="mb-10 text-center sm:text-left">
      <h1 class="inline-block text-4xl sm:text-5xl font-black text-slate-800 dark:text-transparent dark:bg-clip-text dark:bg-gradient-to-r dark:from-cyan-300 dark:via-purple-300 dark:to-pink-300 mb-3 dark:drop-shadow-[0_0_20px_rgba(168,85,247,0.6)] tracking-tight animate-pulse-slow">
        STATISTICS
      </h1>
      <p class="inline-block text-gray-600 dark:text-slate-300 dark:bg-clip-text dark:text-transparent dark:bg-gradient-to-r dark:from-slate-300 dark:to-slate-400 font-medium tracking-wide dark:drop-shadow-[0_0_8px_rgba(148,163,184,0.4)]">
        冒険の記録と分析データ
      </p>
    </div>

    <!-- RPG Status Bar (Hero Section) -->
    <div class="relative mb-12 group">
      <!-- Breathing Glow (呼吸する光) -->
      <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-[5rem] blur-xl opacity-[0.02] dark:opacity-30 animate-pulse-slow pointer-events-none transition-opacity duration-500 group-hover:opacity-[0.05]"></div>

      <div class="relative crystal-card crystal-purple !rounded-[5rem] dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(168,85,247,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] group hover:dark:border-purple-500/50 hover:dark:shadow-[0_0_60px_rgba(168,85,247,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] transition-all duration-300 hover:scale-105 overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[5rem] before:pointer-events-none before:animate-pulse">
        <!-- 背景装飾 -->
        <div class="absolute top-0 right-0 w-64 h-64 bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-full blur-3xl -mr-20 -mt-20 pointer-events-none"></div>

        <div class="relative z-10 p-2 sm:p-4">
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-6">
            <div class="flex items-center gap-5">
              <!-- レベルバッジ -->
              <div class="relative">
                <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 dark:from-indigo-600 dark:to-purple-700 flex items-center justify-center shadow-lg transform group-hover:scale-105 transition-transform duration-300 dark:shadow-[0_0_20px_rgba(99,102,241,0.4)] dark:border dark:border-white/20">
                  <div class="text-center">
                    <span class="block text-[10px] text-white/80 font-bold uppercase tracking-wider">Level</span>
                    <span class="text-white font-black text-3xl leading-none dark:drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]"><%= @stats_service.level %></span>
                  </div>
                </div>
                <!-- キラキラエフェクト -->
                <div class="absolute -top-2 -right-2 w-6 h-6 bg-yellow-300 rounded-full blur-md animate-pulse"></div>
              </div>

              <!-- ランク名 -->
              <div>
                <div class="text-xs font-bold text-purple-500 dark:text-purple-300 uppercase tracking-widest mb-1">Current Rank</div>
                <div class="text-3xl sm:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-purple-600 via-pink-500 to-orange-500 dark:from-white dark:via-purple-200 dark:to-pink-200 dark:drop-shadow-[0_0_10px_rgba(232,121,249,0.5)]">
                  <%= @stats_service.rank_name %>
                </div>
              </div>
            </div>

            <!-- Next Level Info -->
            <div class="text-right w-full sm:w-auto bg-white/50 dark:bg-white/5 rounded-xl p-3 backdrop-blur-sm border border-white/20 dark:border-white/5">
              <div class="text-xs font-bold text-purple-500 dark:text-purple-300 mb-1">NEXT LEVEL</div>
              <div class="font-mono font-bold text-gray-700 dark:text-gray-200 flex items-baseline justify-end gap-2">
                <span class="text-sm opacity-70">あと</span>
                <span class="text-blue-600 dark:text-cyan-400 text-2xl dark:drop-shadow-[0_0_8px_rgba(34,211,238,0.6)]"><%= @stats_service.distance_to_next_level %></span>
                <span class="text-sm opacity-70">km</span>
              </div>
            </div>
          </div>

          <!-- XP Progress Bar -->
          <div class="h-3 rounded-full bg-gray-200 dark:bg-slate-800 overflow-hidden shadow-inner">
            <div class="h-full bg-gradient-to-r from-blue-400 via-indigo-500 to-purple-500 dark:from-cyan-400 dark:via-blue-500 dark:to-purple-600 transition-all duration-1000 ease-out rounded-full shadow-[0_0_15px_rgba(99,102,241,0.6)] relative overflow-hidden"
                 style="width: <%= @stats_service.level_progress_percentage %>%">
              <!-- シマーエフェクト -->
              <div class="absolute inset-0 animate-shimmer bg-gradient-to-r from-transparent via-white/30 to-transparent -skew-x-12"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Achievements (Badges) List -->
    <div class="mb-16" data-controller="accordion" data-accordion-is-open-value="false">
      <!-- Accordion Header -->
      <button type="button"
              data-action="click->accordion#toggle"
              class="w-full flex items-center justify-between mb-4 px-6 py-5 crystal-card crystal-orange !rounded-[3.75rem] group hover:scale-105 transition-all duration-300 hover:scale-105 dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(245,158,11,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] hover:dark:border-amber-500/30 hover:dark:shadow-[0_0_60px_rgba(245,158,11,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">

        <!-- Breathing Glow (内部発光) -->
        <div class="absolute -bottom-10 -right-10 w-64 h-64 bg-amber-500/20 rounded-full blur-3xl animate-pulse-slow pointer-events-none"></div>

        <div class="flex items-center gap-4 relative z-10">
          <div class="w-12 h-12 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center">
            <span class="material-symbols-outlined text-amber-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-amber-300 dark:to-yellow-200 text-2xl dark:drop-shadow-[0_0_8px_rgba(251,191,36,0.8)]">military_tech</span>
          </div>
          <div class="text-left">
            <h2 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-amber-600 to-orange-600 dark:from-amber-200 dark:to-orange-200">
              獲得した称号
            </h2>
            <p class="text-xs text-orange-600 dark:text-amber-400/60 font-medium">
              コレクションを見る
            </p>
          </div>
        </div>

        <div class="flex items-center gap-4 relative z-10">
          <div class="px-4 py-1.5 rounded-full bg-amber-100 dark:bg-amber-950/50 border border-amber-200 dark:border-amber-500/30">
            <span class="text-sm font-bold text-amber-700 dark:text-amber-300">
              <%= @stats_service.achievements.count { |a| a[:obtained] } %> <span class="opacity-50 mx-1">/</span> <%= @stats_service.achievements.size %>
            </span>
          </div>
          <span class="material-symbols-outlined text-orange-500 dark:text-amber-400 transition-transform duration-300" data-accordion-target="icon">expand_more</span>
        </div>
      </button>

      <!-- Accordion Content (Horizontal Scroll) -->
      <div class="hidden transition-all duration-300 hover:scale-105 ease-in-out" data-accordion-target="content">
        <div class="flex overflow-x-auto gap-4 pb-6 px-2 snap-x snap-mandatory scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-slate-700 dark:scrollbar-track-slate-800/30 pt-2"
             data-controller="scroll-drag"
             data-action="mousedown->scroll-drag#mousedown mouseleave->scroll-drag#mouseleave mouseup->scroll-drag#mouseup mousemove->scroll-drag#mousemove">
          <% @stats_service.achievements.each do |ach| %>
            <div class="snap-center flex-shrink-0 w-36 flex flex-col items-center text-center group p-4 rounded-2xl transition-all duration-300 hover:scale-105 hover:bg-white/50 dark:hover:bg-white/5 border border-transparent hover:border-gray-200 dark:hover:border-white/10">
              <!-- Badge Icon -->
              <div class="w-20 h-20 rounded-full flex items-center justify-center mb-4 transition-all duration-300 hover:scale-105 relative overflow-hidden
                          <%= ach[:obtained] ? 'bg-gradient-to-br from-yellow-100 to-orange-100 dark:from-amber-900/40 dark:to-yellow-900/40 border-2 border-yellow-400 dark:border-amber-500/50 shadow-lg dark:shadow-[0_0_20px_rgba(245,158,11,0.3)] transform group-hover:scale-110' : 'bg-gray-100 dark:bg-slate-800 border-2 border-gray-200 dark:border-slate-700 grayscale opacity-40' %>">

                <% if ach[:obtained] %>
                  <!-- Shine Effect -->
                  <div class="absolute -top-[50%] -left-[50%] w-[200%] h-[200%] opacity-0 group-hover:opacity-100 transition-opacity duration-500 animate-sheen-skew"
                       style="background: linear-gradient(90deg, transparent 20%, rgba(255,255,255,0.1) 40%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,0.1) 60%, transparent 80%);"></div>
                <% end %>

                <span class="material-symbols-outlined text-4xl <%= ach[:obtained] ? 'text-yellow-600 dark:text-amber-300 dark:drop-shadow-[0_0_5px_rgba(251,191,36,0.8)]' : 'text-gray-400 dark:text-slate-500' %>">
                  <%= ach[:icon] %>
                </span>

                <% unless ach[:obtained] %>
                  <div class="absolute inset-0 flex items-center justify-center bg-black/10 dark:bg-black/40 backdrop-blur-[1px]">
                    <span class="material-symbols-outlined text-gray-500 dark:text-slate-400 text-2xl">lock</span>
                  </div>
                <% end %>
              </div>

              <!-- Badge Name & Description -->
              <p class="text-sm font-bold <%= ach[:obtained] ? 'text-gray-800 dark:text-gray-200' : 'text-gray-500 dark:text-slate-500' %> mb-1 line-clamp-1">
                <%= ach[:name] %>
              </p>
              <p class="text-[10px] text-gray-500 dark:text-slate-400 line-clamp-2 h-8 leading-tight w-full opacity-80">
                <%= ach[:description] %>
              </p>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- 基本統計カード (6つ) -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-16">
      <!-- 累計距離 -->
      <div class="crystal-card crystal-blue !rounded-[3.75rem] dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(6,182,212,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] group hover:dark:border-cyan-500/50 hover:dark:shadow-[0_0_60px_rgba(6,182,212,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] transition-all duration-300 hover:scale-105 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
        <!-- Breathing Glow -->
        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-cyan-500/20 rounded-full blur-3xl animate-pulse-slow pointer-events-none"></div>

        <div class="relative z-10">
          <div class="flex items-center justify-between mb-2">
            <div class="w-12 h-12 rounded-xl bg-blue-100 dark:bg-cyan-950/30 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
              <span class="material-symbols-outlined text-3xl text-blue-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-cyan-300 dark:to-blue-300 dark:drop-shadow-[0_0_8px_rgba(34,211,238,0.8)]">distance</span>
            </div>
            <p class="text-blue-500 dark:text-cyan-200 text-xs font-bold tracking-wider uppercase">総距離</p>
          </div>
          <div class="text-right">
            <p class="inline-block text-3xl sm:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-600 dark:from-cyan-300 dark:via-blue-300 dark:to-cyan-500 drop-shadow-sm"><%= number_with_delimiter(@total_distance) %></p>
            <p class="text-blue-500 dark:text-cyan-400/60 text-xs font-medium mt-1">km</p>
          </div>
        </div>
      </div>

      <!-- 累計日数 -->
      <div class="crystal-card crystal-emerald !rounded-[3.75rem] dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(16,185,129,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] group hover:dark:border-emerald-500/50 hover:dark:shadow-[0_0_60px_rgba(16,185,129,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] transition-all duration-300 hover:scale-105 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
        <!-- Breathing Glow -->
        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-emerald-500/20 rounded-full blur-3xl animate-pulse-slow pointer-events-none"></div>

        <div class="relative z-10">
          <div class="flex items-center justify-between mb-2">
            <div class="w-12 h-12 rounded-xl bg-emerald-100 dark:bg-emerald-950/30 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
              <span class="material-symbols-outlined text-3xl text-emerald-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-emerald-300 dark:to-green-300 dark:drop-shadow-[0_0_8px_rgba(52,211,153,0.8)]">calendar_month</span>
            </div>
            <p class="text-emerald-600 dark:text-emerald-200 text-xs font-bold tracking-wider uppercase">記録日数</p>
          </div>
          <div class="text-right">
            <p class="inline-block text-3xl sm:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-green-600 dark:from-emerald-300 dark:via-green-300 dark:to-emerald-500 drop-shadow-sm"><%= @total_days %></p>
            <p class="text-emerald-600 dark:text-emerald-400/60 text-xs font-medium mt-1">日</p>
          </div>
        </div>
      </div>

      <!-- 連続記録日数 -->
      <div class="crystal-card crystal-orange !rounded-[3.75rem] dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(249,115,22,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] group hover:dark:border-orange-500/50 hover:dark:shadow-[0_0_60px_rgba(249,115,22,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] transition-all duration-300 hover:scale-105 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
        <!-- Breathing Glow -->
        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-orange-500/20 rounded-full blur-3xl animate-pulse-slow pointer-events-none"></div>

        <div class="relative z-10">
          <div class="flex items-center justify-between mb-2">
            <div class="w-12 h-12 rounded-xl bg-orange-100 dark:bg-orange-950/30 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
              <span class="material-symbols-outlined text-3xl text-orange-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-orange-300 dark:to-amber-300 dark:drop-shadow-[0_0_8px_rgba(251,146,60,0.8)]">local_fire_department</span>
            </div>
            <p class="text-orange-600 dark:text-orange-200 text-xs font-bold tracking-wider uppercase">連続日数</p>
          </div>
          <div class="text-right">
            <p class="inline-block text-3xl sm:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-orange-600 to-red-600 dark:from-orange-300 dark:via-red-300 dark:to-orange-500 drop-shadow-sm"><%= @current_streak %></p>
            <p class="text-orange-600 dark:text-orange-400/60 text-xs font-medium mt-1">日</p>
          </div>
        </div>
      </div>

      <!-- 平均距離 -->
      <div class="crystal-card crystal-purple !rounded-[3.75rem] dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(168,85,247,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] group hover:dark:border-purple-500/50 hover:dark:shadow-[0_0_60px_rgba(168,85,247,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] transition-all duration-300 hover:scale-105 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
        <!-- Breathing Glow -->
        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-purple-500/20 rounded-full blur-3xl animate-pulse-slow pointer-events-none"></div>

        <div class="relative z-10">
          <div class="flex items-center justify-between mb-2">
            <div class="w-12 h-12 rounded-xl bg-purple-100 dark:bg-purple-950/30 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
              <span class="material-symbols-outlined text-3xl text-purple-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-purple-300 dark:to-pink-300 dark:drop-shadow-[0_0_8px_rgba(192,132,252,0.8)]">trending_up</span>
            </div>
            <p class="text-purple-600 dark:text-purple-200 text-xs font-bold tracking-wider uppercase">平均距離</p>
          </div>
          <div class="text-right">
            <p class="inline-block text-3xl sm:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-violet-600 dark:from-purple-300 dark:via-fuchsia-300 dark:to-purple-500 drop-shadow-sm"><%= @average_distance %></p>
            <p class="text-purple-600 dark:text-purple-400/60 text-xs font-medium mt-1">km / 日</p>
          </div>
        </div>
      </div>

      <!-- 最長記録 -->
      <div class="crystal-card crystal-pink !rounded-[3.75rem] dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(236,72,153,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] group hover:dark:border-pink-500/50 hover:dark:shadow-[0_0_60px_rgba(236,72,153,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] transition-all duration-300 hover:scale-105 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
        <!-- Breathing Glow -->
        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-pink-500/20 rounded-full blur-3xl animate-pulse-slow pointer-events-none"></div>

        <div class="relative z-10">
          <div class="flex items-center justify-between mb-2">
            <div class="w-12 h-12 rounded-xl bg-pink-100 dark:bg-pink-950/30 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
              <span class="material-symbols-outlined text-3xl text-pink-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-pink-300 dark:to-rose-300 dark:drop-shadow-[0_0_8px_rgba(244,114,182,0.8)]">emoji_events</span>
            </div>
            <p class="text-pink-600 dark:text-pink-200 text-xs font-bold tracking-wider uppercase">自己ベスト</p>
          </div>
          <div class="text-right">
            <p class="inline-block text-3xl sm:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-pink-600 to-rose-600 dark:from-pink-300 dark:via-rose-300 dark:to-pink-500 drop-shadow-sm"><%= @max_distance %></p>
            <p class="text-pink-600 dark:text-pink-400/60 text-xs font-medium mt-1">km</p>
          </div>
        </div>
      </div>

      <!-- 目標達成率 -->
      <div class="crystal-card crystal-amber !rounded-[3.75rem] dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(245,158,11,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] group hover:dark:border-amber-500/50 hover:dark:shadow-[0_0_60px_rgba(245,158,11,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] transition-all duration-300 hover:scale-105 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
        <!-- Breathing Glow -->
        <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-amber-500/20 rounded-full blur-3xl animate-pulse-slow pointer-events-none"></div>

        <div class="relative z-10">
          <div class="flex items-center justify-between mb-2">
            <div class="w-12 h-12 rounded-xl bg-amber-100 dark:bg-amber-950/30 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
              <span class="material-symbols-outlined text-3xl text-amber-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-amber-300 dark:to-yellow-300 dark:drop-shadow-[0_0_8px_rgba(251,191,36,0.8)]">stars</span>
            </div>
            <p class="text-amber-600 dark:text-amber-200 text-xs font-bold tracking-wider uppercase">今月の目標</p>
          </div>
          <div class="text-right">
            <p class="inline-block text-3xl sm:text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-amber-600 to-yellow-600 dark:from-amber-300 dark:via-yellow-300 dark:to-amber-500 drop-shadow-sm"><%= @monthly_goal_rate %>%</p>
            <p class="text-amber-600 dark:text-amber-400/60 text-xs font-medium mt-1">達成率</p>
          </div>
        </div>
      </div>
    </div>

    <!-- グラフセクション -->
    <div
      data-controller="stats-chart"
      data-stats-chart-daily-url-value="<%= stats_chart_data_path(type: 'daily') %>"
      data-stats-chart-weekly-url-value="<%= stats_chart_data_path(type: 'weekly') %>"
      data-stats-chart-monthly-url-value="<%= stats_chart_data_path(type: 'monthly') %>"
      data-stats-chart-weekday-url-value="<%= stats_chart_data_path(type: 'weekday') %>"
      data-stats-chart-pace-url-value="<%= stats_chart_data_path(type: 'pace') %>"
      data-stats-chart-calories-url-value="<%= stats_chart_data_path(type: 'calories') %>"
      data-stats-chart-time-of-day-url-value="<%= stats_chart_data_path(type: 'time_of_day') %>"
      class="space-y-8"
    >
      <!-- 時系列グラフ (タブ切り替え) -->
      <div class="crystal-card crystal-blue !rounded-[3.75rem] dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(59,130,246,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] group hover:dark:border-blue-500/50 hover:dark:shadow-[0_0_60px_rgba(59,130,246,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] transition-all duration-300 hover:scale-105 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
        <!-- Glass Cover -->
        <div class="absolute inset-0 bg-gradient-to-br from-white/10 via-white/5 to-transparent pointer-events-none"></div>

        <div class="relative z-10">
          <div class="flex items-center gap-3 mb-6">
            <span class="material-symbols-outlined text-3xl text-blue-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-blue-300 dark:to-cyan-300 dark:drop-shadow-[0_0_10px_rgba(59,130,246,0.8)]">show_chart</span>
            <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-600 dark:from-blue-200 dark:to-cyan-200 drop-shadow-sm">
              距離の推移
            </h2>
          </div>

          <!-- タブナビゲーション -->
          <div class="flex space-x-2 mb-6 border-b border-blue-200/50 dark:border-white/10 overflow-x-auto scrollbar-hide flex-nowrap pb-1">
            <button
              class="tab-button active px-4 py-2 font-medium text-white bg-gradient-to-r from-blue-500 to-blue-600 dark:text-blue-300 dark:bg-blue-900/30 rounded-t-xl border-b-2 border-blue-600 dark:border-blue-400 transition-all"
              data-tab="daily-chart"
              onclick="switchTab(event, 'daily-chart')"
            >
              日別 (30日)
            </button>
            <button
              class="tab-button px-4 py-2 font-medium text-blue-500 dark:text-slate-400 border-b-2 border-transparent hover:text-blue-700 dark:hover:text-slate-200 rounded-t-xl transition-all"
              data-tab="weekly-chart"
              onclick="switchTab(event, 'weekly-chart')"
            >
              週別 (12週)
            </button>
            <button
              class="tab-button px-4 py-2 font-medium text-blue-500 dark:text-slate-400 border-b-2 border-transparent hover:text-blue-700 dark:hover:text-slate-200 rounded-t-xl transition-all"
              data-tab="monthly-chart"
              onclick="switchTab(event, 'monthly-chart')"
            >
              月別 (12ヶ月)
            </button>
          </div>

          <!-- グラフエリア -->
          <div class="tab-content" id="daily-chart">
            <div class="h-80">
              <canvas data-stats-chart-target="dailyCanvas"></canvas>
            </div>
          </div>

          <div class="tab-content hidden" id="weekly-chart">
            <div class="h-80">
              <canvas data-stats-chart-target="weeklyCanvas"></canvas>
            </div>
          </div>

          <div class="tab-content hidden" id="monthly-chart">
            <div class="h-80">
              <canvas data-stats-chart-target="monthlyCanvas"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- 傾向分析 (曜日 & 時間帯) -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- 曜日別分析 -->
        <div class="crystal-card crystal-emerald !rounded-[3.75rem] dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(16,185,129,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] group hover:dark:border-emerald-500/50 hover:dark:shadow-[0_0_60px_rgba(16,185,129,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] transition-all duration-300 hover:scale-105 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
          <!-- Glass Cover -->
          <div class="absolute inset-0 bg-gradient-to-br from-white/10 via-white/5 to-transparent pointer-events-none"></div>

          <div class="relative z-10">
            <div class="flex items-center gap-3 mb-6">
              <span class="material-symbols-outlined text-3xl text-emerald-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-emerald-300 dark:to-green-300 dark:drop-shadow-[0_0_10px_rgba(16,185,129,0.8)]">bar_chart</span>
              <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-green-600 dark:from-emerald-200 dark:to-green-200 drop-shadow-sm">
                曜日別の傾向
              </h2>
            </div>
            <p class="text-emerald-700 dark:text-emerald-200/60 mb-4 text-sm font-medium">
              どの曜日に散歩していますか?平均距離を比較してみましょう
            </p>
            <div class="h-80">
              <canvas data-stats-chart-target="weekdayCanvas"></canvas>
            </div>
          </div>
        </div>

        <!-- 時間帯別分析 -->
        <div class="crystal-card crystal-purple !rounded-[3.75rem] dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(168,85,247,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] group hover:dark:border-purple-500/50 hover:dark:shadow-[0_0_60px_rgba(168,85,247,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] transition-all duration-300 hover:scale-105 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
          <!-- Glass Cover -->
          <div class="absolute inset-0 bg-gradient-to-br from-white/10 via-white/5 to-transparent pointer-events-none"></div>

          <div class="relative z-10">
            <div class="flex items-center gap-3 mb-6">
              <span class="material-symbols-outlined text-3xl text-purple-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-purple-300 dark:to-pink-300 dark:drop-shadow-[0_0_10px_rgba(168,85,247,0.8)]">schedule</span>
              <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-pink-600 dark:from-purple-200 dark:to-pink-200 drop-shadow-sm">
                冒険の時間帯
              </h2>
            </div>
            <p class="text-purple-700 dark:text-purple-200/60 mb-4 text-sm font-medium">
              あなたの活動時間帯の傾向です。朝型？それとも夜型？
            </p>
            <div class="h-80 relative w-full">
              <canvas data-stats-chart-target="timeOfDayCanvas"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- パフォーマンス分析 -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- ペース推移 -->
        <div class="crystal-card crystal-amber !rounded-[3.75rem] dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(245,158,11,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] group hover:dark:border-amber-500/50 hover:dark:shadow-[0_0_60px_rgba(245,158,11,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] transition-all duration-300 hover:scale-105 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
          <!-- Glass Cover -->
          <div class="absolute inset-0 bg-gradient-to-br from-white/10 via-white/5 to-transparent pointer-events-none"></div>

          <div class="relative z-10">
            <div class="flex items-center gap-3 mb-6">
              <span class="material-symbols-outlined text-3xl text-amber-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-amber-300 dark:to-yellow-300 dark:drop-shadow-[0_0_10px_rgba(245,158,11,0.8)]">timer</span>
              <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-amber-600 to-yellow-600 dark:from-amber-200 dark:to-yellow-200 drop-shadow-sm">
                ペースの推移
              </h2>
            </div>
            <p class="text-amber-700 dark:text-amber-200/60 mb-4 text-sm font-medium">
              過去30日間の平均ペース (分/km)
            </p>
            <div class="h-64">
              <canvas data-stats-chart-target="paceCanvas"></canvas>
            </div>
          </div>
        </div>

        <!-- カロリー推移 -->
        <div class="crystal-card crystal-orange !rounded-[3.75rem] dark:bg-slate-900/40 dark:backdrop-blur-xl dark:border dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_30px_rgba(249,115,22,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] group hover:dark:border-orange-500/50 hover:dark:shadow-[0_0_60px_rgba(249,115,22,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] transition-all duration-300 hover:scale-105 relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:!rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
          <!-- Glass Cover -->
          <div class="absolute inset-0 bg-gradient-to-br from-white/10 via-white/5 to-transparent pointer-events-none"></div>

          <div class="relative z-10">
            <div class="flex items-center gap-3 mb-6">
              <span class="material-symbols-outlined text-3xl text-orange-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-orange-300 dark:to-red-300 dark:drop-shadow-[0_0_10px_rgba(249,115,22,0.8)]">local_fire_department</span>
              <h2 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-orange-600 to-red-600 dark:from-orange-200 dark:to-red-200 drop-shadow-sm">
                カロリー消費の推移
              </h2>
            </div>
            <p class="text-orange-700 dark:text-orange-200/60 mb-4 text-sm font-medium">
              過去30日間の消費カロリー
            </p>
            <div class="h-64">
              <canvas data-stats-chart-target="caloriesCanvas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- タブ切り替え用スクリプト -->
<script>
  function switchTab(event, tabId) {
    // 全てのタブボタンとコンテンツを非アクティブ化
    document.querySelectorAll('.tab-button').forEach(btn => {
      btn.classList.remove('active', 'text-blue-600', 'border-blue-600', 'dark:text-blue-300', 'dark:bg-blue-900/30', 'dark:border-blue-400')
      btn.classList.add('text-gray-500', 'border-transparent', 'dark:text-slate-400', 'dark:hover:text-slate-200')
    })
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.add('hidden')
    })

    // クリックされたタブをアクティブ化
    event.target.classList.remove('text-gray-500', 'border-transparent', 'dark:text-slate-400', 'dark:hover:text-slate-200')
    event.target.classList.add('active', 'text-blue-600', 'border-blue-600', 'dark:text-blue-300', 'dark:bg-blue-900/30', 'dark:border-blue-400')
    document.getElementById(tabId).classList.remove('hidden')
  }
</script>
</file>

<file path="bin/test_all.sh">
#!/bin/bash
# ~/workspace/tekumemo/bin/test_all.sh
# 
# ⚠️ 重要: このスクリプトはDocker環境専用です ⚠️
# Docker環境でコンテナ内でテストを実行します。
# ホストマシン上で直接実行しないでください。
#
# 前提条件:
#   - Docker EngineがWSL2上で起動していること
#   - docker-compose.ymlで定義されたコンテナが起動していること
# 
# 使い方:
#   1. 実行権限を付与（初回のみ）:
#      chmod +x bin/test_all.sh
#   
#   2. スクリプトを実行:
#      ./bin/test_all.sh
#
# このスクリプトは以下を自動で実行します:
#   1. Dockerコンテナの起動確認
#   2. テストデータベースの準備
#   3. RuboCopによるコードスタイルチェック
#   4. RSpecによる全テスト実行

set -e  # エラーが発生したら即座に終了

echo "========================================="
echo "  全テスト実行 (Docker環境)"
echo "========================================="
echo ""
echo "ℹ️  このスクリプトはDocker環境でのみ動作します"
echo ""

# Docker環境チェック: dockerコマンドが利用可能か確認
if ! command -v docker &> /dev/null; then
    echo "🚨 エラー: Dockerがインストールされていません"
    echo ""
    echo "このプロジェクトはDocker環境でのテスト実行が必須です。"
    echo "以下を確認してください:"
    echo "  1. Docker EngineがWSL2にインストールされているか"
    echo "  2. dockerコマンドが使用可能か"
    echo ""
    exit 1
fi

# コンテナが起動しているか確認し、起動していなければ自動起動
echo "--- Step 1/4: Dockerコンテナの状態確認 ---"
if ! docker ps | grep -q tekumemo-web; then
    echo "🔄 コンテナが起動していないため、自動起動します..."
    docker compose up -d
    
    echo "⏳ コンテナの起動を待機中..."
    # コンテナが安定するまで少し待つ
    sleep 10
else
    echo "✅ コンテナ起動済み"
fi
echo ""
# テストデータベースの準備
# テストDBへの既存接続を強制切断（ObjectInUseエラー回避の最終手段）
echo "🔄 DBコンテナを再起動して接続を完全リセット中..."
docker compose restart db
# DBの起動待機（最大30秒）
echo "⏳ DBの起動を待機中..."
for i in {1..30}; do
  if docker exec tekumemo-db pg_isready -U postgres > /dev/null 2>&1; then
    echo "✅ DB起動完了"
    break
  fi
  sleep 1
done

# デバッグ: DB一覧を表示
# PostgreSQLのFORCEオプションを使って強制的にDBを削除
echo "💣 テストDBを強制削除中..."
docker exec tekumemo-db psql -U postgres -d postgres -c "DROP DATABASE IF EXISTS tekumemo_test WITH (FORCE);" > /dev/null 2>&1 || true

docker exec tekumemo-web bash -c "DATABASE_URL='postgresql://postgres:password@db:5432/tekumemo_test' RAILS_ENV=test DISABLE_DATABASE_ENVIRONMENT_CHECK=1 bundle exec rails db:test:prepare"
if [ $? -ne 0 ]; then
    echo "🚨 テストDBの準備に失敗しました"
    exit 1
fi
echo "✅ テストDB準備完了"
echo ""

# RuboCopの実行（自動修正）
echo "--- Step 3/4: RuboCopによるコードスタイルチェック ---"
docker exec tekumemo-web bash -c "bundle exec rubocop -a"
rubocop_exit=$?
if [ $rubocop_exit -ne 0 ]; then
    echo "⚠️ RuboCopで修正不能なスタイルエラーが検出されました"
    echo "テストは続行しますが、後で確認してください"
fi
echo ""

# RSpecの実行
echo "--- Step 4/4: RSpec実行（Docker環境内） ---"
docker exec tekumemo-web bash -c "DATABASE_URL='postgresql://postgres:password@db:5432/tekumemo_test' RAILS_ENV=test bundle exec rspec spec/ --format documentation"
rspec_exit=$?

echo ""
echo "========================================="
if [ $rspec_exit -eq 0 ]; then
    echo "✅ 全てのテストが成功しました！"
    echo "========================================="
    exit 0
else
    echo "🚨 テストが失敗しました"
    echo "========================================="
    echo ""
    echo "修正のヒント:"
    echo "  1. 上記のエラーログを確認してください"
    echo "  2. 該当のspecファイルを個別に実行して詳細を確認:"
    echo "     docker exec tekumemo-web bash -c 'RAILS_ENV=test bundle exec rspec spec/path/to/failing_spec.rb -fd'"
    echo "  3. デバッグ用にbinding.bを使用できます"
    echo ""
    echo "ℹ️  注意: テストはDocker環境内で実行されています"
    exit 1
fi
</file>

<file path=".cursorrules">
# 思考プロセスの言語設定 (THINKING PROCESS)
あなたは純粋な日本語話者のAIアシスタントです。
内部的な推論・計画・ステップごとの検討（思考プロセス）は、**必ずすべて日本語**で行ってください。

<thinking_constraints>
1. **開始フレーズの固定:** 思考ブロック（Thinking block）を開始する際は、必ず「**【思考プロセスを開始します】**」という日本語から書き始めてください。これにより、以降の言語を日本語に強力に引き寄せます。
2. **完全日本語化:** 内部モノローグ、プランニング、コード解析の推論もすべて日本語で行います。技術用語やコードが英語であっても、その説明や論理構築に英語を使用することは禁止です。
3. **自己修正:** もし思考中に英語が混じっていることに気づいたら、即座に日本語に修正して継続してください。
</thinking_constraints>

---

# 禁止事項
- **config/tailwind.config.js の作成禁止:** Rails 7以降、Tailwind CSSの設定は必ずプロジェクトルートにある `.tailwind.config.js` を編集してください。

---

# 役割と振る舞い
あなたは実務経験豊富なRuby on Railsのシニアエンジニアであり、教育熱心なメンター**「らんて君」**です。
- **対象:** WEBエンジニアを目指す初学者。
- **方針:** 単に回答を出すだけでなく、「なぜそうするのか」という理由と背景をセットで解説し、ユーザーの成長を促してください。

---

# 言語・コミュニケーション設定
- **会話と言語:** すべて日本語で行ってください。専門用語は初心者にわかりやすく補足します。
- **コード内コメント:** ロジックの流れがわかるよう、日本語で丁寧に記述してください。
- **命名規則:** 変数名・メソッド名は意味が明確な英語を使用し、省略形は避けてください。

---

# コーディング指針
- **The Rails Way:** Rails標準のメソッドや機能を優先し、レールに乗った書き方を推奨してください。
- **可読性第一:** プロの視点で、シンプルかつ初学者が理解しやすい清潔なコードを提案してください。
- **セキュリティ:** SQLインジェクションやXSSなどの脆弱性を防ぐ実装を徹底し、危険な場合は理由を警告してください。
- **フォーマット:** 適度な空白と改行を用い、読みやすさを確保してください。

---

# 技術スタック詳細 (Ruby on Rails)
- **環境:** Rails 7系 / Ruby 3.2系
- **MVCの責務:** 「モデルに書くべき理由」「コントローラーを薄くする意義」をその都度説明してください。
- **デバッグ:** 修正時には `binding.b` の活用場所やログの読み方もアドバイスしてください。
- **Rubyの活用:** `map`, `select`, `present?` など、Ruby/Railsらしい便利なメソッドを積極的に紹介してください。

---

# Webアプリケーション開発ガイドライン
- **Docker Engine ＋ WSL2(ubuntu):** Docker Engine ＋ WSL2(ubuntu)を使用しています。コンテナを起動するときはWSL2を最優先してコマンド入力。
- **Core:** HTML (ERB) / JavaScript (Stimulus/Turbo / Hotwire)。
- **Styling:** TailwindCSSを使用。
- **Stimulus規則:** `app/javascript/controllers/` に新規作成した際は、必ず直後に `bin/rails stimulus:manifest:update` を実行するようユーザーに促すか、手順に含めてください。

## デザインシステム
**詳細は `.docs/` 以下の定義ファイルを厳密に参照してください。**
- **Light Mode:** Crystal Claymorphism (`.docs/DESIGN_SYSTEM_LIGHT.md`)
- **Dark Mode:** Holographic Neon Noir / God Mode (`.docs/DESIGN_SYSTEM_DARK.md`)
- **要件:** リッチな美学、プレミアム感、レスポンシブ対応、アクセシビリティ（WCAG 2.1 A）。

---

# テスト・エラー対応
- **Docker環境必須:** このプロジェクトでは、**必ずDocker環境内でテストを実行**してください。`./bin/test_all.sh`を使用するか、`docker exec tekumemo-web bash -c "RAILS_ENV=test bundle exec rspec ..."`の形式で実行すること。
- **RSpec:** `describe` や `context` は日本語で構造化し、テストデータ作成（FactoryBot）や検証（expect）には何を確認しているかコメントを添えてください。
- **エラー解説:** メッセージを噛み砕いて翻訳し、原因を説明。「次はどこを見れば自力で解決できるか」のヒントを添えてください。

---

# 運用・フロー管理

## ファイル・ディレクトリ運用
- **ドキュメント:** .md形式などの出力は日本語で行ってください。
- **作業ディレクトリ:** プロジェクト内のディレクトリを汚さないよう、一時ファイルやドキュメント作成にはプロジェクト外（`/home/nukon999/.gemini`）を使用してください。

## Git運用
- **ブランチ:** 指示があるまで新規作成禁止。命名は `数字-主目的-内容`（例: 07-mvp-setup）。
- **コミット:** 勝手に行わず、適切なタイミングで提案してください。
  - 形式: `type: 日本語` (例: `feat: ログイン機能の実装`)
  - 構造: タイトル、空行、箇条書きの要約を徹底。
- **プッシュ:** 指示があるまで禁止。実行前には必ず `bundle exec rubocop -a` を実行すること。
- **プルリクエスト:** 就活の面接官に評価されるレベルの、丁寧で印象の良い日本語概要を作成してください。末尾にSS添付用のスペースを確保してください。

---
ここまでは今後遵守すべき.cursorrulesの再確認です。次の会話のユーザーの指示から作業を開始してください。
</file>

<file path="app/services/google_fit_service.rb">
require "google/apis/fitness_v1"
require "signet/oauth_2/client"

class GoogleFitService
  # Google Fit Activity Types
  ACTIVITY_TYPE_BIKING = 1
  ACTIVITY_TYPE_WALKING = 7
  ACTIVITY_TYPE_RUNNING = 8
  TARGET_ACTIVITY_TYPES = [ ACTIVITY_TYPE_BIKING, ACTIVITY_TYPE_WALKING, ACTIVITY_TYPE_RUNNING ].freeze

  def initialize(user)
    @user = user
    return if user.guest? # ゲストユーザーはAPIクライアント初期化不要

    @client = Google::Apis::FitnessV1::FitnessService.new
    auth = Signet::OAuth2::Client.new(access_token: user.google_token)
    @client.authorization = auth
  end

  # 指定期間の歩数と距離データを日別で取得する
  # @param start_date [Date] 開始日
  # @param end_date [Date] 終了日
  # @return [Hash] 日付(Date)をキー、データ(Hash)を値とするハッシュ
  #   例: { Date.new(2025, 12, 20) => { steps: 5000, distance: 3.5, calories: 150 } }
  def fetch_activities(start_date, end_date)
    return { data: fetch_dummy_activities(start_date, end_date) } if @user.guest?

    # タイムゾーンを考慮して、開始日の00:00:00から終了日の23:59:59までのミリ秒を取得
    start_time_millis = start_date.beginning_of_day.to_i * 1000
    end_time_millis = end_date.end_of_day.to_i * 1000

    begin
      # === 1. 歩数データを日次バケットで取得（全歩数を正確に取得） ===
      steps_by_date = fetch_daily_steps(start_time_millis, end_time_millis)

      # === 2. 距離・カロリー・アクティビティ時間はアクティビティセグメントから取得 ===
      activity_data_by_date = fetch_activity_segment_data(start_time_millis, end_time_millis)

      # === 3. マージして結果を作成 ===
      result = {}

      # 両方のデータソースの日付を統合
      all_dates = (steps_by_date.keys + activity_data_by_date.keys).uniq

      all_dates.each do |date|
        steps = steps_by_date[date] || 0
        activity = activity_data_by_date[date] || { distance_m: 0.0, calories: 0, activity_duration_min: 0, cycling_duration_min: 0, start_time: nil }

        # 時間計算: 歩行時間（歩数÷100） + サイクリング時間（1/2換算後）
        walk_duration = (steps / 100.0).round
        total_duration = walk_duration + activity[:cycling_duration_min]

        result[date] = {
          steps: steps,
          distance: (activity[:distance_m] / 1000.0).round(2),
          calories: activity[:calories],
          duration: total_duration,
          start_time: activity[:start_time] || date.in_time_zone.change(hour: 8)
        }
      end

      { data: result }

    rescue Google::Apis::AuthorizationError => e
      Rails.logger.error "Google Fit Authorization Error for user #{@user.id}: #{e.message}"
      { error: :auth_expired }
    rescue Google::Apis::ClientError => e
      if e.status_code == 401 || e.status_code == 403
        Rails.logger.error "Google Fit Auth Error (#{e.status_code}) for user #{@user.id}: #{e.message}"
        { error: :auth_expired }
      else
        Rails.logger.error "Google Fit Client Error for user #{@user.id}: #{e.message}"
        { error: :api_error, message: e.message }
      end
    rescue Google::Apis::ServerError => e
      Rails.logger.error "Google Fit Server Error for user #{@user.id}: #{e.message}"
      { error: :api_error, message: "Google Fitサーバーエラー" }
    rescue StandardError => e
      Rails.logger.error "Unexpected error in GoogleFitService for user #{@user.id}: #{e.message}"
      { error: :api_error, message: "予期しないエラー" }
    end
  end

  private

  # 日次バケットで歩数のみ取得（全歩数を漏れなく取得）
  def fetch_daily_steps(start_time_millis, end_time_millis)
    request = Google::Apis::FitnessV1::AggregateRequest.new(
      aggregate_by: [
        Google::Apis::FitnessV1::AggregateBy.new(
          data_type_name: "com.google.step_count.delta"
        )
      ],
      bucket_by_time: Google::Apis::FitnessV1::BucketByTime.new(
        duration_millis: 86400000  # 24時間（ミリ秒）
      ),
      start_time_millis: start_time_millis,
      end_time_millis: end_time_millis
    )

    response = @client.aggregate_dataset("me", request)
    result = {}

    response.bucket.each do |bucket|
      date = Time.at(bucket.start_time_millis / 1000).in_time_zone.to_date
      steps = 0

      bucket.dataset.each do |dataset|
        dataset.point.each do |point|
          point.value.each do |value|
            steps += value.int_val.to_i if value.int_val
          end
        end
      end

      result[date] = steps if steps > 0
    end

    result
  end

  # アクティビティセグメントで距離・カロリー・時間を取得（電車・車を除外）
  def fetch_activity_segment_data(start_time_millis, end_time_millis)
    request = Google::Apis::FitnessV1::AggregateRequest.new(
      aggregate_by: [
        Google::Apis::FitnessV1::AggregateBy.new(
          data_type_name: "com.google.distance.delta"
        ),
        Google::Apis::FitnessV1::AggregateBy.new(
          data_type_name: "com.google.calories.expended"
        )
      ],
      bucket_by_activity_segment: Google::Apis::FitnessV1::BucketByActivity.new(
        min_duration_millis: 0
      ),
      start_time_millis: start_time_millis,
      end_time_millis: end_time_millis
    )

    response = @client.aggregate_dataset("me", request)
    daily_stats = Hash.new { |h, k| h[k] = { distance_m: 0.0, calories: 0, activity_duration_min: 0, cycling_duration_min: 0, max_calories: 0, start_time: nil } }

    response.bucket.each do |bucket|
      activity_type = bucket.activity

      # 歩行(7)、ランニング(8)、サイクリング(1)のみ対象
      next unless TARGET_ACTIVITY_TYPES.include?(activity_type)

      bucket_time = Time.at(bucket.start_time_millis / 1000).in_time_zone
      bucket_date = bucket_time.to_date

      duration_millis = bucket.end_time_millis - bucket.start_time_millis
      duration_min = (duration_millis / 1000.0 / 60.0).round

      distance, calories = extract_distance_and_calories_from_bucket(bucket)

      # サイクリングの換算処理
      if activity_type == ACTIVITY_TYPE_BIKING
        # 距離データが空なら時間から推定（街乗り自転車の平均速度 15km/h）
        if distance == 0.0
          distance = (duration_min / 60.0) * 15 * 1000 # メートル単位
        end

        distance = distance / 4.0      # 距離1/4
        cycling_duration_min = (duration_min / 2.0).round  # 時間1/2
        daily_stats[bucket_date][:cycling_duration_min] += cycling_duration_min
      else
        # 歩行・ランニングの時間はそのまま加算しない（歩数から推定するため）
      end

      # 日別に加算
      daily_stats[bucket_date][:distance_m] += distance
      daily_stats[bucket_date][:calories] += calories

      # 最大カロリーのセグメントの開始時刻を記録（時間帯判定用）
      if calories > daily_stats[bucket_date][:max_calories]
        daily_stats[bucket_date][:max_calories] = calories
        daily_stats[bucket_date][:start_time] = bucket_time
      end
    end

    daily_stats
  end

  # バケットから距離とカロリーを抽出
  def extract_distance_and_calories_from_bucket(bucket)
    distance = 0.0
    calories = 0

    bucket.dataset.each_with_index do |dataset, index|
      dataset.point.each do |point|
        point.value.each do |value|
          case index
          when 0  # 距離
            distance += value.fp_val.to_f if value.fp_val
          when 1  # カロリー
            calories += value.fp_val.to_i if value.fp_val
          end
        end
      end
    end

    [ distance, calories ]
  end

  # 管理者またはゲストユーザー用のダミーデータを生成する
  def fetch_dummy_activities(start_date, end_date)
    result = {}
    (start_date..end_date).each do |date|
      # ランダムな歩数など（デモ用に少し変動させる）
      # 土日は少し多めに
      base_steps = date.saturday? || date.sunday? ? 8000 : 5000
      steps = base_steps + rand(-1000..3000)

      # 距離 (歩数 * 0.7m 概算)
      distance_m = steps * 0.7
      distance_km = (distance_m / 1000.0).round(2)

      # カロリー (歩数 * 0.04kcal 概算)
      calories = (steps * 0.04).round

      # 時間 (歩数 / 100歩/分 概算)
      duration = (steps / 100.0).round

      result[date] = {
        steps: steps,
        distance: distance_km,
        calories: calories,
        duration: duration,
        start_time: date.in_time_zone.change(hour: 8, min: 0) # 毎朝8時開始とする
      }
    end
    result
  end
end
</file>

<file path="app/services/rpg_card_generator_service.rb">
require "mini_magick"

class RpgCardGeneratorService
  # レイアウト定数
  IMAGE_SIZE = "1200x630".freeze
  AVATAR_SIZE = 340
  AVATAR_POS = "60,120".freeze

  # ヘッダー
  HEADER_TITLE_POS = "+85+35".freeze
  HEADER_DATE_POS = "+50+45".freeze

  # 左カラム
  PLAYER_LABEL_POS = "+65+465".freeze
  USER_NAME_BASE_Y = 500
  LV_BADGE_POS = "+330+433".freeze

  # 右カラム
  MESSAGE_POS = "+480+160".freeze

  # ステータスバー
  STATUS_LABEL_Y = 510
  STATUS_VALUE_Y = 540
  STATUS_COL1_X = 460 # Distance/Rank
  STATUS_COL2_X = 700 # Steps
  STATUS_COL3_X = 940 # Location

  def initialize(user:, title:, message:, stats: {}, theme: :quest)
    @user = user
    @title = title
    @message = message
    @stats = stats
    @theme = theme
  end

  def generate
    require "mini_magick" unless defined?(MiniMagick)

    base_tempfile = nil
    avatar_tempfile = nil
    base_image_path = nil
    avatar_path = nil

    begin
      # 1. ベース画像生成
      base_tempfile = Tempfile.new([ "ogp_base", ".png" ])
      base_image_path = base_tempfile.path
      base_tempfile.close

      # 背景色設定
      colors = theme_colors
      system("convert", "-size", IMAGE_SIZE, "xc:#{colors[:background]}", base_image_path)

      image = ::MiniMagick::Image.new(base_image_path)
      font_path = Rails.root.join("public/fonts/MPLUS1p-Bold.ttf").to_s

      # 2. アバター画像の準備
      avatar_tempfile, avatar_path = prepare_avatar_image

      # 3. 描画処理一括実行
      image.combine_options do |c|
        c.font font_path

        # アバター合成
        c.draw "image Over #{AVATAR_POS} #{AVATAR_SIZE},#{AVATAR_SIZE} '#{avatar_path}'"

        # --- ヘッダーエリア ---
        # タイトル枠
        c.fill "none"
        c.stroke colors[:accent]
        c.strokewidth 3
        c.draw "roundrectangle 50,30 500,100 10,10"

        # タイトルテキスト
        c.stroke "none"
        c.fill colors[:accent]
        c.gravity "NorthWest"
        c.pointsize 36
        c.annotate HEADER_TITLE_POS, @title

        # 日付 (右上のデジタル時計風)
        c.fill colors[:text_secondary]
        c.pointsize 30
        c.gravity "NorthEast"
        date_text = @stats[:date] || Time.current.strftime("%Y-%m-%d")
        c.annotate HEADER_DATE_POS, date_text

        # --- 左側: アバター枠 & 情報 ---
        c.fill "none"
        c.stroke colors[:border]
        c.strokewidth 4
        c.draw "rectangle 50,120 410,460" # アバター枠 (高さ340)

        # ユーザー名プレート
        c.fill colors[:panel_bg]
        c.stroke colors[:border]
        c.strokewidth 2
        c.draw "rectangle 50,460 410,560" # 高さ100 (下端560)

        # ラベル "PLAYER"
        c.stroke "none"
        c.fill colors[:text_secondary]
        c.pointsize 20
        c.gravity "NorthWest"
        c.annotate PLAYER_LABEL_POS, "PLAYER"

        # ユーザー名
        c.fill colors[:text_primary]
        draw_user_name(c, @user.name)

        # Lvバッジ
        if @stats[:level].present?
          c.fill colors[:accent]
          c.draw "rectangle 320,430 400,460"
          c.fill "#000000"
          c.pointsize 22
          c.annotate LV_BADGE_POS, "Lv.#{@stats[:level]}"
        end

        # --- 右側: メッセージウィンドウ ---
        c.fill "none"
        c.stroke colors[:border]
        c.strokewidth 3
        c.draw "roundrectangle 440,120 1150,480 10,10"

        # メッセージ本文
        c.stroke "none"
        c.fill colors[:text_primary]
        c.gravity "NorthWest"
        c.pointsize 36

        draw_message_body(c, @message)

        # --- 下部: ステータスバー ---
        draw_status_bar(c, colors)
      end

      image.format "jpg"
      image.quality 75 # ファイルサイズ削減と生成速度向上のため圧縮率を調整
      image.strip # メタデータを削除してサイズを削減
      blob = image.to_blob
      image.destroy!

      blob
    ensure
      # 確実にTempfileをクリーンアップ
      avatar_tempfile&.close!
      base_tempfile&.close!
    end
  end

  private

  def theme_colors
    case @theme
    when :ranking
      {
        background: "#1a0b2e", # Deep Purple
        text_primary: "#ffffff",
        text_secondary: "#a78bfa", # Light Purple
        accent: "#ffd700", # Gold
        border: "#8b5cf6", # Violet
        panel_bg: "#2e1065" # Darker Purple
      }
    else # :quest (default)
      {
        background: "#0f172a", # Dark Navy
        text_primary: "#ffffff",
        text_secondary: "#94a3b8", # Slate 400
        accent: "#fbbf24", # Amber 400 (Gold-ish)
        border: "#cbd5e1", # Slate 300
        panel_bg: "#1e293b" # Slate 800
      }
    end
  end

  def prepare_avatar_image
    avatar_tempfile = Tempfile.new([ "avatar", ".png" ])
    avatar_path = avatar_tempfile.path
    avatar_used = false

    # アバター画像の取得ロジック
    # 優先順位: Uploaded > Google > Default

    # 1. アップロード画像 (avatar_type: uploaded)
    if @user.uploaded? && @user.uploaded_avatar.attached?
      begin
        File.binwrite(avatar_path, @user.uploaded_avatar.download)

        avatar = ::MiniMagick::Image.new(avatar_path)
        avatar.combine_options do |c|
          c.resize "#{AVATAR_SIZE}x#{AVATAR_SIZE}^"
          c.gravity "center"
          c.extent "#{AVATAR_SIZE}x#{AVATAR_SIZE}"
        end
        avatar_used = true
        Rails.logger.info "Using uploaded avatar for user #{@user.id}"
      rescue => e
        Rails.logger.warn "Failed to use uploaded avatar: #{e.message}"
      end
    end

    # 2. Google画像 (avatar_type: google)
    if !avatar_used && @user.google? && @user.avatar_url.present?
      # ステップ2-1: キャッシュされたアバターを優先使用（超高速）
      if @user.cached_avatar.attached?
        begin
          # Active StorageからダウンロードしてTempfileに保存
          @user.cached_avatar.download do |file|
            File.binwrite(avatar_path, file.read)
          end

          avatar = ::MiniMagick::Image.new(avatar_path)
          avatar.combine_options do |c|
            c.resize "#{AVATAR_SIZE}x#{AVATAR_SIZE}^"
            c.gravity "center"
            c.extent "#{AVATAR_SIZE}x#{AVATAR_SIZE}"
          end
          avatar_used = true
          Rails.logger.info "Using cached google avatar for user #{@user.id}"
        rescue => e
          Rails.logger.warn "Failed to use cached avatar: #{e.message}"
          # キャッシュ使用失敗 → 次のステップへ
        end
      end

      # ステップ2-2: キャッシュがない場合、Googleからダウンロード＆保存
      unless avatar_used
        begin
          require "open-uri"
          downloaded_file = URI.open(@user.avatar_url, read_timeout: 2, open_timeout: 2)
          File.binwrite(avatar_path, downloaded_file.read)

          avatar = ::MiniMagick::Image.new(avatar_path)
          avatar.combine_options do |c|
            c.resize "#{AVATAR_SIZE}x#{AVATAR_SIZE}^"
            c.gravity "center"
            c.extent "#{AVATAR_SIZE}x#{AVATAR_SIZE}"
          end
          avatar_used = true

          # ダウンロード成功したらキャッシュに保存（次回から高速化）
          cache_avatar_for_future_use(downloaded_file)
          Rails.logger.info "Downloaded and cached google avatar for user #{@user.id}"
        rescue => e
          Rails.logger.error "Failed to download avatar: #{e.message}"
        end
      end
    end

    unless avatar_used
      # ステップ3: フォールバック - イニシャル画像
      initial = @user.name[0..1].upcase rescue "U"
      system("convert", "-size", "#{AVATAR_SIZE}x#{AVATAR_SIZE}", "xc:#3b82f6", avatar_path)

      font_path = Rails.root.join("public/fonts/MPLUS1p-Bold.ttf").to_s
      temp_img = ::MiniMagick::Image.new(avatar_path)
      temp_img.combine_options do |c|
        c.font font_path
        c.gravity "Center"
        c.pointsize 150
        c.fill "#ffffff"
        c.annotate "+0+0", initial
      end
      temp_img.write(avatar_path)
    end

    # Tempfileオブジェクトとパスの両方を返す（ensureブロックでクリーンアップできるように）
    [ avatar_tempfile, avatar_path ]
  end

  # アバター画像を将来使用するためにキャッシュ
  def cache_avatar_for_future_use(downloaded_file)
    return if @user.cached_avatar.attached? # 既にキャッシュ済みならスキップ

    begin
      downloaded_file.rewind # ファイルポインタを先頭に戻す
      @user.cached_avatar.attach(
        io: downloaded_file,
        filename: "avatar_#{@user.id}.jpg",
        content_type: "image/jpeg"
      )
      Rails.logger.info "Avatar cached for user #{@user.id}"
    rescue => e
      Rails.logger.warn "Failed to cache avatar for user #{@user.id}: #{e.message}"
      # キャッシュ失敗は無視（次回再試行）
    end
  end

  def draw_user_name(c, name)
    clean_name = strip_emoji(name)
    user_name = clean_name.truncate(20)

    font_size = if user_name.length <= 6
                  40 # 45 -> 40
    elsif user_name.length <= 10
                  30 # 32 -> 30
    elsif user_name.length <= 15
                  20 # 22 -> 20
    else
                  16
    end

    c.pointsize font_size
    y_pos = USER_NAME_BASE_Y
    y_pos += 5 if font_size < 40
    c.annotate "+65+#{y_pos}", user_name
  end

  def draw_message_body(c, message)
    if message.present?
      if @theme == :ranking
        # ランキングの場合は改行を維持して表示
        wrapped_body = strip_emoji(message)
      else
        # 通常（投稿）の場合は改行をスペースに置換して自動折り返し
        clean_text = strip_emoji(message).gsub(/\R/, " ").squeeze(" ")
        body_text = clean_text.truncate(65)
        wrapped_body = wrap_text(body_text, 17)
      end
    else
      wrapped_body = "冒険の記録が更新されました！\n明日もまた、新たな旅へ出かけよう。"
    end
    c.annotate MESSAGE_POS, wrapped_body
  end

  def draw_status_bar(c, colors)
    # 描画基準を左上に固定（前の設定を引き継がないように明示）
    c.gravity "NorthWest"

    # 枠組み (3分割)
    c.fill "none"
    c.stroke colors[:border]
    c.strokewidth 2

    # 左: Distance / Rank
    c.draw "rectangle 440,500 660,600"
    # 中: Exp (Steps)
    c.draw "rectangle 680,500 900,600"
    # 右: Location / Period
    c.draw "rectangle 920,500 1150,600"

    # ラベルと値
    c.stroke "none"
    c.fill colors[:text_secondary]
    c.pointsize 20

    # Item 1 (Distance or Rank)
    label1 = @stats[:label1] || "DISTANCE"
    value1 = @stats[:value1] || "0 km"
    c.annotate "+#{STATUS_COL1_X}+#{STATUS_LABEL_Y}", label1
    c.fill colors[:accent]
    c.pointsize 40

    # DISTANCEの場合は左寄せ（元の位置）、RANKの場合は中央寄せ
    offset_x = label1 == "DISTANCE" ? 20 : 50
    c.annotate "+#{STATUS_COL1_X + offset_x}+#{STATUS_VALUE_Y}", value1.to_s

    # Item 2 (Steps)
    c.fill colors[:text_secondary]
    c.pointsize 20
    label2 = @stats[:label2] || "EXP (STEPS)"
    value2 = @stats[:value2] || "0"
    c.annotate "+#{STATUS_COL2_X}+#{STATUS_LABEL_Y}", label2
    c.fill colors[:accent]
    c.pointsize 40
    c.annotate "+#{STATUS_COL2_X + 20}+#{STATUS_VALUE_Y}", value2.to_s

    # Item 3 (Location or Period)
    c.fill colors[:text_secondary]
    c.pointsize 20
    label3 = @stats[:label3] || "LOCATION"
    value3 = @stats[:value3] || "TekuMemo"
    c.annotate "+#{STATUS_COL3_X}+#{STATUS_LABEL_Y}", label3
    c.fill colors[:text_primary]

    clean_value3 = strip_emoji(value3)
    text_length = clean_value3.length

    # フォントサイズと表示テキストの調整
    font_size = 40 # デフォルトを40にアップ
    display_text = clean_value3

    if clean_value3.ascii_only?
      # 半角のみ（距離や期間など）は大きく表示
      # ただし "TekuMemo" (デフォルト値) は幅を取るため少し小さくする
      if clean_value3 == "TekuMemo"
        font_size = 26 # 32 -> 26 に縮小して確実にはみ出し防止
      else
        font_size = 40
      end
    else
      # 全角含む（場所など）は文字数で調整
      if text_length <= 5
        font_size = 36
      elsif text_length <= 8
        font_size = 24 # 縮小して収める
      else
        font_size = 24
        # 9文字以上の場合、強制的に「7文字 + ...」にする
        display_text = "#{clean_value3[0...7]}..."
      end
    end

    c.pointsize font_size
    # フォントサイズが小さい場合は少し下にずらす
    y_offset = font_size < 36 ? 8 : 5

    c.annotate "+#{STATUS_COL3_X + 10}+#{STATUS_VALUE_Y + y_offset}", display_text
  end

  def wrap_text(text, max_width)
    text.scan(/.{1,#{max_width}}/m).join("\n")
  end

  def strip_emoji(text)
    # 基本的な絵文字範囲 + 異体字セレクタなどを除去
    # 完全にすべての絵文字を除去するのは難しいが、主要な範囲をカバー
    text.to_s.scrub("")
        .gsub(/[\u{1F300}-\u{1F9FF}]/, "") # Miscellaneous Symbols and Pictographs
        .gsub(/[\u{2600}-\u{26FF}]/, "")   # Miscellaneous Symbols
        .gsub(/[\u{2700}-\u{27BF}]/, "")   # Dingbats
        .gsub(/[\u{1F600}-\u{1F64F}]/, "") # Emoticons
        .gsub(/[\u{1F680}-\u{1F6FF}]/, "") # Transport and Map Symbols
        .gsub(/[\u{1F900}-\u{1F9FF}]/, "") # Supplemental Symbols and Pictographs
        .gsub(/[\u{1FA70}-\u{1FAFF}]/, "") # Symbols and Pictographs Extended-A
        .gsub(/\u{FE0F}/, "")              # Variation Selector-16 (emoji style)
        .strip
  end
end
</file>

<file path="app/views/devise/registrations/edit.html.erb">
<% content_for :title, "アカウント設定 - てくメモ" %>

<div class="flex-1 p-4 pb-24 sm:pb-10 w-full max-w-2xl mx-auto">
  <div class="mb-8 text-center">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-slate-50 flex items-center justify-center space-x-2">
      <span class="material-symbols-outlined text-3xl text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-500">manage_accounts</span>
      <span>アカウント設定</span>
    </h1>
    <p class="text-sm text-gray-500 dark:text-slate-400 mt-2">プロフィールの確認と変更ができます</p>
  </div>

  <div class="relative bg-[#fdfbf7] dark:bg-slate-900/40 backdrop-blur-2xl dark:backdrop-blur-xl border-2 border-white/60 dark:border-white/10 dark:border-t-white/40 shadow-[20px_20px_60px_rgba(168,85,247,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(168,85,247,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(168,85,247,0.3)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_50px_rgba(168,85,247,0.2)] rounded-[2.5rem] p-6 sm:p-10 overflow-hidden transition-all duration-300 group">

    <!-- Candy Texture (Light Mode Only) -->
    <div class="absolute inset-0 bg-gradient-to-br from-white/20 via-white/5 to-transparent pointer-events-none dark:hidden"></div>
    <div class="absolute -top-20 -right-20 w-64 h-64 bg-gradient-to-br from-blue-400/20 to-cyan-400/20 dark:from-cyan-500/20 dark:to-blue-500/20 rounded-full blur-3xl pointer-events-none"></div>
    <div class="absolute -bottom-20 -left-20 w-64 h-64 bg-gradient-to-tr from-blue-400/20 to-cyan-400/20 dark:from-cyan-500/20 dark:to-blue-500/20 rounded-full blur-3xl pointer-events-none"></div>

    <!-- Top Highlight -->
    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-400/50 to-transparent opacity-50"></div>

    <div class="flex flex-col items-center mb-8 mt-2">
       <%= render "users/avatar_section", user: resource %>
    </div>

    <!-- Google連携セクション（ゲストユーザーには非表示） -->
    <% unless current_user.guest? %>
      <div class="mb-8 p-4 bg-blue-50/50 dark:bg-slate-800/50 rounded-2xl border border-blue-100 dark:border-slate-700">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
          <div class="flex items-center space-x-3">
            <div class="bg-white dark:bg-slate-700 p-2 rounded-full shadow-sm">
              <svg class="w-6 h-6" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
            </div>
            <div>
              <h3 class="text-sm font-bold text-gray-800 dark:text-white">Google連携</h3>
              <p class="text-xs text-gray-500 dark:text-slate-400">Google Fitデータを使用可能</p>
            </div>
          </div>

          <% if resource.google_uid.present? %>
            <div class="flex items-center space-x-3 w-full sm:w-auto justify-center sm:justify-end">
              <div class="flex items-center text-green-600 dark:text-green-400 font-bold text-xs bg-white dark:bg-slate-900 px-3 py-1.5 rounded-full border border-green-200 dark:border-green-900 shadow-sm">
                <span class="material-symbols-outlined text-base mr-1">check_circle</span>
                <span>連携済み</span>
              </div>

              <!-- 連携解除ボタン（モーダルを開く） -->
              <button type="button" onclick="document.getElementById('disconnect_modal').classList.remove('hidden')" class="text-gray-400 hover:text-red-500 transition-colors">
                <span class="material-symbols-outlined text-xl" title="連携を解除する">link_off</span>
              </button>


            </div>
          <% else %>
            <div class="w-full sm:w-auto flex justify-center sm:justify-end">
              <button type="button" onclick="document.getElementById('connect_warning_modal').classList.remove('hidden')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transition-all transform hover:-translate-y-0.5 text-xs flex items-center">
                <span class="material-symbols-outlined mr-1 text-base">add_link</span>
                連携する
              </button>
            </div>
          <% end %>
        </div>

        <!-- Google Fit連携の注意書き（プレビュー版） -->
        <%= render "shared/google_fit_notice" %>

        <!-- Google認証警告ガイド -->
        <%= render "shared/google_auth_guide" %>
      </div>
    <% end %>


    <!-- アカウント削除セクション（メインカード内に統合） -->
    <% unless resource.google_uid.present? %>
      <% content_for :modals do %>
        <div id="connect_warning_modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
          <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 max-w-md w-full shadow-2xl border border-gray-100 dark:border-gray-700">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center">
              <span class="material-symbols-outlined text-yellow-500 mr-2">warning</span>
              連携前の確認
            </h3>

            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/50 rounded-xl p-4 mb-6">
              <p class="text-xs font-bold text-yellow-800 dark:text-yellow-400 mb-2">MVP期間中の特別仕様</p>
              <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                Google Fit連携を行うには、<span class="font-bold text-red-500">Googleアカウントのメールアドレスと一致させる必要があります。</span>
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                もし異なるメールアドレスのGoogleアカウントを選択した場合、<br>
                登録されているメールアドレスが変更されます。
              </p>
            </div>

            <div class="mb-6">
              <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">現在のメールアドレス</p>
              <p class="font-mono text-sm font-bold text-gray-700 dark:text-slate-300 bg-gray-50 dark:bg-slate-800 p-2 rounded-lg border border-gray-200 dark:border-gray-700">
                <%= resource.email %>
              </p>
            </div>

            <div class="flex justify-end space-x-3">
              <button type="button" onclick="document.getElementById('connect_warning_modal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 font-medium text-sm">キャンセル</button>

              <%= button_to user_google_oauth2_omniauth_authorize_path, method: :post, data: { turbo: false }, class: "bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors text-sm flex items-center" do %>
                <span class="material-symbols-outlined text-lg mr-1">arrow_forward</span>
                連携に進む
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>

    <% if current_user.guest? %>
      <!-- ゲストユーザー向けメッセージ -->
      <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-slate-800/80 dark:to-slate-800/60 rounded-[2.5rem] p-8 text-center border-2 border-white/60 dark:border-white/10 shadow-md relative overflow-hidden">
        <!-- 背景装飾 -->
        <div class="absolute -right-10 top-1/2 -translate-y-1/2 w-32 h-32 bg-blue-400/10 rounded-full blur-2xl"></div>
        <div class="absolute -left-10 top-1/2 -translate-y-1/2 w-32 h-32 bg-purple-400/10 rounded-full blur-2xl"></div>

        <div class="relative z-10">
          <div class="text-5xl mb-4">🔒</div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-3">
            ゲストモード中です
          </h3>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-6 max-w-md mx-auto">
            ゲストモードでは設定の変更はできません。<br>
            実際に設定を変更するには、Googleアカウントでログインしてください。
          </p>

          <!-- 現在の設定（読み取り専用表示） -->
          <div class="bg-white/50 dark:bg-slate-900/30 rounded-2xl p-6 max-w-md mx-auto mb-6 text-left">
            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-4 flex items-center">
              <span class="material-symbols-outlined text-lg mr-2">info</span>
              現在の設定
            </h4>
            <dl class="space-y-3 text-sm">
              <div class="flex justify-between items-center">
                <dt class="text-gray-500 dark:text-gray-400">ユーザー名</dt>
                <dd class="font-bold text-gray-800 dark:text-gray-200"><%= current_user.name %></dd>
              </div>
              <div class="flex justify-between items-center">
                <dt class="text-gray-500 dark:text-gray-400">目標距離</dt>
                <dd class="font-bold text-gray-800 dark:text-gray-200"><%= current_user.target_distance %> m</dd>
              </div>
              <div class="flex justify-between items-center">
                <dt class="text-gray-500 dark:text-gray-400">通知機能</dt>
                <dd class="font-bold text-gray-500 dark:text-gray-400">ゲスト（変更不可）</dd>
              </div>
              <div class="flex justify-between items-center">
                <dt class="text-gray-500 dark:text-gray-400">セキュリティ設定</dt>
                <dd class="font-bold text-gray-500 dark:text-gray-400">ゲスト（変更不可）</dd>
              </div>
              <div class="flex justify-between items-center">
                <dt class="text-gray-500 dark:text-gray-400">権限</dt>
                <dd class="font-bold text-purple-600 dark:text-purple-400">ゲスト（閲覧のみ）</dd>
              </div>
            </dl>
          </div>

          <%= button_to destroy_user_session_path, method: :delete, form: { data: { turbo: false } }, class: "inline-flex items-center gap-2 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5" do %>
            <span class="material-symbols-outlined">logout</span>
            ログアウトして正式登録する
          <% end %>
        </div>
      </div>
    <% else %>
      <!-- 通常ユーザー向けフォーム -->
      <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put, data: { turbo: false }, class: "space-y-6" }) do |f| %>
        <% if resource.errors.any? %>
          <div class="bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-300 p-4 rounded-xl text-sm border border-red-100 dark:border-red-800/30">
            <ul class="list-disc list-inside">
              <% resource.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div>
          <%= f.label :name, "ユーザー名（表示名）", class: "block text-sm font-bold text-gray-700 dark:text-slate-300 mb-2" %>
          <div class="relative group">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500 group-focus-within:text-cyan-500 transition-colors">badge</span>
            <%= f.text_field :name,
                placeholder: "表示名を入力",
                class: "w-full pl-10 pr-4 py-3 bg-white dark:bg-slate-900/50 border border-gray-200 dark:border-white/10 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all outline-none text-gray-800 dark:text-slate-50 placeholder-gray-400 dark:placeholder-slate-500 shadow-inner" %>
          </div>
          <p class="text-xs text-gray-500 dark:text-slate-500 mt-1 ml-1">ランキングや投稿などで他のユーザーに表示されます</p>
        </div>

        <div>
          <%= f.label :target_distance, "1日の目標(月間) [m]", class: "block text-sm font-bold text-gray-700 dark:text-slate-300 mb-2" %>
          <div class="relative group">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-slate-500 group-focus-within:text-cyan-500 transition-colors">flag</span>
            <%= f.number_field :target_distance,
                step: 100,
                placeholder: "例: 3000",
                class: "w-full pl-10 pr-4 py-3 bg-white dark:bg-slate-900/50 border border-gray-200 dark:border-white/10 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all outline-none text-gray-800 dark:text-slate-50 placeholder-gray-400 dark:placeholder-slate-500 shadow-inner" %>
          </div>
          <p class="text-xs text-gray-500 dark:text-slate-500 mt-1 ml-1">1日の目標距離をメートル単位で設定します（デフォルト: 3000）</p>
        </div>

        <%# 通知設定セクション（アコーディオン） %>
        <div class="py-4 my-6" data-controller="accordion" data-accordion-is-open-value="false">
          <button type="button" data-action="click->accordion#toggle" class="w-full flex items-center justify-between focus:outline-none">
            <h3 class="text-base font-bold text-gray-700 dark:text-slate-300 flex items-center hover:text-purple-600 dark:hover:text-purple-400 transition-colors">
              <span class="material-symbols-outlined text-purple-500 mr-2">notifications</span>
              通知設定
            </h3>
            <span class="material-symbols-outlined text-gray-400 transition-transform duration-300" data-accordion-target="icon">expand_more</span>
          </button>

          <div class="hidden space-y-6 mt-6" data-accordion-target="content">
            <%# ブラウザ通知許可ボタン %>
            <div class="" data-controller="push-notification" data-push-notification-vapid-public-key-value="<%= ENV['VAPID_PUBLIC_KEY'] %>">
              <button type="button" data-action="click->push-notification#subscribe" class="w-full h-14 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-fuchsia-400 dark:to-violet-500 text-white font-bold rounded-full border-2 border-white/30 dark:border-white/20 shadow-[0_10px_25px_rgba(168,85,247,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] hover:shadow-[0_15px_35px_rgba(168,85,247,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] dark:shadow-[0_0_20px_rgba(168,85,247,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:hover:shadow-[0_0_40px_rgba(168,85,247,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] hover:-translate-y-1 active:scale-95 transition-all duration-300 flex items-center justify-center gap-2 group/btn relative overflow-hidden">
                <span class="material-symbols-outlined text-xl group-hover/btn:scale-110 transition-transform">notifications_active</span>
                <span>この端末で通知を受け取る</span>
              </button>
              <p class="text-xs text-center text-gray-400 dark:text-slate-500 mt-2">
                ※ボタンを押すとブラウザの通知許可ダイアログが表示されます
              </p>
            </div>

            <%# 散歩時間リマインド %>
            <div class="notification-group p-4 bg-purple-50 dark:bg-purple-900/20 dark:backdrop-blur-sm rounded-3xl border-2 border-purple-100 dark:border-purple-500/30 dark:border-t-white/40 shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2),0_0_20px_rgba(168,85,247,0.15)]">
              <div class="relative">
                <label class="cursor-pointer block pr-16">
                  <%= f.check_box :walk_reminder_enabled,
                      class: "sr-only peer",
                      onchange: "this.closest('.notification-group').querySelector('.time-input-container').classList.toggle('hidden', !this.checked)" %>
                  <div class="absolute top-0 right-0 w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600"></div>
                  <div>
                    <span class="text-sm font-bold text-gray-700 dark:text-gray-300">散歩時間のリマインド</span>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">指定した時刻に散歩を促す通知を送信します</p>
                  </div>
                </label>
              </div>

              <div class="time-input-container <%= 'hidden' unless resource.walk_reminder_enabled %> mt-4">
                <div class="flex items-center space-x-2">
                  <span class="material-symbols-outlined text-gray-400 text-lg">schedule</span>
                  <%= f.time_field :walk_reminder_time,
                      class: "px-3 py-2 bg-white dark:bg-slate-800 border border-gray-200 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-purple-500 outline-none dark:text-white" %>
                  <span class="text-xs text-gray-500 dark:text-gray-400">に通知</span>
                </div>
              </div>
            </div>

            <%# 非アクティブリマインド %>
            <div class="notification-group p-4 bg-orange-50 dark:bg-orange-900/20 dark:backdrop-blur-sm rounded-3xl border-2 border-orange-100 dark:border-orange-500/30 dark:border-t-white/40 shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2),0_0_20px_rgba(251,146,60,0.15)]">
              <div class="relative">
                <label class="cursor-pointer block pr-16">
                  <%= f.check_box :inactive_days_reminder_enabled,
                      class: "sr-only peer",
                      onchange: "this.closest('.notification-group').querySelector('.threshold-input-container').classList.toggle('hidden', !this.checked)" %>
                  <div class="absolute top-0 right-0 w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 dark:peer-focus:ring-orange-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-orange-600"></div>
                  <div>
                    <span class="text-sm font-bold text-gray-700 dark:text-gray-300">非アクティブ時のリマインド</span>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">一定期間散歩していない場合に通知を送信します</p>
                  </div>
                </label>
              </div>

              <div class="threshold-input-container <%= 'hidden' unless resource.inactive_days_reminder_enabled %> mt-4">
                <div class="flex items-center space-x-2">
                  <span class="material-symbols-outlined text-gray-400 text-lg">event_busy</span>
                  <%= f.number_field :inactive_days_threshold,
                      min: 1,
                      max: 30,
                      class: "w-20 px-3 py-2 bg-white dark:bg-slate-800 border border-gray-200 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 outline-none dark:text-white text-center" %>
                  <span class="text-xs text-gray-500 dark:text-gray-400">日間散歩していない場合に通知</span>
                </div>
              </div>
            </div>

            <%# リアクションまとめ通知 %>
            <div class="p-4 bg-pink-50 dark:bg-pink-900/20 dark:backdrop-blur-sm rounded-3xl border-2 border-pink-100 dark:border-pink-500/30 dark:border-t-white/40 shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2),0_0_20px_rgba(236,72,153,0.15)]">
              <div class="relative">
                <label class="cursor-pointer block pr-16">
                  <%= f.check_box :reaction_summary_enabled, class: "sr-only peer" %>
                  <div class="absolute top-0 right-0 w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 dark:peer-focus:ring-pink-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-pink-600"></div>
                  <div>
                    <span class="text-sm font-bold text-gray-700 dark:text-gray-300">リアクションのまとめ通知</span>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">1日1回、受け取ったリアクションをまとめて通知します</p>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>

        <%# セキュリティ設定セクション（アコーディオン） %>
        <div class="py-4 my-6" data-controller="accordion" data-accordion-is-open-value="false">
          <button type="button" data-action="click->accordion#toggle" class="w-full flex items-center justify-between focus:outline-none py-2">
            <h3 class="text-base font-bold text-gray-700 dark:text-slate-300 flex items-center hover:text-cyan-600 dark:hover:text-cyan-400 transition-colors">
              <span class="material-symbols-outlined text-cyan-500 mr-2">lock</span>
              セキュリティ設定
            </h3>
            <span class="material-symbols-outlined text-gray-400 transition-transform duration-300" data-accordion-target="icon">expand_more</span>
          </button>

          <div class="hidden mt-6" data-accordion-target="content">
            <div class="mb-4">
              <%= f.label :email, "メールアドレス", class: "block text-xs font-bold text-gray-500 dark:text-slate-400 mb-1" %>

              <% if resource.google_uid.present? %>
                <div class="relative">
                  <%= f.email_field :email,
                      disabled: true,
                      class: "w-full pl-4 pr-4 py-2 bg-gray-100 dark:bg-slate-800/50 border border-gray-200 dark:border-white/10 rounded-lg text-sm text-gray-500 dark:text-slate-500 cursor-not-allowed select-none shadow-inner" %>
                  <p class="text-xs text-gray-400 dark:text-slate-500 mt-1 flex items-center">
                    <span class="material-symbols-outlined text-sm mr-1">info</span>
                    Googleアカウントで管理されています
                  </p>
                </div>
              <% else %>
                <%= f.email_field :email,
                    class: "w-full pl-4 pr-4 py-2 bg-white dark:bg-slate-900/50 border border-gray-200 dark:border-white/10 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none transition-all text-gray-800 dark:text-slate-50 placeholder-gray-400 dark:placeholder-slate-500 shadow-inner" %>
              <% end %>
            </div>

            <div class="mb-4">
              <%= f.label :password, "新しいパスワード（変更する場合のみ）", class: "block text-xs font-bold text-gray-500 dark:text-slate-400 mb-1" %>
              <%= f.password_field :password,
                  placeholder: "6文字以上",
                  class: "w-full pl-4 pr-4 py-2 bg-white dark:bg-slate-900/50 border border-gray-200 dark:border-white/10 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none transition-all text-gray-800 dark:text-slate-50 placeholder-gray-400 dark:placeholder-slate-500 shadow-inner" %>
            </div>

            <div class="mb-2">
              <%= f.label :password_confirmation, "パスワード確認", class: "block text-xs font-bold text-gray-500 dark:text-slate-400 mb-1" %>
              <%= f.password_field :password_confirmation,
                  class: "w-full pl-4 pr-4 py-2 bg-white dark:bg-slate-900/50 border border-gray-200 dark:border-white/10 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none transition-all text-gray-800 dark:text-slate-50 placeholder-gray-400 dark:placeholder-slate-500 shadow-inner" %>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-100 dark:border-white/10">
              <%= f.label :current_password, "現在のパスワード", class: "block text-xs font-bold text-gray-700 dark:text-slate-300 mb-1" %>
              <%= f.password_field :current_password,
                  autocomplete: "current-password",
                  placeholder: "変更時のみ入力",
                  class: "w-full pl-4 pr-4 py-2 bg-gray-50 dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg text-sm focus:ring-2 focus:ring-cyan-500 focus:border-transparent outline-none transition-all text-gray-800 dark:text-slate-50 placeholder-gray-400 dark:placeholder-slate-500 shadow-inner" %>
              <p class="text-xs text-red-600 dark:text-red-400 mt-1 font-bold">
                <span class="material-symbols-outlined text-sm align-bottom mr-0.5">info</span>
                メールアドレス・パスワード変更時は入力必須です
              </p>
              <div class="mt-2 text-right">
                <%= link_to "パスワードを忘れた場合", new_password_path(resource_name), class: "text-xs text-cyan-600 dark:text-cyan-400 hover:underline" %>
                <span class="text-xs text-red-500 dark:text-red-400 ml-1">※MVPでは未実装です</span>
              </div>
            </div>
          </div>
        </div>

        <div class="pt-2">
          <%= f.button class: "w-full h-14 bg-gradient-to-r from-cyan-500 to-blue-600 dark:from-cyan-400 dark:to-blue-500 text-white font-bold rounded-full border-2 border-white/30 dark:border-white/20 shadow-[0_10px_25px_rgba(59,130,246,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] hover:shadow-[0_15px_35px_rgba(59,130,246,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] dark:shadow-[0_0_20px_rgba(34,211,238,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:hover:shadow-[0_0_40px_rgba(34,211,238,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] hover:-translate-y-1 active:scale-95 transition-all duration-300 flex items-center justify-center gap-2 group/btn relative overflow-hidden" do %>
            <span class="material-symbols-outlined text-xl group-hover/btn:scale-110 transition-transform">save</span>
            <span>変更を保存する</span>
          <% end %>
        </div>
      <% end %>
    <% end %>

    <!-- アカウント削除セクション（メインカード内に統合） -->
    <div class="mt-10 pt-8 border-t border-gray-100 dark:border-white/10">
      <h3 class="text-xs font-bold text-gray-400 dark:text-slate-500 mb-4 px-1 uppercase tracking-wider">アカウント管理</h3>

      <%= render "users/pwa_settings" %>

      <div class="bg-red-50 dark:bg-red-900/20 dark:backdrop-blur-sm backdrop-blur-sm rounded-3xl p-6 border-2 border-red-100 dark:border-red-500/30 dark:border-t-white/40 shadow-[inset_2px_2px_5px_rgba(0,0,0,0.05),inset_-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2),0_0_20px_rgba(239,68,68,0.15)]">
        <% if current_user.guest? %>
          <!-- ゲストユーザー用（自動削除の案内） -->
          <div class="flex items-center space-x-4">
             <div class="bg-orange-100 dark:bg-orange-900/40 p-2 rounded-full">
               <span class="material-symbols-outlined text-orange-500 dark:text-orange-400">hourglass_top</span>
             </div>
             <div>
               <h4 class="text-orange-800 dark:text-orange-300 font-bold text-sm">ゲストアカウントの有効期限</h4>
               <p class="text-orange-600/80 dark:text-orange-400/80 text-xs mt-0.5">
                 このアカウントは作成から24時間後に<span class="font-bold">自動的に削除</span>されます。
               </p>
             </div>
          </div>
        <% else %>
          <!-- 通常ユーザー用（削除機能） -->
          <div class="flex items-center justify-between flex-wrap gap-4">
            <div>
              <h4 class="text-red-800 dark:text-red-300 font-bold flex items-center">
                <span class="material-symbols-outlined mr-1 text-lg">warning</span>
                アカウントの削除
              </h4>
              <p class="text-red-600/70 dark:text-red-400/70 text-xs mt-1">
                一度削除すると、散歩記録などのデータは復元できません。
              </p>
            </div>

            <%= button_to registration_path(resource_name),
                method: :delete,
                data: { turbo_confirm: "本当にアカウントを削除しますか？\n\nこの操作は取り消せません。\nすべての散歩記録が削除されます。" },
                class: "bg-white dark:bg-red-950/50 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800/50 font-bold py-2 px-4 rounded-lg text-sm hover:bg-red-50 dark:hover:bg-red-900/50 transition-colors shadow-sm" do %>
              削除する
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
    </div>
  </div>
  </div>
  <div class="mt-2 flex flex-col items-center space-y-4 mb-32">
    <%= link_to root_path, class: "flex items-center text-gray-500 dark:text-slate-400 text-sm hover:text-gray-900 dark:hover:text-slate-200 transition-colors" do %>
      <span class="material-symbols-outlined text-lg mr-1">home</span>
      ホームに戻る
    <% end %>

    <%= button_to destroy_user_session_path, method: :delete, class: "text-xs text-red-500/70 hover:text-red-600 dark:text-red-400/70 dark:hover:text-red-300 transition-colors flex items-center" do %>
      <span class="material-symbols-outlined text-sm mr-1">logout</span>
      ログアウト
    <% end %>
  </div>
</div>

<% if resource.google_uid.present? %>
  <% content_for :modals do %>
    <!-- 連携解除モーダル -->
    <div id="disconnect_modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
      <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 max-w-md w-full shadow-2xl border border-gray-100 dark:border-gray-700">
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">Google連携の解除</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
          連携を解除すると、Google Fitのデータが取得できなくなります。<br>
          解除するには、<span class="font-bold text-red-500">現在のパスワード</span>を入力してください。
        </p>

        <%= form_with url: disconnect_google_user_path(resource), method: :delete, scope: :user, class: "space-y-4" do |f| %>
          <div>
            <%= f.label :current_password, "現在のパスワード", class: "block text-xs font-bold text-gray-700 dark:text-slate-300 mb-1" %>
            <%= f.password_field :current_password, required: true, placeholder: "パスワードを入力", class: "w-full px-4 py-2 bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-red-500 outline-none dark:text-white" %>
          </div>

          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="document.getElementById('disconnect_modal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 font-medium text-sm">キャンセル</button>
            <%= f.button class: "bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors text-sm flex items-center" do %>
              <span class="material-symbols-outlined text-lg mr-1">link_off</span>
              解除する
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
<% end %>
</file>

<file path="config/routes.rb">
Rails.application.routes.draw do
  get "stats_coming_soon/index"
  # =====  # Deviseの設定（コントローラーをカスタマイズ）
  devise_for :users, controllers: {
    omniauth_callbacks: "users/omniauth_callbacks",
    registrations: "users/registrations",
    sessions: "users/sessions",
    passwords: "users/passwords"
  }

  # ===== メインページ =====
  # ログイン済みユーザー向けのルート
  root "home#index"

  # ===== アプリケーション機能 =====
  # 散歩記録のCRUD機能（作成・閲覧・更新・削除）
  # ログインしているユーザーのみアクセス可能
  resources :walks do
    collection do
      post :import_google_fit
    end
  end

  # ログインスタンプカレンダー
  # 散歩記録をカレンダー形式で表示
  resources :login_stamps, only: [ :index ]
  resources :achievements, only: [ :index ]
  resources :rankings, only: [ :index ]
  namespace :rankings do
    resources :users, only: [] do
      member do
        get :ogp_image, to: "ogp_images#show", defaults: { format: :jpg }, as: :ogp_image
      end
    end
  end

  # 統計機能
  get "stats", to: "stats#index", as: :stats
  get "stats/chart_data", to: "stats#chart_data", as: :stats_chart_data

  # Google Fit連携
  # ログインユーザーのGoogle Fitデータを取得する
  get "google_fit/status", to: "google_fit#status"
  get "google_fit/daily_data", to: "google_fit#daily_data"

  # SNS機能
  resources :posts, only: [ :index, :show, :create, :destroy ] do
    collection do
      # 自分の投稿履歴を表示
      get "mine"
    end

    resource :ogp_image, only: [ :show ], module: :posts, defaults: { format: :jpg }
    resources :reactions, only: [ :create, :destroy ]
  end

  # 通知機能
  resources :notifications, only: [ :index ] do
    member do
      patch :mark_as_read  # 個別既読
    end
    collection do
      patch :mark_all_as_read  # 一括既読
    end
  end

  # Web Push通知購読
  resources :web_push_subscriptions, only: [ :create ]

  # ユーザープロフィール編集
  resources :users, only: [] do
    member do
      delete :disconnect_google
    end
  end

  # ===== 管理者機能 =====
  namespace :admin do
    root to: "dashboard#index"
    get "dashboard", to: "dashboard#index"

    resources :users, only: [ :index, :destroy ]
    resources :posts, only: [ :index, :show, :destroy ]
    resources :walks, only: [ :index, :show, :destroy ]
    resources :announcements do
      member do
        patch :publish    # 公開
        patch :unpublish  # 非公開
      end
    end
  end

  # ===== システム関連 =====
  # ヘルスチェック
  get "up" => "rails/health#show", as: :rails_health_check
  # Deviseのスコープ内で独自アクションを定義
  devise_scope :user do
    # メールアドレス変更確認画面
    get "users/confirm_email_change", to: "users/omniauth_callbacks#confirm_email_change", as: :confirm_email_change_users
    # メールアドレス更新＆連携実行
    post "users/update_email_and_connect", to: "users/omniauth_callbacks#update_email_and_connect", as: :update_email_and_connect_users
    # アップロード画像の削除
    delete "users/uploaded_avatar", to: "users/registrations#delete_uploaded_avatar", as: :delete_user_uploaded_avatar

    # ゲストログイン
    post "users/guest_sign_in", to: "users/sessions#new_guest", as: :users_guest_sign_in
  end

  # ===== 静的ページ =====
  get "privacy", to: "static_pages#privacy"

  # PWA関連
  get "service-worker" => "rails/pwa#service_worker", as: :pwa_service_worker
  get "manifest" => "rails/pwa#manifest", as: :pwa_manifest
end
</file>

<file path="spec/system/user_settings_spec.rb">
require "rails_helper"

RSpec.describe "ユーザー設定", type: :system, js: true do
  before do
    # OmniAuthのモック設定
    OmniAuth.config.test_mode = true
    OmniAuth.config.mock_auth[:google_oauth2] = nil
  end

  after do
    OmniAuth.config.mock_auth[:google_oauth2] = nil
  end

  describe "新規登録とログイン" do
    it "メールアドレスで新規登録し、ログインできること" do
      visit new_user_registration_path

      fill_in "ユーザー名（表示名）", with: "テストユーザー"
      fill_in "メールアドレス", with: "new@example.com"
      fill_in "パスワード", with: "password123"
      fill_in "register-password-confirmation-field", with: "password123"
      click_button "登録する"

      expect(page).to have_content("アカウント登録が完了しました。")
      # expect(page).to have_content("テストユーザー")
    end

    context "入力内容に不備がある場合" do
      it "必須項目が未入力だと登録できず、エラーメッセージが表示されること" do
        visit new_user_registration_path
        # フォーム内の登録ボタンをクリック
        within "#new_user" do
          click_button "登録する"
        end

        # エラーメッセージの検証
        expect(page).to have_content("エラー")
        expect(page).to have_content("メールアドレスを入力してください")
        expect(page).to have_content("パスワードを入力してください")
        expect(page).to have_content("ユーザー名を入力してください")
      end

      it "パスワード（確認用）が一致しないと登録できないこと" do
        visit new_user_registration_path
        fill_in "ユーザー名（表示名）", with: "テストユーザー"
        fill_in "メールアドレス", with: "new@example.com"
        fill_in "パスワード", with: "password123"
        fill_in "register-password-confirmation-field", with: "mismatch"
        within "#new_user" do
          click_button "登録する"
        end

        expect(page).to have_content("パスワード（確認）とパスワードの入力が一致しません")
      end
    end

    it "未連携のGoogleアカウントではログインできないこと" do
      OmniAuth.config.mock_auth[:google_oauth2] = OmniAuth::AuthHash.new({
        provider: "google_oauth2",
        uid: "unlinked_uid",
        info: { email: "unlinked@example.com" },
        credentials: { token: "token", expires_at: Time.now.to_i + 3600 }
      })

      visit new_user_session_path
      # Googleログインボタンをクリック
      click_link "Googleでログイン"

      expect(page).to have_content("このGoogleアカウントは連携されていません")
    end
  end

  describe "設定画面の操作" do
    let(:user) { FactoryBot.create(:user, name: "既存ユーザー", email: "user@example.com", password: "password123", target_distance: 5000) }

    before do
      OmniAuth.config.test_mode = true
      login_as(user, scope: :user)
      visit edit_user_registration_path
    end

    context "プロフィール更新（異常系）" do
      it "名前を空にすると更新できないこと" do
        fill_in "ユーザー名（表示名）", with: ""
        click_button "変更を保存する"
        expect(page).to have_content("ユーザー名を入力してください")
      end

      it "目標距離に不正な値（0以下）を入力すると更新できないこと" do
        fill_in "1日の目標(月間) [m]", with: "0"
        click_button "変更を保存する"
        expect(page).to have_content("目標距離は0より大きい値にしてください")
      end

      it "目標距離に不正な値（上限超え）を入力すると更新できないこと" do
        fill_in "1日の目標(月間) [m]", with: "100001"
        click_button "変更を保存する"

        # HTML5バリデーションが機能している場合、フォーム送信自体がブロックされるため、
        # Rails側のバリデーションエラーメッセージは表示されない可能性がある。
        # そのため、画面遷移していないこと（保存されていないこと）を確認する。
        expect(page).to have_current_path(edit_user_registration_path)

        # もしRails側のバリデーションエラーが出るならそれを確認するが、
        # 出ない場合はこのチェックはスキップするか、HTML5バリデーションの有無を確認する
        # ここでは保存されていないことを主眼とする
      end
    end

    it "プロフィール（名前・目標距離）を更新できること" do
      fill_in "ユーザー名（表示名）", with: "更新後のユーザー"
      fill_in "1日の目標(月間) [m]", with: "8000"
      click_button "変更を保存する"

      expect(page).to have_content("アカウント情報を変更しました。")
      expect(user.reload.name).to eq("更新後のユーザー")
      expect(user.reload.target_distance).to eq(8000)
    end

    it "パスワードを変更できること（現在のパスワード必須）" do
      # セキュリティ設定のアコーディオンを開く
      find("h3", text: "セキュリティ設定").click

      fill_in "新しいパスワード（変更する場合のみ）", with: "newpassword"
      fill_in "パスワード確認", with: "newpassword"
      fill_in "現在のパスワード", with: "password123"
      click_button "変更を保存する"

      expect(page).to have_content("アカウント情報を変更しました。")
      expect(user.reload.valid_password?("newpassword")).to be true
    end

    it "現在のパスワードが間違っていると更新できないこと" do
      # セキュリティ設定のアコーディオンを開く
      find("h3", text: "セキュリティ設定").click

      fill_in "新しいパスワード（変更する場合のみ）", with: "newpassword"
      fill_in "パスワード確認", with: "newpassword"
      fill_in "現在のパスワード", with: "wrongpassword"
      click_button "変更を保存する"

      expect(page).to have_content("現在のパスワードは不正な値です")
    end

    it "確認用パスワードが一致しないと更新できないこと" do
      # セキュリティ設定のアコーディオンを開く
      find("h3", text: "セキュリティ設定").click

      fill_in "新しいパスワード（変更する場合のみ）", with: "newpassword"
      fill_in "パスワード確認", with: "mismatch"
      fill_in "現在のパスワード", with: "password123"
      click_button "変更を保存する"

      expect(page).to have_content("パスワード（確認）とパスワードの入力が一致しません")
    end



    it "Google連携を行い、その後解除できること", js: true do
      # アバター画像のダウンロードをスタブ
      stub_request(:get, "http://example.com/avatar.jpg").
        with(
          headers: {
            'Accept'=>'*/*',
            'Accept-Encoding'=>'gzip;q=1.0,deflate;q=0.6,identity;q=0.3',
            'User-Agent'=>'Ruby'
          }).
        to_return(status: 200, body: File.read(Rails.root.join("spec/fixtures/files/avatar.jpg")), headers: {})

      # Google連携のモック
      OmniAuth.config.mock_auth[:google_oauth2] = OmniAuth::AuthHash.new({
        provider: "google_oauth2",
        uid: "linked_uid",
        info: { email: "user@example.com", image: "http://example.com/avatar.jpg" },
        credentials: { token: "token", expires_at: Time.now.to_i + 3600 }
      })

      # 連携ボタンをクリック（モーダルが開く）
      click_button "連携する"

      # モーダル内の連携リンクをクリック
      click_button "連携に進む"

      expect(page).to have_content("Googleアカウントと連携しました")
      expect(page).to have_content("連携済み")
      expect(user.reload.google_uid).to eq("linked_uid")

      # 連携解除ボタン（モーダルを開く）をクリック
      # 連携済み状態になるまで少し待つ
      expect(page).to have_content("連携済み")
      find("button span[title='連携を解除する']").click

      # モーダルが表示されるのを確認
      expect(page).to have_content("Google連携の解除")
      expect(page).to have_content("現在のパスワードを入力してください")

      # パスワードを入力して解除
      within "#disconnect_modal" do
        fill_in "現在のパスワード", with: "password123"
        click_button "解除する"
      end

      expect(page).to have_content("Google連携を解除しました")

      # "未連携" という文字は表示されない仕様なので、"連携する" ボタンがあることを確認
      expect(page).to have_content("連携する")
      expect(page).not_to have_content("連携済み")

      # DB上で連携情報が消えているか確認
      user.reload
      expect(user.google_uid).to be_nil
      expect(user.google_token).to be_nil
    end

    it "Google連携解除時にパスワードを間違えると解除できないこと", js: true do
      # 事前にGoogle連携状態にする
      user.update!(
        google_uid: "linked_uid",
        google_token: "token",
        google_expires_at: Time.now + 1.hour
      )
      visit edit_user_registration_path

      # 連携解除ボタン（モーダルを開く）をクリック
      find("button span[title='連携を解除する']").click

      # 間違ったパスワードを入力
      within "#disconnect_modal" do
        fill_in "現在のパスワード", with: "wrongpassword"
        click_button "解除する"
      end

      expect(page).to have_content("パスワードが正しくありません")

      # 連携が解除されていないことを確認
      expect(page).to have_content("連携済み")
      expect(user.reload.google_uid).to eq("linked_uid")
    end

    context "アバター設定" do
      before do
        # Google連携済みの状態にする
        user.update!(
          google_uid: "linked_uid",
          google_token: "token",
          google_expires_at: Time.now + 1.hour,
          avatar_url: "http://example.com/avatar.jpg"
        )
        visit edit_user_registration_path
      end

      it "Google画像とアップロード画像を切り替えられること", js: true do
        # 1. Google画像を選択
        find("button[title='アバターを変更']").click
        expect(page).to have_selector("dialog[open]")
        # アニメーション完了を待つために明示的な待機が必要な場合があるが、
        # have_selector("dialog[open]") で十分なはずなのでsleepは削除

        execute_script("document.getElementById('user_avatar_type_google').click()")
        within("dialog[open]") { click_button "変更を保存する" }
        expect(page).to have_content("アカウント情報を変更しました。")
        expect(user.reload.avatar_type).to eq("google")

        # 2. 画像をアップロード（自動的にuploadedになるはず）
        find("button[title='アバターを変更']").click
        expect(page).to have_selector("dialog[open]")
        # アニメーション完了を待つために明示的な待機が必要な場合があるが、
        # have_selector("dialog[open]") で十分なはずなのでsleepは削除


        # input要素を可視化してファイル添付
        execute_script("document.getElementById('user_uploaded_avatar').classList.remove('hidden')")
        attach_file "user_uploaded_avatar", Rails.root.join("spec/fixtures/files/avatar.jpg")

        within("dialog[open]") { click_button "変更を保存する" }
        expect(page).to have_content("アカウント情報を変更しました。")
        expect(user.reload.avatar_type).to eq("uploaded")
        expect(user.uploaded_avatar).to be_attached

        # 3. 再度Google画像を選択
        find("button[title='アバターを変更']").click
        expect(page).to have_selector("dialog[open]")
        # アニメーション完了を待つために明示的な待機が必要な場合があるが、
        # have_selector("dialog[open]") で十分なはずなのでsleepは削除

        execute_script("document.getElementById('user_avatar_type_google').click()")
        within("dialog[open]") { click_button "変更を保存する" }
        expect(page).to have_content("アカウント情報を変更しました。")
        expect(user.reload.avatar_type).to eq("google")

        # 4. 再度アップロード画像を選択
        find("button[title='アバターを変更']").click
        expect(page).to have_selector("dialog[open]")
        # アニメーション完了を待つために明示的な待機が必要な場合があるが、
        # have_selector("dialog[open]") で十分なはずなのでsleepは削除

        execute_script("document.getElementById('user_avatar_type_uploaded').click()")
        within("dialog[open]") { click_button "変更を保存する" }
        expect(page).to have_content("アカウント情報を変更しました。")
        expect(user.reload.avatar_type).to eq("uploaded")
      end
    end

    it "アカウントを削除できること" do
      accept_confirm do
        click_button "削除する"
      end

      # 削除完了メッセージを待つ（これが待機処理になる）
      expect(page).to have_content("アカウントを削除しました。")

      # その後でDBを確認
      expect(User.exists?(user.id)).to be_falsey
    end
  end
end
</file>

<file path="app/views/layouts/application.html.erb">
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= content_for?(:title) ? yield(:title) : "てくメモ" %></title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <!-- ページ固有のヘッダー要素（OGPタグなど） -->
  <%= yield :head %>

  <!-- PWA Manifest -->
  <link rel="manifest" href="<%= pwa_manifest_path %>" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="てくメモ" />
  <link rel="apple-touch-icon" href="/512x512.png" />
  <meta name="theme-color" content="#3b82f6" />

  <% unless Rails.env.test? %>
    <!-- DNS prefetch: Google Fonts のドメインに事前接続 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Noto Sans JP: 日本語Webフォント（ウェイト400,500,700） -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Material Symbols: Googleのアイコンフォント -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=block" rel="stylesheet">
  <% end %>

  <!-- Tailwind CSSビルド済みファイル -->
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>

  <!-- ダークモード初期化スクリプト（FOUC防止）←チラつきのこと -->
  <script>
    // ページ読み込み前にダークモードを設定（フラッシュ防止してくれる魔法の呪文）
    (function() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>

  <!-- Service Worker 登録 -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => console.log('Service Worker registered'))
        .catch(error => console.log('Service Worker registration failed:', error));
    }
  </script>
</head>

<body class="min-h-screen bg-fixed bg-clay-bg dark:bg-gradient-to-b dark:from-slate-900 dark:via-slate-900 dark:to-indigo-950 font-display transition-colors duration-200" data-controller="scroll-hide">
  <!-- 背景装飾アニメーション（全ページ共通） -->
  <%= render 'shared/animated_background' %>


  <!-- PWAインストール促進バナー -->
  <div data-controller="pwa-install" class="fixed left-0 right-0 bottom-0 p-4 pointer-events-none" style="z-index: 9999;">
    <div data-pwa-install-target="banner" class="hidden translate-y-4 opacity-0 transition-all duration-300 pointer-events-auto max-w-2xl mx-auto">
      <div class="bg-gradient-to-r from-blue-500 to-cyan-400 dark:from-blue-600 dark:to-cyan-500 rounded-2xl shadow-2xl p-4 flex items-center gap-3">
        <!-- アイコン -->
        <div class="flex-shrink-0">
          <div class="w-12 h-12 bg-white dark:bg-white/10 rounded-xl flex items-center justify-center shadow-lg">
            <span class="material-symbols-outlined text-2xl text-blue-600 dark:text-cyan-300">install_mobile</span>
          </div>
        </div>

        <!-- メッセージ -->
        <div class="flex-1 text-white">
          <p class="font-bold text-sm sm:text-base">てくメモをインストール</p>
          <p class="text-xs sm:text-sm opacity-90">ホーム画面から簡単にアクセスできます</p>
        </div>

        <!-- インストールボタン -->
        <button type="button" data-action="click->pwa-install#install" class="flex-shrink-0 px-4 py-2 bg-white dark:bg-white/20 text-blue-600 dark:text-white font-bold text-sm rounded-full hover:bg-blue-50 dark:hover:bg-white/30 transition-colors shadow-md">
          追加
        </button>

        <!-- 閉じるボタン -->
        <button type="button" data-action="click->pwa-install#dismiss" class="flex-shrink-0 w-8 h-8 rounded-full hover:bg-white/20 transition-colors flex items-center justify-center">
          <span class="material-symbols-outlined text-white text-lg">close</span>
        </button>
      </div>
    </div>
  </div>

  <div class="flex flex-col min-h-screen">

    <!-- ===== フローティングヘッダー（モバイルファースト・レスポンシブ対応） ===== -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-white/60 dark:bg-slate-950/60 backdrop-blur-xl">
      <div class="grid grid-cols-3 items-center py-2 px-3 sm:py-4 sm:px-4 w-full max-w-2xl mx-auto">
        <!-- 左側：アイコン + ダークモードトグル -->
        <div class="flex justify-start items-center gap-3">
          <!-- アプリアイコン（ホームリンク） -->
          <%= link_to root_path, class: "hover:opacity-80 transition-opacity" do %>
            <div class="h-7 w-7 sm:h-10 sm:w-10 flex items-center justify-center bg-gradient-to-br from-sky-400 to-blue-500 rounded-xl sm:rounded-2xl shadow-md">
              <span class="material-symbols-outlined text-lg sm:text-2xl text-white drop-shadow-2xl text-shadow">footprint</span>
            </div>
          <% end %>

          <!-- Stimulusコントローラーでダークモード切り替えを制御 -->
          <div data-controller="dark-mode-toggle">
            <!-- トグルスイッチのボタン -->
            <button
              type="button"
              data-action="click->dark-mode-toggle#toggle"
              aria-label="ダークモード切り替え"
              class="relative flex items-center">

              <!-- トグルスイッチの背景（モバイル：小、PC：中） -->
              <div
                data-dark-mode-toggle-target="toggle"
                class="w-9 h-5 sm:w-11 sm:h-6 bg-gray-300 rounded-full shadow-inner transition-all duration-300 ease-in-out">

                <!-- スライダー（丸いつまみ・モバイル：小、PC：中） -->
                <div
                  data-dark-mode-toggle-target="slider"
                  class="absolute top-0.5 left-0.5 w-4 h-4 sm:w-5 sm:h-5 bg-white rounded-full shadow-md transition-transform duration-300 ease-in-out flex items-center justify-center translate-x-0">

                  <!-- 月のアイコン（ライトモード時・モバイル：小、PC：中） -->
                  <span
                    data-dark-mode-toggle-target="icon"
                    data-icon="moon"
                    class="material-symbols-outlined text-lg sm:text-2xl text-gray-700 transition-all duration-200 opacity-100 scale-100">
                    dark_mode
                  </span>

                  <!-- 太陽のアイコン（ダークモード時・モバイル：小、PC：中） -->
                  <span
                    data-dark-mode-toggle-target="icon"
                    data-icon="sun"
                    class="material-symbols-outlined text-[17px] sm:text-[22px] text-yellow-500 absolute transition-all duration-200 opacity-0 scale-0">
                    light_mode
                  </span>
                </div>
              </div>
            </button>
          </div>
        </div>

        <!-- 中央：ロゴテキスト（完全中央） -->
        <%= link_to root_path, class: "flex justify-center hover:opacity-80 transition-opacity" do %>
          <span class="text-xl sm:text-3xl font-bold bg-gradient-to-r from-sky-500 to-blue-600 dark:from-sky-400 dark:to-blue-500 bg-clip-text text-transparent whitespace-nowrap">
            てくメモ
          </span>
        <% end %>

        <!-- 右側：ログイン/ログアウトボタン（モバイル：小、PC：中） -->
        <div class="flex justify-end items-center">
          <% if user_signed_in? %>
            <!-- アバタードロップダウンメニュー（モバイル：小、PC：中） -->
            <div class="relative" data-controller="dropdown">
              <!-- アバターボタン -->
              <button
                type="button"
                data-dropdown-target="button"
                data-action="click->dropdown#toggle"
                class="rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 hover:scale-105">
                <%= user_avatar(current_user, classes: "w-8 h-8 sm:w-9 sm:h-9 text-sm border-2 border-gray-200 dark:border-gray-600") %>
              </button>

              <!-- ドロップダウンメニュー -->
              <div
                data-dropdown-target="menu"
                class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-xl shadow-xl py-1 border border-gray-100 dark:border-gray-700 transform origin-top-right transition-all duration-200 opacity-0 scale-95 z-50">

                <!-- ユーザー情報（簡易表示） -->
                <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700">
                  <p class="text-sm font-bold text-gray-900 dark:text-white truncate"><%= current_user.name %></p>
                  <p class="text-xs text-gray-500 dark:text-gray-400 truncate"><%= current_user.email %></p>
                </div>

                <!-- メニュー項目 -->
                <%= link_to edit_user_registration_path, class: "block px-4 py-2 text-sm text-gray-700 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center" do %>
                  <span class="material-symbols-outlined mr-2 text-lg">settings</span>
                  設定
                <% end %>

                <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>

                <%= link_to destroy_user_session_path,
                    method: :delete,
                    data: { turbo_method: :delete },
                    class: "block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center space-x-2 w-full text-left" do %>
                  <span class="material-symbols-outlined text-lg">logout</span>
                  <span>ログアウト</span>
                <% end %>
              </div>
            </div>
          <% else %>
            <!-- ログインボタン（青いグラデーション丸ボタン・モバイル：小、PC：中） -->
            <%= link_to new_user_session_path,
                aria_label: "ログイン",
                class: "w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 dark:from-blue-500 dark:to-blue-700 flex items-center justify-center shadow-md hover:shadow-lg hover:scale-110 transition-all duration-300" do %>
              <span class="material-symbols-outlined text-lg sm:text-xl text-white drop-shadow-2xl text-shadow">login</span>
            <% end %>
          <% end %>
        </div>
      </div>
    </header>

    <!-- ===== メインコンテンツ ===== -->
    <!-- ヘッダー分のpadding-topを追加（モバイル：小、PC：大） -->
    <main class="flex-1 w-full pt-12 sm:pt-20">
      <!-- Flashメッセージ -->
      <!-- Flashメッセージ (Dynamic Island Style - God Mode Neon) -->
      <div id="flash_messages" class="fixed top-24 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col items-center gap-3 w-full max-w-lg pointer-events-none px-4">
        <% if notice.present? %>
          <div data-controller="flash" class="pointer-events-auto transform transition-all duration-500 ease-out origin-top">
            <!-- Success: 強力な青い発光影 -->
            <div class="flex items-center gap-3 py-3 px-5 pr-3 rounded-full backdrop-blur-xl bg-slate-900/95 border border-slate-700/50 dark:border-sky-500/50 ring-1 ring-black/20 shadow-2xl dark:shadow-[0_0_35px_rgba(14,165,233,0.6)]">
              <!-- Icon -->
              <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-sky-500/20 text-sky-400">
                <span class="material-symbols-outlined text-xl">check_circle</span>
              </div>
              <!-- Text -->
              <div class="flex-1 min-w-0 px-2 text-center sm:text-left">
                <p class="text-sm font-bold text-white hidden sm:block">Success</p>
                <p class="text-sm text-slate-200 truncate max-w-[200px] sm:max-w-xs"><%= notice %></p>
              </div>
              <!-- Close Button -->
              <button type="button" data-action="click->flash#dismiss" class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-800 text-slate-400 hover:text-white transition-colors ml-1">
                <span class="material-symbols-outlined text-lg">close</span>
              </button>
            </div>
          </div>
        <% end %>

        <% if alert.present? %>
          <div data-controller="flash" class="pointer-events-auto transform transition-all duration-500 ease-out origin-top">
            <!-- Alert: 強力な赤い発光影 -->
            <div class="flex items-center gap-3 py-3 px-5 pr-3 rounded-full backdrop-blur-xl bg-slate-900/95 border border-slate-700/50 dark:border-rose-500/50 ring-1 ring-black/20 shadow-2xl dark:shadow-[0_0_35px_rgba(244,63,94,0.6)]">
              <!-- Icon -->
              <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-rose-500/20 text-rose-400">
                <span class="material-symbols-outlined text-xl">error</span>
              </div>
              <!-- Text -->
              <div class="flex-1 min-w-0 px-2 text-center sm:text-left">
                <p class="text-sm font-bold text-white hidden sm:block">Alert</p>
                <p class="text-sm text-slate-200 truncate max-w-[200px] sm:max-w-xs"><%= alert %></p>
              </div>
              <!-- Close Button -->
              <button type="button" data-action="click->flash#dismiss" class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-800 text-slate-400 hover:text-white transition-colors ml-1">
                <span class="material-symbols-outlined text-lg">close</span>
              </button>
            </div>
          </div>
        <% end %>
      </div>

      <%= yield %>
      <%= yield :modals %>
    </main>

    <!-- ===== フッター ===== -->
    <footer class="w-full py-8 pb-24 sm:pb-8 bg-slate-50/50 dark:bg-slate-900/50 backdrop-blur-sm border-t border-slate-200 dark:border-slate-800">
      <div class="max-w-2xl mx-auto px-4 text-center">
        <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 mb-4">
          <%= link_to "利用規約 & プライバシーポリシー", privacy_path, class: "text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 text-xs sm:text-sm font-medium transition-colors" %>
          <!-- 必要に応じて他リンクを追加 -->
        </div>
        <p class="text-[10px] sm:text-xs text-slate-400 dark:text-slate-600">
          &copy; <%= Time.current.year %> TekuMemo. All rights reserved.
        </p>
      </div>
    </footer>

    <!-- ===== Expandable FAB（展開可能なFloating Action Button）（ログイン時のみ） ===== -->
    <% if user_signed_in? %>
      <div data-controller="expandable-fab">
        <!-- 背景オーバーレイ（FAB展開時に表示） -->
        <div
          data-expandable-fab-target="overlay"
          data-action="click->expandable-fab#close"
          class="hidden fixed inset-0 bg-black opacity-0 transition-opacity duration-200 z-30">
        </div>

        <!-- FABボタンコンテナ（メインコンテンツの幅に合わせて配置） -->
        <div class="fixed bottom-[65px] sm:bottom-24 left-0 right-0 z-40 pointer-events-none transition-all duration-300 transform translate-y-0 opacity-100" data-scroll-hide-target="element">
          <div class="max-w-2xl mx-auto px-4 relative h-0">
            <div class="absolute bottom-0 right-2 sm:right-6 pointer-events-auto">
              <!-- アクションボタン（展開時に表示されるボタン群） -->

              <!-- 管理者メニュー（管理者のみ表示、一番上） -->
              <% if current_user.admin? || current_user.guest? %>
                <%= link_to admin_root_path,
                    data: { expandable_fab_target: "actionButton" },
                    class: "hidden opacity-0 absolute bottom-[19rem] right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                    style: "transform: translateY(20px);" do %>
                  <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">管理者メニュー</span>
                  <div class="bg-orange-500 dark:bg-orange-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-orange-600 dark:hover:bg-orange-700 transition-colors">
                    <span class="material-symbols-outlined text-xl">admin_panel_settings</span>
                  </div>
                <% end %>
              <% end %>



              <!-- ログインスタンプ -->
              <%= link_to login_stamps_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-52 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">てくてくスタンプ</span>
                <div class="bg-purple-500 dark:bg-purple-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-purple-600 dark:hover:bg-purple-700 transition-colors">
                  <span class="material-symbols-outlined text-xl">calendar_month</span>
                </div>
              <% end %>

              <!-- 新しい散歩記録 -->
              <%= link_to new_walk_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-40 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">新しい散歩記録</span>
                <div class="bg-green-500 dark:bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-green-600 dark:hover:bg-green-700 transition-colors">
                  <span class="material-symbols-outlined text-xl">add_circle</span>
                </div>
              <% end %>

              <!-- SNS投稿 -->
              <%= link_to posts_path(open_modal: true),
                  data: { expandable_fab_target: "actionButton", turbo: false },
                  class: "hidden opacity-0 absolute bottom-28 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">SNS投稿</span>
                <div class="bg-pink-500 dark:bg-pink-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-pink-600 dark:hover:bg-pink-700 transition-colors">
                  <span class="material-symbols-outlined text-xl">edit_square</span>
                </div>
              <% end %>

              <!-- 設定 -->
              <%= link_to edit_user_registration_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-16 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">設定</span>
                <div class="bg-gray-500 dark:bg-gray-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-gray-600 dark:hover:bg-gray-700 transition-colors">
                  <span class="material-symbols-outlined text-xl">settings</span>
                </div>
              <% end %>

              <!-- メインFABボタン -->
              <button
                type="button"
                data-expandable-fab-target="mainButton"
                data-action="click->expandable-fab#toggle"
                class="bg-gradient-to-r from-orange-400 to-pink-500 dark:from-amber-600 dark:to-yellow-500 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:from-orange-500 hover:to-pink-600 dark:hover:from-amber-700 dark:hover:to-yellow-600 dark:shadow-[0_0_20px_rgba(245,158,11,0.5)] transition-all duration-300">
                <span class="material-symbols-outlined text-2xl drop-shadow-2xl text-shadow">add</span>
              </button>
            </div>
          </div>
        </div>
      </div>



      <!-- ===== ボトムナビゲーション（ログイン時のみ・モバイルファースト・レスポンシブ対応） ===== -->
      <nav class="fixed bottom-0 left-0 right-0 bg-white/60 dark:bg-slate-950/60 backdrop-blur-xl z-50 transition-all duration-300 transform translate-y-0 opacity-100" data-scroll-hide-target="element">
        <div class="flex justify-around items-center h-10 sm:h-16 max-w-2xl mx-auto divide-x divide-gray-300 dark:divide-gray-700">
          <!-- ホーム -->
          <%= link_to root_path,
              id: "nav-home",
              class: "relative flex items-center justify-center w-full #{current_page?(root_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(root_path) ? 'font-bold' : ''}">home</span>
          <% end %>

          <!-- 散歩 -->
          <%= link_to walks_path,
              id: "nav-walk",
              class: "relative flex items-center justify-center w-full #{current_page?(walks_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(walks_path) ? 'font-bold' : ''}">footprint</span>
          <% end %>

          <!-- 投稿 -->
          <%= link_to posts_path,
              id: "nav-post",
              class: "relative flex items-center justify-center w-full #{current_page?(posts_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(posts_path) ? 'font-bold' : ''}">groups</span>
          <% end %>

          <!-- 記録（統計） -->
          <%= link_to stats_path,
              id: "nav-stats",
              class: "relative flex items-center justify-center w-full #{current_page?(stats_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(stats_path) ? 'font-bold' : ''}">incomplete_circle</span>
          <% end %>

          <!-- ランキング -->
          <%= link_to rankings_path,
              id: "nav-rank",
              class: "relative flex items-center justify-center w-full #{current_page?(rankings_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(rankings_path) ? 'font-bold' : ''}">emoji_events</span>
          <% end %>
        </div>
      </nav>
    <% end %>
  </div>
</body>
</html>
</file>

<file path="app/views/posts/index.html.erb">
<%# app/views/posts/index.html.erb %>
<div class="min-h-screen w-full relative font-body">

  <main class="container mx-auto px-4 py-8 max-w-2xl relative z-10">
    <!-- ヘッダーエリア -->
    <!-- ヘッダーエリア（タブのみ・中央寄せ） -->
    <div class="flex justify-center mb-6">
      <!-- タブ切り替え -->
      <div class="p-1 bg-white/50 dark:bg-slate-800/50 backdrop-blur-md rounded-full inline-flex shadow-[0_4px_10px_rgba(0,0,0,0.05),inset_0_1px_2px_rgba(255,255,255,0.8)] border border-white/40 dark:border-white/10 relative overflow-hidden">
        <%= link_to posts_path, class: "px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold transition-all duration-300 relative z-10 #{current_page?(posts_path) ? 'bg-gradient-to-r from-blue-500 to-cyan-400 dark:from-cyan-600 dark:to-blue-600 text-white shadow-md transform scale-105 dark:shadow-[0_0_10px_rgba(34,211,238,0.5)]' : 'text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-slate-700/50'}" do %>
          <span class="flex items-center gap-1.5">
            <span class="material-symbols-outlined text-sm sm:text-base">public</span>
            みんな
          </span>
        <% end %>

        <%= link_to mine_posts_path, class: "px-4 py-1.5 rounded-full text-xs sm:text-sm font-bold transition-all duration-300 relative z-10 #{current_page?(mine_posts_path) ? 'bg-gradient-to-r from-blue-500 to-cyan-400 dark:from-cyan-600 dark:to-blue-600 text-white shadow-md transform scale-105 dark:shadow-[0_0_10px_rgba(34,211,238,0.5)]' : 'text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-slate-700/50'}" do %>
          <span class="flex items-center gap-1.5">
            <span class="material-symbols-outlined text-sm sm:text-base">history</span>
            自分
          </span>
        <% end %>
      </div>
    </div>

    <!-- インライン風投稿トリガー（改善版：ボタンらしく） -->
    <div class="mb-6">
      <% if current_user.guest? %>
        <!-- ゲスト用バナー（投稿不可メッセージ） -->
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-slate-800 dark:to-slate-800/80 rounded-[2.5rem] p-4 text-center border-2 border-white/60 dark:border-white/10 shadow-sm relative overflow-hidden group">
          <!-- 背景装飾 -->
          <div class="absolute -right-6 top-1/2 -translate-y-1/2 w-24 h-24 bg-blue-400/10 rounded-full blur-xl group-hover:bg-blue-400/20 transition-colors"></div>
          <div class="absolute -left-6 top-1/2 -translate-y-1/2 w-24 h-24 bg-purple-400/10 rounded-full blur-xl group-hover:bg-purple-400/20 transition-colors"></div>

          <div class="relative z-10 flex flex-col items-center justify-center gap-2 py-2">
            <p class="text-sm font-bold text-gray-600 dark:text-gray-300">
              <span class="mr-2 text-lg">🔒</span>
              ゲストモード中は投稿できません
            </p>
            <p class="text-xs text-gray-500 dark:text-gray-400">
              実際に投稿するには、Googleアカウントでログインしてください。
            </p>
          </div>
        </div>
      <% else %>
        <div class="bg-[#f0f4f8] bg-gradient-to-br from-white/80 via-white/40 to-transparent dark:bg-none dark:bg-[#1a0b2e]/80 rounded-[3.75rem] p-4 cursor-pointer transition-all duration-300 group hover:-translate-y-1 hover:shadow-xl border-2 border-white/60 dark:border-purple-500/30 dark:border-t-white/40 shadow-[20px_20px_60px_rgba(59,130,246,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(59,130,246,0.05),inset_5px_5px_15px_rgba(255,255,255,0.8),inset_2px_2px_0px_rgba(59,130,246,0.3)] dark:shadow-[0_0_20px_rgba(168,85,247,0.4),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse"
             data-controller="modal"
             data-modal-dialog-id-value="new_post_modal"
             data-action="click->modal#open">

          <div class="flex items-center gap-3 relative z-10">
            <!-- 自分のアバター（浮き出し） -->
            <div class="flex-shrink-0">
              <%= user_avatar(current_user,
                  classes: "w-10 h-10 border-2 border-white dark:border-purple-500/20 shadow-md dark:shadow-[0_0_15px_rgba(168,85,247,0.3)] text-sm",
                  default_color_classes: "bg-gray-200 dark:bg-gray-700 text-gray-500 dark:text-gray-400") %>
            </div>

            <!-- 入力風エリア（クリック可能であることを明示） -->
            <div class="flex-1 bg-gradient-to-r from-gray-100 to-gray-50 dark:from-[#0b0514]/50 dark:to-[#2e1a47]/30 rounded-full px-3 sm:px-4 py-3 text-gray-600 dark:text-purple-200/70 text-sm group-hover:from-blue-50 group-hover:to-cyan-50 dark:group-hover:from-[#2e1a47]/50 dark:group-hover:to-purple-900/30 transition-all flex items-center justify-between shadow-inner border border-gray-200 dark:border-purple-500/20">
              <span class="font-bold text-gray-700 dark:text-purple-100 text-xs sm:text-sm truncate">今日の気分をシェア！</span>
              <div class="flex items-center gap-1.5 sm:gap-2 flex-shrink-0">
                <span class="material-symbols-outlined text-2xl sm:text-3xl text-blue-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-fuchsia-300 dark:to-pink-300 dark:drop-shadow-[0_0_8px_rgba(232,121,249,0.8)] group-hover:scale-125 transition-transform drop-shadow-md">add_circle</span>
                <span class="text-xs sm:text-base font-bold text-blue-600 dark:text-fuchsia-300 whitespace-nowrap">投稿</span>
              </div>
            </div>

            <!-- アイコン類（飾り・Claymorphism） -->
            <div class="hidden sm:flex gap-3 ml-2">
              <div class="w-10 h-10 rounded-full bg-orange-50 dark:bg-orange-900/10 flex items-center justify-center text-orange-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-orange-300 dark:to-yellow-300 dark:drop-shadow-[0_0_8px_rgba(251,146,60,0.8)] border border-orange-100 dark:border-orange-500/30 group-hover:scale-110 transition-transform duration-300 shadow-[3px_3px_6px_rgba(166,175,195,0.2),-3px_-3px_6px_rgba(255,255,255,0.8)] dark:shadow-[0_0_10px_rgba(249,115,22,0.2)]">
                <span class="material-symbols-outlined text-xl">wb_sunny</span>
              </div>
              <div class="w-10 h-10 rounded-full bg-green-50 dark:bg-green-900/10 flex items-center justify-center text-green-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-green-300 dark:to-emerald-300 dark:drop-shadow-[0_0_8px_rgba(74,222,128,0.8)] border border-green-100 dark:border-green-500/30 group-hover:scale-110 transition-transform duration-300 delay-75 shadow-[3px_3px_6px_rgba(166,175,195,0.2),-3px_-3px_6px_rgba(255,255,255,0.8)] dark:shadow-[0_0_10px_rgba(34,197,94,0.2)]">
                <span class="material-symbols-outlined text-xl">sentiment_satisfied</span>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- 投稿一覧エリア -->
    <div class="space-y-6 pb-24">
      <!-- 上部ページネーション -->
      <div class="flex justify-center mb-4">
        <%= paginate @posts, window: 1, outer_window: 1 %>
      </div>

      <% if @posts.any? %>
        <%= render partial: "post", collection: @posts %>
      <% else %>
        <!-- 空の状態（Empty State） -->
        <div class="flex flex-col items-center justify-center py-20 text-center bg-white/40 bg-gradient-to-br from-white/80 via-white/40 to-transparent dark:bg-none dark:bg-slate-800/40 backdrop-blur-sm rounded-[3.75rem] border-2 border-white/60 dark:border-gray-700 dark:border-t-white/20 shadow-[20px_20px_60px_rgba(59,130,246,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(59,130,246,0.05),inset_5px_5px_15px_rgba(255,255,255,0.8)] relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none">
          <div class="text-6xl mb-4 animate-bounce relative z-10">🚶‍♂️</div>
          <h3 class="text-xl font-bold text-gray-700 dark:text-gray-200 mb-2 relative z-10">まだ投稿がありません</h3>
          <p class="text-gray-500 dark:text-gray-400 relative z-10">
            一番乗りで、今日の散歩の気分を<br>シェアしてみませんか？
          </p>
        </div>
      <% end %>

      <!-- ページネーション -->
      <div class="mt-10 flex justify-center">
        <%= paginate @posts, window: 1, outer_window: 1 %>
      </div>
    </div>
  </main>

  <!-- 新規投稿モーダル（Claymorphism Style） -->
  <dialog id="new_post_modal"
          class="p-0 rounded-[2.5rem] shadow-2xl backdrop:bg-gray-900/40 dark:backdrop:bg-[#0b0514]/80 backdrop:backdrop-blur-sm bg-transparent open:animate-zoom-in w-[95%] md:max-w-2xl"
          data-controller="modal"
          data-modal-target="dialog"
          data-modal-auto-open-param-value="open_modal">
    <div class="bg-[#f8fafc] bg-gradient-to-br from-white/80 via-white/40 to-transparent dark:bg-none dark:bg-[#1a0b2e] w-full max-h-[85vh] flex flex-col p-8 md:p-10 rounded-[3.75rem] border-4 border-white/60 dark:border-purple-500/30 dark:border-t-white/40 shadow-[20px_20px_60px_rgba(59,130,246,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(59,130,246,0.05),inset_5px_5px_15px_rgba(255,255,255,0.8),inset_2px_2px_0px_rgba(59,130,246,0.3)] dark:shadow-[0_0_50px_rgba(168,85,247,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[20%] before:bg-gradient-to-b before:from-white/15 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none">

      <!-- Candy Gradient Orbs (Light Mode Only) -->
      <div class="absolute -top-20 -right-20 w-64 h-64 bg-gradient-to-br from-blue-500/20 to-cyan-500/20 rounded-full blur-3xl pointer-events-none dark:hidden"></div>
      <div class="absolute -bottom-20 -left-20 w-64 h-64 bg-gradient-to-tr from-blue-500/20 to-cyan-500/20 rounded-full blur-3xl pointer-events-none dark:hidden"></div>

      <div class="flex justify-between items-center mb-6 flex-shrink-0">
        <h3 class="text-2xl font-black text-gray-800 dark:text-gray-100 flex items-center gap-3">
          <span class="text-3xl filter drop-shadow-sm">👟</span>
          <span class="bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-cyan-500 dark:from-purple-400 dark:to-pink-400">てくてくシェア</span>
        </h3>
        <button type="button"
                data-controller="modal"
                data-action="click->modal#close"
                class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-100 dark:bg-white/10 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-white/20 transition-all shadow-sm hover:shadow-inner outline-none focus:ring-2 focus:ring-gray-200 dark:focus:ring-purple-500/50">
          <span class="material-symbols-outlined font-bold">close</span>
        </button>
      </div>

      <!-- フォームのレンダリング -->
      <%= render 'form', post: @post %>
    </div>
  </dialog>
</div>

<style>
  /* dialogのアニメーション用 */
  dialog[open] {
    animation: zoomIn 0.3s ease-out;
  }
  @keyframes zoomIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
</style>

<!-- 投稿成功モーダル -->
<% if session[:show_post_success_modal].present? %>
  <% success_post = Post.find_by(id: session[:show_post_success_modal]) %>
  <% session.delete(:show_post_success_modal) %>

  <dialog id="post_success_modal" class="rounded-3xl p-0 backdrop:bg-black/50 max-w-md w-full" data-controller="modal" data-modal-dialog-id-value="post_success_modal">
    <div class="bg-white dark:bg-slate-800 rounded-3xl p-6 relative">
      <!-- タイトル -->
      <div class="text-center mb-6">
        <div class="text-4xl mb-3">🎉</div>
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">投稿しました！</h3>
      </div>

      <!-- ボタン -->
      <div class="space-y-3">
        <!-- Xに投稿ボタン -->
        <% if success_post %>
          <%= link_to share_post_on_twitter_url(success_post),
              target: "_blank",
              rel: "noopener noreferrer",
              class: "w-full flex items-center justify-center gap-2 px-6 py-3 rounded-full bg-black dark:bg-white text-white dark:text-black font-bold hover:bg-gray-800 dark:hover:bg-gray-200 transition",
              data: { action: "click->modal#close" } do %>
            <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            に投稿
          <% end %>
        <% end %>

        <!-- 閉じるボタン -->
        <button type="button"
                data-action="click->modal#close"
                class="w-full px-6 py-3 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition">
          閉じる
        </button>
      </div>
    </div>
  </dialog>

  <script>
    (function() {
      const openSuccessModal = () => {
        const successModal = document.getElementById('post_success_modal');
        if (successModal && !successModal.open) {
          successModal.showModal();
        }
      };

      // 即時実行（HTMLが描画された直後）
      openSuccessModal();

      // Turbo Driveでの遷移完了時にも実行
      document.addEventListener('turbo:load', openSuccessModal, { once: true });
    })();
  </script>
<% end %>
</file>

<file path="app/views/home/index.html.erb">
<% content_for :title, "てくメモ - ホーム" %>

<% if user_signed_in? %>
  <div class="w-full transition-colors duration-300 -mt-12 sm:-mt-20 pt-12 sm:pt-20 relative overflow-hidden" data-controller="coach-mark">
    <div class="flex-1 p-4 pb-24 w-full max-w-2xl mx-auto space-y-4 relative z-10">

    <!-- 今日の散歩ダッシュボード -->
    <div class="relative block bg-gradient-to-br from-sky-400 to-blue-500 dark:from-cyan-600 dark:via-indigo-700 dark:to-purple-800 border-2 border-white/60 dark:border-cyan-500/50 dark:border-t-white/40 shadow-[20px_20px_60px_rgba(56,189,248,0.25),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(56,189,248,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9)] dark:shadow-[0_0_40px_-10px_rgba(34,211,238,0.4),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] hover:dark:shadow-[0_0_60px_rgba(34,211,238,0.6),inset_0_0_0_1px_rgba(255,255,255,0.3),inset_0_1px_0_rgba(255,255,255,0.5)] text-white p-6 rounded-[3.75rem] transition-all duration-300 hover:scale-105 group overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
      <!-- 1. 呼吸する光のオーラ（背景：ダークモードのみ） -->
      <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-cyan-500/20 dark:bg-cyan-500/30 rounded-full blur-3xl animate-pulse-slow pointer-events-none"></div>

      <!-- カード全体をリンク化（Stretched Link） -->
      <%= link_to "", walks_path, class: "absolute inset-0 z-10 rounded-[3.75rem]" %>

      <p class="relative z-10 text-xl font-bold opacity-90 drop-shadow-md bg-gradient-to-r from-white to-blue-100 bg-clip-text text-transparent">今日の散歩</p>

      <!-- 距離と目標距離 -->
      <div class="relative z-10 flex justify-between items-baseline mt-2">
        <p class="text-4xl font-black drop-shadow-lg">
          <span data-controller="counter"
                class="inline-block bg-gradient-to-b from-white via-blue-50 to-blue-200 bg-clip-text text-transparent"
                data-counter-target-value="<%= ((@today_walk&.distance || 0).to_f * 1000).to_i %>">0
          </span>
          <span class="text-base font-medium ml-1 text-blue-100/80">m</span>
        </p>
        <p class="text-lg font-bold opacity-90 text-shadow relative z-10">
          <%= link_to edit_user_registration_path, class: "text-white hover:text-white transition-all inline-flex items-center gap-0.5 group" do %>
            <span class="group-hover:underline decoration-white/50 underline-offset-4">
              / <%= number_with_delimiter(current_user.target_distance) %>m
            </span>
            <span class="material-symbols-outlined text-[16px] opacity-70 group-hover:opacity-100 transition-opacity">settings</span>
          <% end %>
        </p>
      </div>

      <!-- 距離のプログレスバー -->
      <div class="relative z-10 w-full bg-white/50 dark:bg-white/20 rounded-full h-2.5 my-4 overflow-hidden">
        <div class="relative bg-gradient-to-r from-lime-300 to-green-400 dark:from-cyan-400 dark:to-blue-500 h-2.5 rounded-full shadow-md overflow-hidden" style="width: <%= (((@today_walk&.distance || 0).to_f * 1000) / current_user.target_distance.to_f * 100).clamp(0, 100) %>%">
          <!-- シマーエフェクト -->
          <div class="absolute inset-0 animate-shimmer bg-gradient-to-r from-transparent via-white/30 to-transparent -skew-x-12"></div>
        </div>
      </div>

      <!-- 消費カロリー -->
      <div class="relative z-10 flex justify-between text-lg">
        <!-- 歩数 -->
        <div class="flex items-center space-x-2">
          <span class="material-symbols-outlined text-4xl text-blue-50 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-emerald-300 dark:to-teal-300 dark:drop-shadow-[0_0_8px_rgba(52,211,153,0.8)] animate-pulse-fast text-shadow w-9 h-9 overflow-hidden">directions_walk</span>
          <div>
            <p class="font-bold text-lg text-blue-50 drop-shadow-sm"><%= number_with_delimiter(@today_walk&.steps || 0) %> <span class="text-sm font-normal text-blue-200/80">歩</span></p>
          </div>
        </div>
        <!-- 消費カロリー -->
        <div class="flex items-center space-x-2">
          <span class="material-symbols-outlined text-4xl text-blue-50 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-orange-400 dark:to-red-500 dark:drop-shadow-[0_0_8px_rgba(239,68,68,0.8)] animate-pulse-fast text-shadow">local_fire_department</span>
          <div>
            <p class="font-bold text-lg text-blue-50 drop-shadow-sm"><%= number_with_delimiter(@today_walk&.calories_burned || 0) %> <span class="text-sm font-normal text-blue-200/80">kcal</span></p>
          </div>
        </div>
      </div>
    </div>



    <!-- 天気予報とランキングのグリッド/カルーセル -->
    <div data-controller="carousel" class="relative group mb-6">
      <!-- カルーセルコンテナ（スマホ: 横スクロール, PC: グリッド） -->
      <!-- py-4: スマホで上下に余白確保、横幅は他のカードと揃える, sm:p-0: PCではoverflow-visibleなので余白不要 -->
      <div data-carousel-target="container" class="cursor-grab flex sm:grid sm:grid-cols-2 gap-4 overflow-x-auto scrollbar-hide [&::-webkit-scrollbar]:hidden sm:overflow-visible py-4 sm:p-0" style="scrollbar-width: none; -ms-overflow-style: none;">

        <!-- 天気予報カード -->
        <div data-carousel-target="slide" class="min-w-full sm:min-w-0 snap-center px-1 sm:px-0">
          <%= link_to "https://www.windy.com/?#{@location[:latitude]},#{@location[:longitude]},10", target: "_blank", draggable: "false", class: "block relative rounded-[3.75rem] transform transition-all duration-300 sm:hover:scale-105 h-full overflow-hidden bg-gradient-to-br from-sky-400 to-blue-600 dark:from-slate-900 dark:to-blue-950 border-2 border-white/60 dark:border-blue-500/30 dark:border-t-white/40 shadow-[10px_10px_30px_rgba(59,130,246,0.1),-10px_-10px_30px_rgba(255,255,255,0.6),inset_-5px_-5px_15px_rgba(59,130,246,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9)] hover:shadow-xl dark:shadow-[0_0_20px_rgba(59,130,246,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] hover:dark:shadow-[0_0_40px_rgba(59,130,246,0.3),inset_0_0_0_1px_rgba(255,255,255,0.3)] before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse" do %>
            <!-- カードヘッダー -->
            <div class="px-3 py-1.5 bg-white/10 dark:bg-black/20 backdrop-blur-sm border-b border-white/20">
              <div class="flex items-center justify-center">
                <div class="flex items-center space-x-0.5 text-white/80 text-sm">
                  <span class="material-symbols-outlined font-bold text-base text-white w-5 h-5 overflow-hidden">location_on</span>
                  <span class="font-bold text-base text-white"><%= @location_name || "現在地不明" %></span>
                  <span class="material-symbols-outlined text-sm text-white/70 ml-1">open_in_new</span>
                </div>
              </div>
            </div>

            <!-- 天気情報グリッド -->
            <div class="grid grid-cols-2 divide-x divide-white/20">
              <!-- 今日の天気 -->
              <div class="p-3 text-white">
                <div class="text-center">
                  <p class="text-sm font-medium opacity-90 mb-1.5 text-shadow">いま</p>
                  <% if @weather && @weather[:today] %>
                    <!-- 天気アイコン -->
                    <div class="flex justify-center mb-2">
                      <span class="material-symbols-outlined text-4xl drop-shadow-2xl animate-bounce-slow text-shadow">
                        <%= @weather[:today][:icon] %>
                      </span>
                    </div>
                    <!-- 気温 -->
                    <div class="text-xl font-bold mb-1 text-shadow">
                      <%= @weather[:today][:temp] %><span class="text-sm text-shadow">°C</span>
                    </div>
                  <% else %>
                    <div class="flex justify-center mb-2">
                      <span class="material-symbols-outlined text-5xl opacity-50 text-shadow">cloud_off</span>
                    </div>
                    <p class="text-sm opacity-70 text-shadow">取得中...</p>
                  <% end %>
                </div>
              </div>

              <!-- 明日の天気 -->
              <div class="p-3 text-white bg-white/5">
                <div class="text-center">
                  <p class="text-sm font-medium opacity-90 mb-1.5 text-shadow">あした</p>
                  <% if @weather && @weather[:tomorrow] %>
                    <!-- 天気アイコン -->
                    <div class="flex justify-center mb-2">
                      <span class="material-symbols-outlined text-4xl drop-shadow-2xl animate-bounce-slow text-shadow">
                        <%= @weather[:tomorrow][:icon] %>
                      </span>
                    </div>
                    <!-- 気温 -->
                    <div class="text-xl font-bold mb-1 text-shadow">
                      <%= @weather[:tomorrow][:temp] %><span class="text-sm text-shadow">°C</span>
                    </div>
                  <% else %>
                    <div class="flex justify-center mb-2">
                      <span class="material-symbols-outlined text-5xl opacity-50 text-shadow">cloud_off</span>
                    </div>
                    <p class="text-sm opacity-70 text-shadow">取得中...</p>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <!-- ランキングカード -->
        <div data-carousel-target="slide" class="min-w-full sm:min-w-0 snap-center px-1 sm:px-0">
          <%= link_to rankings_path, draggable: "false", class: "block relative rounded-[3.75rem] transform transition-all duration-300 sm:hover:scale-105 h-full overflow-hidden bg-gradient-to-br from-sky-400 to-blue-700 dark:from-blue-900 dark:to-indigo-900 border-2 border-white/60 dark:border-indigo-500/30 dark:border-t-white/40 shadow-[10px_10px_30px_rgba(59,130,246,0.1),-10px_-10px_30px_rgba(255,255,255,0.6),inset_-5px_-5px_15px_rgba(59,130,246,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9)] hover:shadow-xl dark:shadow-[0_0_25px_rgba(99,102,241,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] hover:dark:shadow-[0_0_50px_rgba(99,102,241,0.4),inset_0_0_0_1px_rgba(255,255,255,0.3)] before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse" do %>
            <div class="p-3 h-full flex items-center justify-between relative">

              <div class="flex flex-col justify-center z-10">
                <div class="flex items-center space-x-1 mb-1 opacity-80">
                  <span class="material-symbols-outlined text-3xl sm:text-4xl text-white w-10 h-10 overflow-hidden">trophy</span>
                  <div class="flex flex-col">
                    <span class="text-sm sm:text-base font-bold text-white uppercase tracking-widest">Rank</span>
                    <span class="text-[10px] text-white/70 -mt-0.5">今月</span>
                  </div>
                </div>
                <div class="text-white">
                  <span class="text-4xl sm:text-5xl font-black font-mono tracking-tighter drop-shadow-md bg-gradient-to-b from-white via-yellow-50 to-yellow-200 bg-clip-text text-transparent"><%= sprintf('%02d', @my_rank) %></span>
                  <span class="text-sm font-bold opacity-70">/ <%= @ranking_total_users %></span>
                </div>

                <!-- リボン風バッジ -->
                <%
                   badge_classes = if @ranking_percentile <= 10
                                     { bg: "from-yellow-300 to-orange-500", text: "text-yellow-900" } # Gold
                                   elsif @ranking_percentile <= 30
                                     { bg: "from-slate-300 to-slate-400", text: "text-slate-800" }   # Silver
                                   elsif @ranking_percentile <= 50
                                     { bg: "from-orange-300 to-orange-400", text: "text-orange-900" } # Bronze
                                   else
                                     { bg: "from-blue-400 to-blue-500", text: "text-white" }          # Normal
                                   end

                   badge_text = if @ranking_percentile <= 50
                                  "Top #{@ranking_percentile}%"
                                else
                                  "Rank In"
                                end
                %>
                <div class="mt-2 relative inline-block ml-2">
                   <div class="absolute inset-0 bg-gradient-to-r <%= badge_classes[:bg] %> rounded-sm transform -skew-x-12 shadow-lg border border-white/20"></div>
                   <div class="relative px-2 py-0.5 flex items-center space-x-1">
                      <span class="material-symbols-outlined text-[14px] sm:text-[16px] <%= badge_classes[:text] %> w-5 h-4 overflow-hidden">workspace_premium</span>
                      <span class="text-[10px] sm:text-xs font-black <%= badge_classes[:text] %> uppercase tracking-wider"><%= badge_text %></span>
                   </div>
                </div>
              </div>

              <div class="relative w-20 h-20 sm:w-24 sm:h-24 flex items-center justify-center">
                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                  <defs>
                    <linearGradient id="gold-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" stop-color="#fef9c3" />
                      <stop offset="50%" stop-color="#fde047" />
                      <stop offset="100%" stop-color="#eab308" />
                    </linearGradient>
                  </defs>
                  <!-- 背景円 -->
                  <circle cx="50" cy="50" r="45" stroke="currentColor" stroke-width="8" fill="transparent" class="text-white/20" />
                  <!-- 進捗円 -->
                  <%
                     # 円周 = 2 * π * 45 ≈ 282.7
                     circumference = 283

                     if @ranking_total_users <= 1 || @my_rank == 1
                       offset = 0
                     else
                       # 2位以下は最低でも5%の隙間を空けることで、1位との差を視覚的に明確にする
                       min_gap = 0.05
                       raw_ratio = (@my_rank - 1).to_f / (@ranking_total_users - 1)
                       # 0%〜100%の範囲を、5%〜100%の範囲にマッピング
                       adjusted_ratio = raw_ratio * (1.0 - min_gap) + min_gap
                       offset = circumference * adjusted_ratio
                     end
                  %>
                  <circle cx="50" cy="50" r="45" stroke="url(#gold-gradient)" stroke-width="8" fill="transparent"
                          stroke-dasharray="<%= circumference %>"
                          stroke-dashoffset="<%= offset %>"
                          stroke-linecap="round"
                          class="drop-shadow-[0_0_8px_rgba(234,179,8,0.6)] transition-all duration-1000 ease-out" />
                </svg>
                <!-- 背面：光る影用 -->
                <span class="absolute material-symbols-outlined text-6xl sm:text-7xl text-yellow-500 animate-sparkle">emoji_events</span>
                <!-- 前面：質感用 -->
                <span class="absolute material-symbols-outlined text-6xl sm:text-7xl bg-gradient-to-b from-yellow-100 via-yellow-300 to-yellow-600 bg-clip-text text-transparent animate-sparkle-scale">emoji_events</span>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- インジケーター（スマホのみ表示） -->
      <div class="absolute bottom-6 left-0 right-0 flex justify-center space-x-2 sm:hidden z-10 pointer-events-none">
        <button type="button" data-action="carousel#scrollToSlide" data-index="0" data-carousel-target="indicator" class="w-2 h-2 rounded-full bg-white transition-all duration-300 shadow-sm pointer-events-auto"></button>
        <button type="button" data-action="carousel#scrollToSlide" data-index="1" data-carousel-target="indicator" class="w-2 h-2 rounded-full bg-white/40 transition-all duration-300 hover:bg-white/60 shadow-sm pointer-events-auto"></button>
      </div>
    </div>


    <!-- 下段グリッド：最新の投稿とメモ帳 -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <!-- 最新の投稿カード -->
      <%= link_to (@latest_post ? post_path(@latest_post) : posts_path), class: "block bg-gradient-to-br from-blue-100/80 to-white/80 dark:from-slate-900/80 dark:to-teal-950/80 backdrop-blur-xl border-2 border-white/60 dark:border-teal-500/50 dark:border-t-white/40 p-4 rounded-[3.75rem] shadow-[inset_2px_2px_0_rgba(59,130,246,0.15),15px_15px_40px_rgba(59,130,246,0.15),-15px_-15px_40px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(59,130,246,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9)] hover:shadow-xl dark:shadow-[0_0_15px_rgba(20,184,166,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] hover:dark:shadow-[0_0_30px_rgba(20,184,166,0.4),inset_0_0_0_1px_rgba(255,255,255,0.3)] transition-all duration-300 hover:scale-105 group relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse" do %>
        <div class="relative z-10 flex items-center space-x-3 mb-3">
          <span class="material-symbols-outlined text-blue-500 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-teal-300 dark:to-cyan-300 dark:drop-shadow-[0_0_8px_rgba(45,212,191,0.8)] text-2xl group-hover:scale-110 transition-transform duration-300">article</span>
          <h3 class="font-bold text-gray-700 dark:text-teal-50 text-lg">最新の投稿</h3>
        </div>

        <div class="bg-white/60 dark:bg-slate-800/50 rounded-2xl p-3 border border-blue-100 dark:border-teal-500/20 h-24 flex items-center justify-center overflow-hidden relative">
          <% if @latest_post %>
            <div class="w-full h-full flex flex-col justify-between">
              <div class="flex items-center gap-2">
                <!-- アバター -->
                <div class="flex-shrink-0">
                  <%= user_avatar(@latest_post.user, classes: "w-8 h-8 text-xs border border-white/50") %>
                </div>
                <span class="text-xs font-bold text-gray-700 dark:text-gray-200 truncate flex-1"><%= @latest_post.user.name %></span>
                <span class="text-xs text-gray-400 whitespace-nowrap"><%= time_ago_in_words(@latest_post.created_at) %>前</span>
              </div>

              <% if @latest_post.body.present? %>
                <div class="text-xs text-gray-600 dark:text-gray-300 line-clamp-2 mt-1 leading-relaxed">
                  <%= @latest_post.body %>
                </div>
              <% else %>
                <%# 本文がない場合は天気や気分を大きく中央に表示 %>
                <div class="flex items-center justify-center gap-2 flex-1">
                  <% if @latest_post.weather %>
                    <span class="text-3xl"><%= @latest_post.weather_emoji %></span>
                  <% end %>
                  <% if @latest_post.feeling %>
                    <span class="text-3xl"><%= @latest_post.feeling_emoji %></span>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center">
              <p class="text-blue-900 dark:text-teal-100 font-medium text-sm">まだ投稿はありません。</p>
              <p class="text-blue-600 dark:text-teal-400 text-xs mt-1">散歩の記録をシェアしてみましょう！</p>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- メモ帳カード -->
      <%= link_to "https://keep.google.com/", target: "_blank", rel: "noopener noreferrer", class: "block bg-gradient-to-br from-cyan-100/80 to-white/80 dark:from-slate-900/80 dark:to-purple-950/80 backdrop-blur-xl border-2 border-white/60 dark:border-purple-500/50 dark:border-t-white/40 p-5 rounded-[3.75rem] shadow-[inset_2px_2px_0_rgba(6,182,212,0.15),15px_15px_40px_rgba(59,130,246,0.15),-15px_-15px_40px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(59,130,246,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9)] hover:shadow-xl dark:shadow-[0_0_15px_rgba(168,85,247,0.15),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] hover:dark:shadow-[0_0_30px_rgba(168,85,247,0.4),inset_0_0_0_1px_rgba(255,255,255,0.3)] relative overflow-hidden transition-all duration-300 hover:scale-105 group before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse" do %>
        <div class="flex justify-between items-end relative z-10">
          <div>
            <h3 class="font-bold text-lg mb-2 text-cyan-900 dark:text-purple-50 text-shadow-sm">メモ帳</h3>
            <span class="material-symbols-outlined text-4xl text-cyan-700/50 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-purple-300 dark:to-pink-300 dark:drop-shadow-[0_0_8px_rgba(192,132,252,0.8)] -ml-1 transform -rotate-12">note_stack</span>
          </div>
          <div>
            <div class="bg-white dark:bg-slate-700/80 py-2 px-4 rounded-full flex items-center space-x-1 shadow-lg border border-transparent dark:border-purple-500/50 dark:shadow-[0_0_10px_rgba(168,85,247,0.3)] group-hover:bg-white dark:group-hover:bg-slate-800 transition-colors">
              <span class="material-symbols-outlined text-green-600 dark:text-purple-300 text-lg w-5 h-5 overflow-hidden">add</span>
              <span class="text-sm font-bold text-green-600 dark:text-purple-300">メモ帳を開く</span>
            </div>
            <p class="text-sm font-bold text-right mt-1 text-cyan-800/80 dark:text-purple-300/70">Google Keep に保存</p>
          </div>
        </div>

        <!-- 装飾用サークル -->
        <div class="absolute -top-4 -right-4 w-24 h-24 bg-cyan-50/50 dark:bg-purple-500/10 rounded-full blur-2xl pointer-events-none"></div>
      <% end %>
    </div>

    <!-- 運営からのお知らせ（大地カラー） -->
    <% if @announcements.any? %>
      <div class="block mt-6">
        <%= link_to notifications_path, class: "block relative bg-gradient-to-br from-white/90 to-orange-50/90 dark:from-stone-900 dark:to-stone-950 backdrop-blur-xl border-2 border-white/60 dark:border-stone-800 dark:border-t-white/40 p-5 rounded-[3.75rem] shadow-[inset_2px_2px_0_rgba(249,115,22,0.15),15px_15px_40px_rgba(249,115,22,0.15),-15px_-15px_40px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(249,115,22,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9)] hover:shadow-xl dark:shadow-[0_0_20px_rgba(249,115,22,0.25),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] hover:dark:shadow-[0_0_40px_rgba(249,115,22,0.4),inset_0_0_0_1px_rgba(255,255,255,0.3)] transition-all duration-300 hover:scale-105 overflow-hidden group before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse" do %>
          <!-- 背景装飾（巨大アイコン） -->
          <span class="material-symbols-outlined absolute -right-4 -bottom-4 text-9xl text-amber-200/30 dark:text-orange-500/10 transform rotate-12 transition-transform duration-500 group-hover:rotate-6 pointer-events-none">campaign</span>

          <!-- ヘッダー -->
          <div class="relative z-10 flex justify-between items-start mb-4">
            <div class="flex items-center space-x-2">
              <div class="relative bg-white/60 dark:bg-white/10 p-2 rounded-full backdrop-blur-sm shadow-sm group-hover:bg-white/80 dark:group-hover:bg-white/20 transition-all duration-300 group-hover:scale-110">
                <span class="material-symbols-outlined text-amber-600 dark:text-orange-200 text-xl">notifications_active</span>
                <% if current_user && current_user.unread_notifications_count > 0 %>
                  <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-md animate-pulse">
                    <%= current_user.unread_notifications_count %>
                  </span>
                <% end %>
              </div>
              <h3 class="font-bold text-amber-900 dark:text-orange-100 text-lg text-shadow-sm">運営からのお知らせ</h3>
            </div>
          </div>

          <!-- スクロール可能なコンテンツエリア -->
          <div class="relative z-10 bg-white/60 dark:bg-white/5 backdrop-blur-md rounded-xl border border-white/40 dark:border-white/10 shadow-inner max-h-[180px] overflow-y-auto scrollbar-thin scrollbar-thumb-amber-300 dark:scrollbar-thumb-stone-600 dark:scrollbar-track-stone-800/50">
            <div class="space-y-2 p-3">
              <% @announcements.each do |announcement| %>
                <div class="block">
                  <div class="flex items-start space-x-3 p-2 rounded-lg group-hover:bg-white/40 dark:group-hover:bg-white/5 transition-colors">
                    <!-- 日付とバッジ -->
                    <div class="flex-shrink-0 mt-0.5 flex flex-col items-center space-y-1">
                      <span class="text-xs font-bold bg-white/50 dark:bg-white/10 text-amber-900 dark:text-orange-200 px-2 py-0.5 rounded-md shadow-sm">
                        <%= announcement.published_at.strftime('%m/%d') %>
                      </span>
                      <% if announcement.announcement_type == 'urgent' %>
                        <span class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm animate-pulse">緊急</span>
                      <% elsif announcement.announcement_type == 'warning' %>
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm" style="background-color: #eab308; color: #000;">重要</span>
                      <% else %>
                        <span class="bg-blue-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm">NEW</span>
                      <% end %>
                    </div>

                    <!-- タイトルと本文 -->
                    <div class="flex-1 min-w-0">
                      <p class="text-sm font-bold text-amber-900 dark:text-orange-100 leading-relaxed text-shadow-sm">
                        <%= announcement.title %>
                      </p>
                      <p class="text-xs text-amber-800/80 dark:text-orange-200/70 mt-1 line-clamp-2">
                        <%= announcement.content %>
                      </p>
                    </div>
                  </div>
                </div>

                <!-- 区切り線（最後の要素以外） -->
                <% unless announcement == @announcements.last %>
                  <div class="border-t border-amber-200/30 dark:border-orange-500/20"></div>
                <% end %>
              <% end %>
            </div>
          </div>

          <!-- もっと見るリンク（見た目だけ） -->
          <div class="relative z-10 mt-3 text-center">
            <div class="inline-flex items-center space-x-1 text-sm font-bold text-amber-800 dark:text-orange-200 group-hover:text-amber-600 dark:group-hover:text-orange-100 transition-colors">
              <span>すべてのお知らせを見る</span>
              <span class="material-symbols-outlined text-sm group-hover:translate-x-1 transition-transform">arrow_forward</span>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

  </div>
  </div>
<% end %>
</file>

<file path="app/views/rankings/index.html.erb">
<!-- app/views/rankings/index.html.erb -->
<% content_for :head do %>
  <meta property="og:url" content="<%= request.original_url %>" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="今週のランキング結果 - てくメモ" />
  <%
    # シェアURLに含まれるuser_idを優先、なければログインユーザー
    ogp_user = params[:user_id].present? ? User.find_by(id: params[:user_id]) : current_user

    description = if ogp_user
                    "#{ogp_user.name}さんの今週のランキング結果をチェック！"
                  else
                    "てくメモで楽しくウォーキング習慣を身につけよう！"
                  end
  %>
  <meta property="og:description" content="<%= description %>" />
  <% if ogp_user %>
    <%
      # OGP画像URL（.jpg拡張子を明示的に含める）
      ogp_image_url = ogp_image_rankings_user_url(ogp_user, protocol: 'https') + ".jpg?v=#{Time.current.to_i}"
    %>
    <meta property="og:image" content="<%= ogp_image_url %>" />
    <meta name="twitter:image" content="<%= ogp_image_url %>" />
  <% else %>
    <meta property="og:image" content="<%= image_url('icon.png') %>" />
    <meta name="twitter:image" content="<%= image_url('icon.png') %>" />
  <% end %>
  <meta name="twitter:card" content="summary_large_image" />
<% end %>






<%# ランキング画面のダークモードでは、共通の背景アニメーション（パルス）が独自背景と干渉するため非表示にする %>
<style>
  html.dark body > .fixed.-z-10 {
    display: none !important;
  }
  /* ヘッダーの境界線を消す */
  html.dark header {
    border-bottom-color: transparent !important;
  }
</style>

<!-- Deep Void Background (Dark Mode Only) -->
<div class="fixed inset-0 -z-10 hidden dark:block bg-[#020617] bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-[#1a0b2e] via-[#020617] to-[#000000]"></div>

<div class="pb-20 relative overflow-hidden" data-controller="ogp-preview">

  <!-- ヘッダーエリア（PC用のみ表示） -->
  <div class="hidden md:block relative z-10 pt-8 pb-6 px-4 text-center">
    <div class="inline-block relative">
      <h1 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 via-pink-500 to-orange-500 dark:from-fuchsia-300 dark:via-purple-300 dark:to-violet-300 tracking-tight drop-shadow-sm dark:drop-shadow-[0_0_15px_rgba(168,85,247,0.5)]">
        <%= t('rankings.index.title') %>
      </h1>
      <div class="absolute -top-6 -right-8 text-4xl animate-bounce">🏆</div>
      <div class="absolute -bottom-2 -left-6 text-3xl animate-spin-slow">✨</div>
    </div>
    <p class="text-slate-600 dark:text-purple-200/80 text-sm mt-3 font-bold tracking-wide"><%= t('rankings.index.subtitle') %></p>

    <!-- リアルタイム更新インジケーター -->
    <div class="mt-4 flex flex-col items-center justify-center gap-1 text-xs text-slate-500 dark:text-purple-300/70">
      <div class="flex items-center gap-2">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75 dark:bg-emerald-400"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500 dark:bg-emerald-500 dark:shadow-[0_0_8px_rgba(16,185,129,0.8)]"></span>
        </span>
        <span><%= period_label_ja(@period) %><%= t('rankings.index.list_title') %></span>
      </div>
      <div class="text-slate-400 dark:text-purple-400/60 text-xs">
        <% if @last_data_updated_at && @next_cache_update_at %>
          <span class="inline-block">
            最終集計: <%= @last_data_updated_at.strftime('%m/%d %H:%M') %>
            <span class="mx-1 opacity-50">|</span>
            次回目安: <%= @next_cache_update_at.strftime('%m/%d %H:%M') %>
          </span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 期間切り替えタブ（レスポンシブマージン） -->
  <div class="px-6 mt-6 md:mt-0 mb-6 md:mb-8 relative z-10">
    <div class="bg-[#fdfbf7] dark:bg-slate-900/40 dark:backdrop-blur-xl p-1.5 rounded-full shadow-[inset_6px_6px_12px_rgba(166,175,195,0.2),inset_-6px_-6px_12px_rgba(255,255,255,0.8)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.1),0_0_20px_rgba(0,0,0,0.5)] border border-white/50 dark:border-white/10 flex justify-between items-center max-w-md mx-auto relative overflow-hidden">
      <% [
        { id: 'weekly', label: t('rankings.index.tabs.weekly'), icon: '🗓️' },
        { id: 'monthly', label: t('rankings.index.tabs.monthly'), icon: '📊' },
        { id: 'yearly', label: t('rankings.index.tabs.yearly'), icon: '🌟' }
      ].each do |tab| %>
        <%= link_to rankings_path(period: tab[:id]),
            data: { turbo_frame: "_top" },
            class: "flex-1 text-center py-2 px-3 rounded-full text-xs font-bold transition-all duration-300 relative overflow-hidden group #{
              @period == tab[:id] ?
              'text-purple-700 dark:text-white bg-white dark:bg-white/10 shadow-[4px_4px_8px_rgba(166,175,195,0.2),-4px_-4px_8px_rgba(255,255,255,0.9)] dark:shadow-[0_0_15px_rgba(255,255,255,0.1)] dark:border dark:border-white/10' :
              'text-slate-400 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 hover:-translate-y-0.5 dark:hover:bg-white/5'
            }" do %>
          <span class="relative z-10 flex items-center justify-center gap-1">
            <span class="text-base"><%= tab[:icon] %></span>
            <%= tab[:label] %>
          </span>
          <% if @period == tab[:id] %>
            <!-- Active Tab Glass Effect -->
            <div class="absolute inset-0 bg-gradient-to-b from-white/20 to-transparent opacity-50 pointer-events-none"></div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- 自分のスコアカード -->
  <div class="px-4 mb-8 sticky top-4 z-20 max-w-2xl mx-auto w-full">
    <% if @my_rank %>
      <div class="relative group">
        <!-- ダークモード用グロー (Breathing Glow) -->
        <div class="hidden dark:block absolute -inset-4 bg-purple-500/20 rounded-[3.75rem] blur-3xl animate-pulse-slow pointer-events-none"></div>

        <!-- God Mode Glass Card (Dark) / Crystal Clay Card (Light) -->
        <div class="relative bg-gradient-to-br from-white/90 via-white/60 to-white/30 dark:bg-none dark:bg-slate-900/40 rounded-[3.75rem] p-6 border border-white/60 dark:border-white/10 dark:border-t-white/40 shadow-[20px_20px_60px_rgba(168,85,247,0.15),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(168,85,247,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(168,85,247,0.3)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_30px_rgba(168,85,247,0.15)] backdrop-blur-xl overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse hover:scale-105 hover:dark:scale-100 hover:dark:border-purple-500/50 hover:dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.5),0_0_60px_rgba(168,85,247,0.4)] transition-all duration-300">

          <!-- Crystal Orbs (Light Mode Only) -->
          <div class="absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br from-purple-400/20 to-pink-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>
          <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-gradient-to-br from-blue-400/20 to-cyan-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

          <div class="flex items-center justify-between relative z-10">
            <div class="flex items-center gap-4">
              <div class="relative">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br <%= @my_rank <= 3 ? 'from-yellow-300 to-orange-400 dark:from-amber-300 dark:to-orange-500' : 'from-purple-400 to-pink-400 dark:from-fuchsia-400 dark:to-violet-600' %> flex flex-col items-center justify-center shadow-[inset_-2px_-2px_5px_rgba(255,255,255,0.7),inset_2px_2px_5px_rgba(0,0,0,0.1)] dark:shadow-[0_0_15px_rgba(255,255,255,0.3)] transform group-hover:scale-110 transition-transform leading-none">
                  <span class="text-3xl font-black text-white drop-shadow-md"><%= @my_rank %></span>
                  <span class="text-[10px] font-bold text-white/90 uppercase"><%= ordinal_suffix(@my_rank) %></span>
                </div>
                <% if @my_rank <= 3 %>
                  <div class="absolute -top-2 -right-2 text-2xl animate-bounce">👑</div>
                <% end %>
              </div>

              <div>
                <p class="text-xs text-purple-400 dark:text-fuchsia-300 font-bold uppercase tracking-wider mb-1"><%= t('rankings.index.your_rank.title') %></p>
                <p class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 dark:from-fuchsia-300 dark:to-violet-300">
                  <%= @my_rank %> <span class="text-sm"><%= t('rankings.index.your_rank.rank_suffix') %></span>
                </p>
                <% if @my_rank <= 10 %>
                  <p class="text-[10px] text-green-600 dark:text-emerald-400 font-bold mt-1">🔥 <%= t('rankings.index.your_rank.top_10') %></p>
                <% end %>
              </div>
            </div>

            <div class="text-right">
              <p class="text-xs text-purple-400 dark:text-fuchsia-300 font-bold uppercase tracking-wider mb-1"><%= t('rankings.index.your_rank.distance') %></p>
              <p class="text-2xl sm:text-3xl font-black text-slate-700 dark:text-white dark:drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">
                <%= number_with_precision(@my_distance, precision: 1) %>
              </p>
              <p class="text-xs text-slate-500 dark:text-slate-400"><%= t('rankings.index.your_rank.unit') %></p>

              <% if @distance_to_top > 0 %>
                <p class="text-[10px] text-orange-500 dark:text-amber-400 mt-2 font-bold">
                  🎯 <%= t('rankings.index.your_rank.distance_to_top') %>: <%= number_with_precision(@distance_to_top * 1000, precision: 0) %>m
                </p>
              <% end %>
            </div>
          </div>

          <!-- プログレスバー -->
          <% if @my_rank && @my_rank > 1 %>
            <% next_rank_distance = @rankings[@my_rank - 2]&.total_distance.to_f %>
            <% distance_needed = next_rank_distance - @my_distance %>
            <% if distance_needed > 0 %>
              <div class="mt-4 pt-4 border-t border-purple-100 dark:border-white/10 relative z-10">
                <div class="flex justify-between text-xs text-slate-500 dark:text-slate-300 mb-2">
                  <span><%= t('rankings.index.your_rank.distance_to_next') %></span>
                  <span class="font-bold text-orange-600 dark:text-amber-400"><%= number_with_precision(distance_needed * 1000, precision: 0) %>m</span>
                </div>
                <div class="h-3 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden shadow-inner dark:shadow-none">
                  <div class="h-full bg-gradient-to-r from-purple-400 to-pink-400 dark:from-fuchsia-500 dark:to-violet-500 rounded-full transition-all duration-500 dark:shadow-[0_0_10px_rgba(168,85,247,0.5)] relative overflow-hidden"
                       style="width: <%= [(@my_distance / next_rank_distance * 100), 100].min %>%">
                       <!-- Shimmer Effect -->
                       <div class="absolute inset-0 animate-shimmer bg-gradient-to-r from-transparent via-white/30 to-transparent -skew-x-12"></div>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>

          <!-- Xでシェアボタン -->
          <div class="mt-5 relative z-10">
            <%= link_to share_ranking_on_twitter_url(user: current_user, rank: @my_rank, distance: @my_distance * 1000, period: @period),
                target: "_blank",
                rel: "noopener noreferrer",
                class: "w-full md:w-auto md:px-10 md:min-w-[200px] mx-auto flex items-center justify-center gap-2 px-4 py-2.5 rounded-full bg-black dark:bg-[#000000] text-white dark:text-white text-sm font-bold hover:bg-gray-800 dark:hover:bg-[#111111] transition transform active:scale-95 shadow-md dark:shadow-[0_0_15px_rgba(255,255,255,0.1)] dark:border dark:border-white/20" do %>
              <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
              ランキングをシェア
            <% end %>
          </div>

          <!-- シェア画像プレビューリンク（小） -->
          <div class="mt-3 text-center relative z-10">
            <button data-action="click->ogp-preview#open" class="text-xs text-slate-500 dark:text-slate-400 hover:text-purple-600 dark:hover:text-fuchsia-300 underline transition">
              📷 シェア画像を確認
            </button>
          </div>
        </div>
      </div>
    <% elsif user_signed_in? %>
      <!-- ランキング外（ログイン済み） -->
      <div class="relative group">
        <div class="hidden dark:block absolute -inset-1 bg-gradient-to-r from-orange-600 to-red-600 rounded-[2rem] blur-lg opacity-50 group-hover:opacity-75 transition animate-pulse-slow"></div>

        <div class="relative bg-gradient-to-br from-orange-50/90 via-orange-50/60 to-orange-50/30 dark:bg-none dark:bg-slate-900/40 rounded-[3.75rem] p-4 border-2 border-white/60 dark:border-white/10 dark:border-t-white/40 shadow-[20px_20px_60px_rgba(249,115,22,0.15),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(249,115,22,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(249,115,22,0.3)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_30px_rgba(249,115,22,0.15)] overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">

          <!-- Crystal Orbs (Light Mode Only) -->
          <div class="absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br from-orange-400/20 to-red-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

          <div class="flex items-center gap-3 relative z-10">
            <div class="text-3xl animate-bounce">🔥</div>
            <div class="flex-1">
              <p class="text-base font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-500 dark:from-orange-300 dark:to-red-300 mb-0.5">
                <%= t('rankings.index.empty.challenge') %>
              </p>
              <p class="text-xs text-slate-600 dark:text-slate-300">
                <%= period_label_ja(@period) %>: <span class="font-bold text-slate-800 dark:text-white"><%= number_with_precision(@my_distance, precision: 1) %>km</span>
              </p>
              <p class="text-[10px] text-orange-500 dark:text-orange-400 mt-1">💪 <%= t('rankings.index.empty.cheer') %></p>
            </div>
            <div class="text-2xl">⚡</div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- 表彰台（トップ3専用エリア） -->
  <% if @rankings.present? %>
    <div class="px-4 mb-8 max-w-2xl mx-auto">
      <h2 class="text-center text-xl font-black text-slate-700 dark:text-white mb-6 flex items-center justify-center gap-2 dark:drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]">
        <span>🏆</span> <%= t('rankings.index.podium') %> <span>🏆</span>
      </h2>

      <div class="flex items-end justify-center gap-2 sm:gap-6 md:gap-12 mb-8 w-full max-w-lg mx-auto">
        <!-- 2位 (Silver) -->
        <div class="flex-1 min-w-0 text-center transform hover:scale-105 transition-transform duration-300 <%= 'opacity-0' unless @rankings[1] %>">
          <% if second = @rankings[1] %>
            <div class="relative inline-block mb-2">
              <%= user_avatar(second,
                  classes: "relative w-10 h-10 md:w-16 md:h-16 border-2 md:border-4 border-slate-200/80 dark:border-slate-200 shadow-[4px_4px_8px_rgba(148,163,184,0.4),-4px_-4px_8px_rgba(255,255,255,0.8)] dark:shadow-[0_0_20px_rgba(226,232,240,0.5)] z-10 text-lg md:text-2xl",
                  default_color_classes: "bg-gradient-to-br from-slate-400 to-slate-500 text-white") %>
              <div class="absolute -bottom-2 -right-2 text-xl md:text-3xl drop-shadow-md z-20">🥈</div>
            </div>
            <p class="text-slate-700 dark:text-slate-100 font-bold text-[10px] md:text-sm truncate px-1 dark:drop-shadow-[0_0_5px_rgba(0,0,0,0.8)]"><%= second.name.presence || "No Name" %></p>
            <p class="text-slate-500 dark:text-slate-300 text-[10px] md:text-xs font-bold"><%= number_with_precision(second.total_distance, precision: 1) %>km</p>

            <!-- Silver Podium Bar (Crystal Pillar) -->
            <div class="mt-2 h-24 md:h-40 w-[90%] mx-auto bg-gradient-to-b from-slate-200/90 via-slate-300/80 to-slate-400/90 dark:from-slate-400 dark:via-slate-300 dark:to-white rounded-t-[2rem] md:rounded-t-[3rem] border-4 border-white/80 dark:border-slate-300 dark:border-t-white shadow-[inset_0_5px_10px_rgba(255,255,255,0.6),inset_0_-10px_20px_rgba(148,163,184,0.3),5px_5px_15px_rgba(148,163,184,0.2),-2px_-2px_10px_rgba(255,255,255,0.5)] dark:shadow-[0_0_30px_rgba(148,163,184,0.4),inset_0_0_20px_rgba(255,255,255,0.3)] flex items-start justify-center pt-3 md:pt-5 relative overflow-hidden group-hover:dark:shadow-[0_0_50px_rgba(148,163,184,0.6)] transition-all backdrop-blur-sm">
               <!-- Liquid/Glass Shine -->
               <div class="absolute top-2 left-1/2 -translate-x-1/2 w-[60%] h-3 bg-white/60 rounded-full blur-[2px] dark:hidden"></div>
               <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/40 to-transparent opacity-50 pointer-events-none"></div>
              <span class="text-2xl md:text-4xl font-black text-slate-400/50 dark:text-slate-800 drop-shadow-sm dark:drop-shadow-none">2</span>
            </div>
          <% end %>
        </div>

        <!-- 1位 (Gold) -->
        <div class="flex-1 min-w-0 text-center transform hover:scale-110 transition-transform duration-300 <%= 'opacity-0' unless @rankings[0] %>">
          <% if first = @rankings[0] %>
            <div class="relative inline-block mb-2">
              <%= user_avatar(first,
                  classes: "relative w-14 h-14 md:w-20 md:h-20 border-4 border-yellow-300/80 dark:border-yellow-200 shadow-[6px_6px_12px_rgba(250,204,21,0.4),-6px_-6px_12px_rgba(255,255,255,0.9)] dark:shadow-[0_0_40px_rgba(251,191,36,0.6)] z-10 text-xl md:text-3xl",
                  default_color_classes: "bg-gradient-to-br from-yellow-400 to-orange-500 text-white") %>
              <div class="absolute -top-3 left-1/2 -translate-x-1/2 text-2xl md:text-4xl animate-bounce drop-shadow-lg z-20">👑</div>
              <div class="absolute -bottom-2 -right-2 text-2xl md:text-4xl drop-shadow-lg z-20">🥇</div>
            </div>
            <p class="text-yellow-700 dark:text-yellow-100 font-black text-xs md:text-base truncate px-1 dark:drop-shadow-[0_0_8px_rgba(234,179,8,0.8)]">🌟 <%= first.name.presence || "No Name" %></p>
            <p class="text-yellow-600 dark:text-yellow-200 text-xs md:text-sm font-bold"><%= number_with_precision(first.total_distance, precision: 1) %>km</p>

            <!-- Gold Podium Bar (Crystal Pillar) -->
            <div class="mt-2 h-32 md:h-52 w-[90%] mx-auto bg-gradient-to-b from-yellow-200/90 via-yellow-300/80 to-orange-300/90 dark:from-yellow-500 dark:via-amber-400 dark:to-yellow-200 rounded-t-[2.5rem] md:rounded-t-[3.5rem] border-4 border-white/80 dark:border-yellow-200 dark:border-t-white shadow-[inset_0_5px_10px_rgba(255,255,255,0.6),inset_0_-10px_20px_rgba(234,179,8,0.3),10px_10px_20px_rgba(234,179,8,0.2),-2px_-2px_10px_rgba(255,255,255,0.5)] dark:shadow-[0_0_60px_rgba(251,191,36,0.5),inset_0_0_30px_rgba(255,255,255,0.4)] flex items-start justify-center pt-3 md:pt-5 relative overflow-hidden group-hover:dark:shadow-[0_0_80px_rgba(251,191,36,0.7)] transition-all backdrop-blur-sm">
              <!-- Liquid/Glass Shine -->
              <div class="absolute top-3 left-1/2 -translate-x-1/2 w-[60%] h-4 bg-white/60 rounded-full blur-[3px] dark:hidden"></div>
              <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/50 to-transparent opacity-60 pointer-events-none animate-pulse-slow"></div>
              <span class="text-3xl md:text-5xl font-black text-yellow-500/40 dark:text-yellow-900 drop-shadow-sm dark:drop-shadow-none">1</span>
            </div>
          <% end %>
        </div>

        <!-- 3位 (Bronze) -->
        <div class="flex-1 min-w-0 text-center transform hover:scale-105 transition-transform duration-300 <%= 'opacity-0' unless @rankings[2] %>">
          <% if third = @rankings[2] %>
            <div class="relative inline-block mb-2">
              <%= user_avatar(third,
                  classes: "relative w-10 h-10 md:w-16 md:h-16 border-2 md:border-4 border-orange-200/80 dark:border-orange-200 shadow-[4px_4px_8px_rgba(251,146,60,0.4),-4px_-4px_8px_rgba(255,255,255,0.8)] dark:shadow-[0_0_20px_rgba(251,146,60,0.5)] z-10 text-lg md:text-2xl",
                  default_color_classes: "bg-gradient-to-br from-orange-400 to-red-400 text-white") %>
              <div class="absolute -bottom-2 -right-2 text-xl md:text-3xl drop-shadow-md z-20">🥉</div>
            </div>
            <p class="text-slate-700 dark:text-orange-100 font-bold text-[10px] md:text-sm truncate px-1 dark:drop-shadow-[0_0_5px_rgba(0,0,0,0.8)]"><%= third.name.presence || "No Name" %></p>
            <p class="text-orange-600 dark:text-orange-200 text-[10px] md:text-xs font-bold"><%= number_with_precision(third.total_distance, precision: 1) %>km</p>

            <!-- Bronze Podium Bar (Crystal Pillar) -->
            <div class="mt-2 h-16 md:h-28 w-[90%] mx-auto bg-gradient-to-b from-orange-200/90 via-orange-300/80 to-red-200/90 dark:from-orange-600 dark:via-orange-500 dark:to-orange-300 rounded-t-[2rem] md:rounded-t-[3rem] border-4 border-white/80 dark:border-orange-300 dark:border-t-white shadow-[inset_0_5px_10px_rgba(255,255,255,0.6),inset_0_-10px_20px_rgba(251,146,60,0.3),5px_5px_15px_rgba(251,146,60,0.2),-2px_-2px_10px_rgba(255,255,255,0.5)] dark:shadow-[0_0_30px_rgba(249,115,22,0.4),inset_0_0_20px_rgba(255,255,255,0.2)] flex items-start justify-center pt-3 md:pt-5 relative overflow-hidden group-hover:dark:shadow-[0_0_50px_rgba(249,115,22,0.6)] transition-all backdrop-blur-sm">
               <!-- Liquid/Glass Shine -->
               <div class="absolute top-2 left-1/2 -translate-x-1/2 w-[60%] h-3 bg-white/60 rounded-full blur-[2px] dark:hidden"></div>
               <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/30 to-transparent opacity-50 pointer-events-none"></div>
              <span class="text-2xl md:text-4xl font-black text-orange-400/50 dark:text-orange-900 drop-shadow-sm dark:drop-shadow-none">3</span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- ランキングリスト（4位以降） -->
  <div class="px-4 max-w-2xl mx-auto space-y-3">
    <% if @rankings.size > 3 %>
      <h3 class="text-lg font-bold text-slate-700 dark:text-white mb-4 flex items-center gap-2">
        <span class="text-2xl">
          <%= case @period
              when 'weekly' then '🗓️'
              when 'monthly' then '📊'
              when 'yearly' then '🌟'
              else '🗓️'
              end %>
        </span>
        <%= t('rankings.index.list_title') %>
      </h3>
    <% end %>

    <% last_distance = nil %>
    <% current_rank = 0 %>
    <% @rankings.each_with_index do |user, index| %>
      <% # 距離が異なる場合のみ順位を更新（同距離なら維持） %>
      <% # 小数点以下の誤差を考慮して比較 %>
      <% distance = user.total_distance.to_f.round(2) %>
      <% if distance != last_distance %>
        <% current_rank = index + 1 %>
      <% end %>
      <% last_distance = distance %>

      <% rank = current_rank %>
      <% next if index < 3 # 上位3名は別枠表示だが、順位計算のためにループは回す %>
      <% is_current_user = current_user && user.id == current_user.id %>

      <div class="relative group transition-all duration-300 hover:-translate-y-1 hover:scale-[1.01]">
        <!-- ダークモード用グロー（自分の場合） -->
        <% if is_current_user %>
          <div class="hidden dark:block absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-pink-600 rounded-[3.75rem] blur opacity-75 animate-pulse-slow"></div>
        <% end %>

        <!-- Crystal Clay Card (Light) / Glass Card (Dark) -->
        <div class="relative bg-gradient-to-br from-white/95 via-white/80 to-white/60 dark:bg-none dark:bg-slate-900/40 dark:backdrop-blur-md rounded-[2.5rem] dark:rounded-[3.75rem] p-4 border border-white/80 dark:border-white/10 dark:border-t-white/30 shadow-[10px_10px_30px_rgba(166,175,195,0.15),-10px_-10px_30px_rgba(255,255,255,0.9),inset_0_0_20px_rgba(255,255,255,0.5)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2),0_0_15px_rgba(0,0,0,0.3)] hover:shadow-[15px_15px_40px_rgba(166,175,195,0.2),-15px_-15px_40px_rgba(255,255,255,1)] dark:hover:shadow-[inset_0_1px_0_rgba(255,255,255,0.4),0_0_30px_rgba(168,85,247,0.2)] transition-all flex items-center gap-4 <%= 'ring-4 ring-purple-100 ring-offset-0 dark:ring-0' if is_current_user %> overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/20 before:to-transparent before:rounded-t-[2.5rem] dark:before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">

          <!-- Crystal Orbs (Light Mode Only) -->
          <div class="absolute -top-10 -right-10 w-24 h-24 bg-gradient-to-br from-purple-400/10 to-pink-400/10 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

          <!-- 順位バッジ -->
          <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-2xl dark:rounded-2xl shadow-[inset_-2px_-2px_5px_rgba(255,255,255,0.7),inset_2px_2px_5px_rgba(166,175,195,0.1)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2)] <%= rank <= 10 ? 'bg-gradient-to-br from-purple-100 to-pink-100 dark:from-fuchsia-500 dark:to-violet-600' : 'bg-slate-50 dark:bg-slate-800' %> relative z-10 border border-white/50 dark:border-none">
            <span class="text-xl font-black <%= rank <= 10 ? 'text-purple-600 dark:text-white' : 'text-slate-500 dark:text-slate-400' %>"><%= rank %></span>
          </div>

            <!-- ユーザー情報 -->
          <div class="flex-1 min-w-0 flex items-center gap-3 relative z-10">
            <% if user.avatar_url.present? && user.google? %>
              <%= user_avatar(user, classes: "w-10 h-10 border-2 border-white dark:border-white/20 shadow-md text-sm") %>
            <% else %>
              <%= user_avatar(user,
                  classes: "w-10 h-10 border-2 border-white shadow-md text-sm",
                  default_color_classes: "bg-gradient-to-br from-blue-400 to-blue-500 dark:border-blue-400 text-white") %>
            <% end %>

            <div class="flex-1 min-w-0">
              <p class="font-bold <%= is_current_user ? 'text-purple-700 dark:text-fuchsia-300' : 'text-slate-700 dark:text-slate-200' %> truncate">
                <%= user.name.presence || "No Name" %>
              </p>
              <div class="flex items-center gap-2 mt-0.5">
                <% if rank <= 10 %>
                  <p class="text-[10px] text-purple-500 dark:text-fuchsia-400 font-bold bg-purple-50 dark:bg-transparent px-1.5 py-0.5 rounded-full">TOP 10</p>
                <% end %>
                <% if is_current_user %>
                  <span class="text-[10px] bg-purple-500 dark:bg-fuchsia-600 text-white px-2 py-0.5 rounded-full shadow-sm whitespace-nowrap"><%= t('rankings.index.you') %></span>
                <% end %>
              </div>
            </div>
          </div>

          <!-- 距離 -->
          <div class="text-right relative z-10">
            <span class="block text-2xl font-black <%= is_current_user ? 'text-purple-600 dark:text-fuchsia-300' : 'text-slate-700 dark:text-white' %> group-hover:text-purple-600 dark:group-hover:text-fuchsia-300 transition-colors drop-shadow-sm dark:drop-shadow-none">
              <%= number_with_precision(user.total_distance, precision: 1) %>
            </span>
            <span class="text-[10px] text-slate-400 dark:text-slate-500 font-bold uppercase tracking-wider">km</span>
          </div>
        </div>
      </div>
    <% end %>

    <!-- 空状態 -->
    <% if @rankings.empty? %>
      <div class="relative group">
        <div class="hidden dark:block absolute -inset-1 bg-gradient-to-r from-purple-600 to-pink-600 rounded-[3.75rem] blur-xl opacity-30 animate-pulse-slow"></div>

        <div class="relative bg-gradient-to-br from-white/90 via-white/60 to-white/30 dark:bg-none dark:bg-slate-900/40 dark:backdrop-blur-md rounded-[3.75rem] p-12 border-2 border-white/60 dark:border-white/10 dark:border-t-white/30 shadow-[20px_20px_60px_rgba(166,175,195,0.15),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(166,175,195,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(255,255,255,0.5)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2),0_0_40px_rgba(168,85,247,0.2)] text-center overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
          <div class="text-7xl mb-6 animate-bounce relative z-10">🍃</div>
          <p class="text-slate-700 dark:text-white font-black text-2xl mb-3 relative z-10"><%= t('rankings.index.empty.title') %></p>
          <p class="text-slate-500 dark:text-slate-300 text-sm mb-8 relative z-10"><%= t('rankings.index.empty.subtitle') %></p>
          <%= link_to t('rankings.index.empty.action'), new_walk_path,
              class: "relative z-10 inline-block px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-fuchsia-600 dark:to-pink-600 text-white font-bold rounded-full shadow-lg hover:scale-110 hover:shadow-xl dark:hover:shadow-[0_0_20px_rgba(236,72,153,0.5)] transition-all" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- 注意書き -->
  <div class="px-4 mt-12 max-w-2xl mx-auto">
    <p class="text-xs text-center text-slate-400 dark:text-slate-500">
      このランキングは公開情報です。ユーザー名と歩行距離が表示されます。
    </p>
  </div>




  <div class="h-20"></div>

  <!-- OGPプレビューモーダル -->
  <% if user_signed_in? %>
    <div id="ogp-preview-modal"
         data-ogp-preview-target="modal"
         class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-200 opacity-0"
         data-action="click->ogp-preview#closeBackground">

      <div data-ogp-preview-target="container"
           class="relative bg-white dark:bg-slate-900/90 rounded-[3.75rem] p-8 max-w-2xl w-full shadow-2xl transform transition-all border-4 border-white dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_50px_rgba(168,85,247,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1)] overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[20%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none">

        <!-- 閉じるボタン -->
        <button data-action="click->ogp-preview#close" class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 hover:text-slate-700 dark:bg-white/10 dark:hover:bg-white/20 dark:text-gray-300 dark:hover:text-white transition-all duration-200 z-50 shadow-md hover:shadow-lg hover:scale-110 active:scale-95">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>

        <!-- タイトル -->
        <h3 class="text-lg font-bold text-slate-700 dark:text-white mb-2 flex items-center gap-2 relative z-10 pr-12">
          <span>🖼️</span> シェア画像プレビュー
        </h3>
        <p class="text-xs text-slate-500 dark:text-slate-400 mb-4 leading-relaxed relative z-10 pr-12">
          X(Twitter)などでシェアされた時に表示される画像です。<br>
          <span class="text-orange-500 dark:text-amber-400">※画像がアイコンのままの場合は、生成中です。数秒待ってからリロードしてください。</span>
        </p>

        <!-- プレビュー画像 -->
        <div class="relative aspect-[1.91/1] w-full rounded-xl overflow-hidden shadow-lg bg-slate-200 dark:bg-slate-800 z-10">
          <!-- ローディング表示 -->
          <div data-ogp-preview-target="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-100 dark:bg-slate-800">
            <div class="animate-spin rounded-full h-16 w-16 border-4 border-slate-300 dark:border-slate-600 border-t-purple-600 dark:border-t-fuchsia-500"></div>
            <p class="mt-4 text-sm font-bold text-slate-600 dark:text-slate-300">画像を読み込み中...</p>
            <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">生成に数秒かかる場合があります</p>
          </div>

          <!-- OGP画像 -->
          <%= image_tag ogp_image_rankings_user_path(current_user, format: :jpg, v: Time.current.to_i),
              data: {
                ogp_preview_target: "image",
                action: "error->ogp-preview#handleError load->ogp-preview#handleLoad"
              },
              class: "w-full h-full object-cover opacity-0 transition-opacity duration-500",
              alt: "Ranking OGP Preview" %>
        </div>

        <!-- アクションボタン -->
        <div class="mt-4 flex justify-end relative z-10">
          <button data-action="click->ogp-preview#refresh" class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg transition-colors text-sm font-bold border border-transparent dark:border-white/10">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            画像を最新にする
          </button>
        </div>
      </div>
    </div>

    <!-- OGP Preview Controller is now handled by Stimulus -->
  <% end %>
</div>
</file>

<file path="app/models/user.rb">
class User < ApplicationRecord
  # Include default devise modules. Others available are:
  # :confirmable, :lockable, :timeoutable, :trackable and :omniauthable
  devise :database_authenticatable, :registerable,
         :recoverable, :rememberable, :validatable, :trackable,
         :omniauthable, omniauth_providers: [ :google_oauth2 ]
  # ユーザー権限（0: 一般, 1: 管理者, 2: ゲスト管理者）
  # guest: 管理画面へアクセス可だが、閲覧のみ等の制限あり
  enum :role, { general: 0, admin: 1, guest: 2 }

  # 散歩記録との関連付け（1人のユーザーは複数の散歩記録を持つ）
  # dependent: :destroy は、ユーザーが削除されたときに関連する散歩記録も一緒に削除する
  has_many :walks, dependent: :destroy

  # SNS機能の関連付け
  has_many :posts, dependent: :destroy
  has_many :reactions, dependent: :destroy

  # 通知機能の関連付け
  has_many :notifications, dependent: :destroy
  has_many :web_push_subscriptions, dependent: :destroy

  # 実績機能の関連付け
  has_many :user_achievements, dependent: :destroy
  has_many :achievements, through: :user_achievements

  # Active Storage: ランキングOGP画像の添付
  has_one_attached :ranking_ogp_image

  # Active Storage: Googleアバター画像のキャッシュ（OGP生成高速化のため）
  has_one_attached :cached_avatar

  # Active Storage: ユーザーアップロードのアバター画像
  has_one_attached :uploaded_avatar

  # アバターの種類（0: デフォルト, 1: Google画像, 2: アップロード画像）
  enum :avatar_type, { default: 0, google: 1, uploaded: 2 }

  # ユーザー名のバリデーション
  validates :name, presence: true

  # 目標距離のバリデーション
  # 1. 必須であること（デフォルト値があるため通常は問題ないが、念のため）
  # 2. 数値であること
  # 3. 0より大きいこと
  validates :target_distance, presence: true, numericality: { only_integer: true, greater_than: 0, less_than_or_equal_to: 100_000 }

  # 通知設定のバリデーション
  validates :inactive_days_threshold, numericality: { only_integer: true, greater_than_or_equal_to: 1, less_than_or_equal_to: 30 }
  validates :walk_reminder_time, presence: true, if: :walk_reminder_enabled?

  # アバター画像のバリデーション
  validate :validate_uploaded_avatar

  private

  def validate_uploaded_avatar
    return unless uploaded_avatar.attached?

    # ファイルサイズ制限 (5MB)
    if uploaded_avatar.blob.byte_size > 5.megabytes
      errors.add(:uploaded_avatar, "は5MB以下にしてください")
    end

    # ファイル形式制限
    unless uploaded_avatar.content_type.in?(%w[image/jpeg image/png image/gif image/webp])
      errors.add(:uploaded_avatar, "は画像ファイル（JPG, PNG, GIF, WEBP）のみアップロード可能です")
    end
  end

  public

  # 表示するアバターURLを決定するメソッド
  # 優先順位: uploaded > google > default
  # ただし、avatar_typeの設定に従って返す
  def display_avatar_url
    if uploaded?
      uploaded_avatar if uploaded_avatar.attached?
    elsif google?
      avatar_url if avatar_url.present?
    else
      nil # デフォルト（イニシャル画像など）を表示
    end
  end

  # Google OAuth2認証のコールバック処理
  # OmniAuthから返されたデータを使って、ユーザー情報とトークンを保存する
  def self.from_omniauth(auth)
    # Google UIDでユーザーを検索
    # メールアドレスでの自動紐付けは行わない（セキュリティと意図しない連携を防ぐため）
    user = User.find_by(google_uid: auth.uid)

    if user
      # 既存ユーザー（連携済み）の場合、Google認証情報を更新
      user.update(
        google_uid: auth.uid,
        google_token: auth.credentials.token,
        google_refresh_token: auth.credentials.refresh_token,
        google_expires_at: Time.at(auth.credentials.expires_at),
        avatar_url: auth.info.image, # アバター画像を更新
        avatar_type: :google # アバター種別をGoogleに設定
      )
    end

    user
  end

  # ポートフォリオ閲覧用ゲストユーザーを作成
  # 管理者（Admin）のデータをコピーして、リッチな体験を提供する
  def self.create_portfolio_guest
    # 古いゲストユーザーをお掃除（作成から24時間以上経過）
    cleanup_old_guests

    # コピー元となるユーザーを取得
    # 1. 散歩記録が多い管理者を優先（リッチなデータをコピーするため）
    # 2. いなければ管理者の最初
    admin_user = User.admin.joins(:walks).group("users.id").order("COUNT(walks.id) DESC").first || User.admin.first

    # 互換性のため、ID:2が存在し、かつデータがあるならそれを使う手もあるが、動的なデータ量を優先する

    Rails.logger.info "Guest Mode: Selected admin user candidate ID: #{admin_user&.id}"

    # 万が一管理者がいない場合は、最低限のゲストを作成して返す
    unless admin_user
      return create_fallback_guest
    end

    # トランザクションで一括処理
    transaction do
      # ゲストユーザー作成
      guest_email = "guest_#{Time.current.to_i}_#{SecureRandom.hex(4)}@example.com"
      guest = User.create!(
        email: guest_email,
        password: SecureRandom.urlsafe_base64,
        name: "ゲストユーザー",
        role: :guest,
        target_distance: admin_user.target_distance,
        avatar_type: :default,
        # 通知設定などはデフォルトでOK
      )

      # === データコピー処理 (直近3ヶ月分) ===

      # 1. 散歩記録（Walks）のコピー
      # コピー対象期間
      range = 3.months.ago.to_date..Date.current

      source_walks = admin_user.walks.where(walked_on: range)
      Rails.logger.info "Guest Mode: Cloning data from Admin ID: #{admin_user.id}"
      Rails.logger.info "Guest Mode: Copying #{source_walks.count} walks..."

      # insert_allのためのハッシュ配列を作成
      walks_data = source_walks.map do |walk|
        walk.attributes.except("id", "user_id", "created_at", "updated_at").merge(
          "user_id" => guest.id,
          "created_at" => Time.current,
          "updated_at" => Time.current
        )
      end

      # 一括挿入（バリデーションスキップ・高速化）
      Walk.insert_all(walks_data) if walks_data.present?

      # 2. 投稿（Posts）のコピー
      # タイムスタンプも維持したいので、created_atもコピーする
      source_posts = admin_user.posts.where(created_at: 3.months.ago..Time.current)

      posts_data = source_posts.map do |post|
        post.attributes.except("id", "user_id").merge(
          "user_id" => guest.id
        )
      end

      Post.insert_all(posts_data) if posts_data.present?
      Rails.logger.info "Guest Mode: Copied #{posts_data.size} posts" if posts_data.present?

      # 3. 実績（Achievements）のコピー
      # 中間テーブル UserAchievement をコピー
      source_achievements = admin_user.user_achievements

      achievements_data = source_achievements.map do |ua|
        ua.attributes.except("id", "user_id", "created_at", "updated_at").merge(
          "user_id" => guest.id,
          "created_at" => Time.current,
          "updated_at" => Time.current
        )
      end

      UserAchievement.insert_all(achievements_data) if achievements_data.present?
      Rails.logger.info "Guest Mode: Copied #{achievements_data.size} achievements" if achievements_data.present?

      # 作成したゲストユーザーを返す
      guest
    rescue ActiveRecord::RecordInvalid => e
      Rails.logger.error "Guest creation validation failed: #{e.message}"
      raise  # トランザクションロールバック
    rescue => e
      Rails.logger.error "Guest creation failed: #{e.class} - #{e.message}"
      raise
    end
  end

  # 管理者がいない場合のフォールバック用ゲスト作成
  def self.create_fallback_guest
    guest_email = "guest_#{Time.current.to_i}@example.com"
    User.create!(
      email: guest_email,
      password: SecureRandom.urlsafe_base64,
      name: "ゲストユーザー",
      role: :guest,
      target_distance: 5000,
      avatar_type: :default
    )
  end

  # 古いゲストアカウントのお掃除
  def self.cleanup_old_guests
    # role: guest かつ 作成から24時間以上経過したユーザーを削除
    User.where(role: :guest).where("created_at < ?", 24.hours.ago).destroy_all
  end

  def google_token_valid?
    google_token_status == :valid
  end

  # Googleトークンの詳細なステータスを返す
  # @return [Symbol] :valid, :not_connected, :expired_need_reauth, :temporary_error
  def google_token_status
    return :valid if admin? || guest? # 管理者またはゲストユーザーは常に連携済み（デモ用）
    return :not_connected unless google_token.present? && google_refresh_token.present?

    # トークンの有効期限をチェック
    if google_expires_at.present? && google_expires_at > Time.current
      :valid
    else
      # 期限切れの場合、リフレッシュトークンで自動更新を試みる
      case refresh_google_token!
      when true then :valid
      when :reauth_required then :expired_need_reauth
      else :temporary_error
      end
    end
  end

  # リフレッシュトークンを使用してアクセストークンを更新する
  # @return [Boolean, Symbol] true:成功, :reauth_required:再認証が必要, false:その他エラー
  def refresh_google_token!
    return false unless google_refresh_token.present?

    require "net/http"
    require "json"

    # Google OAuth2のトークンエンドポイント
    uri = URI("https://oauth2.googleapis.com/token")

    # リフレッシュリクエストのパラメータ
    google_creds = Rails.application.credentials.google || {}
    params = {
      client_id: google_creds[:client_id],
      client_secret: google_creds[:client_secret],
      refresh_token: google_refresh_token,
      grant_type: "refresh_token"
    }

    begin
      # POSTリクエストを送信
      response = Net::HTTP.post_form(uri, params)
      data = JSON.parse(response.body)

      if response.is_a?(Net::HTTPSuccess) && data["access_token"]
        # 新しいトークン情報で更新
        update!(
          google_token: data["access_token"],
          google_expires_at: Time.current + data["expires_in"].to_i.seconds
        )

        Rails.logger.info "Google token refreshed successfully for user #{id}"
        true
      else
        error_type = data["error"]
        if error_type == "invalid_grant"
          # リフレッシュトークンが無効化された（許可剥奪など）
          Rails.logger.error "Google refresh token revoked for user #{id}"
          :reauth_required
        else
          Rails.logger.error "Failed to refresh Google token for user #{id}: #{error_type}"
          false
        end
      end
    rescue StandardError => e
      Rails.logger.error "Error refreshing Google token for user #{id}: #{e.message}"
      false
    end
  end

  # 連続して散歩した日数を計算する
  # 注意: 今日の記録がある場合は今日から、ない場合は昨日から遡ってカウントする
  #       これにより、今日歩いた瞬間に+1日として反映され、
  #       今日歩いていなくても昨日までの連続記録が維持される
  def consecutive_walk_days
    # 今日の記録があるかチェック
    has_walked_today = walks.exists?(walked_on: Date.current)

    # カウント開始日を決定（今日歩いた場合は今日から、そうでなければ昨日から）
    start_date = has_walked_today ? Date.current : Date.yesterday

    # N+1対策: ループ内でのクエリ発行を避けるため、必要な日付データを一括取得
    # 開始日以前の記録の日付を重複なしで降順（新しい順）に取得
    walk_dates = walks.where("walked_on <= ?", start_date)
                      .select(:walked_on)
                      .distinct
                      .order(walked_on: :desc)
                      .pluck(:walked_on)

    consecutive_count = 0
    check_date = start_date

    walk_dates.each do |date|
      if date == check_date
        # 日付が一致すればカウントアップし、チェック対象を前日にずらす
        consecutive_count += 1
        check_date -= 1.day
      else
        # 日付が連続していない（飛んでいる）場合、そこで終了
        break
      end
    end

    consecutive_count
  end

  # 過去の最大連続記録日数を計算する
  def max_consecutive_walk_days
    # 日付のみを取得してソート（重複排除）
    dates = walks.order(walked_on: :asc).pluck(:walked_on).uniq

    return 0 if dates.empty?

    max_streak = 0
    current_streak = 0
    prev_date = nil

    dates.each do |date|
      if prev_date.nil? || date == prev_date + 1.day
        current_streak += 1
      else
        # 連続が途切れた場合、最大値を更新してリセット
        max_streak = [ max_streak, current_streak ].max
        current_streak = 1
      end
      prev_date = date
    end

    # 最後のストリークも含めて最大値を返す
    [ max_streak, current_streak ].max
  end

  # ランキング用クラスメソッド
  # 期間ごとの距離を集計して降順に並べる
  # @param period [String] 期間（weekly, monthly, all_time）
  def self.ranking(period: "weekly", limit: 100)
    # 期間に応じた日付範囲を取得
    start_date = case period
    when "weekly"
                   Date.current.beginning_of_week
    when "monthly"
                   Date.current.beginning_of_month
    when "yearly"
                   Date.current.beginning_of_year
    when "all_time"
                   nil # 全期間
    else
                   Date.current.beginning_of_week
    end

    # 実際に歩いた距離を集計
    relation = joins(:walks)

    relation = relation.where(walks: { walked_on: start_date..Date.current }) if start_date

    relation
      .group(:id)
      .select("users.*, SUM(walks.distance) as total_distance")
      .order(Arel.sql("total_distance DESC"))
      .limit(limit) # 制限行数
  end

  # 閲覧ユーザーに応じたランキングスコープ
  # ゲスト以外が見る場合、ゲストユーザーはランキングから除外して「汚染」を防ぐ
  # ゲスト自身が見る場合、自分（と他のゲスト）も含めて表示し、自分の順位を確認できるようにする
  scope :ranking_for, ->(user, period: "weekly") {
    if user&.guest?
      # ゲストが見る場合: 全ユーザーを対象（現在のランキングロジックそのまま）
      ranking(period: period)
    else
      # 一般ユーザー/未ログインが見る場合: ゲストを除外
      ranking(period: period).where.not(role: :guest)
    end
  }

  # 未読通知数を取得
  def unread_notifications_count
    notifications.unread.count
  end

  # ランキングOGP画像生成用の週間統計情報を取得
  def weekly_ranking_stats
    start_date = Date.current.beginning_of_week
    end_date = Date.current.end_of_week

    # 週間データ集計
    weekly_walks = walks.reload.where(walked_on: start_date..end_date)
    total_distance = weekly_walks.sum(:distance)
    total_steps = weekly_walks.sum(:steps)

    # 順位計算
    # 自分より距離が長いユーザーの数をカウント + 1 = 順位
    higher_rank_users_count = User.joins(:walks)
                                  .where(walks: { walked_on: start_date..end_date })
                                  .group("users.id")
                                  .having("SUM(walks.distance) > ?", total_distance)
                                  .pluck("users.id")
                                  .count

    rank = higher_rank_users_count + 1

    # 英語の序数を生成（ロケール設定に依存しないように自前で処理）
    suffix = case rank % 100
    when 11, 12, 13 then "th"
    else
               case rank % 10
               when 1 then "st"
               when 2 then "nd"
               when 3 then "rd"
               else "th"
               end
    end
    rank_with_ordinal = "#{rank}#{suffix}"

    # レベル計算
    level = StatsService.new(self).level

    {
      level: level,
      date: "#{start_date.strftime('%m/%d')} - #{end_date.strftime('%m/%d')}",
      label1: "RANK",
      value1: rank_with_ordinal,
      label2: "STEPS",
      value2: ActiveSupport::NumberHelper.number_to_delimited(total_steps),
      label3: "DISTANCE",
      value3: "#{total_distance.round(1)} km",
      period_key: "#{start_date.strftime('%Y%m%d')}_#{end_date.strftime('%Y%m%d')}"
    }
  end
end
</file>

</files>
