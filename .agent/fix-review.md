# ä¿®æ­£å†…å®¹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

## âœ… ä¿®æ­£å®Œäº†é …ç›®

### 1. ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚§ãƒƒã‚¯å¾©æ´» âœ“
- `User#google_token_status` ã« `return :valid if role == "admin"` ã‚’è¿½åŠ 
- ã“ã‚Œã«ã‚ˆã‚Šç®¡ç†è€…ã¯å¸¸ã«Google Fité€£æºãŒæœ‰åŠ¹ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹

### 2. GoogleFitService ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå¾©æ´» âœ“  
- `fetch_dummy_activities` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å¾©å…ƒ
- `initialize` ã§ç®¡ç†è€…ã®å ´åˆã¯APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—
- `fetch_activities` ã§ç®¡ç†è€…ã®å ´åˆã¯ `{ data: fetch_dummy_activities(...) }` ã‚’è¿”ã™

### 3. N+1å•é¡Œå¯¾ç­–ã®è¦‹ç›´ã— âœ“
- `User.ranking` ã‹ã‚‰ `with_attached_uploaded_avatar` ã‚’å‰Šé™¤
- GROUP BY ã¨ã®ç«¶åˆã‚’å›é¿
- N+1ã¯è¨±å®¹ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã¯æœ€å¤§100ä»¶ã€å®Ÿéš›ã¯ä¸Šä½10-20ä»¶ç¨‹åº¦ï¼‰
- å¿…è¦ã«å¿œã˜ã¦å°†æ¥çš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§å¯¾å¿œå¯èƒ½

## ğŸ” æ®‹ã‚Šã®æ¤œè¨¼é …ç›®

### A. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã®å‹•ä½œç¢ºèª
```ruby
ActiveRecord::Base.transaction do
  # ...
  if failed_dates.any?
    raise ActiveRecord::Rollback
  end
end
```

**æ¤œè¨¼çµæœ**: æ­£ã—ã„å®Ÿè£…
- `ActiveRecord::Rollback` ã¯ä¾‹å¤–ã‚’ã‚­ãƒ£ãƒƒãƒã•ã‚Œãšã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
- ãã®å¾Œã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚‚æ„å›³é€šã‚Šå‹•ä½œ

### B. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ç¶²ç¾…æ€§
```ruby
result = service.fetch_activities(start_date, end_date)

if result[:error]
  # ã‚¨ãƒ©ãƒ¼å‡¦ç†
end

activities = result[:data]
```

**æ½œåœ¨çš„ãªå•é¡Œ**: `result[:data]` ãŒ nil ã®å ´åˆ
- Google API ãŒç©ºã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ãŸå ´åˆã€`result[:data]` ã¯ `{}` (ç©ºãƒãƒƒã‚·ãƒ¥)
- `activities.each` ã¯å‹•ä½œã™ã‚‹ãŒã€å¿µã®ãŸã‚ `activities ||= {}` ã‚’è¿½åŠ ã™ã¹ãã‹ï¼Ÿ

**åˆ¤æ–­**: ä¸è¦
- `fetch_activities` ã®å®Ÿè£…ã§ã¯å¿…ãš `{ data: result }` ã‚’è¿”ã™
- `result` ã¯ `Hash.new` ã§åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æœ€æ‚ªã§ã‚‚ `{}` ãŒå…¥ã‚‹

### C. ç®¡ç†è€…åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã®ä¸€è²«æ€§
- Userãƒ¢ãƒ‡ãƒ«: `role == "admin"`  
- GoogleFitService: `@user.admin?`

**æ½œåœ¨çš„ãªå•é¡Œ**: enum ã®æ¯”è¼ƒæ–¹æ³•ãŒç•°ãªã‚‹
- `role == "admin"` ã¯æ–‡å­—åˆ—æ¯”è¼ƒ
- `admin?` ã¯ Rails ã® enum ãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰

**ä¿®æ­£ãŒå¿…è¦**: Userãƒ¢ãƒ‡ãƒ«ã‚‚ `admin?` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã¹ã

## ğŸ› ï¸ æœ€çµ‚ä¿®æ­£äº‹é …

1. User#google_token_status ã®ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯ã‚’ `admin?` ãƒ¡ã‚½ãƒƒãƒ‰ã«çµ±ä¸€
