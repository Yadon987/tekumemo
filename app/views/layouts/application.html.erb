<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= content_for?(:title) ? yield(:title) : "てくメモ" %></title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <!-- ページ固有のヘッダー要素（OGPタグなど） -->
  <%= yield :head %>

  <!-- PWA Manifest -->
  <link rel="manifest" href="<%= pwa_manifest_path %>" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="てくメモ" />
  <link rel="apple-touch-icon" href="/512x512.png" />
  <meta name="theme-color" content="#3b82f6" />

  <% unless Rails.env.test? %>
    <!-- DNS prefetch: Google Fonts のドメインに事前接続 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Noto Sans JP: 日本語Webフォント（ウェイト400,500,700） -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Material Symbols: Googleのアイコンフォント -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=block" rel="stylesheet">
  <% end %>

  <!-- Tailwind CSSビルド済みファイル -->
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>

  <!-- ダークモード初期化スクリプト（FOUC防止）←チラつきのこと -->
  <script>
    // ページ読み込み前にダークモードを設定（フラッシュ防止してくれる魔法の呪文）
    (function() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>

  <!-- Service Worker 登録 -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(registration => console.log('Service Worker registered'))
        .catch(error => console.log('Service Worker registration failed:', error));
    }
  </script>
</head>

<body class="min-h-screen bg-fixed bg-clay-bg dark:bg-gradient-to-b dark:from-slate-900 dark:via-slate-900 dark:to-indigo-950 font-display transition-colors duration-200" data-controller="scroll-hide">
  <!-- 背景装飾アニメーション（全ページ共通） -->
  <%= render 'shared/animated_background' %>


  <!-- PWAインストール促進バナー -->
  <div data-controller="pwa-install" class="fixed left-0 right-0 bottom-0 p-4 pointer-events-none" style="z-index: 9999;">
    <div data-pwa-install-target="banner" class="hidden translate-y-4 opacity-0 transition-all duration-300 pointer-events-auto max-w-2xl mx-auto">
      <div class="bg-gradient-to-r from-blue-500 to-cyan-400 dark:from-blue-600 dark:to-cyan-500 rounded-2xl shadow-2xl p-4 flex items-center gap-3">
        <!-- アイコン -->
        <div class="flex-shrink-0">
          <div class="w-12 h-12 bg-white dark:bg-white/10 rounded-xl flex items-center justify-center shadow-lg">
            <span class="material-symbols-outlined text-2xl text-blue-600 dark:text-cyan-300">install_mobile</span>
          </div>
        </div>

        <!-- メッセージ -->
        <div class="flex-1 text-white">
          <p class="font-bold text-sm sm:text-base">てくメモをインストール</p>
          <p class="text-xs sm:text-sm opacity-90">ホーム画面から簡単にアクセスできます</p>
        </div>

        <!-- インストールボタン -->
        <button type="button" data-action="click->pwa-install#install" class="flex-shrink-0 px-4 py-2 bg-white dark:bg-white/20 text-blue-600 dark:text-white font-bold text-sm rounded-full hover:bg-blue-50 dark:hover:bg-white/30 transition-colors shadow-md">
          追加
        </button>

        <!-- 閉じるボタン -->
        <button type="button" data-action="click->pwa-install#dismiss" class="flex-shrink-0 w-8 h-8 rounded-full hover:bg-white/20 transition-colors flex items-center justify-center">
          <span class="material-symbols-outlined text-white text-lg">close</span>
        </button>
      </div>
    </div>
  </div>

  <div class="flex flex-col min-h-screen">

    <!-- ===== フローティングヘッダー（モバイルファースト・レスポンシブ対応） ===== -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-white/60 dark:bg-slate-950/60 backdrop-blur-xl">
      <div class="grid grid-cols-3 items-center py-2 px-3 sm:py-4 sm:px-4 w-full max-w-2xl mx-auto">
        <!-- 左側：アイコン + ダークモードトグル -->
        <div class="flex justify-start items-center gap-3">
          <!-- アプリアイコン（ホームリンク） -->
          <%= link_to root_path, class: "hover:opacity-80 transition-opacity" do %>
            <div class="h-7 w-7 sm:h-10 sm:w-10 flex items-center justify-center bg-gradient-to-br from-sky-400 to-blue-500 rounded-xl sm:rounded-2xl shadow-md">
              <span class="material-symbols-outlined text-lg sm:text-2xl text-white drop-shadow-2xl text-shadow">footprint</span>
            </div>
          <% end %>

          <!-- Stimulusコントローラーでダークモード切り替えを制御 -->
          <div data-controller="dark-mode-toggle">
            <!-- トグルスイッチのボタン -->
            <button
              type="button"
              data-action="click->dark-mode-toggle#toggle"
              aria-label="ダークモード切り替え"
              class="relative flex items-center">

              <!-- トグルスイッチの背景（モバイル：小、PC：中） -->
              <div
                data-dark-mode-toggle-target="toggle"
                class="w-9 h-5 sm:w-11 sm:h-6 bg-gray-300 rounded-full shadow-inner transition-all duration-300 ease-in-out">

                <!-- スライダー（丸いつまみ・モバイル：小、PC：中） -->
                <div
                  data-dark-mode-toggle-target="slider"
                  class="absolute top-0.5 left-0.5 w-4 h-4 sm:w-5 sm:h-5 bg-white rounded-full shadow-md transition-transform duration-300 ease-in-out flex items-center justify-center translate-x-0">

                  <!-- 月のアイコン（ライトモード時・モバイル：小、PC：中） -->
                  <span
                    data-dark-mode-toggle-target="icon"
                    data-icon="moon"
                    class="material-symbols-outlined text-lg sm:text-2xl text-gray-700 transition-all duration-200 opacity-100 scale-100">
                    dark_mode
                  </span>

                  <!-- 太陽のアイコン（ダークモード時・モバイル：小、PC：中） -->
                  <span
                    data-dark-mode-toggle-target="icon"
                    data-icon="sun"
                    class="material-symbols-outlined text-[17px] sm:text-[22px] text-yellow-500 absolute transition-all duration-200 opacity-0 scale-0">
                    light_mode
                  </span>
                </div>
              </div>
            </button>
          </div>
        </div>

        <!-- 中央：ロゴテキスト（完全中央） -->
        <%= link_to root_path, class: "flex justify-center hover:opacity-80 transition-opacity" do %>
          <span class="text-xl sm:text-3xl font-bold bg-gradient-to-r from-sky-500 to-blue-600 dark:from-sky-400 dark:to-blue-500 bg-clip-text text-transparent whitespace-nowrap">
            てくメモ
          </span>
        <% end %>

        <!-- 右側：ログイン/ログアウトボタン（モバイル：小、PC：中） -->
        <div class="flex justify-end items-center">
          <% if user_signed_in? %>
            <!-- アバタードロップダウンメニュー（モバイル：小、PC：中） -->
            <div class="relative" data-controller="dropdown">
              <!-- アバターボタン -->
              <button
                type="button"
                data-dropdown-target="button"
                data-action="click->dropdown#toggle"
                class="rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 hover:scale-105">
                <%= user_avatar(current_user, classes: "w-8 h-8 sm:w-9 sm:h-9 text-sm border-2 border-gray-200 dark:border-gray-600") %>
              </button>

              <!-- ドロップダウンメニュー -->
              <div
                data-dropdown-target="menu"
                class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-xl shadow-xl py-1 border border-gray-100 dark:border-gray-700 transform origin-top-right transition-all duration-200 opacity-0 scale-95 z-50">

                <!-- ユーザー情報（簡易表示） -->
                <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700">
                  <p class="text-sm font-bold text-gray-900 dark:text-white truncate"><%= current_user.name %></p>
                  <p class="text-xs text-gray-500 dark:text-gray-400 truncate"><%= current_user.email %></p>
                </div>

                <!-- メニュー項目 -->
                <%= link_to edit_user_registration_path, class: "block px-4 py-2 text-sm text-gray-700 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center" do %>
                  <span class="material-symbols-outlined mr-2 text-lg">settings</span>
                  設定
                <% end %>

                <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>

                <%= link_to destroy_user_session_path,
                    method: :delete,
                    data: { turbo_method: :delete },
                    class: "block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center space-x-2 w-full text-left" do %>
                  <span class="material-symbols-outlined text-lg">logout</span>
                  <span>ログアウト</span>
                <% end %>
              </div>
            </div>
          <% else %>
            <!-- ログインボタン（青いグラデーション丸ボタン・モバイル：小、PC：中） -->
            <%= link_to new_user_session_path,
                aria_label: "ログイン",
                class: "w-8 h-8 sm:w-9 sm:h-9 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 dark:from-blue-500 dark:to-blue-700 flex items-center justify-center shadow-md hover:shadow-lg hover:scale-110 transition-all duration-300" do %>
              <span class="material-symbols-outlined text-lg sm:text-xl text-white drop-shadow-2xl text-shadow">login</span>
            <% end %>
          <% end %>
        </div>
      </div>
    </header>

    <!-- ===== メインコンテンツ ===== -->
    <!-- ヘッダー分のpadding-topを追加（モバイル：小、PC：大） -->
    <main class="flex-1 w-full pt-12 sm:pt-20">
      <!-- Flashメッセージ -->
      <!-- Flashメッセージ (Dynamic Island Style - God Mode Neon) -->
      <div id="flash_messages" class="fixed top-24 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col items-center gap-3 w-full max-w-lg pointer-events-none px-4">
        <% if notice.present? %>
          <div data-controller="flash" class="pointer-events-auto transform transition-all duration-500 ease-out origin-top">
            <!-- Success: 強力な青い発光影 -->
            <div class="flex items-center gap-3 py-3 px-5 pr-3 rounded-full backdrop-blur-xl bg-slate-900/95 border border-slate-700/50 dark:border-sky-500/50 ring-1 ring-black/20 shadow-2xl dark:shadow-[0_0_35px_rgba(14,165,233,0.6)]">
              <!-- Icon -->
              <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-sky-500/20 text-sky-400">
                <span class="material-symbols-outlined text-xl">check_circle</span>
              </div>
              <!-- Text -->
              <div class="flex-1 min-w-0 px-2 text-center sm:text-left">
                <p class="text-sm font-bold text-white hidden sm:block">Success</p>
                <p class="text-sm text-slate-200 truncate max-w-[200px] sm:max-w-xs"><%= notice %></p>
              </div>
              <!-- Close Button -->
              <button type="button" data-action="click->flash#dismiss" class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-800 text-slate-400 hover:text-white transition-colors ml-1">
                <span class="material-symbols-outlined text-lg">close</span>
              </button>
            </div>
          </div>
        <% end %>

        <% if alert.present? %>
          <div data-controller="flash" class="pointer-events-auto transform transition-all duration-500 ease-out origin-top">
            <!-- Alert: 強力な赤い発光影 -->
            <div class="flex items-center gap-3 py-3 px-5 pr-3 rounded-full backdrop-blur-xl bg-slate-900/95 border border-slate-700/50 dark:border-rose-500/50 ring-1 ring-black/20 shadow-2xl dark:shadow-[0_0_35px_rgba(244,63,94,0.6)]">
              <!-- Icon -->
              <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-rose-500/20 text-rose-400">
                <span class="material-symbols-outlined text-xl">error</span>
              </div>
              <!-- Text -->
              <div class="flex-1 min-w-0 px-2 text-center sm:text-left">
                <p class="text-sm font-bold text-white hidden sm:block">Alert</p>
                <p class="text-sm text-slate-200 truncate max-w-[200px] sm:max-w-xs"><%= alert %></p>
              </div>
              <!-- Close Button -->
              <button type="button" data-action="click->flash#dismiss" class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-800 text-slate-400 hover:text-white transition-colors ml-1">
                <span class="material-symbols-outlined text-lg">close</span>
              </button>
            </div>
          </div>
        <% end %>
      </div>

      <%= yield %>
      <%= yield :modals %>
    </main>

    <!-- ===== フッター ===== -->
    <footer class="w-full py-8 pb-24 sm:pb-8 bg-slate-50/50 dark:bg-slate-900/50 backdrop-blur-sm border-t border-slate-200 dark:border-slate-800">
      <div class="max-w-2xl mx-auto px-4 text-center">
        <div class="flex flex-wrap justify-center gap-x-6 gap-y-2 mb-4">
          <%= link_to "利用規約 & プライバシーポリシー", privacy_path, class: "text-slate-500 dark:text-slate-400 hover:text-blue-600 dark:hover:text-blue-400 text-xs sm:text-sm font-medium transition-colors" %>
          <!-- 必要に応じて他リンクを追加 -->
        </div>
        <p class="text-[10px] sm:text-xs text-slate-400 dark:text-slate-600">
          &copy; <%= Time.current.year %> TekuMemo. All rights reserved.
        </p>
      </div>
    </footer>

    <!-- ===== Expandable FAB（展開可能なFloating Action Button）（ログイン時のみ） ===== -->
    <% if user_signed_in? %>
      <div data-controller="expandable-fab">
        <!-- 背景オーバーレイ（FAB展開時に表示） -->
        <div
          data-expandable-fab-target="overlay"
          data-action="click->expandable-fab#close"
          class="hidden fixed inset-0 bg-black opacity-0 transition-opacity duration-200 z-30">
        </div>

        <!-- FABボタンコンテナ（メインコンテンツの幅に合わせて配置） -->
        <div class="fixed bottom-[65px] sm:bottom-24 left-0 right-0 z-40 pointer-events-none transition-all duration-300 transform translate-y-0 opacity-100" data-scroll-hide-target="element">
          <div class="max-w-2xl mx-auto px-4 relative h-0">
            <div class="absolute bottom-0 right-2 sm:right-6 pointer-events-auto">
              <!-- アクションボタン（展開時に表示されるボタン群） -->

              <!-- 管理者メニュー（管理者のみ表示、一番上） -->
              <% if current_user.admin? || current_user.guest? %>
                <%= link_to admin_root_path,
                    data: { expandable_fab_target: "actionButton" },
                    class: "hidden opacity-0 absolute bottom-[19rem] right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                    style: "transform: translateY(20px);" do %>
                  <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">管理者メニュー</span>
                  <div class="bg-orange-500 dark:bg-orange-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-orange-600 dark:hover:bg-orange-700 transition-colors">
                    <span class="material-symbols-outlined text-xl">admin_panel_settings</span>
                  </div>
                <% end %>
              <% end %>



              <!-- ログインスタンプ -->
              <%= link_to login_stamps_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-52 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">てくてくスタンプ</span>
                <div class="bg-purple-500 dark:bg-purple-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-purple-600 dark:hover:bg-purple-700 transition-colors">
                  <span class="material-symbols-outlined text-xl">calendar_month</span>
                </div>
              <% end %>

              <!-- 新しい散歩記録 -->
              <%= link_to new_walk_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-40 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">新しい散歩記録</span>
                <div class="bg-green-500 dark:bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-green-600 dark:hover:bg-green-700 transition-colors">
                  <span class="material-symbols-outlined text-xl">add_circle</span>
                </div>
              <% end %>

              <!-- SNS投稿 -->
              <%= link_to posts_path(open_modal: true),
                  data: { expandable_fab_target: "actionButton", turbo: false },
                  class: "hidden opacity-0 absolute bottom-28 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">SNS投稿</span>
                <div class="bg-pink-500 dark:bg-pink-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-pink-600 dark:hover:bg-pink-700 transition-colors">
                  <span class="material-symbols-outlined text-xl">edit_square</span>
                </div>
              <% end %>

              <!-- 設定 -->
              <%= link_to edit_user_registration_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-16 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">設定</span>
                <div class="bg-gray-500 dark:bg-gray-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-gray-600 dark:hover:bg-gray-700 transition-colors">
                  <span class="material-symbols-outlined text-xl">settings</span>
                </div>
              <% end %>

              <!-- メインFABボタン -->
              <button
                type="button"
                data-expandable-fab-target="mainButton"
                data-action="click->expandable-fab#toggle"
                class="bg-gradient-to-r from-orange-400 to-pink-500 dark:from-amber-600 dark:to-yellow-500 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:from-orange-500 hover:to-pink-600 dark:hover:from-amber-700 dark:hover:to-yellow-600 dark:shadow-[0_0_20px_rgba(245,158,11,0.5)] transition-all duration-300">
                <span class="material-symbols-outlined text-2xl drop-shadow-2xl text-shadow">add</span>
              </button>
            </div>
          </div>
        </div>
      </div>



      <!-- ===== ボトムナビゲーション（ログイン時のみ・モバイルファースト・レスポンシブ対応） ===== -->
      <nav class="fixed bottom-0 left-0 right-0 bg-white/60 dark:bg-slate-950/60 backdrop-blur-xl z-50 transition-all duration-300 transform translate-y-0 opacity-100" data-scroll-hide-target="element">
        <div class="flex justify-around items-center h-10 sm:h-16 max-w-2xl mx-auto divide-x divide-gray-300 dark:divide-gray-700">
          <!-- ホーム -->
          <%= link_to root_path,
              id: "nav-home",
              class: "relative flex items-center justify-center w-full #{current_page?(root_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(root_path) ? 'font-bold' : ''}">home</span>
          <% end %>

          <!-- 散歩 -->
          <%= link_to walks_path,
              id: "nav-walk",
              class: "relative flex items-center justify-center w-full #{current_page?(walks_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(walks_path) ? 'font-bold' : ''}">footprint</span>
          <% end %>

          <!-- 投稿 -->
          <%= link_to posts_path,
              id: "nav-post",
              class: "relative flex items-center justify-center w-full #{current_page?(posts_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(posts_path) ? 'font-bold' : ''}">groups</span>
          <% end %>

          <!-- 記録（統計） -->
          <%= link_to stats_path,
              id: "nav-stats",
              class: "relative flex items-center justify-center w-full #{current_page?(stats_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(stats_path) ? 'font-bold' : ''}">incomplete_circle</span>
          <% end %>

          <!-- ランキング -->
          <%= link_to rankings_path,
              id: "nav-rank",
              class: "relative flex items-center justify-center w-full #{current_page?(rankings_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(rankings_path) ? 'font-bold' : ''}">emoji_events</span>
          <% end %>
        </div>
      </nav>
    <% end %>
  </div>
</body>
</html>

