<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= content_for?(:title) ? yield(:title) : "てくメモ" %></title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <!-- DNS prefetch: Google Fonts のドメインに事前接続 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Noto Sans JP: 日本語Webフォント（ウェイト400,500,700） -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Material Symbols: Googleのアイコンフォント -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=block" rel="stylesheet">

  <!-- Tailwind CSSビルド済みファイル -->
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>

  <!-- ダークモード初期化スクリプト（FOUC防止）←チラつきのこと -->
  <script>
    // ページ読み込み前にダークモードを設定（フラッシュ防止してくれる魔法の呪文）
    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>
</head>

<body class="min-h-screen bg-fixed bg-gradient-to-b from-sky-50 to-slate-50 dark:bg-gradient-to-b dark:from-slate-900 dark:via-slate-900 dark:to-indigo-950 font-display transition-colors duration-200" data-controller="scroll-hide">
  <!-- 背景装飾アニメーション（全ページ共通） -->
  <%= render 'shared/background_animation' %>

  <div class="flex flex-col min-h-screen">

    <!-- ===== フローティングヘッダー（モバイルファースト・レスポンシブ対応） ===== -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-sky-50/70 dark:bg-slate-950/70 backdrop-blur-md border-b border-sky-100/50 dark:border-white/10">
      <div class="flex justify-between items-center py-2 px-3 sm:py-4 sm:px-4 w-full max-w-2xl mx-auto">
        <!-- 左側：ダークモード切り替えトグルスイッチ（モバイル：小、PC：中） -->
        <div class="w-16 sm:w-24 flex justify-start items-center">
          <!-- Stimulusコントローラーでダークモード切り替えを制御 -->
          <div data-controller="dark-mode-toggle">
            <!-- トグルスイッチのボタン -->
            <button
              type="button"
              data-action="click->dark-mode-toggle#toggle"
              aria-label="ダークモード切り替え"
              class="relative flex items-center">

              <!-- トグルスイッチの背景（モバイル：小、PC：中） -->
              <div
                data-dark-mode-toggle-target="toggle"
                class="w-9 h-5 sm:w-11 sm:h-6 bg-gray-300 rounded-full shadow-inner transition-all duration-300 ease-in-out">

                <!-- スライダー（丸いつまみ・モバイル：小、PC：中） -->
                <div
                  data-dark-mode-toggle-target="slider"
                  class="absolute top-0.5 left-0.5 w-4 h-4 sm:w-5 sm:h-5 bg-white rounded-full shadow-md transition-transform duration-300 ease-in-out flex items-center justify-center translate-x-0">

                  <!-- 月のアイコン（ライトモード時・モバイル：小、PC：中） -->
                  <span
                    data-dark-mode-toggle-target="icon"
                    data-icon="moon"
                    class="material-symbols-outlined text-lg sm:text-2xl text-gray-700 transition-all duration-200 opacity-100 scale-100">
                    dark_mode
                  </span>

                  <!-- 太陽のアイコン（ダークモード時・モバイル：小、PC：中） -->
                  <span
                    data-dark-mode-toggle-target="icon"
                    data-icon="sun"
                    class="material-symbols-outlined text-[17px] sm:text-[22px] text-yellow-500 absolute transition-all duration-200 opacity-0 scale-0">
                    light_mode
                  </span>
                </div>
              </div>
            </button>
          </div>
        </div>

        <!-- 中央：ロゴ（モバイル：小、PC：中） -->
        <!-- 中央：ロゴ（モバイル：小、PC：中） -->
        <%= link_to root_path, class: "flex items-center space-x-2 sm:space-x-3 hover:opacity-80 transition-opacity" do %>
          <!-- 左側のアイコン（モバイル：小、PC：中） -->
          <div class="h-7 w-7 sm:h-10 sm:w-10 flex items-center justify-center bg-gradient-to-br from-sky-400 to-blue-500 rounded-xl sm:rounded-2xl shadow-md">
            <span class="material-symbols-outlined text-lg sm:text-2xl text-white drop-shadow-2xl text-shadow">footprint</span>
          </div>

          <!-- グラデーションテキストロゴ（モバイル：小、PC：大） -->
          <span class="text-xl sm:text-3xl font-bold bg-gradient-to-r from-sky-500 to-blue-600 dark:from-sky-400 dark:to-blue-500 bg-clip-text text-transparent whitespace-nowrap">
            てくメモ
          </span>
        <% end %>

        <!-- 右側：ログイン/ログアウトボタン（モバイル：小、PC：中） -->
        <div class="w-14 sm:w-20 flex justify-end items-center">
          <% if user_signed_in? %>
            <!-- アバタードロップダウンメニュー（モバイル：小、PC：中） -->
            <div class="relative" data-controller="dropdown">
              <!-- アバターボタン -->
              <button
                type="button"
                data-dropdown-target="button"
                data-action="click->dropdown#toggle"
                class="rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-300 hover:scale-105">
                <%= user_avatar(current_user, classes: "w-8 h-8 sm:w-9 sm:h-9 text-sm border-2 border-gray-200 dark:border-gray-600") %>
              </button>

              <!-- ドロップダウンメニュー -->
              <div
                data-dropdown-target="menu"
                class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-xl shadow-xl py-1 border border-gray-100 dark:border-gray-700 transform origin-top-right transition-all duration-200 opacity-0 scale-95 z-50">

                <!-- ユーザー情報（簡易表示） -->
                <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700">
                  <p class="text-sm font-bold text-gray-900 dark:text-white truncate"><%= current_user.name %></p>
                  <p class="text-xs text-gray-500 dark:text-gray-400 truncate"><%= current_user.email %></p>
                </div>

                <!-- メニュー項目 -->
                <%= link_to edit_user_registration_path, class: "block px-4 py-2 text-sm text-gray-700 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700 flex items-center" do %>
                  <span class="material-symbols-outlined mr-2 text-lg">settings</span>
                  設定
                <% end %>

                <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>

                <%= link_to destroy_user_session_path,
                    method: :delete,
                    data: { turbo_method: :delete },
                    class: "block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center space-x-2 w-full text-left" do %>
                  <span class="material-symbols-outlined text-lg">logout</span>
                  <span>ログアウト</span>
                <% end %>
              </div>
            </div>
          <% else %>
            <!-- ログインボタン（青いグラデーション丸ボタン・モバイル：小、PC：中） -->
            <%= link_to new_user_session_path,
                aria_label: "ログイン",
                class: "w-8 h-8 sm:w-8 sm:h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 dark:from-blue-500 dark:to-blue-700 flex items-center justify-center shadow-md hover:shadow-lg hover:scale-110 transition-all duration-300" do %>
              <span class="material-symbols-outlined text-lg sm:text-2xl text-white drop-shadow-2xl text-shadow">login</span>
            <% end %>
          <% end %>
        </div>
      </div>
    </header>

    <!-- ===== メインコンテンツ ===== -->
    <!-- ヘッダー分のpadding-topを追加（モバイル：小、PC：大） -->
    <main class="flex-1 w-full pt-12 sm:pt-20">
      <!-- Flashメッセージ -->
      <div id="flash_messages">
        <% if notice.present? %>
          <div data-controller="flash" class="mx-auto max-w-2xl px-4 py-2">
            <div class="bg-blue-100 dark:bg-blue-900/30 border border-blue-400 dark:border-blue-600 text-blue-700 dark:text-blue-300 px-4 py-3 rounded-xl relative" role="alert">
              <span class="block sm:inline"><%= notice %></span>
            </div>
          </div>
        <% end %>

        <% if alert.present? %>
          <div data-controller="flash" class="mx-auto max-w-2xl px-4 py-2">
            <div class="bg-red-100 dark:bg-red-900/30 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-300 px-4 py-3 rounded-xl relative" role="alert">
              <span class="block sm:inline"><%= alert %></span>
            </div>
          </div>
        <% end %>
      </div>

      <%= yield %>
    </main>

    <!-- ===== Expandable FAB（展開可能なFloating Action Button）（ログイン時のみ） ===== -->
    <% if user_signed_in? %>
      <div data-controller="expandable-fab">
        <!-- 背景オーバーレイ（FAB展開時に表示） -->
        <div
          data-expandable-fab-target="overlay"
          data-action="click->expandable-fab#close"
          class="hidden fixed inset-0 bg-black opacity-0 transition-opacity duration-200 z-30">
        </div>

        <!-- FABボタンコンテナ（メインコンテンツの幅に合わせて配置） -->
        <div class="fixed bottom-[65px] sm:bottom-24 left-0 right-0 z-40 pointer-events-none transition-all duration-300 transform translate-y-0 opacity-100" data-scroll-hide-target="element">
          <div class="max-w-2xl mx-auto px-4 relative h-0">
            <div class="absolute bottom-0 right-2 sm:right-6 pointer-events-auto">
              <!-- アクションボタン（展開時に表示されるボタン群） -->

              <!-- ログインスタンプ -->
              <%= link_to login_stamps_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-52 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">てくてくスタンプ</span>
                <div class="bg-purple-500 dark:bg-purple-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-purple-600 dark:hover:bg-purple-700 transition-colors">
                  <span class="material-symbols-outlined text-xl">calendar_month</span>
                </div>
              <% end %>

              <!-- 新しい散歩記録 -->
              <%= link_to new_walk_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-40 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">新しい散歩記録</span>
                <div class="bg-green-500 dark:bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-green-600 dark:hover:bg-green-700 transition-colors">
                  <span class="material-symbols-outlined text-xl">add_circle</span>
                </div>
              <% end %>

              <!-- プライバシー＆利用規約 -->
              <%= link_to privacy_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-28 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">プライバシー＆利用規約</span>
                <div class="bg-blue-500 dark:bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors">
                  <span class="material-symbols-outlined text-xl">privacy_tip</span>
                </div>
              <% end %>

              <!-- 設定 -->
              <%= link_to edit_user_registration_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-16 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-xl shadow-md text-sm font-medium whitespace-nowrap">設定</span>
                <div class="bg-gray-500 dark:bg-gray-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-gray-600 dark:hover:bg-gray-700 transition-colors">
                  <span class="material-symbols-outlined text-xl">settings</span>
                </div>
              <% end %>

              <!-- メインFABボタン -->
              <button
                type="button"
                data-expandable-fab-target="mainButton"
                data-action="click->expandable-fab#toggle"
                class="bg-gradient-to-r from-orange-400 to-pink-500 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:from-orange-500 hover:to-pink-600 transition-all duration-300">
                <span class="material-symbols-outlined text-2xl drop-shadow-2xl text-shadow">add</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== ボトムナビゲーション（ログイン時のみ・モバイルファースト・レスポンシブ対応） ===== -->
      <nav class="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-slate-950/80 backdrop-blur-md border-t border-gray-100 dark:border-indigo-500/30 dark:shadow-[0_0_15px_rgba(99,102,241,0.15)] shadow-[0_-1px_3px_0_rgba(0,0,0,0.02)] z-50 transition-all duration-300 transform translate-y-0 opacity-100" data-scroll-hide-target="element">
        <div class="flex justify-around items-center h-10 sm:h-16 max-w-2xl mx-auto">
          <!-- ホーム -->
          <%= link_to root_path,
              class: "relative flex items-center justify-center w-full #{current_page?(root_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors after:content-[''] after:absolute after:right-0 after:top-1/2 after:-translate-y-1/2 after:w-px after:h-4 sm:after:h-6 after:bg-gray-400 dark:after:bg-gray-600" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(root_path) ? 'font-bold' : ''}">home</span>
          <% end %>

          <!-- 散歩 -->
          <%= link_to walks_path,
              class: "relative flex items-center justify-center w-full #{current_page?(walks_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors after:content-[''] after:absolute after:right-0 after:top-1/2 after:-translate-y-1/2 after:w-px after:h-4 sm:after:h-6 after:bg-gray-400 dark:after:bg-gray-600" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(walks_path) ? 'font-bold' : ''}">footprint</span>
          <% end %>

          <!-- 投稿 -->
          <%= link_to posts_path,
              class: "relative flex items-center justify-center w-full #{current_page?(posts_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors after:content-[''] after:absolute after:right-0 after:top-1/2 after:-translate-y-1/2 after:w-px after:h-4 sm:after:h-6 after:bg-gray-400 dark:after:bg-gray-600" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(posts_path) ? 'font-bold' : ''}">groups</span>
          <% end %>

          <!-- 記録（統計） -->
          <%= link_to stats_path,
              class: "relative flex items-center justify-center w-full #{current_page?(stats_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors after:content-[''] after:absolute after:right-0 after:top-1/2 after:-translate-y-1/2 after:w-px after:h-4 sm:after:h-6 after:bg-gray-400 dark:after:bg-gray-600" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(stats_path) ? 'font-bold' : ''}">incomplete_circle</span>
          <% end %>

          <!-- ランキング -->
          <%= link_to rankings_path,
              class: "relative flex items-center justify-center w-full #{current_page?(rankings_path) ? 'text-blue-500 dark:text-blue-400' : 'text-gray-400 dark:text-gray-500'} hover:text-blue-600 dark:hover:text-blue-200 transition-colors" do %>
            <span class="material-symbols-outlined text-lg sm:text-2xl #{current_page?(rankings_path) ? 'font-bold' : ''}">emoji_events</span>
          <% end %>
        </div>
      </nav>
    <% end %>
  </div>
</body>
</html>

