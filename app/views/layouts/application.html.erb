<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= content_for?(:title) ? yield(:title) : "てくメモ" %></title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>

  <!-- Tailwind CSSビルド済みファイル -->
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>

  <!-- Google Fonts: Noto Sans JP -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />

  <!-- Google Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

  <!-- ダークモード初期化スクリプト（FOUC防止） -->
  <script>
    // ページ読み込み前にダークモードを設定（フラッシュ防止）
    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display transition-colors duration-200">
  <div class="flex flex-col min-h-screen">

    <!-- ===== フローティングヘッダー（スクロール時も固定表示・15%縮小版） ===== -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-background-light dark:bg-background-dark border-b border-gray-200 dark:border-gray-700">
      <div class="flex justify-between items-center py-3 px-4 w-full max-w-4xl mx-auto">
        <!-- 左側：ダークモード切り替えトグルスイッチ（iOS風・小型化） -->
        <div class="w-20 flex justify-start items-center">
          <!-- Stimulusコントローラーでダークモード切り替えを制御 -->
          <div data-controller="dark-mode-toggle">
            <!-- トグルスイッチのボタン -->
            <button
              type="button"
              data-action="click->dark-mode-toggle#toggle"
              aria-label="ダークモード切り替え"
              class="relative flex items-center">

              <!-- トグルスイッチの背景（20%以上縮小：w-14→w-11, h-8→h-6） -->
              <div
                data-dark-mode-toggle-target="toggle"
                class="w-11 h-6 bg-gray-300 rounded-full shadow-inner transition-all duration-300 ease-in-out">

                <!-- スライダー（丸いつまみ・縮小：w-6→w-5, h-6→h-5） -->
                <div
                  data-dark-mode-toggle-target="slider"
                  class="absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow-md transition-transform duration-300 ease-in-out flex items-center justify-center"
                  style="transform: translateX(0);">

                  <!-- 月のアイコン（ライトモード時・サイズ縮小：text-sm→text-xs） -->
                  <span
                    data-dark-mode-toggle-target="icon"
                    data-icon="moon"
                    class="material-symbols-outlined text-xs text-gray-700 transition-all duration-200 opacity-100 scale-100">
                    dark_mode
                  </span>

                  <!-- 太陽のアイコン（ダークモード時・サイズ縮小：text-sm→text-xs） -->
                  <span
                    data-dark-mode-toggle-target="icon"
                    data-icon="sun"
                    class="material-symbols-outlined text-xs text-yellow-500 absolute transition-all duration-200 opacity-0 scale-0">
                    light_mode
                  </span>
                </div>
              </div>
            </button>
          </div>
        </div>

        <!-- 中央：ロゴ -->
        <div class="flex items-center space-x-3">
          <!-- 左側のアイコン（20%縮小：h-12 w-12→h-10 w-10, text-3xl→text-2xl） -->
          <div class="h-10 w-10 flex items-center justify-center bg-gradient-to-br from-sky-400 to-blue-500 rounded-xl shadow-md">
            <span class="material-symbols-outlined text-2xl text-white">footprint</span>
          </div>

          <!-- グラデーションテキストロゴ（改行防止） -->
          <span class="text-3xl font-bold bg-gradient-to-r from-sky-500 to-blue-600 dark:from-sky-400 dark:to-blue-500 bg-clip-text text-transparent whitespace-nowrap">
            てくメモ
          </span>
        </div>

        <!-- 右側：ログイン/ログアウトボタン（iOS風グラデーション丸ボタン） -->
        <div class="w-20 flex justify-end items-center">
          <% if user_signed_in? %>
            <!-- ログアウトボタン（赤いグラデーション丸ボタン） -->
            <%= link_to destroy_user_session_path,
                method: :delete,
                data: { turbo_method: :delete, turbo_confirm: "ログアウトしますか?" },
                aria_label: "ログアウト",
                class: "w-10 h-10 rounded-full bg-gradient-to-br from-red-400 to-red-600 dark:from-red-500 dark:to-red-700 flex items-center justify-center shadow-md hover:shadow-lg hover:scale-110 transition-all duration-300" do %>
              <span class="material-symbols-outlined text-xl text-white">logout</span>
            <% end %>
          <% else %>
            <!-- ログインボタン（青いグラデーション丸ボタン） -->
            <%= link_to new_user_session_path,
                aria_label: "ログイン",
                class: "w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 dark:from-blue-500 dark:to-blue-700 flex items-center justify-center shadow-md hover:shadow-lg hover:scale-110 transition-all duration-300" do %>
              <span class="material-symbols-outlined text-xl text-white">login</span>
            <% end %>
          <% end %>
        </div>
      </div>
    </header>

    <!-- ===== メインコンテンツ ===== -->
    <!-- ヘッダー分のpadding-topを追加（ヘッダー縮小に合わせて調整） -->
    <main class="flex-1 w-full pt-16">
      <!-- Flashメッセージ -->
      <% if notice.present? %>
        <div class="mx-auto max-w-4xl px-4 py-2">
          <div class="bg-blue-100 dark:bg-blue-900/30 border border-blue-400 dark:border-blue-600 text-blue-700 dark:text-blue-300 px-4 py-3 rounded relative" role="alert">
            <span class="block sm:inline"><%= notice %></span>
          </div>
        </div>
      <% end %>

      <% if alert.present? %>
        <div class="mx-auto max-w-4xl px-4 py-2">
          <div class="bg-red-100 dark:bg-red-900/30 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-300 px-4 py-3 rounded relative" role="alert">
            <span class="block sm:inline"><%= alert %></span>
          </div>
        </div>
      <% end %>

      <%= yield %>
    </main>

    <!-- ===== Expandable FAB（展開可能なFloating Action Button）（ログイン時のみ） ===== -->
    <% if user_signed_in? %>
      <div data-controller="expandable-fab">
        <!-- 背景オーバーレイ（FAB展開時に表示） -->
        <div
          data-expandable-fab-target="overlay"
          data-action="click->expandable-fab#close"
          class="hidden fixed inset-0 bg-black opacity-0 transition-opacity duration-200 z-30">
        </div>

        <!-- FABボタンコンテナ（メインコンテンツの幅に合わせて配置） -->
        <div class="fixed bottom-24 left-0 right-0 z-40 pointer-events-none">
          <div class="max-w-4xl mx-auto px-4 relative h-0">
            <div class="absolute bottom-0 right-5 pointer-events-auto">
              <!-- アクションボタン（展開時に表示されるボタン群） -->
              <!-- プライバシー -->
              <%= link_to "#",
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-72 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-lg shadow-md text-sm font-medium whitespace-nowrap">プライバシー</span>
                <div class="bg-blue-500 dark:bg-blue-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:bg-blue-600 dark:hover:bg-blue-700 transition-colors">
                  <span class="material-symbols-outlined text-2xl">privacy_tip</span>
                </div>
              <% end %>

              <!-- 設定 -->
              <%= link_to edit_user_registration_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-56 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-lg shadow-md text-sm font-medium whitespace-nowrap">設定</span>
                <div class="bg-gray-500 dark:bg-gray-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:bg-gray-600 dark:hover:bg-gray-700 transition-colors">
                  <span class="material-symbols-outlined text-2xl">settings</span>
                </div>
              <% end %>

              <!-- ログインスタンプ -->
              <%= link_to login_stamps_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-40 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-lg shadow-md text-sm font-medium whitespace-nowrap">ログインスタンプ</span>
                <div class="bg-purple-500 dark:bg-purple-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:bg-purple-600 dark:hover:bg-purple-700 transition-colors">
                  <span class="material-symbols-outlined text-2xl">calendar_month</span>
                </div>
              <% end %>

              <!-- 新しい散歩記録 -->
              <%= link_to new_walk_path,
                  data: { expandable_fab_target: "actionButton" },
                  class: "hidden opacity-0 absolute bottom-24 right-0 flex items-center space-x-3 transition-all duration-200 transform translate-y-5",
                  style: "transform: translateY(20px);" do %>
                <span class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-lg shadow-md text-sm font-medium whitespace-nowrap">新しい散歩記録</span>
                <div class="bg-green-500 dark:bg-green-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:bg-green-600 dark:hover:bg-green-700 transition-colors">
                  <span class="material-symbols-outlined text-2xl">add_circle</span>
                </div>
              <% end %>

              <!-- メインFABボタン -->
              <button
                type="button"
                data-expandable-fab-target="mainButton"
                data-action="click->expandable-fab#toggle"
                class="bg-sky-500 dark:bg-sky-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:bg-sky-600 dark:hover:bg-sky-700 transition-all duration-300">
                <span class="material-symbols-outlined text-3xl">add</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== ボトムナビゲーション（ログイン時のみ） ===== -->
      <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-100 dark:border-gray-700/50 shadow-[0_-1px_3px_0_rgba(0,0,0,0.02)] z-50">
        <div class="flex justify-around items-center h-16 max-w-4xl mx-auto">
          <!-- ホーム -->
          <%= link_to root_path,
              class: "relative flex flex-col items-center justify-center w-full text-blue-400 dark:text-blue-300 hover:text-blue-600 dark:hover:text-blue-200 transition-colors after:content-[''] after:absolute after:right-0 after:top-1/2 after:-translate-y-1/2 after:w-px after:h-6 after:bg-gray-400 dark:after:bg-gray-600" do %>
            <span class="material-symbols-outlined text-2xl">home</span>
            <span class="text-[10px] mt-0.5">ホーム</span>
          <% end %>

          <!-- 散歩 -->
          <%= link_to walks_path,
              class: "relative flex flex-col items-center justify-center w-full text-gray-400 dark:text-gray-500 hover:text-blue-600 dark:hover:text-blue-200 transition-colors after:content-[''] after:absolute after:right-0 after:top-1/2 after:-translate-y-1/2 after:w-px after:h-6 after:bg-gray-400 dark:after:bg-gray-600" do %>
            <span class="material-symbols-outlined text-2xl">footprint</span>
            <span class="text-[10px] mt-0.5">散歩</span>
          <% end %>

          <!-- 投稿 -->
          <%= link_to "#",
              class: "relative flex flex-col items-center justify-center w-full text-gray-400 dark:text-gray-500 hover:text-blue-600 dark:hover:text-blue-200 transition-colors after:content-[''] after:absolute after:right-0 after:top-1/2 after:-translate-y-1/2 after:w-px after:h-6 after:bg-gray-400 dark:after:bg-gray-600" do %>
            <span class="material-symbols-outlined text-2xl">groups</span>
            <span class="text-[10px] mt-0.5">投稿</span>
          <% end %>

          <!-- 記録 -->
          <%= link_to "#",
              class: "relative flex flex-col items-center justify-center w-full text-gray-400 dark:text-gray-500 hover:text-blue-600 dark:hover:text-blue-200 transition-colors after:content-[''] after:absolute after:right-0 after:top-1/2 after:-translate-y-1/2 after:w-px after:h-6 after:bg-gray-400 dark:after:bg-gray-600" do %>
            <span class="material-symbols-outlined text-2xl">bar_chart</span>
            <span class="text-[10px] mt-0.5">記録</span>
          <% end %>

          <!-- ランキング -->
          <%= link_to "#",
              class: "flex flex-col items-center justify-center w-full text-gray-400 dark:text-gray-500 hover:text-blue-600 dark:hover:text-blue-200 transition-colors" do %>
            <span class="material-symbols-outlined text-2xl">emoji_events</span>
            <span class="text-[10px] mt-0.5">ランキング</span>
          <% end %>
        </div>
      </nav>
    <% end %>
  </div>
</body>
</html>
