<!-- app/views/rankings/index.html.erb -->
<% content_for :head do %>
  <meta property="og:url" content="<%= request.original_url %>" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="今週のランキング結果 - てくメモ" />
  <%
    # シェアURLに含まれるuser_idを優先、なければログインユーザー
    ogp_user = params[:user_id].present? ? User.find_by(id: params[:user_id]) : current_user

    description = if ogp_user
                    "#{ogp_user.name}さんの今週のランキング結果をチェック！"
                  else
                    "てくメモで楽しくウォーキング習慣を身につけよう！"
                  end
  %>
  <meta property="og:description" content="<%= description %>" />
  <% if ogp_user %>
    <%
      # OGP画像URL（.jpg拡張子を明示的に含める）
      ogp_image_url = ogp_image_rankings_user_url(ogp_user, protocol: 'https') + ".jpg?v=#{Time.current.to_i}"
    %>
    <meta property="og:image" content="<%= ogp_image_url %>" />
    <meta name="twitter:image" content="<%= ogp_image_url %>" />
  <% else %>
    <meta property="og:image" content="<%= image_url('icon.png') %>" />
    <meta name="twitter:image" content="<%= image_url('icon.png') %>" />
  <% end %>
  <meta name="twitter:card" content="summary_large_image" />
<% end %>






<%# ランキング画面のダークモードでは、共通の背景アニメーション（パルス）が独自背景と干渉するため非表示にする %>
<style>
  html.dark body > .fixed.-z-10 {
    display: none !important;
  }
  /* ヘッダーの境界線を消す */
  html.dark header {
    border-bottom-color: transparent !important;
  }
</style>

<!-- Deep Void Background (Dark Mode Only) -->
<div class="fixed inset-0 -z-10 hidden dark:block bg-[#020617] bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-[#1a0b2e] via-[#020617] to-[#000000]"></div>

<div class="pb-20 relative overflow-hidden" data-controller="ogp-preview">

  <!-- ヘッダーエリア（PC用のみ表示） -->
  <div class="hidden md:block relative z-10 pt-8 pb-6 px-4 text-center">
    <div class="inline-block relative">
      <h1 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 via-pink-500 to-orange-500 dark:from-fuchsia-300 dark:via-purple-300 dark:to-violet-300 tracking-tight drop-shadow-sm dark:drop-shadow-[0_0_15px_rgba(168,85,247,0.5)]">
        <%= t('rankings.index.title') %>
      </h1>
      <div class="absolute -top-6 -right-8 text-4xl animate-bounce">🏆</div>
      <div class="absolute -bottom-2 -left-6 text-3xl animate-spin-slow">✨</div>
    </div>
    <p class="text-slate-600 dark:text-purple-200/80 text-sm mt-3 font-bold tracking-wide"><%= t('rankings.index.subtitle') %></p>

    <!-- リアルタイム更新インジケーター -->
    <div class="mt-4 flex flex-col items-center justify-center gap-1 text-xs text-slate-500 dark:text-purple-300/70">
      <div class="flex items-center gap-2">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75 dark:bg-emerald-400"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500 dark:bg-emerald-500 dark:shadow-[0_0_8px_rgba(16,185,129,0.8)]"></span>
        </span>
        <span><%= period_label_ja(@period) %><%= t('rankings.index.list_title') %></span>
      </div>
      <div class="text-slate-400 dark:text-purple-400/60 text-xs">
        <% if @last_data_updated_at && @next_cache_update_at %>
          <span class="inline-block">
            最終集計: <%= @last_data_updated_at.strftime('%m/%d %H:%M') %>
            <span class="mx-1 opacity-50">|</span>
            次回目安: <%= @next_cache_update_at.strftime('%m/%d %H:%M') %>
          </span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- 期間切り替えタブ（レスポンシブマージン） -->
  <div class="px-6 mt-6 md:mt-0 mb-6 md:mb-8 relative z-10">
    <div class="bg-[#fdfbf7] dark:bg-slate-900/40 dark:backdrop-blur-xl p-1.5 rounded-full shadow-[inset_6px_6px_12px_rgba(166,175,195,0.2),inset_-6px_-6px_12px_rgba(255,255,255,0.8)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.1),0_0_20px_rgba(0,0,0,0.5)] border border-white/50 dark:border-white/10 flex justify-between items-center max-w-md mx-auto relative overflow-hidden">
      <% [
        { id: 'weekly', label: t('rankings.index.tabs.weekly'), icon: '🗓️' },
        { id: 'monthly', label: t('rankings.index.tabs.monthly'), icon: '📊' },
        { id: 'yearly', label: t('rankings.index.tabs.yearly'), icon: '🌟' }
      ].each do |tab| %>
        <%= link_to rankings_path(period: tab[:id]),
            data: { turbo_frame: "_top" },
            class: "flex-1 text-center py-2 px-3 rounded-full text-xs font-bold transition-all duration-300 relative overflow-hidden group #{
              @period == tab[:id] ?
              'text-purple-700 dark:text-white bg-white dark:bg-white/10 shadow-[4px_4px_8px_rgba(166,175,195,0.2),-4px_-4px_8px_rgba(255,255,255,0.9)] dark:shadow-[0_0_15px_rgba(255,255,255,0.1)] dark:border dark:border-white/10' :
              'text-slate-400 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 hover:-translate-y-0.5 dark:hover:bg-white/5'
            }" do %>
          <span class="relative z-10 flex items-center justify-center gap-1">
            <span class="text-base"><%= tab[:icon] %></span>
            <%= tab[:label] %>
          </span>
          <% if @period == tab[:id] %>
            <!-- Active Tab Glass Effect -->
            <div class="absolute inset-0 bg-gradient-to-b from-white/20 to-transparent opacity-50 pointer-events-none"></div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- 自分のスコアカード -->
  <div class="px-4 mb-8 sticky top-4 z-20 max-w-2xl mx-auto w-full">
    <% if @my_rank %>
      <div class="relative group">
        <!-- ダークモード用グロー (Breathing Glow) -->
        <div class="hidden dark:block absolute -inset-4 bg-purple-500/20 rounded-[3.75rem] blur-3xl animate-pulse-slow pointer-events-none"></div>

        <!-- God Mode Glass Card (Dark) / Crystal Clay Card (Light) -->
        <div class="relative bg-gradient-to-br from-white/90 via-white/60 to-white/30 dark:bg-none dark:bg-slate-900/40 rounded-[3.75rem] p-6 border border-white/60 dark:border-white/10 dark:border-t-white/40 shadow-[20px_20px_60px_rgba(168,85,247,0.15),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(168,85,247,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(168,85,247,0.3)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_30px_rgba(168,85,247,0.15)] backdrop-blur-xl overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse hover:scale-105 hover:dark:scale-100 hover:dark:border-purple-500/50 hover:dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.5),0_0_60px_rgba(168,85,247,0.4)] transition-all duration-300">

          <!-- Crystal Orbs (Light Mode Only) -->
          <div class="absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br from-purple-400/20 to-pink-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>
          <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-gradient-to-br from-blue-400/20 to-cyan-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

          <div class="flex items-center justify-between relative z-10">
            <div class="flex items-center gap-4">
              <div class="relative">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br <%= @my_rank <= 3 ? 'from-yellow-300 to-orange-400 dark:from-amber-300 dark:to-orange-500' : 'from-purple-400 to-pink-400 dark:from-fuchsia-400 dark:to-violet-600' %> flex flex-col items-center justify-center shadow-[inset_-2px_-2px_5px_rgba(255,255,255,0.7),inset_2px_2px_5px_rgba(0,0,0,0.1)] dark:shadow-[0_0_15px_rgba(255,255,255,0.3)] transform group-hover:scale-110 transition-transform leading-none">
                  <span class="text-3xl font-black text-white drop-shadow-md"><%= @my_rank %></span>
                  <span class="text-[10px] font-bold text-white/90 uppercase"><%= ordinal_suffix(@my_rank) %></span>
                </div>
                <% if @my_rank <= 3 %>
                  <div class="absolute -top-2 -right-2 text-2xl animate-bounce">👑</div>
                <% end %>
              </div>

              <div>
                <p class="text-xs text-purple-400 dark:text-fuchsia-300 font-bold uppercase tracking-wider mb-1"><%= t('rankings.index.your_rank.title') %></p>
                <p class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 dark:from-fuchsia-300 dark:to-violet-300">
                  <%= @my_rank %> <span class="text-sm"><%= t('rankings.index.your_rank.rank_suffix') %></span>
                </p>
                <% if @my_rank <= 10 %>
                  <p class="text-[10px] text-green-600 dark:text-emerald-400 font-bold mt-1">🔥 <%= t('rankings.index.your_rank.top_10') %></p>
                <% end %>
              </div>
            </div>

            <div class="text-right">
              <p class="text-xs text-purple-400 dark:text-fuchsia-300 font-bold uppercase tracking-wider mb-1"><%= t('rankings.index.your_rank.distance') %></p>
              <p class="text-3xl font-black text-slate-700 dark:text-white dark:drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">
                <%= number_with_precision(@my_distance, precision: 1) %>
              </p>
              <p class="text-xs text-slate-500 dark:text-slate-400"><%= t('rankings.index.your_rank.unit') %></p>

              <% if @distance_to_top > 0 %>
                <p class="text-[10px] text-orange-500 dark:text-amber-400 mt-2 font-bold">
                  🎯 <%= t('rankings.index.your_rank.distance_to_top') %>: <%= number_with_precision(@distance_to_top * 1000, precision: 0) %>m
                </p>
              <% end %>
            </div>
          </div>

          <!-- プログレスバー -->
          <% if @my_rank && @my_rank > 1 %>
            <% next_rank_distance = @rankings[@my_rank - 2]&.total_distance.to_f %>
            <% distance_needed = next_rank_distance - @my_distance %>
            <% if distance_needed > 0 %>
              <div class="mt-4 pt-4 border-t border-purple-100 dark:border-white/10 relative z-10">
                <div class="flex justify-between text-xs text-slate-500 dark:text-slate-300 mb-2">
                  <span><%= t('rankings.index.your_rank.distance_to_next') %></span>
                  <span class="font-bold text-orange-600 dark:text-amber-400"><%= number_with_precision(distance_needed * 1000, precision: 0) %>m</span>
                </div>
                <div class="h-3 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden shadow-inner dark:shadow-none">
                  <div class="h-full bg-gradient-to-r from-purple-400 to-pink-400 dark:from-fuchsia-500 dark:to-violet-500 rounded-full transition-all duration-500 dark:shadow-[0_0_10px_rgba(168,85,247,0.5)] relative overflow-hidden"
                       style="width: <%= [(@my_distance / next_rank_distance * 100), 100].min %>%">
                       <!-- Shimmer Effect -->
                       <div class="absolute inset-0 animate-shimmer bg-gradient-to-r from-transparent via-white/30 to-transparent -skew-x-12"></div>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>

          <!-- Xでシェアボタン -->
          <div class="mt-5 relative z-10">
            <%= link_to share_ranking_on_twitter_url(user: current_user, rank: @my_rank, distance: @my_distance * 1000, period: @period),
                target: "_blank",
                rel: "noopener noreferrer",
                class: "w-full md:w-auto md:px-10 md:min-w-[200px] mx-auto flex items-center justify-center gap-2 px-4 py-2.5 rounded-full bg-black dark:bg-[#000000] text-white dark:text-white text-sm font-bold hover:bg-gray-800 dark:hover:bg-[#111111] transition transform active:scale-95 shadow-md dark:shadow-[0_0_15px_rgba(255,255,255,0.1)] dark:border dark:border-white/20" do %>
              <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
              ランキングをシェア
            <% end %>
          </div>

          <!-- シェア画像プレビューリンク（小） -->
          <div class="mt-3 text-center relative z-10">
            <button data-action="click->ogp-preview#open" class="text-xs text-slate-500 dark:text-slate-400 hover:text-purple-600 dark:hover:text-fuchsia-300 underline transition">
              📷 シェア画像を確認
            </button>
          </div>
        </div>
      </div>
    <% elsif user_signed_in? %>
      <!-- ランキング外（ログイン済み） -->
      <div class="relative group">
        <div class="hidden dark:block absolute -inset-1 bg-gradient-to-r from-orange-600 to-red-600 rounded-[2rem] blur-lg opacity-50 group-hover:opacity-75 transition animate-pulse-slow"></div>

        <div class="relative bg-gradient-to-br from-orange-50/90 via-orange-50/60 to-orange-50/30 dark:bg-none dark:bg-slate-900/40 rounded-[3.75rem] p-4 border-2 border-white/60 dark:border-white/10 dark:border-t-white/40 shadow-[20px_20px_60px_rgba(249,115,22,0.15),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(249,115,22,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(249,115,22,0.3)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_30px_rgba(249,115,22,0.15)] overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">

          <!-- Crystal Orbs (Light Mode Only) -->
          <div class="absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br from-orange-400/20 to-red-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

          <div class="flex items-center gap-3 relative z-10">
            <div class="text-3xl animate-bounce">🔥</div>
            <div class="flex-1">
              <p class="text-base font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-500 dark:from-orange-300 dark:to-red-300 mb-0.5">
                <%= t('rankings.index.empty.challenge') %>
              </p>
              <p class="text-xs text-slate-600 dark:text-slate-300">
                <%= period_label_ja(@period) %>: <span class="font-bold text-slate-800 dark:text-white"><%= number_with_precision(@my_distance, precision: 1) %>km</span>
              </p>
              <p class="text-[10px] text-orange-500 dark:text-orange-400 mt-1">💪 <%= t('rankings.index.empty.cheer') %></p>
            </div>
            <div class="text-2xl">⚡</div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- 表彰台（トップ3専用エリア） -->
  <% if @rankings.present? %>
    <div class="px-4 mb-8 max-w-2xl mx-auto">
      <h2 class="text-center text-xl font-black text-slate-700 dark:text-white mb-6 flex items-center justify-center gap-2 dark:drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]">
        <span>🏆</span> <%= t('rankings.index.podium') %> <span>🏆</span>
      </h2>

      <div class="flex items-end justify-center gap-4 sm:gap-6 md:gap-12 mb-8 w-full max-w-lg mx-auto">
        <!-- 2位 (Silver) -->
        <div class="flex-1 min-w-0 text-center transform hover:scale-105 transition-transform duration-300 <%= 'opacity-0' unless @rankings[1] %>">
          <% if second = @rankings[1] %>
            <div class="relative inline-block mb-2">
              <%= user_avatar(second,
                  classes: "relative w-10 h-10 md:w-16 md:h-16 border-2 md:border-4 border-slate-200/80 dark:border-slate-200 shadow-[4px_4px_8px_rgba(148,163,184,0.4),-4px_-4px_8px_rgba(255,255,255,0.8)] dark:shadow-[0_0_20px_rgba(226,232,240,0.5)] z-10 text-lg md:text-2xl",
                  default_color_classes: "bg-gradient-to-br from-slate-400 to-slate-500 text-white") %>
              <div class="absolute -bottom-2 -right-2 text-xl md:text-3xl drop-shadow-md z-20">🥈</div>
            </div>
            <p class="text-slate-700 dark:text-slate-100 font-bold text-[10px] md:text-sm truncate px-1 dark:drop-shadow-[0_0_5px_rgba(0,0,0,0.8)]"><%= second.name.presence || "No Name" %></p>
            <p class="text-slate-500 dark:text-slate-300 text-[10px] md:text-xs font-bold"><%= number_with_precision(second.total_distance, precision: 1) %>km</p>

            <!-- Silver Podium Bar (Crystal Pillar) -->
            <div class="mt-2 h-24 md:h-40 w-[90%] mx-auto bg-gradient-to-b from-slate-200/90 via-slate-300/80 to-slate-400/90 dark:from-slate-400 dark:via-slate-300 dark:to-white rounded-t-[2rem] md:rounded-t-[3rem] border-4 border-white/80 dark:border-slate-300 dark:border-t-white shadow-[inset_0_5px_10px_rgba(255,255,255,0.6),inset_0_-10px_20px_rgba(148,163,184,0.3),5px_5px_15px_rgba(148,163,184,0.2),-2px_-2px_10px_rgba(255,255,255,0.5)] dark:shadow-[0_0_30px_rgba(148,163,184,0.4),inset_0_0_20px_rgba(255,255,255,0.3)] flex items-start justify-center pt-3 md:pt-5 relative overflow-hidden group-hover:dark:shadow-[0_0_50px_rgba(148,163,184,0.6)] transition-all backdrop-blur-sm">
               <!-- Liquid/Glass Shine -->
               <div class="absolute top-2 left-1/2 -translate-x-1/2 w-[60%] h-3 bg-white/60 rounded-full blur-[2px] dark:hidden"></div>
               <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/40 to-transparent opacity-50 pointer-events-none"></div>
              <span class="text-2xl md:text-4xl font-black text-slate-400/50 dark:text-slate-800 drop-shadow-sm dark:drop-shadow-none">2</span>
            </div>
          <% end %>
        </div>

        <!-- 1位 (Gold) -->
        <div class="flex-1 min-w-0 text-center transform hover:scale-110 transition-transform duration-300 <%= 'opacity-0' unless @rankings[0] %>">
          <% if first = @rankings[0] %>
            <div class="relative inline-block mb-2">
              <%= user_avatar(first,
                  classes: "relative w-14 h-14 md:w-20 md:h-20 border-4 border-yellow-300/80 dark:border-yellow-200 shadow-[6px_6px_12px_rgba(250,204,21,0.4),-6px_-6px_12px_rgba(255,255,255,0.9)] dark:shadow-[0_0_40px_rgba(251,191,36,0.6)] z-10 text-xl md:text-3xl",
                  default_color_classes: "bg-gradient-to-br from-yellow-400 to-orange-500 text-white") %>
              <div class="absolute -top-3 left-1/2 -translate-x-1/2 text-2xl md:text-4xl animate-bounce drop-shadow-lg z-20">👑</div>
              <div class="absolute -bottom-2 -right-2 text-2xl md:text-4xl drop-shadow-lg z-20">🥇</div>
            </div>
            <p class="text-yellow-700 dark:text-yellow-100 font-black text-xs md:text-base truncate px-1 dark:drop-shadow-[0_0_8px_rgba(234,179,8,0.8)]">🌟 <%= first.name.presence || "No Name" %></p>
            <p class="text-yellow-600 dark:text-yellow-200 text-xs md:text-sm font-bold"><%= number_with_precision(first.total_distance, precision: 1) %>km</p>

            <!-- Gold Podium Bar (Crystal Pillar) -->
            <div class="mt-2 h-32 md:h-52 w-[90%] mx-auto bg-gradient-to-b from-yellow-200/90 via-yellow-300/80 to-orange-300/90 dark:from-yellow-500 dark:via-amber-400 dark:to-yellow-200 rounded-t-[2.5rem] md:rounded-t-[3.5rem] border-4 border-white/80 dark:border-yellow-200 dark:border-t-white shadow-[inset_0_5px_10px_rgba(255,255,255,0.6),inset_0_-10px_20px_rgba(234,179,8,0.3),10px_10px_20px_rgba(234,179,8,0.2),-2px_-2px_10px_rgba(255,255,255,0.5)] dark:shadow-[0_0_60px_rgba(251,191,36,0.5),inset_0_0_30px_rgba(255,255,255,0.4)] flex items-start justify-center pt-3 md:pt-5 relative overflow-hidden group-hover:dark:shadow-[0_0_80px_rgba(251,191,36,0.7)] transition-all backdrop-blur-sm">
              <!-- Liquid/Glass Shine -->
              <div class="absolute top-3 left-1/2 -translate-x-1/2 w-[60%] h-4 bg-white/60 rounded-full blur-[3px] dark:hidden"></div>
              <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/50 to-transparent opacity-60 pointer-events-none animate-pulse-slow"></div>
              <span class="text-3xl md:text-5xl font-black text-yellow-500/40 dark:text-yellow-900 drop-shadow-sm dark:drop-shadow-none">1</span>
            </div>
          <% end %>
        </div>

        <!-- 3位 (Bronze) -->
        <div class="flex-1 min-w-0 text-center transform hover:scale-105 transition-transform duration-300 <%= 'opacity-0' unless @rankings[2] %>">
          <% if third = @rankings[2] %>
            <div class="relative inline-block mb-2">
              <%= user_avatar(third,
                  classes: "relative w-10 h-10 md:w-16 md:h-16 border-2 md:border-4 border-orange-200/80 dark:border-orange-200 shadow-[4px_4px_8px_rgba(251,146,60,0.4),-4px_-4px_8px_rgba(255,255,255,0.8)] dark:shadow-[0_0_20px_rgba(251,146,60,0.5)] z-10 text-lg md:text-2xl",
                  default_color_classes: "bg-gradient-to-br from-orange-400 to-red-400 text-white") %>
              <div class="absolute -bottom-2 -right-2 text-xl md:text-3xl drop-shadow-md z-20">🥉</div>
            </div>
            <p class="text-slate-700 dark:text-orange-100 font-bold text-[10px] md:text-sm truncate px-1 dark:drop-shadow-[0_0_5px_rgba(0,0,0,0.8)]"><%= third.name.presence || "No Name" %></p>
            <p class="text-orange-600 dark:text-orange-200 text-[10px] md:text-xs font-bold"><%= number_with_precision(third.total_distance, precision: 1) %>km</p>

            <!-- Bronze Podium Bar (Crystal Pillar) -->
            <div class="mt-2 h-16 md:h-28 w-[90%] mx-auto bg-gradient-to-b from-orange-200/90 via-orange-300/80 to-red-200/90 dark:from-orange-600 dark:via-orange-500 dark:to-orange-300 rounded-t-[2rem] md:rounded-t-[3rem] border-4 border-white/80 dark:border-orange-300 dark:border-t-white shadow-[inset_0_5px_10px_rgba(255,255,255,0.6),inset_0_-10px_20px_rgba(251,146,60,0.3),5px_5px_15px_rgba(251,146,60,0.2),-2px_-2px_10px_rgba(255,255,255,0.5)] dark:shadow-[0_0_30px_rgba(249,115,22,0.4),inset_0_0_20px_rgba(255,255,255,0.2)] flex items-start justify-center pt-3 md:pt-5 relative overflow-hidden group-hover:dark:shadow-[0_0_50px_rgba(249,115,22,0.6)] transition-all backdrop-blur-sm">
               <!-- Liquid/Glass Shine -->
               <div class="absolute top-2 left-1/2 -translate-x-1/2 w-[60%] h-3 bg-white/60 rounded-full blur-[2px] dark:hidden"></div>
               <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/30 to-transparent opacity-50 pointer-events-none"></div>
              <span class="text-2xl md:text-4xl font-black text-orange-400/50 dark:text-orange-900 drop-shadow-sm dark:drop-shadow-none">3</span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- ランキングリスト（4位以降） -->
  <div class="px-4 max-w-2xl mx-auto space-y-3">
    <% if @rankings.size > 3 %>
      <h3 class="text-lg font-bold text-slate-700 dark:text-white mb-4 flex items-center gap-2">
        <span class="text-2xl">
          <%= case @period
              when 'weekly' then '🗓️'
              when 'monthly' then '📊'
              when 'yearly' then '🌟'
              else '🗓️'
              end %>
        </span>
        <%= t('rankings.index.list_title') %>
      </h3>
    <% end %>

    <% last_distance = nil %>
    <% current_rank = 0 %>
    <% @rankings.each_with_index do |user, index| %>
      <% # 距離が異なる場合のみ順位を更新（同距離なら維持） %>
      <% # 小数点以下の誤差を考慮して比較 %>
      <% distance = user.total_distance.to_f.round(2) %>
      <% if distance != last_distance %>
        <% current_rank = index + 1 %>
      <% end %>
      <% last_distance = distance %>

      <% rank = current_rank %>
      <% next if index < 3 # 上位3名は別枠表示だが、順位計算のためにループは回す %>
      <% is_current_user = current_user && user.id == current_user.id %>

      <div class="relative group transition-all duration-300 hover:-translate-y-1 hover:scale-[1.01]">
        <!-- ダークモード用グロー（自分の場合） -->
        <% if is_current_user %>
          <div class="hidden dark:block absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-pink-600 rounded-[3.75rem] blur opacity-75 animate-pulse-slow"></div>
        <% end %>

        <!-- Crystal Clay Card (Light) / Glass Card (Dark) -->
        <div class="relative bg-gradient-to-br from-white/95 via-white/80 to-white/60 dark:bg-none dark:bg-slate-900/40 dark:backdrop-blur-md rounded-[2.5rem] dark:rounded-[3.75rem] p-4 border border-white/80 dark:border-white/10 dark:border-t-white/30 shadow-[10px_10px_30px_rgba(166,175,195,0.15),-10px_-10px_30px_rgba(255,255,255,0.9),inset_0_0_20px_rgba(255,255,255,0.5)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2),0_0_15px_rgba(0,0,0,0.3)] hover:shadow-[15px_15px_40px_rgba(166,175,195,0.2),-15px_-15px_40px_rgba(255,255,255,1)] dark:hover:shadow-[inset_0_1px_0_rgba(255,255,255,0.4),0_0_30px_rgba(168,85,247,0.2)] transition-all flex items-center gap-4 <%= 'ring-4 ring-purple-100 ring-offset-0 dark:ring-0' if is_current_user %> overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/20 before:to-transparent before:rounded-t-[2.5rem] dark:before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">

          <!-- Crystal Orbs (Light Mode Only) -->
          <div class="absolute -top-10 -right-10 w-24 h-24 bg-gradient-to-br from-purple-400/10 to-pink-400/10 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

          <!-- 順位バッジ -->
          <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-2xl dark:rounded-2xl shadow-[inset_-2px_-2px_5px_rgba(255,255,255,0.7),inset_2px_2px_5px_rgba(166,175,195,0.1)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2)] <%= rank <= 10 ? 'bg-gradient-to-br from-purple-100 to-pink-100 dark:from-fuchsia-500 dark:to-violet-600' : 'bg-slate-50 dark:bg-slate-800' %> relative z-10 border border-white/50 dark:border-none">
            <span class="text-xl font-black <%= rank <= 10 ? 'text-purple-600 dark:text-white' : 'text-slate-500 dark:text-slate-400' %>"><%= rank %></span>
          </div>

            <!-- ユーザー情報 -->
          <div class="flex-1 min-w-0 flex items-center gap-3 relative z-10">
            <% if user.avatar_url.present? && user.google? %>
              <%= user_avatar(user, classes: "w-10 h-10 border-2 border-white dark:border-white/20 shadow-md text-sm") %>
            <% else %>
              <%= user_avatar(user,
                  classes: "w-10 h-10 border-2 border-white shadow-md text-sm",
                  default_color_classes: "bg-gradient-to-br from-blue-400 to-blue-500 dark:border-blue-400 text-white") %>
            <% end %>

            <div class="flex-1 min-w-0">
              <p class="font-bold <%= is_current_user ? 'text-purple-700 dark:text-fuchsia-300' : 'text-slate-700 dark:text-slate-200' %> truncate">
                <%= user.name.presence || "No Name" %>
              </p>
              <div class="flex items-center gap-2 mt-0.5">
                <% if rank <= 10 %>
                  <p class="text-[10px] text-purple-500 dark:text-fuchsia-400 font-bold bg-purple-50 dark:bg-transparent px-1.5 py-0.5 rounded-full">TOP 10</p>
                <% end %>
                <% if is_current_user %>
                  <span class="text-[10px] bg-purple-500 dark:bg-fuchsia-600 text-white px-2 py-0.5 rounded-full shadow-sm whitespace-nowrap"><%= t('rankings.index.you') %></span>
                <% end %>
              </div>
            </div>
          </div>

          <!-- 距離 -->
          <div class="text-right relative z-10">
            <span class="block text-2xl font-black <%= is_current_user ? 'text-purple-600 dark:text-fuchsia-300' : 'text-slate-700 dark:text-white' %> group-hover:text-purple-600 dark:group-hover:text-fuchsia-300 transition-colors drop-shadow-sm dark:drop-shadow-none">
              <%= number_with_precision(user.total_distance, precision: 1) %>
            </span>
            <span class="text-[10px] text-slate-400 dark:text-slate-500 font-bold uppercase tracking-wider">km</span>
          </div>
        </div>
      </div>
    <% end %>

    <!-- 空状態 -->
    <% if @rankings.empty? %>
      <div class="relative group">
        <div class="hidden dark:block absolute -inset-1 bg-gradient-to-r from-purple-600 to-pink-600 rounded-[3.75rem] blur-xl opacity-30 animate-pulse-slow"></div>

        <div class="relative bg-gradient-to-br from-white/90 via-white/60 to-white/30 dark:bg-none dark:bg-slate-900/40 dark:backdrop-blur-md rounded-[3.75rem] p-12 border-2 border-white/60 dark:border-white/10 dark:border-t-white/30 shadow-[20px_20px_60px_rgba(166,175,195,0.15),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(166,175,195,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(255,255,255,0.5)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2),0_0_40px_rgba(168,85,247,0.2)] text-center overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
          <div class="text-7xl mb-6 animate-bounce relative z-10">🍃</div>
          <p class="text-slate-700 dark:text-white font-black text-2xl mb-3 relative z-10"><%= t('rankings.index.empty.title') %></p>
          <p class="text-slate-500 dark:text-slate-300 text-sm mb-8 relative z-10"><%= t('rankings.index.empty.subtitle') %></p>
          <%= link_to t('rankings.index.empty.action'), new_walk_path,
              class: "relative z-10 inline-block px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-fuchsia-600 dark:to-pink-600 text-white font-bold rounded-full shadow-lg hover:scale-110 hover:shadow-xl dark:hover:shadow-[0_0_20px_rgba(236,72,153,0.5)] transition-all" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- 注意書き -->
  <div class="px-4 mt-12 max-w-2xl mx-auto">
    <p class="text-xs text-center text-slate-400 dark:text-slate-500">
      このランキングは公開情報です。ユーザー名と歩行距離が表示されます。
    </p>
  </div>




  <div class="h-20"></div>

  <!-- OGPプレビューモーダル -->
  <% if user_signed_in? %>
    <div id="ogp-preview-modal"
         data-ogp-preview-target="modal"
         class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-200 opacity-0"
         data-action="click->ogp-preview#close">

      <div data-ogp-preview-target="container"
           class="relative bg-white dark:bg-slate-900/90 rounded-[3.75rem] p-8 max-w-2xl w-full shadow-2xl transform transition-all border-4 border-white dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_50px_rgba(168,85,247,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1)] overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[20%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none">

        <!-- 閉じるボタン -->
        <button data-action="click->ogp-preview#close" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-white transition relative z-20">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>

        <!-- タイトル -->
        <h3 class="text-lg font-bold text-slate-700 dark:text-white mb-2 flex items-center gap-2 relative z-10">
          <span>🖼️</span> シェア画像プレビュー
        </h3>
        <p class="text-xs text-slate-500 dark:text-slate-400 mb-4 leading-relaxed relative z-10">
          X(Twitter)などでシェアされた時に表示される画像です。<br>
          <span class="text-orange-500 dark:text-amber-400">※画像がアイコンのままの場合は、生成中です。数秒待ってからリロードしてください。</span>
        </p>

        <!-- プレビュー画像 -->
        <div class="relative aspect-[1.91/1] w-full rounded-xl overflow-hidden shadow-lg bg-slate-200 dark:bg-slate-800 z-10">
          <!-- ローディング表示 -->
          <div data-ogp-preview-target="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-100 dark:bg-slate-800">
            <div class="animate-spin rounded-full h-16 w-16 border-4 border-slate-300 dark:border-slate-600 border-t-purple-600 dark:border-t-fuchsia-500"></div>
            <p class="mt-4 text-sm font-bold text-slate-600 dark:text-slate-300">画像を読み込み中...</p>
            <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">生成に数秒かかる場合があります</p>
          </div>

          <!-- OGP画像 -->
          <%= image_tag ogp_image_rankings_user_path(current_user, format: :jpg, v: Time.current.to_i),
              data: {
                ogp_preview_target: "image",
                action: "error->ogp-preview#handleError load->ogp-preview#handleLoad"
              },
              class: "w-full h-full object-cover opacity-0 transition-opacity duration-500",
              alt: "Ranking OGP Preview" %>
        </div>

        <!-- アクションボタン -->
        <div class="mt-4 flex justify-end relative z-10">
          <button data-action="click->ogp-preview#refresh" class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg transition-colors text-sm font-bold border border-transparent dark:border-white/10">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            画像を最新にする
          </button>
        </div>
      </div>
    </div>

    <!-- OGP Preview Controller is now handled by Stimulus -->
  <% end %>
</div>

