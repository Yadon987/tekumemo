<!-- app/views/rankings/index.html.erb -->
<% content_for :head do %>
  <meta property="og:url" content="<%= request.original_url %>" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ä»Šé€±ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°çµæœ - ã¦ããƒ¡ãƒ¢" />
  <%
    # ã‚·ã‚§ã‚¢URLã«å«ã¾ã‚Œã‚‹user_idã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼
    ogp_user = params[:user_id].present? ? User.find_by(id: params[:user_id]) : current_user

    description = if ogp_user
                    "#{ogp_user.name}ã•ã‚“ã®ä»Šé€±ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°çµæœã‚’ãƒã‚§ãƒƒã‚¯ï¼"
                  else
                    "ã¦ããƒ¡ãƒ¢ã§æ¥½ã—ãã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ç¿’æ…£ã‚’èº«ã«ã¤ã‘ã‚ˆã†ï¼"
                  end
  %>
  <meta property="og:description" content="<%= description %>" />
  <% if ogp_user %>
    <%
      # OGPç”»åƒURLï¼ˆ.jpgæ‹¡å¼µå­ã‚’æ˜ç¤ºçš„ã«å«ã‚ã‚‹ï¼‰
      ogp_image_url = ogp_image_rankings_user_url(ogp_user, protocol: 'https') + ".jpg?v=#{Time.current.to_i}"
    %>
    <meta property="og:image" content="<%= ogp_image_url %>" />
    <meta name="twitter:image" content="<%= ogp_image_url %>" />
  <% else %>
    <meta property="og:image" content="<%= image_url('icon.png') %>" />
    <meta name="twitter:image" content="<%= image_url('icon.png') %>" />
  <% end %>
  <meta name="twitter:card" content="summary_large_image" />
<% end %>






<%# ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã®ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€å…±é€šã®èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‘ãƒ«ã‚¹ï¼‰ãŒç‹¬è‡ªèƒŒæ™¯ã¨å¹²æ¸‰ã™ã‚‹ãŸã‚éè¡¨ç¤ºã«ã™ã‚‹ %>
<style>
  html.dark body > .fixed.-z-10 {
    display: none !important;
  }
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®å¢ƒç•Œç·šã‚’æ¶ˆã™ */
  html.dark header {
    border-bottom-color: transparent !important;
  }
</style>
<div class="min-h-screen dark:bg-gradient-to-br dark:from-slate-900 dark:via-purple-800 dark:to-purple-900 pb-20 relative overflow-hidden">

  <!-- èƒŒæ™¯ã®è£…é£¾ -->
  <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼ˆå°‚ç”¨ãƒã‚ªãƒ³èƒŒæ™¯ï¼‰ -->
  <div class="hidden dark:block absolute inset-0 overflow-hidden pointer-events-none -z-10">
    <div class="absolute top-20 left-10 w-72 h-72 bg-purple-500/30 rounded-full mix-blend-multiply filter blur-3xl opacity-70"></div>
    <div class="absolute top-20 right-10 w-72 h-72 bg-pink-500/30 rounded-full mix-blend-multiply filter blur-3xl opacity-70"></div>
    <div class="absolute -bottom-8 left-20 w-72 h-72 bg-blue-500/30 rounded-full mix-blend-multiply filter blur-3xl opacity-70"></div>
  </div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆPCç”¨ã®ã¿è¡¨ç¤ºï¼‰ -->
  <div class="hidden md:block relative z-10 pt-8 pb-6 px-4 text-center">
    <div class="inline-block relative">
      <h1 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 via-pink-500 to-orange-500 dark:from-yellow-300 dark:via-pink-300 dark:to-purple-300 tracking-tight drop-shadow-sm dark:drop-shadow-2xl">
        <%= t('rankings.index.title') %>
      </h1>
      <div class="absolute -top-6 -right-8 text-4xl animate-bounce">ğŸ†</div>
      <div class="absolute -bottom-2 -left-6 text-3xl animate-spin-slow">âœ¨</div>
    </div>
    <p class="text-slate-600 dark:text-purple-200 text-sm mt-3 font-bold tracking-wide"><%= t('rankings.index.subtitle') %></p>

    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div class="mt-4 flex flex-col items-center justify-center gap-1 text-xs text-slate-500 dark:text-purple-300">
      <div class="flex items-center gap-2">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
        </span>
        <span><%= period_label_ja(@period) %><%= t('rankings.index.list_title') %></span>
      </div>
      <div class="text-slate-400 dark:text-purple-400 text-xs">
        <% if @last_data_updated_at && @next_cache_update_at %>
          <span class="inline-block">
            æœ€çµ‚é›†è¨ˆ: <%= @last_data_updated_at.strftime('%m/%d %H:%M') %>
            <span class="mx-1 opacity-50">|</span>
            æ¬¡å›ç›®å®‰: <%= @next_cache_update_at.strftime('%m/%d %H:%M') %>
          </span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- æœŸé–“åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ–ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒãƒ¼ã‚¸ãƒ³ï¼‰ -->
  <div class="px-6 mt-6 md:mt-0 mb-6 md:mb-8 relative z-10">
    <div class="bg-[#fdfbf7] dark:bg-slate-800/50 dark:backdrop-blur-xl p-1.5 rounded-full shadow-[inset_6px_6px_12px_rgba(166,175,195,0.2),inset_-6px_-6px_12px_rgba(255,255,255,0.8)] dark:shadow-[0_0_30px_rgba(168,85,247,0.3)] border border-white/50 dark:border-purple-500/30 flex justify-between items-center max-w-md mx-auto">
      <% [
        { id: 'weekly', label: t('rankings.index.tabs.weekly'), icon: 'ğŸ—“ï¸' },
        { id: 'monthly', label: t('rankings.index.tabs.monthly'), icon: 'ğŸ“Š' },
        { id: 'yearly', label: t('rankings.index.tabs.yearly'), icon: 'ğŸŒŸ' }
      ].each do |tab| %>
        <%= link_to rankings_path(period: tab[:id]),
            data: { turbo_frame: "_top" },
            class: "flex-1 text-center py-2 px-3 rounded-full text-xs font-bold transition-all duration-300 relative overflow-hidden group #{
              @period == tab[:id] ?
              'text-purple-700 dark:text-white bg-white dark:bg-gradient-to-r dark:from-purple-600 dark:to-pink-600 shadow-[4px_4px_8px_rgba(166,175,195,0.2),-4px_-4px_8px_rgba(255,255,255,0.9)] dark:shadow-[0_0_20px_rgba(168,85,247,0.5)]' :
              'text-slate-400 dark:text-purple-300 hover:text-slate-600 dark:hover:text-white hover:-translate-y-0.5 dark:hover:bg-slate-700/50'
            }" do %>
          <span class="relative z-10 flex items-center justify-center gap-1">
            <span class="text-base"><%= tab[:icon] %></span>
            <%= tab[:label] %>
          </span>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- è‡ªåˆ†ã®ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ -->
  <div class="px-4 mb-8 sticky top-4 z-20 max-w-2xl mx-auto w-full">
    <% if @my_rank %>
      <div class="relative group">
        <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚°ãƒ­ãƒ¼ -->
        <div class="hidden dark:block absolute -inset-1 bg-gradient-to-r from-purple-600 via-pink-600 to-purple-600 rounded-[2rem] blur-lg opacity-75 group-hover:opacity-100 transition animate-pulse"></div>

        <div class="relative bg-white dark:bg-gradient-to-br dark:from-slate-800 dark:to-slate-900 rounded-[2rem] p-6 border border-gray-200 dark:border-purple-500/30 shadow-lg dark:shadow-2xl backdrop-blur-xl">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="relative">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br <%= @my_rank <= 3 ? 'from-yellow-300 to-orange-400 dark:from-yellow-400 dark:to-orange-500' : 'from-purple-400 to-pink-400 dark:from-purple-500 dark:to-pink-500' %> flex flex-col items-center justify-center shadow-[inset_-2px_-2px_5px_rgba(255,255,255,0.7),inset_2px_2px_5px_rgba(0,0,0,0.1)] dark:shadow-lg transform group-hover:scale-110 transition-transform leading-none">
                  <span class="text-3xl font-black text-white drop-shadow-md"><%= @my_rank %></span>
                  <span class="text-[10px] font-bold text-white/90 uppercase"><%= ordinal_suffix(@my_rank) %></span>
                </div>
                <% if @my_rank <= 3 %>
                  <div class="absolute -top-2 -right-2 text-2xl animate-bounce">ğŸ‘‘</div>
                <% end %>
              </div>

              <div>
                <p class="text-xs text-purple-400 dark:text-purple-300 font-bold uppercase tracking-wider mb-1"><%= t('rankings.index.your_rank.title') %></p>
                <p class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 dark:from-yellow-300 dark:to-pink-300">
                  <%= @my_rank %> <span class="text-sm"><%= t('rankings.index.your_rank.rank_suffix') %></span>
                </p>
                <% if @my_rank <= 10 %>
                  <p class="text-[10px] text-green-600 dark:text-green-400 font-bold mt-1">ğŸ”¥ <%= t('rankings.index.your_rank.top_10') %></p>
                <% end %>
              </div>
            </div>

            <div class="text-right">
              <p class="text-xs text-purple-400 dark:text-purple-300 font-bold uppercase tracking-wider mb-1"><%= t('rankings.index.your_rank.distance') %></p>
              <p class="text-3xl font-black text-slate-700 dark:text-white">
                <%= number_with_precision(@my_distance, precision: 1) %>
              </p>
              <p class="text-xs text-slate-500 dark:text-purple-400"><%= t('rankings.index.your_rank.unit') %></p>

              <% if @distance_to_top > 0 %>
                <p class="text-[10px] text-orange-500 dark:text-yellow-400 mt-2 font-bold">
                  ğŸ¯ <%= t('rankings.index.your_rank.distance_to_top') %>: <%= number_with_precision(@distance_to_top * 1000, precision: 0) %>m
                </p>
              <% end %>
            </div>
          </div>

          <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
          <% if @my_rank && @my_rank > 1 %>
            <% next_rank_distance = @rankings[@my_rank - 2]&.total_distance.to_f %>
            <% distance_needed = next_rank_distance - @my_distance %>
            <% if distance_needed > 0 %>
              <div class="mt-4 pt-4 border-t border-purple-100 dark:border-purple-500/30">
                <div class="flex justify-between text-xs text-slate-500 dark:text-purple-300 mb-2">
                  <span><%= t('rankings.index.your_rank.distance_to_next') %></span>
                  <span class="font-bold text-orange-600 dark:text-yellow-400"><%= number_with_precision(distance_needed * 1000, precision: 0) %>m</span>
                </div>
                <div class="h-3 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden shadow-inner">
                  <div class="h-full bg-gradient-to-r from-purple-400 to-pink-400 dark:from-purple-500 dark:to-pink-500 rounded-full transition-all duration-500 dark:shadow-lg dark:shadow-purple-500/50"
                       style="width: <%= [(@my_distance / next_rank_distance * 100), 100].min %>%"></div>
                </div>
              </div>
            <% end %>
          <% end %>

          <!-- Xã§ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ -->
          <div class="mt-5">
            <%= link_to share_ranking_on_twitter_url(user: current_user, rank: @my_rank, distance: @my_distance * 1000, period: @period),
                target: "_blank",
                rel: "noopener noreferrer",
                class: "w-full md:w-auto md:px-10 md:min-w-[200px] mx-auto flex items-center justify-center gap-2 px-4 py-2.5 rounded-full bg-black dark:bg-white text-white dark:text-black text-sm font-bold hover:bg-gray-800 dark:hover:bg-gray-200 transition transform active:scale-95 shadow-md" do %>
              <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
              ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã‚·ã‚§ã‚¢
            <% end %>
          </div>

          <!-- ã‚·ã‚§ã‚¢ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯ï¼ˆå°ï¼‰ -->
          <div class="mt-3 text-center">
            <button onclick="toggleOgpPreview()" class="text-xs text-slate-500 dark:text-purple-400 hover:text-purple-600 dark:hover:text-purple-300 underline transition">
              ğŸ“· ã‚·ã‚§ã‚¢ç”»åƒã‚’ç¢ºèª
            </button>
          </div>
        </div>
      </div>
    <% elsif user_signed_in? %>
      <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¤–ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼‰ -->
      <div class="relative group">
        <div class="hidden dark:block absolute -inset-1 bg-gradient-to-r from-orange-600 to-red-600 rounded-[2rem] blur-lg opacity-50 group-hover:opacity-75 transition"></div>

        <div class="relative bg-orange-50 dark:bg-gradient-to-br dark:from-slate-800 dark:to-slate-900 rounded-[2rem] p-4 border-2 border-white dark:border-orange-500/50 shadow-lg dark:shadow-2xl">
          <div class="flex items-center gap-3">
            <div class="text-3xl animate-bounce">ğŸ”¥</div>
            <div class="flex-1">
              <p class="text-base font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-500 dark:from-orange-300 dark:to-red-300 mb-0.5">
                <%= t('rankings.index.empty.challenge') %>
              </p>
              <p class="text-xs text-slate-600 dark:text-purple-200">
                <%= period_label_ja(@period) %>: <span class="font-bold text-slate-800 dark:text-white"><%= number_with_precision(@my_distance, precision: 1) %>km</span>
              </p>
              <p class="text-[10px] text-orange-500 dark:text-orange-400 mt-1">ğŸ’ª <%= t('rankings.index.empty.cheer') %></p>
            </div>
            <div class="text-2xl">âš¡</div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- è¡¨å½°å°ï¼ˆãƒˆãƒƒãƒ—3å°‚ç”¨ã‚¨ãƒªã‚¢ï¼‰ -->
  <% if @rankings.present? %>
    <div class="px-4 mb-8 max-w-2xl mx-auto">
      <h2 class="text-center text-xl font-black text-slate-700 dark:text-purple-200 mb-6 flex items-center justify-center gap-2">
        <span>ğŸ†</span> <%= t('rankings.index.podium') %> <span>ğŸ†</span>
      </h2>

      <div class="flex items-end justify-center gap-4 sm:gap-6 md:gap-12 mb-8 w-full max-w-lg mx-auto">
        <!-- 2ä½ -->
        <div class="flex-1 min-w-0 text-center transform hover:scale-105 transition-transform <%= 'opacity-0' unless @rankings[1] %>">
          <% if second = @rankings[1] %>
            <div class="relative inline-block mb-2">
              <% if second.avatar_url.present? && second.use_google_avatar %>
                <%= image_tag second.avatar_url, class: "relative w-10 h-10 md:w-16 md:h-16 rounded-full border-2 md:border-4 border-slate-300 dark:border-slate-400 shadow-[4px_4px_8px_rgba(166,175,195,0.4),-4px_-4px_8px_rgba(255,255,255,0.8)] dark:shadow-xl object-cover" %>
              <% else %>
                <div class="relative w-10 h-10 md:w-16 md:h-16 rounded-full border-2 md:border-4 border-slate-300 dark:border-slate-400 bg-blue-500 flex items-center justify-center text-white font-bold text-lg md:text-2xl shadow-[4px_4px_8px_rgba(166,175,195,0.4),-4px_-4px_8px_rgba(255,255,255,0.8)] dark:shadow-xl">
                  <%= second.name.to_s[0, 2]&.upcase || "?" %>
                </div>
              <% end %>
              <div class="absolute -bottom-2 -right-2 text-xl md:text-3xl">ğŸ¥ˆ</div>
            </div>
            <p class="text-slate-700 dark:text-white font-bold text-[10px] md:text-sm truncate px-1"><%= second.name.presence || "No Name" %></p>
            <p class="text-slate-500 dark:text-slate-300 text-[10px] md:text-xs"><%= number_with_precision(second.total_distance, precision: 1) %>km</p>
            <div class="mt-2 h-24 md:h-40 w-[90%] mx-auto bg-gradient-to-t from-slate-300 to-slate-200 dark:from-slate-400 dark:to-slate-500 rounded-t-xl md:rounded-t-2xl border-2 md:border-4 border-white dark:border-slate-300 shadow-[4px_4px_8px_rgba(166,175,195,0.3)] dark:shadow-lg flex items-start justify-center pt-2 md:pt-4">
              <span class="text-xl md:text-3xl font-black text-slate-600 dark:text-white drop-shadow-sm">2</span>
            </div>
          <% end %>
        </div>

        <!-- 1ä½ -->
        <div class="flex-1 min-w-0 text-center transform hover:scale-110 transition-transform <%= 'opacity-0' unless @rankings[0] %>">
          <% if first = @rankings[0] %>
            <div class="relative inline-block mb-2">
              <% if first.avatar_url.present? && first.use_google_avatar %>
                <%= image_tag first.avatar_url, class: "relative w-14 h-14 md:w-20 md:h-20 rounded-full border-2 md:border-4 border-yellow-400 shadow-[6px_6px_12px_rgba(250,204,21,0.4),-6px_-6px_12px_rgba(255,255,255,0.9)] dark:shadow-2xl object-cover" %>
              <% else %>
                <div class="relative w-14 h-14 md:w-20 md:h-20 rounded-full border-2 md:border-4 border-yellow-400 bg-blue-500 flex items-center justify-center text-white font-bold text-xl md:text-3xl shadow-[6px_6px_12px_rgba(250,204,21,0.4),-6px_-6px_12px_rgba(255,255,255,0.9)] dark:shadow-2xl">
                  <%= first.name.to_s[0, 2]&.upcase || "?" %>
                </div>
              <% end %>
              <div class="absolute -top-3 left-1/2 -translate-x-1/2 text-2xl md:text-4xl animate-bounce">ğŸ‘‘</div>
              <div class="absolute -bottom-2 -right-2 text-2xl md:text-4xl drop-shadow-lg">ğŸ¥‡</div>
            </div>
            <p class="text-yellow-700 dark:text-yellow-300 font-black text-xs md:text-base truncate px-1">ğŸŒŸ <%= first.name.presence || "No Name" %></p>
            <p class="text-yellow-600 dark:text-yellow-200 text-xs md:text-sm font-bold"><%= number_with_precision(first.total_distance, precision: 1) %>km</p>
            <div class="mt-2 h-32 md:h-52 w-[90%] mx-auto bg-gradient-to-t from-yellow-400 via-yellow-300 to-yellow-200 dark:from-yellow-400 dark:via-yellow-500 dark:to-yellow-600 rounded-t-xl md:rounded-t-2xl border-2 md:border-4 border-white dark:border-yellow-300 shadow-[6px_6px_12px_rgba(250,204,21,0.4),-6px_-6px_12px_rgba(255,255,255,0.9)] dark:shadow-[0_0_30px_rgba(250,204,21,0.5)] flex items-start justify-center pt-2 md:pt-4">
              <span class="text-2xl md:text-4xl font-black text-yellow-800 dark:text-white drop-shadow-sm">1</span>
            </div>
          <% end %>
        </div>

        <!-- 3ä½ -->
        <div class="flex-1 min-w-0 text-center transform hover:scale-105 transition-transform <%= 'opacity-0' unless @rankings[2] %>">
          <% if third = @rankings[2] %>
            <div class="relative inline-block mb-2">
              <% if third.avatar_url.present? && third.use_google_avatar %>
                <%= image_tag third.avatar_url, class: "relative w-10 h-10 md:w-16 md:h-16 rounded-full border-2 md:border-4 border-orange-300 dark:border-orange-400 shadow-[4px_4px_8px_rgba(251,146,60,0.4),-4px_-4px_8px_rgba(255,255,255,0.8)] dark:shadow-xl object-cover" %>
              <% else %>
                <div class="relative w-10 h-10 md:w-16 md:h-16 rounded-full border-2 md:border-4 border-orange-300 dark:border-orange-400 bg-blue-500 flex items-center justify-center text-white font-bold text-lg md:text-2xl shadow-[4px_4px_8px_rgba(251,146,60,0.4),-4px_-4px_8px_rgba(255,255,255,0.8)] dark:shadow-xl">
                  <%= third.name.to_s[0, 2]&.upcase || "?" %>
                </div>
              <% end %>
              <div class="absolute -bottom-2 -right-2 text-xl md:text-3xl">ğŸ¥‰</div>
            </div>
            <p class="text-slate-700 dark:text-white font-bold text-[10px] md:text-sm truncate px-1"><%= third.name.presence || "No Name" %></p>
            <p class="text-orange-600 dark:text-orange-300 text-[10px] md:text-xs"><%= number_with_precision(third.total_distance, precision: 1) %>km</p>
            <div class="mt-2 h-16 md:h-28 w-[90%] mx-auto bg-gradient-to-t from-orange-300 to-orange-200 dark:from-orange-400 dark:to-orange-500 rounded-t-xl md:rounded-t-2xl border-2 md:border-4 border-white dark:border-orange-300 shadow-[4px_4px_8px_rgba(251,146,60,0.3)] dark:shadow-lg flex items-start justify-center pt-2 md:pt-4">
              <span class="text-xl md:text-3xl font-black text-orange-700 dark:text-white drop-shadow-sm">3</span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆï¼ˆ4ä½ä»¥é™ï¼‰ -->
  <div class="px-4 max-w-2xl mx-auto space-y-3">
    <% if @rankings.size > 3 %>
      <h3 class="text-lg font-bold text-slate-700 dark:text-purple-200 mb-4 flex items-center gap-2">
        <span class="text-2xl">
          <%= case @period
              when 'weekly' then 'ğŸ—“ï¸'
              when 'monthly' then 'ğŸ“Š'
              when 'yearly' then 'ğŸŒŸ'
              else 'ğŸ—“ï¸'
              end %>
        </span>
        <%= t('rankings.index.list_title') %>
      </h3>
    <% end %>

    <% last_distance = nil %>
    <% current_rank = 0 %>
    <% @rankings.each_with_index do |user, index| %>
      <% # è·é›¢ãŒç•°ãªã‚‹å ´åˆã®ã¿é †ä½ã‚’æ›´æ–°ï¼ˆåŒè·é›¢ãªã‚‰ç¶­æŒï¼‰ %>
      <% # å°æ•°ç‚¹ä»¥ä¸‹ã®èª¤å·®ã‚’è€ƒæ…®ã—ã¦æ¯”è¼ƒ %>
      <% distance = user.total_distance.to_f.round(2) %>
      <% if distance != last_distance %>
        <% current_rank = index + 1 %>
      <% end %>
      <% last_distance = distance %>

      <% rank = current_rank %>
      <% next if index < 3 # ä¸Šä½3åã¯åˆ¥æ è¡¨ç¤ºã ãŒã€é †ä½è¨ˆç®—ã®ãŸã‚ã«ãƒ«ãƒ¼ãƒ—ã¯å›ã™ %>
      <% is_current_user = current_user && user.id == current_user.id %>

      <div class="relative group transition-all duration-300 hover:-translate-y-1">
        <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚°ãƒ­ãƒ¼ï¼ˆè‡ªåˆ†ã®å ´åˆï¼‰ -->
        <% if is_current_user %>
          <div class="hidden dark:block absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl blur opacity-75"></div>
        <% end %>

        <div class="relative bg-white dark:bg-slate-800/70 dark:backdrop-blur-sm rounded-2xl p-4 border border-gray-200 dark:border-<%= is_current_user ? 'purple-500/30' : 'purple-500/30' %> shadow-lg dark:shadow-xl hover:shadow-xl dark:hover:shadow-2xl transition-shadow flex items-center gap-4 <%= 'ring-2 ring-purple-400 ring-offset-2 ring-offset-[#fdfbf7] dark:ring-0' if is_current_user %>">

          <!-- é †ä½ãƒãƒƒã‚¸ -->
          <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-xl shadow-[inset_-2px_-2px_5px_rgba(255,255,255,0.7),inset_2px_2px_5px_rgba(0,0,0,0.1)] dark:shadow-inner <%= rank <= 10 ? 'bg-gradient-to-br from-purple-300 to-pink-300 dark:from-purple-500 dark:to-pink-500' : 'bg-slate-100 dark:bg-slate-700' %>">
            <span class="text-xl font-black <%= rank <= 10 ? 'text-purple-700 dark:text-white' : 'text-slate-600 dark:text-slate-300' %>"><%= rank %></span>
          </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
          <div class="flex-1 min-w-0 flex items-center gap-3">
            <% if user.avatar_url.present? && user.use_google_avatar %>
              <%= image_tag user.avatar_url, class: "w-10 h-10 rounded-full border-2 border-slate-200 dark:border-white/20 shadow-sm object-cover" %>
            <% else %>
              <div class="w-10 h-10 rounded-full bg-blue-500 border-2 border-blue-400 shadow-sm flex items-center justify-center text-white font-bold text-sm">
                <%= user.name.to_s[0, 2]&.upcase || "?" %>
              </div>
            <% end %>

            <div class="flex-1 min-w-0">
              <p class="font-bold <%= is_current_user ? 'text-purple-700 dark:text-purple-300' : 'text-slate-700 dark:text-white' %> truncate">
                <%= user.name.presence || "No Name" %>
              </p>
              <div class="flex items-center gap-2 mt-0.5">
                <% if rank <= 10 %>
                  <p class="text-[10px] text-purple-500 dark:text-purple-400 font-bold">TOP 10</p>
                <% end %>
                <% if is_current_user %>
                  <span class="text-[10px] bg-purple-500 text-white px-2 py-0.5 rounded-full shadow-sm whitespace-nowrap"><%= t('rankings.index.you') %></span>
                <% end %>
              </div>
            </div>
          </div>

          <!-- è·é›¢ -->
          <div class="text-right">
            <span class="block text-2xl font-black <%= is_current_user ? 'text-purple-600 dark:text-purple-300' : 'text-slate-700 dark:text-white' %> group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors">
              <%= number_with_precision(user.total_distance, precision: 1) %>
            </span>
            <span class="text-[10px] text-slate-400 dark:text-slate-500 font-bold uppercase tracking-wider">km</span>
          </div>
        </div>
      </div>
    <% end %>

    <!-- ç©ºçŠ¶æ…‹ -->
    <% if @rankings.empty? %>
      <div class="relative group">
        <div class="hidden dark:block absolute -inset-1 bg-gradient-to-r from-purple-600 to-pink-600 rounded-[2.5rem] blur-xl opacity-30"></div>

        <div class="relative bg-white dark:bg-slate-800/70 dark:backdrop-blur-sm rounded-[2.5rem] p-12 border-2 border-white dark:border-slate-700/50 shadow-[14px_14px_28px_rgba(166,175,195,0.25),-14px_-14px_28px_rgba(255,255,255,0.9)] dark:shadow-lg text-center">
          <div class="text-7xl mb-6 animate-bounce">ğŸƒ</div>
          <p class="text-slate-700 dark:text-white font-black text-2xl mb-3"><%= t('rankings.index.empty.title') %></p>
          <p class="text-slate-500 dark:text-purple-300 text-sm mb-8"><%= t('rankings.index.empty.subtitle') %></p>
          <%= link_to t('rankings.index.empty.action'), new_walk_path,
              class: "inline-block px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-purple-600 dark:to-pink-600 text-white font-bold rounded-full shadow-lg hover:scale-110 hover:shadow-xl dark:hover:shadow-2xl dark:hover:shadow-purple-500/50 transition-all" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- æ³¨æ„æ›¸ã -->
  <div class="px-4 mt-12 max-w-2xl mx-auto">
    <p class="text-xs text-center text-slate-400 dark:text-purple-400/60">
      ã“ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯å…¬é–‹æƒ…å ±ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨æ­©è¡Œè·é›¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    </p>
  </div>




  <div class="h-20"></div>

  <!-- OGPãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <% if user_signed_in? %>
    <div id="ogp-preview-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onclick="closeOgpPreview(event)">
      <div class="relative bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-2xl w-full shadow-2xl transform transition-all" onclick="event.stopPropagation()">
        <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
        <button onclick="closeOgpPreview()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-white transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>

        <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
        <h3 class="text-lg font-bold text-slate-700 dark:text-purple-300 mb-2 flex items-center gap-2">
          <span>ğŸ–¼ï¸</span> ã‚·ã‚§ã‚¢ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        </h3>
        <p class="text-xs text-slate-500 dark:text-slate-400 mb-4 leading-relaxed">
          X(Twitter)ãªã©ã§ã‚·ã‚§ã‚¢ã•ã‚ŒãŸæ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ç”»åƒã§ã™ã€‚<br>
          <span class="text-orange-500 dark:text-yellow-400">â€»ç”»åƒãŒã‚¢ã‚¤ã‚³ãƒ³ã®ã¾ã¾ã®å ´åˆã¯ã€ç”Ÿæˆä¸­ã§ã™ã€‚æ•°ç§’å¾…ã£ã¦ã‹ã‚‰ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</span>
        </p>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ -->
        <div class="relative aspect-[1.91/1] w-full rounded-xl overflow-hidden shadow-lg bg-slate-200 dark:bg-slate-900">
          <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
          <div id="ogp-loading" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-100 dark:bg-slate-800">
            <div class="animate-spin rounded-full h-16 w-16 border-4 border-slate-300 dark:border-slate-600 border-t-purple-600 dark:border-t-purple-400"></div>
            <p class="mt-4 text-sm font-bold text-slate-600 dark:text-purple-300">ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">ç”Ÿæˆã«æ•°ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</p>
          </div>

          <!-- OGPç”»åƒ -->
          <%= image_tag ogp_image_rankings_user_path(current_user, format: :jpg, v: Time.current.to_i),
              id: "ogp-preview-image",
              class: "w-full h-full object-cover opacity-0 transition-opacity duration-500",
              alt: "Ranking OGP Preview",
              onerror: "handleOgpImageError(this)",
              onload: "handleOgpImageLoad()" %>
        </div>
      </div>
    </div>

    <script>
      let retryCount = 0;
      const MAX_RETRIES = 5;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      function toggleOgpPreview() {
        const modal = document.getElementById('ogp-preview-modal');
        modal.classList.remove('hidden');
        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        setTimeout(() => {
          modal.style.opacity = '1';
        }, 10);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸã¨ãã«ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
        retryCount = 0;
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      function closeOgpPreview(event) {
        const modal = document.getElementById('ogp-preview-modal');
        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
        modal.style.opacity = '0';
        setTimeout(() => {
          modal.classList.add('hidden');
        }, 200);
      }

      // ç”»åƒã®èª­ã¿è¾¼ã¿æˆåŠŸ
      function handleOgpImageLoad() {
        const loading = document.getElementById('ogp-loading');
        const image = document.getElementById('ogp-preview-image');

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã€ç”»åƒã‚’è¡¨ç¤º
        loading.style.display = 'none';
        image.classList.remove('opacity-0');
        image.classList.add('opacity-100');
      }

      // ç”»åƒã®èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆç”Ÿæˆä¸­ã®å¯èƒ½æ€§ï¼‰
      function handleOgpImageError(img) {
        const loading = document.getElementById('ogp-loading');

        // ã¾ã ãƒªãƒˆãƒ©ã‚¤å›æ•°ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆ
        if (retryCount < MAX_RETRIES) {
          retryCount++;

          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
          const loadingText = loading.querySelector('p.font-bold');
          loadingText.textContent = `ç”»åƒã‚’ç”Ÿæˆä¸­... (${retryCount}/${MAX_RETRIES})`;

          // 2ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤
          setTimeout(() => {
            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ›´æ–°ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°
            const currentSrc = img.src;
            img.src = currentSrc.replace(/v=\d+/, `v=${Date.now()}`);
          }, 2000);
        } else {
          // ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ã«é”ã—ãŸå ´åˆ
          loading.innerHTML = `
            <div class="text-center">
              <span class="text-4xl">âš ï¸</span>
              <p class="mt-4 text-sm font-bold text-slate-600 dark:text-purple-300">ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
              <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
            </div>
          `;
        }
      }

      // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeOgpPreview();
        }
      });
    </script>
  <% end %>
</div>


