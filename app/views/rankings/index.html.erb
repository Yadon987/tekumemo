<!-- app/views/rankings/index.html.erb -->
<% content_for :head do %>
  <meta property="og:url" content="<%= request.original_url %>" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ä»Šé€±ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°çµæœ - ã¦ããƒ¡ãƒ¢" />
  <%
    # ã‚·ã‚§ã‚¢URLã«å«ã¾ã‚Œã‚‹user_idã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼
    ogp_user = params[:user_id].present? ? User.find_by(id: params[:user_id]) : current_user

    description = if ogp_user
                    "#{ogp_user.name}ã•ã‚“ã®ä»Šé€±ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°çµæœã‚’ãƒã‚§ãƒƒã‚¯ï¼"
                  else
                    "ã¦ããƒ¡ãƒ¢ã§æ¥½ã—ãã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°ç¿’æ…£ã‚’èº«ã«ã¤ã‘ã‚ˆã†ï¼"
                  end
  %>
  <meta property="og:description" content="<%= description %>" />
  <% if ogp_user %>
    <%
      # OGPç”»åƒURLï¼ˆ.jpgæ‹¡å¼µå­ã‚’æ˜ç¤ºçš„ã«å«ã‚ã‚‹ï¼‰
      ogp_image_url = ogp_image_rankings_user_url(ogp_user, protocol: 'https') + ".jpg?v=#{Time.current.to_i}"
    %>
    <meta property="og:image" content="<%= ogp_image_url %>" />
    <meta name="twitter:image" content="<%= ogp_image_url %>" />
  <% else %>
    <meta property="og:image" content="<%= image_url('icon.png') %>" />
    <meta name="twitter:image" content="<%= image_url('icon.png') %>" />
  <% end %>
  <meta name="twitter:card" content="summary_large_image" />
<% end %>






<%# ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã®ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€å…±é€šã®èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‘ãƒ«ã‚¹ï¼‰ãŒç‹¬è‡ªèƒŒæ™¯ã¨å¹²æ¸‰ã™ã‚‹ãŸã‚éè¡¨ç¤ºã«ã™ã‚‹ %>
<style>
  html.dark body > .fixed.-z-10 {
    display: none !important;
  }
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®å¢ƒç•Œç·šã‚’æ¶ˆã™ */
  html.dark header {
    border-bottom-color: transparent !important;
  }
</style>

<!-- Deep Void Background (Dark Mode Only) -->
<div class="fixed inset-0 -z-10 hidden dark:block bg-[#020617] bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-[#1a0b2e] via-[#020617] to-[#000000]"></div>

<div class="pb-20 relative overflow-hidden">

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆPCç”¨ã®ã¿è¡¨ç¤ºï¼‰ -->
  <div class="hidden md:block relative z-10 pt-8 pb-6 px-4 text-center">
    <div class="inline-block relative">
      <h1 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 via-pink-500 to-orange-500 dark:from-fuchsia-300 dark:via-purple-300 dark:to-violet-300 tracking-tight drop-shadow-sm dark:drop-shadow-[0_0_15px_rgba(168,85,247,0.5)]">
        <%= t('rankings.index.title') %>
      </h1>
      <div class="absolute -top-6 -right-8 text-4xl animate-bounce">ğŸ†</div>
      <div class="absolute -bottom-2 -left-6 text-3xl animate-spin-slow">âœ¨</div>
    </div>
    <p class="text-slate-600 dark:text-purple-200/80 text-sm mt-3 font-bold tracking-wide"><%= t('rankings.index.subtitle') %></p>

    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div class="mt-4 flex flex-col items-center justify-center gap-1 text-xs text-slate-500 dark:text-purple-300/70">
      <div class="flex items-center gap-2">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75 dark:bg-emerald-400"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500 dark:bg-emerald-500 dark:shadow-[0_0_8px_rgba(16,185,129,0.8)]"></span>
        </span>
        <span><%= period_label_ja(@period) %><%= t('rankings.index.list_title') %></span>
      </div>
      <div class="text-slate-400 dark:text-purple-400/60 text-xs">
        <% if @last_data_updated_at && @next_cache_update_at %>
          <span class="inline-block">
            æœ€çµ‚é›†è¨ˆ: <%= @last_data_updated_at.strftime('%m/%d %H:%M') %>
            <span class="mx-1 opacity-50">|</span>
            æ¬¡å›ç›®å®‰: <%= @next_cache_update_at.strftime('%m/%d %H:%M') %>
          </span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- æœŸé–“åˆ‡ã‚Šæ›¿ãˆã‚¿ãƒ–ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒãƒ¼ã‚¸ãƒ³ï¼‰ -->
  <div class="px-6 mt-6 md:mt-0 mb-6 md:mb-8 relative z-10">
    <div class="bg-[#fdfbf7] dark:bg-slate-900/40 dark:backdrop-blur-xl p-1.5 rounded-full shadow-[inset_6px_6px_12px_rgba(166,175,195,0.2),inset_-6px_-6px_12px_rgba(255,255,255,0.8)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.1),0_0_20px_rgba(0,0,0,0.5)] border border-white/50 dark:border-white/10 flex justify-between items-center max-w-md mx-auto relative overflow-hidden">
      <% [
        { id: 'weekly', label: t('rankings.index.tabs.weekly'), icon: 'ğŸ—“ï¸' },
        { id: 'monthly', label: t('rankings.index.tabs.monthly'), icon: 'ğŸ“Š' },
        { id: 'yearly', label: t('rankings.index.tabs.yearly'), icon: 'ğŸŒŸ' }
      ].each do |tab| %>
        <%= link_to rankings_path(period: tab[:id]),
            data: { turbo_frame: "_top" },
            class: "flex-1 text-center py-2 px-3 rounded-full text-xs font-bold transition-all duration-300 relative overflow-hidden group #{
              @period == tab[:id] ?
              'text-purple-700 dark:text-white bg-white dark:bg-white/10 shadow-[4px_4px_8px_rgba(166,175,195,0.2),-4px_-4px_8px_rgba(255,255,255,0.9)] dark:shadow-[0_0_15px_rgba(255,255,255,0.1)] dark:border dark:border-white/10' :
              'text-slate-400 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 hover:-translate-y-0.5 dark:hover:bg-white/5'
            }" do %>
          <span class="relative z-10 flex items-center justify-center gap-1">
            <span class="text-base"><%= tab[:icon] %></span>
            <%= tab[:label] %>
          </span>
          <% if @period == tab[:id] %>
            <!-- Active Tab Glass Effect -->
            <div class="absolute inset-0 bg-gradient-to-b from-white/20 to-transparent opacity-50 pointer-events-none"></div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- è‡ªåˆ†ã®ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ -->
  <div class="px-4 mb-8 sticky top-4 z-20 max-w-2xl mx-auto w-full">
    <% if @my_rank %>
      <div class="relative group">
        <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚°ãƒ­ãƒ¼ (Breathing Glow) -->
        <div class="hidden dark:block absolute -inset-4 bg-purple-500/20 rounded-[3.75rem] blur-3xl animate-pulse-slow pointer-events-none"></div>

        <!-- God Mode Glass Card (Dark) / Crystal Clay Card (Light) -->
        <div class="relative bg-gradient-to-br from-white/90 via-white/60 to-white/30 dark:bg-none dark:bg-slate-900/40 rounded-[3.75rem] p-6 border border-white/60 dark:border-white/10 dark:border-t-white/40 shadow-[20px_20px_60px_rgba(168,85,247,0.15),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(168,85,247,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(168,85,247,0.3)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_30px_rgba(168,85,247,0.15)] backdrop-blur-xl overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse hover:scale-105 hover:dark:scale-100 hover:dark:border-purple-500/50 hover:dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.5),0_0_60px_rgba(168,85,247,0.4)] transition-all duration-300">

          <!-- Crystal Orbs (Light Mode Only) -->
          <div class="absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br from-purple-400/20 to-pink-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>
          <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-gradient-to-br from-blue-400/20 to-cyan-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

          <div class="flex items-center justify-between relative z-10">
            <div class="flex items-center gap-4">
              <div class="relative">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br <%= @my_rank <= 3 ? 'from-yellow-300 to-orange-400 dark:from-amber-300 dark:to-orange-500' : 'from-purple-400 to-pink-400 dark:from-fuchsia-400 dark:to-violet-600' %> flex flex-col items-center justify-center shadow-[inset_-2px_-2px_5px_rgba(255,255,255,0.7),inset_2px_2px_5px_rgba(0,0,0,0.1)] dark:shadow-[0_0_15px_rgba(255,255,255,0.3)] transform group-hover:scale-110 transition-transform leading-none">
                  <span class="text-3xl font-black text-white drop-shadow-md"><%= @my_rank %></span>
                  <span class="text-[10px] font-bold text-white/90 uppercase"><%= ordinal_suffix(@my_rank) %></span>
                </div>
                <% if @my_rank <= 3 %>
                  <div class="absolute -top-2 -right-2 text-2xl animate-bounce">ğŸ‘‘</div>
                <% end %>
              </div>

              <div>
                <p class="text-xs text-purple-400 dark:text-fuchsia-300 font-bold uppercase tracking-wider mb-1"><%= t('rankings.index.your_rank.title') %></p>
                <p class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 dark:from-fuchsia-300 dark:to-violet-300">
                  <%= @my_rank %> <span class="text-sm"><%= t('rankings.index.your_rank.rank_suffix') %></span>
                </p>
                <% if @my_rank <= 10 %>
                  <p class="text-[10px] text-green-600 dark:text-emerald-400 font-bold mt-1">ğŸ”¥ <%= t('rankings.index.your_rank.top_10') %></p>
                <% end %>
              </div>
            </div>

            <div class="text-right">
              <p class="text-xs text-purple-400 dark:text-fuchsia-300 font-bold uppercase tracking-wider mb-1"><%= t('rankings.index.your_rank.distance') %></p>
              <p class="text-3xl font-black text-slate-700 dark:text-white dark:drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">
                <%= number_with_precision(@my_distance, precision: 1) %>
              </p>
              <p class="text-xs text-slate-500 dark:text-slate-400"><%= t('rankings.index.your_rank.unit') %></p>

              <% if @distance_to_top > 0 %>
                <p class="text-[10px] text-orange-500 dark:text-amber-400 mt-2 font-bold">
                  ğŸ¯ <%= t('rankings.index.your_rank.distance_to_top') %>: <%= number_with_precision(@distance_to_top * 1000, precision: 0) %>m
                </p>
              <% end %>
            </div>
          </div>

          <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
          <% if @my_rank && @my_rank > 1 %>
            <% next_rank_distance = @rankings[@my_rank - 2]&.total_distance.to_f %>
            <% distance_needed = next_rank_distance - @my_distance %>
            <% if distance_needed > 0 %>
              <div class="mt-4 pt-4 border-t border-purple-100 dark:border-white/10 relative z-10">
                <div class="flex justify-between text-xs text-slate-500 dark:text-slate-300 mb-2">
                  <span><%= t('rankings.index.your_rank.distance_to_next') %></span>
                  <span class="font-bold text-orange-600 dark:text-amber-400"><%= number_with_precision(distance_needed * 1000, precision: 0) %>m</span>
                </div>
                <div class="h-3 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden shadow-inner dark:shadow-none">
                  <div class="h-full bg-gradient-to-r from-purple-400 to-pink-400 dark:from-fuchsia-500 dark:to-violet-500 rounded-full transition-all duration-500 dark:shadow-[0_0_10px_rgba(168,85,247,0.5)] relative overflow-hidden"
                       style="width: <%= [(@my_distance / next_rank_distance * 100), 100].min %>%">
                       <!-- Shimmer Effect -->
                       <div class="absolute inset-0 animate-shimmer bg-gradient-to-r from-transparent via-white/30 to-transparent -skew-x-12"></div>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>

          <!-- Xã§ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ -->
          <div class="mt-5 relative z-10">
            <%= link_to share_ranking_on_twitter_url(user: current_user, rank: @my_rank, distance: @my_distance * 1000, period: @period),
                target: "_blank",
                rel: "noopener noreferrer",
                class: "w-full md:w-auto md:px-10 md:min-w-[200px] mx-auto flex items-center justify-center gap-2 px-4 py-2.5 rounded-full bg-black dark:bg-white/10 text-white dark:text-white text-sm font-bold hover:bg-gray-800 dark:hover:bg-white/20 transition transform active:scale-95 shadow-md dark:shadow-[0_0_15px_rgba(255,255,255,0.1)] dark:border dark:border-white/10" do %>
              <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
              ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ã‚·ã‚§ã‚¢
            <% end %>
          </div>

          <!-- ã‚·ã‚§ã‚¢ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯ï¼ˆå°ï¼‰ -->
          <div class="mt-3 text-center relative z-10">
            <button onclick="toggleOgpPreview()" class="text-xs text-slate-500 dark:text-slate-400 hover:text-purple-600 dark:hover:text-fuchsia-300 underline transition">
              ğŸ“· ã‚·ã‚§ã‚¢ç”»åƒã‚’ç¢ºèª
            </button>
          </div>
        </div>
      </div>
    <% elsif user_signed_in? %>
      <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¤–ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼‰ -->
      <div class="relative group">
        <div class="hidden dark:block absolute -inset-1 bg-gradient-to-r from-orange-600 to-red-600 rounded-[2rem] blur-lg opacity-50 group-hover:opacity-75 transition animate-pulse-slow"></div>

        <div class="relative bg-gradient-to-br from-orange-50/90 via-orange-50/60 to-orange-50/30 dark:bg-none dark:bg-slate-900/40 rounded-[3.75rem] p-4 border-2 border-white/60 dark:border-white/10 dark:border-t-white/40 shadow-[20px_20px_60px_rgba(249,115,22,0.15),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(249,115,22,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(249,115,22,0.3)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.3),0_0_30px_rgba(249,115,22,0.15)] overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">

          <!-- Crystal Orbs (Light Mode Only) -->
          <div class="absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br from-orange-400/20 to-red-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

          <div class="flex items-center gap-3 relative z-10">
            <div class="text-3xl animate-bounce">ğŸ”¥</div>
            <div class="flex-1">
              <p class="text-base font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-500 dark:from-orange-300 dark:to-red-300 mb-0.5">
                <%= t('rankings.index.empty.challenge') %>
              </p>
              <p class="text-xs text-slate-600 dark:text-slate-300">
                <%= period_label_ja(@period) %>: <span class="font-bold text-slate-800 dark:text-white"><%= number_with_precision(@my_distance, precision: 1) %>km</span>
              </p>
              <p class="text-[10px] text-orange-500 dark:text-orange-400 mt-1">ğŸ’ª <%= t('rankings.index.empty.cheer') %></p>
            </div>
            <div class="text-2xl">âš¡</div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- è¡¨å½°å°ï¼ˆãƒˆãƒƒãƒ—3å°‚ç”¨ã‚¨ãƒªã‚¢ï¼‰ -->
  <% if @rankings.present? %>
    <div class="px-4 mb-8 max-w-2xl mx-auto">
      <h2 class="text-center text-xl font-black text-slate-700 dark:text-white mb-6 flex items-center justify-center gap-2 dark:drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]">
        <span>ğŸ†</span> <%= t('rankings.index.podium') %> <span>ğŸ†</span>
      </h2>

      <div class="flex items-end justify-center gap-4 sm:gap-6 md:gap-12 mb-8 w-full max-w-lg mx-auto">
        <!-- 2ä½ (Silver) -->
        <div class="flex-1 min-w-0 text-center transform hover:scale-105 transition-transform duration-300 <%= 'opacity-0' unless @rankings[1] %>">
          <% if second = @rankings[1] %>
            <div class="relative inline-block mb-2">
              <% if second.avatar_url.present? && second.use_google_avatar %>
                <%= image_tag second.avatar_url, class: "relative w-10 h-10 md:w-16 md:h-16 rounded-full border-2 md:border-4 border-slate-200/80 dark:border-slate-200 shadow-[4px_4px_8px_rgba(148,163,184,0.4),-4px_-4px_8px_rgba(255,255,255,0.8)] dark:shadow-[0_0_20px_rgba(226,232,240,0.5)] object-cover z-10" %>
              <% else %>
                <div class="relative w-10 h-10 md:w-16 md:h-16 rounded-full border-2 md:border-4 border-slate-200/80 dark:border-slate-200 bg-gradient-to-br from-slate-400 to-slate-500 flex items-center justify-center text-white font-bold text-lg md:text-2xl shadow-[4px_4px_8px_rgba(148,163,184,0.4),-4px_-4px_8px_rgba(255,255,255,0.8)] dark:shadow-[0_0_20px_rgba(226,232,240,0.5)] z-10">
                  <%= second.name.to_s[0, 1]&.upcase || "?" %>
                </div>
              <% end %>
              <div class="absolute -bottom-2 -right-2 text-xl md:text-3xl drop-shadow-md z-20">ğŸ¥ˆ</div>
            </div>
            <p class="text-slate-700 dark:text-slate-100 font-bold text-[10px] md:text-sm truncate px-1 dark:drop-shadow-[0_0_5px_rgba(0,0,0,0.8)]"><%= second.name.presence || "No Name" %></p>
            <p class="text-slate-500 dark:text-slate-300 text-[10px] md:text-xs font-bold"><%= number_with_precision(second.total_distance, precision: 1) %>km</p>

            <!-- Silver Podium Bar (Crystal Pillar) -->
            <div class="mt-2 h-24 md:h-40 w-[90%] mx-auto bg-gradient-to-b from-slate-200/90 via-slate-300/80 to-slate-400/90 dark:from-slate-400 dark:via-slate-300 dark:to-white rounded-t-[2rem] md:rounded-t-[3rem] border-4 border-white/80 dark:border-slate-300 dark:border-t-white shadow-[inset_0_5px_10px_rgba(255,255,255,0.6),inset_0_-10px_20px_rgba(148,163,184,0.3),5px_5px_15px_rgba(148,163,184,0.2),-2px_-2px_10px_rgba(255,255,255,0.5)] dark:shadow-[0_0_30px_rgba(148,163,184,0.4),inset_0_0_20px_rgba(255,255,255,0.3)] flex items-start justify-center pt-3 md:pt-5 relative overflow-hidden group-hover:dark:shadow-[0_0_50px_rgba(148,163,184,0.6)] transition-all backdrop-blur-sm">
               <!-- Liquid/Glass Shine -->
               <div class="absolute top-2 left-1/2 -translate-x-1/2 w-[60%] h-3 bg-white/60 rounded-full blur-[2px] dark:hidden"></div>
               <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/40 to-transparent opacity-50 pointer-events-none"></div>
              <span class="text-2xl md:text-4xl font-black text-slate-400/50 dark:text-slate-800 drop-shadow-sm dark:drop-shadow-none">2</span>
            </div>
          <% end %>
        </div>

        <!-- 1ä½ (Gold) -->
        <div class="flex-1 min-w-0 text-center transform hover:scale-110 transition-transform duration-300 <%= 'opacity-0' unless @rankings[0] %>">
          <% if first = @rankings[0] %>
            <div class="relative inline-block mb-2">
              <% if first.avatar_url.present? && first.use_google_avatar %>
                <%= image_tag first.avatar_url, class: "relative w-14 h-14 md:w-20 md:h-20 rounded-full border-4 border-yellow-300/80 dark:border-yellow-200 shadow-[6px_6px_12px_rgba(250,204,21,0.4),-6px_-6px_12px_rgba(255,255,255,0.9)] dark:shadow-[0_0_40px_rgba(251,191,36,0.6)] object-cover z-10" %>
              <% else %>
                <div class="relative w-14 h-14 md:w-20 md:h-20 rounded-full border-4 border-yellow-300/80 dark:border-yellow-200 bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-white font-bold text-xl md:text-3xl shadow-[6px_6px_12px_rgba(250,204,21,0.4),-6px_-6px_12px_rgba(255,255,255,0.9)] dark:shadow-[0_0_40px_rgba(251,191,36,0.6)] z-10">
                  <%= first.name.to_s[0, 1]&.upcase || "?" %>
                </div>
              <% end %>
              <div class="absolute -top-3 left-1/2 -translate-x-1/2 text-2xl md:text-4xl animate-bounce drop-shadow-lg z-20">ğŸ‘‘</div>
              <div class="absolute -bottom-2 -right-2 text-2xl md:text-4xl drop-shadow-lg z-20">ğŸ¥‡</div>
            </div>
            <p class="text-yellow-700 dark:text-yellow-100 font-black text-xs md:text-base truncate px-1 dark:drop-shadow-[0_0_8px_rgba(234,179,8,0.8)]">ğŸŒŸ <%= first.name.presence || "No Name" %></p>
            <p class="text-yellow-600 dark:text-yellow-200 text-xs md:text-sm font-bold"><%= number_with_precision(first.total_distance, precision: 1) %>km</p>

            <!-- Gold Podium Bar (Crystal Pillar) -->
            <div class="mt-2 h-32 md:h-52 w-[90%] mx-auto bg-gradient-to-b from-yellow-200/90 via-yellow-300/80 to-orange-300/90 dark:from-yellow-500 dark:via-amber-400 dark:to-yellow-200 rounded-t-[2.5rem] md:rounded-t-[3.5rem] border-4 border-white/80 dark:border-yellow-200 dark:border-t-white shadow-[inset_0_5px_10px_rgba(255,255,255,0.6),inset_0_-10px_20px_rgba(234,179,8,0.3),10px_10px_20px_rgba(234,179,8,0.2),-2px_-2px_10px_rgba(255,255,255,0.5)] dark:shadow-[0_0_60px_rgba(251,191,36,0.5),inset_0_0_30px_rgba(255,255,255,0.4)] flex items-start justify-center pt-3 md:pt-5 relative overflow-hidden group-hover:dark:shadow-[0_0_80px_rgba(251,191,36,0.7)] transition-all backdrop-blur-sm">
              <!-- Liquid/Glass Shine -->
              <div class="absolute top-3 left-1/2 -translate-x-1/2 w-[60%] h-4 bg-white/60 rounded-full blur-[3px] dark:hidden"></div>
              <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/50 to-transparent opacity-60 pointer-events-none animate-pulse-slow"></div>
              <span class="text-3xl md:text-5xl font-black text-yellow-500/40 dark:text-yellow-900 drop-shadow-sm dark:drop-shadow-none">1</span>
            </div>
          <% end %>
        </div>

        <!-- 3ä½ (Bronze) -->
        <div class="flex-1 min-w-0 text-center transform hover:scale-105 transition-transform duration-300 <%= 'opacity-0' unless @rankings[2] %>">
          <% if third = @rankings[2] %>
            <div class="relative inline-block mb-2">
              <% if third.avatar_url.present? && third.use_google_avatar %>
                <%= image_tag third.avatar_url, class: "relative w-10 h-10 md:w-16 md:h-16 rounded-full border-2 md:border-4 border-orange-200/80 dark:border-orange-200 shadow-[4px_4px_8px_rgba(251,146,60,0.4),-4px_-4px_8px_rgba(255,255,255,0.8)] dark:shadow-[0_0_20px_rgba(251,146,60,0.5)] object-cover z-10" %>
              <% else %>
                <div class="relative w-10 h-10 md:w-16 md:h-16 rounded-full border-2 md:border-4 border-orange-200/80 dark:border-orange-200 bg-gradient-to-br from-orange-400 to-red-400 flex items-center justify-center text-white font-bold text-lg md:text-2xl shadow-[4px_4px_8px_rgba(251,146,60,0.4),-4px_-4px_8px_rgba(255,255,255,0.8)] dark:shadow-[0_0_20px_rgba(251,146,60,0.5)] z-10">
                  <%= third.name.to_s[0, 1]&.upcase || "?" %>
                </div>
              <% end %>
              <div class="absolute -bottom-2 -right-2 text-xl md:text-3xl drop-shadow-md z-20">ğŸ¥‰</div>
            </div>
            <p class="text-slate-700 dark:text-orange-100 font-bold text-[10px] md:text-sm truncate px-1 dark:drop-shadow-[0_0_5px_rgba(0,0,0,0.8)]"><%= third.name.presence || "No Name" %></p>
            <p class="text-orange-600 dark:text-orange-200 text-[10px] md:text-xs font-bold"><%= number_with_precision(third.total_distance, precision: 1) %>km</p>

            <!-- Bronze Podium Bar (Crystal Pillar) -->
            <div class="mt-2 h-16 md:h-28 w-[90%] mx-auto bg-gradient-to-b from-orange-200/90 via-orange-300/80 to-red-200/90 dark:from-orange-600 dark:via-orange-500 dark:to-orange-300 rounded-t-[2rem] md:rounded-t-[3rem] border-4 border-white/80 dark:border-orange-300 dark:border-t-white shadow-[inset_0_5px_10px_rgba(255,255,255,0.6),inset_0_-10px_20px_rgba(251,146,60,0.3),5px_5px_15px_rgba(251,146,60,0.2),-2px_-2px_10px_rgba(255,255,255,0.5)] dark:shadow-[0_0_30px_rgba(249,115,22,0.4),inset_0_0_20px_rgba(255,255,255,0.2)] flex items-start justify-center pt-3 md:pt-5 relative overflow-hidden group-hover:dark:shadow-[0_0_50px_rgba(249,115,22,0.6)] transition-all backdrop-blur-sm">
               <!-- Liquid/Glass Shine -->
               <div class="absolute top-2 left-1/2 -translate-x-1/2 w-[60%] h-3 bg-white/60 rounded-full blur-[2px] dark:hidden"></div>
               <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/30 to-transparent opacity-50 pointer-events-none"></div>
              <span class="text-2xl md:text-4xl font-black text-orange-400/50 dark:text-orange-900 drop-shadow-sm dark:drop-shadow-none">3</span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆï¼ˆ4ä½ä»¥é™ï¼‰ -->
  <div class="px-4 max-w-2xl mx-auto space-y-3">
    <% if @rankings.size > 3 %>
      <h3 class="text-lg font-bold text-slate-700 dark:text-white mb-4 flex items-center gap-2">
        <span class="text-2xl">
          <%= case @period
              when 'weekly' then 'ğŸ—“ï¸'
              when 'monthly' then 'ğŸ“Š'
              when 'yearly' then 'ğŸŒŸ'
              else 'ğŸ—“ï¸'
              end %>
        </span>
        <%= t('rankings.index.list_title') %>
      </h3>
    <% end %>

    <% last_distance = nil %>
    <% current_rank = 0 %>
    <% @rankings.each_with_index do |user, index| %>
      <% # è·é›¢ãŒç•°ãªã‚‹å ´åˆã®ã¿é †ä½ã‚’æ›´æ–°ï¼ˆåŒè·é›¢ãªã‚‰ç¶­æŒï¼‰ %>
      <% # å°æ•°ç‚¹ä»¥ä¸‹ã®èª¤å·®ã‚’è€ƒæ…®ã—ã¦æ¯”è¼ƒ %>
      <% distance = user.total_distance.to_f.round(2) %>
      <% if distance != last_distance %>
        <% current_rank = index + 1 %>
      <% end %>
      <% last_distance = distance %>

      <% rank = current_rank %>
      <% next if index < 3 # ä¸Šä½3åã¯åˆ¥æ è¡¨ç¤ºã ãŒã€é †ä½è¨ˆç®—ã®ãŸã‚ã«ãƒ«ãƒ¼ãƒ—ã¯å›ã™ %>
      <% is_current_user = current_user && user.id == current_user.id %>

      <div class="relative group transition-all duration-300 hover:-translate-y-1 hover:scale-[1.01]">
        <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚°ãƒ­ãƒ¼ï¼ˆè‡ªåˆ†ã®å ´åˆï¼‰ -->
        <% if is_current_user %>
          <div class="hidden dark:block absolute -inset-0.5 bg-gradient-to-r from-purple-600 to-pink-600 rounded-[3.75rem] blur opacity-75 animate-pulse-slow"></div>
        <% end %>

        <!-- Crystal Clay Card (Light) / Glass Card (Dark) -->
        <div class="relative bg-gradient-to-br from-white/95 via-white/80 to-white/60 dark:bg-none dark:bg-slate-900/40 dark:backdrop-blur-md rounded-[2.5rem] dark:rounded-[3.75rem] p-4 border border-white/80 dark:border-white/10 dark:border-t-white/30 shadow-[10px_10px_30px_rgba(166,175,195,0.15),-10px_-10px_30px_rgba(255,255,255,0.9),inset_0_0_20px_rgba(255,255,255,0.5)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2),0_0_15px_rgba(0,0,0,0.3)] hover:shadow-[15px_15px_40px_rgba(166,175,195,0.2),-15px_-15px_40px_rgba(255,255,255,1)] dark:hover:shadow-[inset_0_1px_0_rgba(255,255,255,0.4),0_0_30px_rgba(168,85,247,0.2)] transition-all flex items-center gap-4 <%= 'ring-4 ring-purple-100 ring-offset-0 dark:ring-0' if is_current_user %> overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/20 before:to-transparent before:rounded-t-[2.5rem] dark:before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">

          <!-- Crystal Orbs (Light Mode Only) -->
          <div class="absolute -top-10 -right-10 w-24 h-24 bg-gradient-to-br from-purple-400/10 to-pink-400/10 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

          <!-- é †ä½ãƒãƒƒã‚¸ -->
          <div class="w-12 h-12 flex-shrink-0 flex items-center justify-center rounded-2xl dark:rounded-2xl shadow-[inset_-2px_-2px_5px_rgba(255,255,255,0.7),inset_2px_2px_5px_rgba(166,175,195,0.1)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2)] <%= rank <= 10 ? 'bg-gradient-to-br from-purple-100 to-pink-100 dark:from-fuchsia-500 dark:to-violet-600' : 'bg-slate-50 dark:bg-slate-800' %> relative z-10 border border-white/50 dark:border-none">
            <span class="text-xl font-black <%= rank <= 10 ? 'text-purple-600 dark:text-white' : 'text-slate-500 dark:text-slate-400' %>"><%= rank %></span>
          </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
          <div class="flex-1 min-w-0 flex items-center gap-3 relative z-10">
            <% if user.avatar_url.present? && user.use_google_avatar %>
              <%= image_tag user.avatar_url, class: "w-10 h-10 rounded-full border-2 border-white dark:border-white/20 shadow-md object-cover" %>
            <% else %>
              <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-500 border-2 border-white dark:border-blue-400 shadow-md flex items-center justify-center text-white font-bold text-sm">
                <%= user.name.to_s[0, 1]&.upcase || "?" %>
              </div>
            <% end %>

            <div class="flex-1 min-w-0">
              <p class="font-bold <%= is_current_user ? 'text-purple-700 dark:text-fuchsia-300' : 'text-slate-700 dark:text-slate-200' %> truncate">
                <%= user.name.presence || "No Name" %>
              </p>
              <div class="flex items-center gap-2 mt-0.5">
                <% if rank <= 10 %>
                  <p class="text-[10px] text-purple-500 dark:text-fuchsia-400 font-bold bg-purple-50 dark:bg-transparent px-1.5 py-0.5 rounded-full">TOP 10</p>
                <% end %>
                <% if is_current_user %>
                  <span class="text-[10px] bg-purple-500 dark:bg-fuchsia-600 text-white px-2 py-0.5 rounded-full shadow-sm whitespace-nowrap"><%= t('rankings.index.you') %></span>
                <% end %>
              </div>
            </div>
          </div>

          <!-- è·é›¢ -->
          <div class="text-right relative z-10">
            <span class="block text-2xl font-black <%= is_current_user ? 'text-purple-600 dark:text-fuchsia-300' : 'text-slate-700 dark:text-white' %> group-hover:text-purple-600 dark:group-hover:text-fuchsia-300 transition-colors drop-shadow-sm dark:drop-shadow-none">
              <%= number_with_precision(user.total_distance, precision: 1) %>
            </span>
            <span class="text-[10px] text-slate-400 dark:text-slate-500 font-bold uppercase tracking-wider">km</span>
          </div>
        </div>
      </div>
    <% end %>

    <!-- ç©ºçŠ¶æ…‹ -->
    <% if @rankings.empty? %>
      <div class="relative group">
        <div class="hidden dark:block absolute -inset-1 bg-gradient-to-r from-purple-600 to-pink-600 rounded-[3.75rem] blur-xl opacity-30 animate-pulse-slow"></div>

        <div class="relative bg-gradient-to-br from-white/90 via-white/60 to-white/30 dark:bg-none dark:bg-slate-900/40 dark:backdrop-blur-md rounded-[3.75rem] p-12 border-2 border-white/60 dark:border-white/10 dark:border-t-white/30 shadow-[20px_20px_60px_rgba(166,175,195,0.15),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(166,175,195,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(255,255,255,0.5)] dark:shadow-[inset_0_1px_0_rgba(255,255,255,0.2),0_0_40px_rgba(168,85,247,0.2)] text-center overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">
          <div class="text-7xl mb-6 animate-bounce relative z-10">ğŸƒ</div>
          <p class="text-slate-700 dark:text-white font-black text-2xl mb-3 relative z-10"><%= t('rankings.index.empty.title') %></p>
          <p class="text-slate-500 dark:text-slate-300 text-sm mb-8 relative z-10"><%= t('rankings.index.empty.subtitle') %></p>
          <%= link_to t('rankings.index.empty.action'), new_walk_path,
              class: "relative z-10 inline-block px-8 py-4 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-fuchsia-600 dark:to-pink-600 text-white font-bold rounded-full shadow-lg hover:scale-110 hover:shadow-xl dark:hover:shadow-[0_0_20px_rgba(236,72,153,0.5)] transition-all" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- æ³¨æ„æ›¸ã -->
  <div class="px-4 mt-12 max-w-2xl mx-auto">
    <p class="text-xs text-center text-slate-400 dark:text-slate-500">
      ã“ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯å…¬é–‹æƒ…å ±ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨æ­©è¡Œè·é›¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    </p>
  </div>




  <div class="h-20"></div>

  <!-- OGPãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <% if user_signed_in? %>
    <div id="ogp-preview-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onclick="closeOgpPreview(event)">
      <div class="relative bg-white dark:bg-slate-900/90 rounded-[3.75rem] p-8 max-w-2xl w-full shadow-2xl transform transition-all border-4 border-white dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_50px_rgba(168,85,247,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1)] overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[20%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none" onclick="event.stopPropagation()">
        <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
        <button onclick="closeOgpPreview()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-white transition relative z-20">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>

        <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
        <h3 class="text-lg font-bold text-slate-700 dark:text-white mb-2 flex items-center gap-2 relative z-10">
          <span>ğŸ–¼ï¸</span> ã‚·ã‚§ã‚¢ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        </h3>
        <p class="text-xs text-slate-500 dark:text-slate-400 mb-4 leading-relaxed relative z-10">
          X(Twitter)ãªã©ã§ã‚·ã‚§ã‚¢ã•ã‚ŒãŸæ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ç”»åƒã§ã™ã€‚<br>
          <span class="text-orange-500 dark:text-amber-400">â€»ç”»åƒãŒã‚¢ã‚¤ã‚³ãƒ³ã®ã¾ã¾ã®å ´åˆã¯ã€ç”Ÿæˆä¸­ã§ã™ã€‚æ•°ç§’å¾…ã£ã¦ã‹ã‚‰ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</span>
        </p>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ -->
        <div class="relative aspect-[1.91/1] w-full rounded-xl overflow-hidden shadow-lg bg-slate-200 dark:bg-slate-800 z-10">
          <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
          <div id="ogp-loading" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-100 dark:bg-slate-800">
            <div class="animate-spin rounded-full h-16 w-16 border-4 border-slate-300 dark:border-slate-600 border-t-purple-600 dark:border-t-fuchsia-500"></div>
            <p class="mt-4 text-sm font-bold text-slate-600 dark:text-slate-300">ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
            <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">ç”Ÿæˆã«æ•°ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</p>
          </div>

          <!-- OGPç”»åƒ -->
          <%= image_tag ogp_image_rankings_user_path(current_user, format: :jpg, v: Time.current.to_i),
              id: "ogp-preview-image",
              class: "w-full h-full object-cover opacity-0 transition-opacity duration-500",
              alt: "Ranking OGP Preview",
              onerror: "handleOgpImageError(this)",
              onload: "handleOgpImageLoad()" %>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="mt-4 flex justify-end relative z-10">
          <button onclick="refreshOgpImage()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg transition-colors text-sm font-bold border border-transparent dark:border-white/10">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            ç”»åƒã‚’æœ€æ–°ã«ã™ã‚‹
          </button>
        </div>
      </div>
    </div>

    <script>
      let retryCount = 0;
      const MAX_RETRIES = 5;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      function toggleOgpPreview() {
        const modal = document.getElementById('ogp-preview-modal');
        modal.classList.remove('hidden');
        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        setTimeout(() => {
          modal.style.opacity = '1';
        }, 10);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸã¨ãã«ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
        retryCount = 0;
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      function closeOgpPreview(event) {
        const modal = document.getElementById('ogp-preview-modal');
        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
        modal.style.opacity = '0';
        setTimeout(() => {
          modal.classList.add('hidden');
        }, 200);
      }

      // ç”»åƒã‚’å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
      function refreshOgpImage() {
        const img = document.getElementById('ogp-preview-image');
        const loading = document.getElementById('ogp-loading');

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        loading.style.display = 'flex';
        img.classList.remove('opacity-100');
        img.classList.add('opacity-0');

        // ç¾åœ¨ã®srcã‚’å–å¾—ã—ã€refreshãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜ä¸
        const currentSrc = new URL(img.src);
        currentSrc.searchParams.set('refresh', 'true');
        currentSrc.searchParams.set('v', new Date().getTime()); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼

        // ç”»åƒã‚’å†èª­ã¿è¾¼ã¿
        img.src = currentSrc.toString();
      }

      // ç”»åƒã®èª­ã¿è¾¼ã¿æˆåŠŸ
      function handleOgpImageLoad() {
        const loading = document.getElementById('ogp-loading');
        const image = document.getElementById('ogp-preview-image');

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã€ç”»åƒã‚’è¡¨ç¤º
        loading.style.display = 'none';
        image.classList.remove('opacity-0');
        image.classList.add('opacity-100');
      }

      // ç”»åƒã®èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆç”Ÿæˆä¸­ã®å¯èƒ½æ€§ï¼‰
      function handleOgpImageError(img) {
        const loading = document.getElementById('ogp-loading');

        // ã¾ã ãƒªãƒˆãƒ©ã‚¤å›æ•°ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆ
        if (retryCount < MAX_RETRIES) {
          retryCount++;

          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
          const loadingText = loading.querySelector('p.font-bold');
          loadingText.textContent = `ç”»åƒã‚’ç”Ÿæˆä¸­... (${retryCount}/${MAX_RETRIES})`;

          // 2ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤
          setTimeout(() => {
            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ›´æ–°ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°
            const currentSrc = img.src;
            img.src = currentSrc.replace(/v=\d+/, `v=${Date.now()}`);
          }, 2000);
        } else {
          // ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ã«é”ã—ãŸå ´åˆ
          loading.innerHTML = `
            <div class="text-center">
              <span class="text-4xl">âš ï¸</span>
              <p class="mt-4 text-sm font-bold text-slate-600 dark:text-purple-300">ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
              <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
            </div>
          `;
        }
      }

      // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeOgpPreview();
        }
      });
    </script>
  <% end %>
</div>
