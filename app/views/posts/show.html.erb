<%# OGPè¨­å®š %>
<% content_for :head do %>
  <meta property="og:title" content="ADVENTURE LOG - TekuMemo" />
  <meta property="og:description" content="<%= @post.body.present? ? @post.body.truncate(100) : 'æ•£æ­©ã®è¨˜éŒ²ã‚’ãƒã‚§ãƒƒã‚¯ã—ã‚ˆã†ï¼' %>" />
  <%# OGPç”»åƒã®URLã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã¨æ‹¡å¼µå­ã‚’è¿½åŠ  %>
  <meta property="og:image" content="<%= post_ogp_image_url(@post, format: :jpg, v: @post.updated_at.to_i) %>" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="<%= post_url(@post) %>" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ADVENTURE LOG - TekuMemo" />
  <meta name="twitter:description" content="<%= @post.body.present? ? @post.body.truncate(100) : 'æ•£æ­©ã®è¨˜éŒ²ã‚’ãƒã‚§ãƒƒã‚¯ã—ã‚ˆã†ï¼' %>" />
  <meta name="twitter:image" content="<%= post_ogp_image_url(@post, format: :jpg, v: @post.updated_at.to_i) %>" />
<% end %>

<div class="container mx-auto px-4 py-8 min-h-screen flex items-center justify-center">
  <div class="relative max-w-2xl w-full bg-[#fdfbf7] dark:bg-[#1a0b2e] rounded-[2.5rem] shadow-[20px_20px_60px_rgba(168,85,247,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(168,85,247,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(168,85,247,0.3)] dark:shadow-[0_0_20px_rgba(168,85,247,0.4)] overflow-hidden border-2 border-white/60 dark:border-purple-500/30 p-8">
    <!-- Candy Texture & Orbs (Light Mode Only) -->
    <div class="absolute inset-0 bg-gradient-to-br from-white/80 via-white/40 to-transparent pointer-events-none dark:hidden"></div>
    <div class="absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br from-purple-400/20 to-pink-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>
    <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-gradient-to-br from-blue-400/20 to-cyan-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

    <div class="relative z-10">
      <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
      <div class="mb-4">
      <% back_path = user_signed_in? ? posts_path : root_path %>
      <% back_text = user_signed_in? ? "ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«æˆ»ã‚‹" : "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹" %>
      <%= link_to back_path, class: "inline-flex items-center gap-2 text-slate-600 dark:text-purple-300 hover:text-purple-600 dark:hover:text-purple-200 transition font-bold" do %>
        <span class="material-symbols-outlined">arrow_back</span>
        <span class="text-sm"><%= back_text %></span>
      <% end %>
    </div>

    <h1 class="text-3xl font-bold mb-6 text-center text-slate-800 dark:text-purple-100">å†’é™ºã®è¨˜éŒ²</h1>

    <div class="mb-8 relative group">
      <div class="absolute -inset-1 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
      <img id="main-ogp-image" src="<%= post_ogp_image_url(@post, format: :jpg) %>" alt="Adventure Log" class="relative w-full rounded-[2rem] shadow-[0_10px_30px_rgba(0,0,0,0.1)] dark:shadow-none transform transition duration-500 hover:scale-[1.02] border-4 border-white/50 dark:border-transparent">
    </div>

    <!-- ã‚·ã‚§ã‚¢ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯ï¼ˆå°ï¼‰ -->
    <div class="mt-[-20px] mb-8 text-center relative z-10">
      <button onclick="toggleOgpPreview()" class="text-xs text-slate-500 dark:text-slate-400 hover:text-purple-600 dark:hover:text-fuchsia-300 underline transition">
        ğŸ“· ã‚·ã‚§ã‚¢ç”»åƒã‚’ç¢ºèªãƒ»æ›´æ–°
      </button>
    </div>

    <% if @post.body.present? %>
      <p class="text-lg text-slate-600 dark:text-slate-300 mb-8 text-center font-medium leading-relaxed">
        "<%= @post.body %>"
      </p>
    <% end %>

    <div class="text-center space-y-4 max-w-md mx-auto">
      <% if @post.user_id == current_user&.id %>
        <%= link_to share_post_on_twitter_url(@post),
            target: "_blank",
            rel: "noopener noreferrer",
            class: "w-full rounded-full border-2 border-white/30 bg-black text-white font-bold py-3 px-8 shadow-[0_10px_25px_rgba(0,0,0,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] hover:shadow-[0_15px_35px_rgba(0,0,0,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] hover:-translate-y-1 transition-all duration-300 mb-4 flex items-center justify-center gap-2" do %>
          <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
          ã§ã‚·ã‚§ã‚¢ã™ã‚‹
        <% end %>
        <br>
      <% end %>

      <% if user_signed_in? %>
        <%= link_to posts_path, class: "w-full rounded-full border-2 border-white/30 dark:border-cyan-500/50 bg-gradient-to-r from-cyan-500 to-blue-500 dark:from-[#0f172a] dark:to-[#1e3a8a] text-white dark:text-cyan-100 font-bold py-4 px-10 shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.15),inset_2px_2px_5px_rgba(255,255,255,0.3),0_10px_25px_rgba(6,182,212,0.4)] dark:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.3),inset_2px_2px_5px_rgba(255,255,255,0.2),0_0_20px_rgba(6,182,212,0.4)] hover:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.15),inset_2px_2px_5px_rgba(255,255,255,0.3),0_15px_35px_rgba(6,182,212,0.6)] dark:hover:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.3),inset_2px_2px_5px_rgba(255,255,255,0.2),0_0_40px_rgba(6,182,212,0.6)] hover:-translate-y-1 active:scale-95 transition-all duration-300 flex items-center justify-center gap-2" do %>
          <i class="fas fa-list"></i> <span>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’è¦‹ã‚‹</span>
        <% end %>

        <%= link_to root_path, class: "w-full rounded-full border-2 border-white/30 dark:border-rose-500/50 bg-gradient-to-r from-rose-500 to-red-500 dark:from-[#2e0f15] dark:to-[#450a0a] text-white dark:text-rose-100 font-bold py-4 px-10 shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.15),inset_2px_2px_5px_rgba(255,255,255,0.3),0_10px_25px_rgba(244,63,94,0.4)] dark:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.3),inset_2px_2px_5px_rgba(255,255,255,0.2),0_0_20px_rgba(244,63,94,0.4)] hover:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.15),inset_2px_2px_5px_rgba(255,255,255,0.3),0_15px_35px_rgba(244,63,94,0.6)] dark:hover:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.3),inset_2px_2px_5px_rgba(255,255,255,0.2),0_0_40px_rgba(244,63,94,0.6)] hover:-translate-y-1 active:scale-95 transition-all duration-300 flex items-center justify-center gap-2" do %>
          <i class="fas fa-home"></i> <span>ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</span>
        <% end %>
      <% else %>
        <%= link_to new_user_session_path, class: "w-full rounded-full border-2 border-white/30 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-[#0f172a] dark:to-[#1e3a8a] text-white dark:text-cyan-100 font-bold py-4 px-10 shadow-[0_10px_25px_rgba(168,85,247,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:shadow-[0_0_15px_rgba(6,182,212,0.3)] dark:border-cyan-500/50 hover:shadow-[0_15px_35px_rgba(168,85,247,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] dark:hover:shadow-[0_0_25px_rgba(6,182,212,0.6)] hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2" do %>
          <i class="fas fa-sign-in-alt"></i> <span>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦å§‹ã‚ã‚‹</span>
        <% end %>

        <%= link_to root_path, class: "w-full rounded-full border-2 border-white/30 bg-gradient-to-r from-yellow-400 to-orange-500 dark:from-[#2e0f15] dark:to-[#450a0a] text-white dark:text-rose-100 font-bold py-4 px-10 shadow-[0_10px_25px_rgba(245,158,11,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:shadow-[0_0_15px_rgba(244,63,94,0.3)] dark:border-rose-500/50 hover:shadow-[0_15px_35px_rgba(245,158,11,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] dark:hover:shadow-[0_0_25px_rgba(244,63,94,0.6)] hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2" do %>
          <i class="fas fa-play"></i> <span>å†’é™ºã‚’å§‹ã‚ã‚‹</span>
        <% end %>
      <% end %>

      <p class="text-sm text-slate-400 dark:text-slate-500 mt-4">
        TekuMemo - æ¥½ã—ãæ­©ãã€å†’é™ºã™ã‚‹ã€‚
      </p>
    </div>
    </div>
    </div> <!-- End of relative z-10 wrapper -->
  </div>
</div>

<!-- OGPãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="ogp-preview-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" onclick="closeOgpPreview(event)">
  <div class="relative bg-white dark:bg-slate-900/90 rounded-[3.75rem] p-8 max-w-2xl w-full shadow-2xl transform transition-all border-4 border-white dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_50px_rgba(168,85,247,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1)] overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[20%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none" onclick="event.stopPropagation()">
    <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
    <button onclick="closeOgpPreview()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-white transition relative z-20">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>

    <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
    <h3 class="text-lg font-bold text-slate-700 dark:text-white mb-2 flex items-center gap-2 relative z-10">
      <span>ğŸ–¼ï¸</span> ã‚·ã‚§ã‚¢ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    </h3>
    <p class="text-xs text-slate-500 dark:text-slate-400 mb-4 leading-relaxed relative z-10">
      X(Twitter)ãªã©ã§ã‚·ã‚§ã‚¢ã•ã‚ŒãŸæ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ç”»åƒã§ã™ã€‚<br>
      <span class="text-orange-500 dark:text-amber-400">â€»ç”»åƒãŒå¤ã„å ´åˆã¯ã€Œç”»åƒã‚’æœ€æ–°ã«ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</span>
    </p>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ -->
    <div class="relative aspect-[1.91/1] w-full rounded-xl overflow-hidden shadow-lg bg-slate-200 dark:bg-slate-800 z-10">
      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
      <div id="ogp-loading" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-100 dark:bg-slate-800">
        <div class="animate-spin rounded-full h-16 w-16 border-4 border-slate-300 dark:border-slate-600 border-t-purple-600 dark:border-t-fuchsia-500"></div>
        <p class="mt-4 text-sm font-bold text-slate-600 dark:text-slate-300">ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">ç”Ÿæˆã«æ•°ç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</p>
      </div>

      <!-- OGPç”»åƒ -->
      <%= image_tag post_ogp_image_path(@post, format: :jpg, v: Time.current.to_i),
          id: "ogp-preview-image",
          class: "w-full h-full object-cover opacity-0 transition-opacity duration-500",
          alt: "Post OGP Preview",
          onerror: "handleOgpImageError(this)",
          onload: "handleOgpImageLoad()" %>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="mt-4 flex justify-end relative z-10">
      <button onclick="refreshOgpImage()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg transition-colors text-sm font-bold border border-transparent dark:border-white/10">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        ç”»åƒã‚’æœ€æ–°ã«ã™ã‚‹
      </button>
    </div>
  </div>
</div>

<script>
  let retryCount = 0;
  const MAX_RETRIES = 5;

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  function toggleOgpPreview() {
    const modal = document.getElementById('ogp-preview-modal');
    modal.classList.remove('hidden');
    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    setTimeout(() => {
      modal.style.opacity = '1';
    }, 10);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸã¨ãã«ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    retryCount = 0;
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  function closeOgpPreview(event) {
    const modal = document.getElementById('ogp-preview-modal');
    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    modal.style.opacity = '0';
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 200);
  }

  // ç”»åƒã‚’å¼·åˆ¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
  function refreshOgpImage() {
    const img = document.getElementById('ogp-preview-image');
    const loading = document.getElementById('ogp-loading');

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    loading.style.display = 'flex';
    img.classList.remove('opacity-100');
    img.classList.add('opacity-0');

    // ç¾åœ¨ã®srcã‚’å–å¾—ã—ã€refreshãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜ä¸
    const currentSrc = new URL(img.src);
    currentSrc.searchParams.set('refresh', 'true');
    currentSrc.searchParams.set('v', new Date().getTime()); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼

    // ç”»åƒã‚’å†èª­ã¿è¾¼ã¿
    img.src = currentSrc.toString();
  }

  // ç”»åƒã®èª­ã¿è¾¼ã¿æˆåŠŸ
  function handleOgpImageLoad() {
    const loading = document.getElementById('ogp-loading');
    const image = document.getElementById('ogp-preview-image');
    const mainImg = document.getElementById('main-ogp-image');

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã€ç”»åƒã‚’è¡¨ç¤º
    loading.style.display = 'none';
    image.classList.remove('opacity-0');
    image.classList.add('opacity-100');

    // ãƒ¡ã‚¤ãƒ³ç”»åƒã‚‚æ›´æ–°
    if (mainImg) {
      const currentSrc = new URL(mainImg.src);
      currentSrc.searchParams.set('v', new Date().getTime());
      mainImg.src = currentSrc.toString();
    }
  }

  // ç”»åƒã®èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆç”Ÿæˆä¸­ã®å¯èƒ½æ€§ï¼‰
  function handleOgpImageError(img) {
    const loading = document.getElementById('ogp-loading');

    // ã¾ã ãƒªãƒˆãƒ©ã‚¤å›æ•°ãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆ
    if (retryCount < MAX_RETRIES) {
      retryCount++;

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
      const loadingText = loading.querySelector('p.font-bold');
      loadingText.textContent = `ç”»åƒã‚’ç”Ÿæˆä¸­... (${retryCount}/${MAX_RETRIES})`;

      // 2ç§’å¾Œã«ãƒªãƒˆãƒ©ã‚¤
      setTimeout(() => {
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ›´æ–°ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°
        const currentSrc = img.src;
        img.src = currentSrc.replace(/v=\d+/, `v=${Date.now()}`);
      }, 2000);
    } else {
      // ãƒªãƒˆãƒ©ã‚¤ä¸Šé™ã«é”ã—ãŸå ´åˆ
      loading.innerHTML = `
        <div class="text-center">
          <span class="text-4xl">âš ï¸</span>
          <p class="mt-4 text-sm font-bold text-slate-600 dark:text-purple-300">ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
          <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
        </div>
      `;
    }
  }

  // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeOgpPreview();
    }
  });
</script>
