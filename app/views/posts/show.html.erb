<%# OGP設定 %>
<% content_for :head do %>
  <meta property="og:title" content="ADVENTURE LOG - TekuMemo" />
  <meta property="og:description" content="<%= @post.body.present? ? @post.body.truncate(100) : '散歩の記録をチェックしよう！' %>" />
  <%# OGP画像のURLにキャッシュバスターと拡張子を追加 %>
  <meta property="og:image" content="<%= post_ogp_image_url(@post, format: :jpg, v: @post.updated_at.to_i) %>" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="<%= post_url(@post) %>" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ADVENTURE LOG - TekuMemo" />
  <meta name="twitter:description" content="<%= @post.body.present? ? @post.body.truncate(100) : '散歩の記録をチェックしよう！' %>" />
  <meta name="twitter:image" content="<%= post_ogp_image_url(@post, format: :jpg, v: @post.updated_at.to_i) %>" />
<% end %>

<div class="container mx-auto px-4 py-8 min-h-screen flex items-center justify-center">
  <div class="relative max-w-2xl w-full bg-[#fdfbf7] dark:bg-[#1a0b2e] rounded-[2.5rem] shadow-[20px_20px_60px_rgba(168,85,247,0.2),-20px_-20px_60px_rgba(255,255,255,0.8),inset_-5px_-5px_15px_rgba(168,85,247,0.05),inset_5px_5px_15px_rgba(255,255,255,0.9),inset_2px_2px_0px_rgba(168,85,247,0.3)] dark:shadow-[0_0_20px_rgba(168,85,247,0.4)] overflow-hidden border-2 border-white/60 dark:border-purple-500/30 p-8">
    <!-- Candy Texture & Orbs (Light Mode Only) -->
    <div class="absolute inset-0 bg-gradient-to-br from-white/80 via-white/40 to-transparent pointer-events-none dark:hidden"></div>
    <div class="absolute -top-10 -right-10 w-40 h-40 bg-gradient-to-br from-purple-400/20 to-pink-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>
    <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-gradient-to-br from-blue-400/20 to-cyan-400/20 rounded-full blur-2xl pointer-events-none dark:hidden"></div>

    <div class="relative z-10">
      <!-- 戻るボタン -->
      <div class="mb-4">
      <% back_path = user_signed_in? ? posts_path : root_path %>
      <% back_text = user_signed_in? ? "タイムラインに戻る" : "トップページに戻る" %>
      <%= link_to back_path, class: "inline-flex items-center gap-2 text-slate-600 dark:text-purple-300 hover:text-purple-600 dark:hover:text-purple-200 transition font-bold" do %>
        <span class="material-symbols-outlined">arrow_back</span>
        <span class="text-sm"><%= back_text %></span>
      <% end %>
    </div>

    <h1 class="text-3xl font-bold mb-6 text-center text-slate-800 dark:text-purple-100">冒険の記録</h1>

    <div class="mb-8 relative group" data-controller="ogp-preview">
      <div class="absolute -inset-1 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>

      <!-- Loading State -->
      <div data-ogp-preview-target="loading" class="absolute inset-0 z-20 flex items-center justify-center bg-slate-100/50 dark:bg-slate-900/50 backdrop-blur-sm rounded-[2rem] hidden">
         <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-300 dark:border-slate-600 border-t-purple-600 dark:border-t-fuchsia-500"></div>
      </div>

      <img id="main-ogp-image"
           data-ogp-preview-target="image"
           data-action="load->ogp-preview#handleLoad error->ogp-preview#handleError"
           src="<%= post_ogp_image_url(@post, format: :jpg) %>"
           alt="Adventure Log"
           class="relative w-full rounded-[2rem] shadow-[0_10px_30px_rgba(0,0,0,0.1)] dark:shadow-none transform transition duration-500 hover:scale-[1.02] border-4 border-white/50 dark:border-transparent">
    </div>

    <!-- シェア画像プレビューリンク（小） -->
    <div class="mt-[-20px] mb-8 text-center relative z-10">
      <button onclick="document.dispatchEvent(new CustomEvent('ogp:open'))" class="text-xs text-slate-500 dark:text-slate-400 hover:text-purple-600 dark:hover:text-fuchsia-300 underline transition">
        📷 シェア画像を確認・更新
      </button>
    </div>

    <% if @post.body.present? %>
      <p class="text-lg text-slate-600 dark:text-slate-300 mb-8 text-center font-medium leading-relaxed break-words">
        "<%= @post.body %>"
      </p>
    <% end %>

    <div class="text-center space-y-4 max-w-md mx-auto">
      <% if @post.user_id == current_user&.id %>
        <%= link_to share_post_on_twitter_url(@post),
            target: "_blank",
            rel: "noopener noreferrer",
            class: "w-full rounded-full border-2 border-white/30 bg-black text-white font-bold py-3 px-8 shadow-[0_10px_25px_rgba(0,0,0,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] hover:shadow-[0_15px_35px_rgba(0,0,0,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] hover:-translate-y-1 transition-all duration-300 mb-4 flex items-center justify-center gap-2" do %>
          <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
          でシェアする
        <% end %>
        <br>
      <% end %>

      <% if user_signed_in? %>
        <%= link_to posts_path, class: "w-full rounded-full border-2 border-white/30 dark:border-cyan-500/50 bg-gradient-to-r from-cyan-500 to-blue-500 dark:from-[#0f172a] dark:to-[#1e3a8a] text-white dark:text-cyan-100 font-bold py-4 px-10 shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.15),inset_2px_2px_5px_rgba(255,255,255,0.3),0_10px_25px_rgba(6,182,212,0.4)] dark:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.3),inset_2px_2px_5px_rgba(255,255,255,0.2),0_0_20px_rgba(6,182,212,0.4)] hover:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.15),inset_2px_2px_5px_rgba(255,255,255,0.3),0_15px_35px_rgba(6,182,212,0.6)] dark:hover:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.3),inset_2px_2px_5px_rgba(255,255,255,0.2),0_0_40px_rgba(6,182,212,0.6)] hover:-translate-y-1 active:scale-95 transition-all duration-300 flex items-center justify-center gap-2" do %>
          <i class="fas fa-list"></i> <span>タイムラインを見る</span>
        <% end %>

        <%= link_to root_path, class: "w-full rounded-full border-2 border-white/30 dark:border-rose-500/50 bg-gradient-to-r from-rose-500 to-red-500 dark:from-[#2e0f15] dark:to-[#450a0a] text-white dark:text-rose-100 font-bold py-4 px-10 shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.15),inset_2px_2px_5px_rgba(255,255,255,0.3),0_10px_25px_rgba(244,63,94,0.4)] dark:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.3),inset_2px_2px_5px_rgba(255,255,255,0.2),0_0_20px_rgba(244,63,94,0.4)] hover:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.15),inset_2px_2px_5px_rgba(255,255,255,0.3),0_15px_35px_rgba(244,63,94,0.6)] dark:hover:shadow-[inset_-2px_-2px_5px_rgba(0,0,0,0.3),inset_2px_2px_5px_rgba(255,255,255,0.2),0_0_40px_rgba(244,63,94,0.6)] hover:-translate-y-1 active:scale-95 transition-all duration-300 flex items-center justify-center gap-2" do %>
          <i class="fas fa-home"></i> <span>ホームに戻る</span>
        <% end %>
      <% else %>
        <%= link_to new_user_session_path, class: "w-full rounded-full border-2 border-white/30 bg-gradient-to-r from-purple-500 to-pink-500 dark:from-[#0f172a] dark:to-[#1e3a8a] text-white dark:text-cyan-100 font-bold py-4 px-10 shadow-[0_10px_25px_rgba(168,85,247,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:shadow-[0_0_15px_rgba(6,182,212,0.3)] dark:border-cyan-500/50 hover:shadow-[0_15px_35px_rgba(168,85,247,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] dark:hover:shadow-[0_0_25px_rgba(6,182,212,0.6)] hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2" do %>
          <i class="fas fa-sign-in-alt"></i> <span>ログインして始める</span>
        <% end %>

        <%= link_to root_path, class: "w-full rounded-full border-2 border-white/30 bg-gradient-to-r from-yellow-400 to-orange-500 dark:from-[#2e0f15] dark:to-[#450a0a] text-white dark:text-rose-100 font-bold py-4 px-10 shadow-[0_10px_25px_rgba(245,158,11,0.4),inset_0_1px_0_rgba(255,255,255,0.4)] dark:shadow-[0_0_15px_rgba(244,63,94,0.3)] dark:border-rose-500/50 hover:shadow-[0_15px_35px_rgba(245,158,11,0.6),inset_0_1px_0_rgba(255,255,255,0.6)] dark:hover:shadow-[0_0_25px_rgba(244,63,94,0.6)] hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2" do %>
          <i class="fas fa-play"></i> <span>冒険を始める</span>
        <% end %>
      <% end %>

      <p class="text-sm text-slate-400 dark:text-slate-500 mt-4">
        TekuMemo - 楽しく歩く、冒険する。
      </p>
    </div>
    </div>
    </div> <!-- End of relative z-10 wrapper -->
  </div>
</div>

<!-- OGPプレビューモーダル -->
<div id="ogp-preview-modal"
     data-controller="ogp-preview"
     data-ogp-preview-target="modal"
     class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-200 opacity-0"
     data-action="click->ogp-preview#closeBackground">

  <div data-ogp-preview-target="container"
       class="relative bg-white dark:bg-slate-900/90 rounded-[3.75rem] p-8 max-w-2xl w-full shadow-2xl transform transition-all border-4 border-white dark:border-white/10 dark:border-t-white/40 dark:shadow-[0_0_50px_rgba(168,85,247,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1)] overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[20%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none">

    <!-- 閉じるボタン -->
    <button data-action="click->ogp-preview#close" class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 hover:text-slate-700 dark:bg-white/10 dark:hover:bg-white/20 dark:text-gray-300 dark:hover:text-white transition-all duration-200 z-50 shadow-md hover:shadow-lg hover:scale-110 active:scale-95">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>

    <!-- タイトル -->
    <h3 class="text-lg font-bold text-slate-700 dark:text-white mb-2 flex items-center gap-2 relative z-10 pr-12">
      <span>🖼️</span> シェア画像プレビュー
    </h3>
    <p class="text-xs text-slate-500 dark:text-slate-400 mb-4 leading-relaxed relative z-10 pr-12">
      X(Twitter)などでシェアされた時に表示される画像です。<br>
      <span class="text-orange-500 dark:text-amber-400">※画像が古い場合は「画像を最新にする」を押してください。</span>
    </p>

    <!-- プレビュー画像 -->
    <div class="relative aspect-[1.91/1] w-full rounded-xl overflow-hidden shadow-lg bg-slate-200 dark:bg-slate-800 z-10">
      <!-- ローディング表示 -->
      <div data-ogp-preview-target="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-100 dark:bg-slate-800">
        <div class="animate-spin rounded-full h-16 w-16 border-4 border-slate-300 dark:border-slate-600 border-t-purple-600 dark:border-t-fuchsia-500"></div>
        <p class="mt-4 text-sm font-bold text-slate-600 dark:text-slate-300">画像を読み込み中...</p>
        <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">生成に数秒かかる場合があります</p>
      </div>

      <!-- OGP画像 -->
      <%= image_tag post_ogp_image_path(@post, format: :jpg, v: Time.current.to_i),
          data: {
            ogp_preview_target: "image",
            action: "error->ogp-preview#handleError load->ogp-preview#handleLoad"
          },
          class: "w-full h-full object-cover opacity-0 transition-opacity duration-500",
          alt: "Post OGP Preview" %>
    </div>

    <!-- アクションボタン -->
    <div class="mt-4 flex justify-end relative z-10">
      <button data-action="click->ogp-preview#refresh" class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-lg transition-colors text-sm font-bold border border-transparent dark:border-white/10">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        画像を最新にする
      </button>
    </div>
  </div>
</div>
