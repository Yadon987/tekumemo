<!-- app/views/posts/_reactions.html.erb -->
<!-- 投稿に対するリアクションボタン群を表示 -->

<div id="post_<%= post.id %>_reactions" class="flex gap-3 mt-3 items-start">
  <!-- ========================================
       事前準備：N+1問題を回避するため、一度だけデータを整理
       ======================================== -->

  <!-- 自分がつけたリアクションのスタンプをSetで保持（高速な検索用） -->
  <% my_reaction_stamps = post.reactions
                             .select { |r| r.user_id == current_user.id }
                             .map(&:stamp)
                             .to_set %>

  <!-- リアクションのスタンプごとの件数をハッシュで保持 -->
  <% reaction_counts = post.reactions
                           .group_by(&:stamp)
                           .transform_values(&:count) %>

  <!-- ========================================
       左側：追加ボタン（固定）
       ======================================== -->
  <div class="relative shrink-0" data-controller="popover">
    <!-- トリガーボタン -->
    <button type="button"
            data-action="click->popover#toggle"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-white/50 dark:bg-slate-700/50 text-gray-400 dark:text-gray-500 border border-white/60 dark:border-gray-600 hover:bg-white dark:hover:bg-slate-600 hover:text-gray-600 dark:hover:text-gray-300 transition-all shadow-[inset_2px_2px_5px_rgba(255,255,255,0.8),inset_-2px_-2px_5px_rgba(0,0,0,0.05)] dark:shadow-inner"
            title="リアクションを追加">
      <span class="material-symbols-outlined text-xl">add_reaction</span>
    </button>

    <!-- ピッカー（吹き出し） -->
    <div data-popover-target="content"
         class="hidden absolute bottom-full left-0 mb-2 p-4 bg-white/95 dark:bg-slate-800/95 backdrop-blur-md rounded-[2rem] shadow-[10px_10px_30px_rgba(0,0,0,0.1),-10px_-10px_30px_rgba(255,255,255,0.8)] dark:shadow-xl border border-white/60 dark:border-gray-700 w-64 z-30 animate-fade-in-up origin-bottom-left">
      <div class="grid grid-cols-4 gap-2">
        <% Reaction.all_stamps.each do |reaction_info| %>
          <% stamp = reaction_info[:stamp] %>
          <% is_reacted = my_reaction_stamps.include?(stamp) %>
          <% count = reaction_counts[stamp] || 0 %>

          <button type="button"
                  id="picker-btn-<%= post.id %>-<%= stamp %>"
                  class="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-700 transition-colors flex flex-col items-center justify-center group <%= is_reacted ? 'bg-blue-50 dark:bg-blue-900/20' : '' %>"
                  data-action="click->popover#close"
                  onclick="document.getElementById('reaction-btn-<%= post.id %>-<%= stamp %>').click();">
            <span class="text-2xl group-hover:scale-125 transition-transform duration-200"><%= reaction_info[:emoji] %></span>
            <span class="text-[10px] text-gray-500 dark:text-gray-400 mt-1"><%= reaction_info[:label] %></span>
          </button>
        <% end %>
      </div>
    </div>
  </div>

  <!-- ========================================
       右側：スタンプ一覧（横スクロール）
       ======================================== -->
  <div data-controller="scroll-drag" class="flex overflow-x-auto gap-1.5 scrollbar-hide [&::-webkit-scrollbar]:hidden items-center py-1 pr-4 mask-image-linear-gradient">
    <% Reaction.all_stamps.each do |reaction_info| %>
      <% stamp = reaction_info[:stamp] %>
      <% count = reaction_counts[stamp] || 0 %>
      <% is_reacted = my_reaction_stamps.include?(stamp) %>

      <%# カウントが0かつ未リアクションの場合はhiddenクラスで隠す %>
      <% is_hidden = count == 0 && !is_reacted %>

      <% button_class = if is_reacted
                          "reaction-btn flex-shrink-0 flex items-center gap-1 px-3 h-8 rounded-full bg-blue-50 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300 border border-blue-200 dark:border-blue-500/50 hover:bg-blue-100 dark:hover:bg-blue-800/50 transition transform active:scale-95 shadow-[2px_2px_5px_rgba(0,0,0,0.1),-2px_-2px_5px_rgba(255,255,255,0.8)] dark:shadow-none"
                        else
                          "reaction-btn flex-shrink-0 flex items-center gap-1 px-3 h-8 rounded-full bg-white/50 dark:bg-white/5 text-gray-600 dark:text-gray-300 border border-white/60 dark:border-white/10 hover:bg-white dark:hover:bg-white/10 transition transform active:scale-95 shadow-[inset_2px_2px_5px_rgba(255,255,255,0.8),inset_-2px_-2px_5px_rgba(0,0,0,0.05)] dark:shadow-none"
                        end %>

      <%# hiddenクラスを追加 %>
      <% button_class += " hidden" if is_hidden %>

      <button type="button"
              id="reaction-btn-<%= post.id %>-<%= stamp %>"
              class="<%= button_class %>"
              data-controller="reaction"
              data-action="click->reaction#toggle"
              data-reaction-target="button"
              data-reaction-url-value="<%= post_reactions_path(post) %>"
              data-reaction-stamp-value="<%= stamp %>"
              data-reaction-count-value="<%= count %>"
              data-reaction-reacted-value="<%= is_reacted %>">

        <span class="text-base transition-transform duration-200" data-reaction-target="emoji"><%= reaction_info[:emoji] %></span>
        <span class="text-xs font-bold" data-reaction-target="count"><%= count %></span>
      </button>
    <% end %>
  </div>
</div>
