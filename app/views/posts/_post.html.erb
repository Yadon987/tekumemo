<%# app/views/posts/_post.html.erb %>
<%# Claymorphism Style: Colorful, Pop, Tactile, Deep %>

<%# 強度スコアに基づく配色ロジック（高スコア＝Vivid, 低スコア＝Pastel） %>
<%
   # 1. 各要素の強度スコアを定義（同点なし）
   weather_scores = {
     'stormy' => 9,    # 嵐：最強（Vivid Purple）
     'snowy' => 6,     # 雪：強い（Bright Sky）
     'sunny' => 5,     # 晴れ：中強（Bright Orange）
     'rainy' => 4,     # 雨：中弱（Soft Blue）
     'cloudy' => 1     # 曇り：弱い（Soft Gray）
   }

   feeling_scores = {
     'exhausted' => 8, # ヘトヘト：最強（Vivid Rose）
     'great' => 7,     # 最高：強い（Bright Yellow）
     'tired' => 3,     # 疲れた：中弱（Soft Slate）
     'good' => 2,      # 良い：弱い（Soft Lime）
     'normal' => 0     # 普通：最弱（Soft Stone）
   }

   # 2. 現在の投稿のスコアを取得
   w_score = weather_scores[post.weather] || 0
   f_score = feeling_scores[post.feeling] || 0

   # 3. スコア比較で勝者を決定
   winner = if w_score > f_score
              { type: 'weather', key: post.weather, score: w_score }
            elsif f_score > w_score
              { type: 'feeling', key: post.feeling, score: f_score }
            else
              # 万が一同点なら天気を優先
              { type: 'weather', key: post.weather, score: w_score }
            end

   # 4. 勝者に基づいたカラーテーマ定義
   # Light: Claymorphism (Puni-Puni)
   # Dark: Neon Noir / Synthwave (Atmospheric Glow)

   color_theme = case winner[:key]
   # === Lv.High (Ultraviolet & Hot Pink) ===
   when 'stormy'    then {
     bg: 'bg-[#faf5ff] dark:bg-[#1a0b2e]/90',
     border: 'border-purple-100/50 dark:border-purple-500/50',
     text: 'text-purple-800 dark:text-purple-200',
     inner_bg: 'bg-purple-50/50 dark:bg-purple-900/30',
     shadow: 'shadow-[8px_8px_16px_rgba(168,85,247,0.15),-8px_-8px_16px_rgba(255,255,255,0.8)] dark:shadow-[0_0_30px_rgba(168,85,247,0.4),inset_0_0_20px_rgba(168,85,247,0.1)]'
   }
   when 'exhausted' then {
     bg: 'bg-[#fff1f2] dark:bg-[#2e0b16]/90',
     border: 'border-rose-100/50 dark:border-rose-500/50',
     text: 'text-rose-800 dark:text-rose-200',
     inner_bg: 'bg-rose-50/50 dark:bg-rose-900/30',
     shadow: 'shadow-[8px_8px_16px_rgba(244,63,94,0.15),-8px_-8px_16px_rgba(255,255,255,0.8)] dark:shadow-[0_0_30px_rgba(244,63,94,0.4),inset_0_0_20px_rgba(244,63,94,0.1)]'
   }

   # === Lv.Mid (Sunset Gradient Glow) ===
   when 'great'     then {
     bg: 'bg-[#fffbeb] dark:bg-[#2e200b]/90',
     border: 'border-yellow-100/50 dark:border-yellow-500/50',
     text: 'text-yellow-700 dark:text-yellow-200',
     inner_bg: 'bg-yellow-50/50 dark:bg-yellow-900/30',
     shadow: 'shadow-[8px_8px_16px_rgba(234,179,8,0.15),-8px_-8px_16px_rgba(255,255,255,0.8)] dark:shadow-[0_0_30px_rgba(234,179,8,0.3),inset_0_0_20px_rgba(234,179,8,0.1)]'
   }
   when 'snowy'     then {
     bg: 'bg-[#f0f9ff] dark:bg-[#0b1e2e]/90',
     border: 'border-sky-100/50 dark:border-cyan-400/50',
     text: 'text-sky-700 dark:text-cyan-200',
     inner_bg: 'bg-sky-50/50 dark:bg-cyan-900/30',
     shadow: 'shadow-[8px_8px_16px_rgba(14,165,233,0.15),-8px_-8px_16px_rgba(255,255,255,0.8)] dark:shadow-[0_0_30px_rgba(34,211,238,0.4),inset_0_0_20px_rgba(34,211,238,0.1)]'
   }
   when 'sunny'     then {
     bg: 'bg-[#fff7ed] dark:bg-[#2e150b]/90',
     border: 'border-orange-100/50 dark:border-orange-500/50',
     text: 'text-orange-700 dark:text-orange-200',
     inner_bg: 'bg-orange-50/50 dark:bg-orange-900/30',
     shadow: 'shadow-[8px_8px_16px_rgba(249,115,22,0.15),-8px_-8px_16px_rgba(255,255,255,0.8)] dark:shadow-[0_0_30px_rgba(249,115,22,0.4),inset_0_0_20px_rgba(249,115,22,0.1)]'
   }

   # === Lv.Low (Midnight Blue Glow) ===
   when 'rainy'     then {
     bg: 'bg-[#eff6ff] dark:bg-[#0b102e]/90',
     border: 'border-blue-100/50 dark:border-blue-500/50',
     text: 'text-blue-600 dark:text-blue-200',
     inner_bg: 'bg-blue-50/50 dark:bg-blue-900/30',
     shadow: 'shadow-[8px_8px_16px_rgba(59,130,246,0.1),-8px_-8px_16px_rgba(255,255,255,0.8)] dark:shadow-[0_0_30px_rgba(59,130,246,0.3),inset_0_0_20px_rgba(59,130,246,0.1)]'
   }
   when 'tired'     then {
     bg: 'bg-[#f8fafc] dark:bg-[#0f172a]/90',
     border: 'border-slate-100/50 dark:border-slate-500/50',
     text: 'text-slate-600 dark:text-slate-300',
     inner_bg: 'bg-slate-50/50 dark:bg-slate-800/50',
     shadow: 'shadow-[8px_8px_16px_rgba(100,116,139,0.1),-8px_-8px_16px_rgba(255,255,255,0.8)] dark:shadow-[0_0_20px_rgba(148,163,184,0.2),inset_0_0_10px_rgba(148,163,184,0.05)]'
   }
   when 'good'      then {
     bg: 'bg-[#f7fee7] dark:bg-[#142e0b]/90',
     border: 'border-lime-100/50 dark:border-lime-500/50',
     text: 'text-lime-600 dark:text-lime-200',
     inner_bg: 'bg-lime-50/50 dark:bg-lime-900/30',
     shadow: 'shadow-[8px_8px_16px_rgba(132,204,22,0.1),-8px_-8px_16px_rgba(255,255,255,0.8)] dark:shadow-[0_0_30px_rgba(132,204,22,0.3),inset_0_0_20px_rgba(132,204,22,0.1)]'
   }
   when 'cloudy'    then {
     bg: 'bg-[#f9fafb] dark:bg-[#111827]/90',
     border: 'border-gray-100/50 dark:border-gray-600/50',
     text: 'text-gray-500 dark:text-gray-300',
     inner_bg: 'bg-gray-50/50 dark:bg-gray-800/50',
     shadow: 'shadow-[8px_8px_16px_rgba(107,114,128,0.1),-8px_-8px_16px_rgba(255,255,255,0.8)] dark:shadow-[0_0_20px_rgba(156,163,175,0.2),inset_0_0_10px_rgba(156,163,175,0.05)]'
   }

   # === Default ===
   else                  {
     bg: 'bg-[#fafaf9] dark:bg-[#1c1917]/90',
     border: 'border-stone-100/50 dark:border-stone-600/50',
     text: 'text-stone-500 dark:text-stone-300',
     inner_bg: 'bg-stone-50/50 dark:bg-stone-900/50',
     shadow: 'shadow-[8px_8px_16px_rgba(166,175,195,0.4),-8px_-8px_16px_rgba(255,255,255,0.8)] dark:shadow-[0_0_20px_rgba(168,162,158,0.2),inset_0_0_10px_rgba(168,162,158,0.05)]'
   }
   end
%>

<div id="<%= dom_id post %>"
     class="group relative mb-8 p-6 rounded-[2.5rem] transition-all duration-300 hover:-translate-y-2
            <%= color_theme[:bg] %> border-4 dark:border-2 <%= color_theme[:border] %> <%= color_theme[:shadow] %> backdrop-blur-md">

  <!-- ダークモード用の装飾（Synthwave Sun / Grid） -->
  <div class="absolute inset-0 rounded-[2.5rem] pointer-events-none overflow-hidden">
    <!-- 上部の淡いグラデーション -->
    <div class="hidden dark:block absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/5 to-transparent"></div>
    <!-- 下部のグリッドライン（Synthwave風） -->
    <div class="hidden dark:block absolute bottom-0 left-0 w-full h-1/3 bg-[linear-gradient(to_top,rgba(255,255,255,0.05)_1px,transparent_1px)] bg-[size:100%_10px]"></div>
  </div>

  <!-- コンテンツラッパー -->
  <div class="relative z-10">
    <!-- ヘッダー：ユーザー情報 -->
    <div class="flex justify-between items-start mb-4">
      <div class="flex items-center gap-4">
        <!-- アバター -->
        <div class="w-14 h-14 rounded-2xl flex items-center justify-center overflow-hidden border-4 border-white dark:border-white/10 transform group-hover:rotate-6 transition-transform duration-300 shadow-md dark:shadow-[0_0_15px_rgba(255,255,255,0.2)]">
          <% if post.user.avatar_url.present? %>
            <%= image_tag post.user.avatar_url, class: "w-full h-full object-cover", alt: post.user.name %>
          <% else %>
            <span class="text-xl font-black text-gray-400 dark:text-gray-400">
              <%= post.user.name[0].upcase %>
            </span>
          <% end %>
        </div>

        <div>
          <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg tracking-wide dark:drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">
            <%= post.user.name %>
          </h3>
          <div class="flex items-center gap-2 mt-1">
            <span class="text-xs font-bold px-3 py-1 rounded-full bg-white/60 dark:bg-white/10 text-gray-500 dark:text-gray-300 backdrop-blur-sm shadow-sm dark:shadow-none dark:border dark:border-white/10">
              <%= time_ago_in_words(post.created_at) %>前
            </span>
          </div>
        </div>
      </div>

      <!-- 削除ボタン -->
      <% if post.user == current_user %>
        <div class="absolute top-0 right-0">
          <%= link_to post_path(post),
              data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
              class: "flex items-center justify-center w-12 h-12 rounded-full text-gray-400 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400 transition-all duration-300 transform hover:-translate-y-1 active:translate-y-0 active:scale-95 group/btn border border-white/60 dark:border-white/10 dark:hover:border-red-500/50 dark:hover:shadow-[0_0_15px_rgba(248,113,113,0.6)]",
              style: "background: var(--btn-bg, radial-gradient(circle at 30% 30%, #ffffff, #e2e8f0));
                      box-shadow: var(--btn-shadow, 6px 6px 12px rgba(166,175,195,0.4), -6px -6px 12px rgba(255,255,255,0.9), inset 2px 2px 5px rgba(255,255,255,1), inset -2px -2px 5px rgba(166,175,195,0.2));",
              title: "投稿を削除" do %>
            <style>
              .dark .group\/btn {
                background: rgba(255,255,255,0.05) !important;
                box-shadow: none !important;
              }
            </style>
            <span class="material-symbols-outlined text-xl font-bold drop-shadow-sm group-hover/btn:text-red-500 transition-colors">delete</span>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- 投稿本文エリア -->
    <div class="mb-5 px-1">
      <% if post.body.present? %>
        <!-- パターンA: 本文がある場合 -->
        <div class="flex flex-wrap gap-2 mb-3">
          <% if post.weather %>
            <span class="inline-flex items-center justify-center h-10 gap-2 px-4 rounded-2xl bg-white/70 dark:bg-white/5 text-sky-600 dark:text-cyan-300 text-sm font-bold shadow-sm dark:shadow-[0_0_10px_rgba(34,211,238,0.2)] border border-white/50 dark:border-white/10 hover:scale-105 transition-transform cursor-default">
              <span class="text-xl leading-none"><%= post.weather_emoji %></span>
              <span><%= post.weather_label %></span>
            </span>
          <% end %>
          <% if post.feeling %>
            <span class="inline-flex items-center justify-center h-10 gap-2 px-4 rounded-2xl bg-white/70 dark:bg-white/5 <%= color_theme[:text] %> text-sm font-bold shadow-sm dark:shadow-[0_0_10px_rgba(255,255,255,0.1)] border border-white/50 dark:border-white/10 hover:scale-105 transition-transform cursor-default">
              <span class="text-xl leading-none"><%= post.feeling_emoji %></span>
              <span><%= post.feeling_label %></span>
            </span>
          <% end %>
        </div>

        <!-- 本文 -->
        <div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-200 leading-relaxed font-medium text-base p-5 rounded-3xl <%= color_theme[:inner_bg] %> shadow-inner dark:shadow-none border border-black/5 dark:border-white/5">
          <%= simple_format(post.body) %>
        </div>

      <% else %>
        <!-- パターンB: 本文がない場合 -->
        <div class="flex justify-center items-center gap-8 py-6">
          <% if post.weather %>
            <div class="flex flex-col items-center animate-bounce-slow group/icon cursor-default">
              <span class="text-7xl drop-shadow-md dark:drop-shadow-[0_0_20px_rgba(255,255,255,0.4)] mb-2 transform transition-transform group-hover/icon:scale-110"><%= post.weather_emoji %></span>
              <span class="text-sm font-bold text-gray-500 dark:text-cyan-300 bg-white/50 dark:bg-white/5 px-3 py-1 rounded-full backdrop-blur-sm dark:border dark:border-white/10"><%= post.weather_label %></span>
            </div>
          <% end %>

          <% if post.feeling %>
            <div class="flex flex-col items-center animate-pulse-slow group/icon cursor-default">
              <span class="text-7xl drop-shadow-md dark:drop-shadow-[0_0_20px_rgba(255,255,255,0.4)] mb-2 transform transition-transform group-hover/icon:scale-110"><%= post.feeling_emoji %></span>
              <span class="text-sm font-bold <%= color_theme[:text] %> bg-white/50 dark:bg-white/5 px-3 py-1 rounded-full backdrop-blur-sm dark:border dark:border-white/10"><%= post.feeling_label %></span>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- リアクションエリア -->
    <div class="pt-3 px-4 pb-3 -mx-2 rounded-2xl bg-white/40 dark:bg-black/20 border border-white/40 dark:border-white/5 shadow-inner dark:shadow-none">
      <%= render "posts/reactions", post: post %>
    </div>
  </div>
</div>
