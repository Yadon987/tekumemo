<%# app/views/posts/_post.html.erb %>
<%# Claymorphism Style: Colorful, Pop, Tactile, Deep %>

<%# 強度スコアに基づく配色ロジック（高スコア＝Vivid, 低スコア＝Pastel） %>
<%# 強度スコアに基づく配色ロジック（高スコア＝Vivid, 低スコア＝Pastel） %>
<% color_theme = post_color_theme(post) %>

<div id="<%= dom_id post %>"
     class="group relative mb-8 p-6 rounded-[3.75rem] transition-all duration-300 hover:-translate-y-2
            <%= color_theme[:bg] %> border border-white/40 dark:border-purple-500/30 dark:border-t-white/40 shadow-clay-card dark:shadow-[0_0_20px_rgba(168,85,247,0.2),inset_0_0_0_1px_rgba(255,255,255,0.1),inset_0_1px_0_rgba(255,255,255,0.3)] backdrop-blur-md hover:shadow-xl overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[45%] before:bg-gradient-to-b before:from-white/40 before:to-transparent before:rounded-t-[3.75rem] before:pointer-events-none before:animate-pulse">

  <!-- ダークモード用の装飾（Synthwave Sun / Grid） -->
  <div class="absolute inset-0 rounded-[3.75rem] pointer-events-none overflow-hidden">
    <!-- 上部の淡いグラデーション -->
    <div class="hidden dark:block absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/5 to-transparent"></div>
    <!-- 下部のグリッドライン（Synthwave風） -->
    <div class="hidden dark:block absolute bottom-0 left-0 w-full h-1/4 bg-[linear-gradient(to_top,rgba(255,255,255,0.05)_1px,transparent_1px)] bg-[size:100%_10px]"></div>
  </div>

  <%# 自分の投稿の場合、詳細ページへのリンクを全体に配置 %>
  <% if post.user_id == current_user&.id %>
    <%= link_to post_path(post), class: "absolute inset-0 z-0 rounded-[3.75rem] focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-purple-500/50", aria: { label: "詳細を見る" } do %>
      <span class="sr-only">詳細を見る</span>
    <% end %>
  <% end %>

  <!-- コンテンツラッパー -->
  <div class="relative z-10 pointer-events-none">
    <!-- リンクを無効化しないように、インタラクティブな要素だけ pointer-events-auto にする -->
    <!-- ヘッダー：ユーザー情報 -->
    <div class="flex justify-between items-start mb-4">
      <div class="flex items-center gap-4">
        <!-- アバター -->
        <div class="w-14 h-14 rounded-full flex items-center justify-center overflow-hidden border-4 border-white dark:border-white/10 transform group-hover:rotate-6 transition-transform duration-300 shadow-md dark:shadow-[0_0_15px_rgba(255,255,255,0.2)] relative z-10">
          <% if post.user.avatar_url.present? && post.user.use_google_avatar %>
            <%= image_tag post.user.avatar_url, class: "w-full h-full object-cover", alt: post.user.name %>
          <% else %>
            <span class="text-xl font-black text-gray-400 dark:text-gray-400">
              <%= post.user.name[0].upcase %>
            </span>
          <% end %>
        </div>

        <div>
          <h3 class="font-bold text-gray-800 dark:text-gray-100 text-lg tracking-wide dark:drop-shadow-[0_0_5px_rgba(255,255,255,0.5)]">
            <%= post.user.name %>
          </h3>
          <div class="flex items-center gap-2 mt-1">
            <span class="text-xs font-bold px-3 py-1 rounded-full bg-white/60 dark:bg-white/10 text-gray-500 dark:text-gray-300 backdrop-blur-sm shadow-sm dark:shadow-none dark:border dark:border-white/10">
              <%= time_ago_in_words(post.created_at) %>前
            </span>
          </div>
        </div>
      </div>

      <!-- 削除ボタン -->
      <% if post.user_id == current_user&.id %>
        <div class="absolute top-0 right-0">
          <%= link_to post_path(post),
              data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
              class: "pointer-events-auto flex items-center justify-center w-12 h-12 rounded-full text-gray-400 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400 transition-all duration-300 transform hover:-translate-y-1 active:translate-y-0 active:scale-95 group/btn border border-white/60 dark:border-white/10 dark:hover:border-red-500/50 dark:hover:shadow-[0_0_15px_rgba(248,113,113,0.6)] relative z-20",
              style: "background: var(--btn-bg, radial-gradient(circle at 30% 30%, #ffffff, #e2e8f0));
                      box-shadow: var(--btn-shadow, 6px 6px 12px rgba(166,175,195,0.4), -6px -6px 12px rgba(255,255,255,0.9), inset 2px 2px 5px rgba(255,255,255,1), inset -2px -2px 5px rgba(166,175,195,0.2));",
              title: "投稿を削除" do %>
            <style>
              .dark .group\/btn {
                background: rgba(255,255,255,0.05) !important;
                box-shadow: none !important;
              }
            </style>
            <span class="material-symbols-outlined text-xl font-bold drop-shadow-sm group-hover/btn:text-red-500 transition-colors">delete</span>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- 投稿本文エリア -->
    <div class="mb-0 px-1">
      <% if post.body.present? %>
        <!-- パターンA: 本文がある場合 -->
        <div class="flex flex-wrap gap-2 mb-3">
          <% if post.weather %>
            <span class="inline-flex items-center justify-center h-10 gap-2 px-4 rounded-[1.25rem] bg-white/70 dark:bg-white/5 text-sky-600 dark:!text-transparent dark:!bg-clip-text dark:bg-gradient-to-br dark:from-cyan-300 dark:to-blue-300 text-sm font-bold shadow-sm dark:shadow-[0_0_10px_rgba(34,211,238,0.2)] border border-white/50 dark:border-white/10 hover:scale-105 transition-transform cursor-default relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[1.25rem] before:pointer-events-none">
              <span class="text-xl leading-none"><%= post.weather_emoji %></span>
              <span><%= post.weather_label %></span>
            </span>
          <% end %>
          <% if post.feeling %>
            <span class="inline-flex items-center justify-center h-10 gap-2 px-4 rounded-[1.25rem] bg-white/70 dark:bg-white/5 <%= color_theme[:text] %> text-sm font-bold shadow-sm dark:shadow-[0_0_10px_rgba(255,255,255,0.1)] border border-white/50 dark:border-white/10 hover:scale-105 transition-transform cursor-default relative overflow-hidden before:absolute before:inset-x-0 before:top-0 before:h-[50%] before:bg-gradient-to-b before:from-white/10 before:to-transparent before:rounded-t-[1.25rem] before:pointer-events-none">
              <span class="text-xl leading-none"><%= post.feeling_emoji %></span>
              <span><%= post.feeling_label %></span>
            </span>
          <% end %>
        </div>

        <!-- 本文 -->
        <div class="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-200 leading-relaxed font-medium text-base p-5 rounded-[2rem] <%= color_theme[:inner_bg] %> shadow-inner dark:shadow-none border border-black/5 dark:border-white/5 relative z-10">
          <%= simple_format(post.body) %>
        </div>

      <% else %>
        <!-- パターンB: 本文がない場合 -->
        <div class="flex justify-center items-center gap-8 py-2">
          <% if post.weather %>
            <div class="flex flex-col items-center animate-bounce-slow group/icon cursor-default">
              <span class="text-7xl drop-shadow-md dark:drop-shadow-[0_0_20px_rgba(255,255,255,0.4)] mb-2 transform transition-transform group-hover/icon:scale-110"><%= post.weather_emoji %></span>
              <span class="text-sm font-bold text-gray-500 dark:text-cyan-300 bg-white/50 dark:bg-white/5 px-3 py-1 rounded-full backdrop-blur-sm dark:border dark:border-white/10"><%= post.weather_label %></span>
            </div>
          <% end %>

          <% if post.feeling %>
            <div class="flex flex-col items-center animate-pulse-slow group/icon cursor-default">
              <span class="text-7xl drop-shadow-md dark:drop-shadow-[0_0_20px_rgba(255,255,255,0.4)] mb-2 transform transition-transform group-hover/icon:scale-110"><%= post.feeling_emoji %></span>
              <span class="text-sm font-bold <%= color_theme[:text] %> bg-white/50 dark:bg-white/5 px-3 py-1 rounded-full backdrop-blur-sm dark:border dark:border-white/10"><%= post.feeling_label %></span>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- リアクションエリア -->
    <div class="mt-0 pt-2 pb-1 bg-white/30 dark:bg-black/20 backdrop-blur-sm -mx-6 px-6 rounded-b-[3.75rem] pointer-events-auto relative z-20">
      <%= render "posts/reactions", post: post %>
    </div>
  </div>
</div>
