# 引継ぎ資料 (2025-12-20 20:19)

## 🚨 重要：基本ルール

**このプロジェクトでは `.cursorrules` ファイルに定義されたルールを厳格に遵守すること。**

- 思考プロセスは**必ず日本語**で行う
- 会話も**すべて日本語**で行う
- コード内のコメントも日本語で丁寧に記述
- 初学者にも理解できるように、理由と背景を説明する
- Rails 標準の書き方（The Rails Way）を優先

---

## 📍 現在の状況

### ブランチ

- **現在**: `15-comprehensive-improvements`
- **状態**: origin より 1 commit 先行（未プッシュのコミットあり）

### 作業状態

- **全変更をロールバック済み**
- 直近のコミット時点の状態に戻っている
- 未コミットの変更なし

---

## 🎯 今回のセッションの目的

**「コミュニティページ（/posts）のデザインを /stats ページと統一」**

具体的には、投稿カードに Crystal Claymorphism デザインを適用し、以下を実現する：

1. `crystal-card` クラスと色バリエーション（`crystal-blue`, `crystal-orange` など）の適用
2. カード内部に「Breathing Glow」（呼吸する光）を追加
3. 天気・気分に応じた動的な色付け
4. ライトモードとダークモードの両方で美しく表示

---

## ⚠️ 発生した問題と学び

### 1. **ActiveRecord のメソッド誤用**

- **問題**: `post.user.avatar` → 存在しないメソッド
- **正解**: `post.user.avatar_url` + `post.user.use_google_avatar` で条件分岐
- **原因**: 元のファイルを確認せずに、他のページ（例: ダッシュボード）の実装を参考にしてしまった

### 2. **存在しない要素を追加**

- **問題**: レベルバッジ（`post.user.level`）を誤って追加
- **原因**: 元のファイルには存在しない要素を、デザイン適用時に勝手に追加してしまった
- **対策**: **必ず元のファイルを `git show HEAD:ファイル名` で確認してから編集する**

### 3. **存在しないパーシャルを呼び出し**

- **問題**: `<%= render "reactions/button", post: post %>` → 存在しない
- **原因**: 元のファイルにはこの呼び出しが存在しないのに追加してしまった

### 4. **DOM 構造の破壊**

- **問題**: `<% end %>` タグの削除により構文エラー
- **原因**: レベルバッジを削除する際に、誤ってリンクの閉じタグも削除した
- **対策**: 編集範囲を最小限にし、慎重に行う

### 5. **ダークモードとの非互換性**

- **問題**:
  - Breathing Glow（右下のオレンジ色の呼吸する光）がダークモードでも表示され、違和感
  - `dark:hidden` で非表示にしたら、カードの色が完全に消えた
- **原因**: Crystal Claymorphism のライトモード専用スタイルをダークモードに適用
- **対策**: **最初からダークモードとの互換性を考慮し、段階的にテストする**

---

## 🔄 ロールバックした変更内容

以下のファイルを直近のコミットの状態に戻した：

1. `app/views/posts/_post.html.erb`
2. `app/views/posts/index.html.erb`
3. `app/views/posts/_form.html.erb`

---

## 📝 次のセッションでやるべきこと

### 目標

**コミュニティページのデザインを /stats と統一（再挑戦）**

### アプローチ

#### STEP 1: 元のファイルを完全に理解する

```bash
# 現在のファイル構造を確認
git show HEAD:app/views/posts/_post.html.erb
```

- どの要素が存在するか
- どのような条件分岐があるか
- どのようなパーシャルが呼ばれているか

#### STEP 2: /stats ページのデザインを分析

```bash
# /stats のデザイン実装を確認
cat app/views/stats/index.html.erb
cat app/assets/stylesheets/application.css | grep -A 50 "crystal-card"
```

- `crystal-card` とは何か
- 色バリエーションはどう定義されているか
- ライトモードとダークモードでどう切り替わるか

#### STEP 3: 段階的に適用

**3-1. カードコンテナのみ修正**

- `crystal-card` クラスを追加
- 色バリエーション（`crystal-blue` など）を動的に適用
- **ライトモードのみ**でテスト

**3-2. 内部要素を調整**

- 削除ボタン、アバター、本文エリアなどはそのまま
- **新しい要素は追加しない**

**3-3. ダークモードを確認**

- ダークモード専用のスタイルが正しく適用されているか
- Breathing Glow などのライトモード専用要素が邪魔していないか

**3-4. Breathing Glow を追加（オプション）**

- ライトモードのみで表示するように `dark:hidden` を追加
- ダークモードでカードが正しく表示されることを確認

#### STEP 4: コミット

```bash
git add .
git commit -m "design: コミュニティページ(/posts)のデザインを/statsと統一

- 投稿カードにcrystal-cardクラスを適用
- 天気・気分に基づいて色バリエーションを動的に適用
- ライトモードとダークモードの両方で正しく表示されることを確認"
git push origin 15-comprehensive-improvements
```

---

## 🔍 デバッグの際の重要なコマンド

### 元のファイルを確認

```bash
git show HEAD:app/views/posts/_post.html.erb
git diff HEAD app/views/posts/_post.html.erb
```

### 変更を破棄

```bash
git restore app/views/posts/_post.html.erb
```

### CSS を再ビルド

```bash
yarn build:css
```

---

## 📚 参考ファイル

### デザインシステム

- `.docs/DESIGN_SYSTEM_LIGHT.md` - Crystal Claymorphism の定義
- `app/assets/stylesheets/application.css` - `crystal-card` クラスの実装

### 参考実装

- `app/views/stats/index.html.erb` - /stats ページの実装例
- `app/views/posts/_post.html.erb` - 元の投稿カードの実装

### ヘルパーメソッド

- `app/helpers/posts_helper.rb` - `post_color_theme` メソッド（天気・気分に基づく配色）

---

## 💡 重要な教訓

1. **元のファイルを必ず確認する**

   - 編集前に `git show HEAD:ファイル名` で確認
   - 存在しない要素を追加しない

2. **段階的にテストする**

   - 一度にすべてを変更しない
   - ライトモード → ダークモード の順でテスト

3. **ダークモードとの互換性を最初から考慮**

   - ライトモード専用の要素は `dark:hidden` で非表示
   - ダークモード専用のスタイルは `dark:` プレフィックスで上書き

4. **最小限の変更に留める**

   - デザイン適用が目的なら、機能追加（レベルバッジなど）は行わない
   - 既存の要素を壊さない

5. **エラーが出たらすぐにロールバック**
   - 深みにハマる前に `git restore` で戻す
   - 新しいアプローチで再挑戦

---

## 🎨 Crystal Claymorphism のポイント

### ライトモード

- 柔らかい radial-gradient 背景
- ぷっくりとした box-shadow（外側 + 内側）
- 淡い境界線（`border-white/60`）
- 天気・気分に応じた色のバリエーション

### ダークモード

- `dark:bg-slate-900/40` で背景を上書き
- `dark:shadow-[...]` で影を再定義
- `dark:border-white/10` で境界線を暗く

### Breathing Glow

- カード右下の呼吸する光
- `animate-pulse-slow` でゆっくり点滅
- **ライトモードのみ** (`dark:hidden`)

---

## 次のセッション開始時の確認事項

1. ブランチが `15-comprehensive-improvements` であることを確認
2. 未コミットの変更がないことを確認（`git status`）
3. `.cursorrules` を読み、基本ルールを再確認
4. 今回の引継ぎ資料を読み、前回の失敗から学ぶ

---

**次のセッションでの成功を祈ります！🚀**
